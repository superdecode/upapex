<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inventario v2</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #4CAF50;
            --success-light: #e8f5e9;
            --warning: #FF9800;
            --error: #F44336;
            --blocked: #f97316;
            --bg: #f7f7f7;
            --text: #333;
            --card: #ffffff;
            --border: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .connection-banner { position: fixed; top: 0; left: 0; right: 0; padding: 10px; text-align: center; font-weight: 700; z-index: 10000; display: none; animation: slideDown 0.3s; }
        .connection-banner.offline { background: var(--error); color: white; display: block; }
        .connection-banner.online { background: var(--success); color: white; display: block; }
        .connection-banner.syncing { background: var(--warning); color: white; display: block; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
        .login-card { background: white; padding: 3rem; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; max-width: 400px; width: 90%; }
        .login-icon { font-size: 4rem; margin-bottom: 1.5rem; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .login-title { font-size: 1.8rem; font-weight: 700; color: var(--text); margin-bottom: 0.5rem; }
        .login-subtitle { color: #666; margin-bottom: 2rem; }
        .main-container { display: flex; height: 100vh; }
        .sidebar { width: 220px; background: #333; color: white; padding: 15px; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar-header { text-align: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #555; }
        .sidebar-header h2 { color: var(--primary); font-size: 1.3em; margin-bottom: 5px; }
        .sidebar-header p { font-size: 0.8em; color: #aaa; }
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-section-title { font-size: 0.75em; color: #888; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .sidebar-btn { width: 100%; padding: 10px; margin-bottom: 8px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.85em; }
        .sidebar-btn:hover { transform: translateX(3px); }
        .sidebar-btn-primary { background: var(--primary); color: white; }
        .sidebar-btn-secondary { background: #555; color: white; }
        .sync-status { padding: 10px 12px; border-radius: 6px; margin-bottom: 10px; font-size: 0.85em; text-align: center; cursor: pointer; }
        .sync-ok { background: rgba(76, 175, 80, 0.2); color: var(--success); border: 1px solid var(--success); }
        .sync-error { background: rgba(244, 67, 54, 0.2); color: var(--error); border: 1px solid var(--error); }
        .sync-warning { background: rgba(255, 152, 0, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .pallet-status-list { flex: 1; overflow-y: auto; }
        .pallet-status-item { background: #444; border-radius: 6px; padding: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .pallet-status-item:hover { background: #555; }
        .pallet-status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .pallet-status-name { font-weight: 600; font-size: 0.9em; }
        .pallet-status-count { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.75em; }
        .pallet-code { font-family: monospace; font-size: 0.7em; color: #aaa; word-break: break-all; }
        .user-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid #555; }
        .user-info { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1em; color: white; flex-shrink: 0; cursor: pointer; }
        .user-details { flex: 1; overflow: hidden; }
        .user-name { font-weight: 600; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .connection-indicator { font-size: 0.75em; display: flex; align-items: center; gap: 4px; }
        .connection-dot { width: 8px; height: 8px; border-radius: 50%; }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }
        .connection-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .user-footer-actions { display: flex; gap: 5px; margin-bottom: 8px; }
        .user-footer-actions button { flex: 1; padding: 6px; font-size: 0.75em; }
        .bd-info { font-size: 0.7em; color: #aaa; text-align: center; line-height: 1.4; }
        .main-content { flex: 1; padding: 15px; display: flex; flex-direction: column; overflow: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .header h1 { color: var(--primary); font-size: 1.4em; }
        .global-counter { display: flex; align-items: center; gap: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 10px 20px; border-radius: 10px; color: white; font-weight: 600; }
        .global-counter-item { display: flex; align-items: center; gap: 6px; }
        .global-counter-number { font-size: 1.5em; font-weight: 800; }
        .global-counter-label { font-size: 0.75em; opacity: 0.9; }
        .origin-location-bar { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); padding: 12px 20px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .origin-location-bar label { color: white; font-weight: 600; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .origin-location-input { flex: 1; padding: 10px 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 1em; font-weight: 600; text-transform: uppercase; background: rgba(255,255,255,0.95); max-width: 250px; }
        .origin-location-input:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 0 3px rgba(76,175,80,0.3); }
        .origin-copy-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .origin-copy-btn:hover { background: rgba(255,255,255,0.3); }
        .scan-section { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .scan-row { display: flex; gap: 10px; align-items: flex-end; }
        .scan-input-group { flex: 1; }
        .scan-input-group label { display: block; font-size: 0.85em; font-weight: 600; margin-bottom: 5px; }
        .scan-input { width: 100%; padding: 12px 15px; font-size: 1.3em; border: 2px solid var(--border); border-radius: 8px; font-weight: 600; text-transform: uppercase; text-align: center; background: #fff5ed; transition: all 0.2s; }
        .scan-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .scan-input.error { border-color: var(--error); background: #ffebee; }
        .scan-input.success { border-color: var(--success); background: #e8f5e9; }
        .result-box { padding: 12px; border-radius: 8px; margin-top: 10px; display: none; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .result-box.show { display: block; }
        .result-box.success { background: #e8f5e9; border: 2px solid var(--success); }
        .result-box.warning { background: #fff3e0; border: 2px solid var(--warning); }
        .result-box.blocked { background: #fff3e0; border: 2px solid var(--blocked); }
        .result-box.error { background: #ffebee; border: 2px solid var(--error); }
        .result-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .result-icon { font-size: 1.5rem; }
        .result-title { font-weight: 700; font-size: 1.1em; }
        .result-code { font-family: monospace; font-weight: 600; }
        .result-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 0.85em; }
        .result-detail-label { color: #666; font-size: 0.8em; }
        .result-detail-value { font-weight: 600; }
        .code2-container { margin-top: 10px; padding-top: 10px; border-top: 2px dashed var(--error); display: none; }
        .code2-container.show { display: block; }
        .code2-row { display: flex; gap: 10px; align-items: flex-end; }
        .btn-insertado { padding: 12px 20px; background: var(--error); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; white-space: nowrap; }
        .btn-insertado:hover { background: #d32f2f; }
        .columns-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; flex: 1; min-height: 0; }
        .column { background: white; border-radius: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid var(--border); flex-wrap: wrap; gap: 5px; }
        .column-title { font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .column-count { padding: 3px 10px; border-radius: 15px; font-weight: 700; font-size: 0.85em; }
        .column.ok .column-title { color: var(--success); }
        .column.ok .column-count { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        .column.blocked .column-title { color: var(--blocked); }
        .column.blocked .column-count { background: rgba(249, 115, 22, 0.15); color: var(--blocked); }
        .column.nowms .column-title { color: var(--error); }
        .column.nowms .column-count { background: rgba(244, 67, 54, 0.15); color: var(--error); }
        .column-status-indicators { display: flex; gap: 6px; }
        .status-badge { width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.7em; color: white; }
        .status-badge.completed { background: var(--success); }
        .status-badge.pending { background: var(--error); }
        .column-pallet-info { background: #f5f5f5; padding: 8px; border-radius: 6px; margin-bottom: 8px; font-size: 0.8em; }
        .column-pallet-code { font-family: monospace; font-weight: 600; color: var(--primary); }
        .column-location-input { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em; margin-top: 6px; }
        .column-actions { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap; }
        .column-action-btn { flex: 1; min-width: 70px; padding: 5px 6px; border: none; border-radius: 4px; font-size: 0.65em; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 3px; }
        .column-action-btn:hover { transform: translateY(-1px); }
        .column-action-btn.copy-codes { background: #e3f2fd; color: #1976d2; }
        .column-action-btn.copy-location { background: #f3e5f5; color: #7b1fa2; }
        .column-action-btn.view-detail { background: #fff3e0; color: #f57c00; }
        .column-send-btn { margin-top: 6px; padding: 8px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; font-size: 0.85em; }
        .column-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .column.ok .column-send-btn { background: var(--success); color: white; }
        .column.blocked .column-send-btn { background: var(--blocked); color: white; }
        .column.nowms .column-send-btn { background: var(--error); color: white; }
        .column-list { flex: 1; overflow-y: auto; counter-reset: item-counter; }
        .box-item { padding: 6px 8px; background: #f9f9f9; border-radius: 6px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid; counter-increment: item-counter; transition: all 0.2s; font-size: 0.85em; }
        .box-item::before { content: counter(item-counter) "."; font-weight: 700; min-width: 22px; margin-right: 6px; font-size: 0.8em; }
        .box-item.status-ok { background: var(--success-light); }
        .column.ok .box-item { border-color: var(--success); }
        .column.ok .box-item::before { color: var(--success); }
        .column.blocked .box-item { border-color: var(--blocked); }
        .column.blocked .box-item::before { color: var(--blocked); }
        .column.nowms .box-item { border-color: var(--error); }
        .column.nowms .box-item::before { color: var(--error); }
        .box-info { flex: 1; min-width: 0; }
        .box-code { font-weight: 600; font-family: monospace; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .box-meta { font-size: 0.7em; color: #666; }
        .box-actions { display: flex; gap: 2px; align-items: center; flex-shrink: 0; }
        .box-check { width: 18px; height: 18px; cursor: pointer; accent-color: var(--success); }
        .box-transfer, .box-delete { background: none; border: none; cursor: pointer; font-size: 0.9em; padding: 3px; opacity: 0.6; transition: all 0.2s; }
        .box-transfer:hover { opacity: 1; color: var(--primary); }
        .box-delete:hover { opacity: 1; color: var(--error); }
        .empty-state { text-align: center; padding: 20px 15px; color: #999; }
        .empty-icon { font-size: 2em; margin-bottom: 8px; opacity: 0.5; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-google { background: #4285F4; color: white; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        .btn-full { width: 100%; }
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px; }
        .notification { background: white; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 4px solid; animation: slideIn 0.3s; }
        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: var(--primary); }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .popup-overlay.show { display: flex; }
        .popup-content { background: white; padding: 25px; border-radius: 12px; max-width: 700px; width: 95%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .popup-header { font-size: 1.3em; font-weight: 700; margin-bottom: 15px; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .popup-close { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999; }
        .popup-close:hover { color: #333; }
        .popup-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .duplicate-popup { max-width: 450px; }
        .duplicate-info { background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid var(--warning); }
        .duplicate-info-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .duplicate-info-label { color: #666; font-size: 0.9em; }
        .duplicate-info-value { font-weight: 600; }
        .validation-popup { max-width: 400px; text-align: center; }
        .validation-input { width: 100%; padding: 15px; font-size: 2em; text-align: center; border: 3px solid var(--primary); border-radius: 10px; margin: 15px 0; }
        .validation-input.error { border-color: var(--error); background: #ffebee; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .validation-compare { display: flex; justify-content: center; gap: 30px; margin: 15px 0; }
        .validation-compare-item { text-align: center; }
        .validation-compare-number { font-size: 2.5em; font-weight: 800; }
        .validation-compare-label { font-size: 0.85em; color: #666; }
        .validation-compare-item.expected .validation-compare-number { color: var(--success); }
        .validation-compare-item.entered .validation-compare-number { color: var(--primary); }
        .validation-compare-item.mismatch .validation-compare-number { color: var(--error); }
        .detail-modal { max-width: 95vw; width: 1200px; max-height: 90vh; }
        .detail-modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 2px solid var(--border); margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .detail-modal-title { display: flex; align-items: center; gap: 15px; }
        .detail-modal-counters { display: flex; gap: 10px; }
        .detail-filters { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.8em; font-weight: 600; color: #666; }
        .filter-group input, .filter-group select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; }
        .filter-actions { display: flex; gap: 8px; margin-left: auto; }
        .detail-table-container { max-height: 50vh; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; }
        .detail-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .detail-table th, .detail-table td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; }
        .detail-table th { background: #f5f5f5; font-weight: 700; position: sticky; top: 0; cursor: pointer; user-select: none; }
        .detail-table th:hover { background: #e8e8e8; }
        .detail-table th .sort-icon { margin-left: 5px; opacity: 0.5; }
        .detail-table th.sorted .sort-icon { opacity: 1; }
        .detail-table tr:hover { background: #f9f9f9; }
        .detail-table .row-actions { display: flex; gap: 5px; }
        .detail-table .action-btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
        .detail-table .action-btn.transfer { background: #e3f2fd; color: #1976d2; }
        .detail-table .action-btn.delete { background: #ffebee; color: var(--error); }
        .detail-table .action-btn.status { background: #e8f5e9; color: var(--success); }
        .detail-table .action-btn.copy { background: #f3e5f5; color: #7b1fa2; }
        .detail-table .action-btn:hover { transform: scale(1.05); }
        .resumen-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .resumen-stat { text-align: center; padding: 15px; border-radius: 8px; background: #f5f5f5; }
        .resumen-stat-number { font-size: 2em; font-weight: 700; }
        .resumen-stat-label { font-size: 0.8em; color: #666; }
        .resumen-stat.ok { border: 2px solid var(--success); }
        .resumen-stat.ok .resumen-stat-number { color: var(--success); }
        .resumen-stat.blocked { border: 2px solid var(--blocked); }
        .resumen-stat.blocked .resumen-stat-number { color: var(--blocked); }
        .resumen-stat.nowms { border: 2px solid var(--error); }
        .resumen-stat.nowms .resumen-stat-number { color: var(--error); }
        .resumen-stat.pending { border: 2px solid var(--warning); }
        .resumen-stat.pending .resumen-stat-number { color: var(--warning); }
        .resumen-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .resumen-table th, .resumen-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        .resumen-table th { background: #f5f5f5; font-weight: 700; position: sticky; top: 0; }
        .resumen-table-container { max-height: 300px; overflow-y: auto; }
        .resumen-actions { display: flex; gap: 10px; margin-bottom: 15px; }
        .hidden { display: none !important; }
        @media (max-width: 1024px) { .sidebar { width: 180px; } .columns-container { grid-template-columns: 1fr; } .resumen-stats { grid-template-columns: repeat(2, 1fr); } .global-counter { flex-wrap: wrap; justify-content: center; } }
        @media (max-width: 768px) { .main-container { flex-direction: column; } .sidebar { width: 100%; max-height: 200px; } .origin-location-bar { flex-wrap: wrap; } .detail-modal { width: 100%; } }
    </style>
</head>
<body>
    <div class="connection-banner" id="connection-banner"></div>
    <div class="notification-container" id="notifications"></div>
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">üì¶</div>
            <h1 class="login-title">Sistema Inventario v2</h1>
            <p class="login-subtitle">Control y gesti√≥n de mercanc√≠a</p>
            <button class="btn btn-google btn-full" onclick="handleLogin()" style="padding: 15px; font-size: 1.1em;">üîê Iniciar sesi√≥n con Google</button>
        </div>
    </div>
    <div id="main-app" class="hidden">
        <div class="main-container">
            <div class="sidebar">
                <div class="sidebar-header"><h2>üì¶ Inventario</h2><p>Sistema v2</p></div>
                <div id="sync-status" class="sync-status sync-ok" onclick="SyncManager.showPanel()">‚úÖ Sincronizado</div>
                <div class="sidebar-section">
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showResumen()">üìä Resumen</button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="newSession()">‚ûï Nueva Sesi√≥n</button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="exportData()">üì• Exportar</button>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Tarimas Activas</div>
                    <div class="pallet-status-list" id="pallet-status-list">
                        <div class="pallet-status-item" onclick="showDetailModal('ok')">
                            <div class="pallet-status-header"><span class="pallet-status-name" style="color: var(--success);">‚úÖ OK</span><span class="pallet-status-count" id="sidebar-ok-count">0</span></div>
                            <div class="pallet-code" id="sidebar-ok-pallet">-</div>
                        </div>
                        <div class="pallet-status-item" onclick="showDetailModal('blocked')">
                            <div class="pallet-status-header"><span class="pallet-status-name" style="color: var(--blocked);">‚ö†Ô∏è Bloqueado</span><span class="pallet-status-count" id="sidebar-blocked-count">0</span></div>
                            <div class="pallet-code" id="sidebar-blocked-pallet">-</div>
                        </div>
                        <div class="pallet-status-item" onclick="showDetailModal('nowms')">
                            <div class="pallet-status-header"><span class="pallet-status-name" style="color: var(--error);">‚ùå No WMS</span><span class="pallet-status-count" id="sidebar-nowms-count">0</span></div>
                            <div class="pallet-code" id="sidebar-nowms-pallet">-</div>
                        </div>
                    </div>
                </div>
                <div class="user-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar" onclick="changeUserAlias()">?</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name-display" onclick="changeUserAlias()">No conectado</div>
                            <div class="connection-indicator"><div class="connection-dot" id="connection-dot"></div><span id="connection-text">Offline</span></div>
                        </div>
                    </div>
                    <div class="user-footer-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshInventory()">üîÑ BD</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleConnection()">üîó</button>
                        <button class="btn btn-danger btn-small" onclick="handleLogout()">üö™</button>
                    </div>
                    <div class="bd-info"><div><span id="bd-count">0</span> c√≥digos</div><div id="bd-update-time">Sin actualizar</div></div>
                </div>
            </div>
            <div class="main-content">
                <div class="header">
                    <h1>üì∏ √Årea de Escaneo</h1>
                    <div class="global-counter"><div class="global-counter-item"><span class="global-counter-number" id="global-total">0</span><span class="global-counter-label">TOTAL CAJAS</span></div></div>
                </div>
                <div class="origin-location-bar">
                    <label>üìç Ubicaci√≥n F√≠sica Origen:</label>
                    <input type="text" class="origin-location-input" id="origin-location" placeholder="Ej: A21-06-05-01" autocomplete="off">
                    <button class="origin-copy-btn" onclick="copyOriginLocation()" title="Copiar ubicaci√≥n">üìã Copiar</button>
                </div>
                <div class="scan-section">
                    <div class="scan-row"><div class="scan-input-group"><label>üîç C√≥digo Principal</label><input type="text" class="scan-input" id="scan-input" placeholder="Escanea o ingresa c√≥digo..." autocomplete="off"></div></div>
                    <div class="result-box" id="result-box"><div class="result-header"><span class="result-icon" id="result-icon">üì¶</span><span class="result-title" id="result-title">Estado</span></div><div class="result-code" id="result-code"></div><div class="result-details" id="result-details"></div></div>
                    <div class="code2-container" id="code2-container">
                        <label style="font-size: 0.9em; color: var(--error); font-weight: 600; margin-bottom: 8px; display: block;">‚ö†Ô∏è C√≥digo no encontrado. Ingresa C√≥digo 2 o fuerza el registro:</label>
                        <div class="code2-row"><div class="scan-input-group"><input type="text" class="scan-input" id="code2-input" placeholder="C√≥digo 2..." autocomplete="off" style="font-size: 1.1em;"></div><button class="btn-insertado" onclick="forceInsert()">‚ö° INSERTADO</button></div>
                    </div>
                </div>
                <div class="columns-container">
                    <div class="column ok">
                        <div class="column-header">
                            <span class="column-title">‚úÖ OK</span>
                            <div class="column-status-indicators"><span class="status-badge completed" id="ok-completed-badge" title="Completados">0</span><span class="status-badge pending" id="ok-pending-badge" title="Pendientes">0</span></div>
                            <span class="column-count" id="ok-count">0</span>
                        </div>
                        <div class="column-pallet-info">
                            <div>Pallet: <span class="column-pallet-code" id="ok-pallet">-</span></div>
                            <input type="text" class="column-location-input" id="location-ok" placeholder="üìç Ubicaci√≥n destino...">
                            <div class="column-actions">
                                <button class="column-action-btn copy-codes" onclick="copyCodes('ok')">üìã C√≥digos</button>
                                <button class="column-action-btn copy-location" onclick="copyColumnLocation('ok')">üìç Ubicaci√≥n</button>
                                <button class="column-action-btn view-detail" onclick="showDetailModal('ok')">üîç Detalle</button>
                            </div>
                            <button class="column-send-btn" onclick="initSendPallet('ok')" id="send-ok-btn" disabled>üì§ Enviar Tarima OK</button>
                        </div>
                        <div class="column-list" id="ok-list"><div class="empty-state"><div class="empty-icon">üì≠</div><div>Sin cajas</div></div></div>
                    </div>
                    <div class="column blocked">
                        <div class="column-header"><span class="column-title">‚ö†Ô∏è Bloqueado</span><span class="column-count" id="blocked-count">0</span></div>
                        <div class="column-pallet-info">
                            <div>Pallet: <span class="column-pallet-code" id="blocked-pallet">-</span></div>
                            <input type="text" class="column-location-input" id="location-blocked" placeholder="üìç Ubicaci√≥n destino...">
                            <div class="column-actions">
                                <button class="column-action-btn copy-codes" onclick="copyCodes('blocked')">üìã C√≥digos</button>
                                <button class="column-action-btn copy-location" onclick="copyColumnLocation('blocked')">üìç Ubicaci√≥n</button>
                                <button class="column-action-btn view-detail" onclick="showDetailModal('blocked')">üîç Detalle</button>
                            </div>
                            <button class="column-send-btn" onclick="initSendPallet('blocked')" id="send-blocked-btn" disabled>üì§ Enviar Tarima Bloqueado</button>
                        </div>
                        <div class="column-list" id="blocked-list"><div class="empty-state"><div class="empty-icon">üì≠</div><div>Sin cajas</div></div></div>
                    </div>
                    <div class="column nowms">
                        <div class="column-header"><span class="column-title">‚ùå No WMS</span><span class="column-count" id="nowms-count">0</span></div>
                        <div class="column-pallet-info">
                            <div>Pallet: <span class="column-pallet-code" id="nowms-pallet">-</span></div>
                            <input type="text" class="column-location-input" id="location-nowms" placeholder="üìç Ubicaci√≥n destino...">
                            <div class="column-actions">
                                <button class="column-action-btn copy-codes" onclick="copyCodes('nowms')">üìã C√≥digos</button>
                                <button class="column-action-btn copy-location" onclick="copyColumnLocation('nowms')">üìç Ubicaci√≥n</button>
                                <button class="column-action-btn view-detail" onclick="showDetailModal('nowms')">üîç Detalle</button>
                            </div>
                            <button class="column-send-btn" onclick="initSendPallet('nowms')" id="send-nowms-btn" disabled>üì§ Enviar Tarima No WMS</button>
                        </div>
                        <div class="column-list" id="nowms-list"><div class="empty-state"><div class="empty-icon">üì≠</div><div>Sin cajas</div></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- POPUPS -->
    <div class="popup-overlay" id="resumen-popup"><div class="popup-content"><div class="popup-header"><span>üìä Resumen de Sesi√≥n</span><button class="popup-close" onclick="closeResumen()">√ó</button></div><div class="resumen-stats"><div class="resumen-stat ok"><div class="resumen-stat-number" id="resumen-ok">0</div><div class="resumen-stat-label">OK</div></div><div class="resumen-stat blocked"><div class="resumen-stat-number" id="resumen-blocked">0</div><div class="resumen-stat-label">Bloqueado</div></div><div class="resumen-stat nowms"><div class="resumen-stat-number" id="resumen-nowms">0</div><div class="resumen-stat-label">No WMS</div></div><div class="resumen-stat pending"><div class="resumen-stat-number" id="resumen-pending">0</div><div class="resumen-stat-label">Pendientes Sync</div></div></div><div class="resumen-actions"><button class="btn btn-primary btn-small" onclick="refreshInventory(); closeResumen();">üîÑ Recargar BD</button><button class="btn btn-success btn-small" onclick="SyncManager.sync(); updateResumen();">üîÑ Sincronizar</button><button class="btn btn-secondary btn-small" onclick="exportData();">üì• Exportar</button></div><h3 style="margin-bottom: 10px; font-size: 1em;">üìã Historial Reciente</h3><div class="resumen-table-container"><table class="resumen-table"><thead><tr><th>Hora</th><th>C√≥digo</th><th>C√≥digo 2</th><th>Estatus</th><th>Ubicaci√≥n</th><th>Pallet</th></tr></thead><tbody id="resumen-table-body"></tbody></table></div></div></div>
    <div class="popup-overlay" id="duplicate-popup"><div class="popup-content duplicate-popup"><div class="popup-header"><span>‚ö†Ô∏è C√≥digo Duplicado</span><button class="popup-close" onclick="closeDuplicatePopup()">√ó</button></div><div class="duplicate-info"><div class="duplicate-info-row"><span class="duplicate-info-label">C√≥digo:</span><span class="duplicate-info-value" id="dup-code">-</span></div><div class="duplicate-info-row"><span class="duplicate-info-label">Escaneado por:</span><span class="duplicate-info-value" id="dup-user">-</span></div><div class="duplicate-info-row"><span class="duplicate-info-label">Hora original:</span><span class="duplicate-info-value" id="dup-time">-</span></div><div class="duplicate-info-row"><span class="duplicate-info-label">Tarima:</span><span class="duplicate-info-value" id="dup-pallet">-</span></div></div><div class="popup-buttons"><button class="btn btn-warning btn-full" onclick="forceInsertDuplicate()">‚ö° INGRESO FORZADO</button><button class="btn btn-secondary btn-full" onclick="closeDuplicatePopup()">Cancelar</button></div></div></div>
    <div class="popup-overlay" id="validation-popup"><div class="popup-content validation-popup"><div class="popup-header"><span>üî¢ Validaci√≥n de Cajas</span><button class="popup-close" onclick="closeValidationPopup()">√ó</button></div><p style="margin-bottom: 15px; color: #666;">¬øCu√°ntas cajas f√≠sicas hay en la tarima?</p><div class="validation-compare"><div class="validation-compare-item expected"><div class="validation-compare-number" id="validation-expected">0</div><div class="validation-compare-label">Escaneadas</div></div><div class="validation-compare-item entered" id="validation-entered-container"><div class="validation-compare-number" id="validation-entered">-</div><div class="validation-compare-label">Ingresadas</div></div></div><input type="number" class="validation-input" id="validation-input" placeholder="Cantidad" min="0"><div id="validation-message" style="margin: 10px 0; font-weight: 600;"></div><div class="popup-buttons"><button class="btn btn-success btn-full" id="validation-confirm-btn" onclick="confirmValidation()" disabled>‚úÖ Confirmar y Enviar</button><button class="btn btn-secondary btn-full" onclick="closeValidationPopup()">Cancelar</button></div></div></div>
    <div class="popup-overlay" id="transfer-popup"><div class="popup-content" style="max-width: 400px;"><div class="popup-header"><span>üîÑ Transferir Caja</span><button class="popup-close" onclick="closeTransferPopup()">√ó</button></div><p style="margin-bottom: 15px;">Selecciona el destino para la caja:</p><div id="transfer-box-info" style="background: #f5f5f5; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-family: monospace;"></div><div class="popup-buttons" id="transfer-options"></div></div></div>
    <div class="popup-overlay" id="detail-modal"><div class="popup-content detail-modal"><div class="detail-modal-header"><div class="detail-modal-title"><span id="detail-modal-icon">üì¶</span><span id="detail-modal-title-text">Detalle de Tarima</span><span id="detail-modal-pallet" style="font-family: monospace; color: var(--primary);"></span></div><div class="detail-modal-counters" id="detail-modal-counters"></div><button class="popup-close" onclick="closeDetailModal()">√ó</button></div><div class="detail-filters"><div class="filter-group"><label>Fecha/Hora</label><input type="text" id="filter-datetime" placeholder="Buscar..."></div><div class="filter-group"><label>Ubicaci√≥n</label><input type="text" id="filter-location" placeholder="Buscar..."></div><div class="filter-group"><label>C√≥digo</label><input type="text" id="filter-code" placeholder="Buscar..."></div><div class="filter-actions"><button class="btn btn-small btn-primary" onclick="applyDetailFilters()">üîç Filtrar</button><button class="btn btn-small btn-secondary" onclick="clearDetailFilters()">üóëÔ∏è Limpiar</button><button class="btn btn-small" style="background: #f3e5f5; color: #7b1fa2;" onclick="copyAllDetailCodes()">üìã Copiar Todo</button></div></div><div class="detail-table-container"><table class="detail-table"><thead><tr><th onclick="sortDetailTable('index')"># <span class="sort-icon">‚Üï</span></th><th onclick="sortDetailTable('code')">C√≥digo <span class="sort-icon">‚Üï</span></th><th onclick="sortDetailTable('scan2')">C√≥digo 2 <span class="sort-icon">‚Üï</span></th><th onclick="sortDetailTable('location')">Ubicaci√≥n <span class="sort-icon">‚Üï</span></th><th onclick="sortDetailTable('timestamp')">Hora <span class="sort-icon">‚Üï</span></th><th>Acciones</th></tr></thead><tbody id="detail-table-body"></tbody></table></div><div class="popup-buttons" style="flex-direction: row; margin-top: 15px;"><button class="btn btn-secondary" onclick="closeDetailModal()">Cerrar</button></div></div></div>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        const CONFIG = { CLIENT_ID: '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com', SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile', SPREADSHEET_WRITE: '1FBhZloEeT-xTe1yVKzdWxGJa6gKkZQOObmkBMuxqcv8', SHEET_NAME: 'BD', INVENTORY_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-HG8HPf-94Ki5Leo5iEF5pyqsiD9CVk-mcl-F8BAw34kT0s3nzNn532YTYDCtkG76NbauiVx0Ffmd/pub?output=csv' };
        let STATE = { inventory: new Map(), inventoryLastUpdate: null, pallets: { ok: { id: generatePalletId('OK'), boxes: [], location: '' }, blocked: { id: generatePalletId('BLK'), boxes: [], location: '' }, nowms: { id: generatePalletId('NW'), boxes: [], location: '' } }, pendingCode1: null, history: [], originLocation: '', boxStatuses: {} };
        let DUPLICATE_PENDING = null, VALIDATION_CATEGORY = null, TRANSFER_DATA = null, DETAIL_MODAL_CATEGORY = null, DETAIL_SORT_FIELD = null, DETAIL_SORT_ASC = true, DETAIL_FILTERED_DATA = [];
        let CURRENT_USER = '', USER_EMAIL = '', USER_GOOGLE_NAME = '', IS_ONLINE = navigator.onLine, PENDING_SYNC = [], TOKEN_CLIENT = null, audioCtx = null;

        const SyncManager = {
            inProgress: false, retryCount: 0, intervalId: null, AUTO_SYNC_INTERVAL: 30000,
            init() { this.load(); this.startAutoSync(); this.setupExitProtection(); this.updateUI(PENDING_SYNC.length === 0); },
            setupExitProtection() { window.addEventListener('beforeunload', (e) => { const hasData = PENDING_SYNC.length > 0 || STATE.pallets.ok.boxes.length > 0 || STATE.pallets.blocked.boxes.length > 0 || STATE.pallets.nowms.boxes.length > 0; if (hasData) { e.preventDefault(); e.returnValue = '¬°Tienes datos sin sincronizar!'; return e.returnValue; } }); },
            startAutoSync() { if (this.intervalId) clearInterval(this.intervalId); this.intervalId = setInterval(() => { if (PENDING_SYNC.length > 0 && IS_ONLINE && gapi?.client?.getToken()) this.sync(false); }, this.AUTO_SYNC_INTERVAL); },
            async sync(showMessages = true) {
                if (this.inProgress || PENDING_SYNC.length === 0) return { success: true };
                if (!IS_ONLINE) { if (showMessages) showNotification('‚ö†Ô∏è Sin conexi√≥n', 'warning'); return { success: false }; }
                if (!gapi?.client?.getToken()) { if (showMessages) showNotification('‚ö†Ô∏è No autenticado', 'warning'); return { success: false }; }
                this.inProgress = true; updateConnectionIndicator(true);
                try {
                    const values = PENDING_SYNC.map(r => [r.date, r.time, r.user, r.scan1, r.scan2, r.location, r.status, r.note, r.pallet, r.originLocation || '']);
                    await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: CONFIG.SPREADSHEET_WRITE, range: `${CONFIG.SHEET_NAME}!A:J`, valueInputOption: 'USER_ENTERED', insertDataOption: 'INSERT_ROWS', resource: { values } });
                    const synced = PENDING_SYNC.length; PENDING_SYNC = []; this.save(); this.updateUI(true);
                    if (showMessages) showNotification(`‚úÖ ${synced} registros sincronizados`, 'success'); return { success: true, synced };
                } catch (e) { console.error('Sync error:', e); this.updateUI(false); if (showMessages) showNotification(`‚ùå Error: ${e.result?.error?.message || e.message}`, 'error'); return { success: false }; }
                finally { this.inProgress = false; updateConnectionIndicator(); }
            },
            async save() { try { localStorage.setItem('pd_pending_sync', JSON.stringify(PENDING_SYNC)); } catch (e) {} },
            async load() { try { const saved = localStorage.getItem('pd_pending_sync'); if (saved) PENDING_SYNC = JSON.parse(saved); } catch (e) {} },
            updateUI(synced) { const el = document.getElementById('sync-status'); if (!el) return; if (!IS_ONLINE) { el.className = 'sync-status sync-warning'; el.innerHTML = `‚ö†Ô∏è Sin conexi√≥n${PENDING_SYNC.length > 0 ? ` (${PENDING_SYNC.length})` : ''}`; } else if (PENDING_SYNC.length > 0) { el.className = 'sync-status sync-warning'; el.innerHTML = `‚è≥ ${PENDING_SYNC.length} pendientes`; } else if (synced) { el.className = 'sync-status sync-ok'; el.textContent = '‚úÖ Sincronizado'; } else { el.className = 'sync-status sync-error'; el.textContent = '‚ùå Error sync'; } },
            showPanel() { const overlay = document.createElement('div'); overlay.className = 'popup-overlay show'; overlay.innerHTML = `<div class="popup-content" style="max-width: 450px;"><div class="popup-header"><span>üìä Estado de Sincronizaci√≥n</span><button class="popup-close" onclick="this.closest('.popup-overlay').remove()">√ó</button></div><div style="margin-bottom: 15px;"><div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px; text-align: center;"><div style="font-size: 0.85em; color: #666;">Pendientes</div><div style="font-size: 2em; font-weight: 700; color: ${PENDING_SYNC.length > 0 ? 'var(--warning)' : 'var(--success)'};">${PENDING_SYNC.length}</div></div><div style="font-size: 0.9em; padding: 10px; background: #f9f9f9; border-radius: 6px;">${IS_ONLINE ? 'üü¢ Conectado' : 'üî¥ Sin conexi√≥n'}<br>${gapi?.client?.getToken() ? 'üü¢ Google OK' : 'üî¥ Google desconectado'}</div></div><div class="popup-buttons">${PENDING_SYNC.length > 0 && IS_ONLINE && gapi?.client?.getToken() ? `<button class="btn btn-success btn-full" onclick="this.closest('.popup-overlay').remove(); SyncManager.sync();">üîÑ Sincronizar</button>` : ''}<button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">Cerrar</button></div></div>`; document.body.appendChild(overlay); overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); }); }
        };

        document.addEventListener('DOMContentLoaded', () => { initAudio(); loadFromStorage(); setupEventListeners(); setupConnectionMonitor(); gapi.load('client', initGAPI); });
        function initAudio() { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); document.addEventListener('click', () => { if (audioCtx?.state === 'suspended') audioCtx.resume(); }, { once: true }); } catch (e) {} }
        async function initGAPI() { try { await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] }); TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({ client_id: CONFIG.CLIENT_ID, scope: CONFIG.SCOPES, callback: handleAuthCallback }); } catch (e) { showNotification('Error inicializando API', 'error'); } }
        async function handleAuthCallback(response) { if (response?.access_token) { gapi.client.setToken(response); await getUserProfile(); await loadInventory(); SyncManager.init(); if (PENDING_SYNC.length > 0) SyncManager.sync(); showApp(); } }
        function handleLogin() { TOKEN_CLIENT?.requestAccessToken(); }
        async function getUserProfile() { try { const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` } }); const data = await response.json(); USER_EMAIL = data.email || ''; USER_GOOGLE_NAME = data.name || 'Usuario'; const savedAlias = localStorage.getItem(`pd_alias_${USER_EMAIL}`); if (savedAlias) { CURRENT_USER = savedAlias; showNotification(`‚úÖ Bienvenido, ${CURRENT_USER}`, 'success'); updateUserFooter(); } else { showAliasPopup(); } } catch (e) { CURRENT_USER = 'Usuario'; updateUserFooter(); } }
        function showApp() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); updateUserFooter(); updateUI(); document.getElementById('scan-input').focus(); }
        function handleLogout() { const hasData = PENDING_SYNC.length > 0 || STATE.pallets.ok.boxes.length > 0 || STATE.pallets.blocked.boxes.length > 0 || STATE.pallets.nowms.boxes.length > 0; if (hasData && !confirm('‚ö†Ô∏è Tienes datos sin sincronizar. ¬øSeguro?')) return; if (gapi.client.getToken()) { google.accounts.oauth2.revoke(gapi.client.getToken().access_token); gapi.client.setToken(null); } CURRENT_USER = ''; USER_EMAIL = ''; document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('main-app').classList.add('hidden'); }
        function showAliasPopup() { document.querySelectorAll('.alias-popup').forEach(e => e.remove()); const overlay = document.createElement('div'); overlay.className = 'popup-overlay show alias-popup'; overlay.innerHTML = `<div class="popup-content" style="max-width: 400px;"><div class="popup-header">üë§ ¬øC√≥mo te llamamos?</div><p style="margin-bottom: 15px; color: #666;">Hola <strong>${USER_GOOGLE_NAME}</strong>:</p><div class="popup-buttons"><button class="btn btn-primary btn-full" onclick="saveUserAlias('${USER_GOOGLE_NAME}', true)">üë§ Usar mi nombre de Google</button><div style="text-align: center; color: #999; font-size: 0.85em;">o</div><div style="display: flex; gap: 8px;"><input type="text" id="alias-input" placeholder="Escribe un alias..." style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px;" maxlength="20"><button class="btn btn-success" onclick="saveUserAlias(document.getElementById('alias-input').value)">üíæ</button></div></div></div>`; document.body.appendChild(overlay); const input = overlay.querySelector('#alias-input'); input.addEventListener('keypress', (e) => { if (e.key === 'Enter' && input.value.trim()) saveUserAlias(input.value); }); input.focus(); }
        function saveUserAlias(alias, isGoogleName = false) { const finalAlias = alias?.trim() || USER_GOOGLE_NAME; if (!finalAlias) { showNotification('‚ö†Ô∏è Ingresa un nombre v√°lido', 'warning'); return; } CURRENT_USER = finalAlias; localStorage.setItem(`pd_alias_${USER_EMAIL}`, finalAlias); document.querySelectorAll('.alias-popup').forEach(e => e.remove()); showNotification(`‚úÖ Guardado: ${finalAlias}`, 'success'); updateUserFooter(); }
        function changeUserAlias() { showAliasPopup(); }
        function updateUserFooter() { const avatar = document.getElementById('user-avatar'); const nameDisplay = document.getElementById('user-name-display'); if (avatar) { avatar.textContent = CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : '?'; avatar.title = USER_EMAIL || 'No conectado'; } if (nameDisplay) { nameDisplay.textContent = CURRENT_USER || 'No conectado'; } updateConnectionIndicator(); }
        async function loadInventory() { try { showNotification('üì¶ Cargando inventario...', 'info'); updateConnectionIndicator(true); const response = await fetch(CONFIG.INVENTORY_CSV_URL, { method: 'GET', mode: 'cors', cache: 'no-cache' }); if (!response.ok) throw new Error(`HTTP ${response.status}`); const csv = await response.text(); if (!csv || csv.trim().length === 0) throw new Error('CSV vac√≠o'); parseInventoryCSV(csv); await saveToStorage(); showNotification(`‚úÖ ${STATE.inventory.size} c√≥digos cargados`, 'success'); updateBdInfo(); } catch (e) { console.error('Error cargando inventario:', e); showNotification(`‚ö†Ô∏è ${e.message}`, 'warning'); if (STATE.inventory.size > 0) showNotification(`Usando ${STATE.inventory.size} c√≥digos en cach√©`, 'info'); } finally { updateConnectionIndicator(); } }
        function parseInventoryCSV(csv) { const lines = csv.split('\n').filter(line => line.trim().length > 0); STATE.inventory.clear(); for (let i = 1; i < lines.length; i++) { const cols = parseCSVLine(lines[i]); if (cols.length >= 11) { const code = (cols[1] || '').toString().trim().toUpperCase(); if (code && code.length > 0) { const availableStock = parseFloat(cols[9]) || 0; const lockedInventory = parseFloat(cols[10]) || 0; STATE.inventory.set(code, { code, boxType: cols[0] || '', warehouse: cols[3] || '', cellNo: cols[6] || '', area: cols[8] || '', availableStock, lockedInventory, sku: cols[12] || '', productName: cols[13] || '', isAvailable: availableStock > 0, isBlocked: lockedInventory > 0 }); } } } STATE.inventoryLastUpdate = new Date().toLocaleString(); }
        function parseCSVLine(line) { const result = []; let current = '', inQuotes = false; for (let i = 0; i < line.length; i++) { const char = line[i]; if (char === '"') inQuotes = !inQuotes; else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; } else current += char; } result.push(current.trim()); return result; }
        function refreshInventory() { loadInventory(); }
        function updateBdInfo() { document.getElementById('bd-count').textContent = STATE.inventory.size.toLocaleString(); document.getElementById('bd-update-time').textContent = STATE.inventoryLastUpdate || 'Sin actualizar'; }
        function generatePalletId(prefix = 'PD') { const timestamp = Date.now().toString(36).toUpperCase(); const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0'); return `${prefix}-${timestamp}-${random}`; }
        function newSession() { const total = STATE.pallets.ok.boxes.length + STATE.pallets.blocked.boxes.length + STATE.pallets.nowms.boxes.length; if (total > 0 && !confirm(`Hay ${total} cajas. ¬øIniciar nueva sesi√≥n?`)) return; STATE.pallets = { ok: { id: generatePalletId('OK'), boxes: [], location: '' }, blocked: { id: generatePalletId('BLK'), boxes: [], location: '' }, nowms: { id: generatePalletId('NW'), boxes: [], location: '' } }; STATE.pendingCode1 = null; STATE.boxStatuses = {}; document.getElementById('result-box').classList.remove('show'); document.getElementById('code2-container').classList.remove('show'); document.getElementById('location-ok').value = ''; document.getElementById('location-blocked').value = ''; document.getElementById('location-nowms').value = ''; saveToStorage(); updateUI(); showNotification('‚úÖ Nueva sesi√≥n iniciada', 'success'); document.getElementById('scan-input').focus(); }
        function showResumen() { updateResumen(); document.getElementById('resumen-popup').classList.add('show'); }
        function closeResumen() { document.getElementById('resumen-popup').classList.remove('show'); }
        function updateResumen() { document.getElementById('resumen-ok').textContent = STATE.pallets.ok.boxes.length; document.getElementById('resumen-blocked').textContent = STATE.pallets.blocked.boxes.length; document.getElementById('resumen-nowms').textContent = STATE.pallets.nowms.boxes.length; document.getElementById('resumen-pending').textContent = PENDING_SYNC.length; const tbody = document.getElementById('resumen-table-body'); const recentHistory = STATE.history.slice(0, 50); if (recentHistory.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">Sin registros</td></tr>'; } else { tbody.innerHTML = recentHistory.map(r => `<tr><td>${r.time}</td><td><code>${r.scan1}</code></td><td><code>${r.scan2 || '-'}</code></td><td><span style="color: ${r.status === 'OK' ? 'var(--success)' : r.status === 'BLOQUEADO' ? 'var(--blocked)' : 'var(--error)'}">${r.status}</span></td><td>${r.location}</td><td style="font-size: 0.8em;">${r.pallet}</td></tr>`).join(''); } }
        function setupConnectionMonitor() { window.addEventListener('online', () => { IS_ONLINE = true; showConnectionBanner('online'); updateConnectionIndicator(); showNotification('‚úÖ Conexi√≥n restaurada', 'success'); setTimeout(() => SyncManager.sync(), 1000); }); window.addEventListener('offline', () => { IS_ONLINE = false; showConnectionBanner('offline'); updateConnectionIndicator(); showNotification('‚ö†Ô∏è Sin conexi√≥n', 'warning'); }); updateConnectionIndicator(); }
        function showConnectionBanner(status) { const banner = document.getElementById('connection-banner'); banner.className = `connection-banner ${status}`; banner.textContent = status === 'online' ? '‚úÖ Conexi√≥n restaurada' : status === 'offline' ? '‚ö†Ô∏è Sin conexi√≥n' : 'üîÑ Sincronizando...'; if (status === 'online') setTimeout(() => banner.style.display = 'none', 3000); }
        function updateConnectionIndicator(syncing = false) { const dot = document.getElementById('connection-dot'); const text = document.getElementById('connection-text'); if (!dot || !text) return; if (syncing) { dot.className = 'connection-dot syncing'; text.textContent = 'Sincronizando...'; } else if (IS_ONLINE) { dot.className = 'connection-dot online'; text.textContent = 'En l√≠nea'; } else { dot.className = 'connection-dot offline'; text.textContent = 'Sin conexi√≥n'; } }
        function toggleConnection() { if (gapi?.client?.getToken()) { if (confirm('¬øDesconectar de Google?')) { google.accounts.oauth2.revoke(gapi.client.getToken().access_token); gapi.client.setToken(null); showNotification('Desconectado de Google', 'info'); updateConnectionIndicator(); } } else { handleLogin(); } }
        async function loadFromStorage() { try { const saved = localStorage.getItem('pd_system_state_v2'); if (saved) { const data = JSON.parse(saved); if (data.inventory) STATE.inventory = new Map(data.inventory); STATE.inventoryLastUpdate = data.inventoryLastUpdate; if (data.pallets) STATE.pallets = data.pallets; STATE.history = data.history || []; STATE.originLocation = data.originLocation || ''; STATE.boxStatuses = data.boxStatuses || {}; const originInput = document.getElementById('origin-location'); if (originInput) originInput.value = STATE.originLocation; } updateBdInfo(); } catch (e) { console.error('Error loading from storage:', e); } }
        async function saveToStorage() { try { const data = { inventory: Array.from(STATE.inventory.entries()), inventoryLastUpdate: STATE.inventoryLastUpdate, pallets: STATE.pallets, history: STATE.history.slice(0, 1000), originLocation: STATE.originLocation, boxStatuses: STATE.boxStatuses }; localStorage.setItem('pd_system_state_v2', JSON.stringify(data)); } catch (e) { console.error('Error saving:', e); } }
        function setupEventListeners() { 
            const scanInput = document.getElementById('scan-input'); 
            scanInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && scanInput.value.trim()) { e.preventDefault(); processScan(scanInput.value.trim()); scanInput.value = ''; } }); 
            const code2Input = document.getElementById('code2-input'); 
            code2Input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && code2Input.value.trim()) { e.preventDefault(); processCode2(code2Input.value.trim()); code2Input.value = ''; } }); 
            const originInput = document.getElementById('origin-location'); 
            originInput.addEventListener('change', () => { STATE.originLocation = originInput.value.trim().toUpperCase(); originInput.value = STATE.originLocation; saveToStorage(); }); 
            const validationInput = document.getElementById('validation-input'); 
            validationInput.addEventListener('input', () => { checkValidationInput(); }); 
            validationInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); if (!document.getElementById('validation-confirm-btn').disabled) confirmValidation(); } }); 
        }
        function processScan(rawCode) { const code = normalizeCode(rawCode); const duplicateInfo = findDuplicate(code); if (duplicateInfo) { showDuplicatePopup(code, rawCode, duplicateInfo); return; } processCodeInternal(rawCode, code); }
        function findDuplicate(code) { const categories = ['ok', 'blocked', 'nowms']; for (const cat of categories) { const boxes = STATE.pallets[cat].boxes; const found = boxes.find(b => b.code === code); if (found) return { category: cat, box: found, palletId: STATE.pallets[cat].id }; } return null; }
        function showDuplicatePopup(code, rawCode, dupInfo) { DUPLICATE_PENDING = { code, rawCode, dupInfo }; document.getElementById('dup-code').textContent = code; document.getElementById('dup-user').textContent = CURRENT_USER || 'Usuario'; document.getElementById('dup-time').textContent = dupInfo.box.timestamp; document.getElementById('dup-pallet').textContent = `${dupInfo.palletId} (${dupInfo.category.toUpperCase()})`; document.getElementById('duplicate-popup').classList.add('show'); playSound('warning'); flashInput('warning'); }
        function closeDuplicatePopup() { document.getElementById('duplicate-popup').classList.remove('show'); DUPLICATE_PENDING = null; document.getElementById('scan-input').focus(); }
        function forceInsertDuplicate() { if (!DUPLICATE_PENDING) return; const { rawCode, code } = DUPLICATE_PENDING; closeDuplicatePopup(); processCodeInternal(rawCode, code, true); showNotification('‚ö° Duplicado registrado', 'warning'); }
        function processCodeInternal(rawCode, code, forceDuplicate = false) { const item = STATE.inventory.get(code); if (!item) { STATE.pendingCode1 = { raw: rawCode, code }; showResultBox('error', code, 'NO ENCONTRADO', 'C√≥digo no encontrado en WMS.', null); document.getElementById('code2-container').classList.add('show'); flashInput('error'); playSound('error'); setTimeout(() => document.getElementById('code2-input').focus(), 100); return; } document.getElementById('code2-container').classList.remove('show'); STATE.pendingCode1 = null; if (item.isBlocked) { addBox('blocked', createBoxData(rawCode, code, '', item)); showResultBox('blocked', code, 'BLOQUEADO', 'Inventario bloqueado', item); playSound('warning'); } else if (item.isAvailable) { addBox('ok', createBoxData(rawCode, code, '', item)); showResultBox('success', code, 'OK', 'Validado correctamente', item); playSound('success'); } else { addBox('blocked', createBoxData(rawCode, code, '', item)); showResultBox('blocked', code, 'SIN STOCK', 'Sin stock disponible', item); playSound('warning'); } flashInput('success'); }
        function processCode2(rawCode2) { if (!STATE.pendingCode1) return; const code2 = normalizeCode(rawCode2); const item = STATE.inventory.get(code2); document.getElementById('code2-container').classList.remove('show'); if (!item) { addBox('nowms', createBoxData(STATE.pendingCode1.raw, STATE.pendingCode1.code, rawCode2, null)); showResultBox('error', STATE.pendingCode1.code, 'NO WMS', `Ambos c√≥digos no encontrados`, null); playSound('error'); } else if (item.isBlocked) { addBox('blocked', createBoxData(STATE.pendingCode1.raw, code2, rawCode2, item)); showResultBox('blocked', code2, 'BLOQUEADO (C√≥digo 2)', 'Bloqueado', item); playSound('warning'); } else { addBox('ok', createBoxData(STATE.pendingCode1.raw, code2, rawCode2, item)); showResultBox('success', code2, 'OK (C√≥digo 2)', 'Validado con C√≥digo 2', item); playSound('success'); } STATE.pendingCode1 = null; flashInput('success'); document.getElementById('scan-input').focus(); }
        function forceInsert() { if (!STATE.pendingCode1) { showNotification('‚ö†Ô∏è Primero escanea un c√≥digo', 'warning'); return; } const code2Value = document.getElementById('code2-input').value.trim(); addBox('nowms', createBoxData(STATE.pendingCode1.raw, STATE.pendingCode1.code, code2Value, null)); showResultBox('error', STATE.pendingCode1.code, 'INSERTADO (No WMS)', code2Value ? `Con c√≥digos: ${STATE.pendingCode1.code} y ${code2Value}` : `Con c√≥digo: ${STATE.pendingCode1.code}`, null); document.getElementById('code2-container').classList.remove('show'); document.getElementById('code2-input').value = ''; STATE.pendingCode1 = null; playSound('warning'); flashInput('warning'); document.getElementById('scan-input').focus(); showNotification('‚ö° Registro insertado', 'warning'); }
        function createBoxData(raw, code, scan2, item) { return { raw, code, scan1: raw, scan2: scan2 || '', location: item?.cellNo || '-', sku: item?.sku || '-', product: item?.productName || '-', timestamp: new Date().toLocaleTimeString(), user: CURRENT_USER || 'Usuario' }; }
        function normalizeCode(raw) { let code = raw.trim().toUpperCase(); const patterns = [/\[id\[.*?\[([^\[]+)\[/i, /¬®id¬®.*?¬®([^¬®]+)¬®/i, /"id"\s*:\s*"([^"]+)"/i]; for (const pattern of patterns) { const match = code.match(pattern); if (match) return match[1]; } const hasValidDash = /^[A-Z]+\d+\-\d+$/i.test(code); if (!hasValidDash) code = code.replace(/(\d)-(\d)/g, '$1/$2'); return code.replace(/[^a-zA-Z0-9\-\/]/g, ''); }
        function showResultBox(type, code, title, message, item) { const box = document.getElementById('result-box'); const icons = { success: '‚úÖ', warning: '‚ö†Ô∏è', blocked: '‚ö†Ô∏è', error: '‚ùå' }; box.className = `result-box show ${type}`; document.getElementById('result-icon').textContent = icons[type] || 'üì¶'; document.getElementById('result-title').textContent = title; document.getElementById('result-code').textContent = code; const detailsEl = document.getElementById('result-details'); if (item) { detailsEl.innerHTML = `<div><span class="result-detail-label">Ubicaci√≥n</span><div class="result-detail-value">${item.cellNo || '-'}</div></div><div><span class="result-detail-label">SKU</span><div class="result-detail-value">${item.sku || '-'}</div></div><div><span class="result-detail-label">Producto</span><div class="result-detail-value">${item.productName || '-'}</div></div><div><span class="result-detail-label">Stock</span><div class="result-detail-value">${item.availableStock || 0}</div></div>`; } else { detailsEl.innerHTML = `<div style="grid-column: 1/-1; color: #666;">${message}</div>`; } }
        function flashInput(type) { const input = document.getElementById('scan-input'); input.classList.remove('success', 'error'); input.classList.add(type === 'success' ? 'success' : type === 'error' ? 'error' : ''); setTimeout(() => input.classList.remove('success', 'error'), 500); }
        function addBox(category, boxData) { STATE.pallets[category].boxes.push(boxData); saveToStorage(); updateUI(); }
        function deleteBox(category, index) { if (confirm('¬øEliminar esta caja?')) { const box = STATE.pallets[category].boxes[index]; if (box) delete STATE.boxStatuses[box.code]; STATE.pallets[category].boxes.splice(index, 1); saveToStorage(); updateUI(); showNotification('Caja eliminada', 'info'); } }
        function toggleBoxStatus(category, index) { const box = STATE.pallets[category].boxes[index]; if (box) { STATE.boxStatuses[box.code] = !STATE.boxStatuses[box.code]; saveToStorage(); updateUI(); } }
        function initSendPallet(category) { const pallet = STATE.pallets[category]; const locationInput = document.getElementById(`location-${category}`); const location = locationInput.value.trim(); if (pallet.boxes.length === 0) { showNotification('‚ö†Ô∏è No hay cajas', 'warning'); return; } if (!location) { showNotification('‚ö†Ô∏è Ingresa ubicaci√≥n destino', 'warning'); locationInput.focus(); return; } VALIDATION_CATEGORY = category; document.getElementById('validation-expected').textContent = pallet.boxes.length; document.getElementById('validation-entered').textContent = '-'; document.getElementById('validation-input').value = ''; document.getElementById('validation-input').classList.remove('error'); document.getElementById('validation-message').textContent = ''; document.getElementById('validation-confirm-btn').disabled = true; document.getElementById('validation-entered-container').classList.remove('mismatch'); document.getElementById('validation-popup').classList.add('show'); setTimeout(() => document.getElementById('validation-input').focus(), 100); }
        function closeValidationPopup() { document.getElementById('validation-popup').classList.remove('show'); VALIDATION_CATEGORY = null; }
        function checkValidationInput() { const input = document.getElementById('validation-input'); const enteredValue = parseInt(input.value) || 0; const expected = STATE.pallets[VALIDATION_CATEGORY]?.boxes.length || 0; document.getElementById('validation-entered').textContent = enteredValue || '-'; const msgEl = document.getElementById('validation-message'); const confirmBtn = document.getElementById('validation-confirm-btn'); const enteredContainer = document.getElementById('validation-entered-container'); if (enteredValue === expected && enteredValue > 0) { input.classList.remove('error'); enteredContainer.classList.remove('mismatch'); msgEl.innerHTML = '<span style="color: var(--success);">‚úÖ ¬°Cantidades coinciden!</span>'; confirmBtn.disabled = false; } else if (enteredValue > 0) { input.classList.add('error'); enteredContainer.classList.add('mismatch'); msgEl.innerHTML = `<span style="color: var(--error);">‚ùå No coincide (esperado: ${expected})</span>`; confirmBtn.disabled = true; } else { input.classList.remove('error'); enteredContainer.classList.remove('mismatch'); msgEl.textContent = ''; confirmBtn.disabled = true; } }
        function confirmValidation() { if (!VALIDATION_CATEGORY) return; closeValidationPopup(); sendPallet(VALIDATION_CATEGORY); }
        async function sendPallet(category) { const pallet = STATE.pallets[category]; const locationInput = document.getElementById(`location-${category}`); const location = locationInput.value.trim().toUpperCase(); const statusMap = { ok: 'OK', blocked: 'BLOQUEADO', nowms: 'NO WMS' }; const now = new Date(); const dateStr = now.toISOString().slice(0, 10); const timeStr = now.toTimeString().slice(0, 8); const records = pallet.boxes.map(box => ({ date: dateStr, time: timeStr, user: CURRENT_USER || 'Usuario', scan1: box.scan1 || box.raw, scan2: box.scan2 || '', location: location, status: statusMap[category], note: '', pallet: pallet.id, originLocation: STATE.originLocation })); STATE.history = [...records, ...STATE.history].slice(0, 1000); PENDING_SYNC = [...PENDING_SYNC, ...records]; SyncManager.save(); showNotification(`üíæ ${records.length} registros agregados`, 'info'); if (IS_ONLINE && gapi?.client?.getToken()) await SyncManager.sync(); else SyncManager.updateUI(false); const prefixes = { ok: 'OK', blocked: 'BLK', nowms: 'NW' }; pallet.boxes.forEach(box => delete STATE.boxStatuses[box.code]); STATE.pallets[category] = { id: generatePalletId(prefixes[category]), boxes: [], location: '' }; locationInput.value = ''; saveToStorage(); updateUI(); playSound('success'); document.getElementById('scan-input').focus(); }
DETAIL_MODAL_CATEGORY].boxes.indexOf(a); valB = STATE.pallets[DETAIL_MODAL_CATEGORY].boxes.indexOf(b); break; case 'code': valA = a.code; valB = b.code; break; case 'scan2': valA = a.scan2 || ''; valB = b.scan2 || ''; break; case 'location': valA = a.location; valB = b.location; break; case 'timestamp': valA = a.timestamp; valB = b.timestamp; break; default: return 0; } if (valA < valB) return DETAIL_SORT_ASC ? -1 : 1; if (valA > valB) return DETAIL_SORT_ASC ? 1 : -1; return 0; }); }
        function renderDetailTable() { const tbody = document.getElementById('detail-table-body'); if (DETAIL_FILTERED_DATA.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">Sin registros</td></tr>'; return; } tbody.innerHTML = DETAIL_FILTERED_DATA.map((box, idx) => { const realIndex = STATE.pallets[DETAIL_MODAL_CATEGORY].boxes.indexOf(box); const isStatusOk = STATE.boxStatuses[box.code]; const rowClass = isStatusOk ? 'style="background: var(--success-light);"' : ''; return `<tr ${rowClass}><td>${realIndex + 1}</td><td><code>${box.code}</code></td><td><code>${box.scan2 || '-'}</code></td><td>${box.location}</td><td>${box.timestamp}</td><td><div class="row-actions">${DETAIL_MODAL_CATEGORY === 'ok' ? `<button class="action-btn status" onclick="toggleBoxStatusFromModal(${realIndex})" title="Marcar OK">${isStatusOk ? '‚úÖ' : '‚¨ú'}</button>` : ''}<button class="action-btn transfer" onclick="showTransferPopup('${DETAIL_MODAL_CATEGORY}', ${realIndex})" title="Transferir">üîÑ</button><button class="action-btn copy" onclick="copyToClipboard('${box.code}')" title="Copiar">üìã</button><button class="action-btn delete" onclick="deleteBoxFromModal(${realIndex})" title="Eliminar">üóëÔ∏è</button></div></td></tr>`; }).join(''); }
        function toggleBoxStatusFromModal(index) { toggleBoxStatus(DETAIL_MODAL_CATEGORY, index); refreshDetailModal(); }
        function deleteBoxFromModal(index) { if (confirm('¬øEliminar esta caja?')) { const box = STATE.pallets[DETAIL_MODAL_CATEGORY].boxes[index]; if (box) delete STATE.boxStatuses[box.code]; STATE.pallets[DETAIL_MODAL_CATEGORY].boxes.splice(index, 1); saveToStorage(); updateUI(); refreshDetailModal(); showNotification('Caja eliminada', 'info'); } }
        function copyAllDetailCodes() { const codes = DETAIL_FILTERED_DATA.map(b => b.code).join('\n'); copyToClipboard(codes); showNotification(`üìã ${DETAIL_FILTERED_DATA.length} c√≥digos copiados`, 'success'); }
        // COPY FUNCTIONS
        function copyOriginLocation() { const location = document.getElementById('origin-location').value.trim(); if (!location) { showNotification('‚ö†Ô∏è No hay ubicaci√≥n', 'warning'); return; } copyToClipboard(location); showNotification('üìã Ubicaci√≥n copiada', 'success'); }
        function copyCodes(category) { const codes = STATE.pallets[category].boxes.map(b => b.code).join('\n'); if (!codes) { showNotification('‚ö†Ô∏è No hay c√≥digos', 'warning'); return; } copyToClipboard(codes); showNotification(`üìã ${STATE.pallets[category].boxes.length} c√≥digos copiados`, 'success'); }
        function copyColumnLocation(category) { const location = STATE.originLocation; if (!location) { showNotification('‚ö†Ô∏è No hay ubicaci√≥n origen', 'warning'); return; } copyToClipboard(location); showNotification('üìã Ubicaci√≥n copiada', 'success'); }
        function copyToClipboard(text) { navigator.clipboard.writeText(text).catch(() => { const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }); }
        // UI UPDATE FUNCTIONS
        function updateUI() { updateCounts(); updateLists(); updateSidebar(); updateSendButtons(); updateGlobalCounter(); updateOkStatusBadges(); }
        function updateCounts() { document.getElementById('ok-count').textContent = STATE.pallets.ok.boxes.length; document.getElementById('blocked-count').textContent = STATE.pallets.blocked.boxes.length; document.getElementById('nowms-count').textContent = STATE.pallets.nowms.boxes.length; document.getElementById('ok-pallet').textContent = STATE.pallets.ok.id; document.getElementById('blocked-pallet').textContent = STATE.pallets.blocked.id; document.getElementById('nowms-pallet').textContent = STATE.pallets.nowms.id; }
        function updateGlobalCounter() { const total = STATE.pallets.ok.boxes.length + STATE.pallets.blocked.boxes.length + STATE.pallets.nowms.boxes.length; document.getElementById('global-total').textContent = total; }
        function updateOkStatusBadges() { const completed = STATE.pallets.ok.boxes.filter(b => STATE.boxStatuses[b.code]).length; const pending = STATE.pallets.ok.boxes.length - completed; document.getElementById('ok-completed-badge').textContent = completed; document.getElementById('ok-pending-badge').textContent = pending; }
        function updateLists() { updateList('ok'); updateList('blocked'); updateList('nowms'); }
        function updateList(category) { const listEl = document.getElementById(`${category}-list`); const boxes = STATE.pallets[category].boxes; if (boxes.length === 0) { listEl.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><div>Sin cajas</div></div>`; return; } listEl.innerHTML = boxes.map((box, index) => { const isStatusOk = STATE.boxStatuses[box.code]; const statusClass = isStatusOk ? 'status-ok' : ''; return `<div class="box-item ${statusClass}"><div class="box-info"><div class="box-code">${box.code}${box.scan2 ? ` / ${box.scan2}` : ''}</div><div class="box-meta">${box.location} ‚Ä¢ ${box.timestamp}</div></div><div class="box-actions">${category === 'ok' ? `<input type="checkbox" class="box-check" ${isStatusOk ? 'checked' : ''} onchange="toggleBoxStatus('${category}', ${index})" title="Marcar OK">` : ''}<button class="box-transfer" onclick="showTransferPopup('${category}', ${index})" title="Transferir">üîÑ</button><button class="box-delete" onclick="deleteBox('${category}', ${index})" title="Eliminar">‚úï</button></div></div>`; }).join(''); }
        function updateSidebar() { document.getElementById('sidebar-ok-count').textContent = STATE.pallets.ok.boxes.length; document.getElementById('sidebar-blocked-count').textContent = STATE.pallets.blocked.boxes.length; document.getElementById('sidebar-nowms-count').textContent = STATE.pallets.nowms.boxes.length; document.getElementById('sidebar-ok-pallet').textContent = STATE.pallets.ok.id; document.getElementById('sidebar-blocked-pallet').textContent = STATE.pallets.blocked.id; document.getElementById('sidebar-nowms-pallet').textContent = STATE.pallets.nowms.id; }
        function updateSendButtons() { document.getElementById('send-ok-btn').disabled = STATE.pallets.ok.boxes.length === 0; document.getElementById('send-blocked-btn').disabled = STATE.pallets.blocked.boxes.length === 0; document.getElementById('send-nowms-btn').disabled = STATE.pallets.nowms.boxes.length === 0; }
        // EXPORT
        function exportData() { if (STATE.history.length === 0) { showNotification('No hay datos', 'warning'); return; } const headers = ['FECHA', 'HORA', 'RESPONSABLE', 'SCAN 1', 'SCAN 2', 'UBICACION', 'ESTATUS', 'NOTA', 'PALLET', 'UBICACION_ORIGEN']; const rows = STATE.history.map(r => [r.date, r.time, r.user, r.scan1, r.scan2, r.location, r.status, r.note, r.pallet, r.originLocation || '']); const csv = '\ufeff' + [headers.join(','), ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))].join('\n'); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `inventario_${new Date().toISOString().slice(0, 10)}.csv`; link.click(); showNotification('‚úÖ Datos exportados', 'success'); }
        // UTILITIES
        function showNotification(message, type = 'info') { const container = document.getElementById('notifications'); const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' }; const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.innerHTML = `<span style="margin-right: 8px;">${icons[type]}</span>${message}`; container.appendChild(notification); setTimeout(() => notification.remove(), 4000); }
        function playSound(type) { if (!audioCtx) return; try { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); gain.gain.setValueAtTime(0.3, audioCtx.currentTime); if (type === 'success') { osc.frequency.setValueAtTime(880, audioCtx.currentTime); osc.start(); osc.stop(audioCtx.currentTime + 0.15); } else if (type === 'error') { osc.frequency.setValueAtTime(300, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.35); } else if (type === 'warning') { osc.frequency.setValueAtTime(600, audioCtx.currentTime); osc.start(); osc.stop(audioCtx.currentTime + 0.1); } } catch (e) {} }
    </script>
</body>
</html>
