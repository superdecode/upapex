<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inventario</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --blocked: #f97316;
            --bg: #f7f7f7;
            --text: #333;
            --card: #ffffff;
            --border: #e2e8f0;
            --tab-active: #f97316;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* Loading Indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text);
        }

        .loading-subtext {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        /* Connection Banner */
        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s;
        }
        .connection-banner.offline {
            background: var(--error);
            color: white;
            display: block;
        }
        .connection-banner.online {
            background: var(--success);
            color: white;
            display: block;
        }
        .connection-banner.syncing {
            background: var(--warning);
            color: white;
            display: block;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        /* MAIN LAYOUT */
        .main-container {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #555;
        }

        .sidebar-header h2 {
            color: var(--primary);
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.8em;
            color: #aaa;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }

        .sidebar-section-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .sidebar-btn:hover {
            transform: translateX(3px);
        }

        .sidebar-btn-primary {
            background: var(--primary);
            color: white;
        }

        .sidebar-btn-secondary {
            background: #555;
            color: white;
        }

        .sidebar-btn-quick {
            background: var(--tab-active);
            color: white;
        }

        /* Sync Status */
        .sync-status {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            cursor: pointer;
        }
        .sync-ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .sync-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }
        .sync-warning {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* Pallets por estatus */
        .pallet-status-list {
            flex: 1;
            overflow-y: auto;
        }

        .pallet-status-item {
            background: #444;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .pallet-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .pallet-status-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .pallet-status-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .pallet-code {
            font-family: monospace;
            font-size: 0.7em;
            color: #aaa;
            word-break: break-all;
        }

        /* User Footer */
        .user-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            color: white;
            flex-shrink: 0;
            cursor: pointer;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .connection-indicator {
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }
        .connection-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-footer-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .user-footer-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.75em;
        }

        .bd-info {
            font-size: 0.7em;
            color: #aaa;
            text-align: center;
            line-height: 1.4;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tabs Container */
        .tabs-container {
            background: white;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            padding: 8px 15px;
            gap: 8px;
        }

        .tab-new-btn {
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .tab-new-btn:hover {
            background: #1d4ed8;
        }

        .tabs-list {
            display: flex;
            gap: 5px;
            flex: 1;
            overflow-x: auto;
        }

        .tab-item {
            padding: 8px 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            transition: all 0.2s;
            font-size: 0.85em;
            min-width: 150px;
        }

        .tab-item.active {
            background: var(--tab-active);
            color: white;
            border-color: var(--tab-active);
            font-weight: 600;
        }

        .tab-item:not(.active):hover {
            background: #f5f5f5;
        }

        .tab-close {
            margin-left: auto;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.1em;
            padding: 0 4px;
            opacity: 0.7;
        }

        .tab-close:hover {
            opacity: 1;
        }

        /* Tab Content Area */
        .tab-content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-content {
            display: none;
            height: 100%;
            overflow: auto;
            padding: 15px;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Empty State */
        .empty-workspace {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }

        .empty-workspace-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-workspace-text {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .empty-workspace-subtext {
            font-size: 0.9em;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.4em;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        /* Scan Section */
        .scan-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scan-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .scan-input-group {
            flex: 1;
        }

        .scan-input-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .scan-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.3em;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
            transition: all 0.2s;
        }

        .scan-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .scan-input.error {
            border-color: var(--error);
            background: #ffebee;
        }

        .scan-input.success {
            border-color: var(--success);
            background: #e8f5e9;
        }

        /* Result Box */
        .result-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-box.show { display: block; }
        .result-box.success { background: #e8f5e9; border: 2px solid var(--success); }
        .result-box.warning { background: #fff3e0; border: 2px solid var(--warning); }
        .result-box.blocked { background: #fff3e0; border: 2px solid var(--blocked); }
        .result-box.error { background: #ffebee; border: 2px solid var(--error); }

        .result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .result-icon { font-size: 1.5rem; }
        .result-title { font-weight: 700; font-size: 1.1em; }
        .result-code { font-family: monospace; font-weight: 600; }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            font-size: 0.85em;
        }

        .result-detail-label { color: #666; font-size: 0.8em; }
        .result-detail-value { font-weight: 600; }

        /* Code2 Input */
        .code2-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px dashed var(--error);
            display: none;
        }

        .code2-container.show { display: block; }

        .code2-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn-insertado {
            padding: 12px 20px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-insertado:hover {
            background: #d32f2f;
        }

        /* Quick Capture Log */
        .quick-log-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .quick-log-header {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .quick-log-list {
            flex: 1;
            overflow-y: auto;
        }

        .quick-log-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .quick-log-item.success {
            background: #e8f5e9;
            border-color: var(--success);
        }

        .quick-log-item.blocked {
            background: #fff3e0;
            border-color: var(--blocked);
        }

        .quick-log-item.nowms {
            background: #ffebee;
            border-color: var(--error);
        }

        .quick-log-info {
            flex: 1;
        }

        .quick-log-code {
            font-family: monospace;
            font-weight: 600;
            font-size: 1em;
        }

        .quick-log-status {
            font-size: 0.85em;
            margin-top: 4px;
        }

        .quick-log-time {
            font-size: 0.75em;
            color: #666;
        }

        /* Columns Container */
        .columns-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            flex: 1;
            min-height: 0;
        }

        .column {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .column-title {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .column-count {
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
        }

        .column.ok .column-title { color: var(--success); }
        .column.ok .column-count { background: rgba(76, 175, 80, 0.15); color: var(--success); }

        .column.blocked .column-title { color: var(--blocked); }
        .column.blocked .column-count { background: rgba(249, 115, 22, 0.15); color: var(--blocked); }

        .column.nowms .column-title { color: var(--error); }
        .column.nowms .column-count { background: rgba(244, 67, 54, 0.15); color: var(--error); }

        .column-pallet-info {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.8em;
        }

        .column-pallet-code {
            font-family: monospace;
            font-weight: 600;
            color: var(--primary);
        }

        .column-location-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
            margin-top: 6px;
        }

        .column-send-btn {
            margin-top: 8px;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 0.85em;
        }

        .column-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .column.ok .column-send-btn { background: var(--success); color: white; }
        .column.blocked .column-send-btn { background: var(--blocked); color: white; }
        .column.nowms .column-send-btn { background: var(--error); color: white; }

        .column-list {
            flex: 1;
            overflow-y: auto;
            counter-reset: item-counter;
        }

        .box-item {
            padding: 8px 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid;
            counter-increment: item-counter;
        }

        .box-item::before {
            content: counter(item-counter) ".";
            font-weight: 700;
            min-width: 25px;
            margin-right: 8px;
        }

        .column.ok .box-item { border-color: var(--success); }
        .column.ok .box-item::before { color: var(--success); }

        .column.blocked .box-item { border-color: var(--blocked); }
        .column.blocked .box-item::before { color: var(--blocked); }

        .column.nowms .box-item { border-color: var(--error); }
        .column.nowms .box-item::before { color: var(--error); }

        .box-info { flex: 1; }
        .box-code { font-weight: 600; font-family: monospace; font-size: 0.9em; }
        .box-meta { font-size: 0.75em; color: #666; }

        .box-delete {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1.1em;
            padding: 4px;
            opacity: 0.6;
        }

        .box-delete:hover { opacity: 1; }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #999;
        }

        .empty-icon { font-size: 2.5em; margin-bottom: 8px; opacity: 0.5; }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-google { background: #4285F4; color: white; }

        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        .btn-full { width: 100%; }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .notification {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }

        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Popups */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-overlay.show { display: flex; }

        .popup-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .popup-header {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .popup-close:hover { color: #333; }

        .popup-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        /* Resumen Module */
        .resumen-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .resumen-stat {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f5f5f5;
        }

        .resumen-stat-number {
            font-size: 2em;
            font-weight: 700;
        }

        .resumen-stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .resumen-stat.ok { border: 2px solid var(--success); }
        .resumen-stat.ok .resumen-stat-number { color: var(--success); }

        .resumen-stat.blocked { border: 2px solid var(--blocked); }
        .resumen-stat.blocked .resumen-stat-number { color: var(--blocked); }

        .resumen-stat.nowms { border: 2px solid var(--error); }
        .resumen-stat.nowms .resumen-stat-number { color: var(--error); }

        .resumen-stat.pending { border: 2px solid var(--warning); }
        .resumen-stat.pending .resumen-stat-number { color: var(--warning); }

        .resumen-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .resumen-table th, .resumen-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .resumen-table th {
            background: #f5f5f5;
            font-weight: 700;
            position: sticky;
            top: 0;
        }

        .resumen-table-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .resumen-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 180px; }
            .columns-container { grid-template-columns: 1fr; }
            .resumen-stats { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; max-height: 200px; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Cargando Inventario...</div>
            <div class="loading-subtext">Por favor espera</div>
        </div>
    </div>

    <div class="connection-banner" id="connection-banner"></div>
    <div class="notification-container" id="notifications"></div>

    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">üì¶</div>
            <h1 class="login-title">Sistema Inventario</h1>
            <p class="login-subtitle">Control y gesti√≥n de mercanc√≠a</p>
            <button class="btn btn-google btn-full" onclick="handleLogin()" style="padding: 15px; font-size: 1.1em;">
                üîê Iniciar sesi√≥n con Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <div class="main-container">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>üì¶ Inventario</h2>
                    <p>Sistema de gesti√≥n</p>
                </div>

                <!-- Sync Status -->
                <div id="sync-status" class="sync-status sync-ok" onclick="SyncManager.showPanel()">
                    ‚úÖ Sincronizado
                </div>

                <!-- Menu -->
                <div class="sidebar-section">
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showResumen()">
                        üìä Resumen
                    </button>
                    <button class="sidebar-btn sidebar-btn-quick" onclick="openQuickCapture()">
                        ‚ö° Captura R√°pida
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="newSession()">
                        ‚ûï Nueva Sesi√≥n
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="exportData()">
                        üì• Exportar
                    </button>
                </div>

                <!-- Pallets por estatus -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Tarimas Activas</div>
                    <div class="pallet-status-list" id="pallet-status-list">
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--success);">‚úÖ OK</span>
                                <span class="pallet-status-count" id="sidebar-ok-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-ok-pallet">-</div>
                        </div>
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--blocked);">‚ö†Ô∏è Bloqueado</span>
                                <span class="pallet-status-count" id="sidebar-blocked-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-blocked-pallet">-</div>
                        </div>
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--error);">‚ùå No WMS</span>
                                <span class="pallet-status-count" id="sidebar-nowms-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-nowms-pallet">-</div>
                        </div>
                    </div>
                </div>

                <!-- User Footer -->
                <div class="user-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar" onclick="changeUserAlias()">?</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name-display" onclick="changeUserAlias()">No conectado</div>
                            <div class="connection-indicator">
                                <div class="connection-dot" id="connection-dot"></div>
                                <span id="connection-text">Offline</span>
                            </div>
                        </div>
                    </div>
                    <div class="user-footer-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshInventory()">üîÑ BD</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleConnection()" id="sidebar-auth-btn">üîó</button>
                        <button class="btn btn-danger btn-small" onclick="handleLogout()">üö™</button>
                    </div>
                    <div class="bd-info">
                        <div><span id="bd-count">0</span> c√≥digos cargados</div>
                        <div id="bd-update-time">Sin actualizar</div>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- Tabs -->
                <div class="tabs-container">
                    <button class="tab-new-btn" onclick="TabManager.createTab()">‚ûï Nuevo</button>
                    <div class="tabs-list" id="tabs-list"></div>
                </div>

                <!-- Tab Content Area -->
                <div class="tab-content-area" id="tab-content-area">
                    <!-- Empty State -->
                    <div class="empty-workspace" id="empty-workspace">
                        <div class="empty-workspace-icon">üì¶</div>
                        <div class="empty-workspace-text">No hay pesta√±as abiertas</div>
                        <div class="empty-workspace-subtext">Haz clic en "‚ûï Nuevo" para comenzar</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESUMEN POPUP -->
    <div class="popup-overlay" id="resumen-popup">
        <div class="popup-content">
            <div class="popup-header">
                <span>üìä Resumen de Sesi√≥n</span>
                <button class="popup-close" onclick="closeResumen()">√ó</button>
            </div>

            <div class="resumen-stats">
                <div class="resumen-stat ok">
                    <div class="resumen-stat-number" id="resumen-ok">0</div>
                    <div class="resumen-stat-label">OK</div>
                </div>
                <div class="resumen-stat blocked">
                    <div class="resumen-stat-number" id="resumen-blocked">0</div>
                    <div class="resumen-stat-label">Bloqueado</div>
                </div>
                <div class="resumen-stat nowms">
                    <div class="resumen-stat-number" id="resumen-nowms">0</div>
                    <div class="resumen-stat-label">No WMS</div>
                </div>
                <div class="resumen-stat pending">
                    <div class="resumen-stat-number" id="resumen-pending">0</div>
                    <div class="resumen-stat-label">Pendientes Sync</div>
                </div>
            </div>

            <div class="resumen-actions">
                <button class="btn btn-primary btn-small" onclick="refreshInventory(); closeResumen();">üîÑ Recargar BD</button>
                <button class="btn btn-success btn-small" onclick="SyncManager.sync(); updateResumen();">üîÑ Sincronizar</button>
                <button class="btn btn-secondary btn-small" onclick="exportData();">üì• Exportar</button>
            </div>

            <h3 style="margin-bottom: 10px; font-size: 1em;">üìã Historial Reciente</h3>
            <div class="resumen-table-container">
                <table class="resumen-table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>C√≥digo</th>
                            <th>C√≥digo 2</th>
                            <th>Estatus</th>
                            <th>Ubicaci√≥n</th>
                            <th>Pallet</th>
                        </tr>
                    </thead>
                    <tbody id="resumen-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            CLIENT_ID: '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile',
            SPREADSHEET_WRITE: '1FBhZloEeT-xTe1yVKzdWxGJa6gKkZQOObmkBMuxqcv8',
            SHEET_NAME: 'BD',  // Hoja para escaneo normal
            SHEET_QUICK: 'BD2',  // Hoja para captura r√°pida
            INVENTORY_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-HG8HPf-94Ki5Leo5iEF5pyqsiD9CVk-mcl-F8BAw34kT0s3nzNn532YTYDCtkG76NbauiVx0Ffmd/pub?output=csv',
            MAX_TABS: 4
        };

        // ==================== STATE ====================
        let STATE = {
            inventory: new Map(),
            inventoryLastUpdate: null,
            pallets: {
                ok: { id: generatePalletId('OK'), boxes: [], location: '' },
                blocked: { id: generatePalletId('BLK'), boxes: [], location: '' },
                nowms: { id: generatePalletId('NW'), boxes: [], location: '' }
            },
            pendingCode1: null,
            history: [],
            quickHistory: []  // Historial separado para captura r√°pida
        };

        let CURRENT_USER = '';
        let USER_EMAIL = '';
        let USER_GOOGLE_NAME = '';
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];
        let PENDING_SYNC_QUICK = [];  // Cola separada para captura r√°pida
        let TOKEN_CLIENT = null;
        let audioCtx = null;

        // ==================== TAB MANAGER ====================
        const TabManager = {
            tabs: [],
            activeTabId: null,
            nextId: 1,

            init() {
                this.updateUI();
            },

            createTab(type = 'normal') {
                if (this.tabs.length >= CONFIG.MAX_TABS) {
                    showNotification(`‚ö†Ô∏è M√°ximo ${CONFIG.MAX_TABS} pesta√±as`, 'warning');
                    return null;
                }

                const tabId = `tab-${this.nextId++}`;
                const tab = {
                    id: tabId,
                    type,  // 'normal' or 'quick'
                    title: type === 'quick' ? '‚ö° Captura R√°pida' : 'üì¶ Escaneo',
                    timestamp: Date.now()
                };

                this.tabs.push(tab);
                this.createTabContent(tabId, type);
                this.setActiveTab(tabId);
                this.updateUI();
                this.saveState();

                return tabId;
            },

            createTabContent(tabId, type) {
                const contentArea = document.getElementById('tab-content-area');
                const emptyState = document.getElementById('empty-workspace');
                if (emptyState) emptyState.style.display = 'none';

                const tabContent = document.createElement('div');
                tabContent.id = tabId;
                tabContent.className = 'tab-content';

                if (type === 'quick') {
                    tabContent.innerHTML = this.getQuickCaptureHTML(tabId);
                } else {
                    tabContent.innerHTML = this.getNormalScanHTML(tabId);
                }

                contentArea.appendChild(tabContent);
                this.setupTabEventListeners(tabId, type);
            },

            getNormalScanHTML(tabId) {
                return `
                    <div class="header">
                        <h1>üì∏ √Årea de Escaneo</h1>
                    </div>

                    <div class="scan-section">
                        <div class="scan-row">
                            <div class="scan-input-group">
                                <label>üîç C√≥digo Principal</label>
                                <input type="text" class="scan-input" id="scan-input-${tabId}" placeholder="Escanea o ingresa c√≥digo..." autocomplete="off">
                            </div>
                        </div>

                        <div class="result-box" id="result-box-${tabId}">
                            <div class="result-header">
                                <span class="result-icon" id="result-icon-${tabId}">üì¶</span>
                                <span class="result-title" id="result-title-${tabId}">Estado</span>
                            </div>
                            <div class="result-code" id="result-code-${tabId}"></div>
                            <div class="result-details" id="result-details-${tabId}"></div>
                        </div>

                        <div class="code2-container" id="code2-container-${tabId}">
                            <label style="font-size: 0.9em; color: var(--error); font-weight: 600; margin-bottom: 8px; display: block;">
                                ‚ö†Ô∏è C√≥digo no encontrado. Ingresa C√≥digo 2 o fuerza el registro:
                            </label>
                            <div class="code2-row">
                                <div class="scan-input-group">
                                    <input type="text" class="scan-input" id="code2-input-${tabId}" placeholder="C√≥digo 2..." autocomplete="off" style="font-size: 1.1em;">
                                </div>
                                <button class="btn-insertado" onclick="TabManager.forceInsert('${tabId}')">
                                    ‚ö° INSERTADO
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="columns-container">
                        <div class="column ok">
                            <div class="column-header">
                                <span class="column-title">‚úÖ OK</span>
                                <span class="column-count" id="ok-count-${tabId}">0</span>
                            </div>
                            <div class="column-pallet-info">
                                <div>Pallet: <span class="column-pallet-code" id="ok-pallet-${tabId}">-</span></div>
                                <input type="text" class="column-location-input" id="location-ok-${tabId}" placeholder="üìç Ubicaci√≥n destino...">
                                <button class="column-send-btn" onclick="TabManager.sendPallet('${tabId}', 'ok')" id="send-ok-btn-${tabId}" disabled>
                                    üì§ Enviar Tarima OK
                                </button>
                            </div>
                            <div class="column-list" id="ok-list-${tabId}">
                                <div class="empty-state">
                                    <div class="empty-icon">üì≠</div>
                                    <div>Sin cajas</div>
                                </div>
                            </div>
                        </div>

                        <div class="column blocked">
                            <div class="column-header">
                                <span class="column-title">‚ö†Ô∏è Bloqueado</span>
                                <span class="column-count" id="blocked-count-${tabId}">0</span>
                            </div>
                            <div class="column-pallet-info">
                                <div>Pallet: <span class="column-pallet-code" id="blocked-pallet-${tabId}">-</span></div>
                                <input type="text" class="column-location-input" id="location-blocked-${tabId}" placeholder="üìç Ubicaci√≥n destino...">
                                <button class="column-send-btn" onclick="TabManager.sendPallet('${tabId}', 'blocked')" id="send-blocked-btn-${tabId}" disabled>
                                    üì§ Enviar Tarima Bloqueado
                                </button>
                            </div>
                            <div class="column-list" id="blocked-list-${tabId}">
                                <div class="empty-state">
                                    <div class="empty-icon">üì≠</div>
                                    <div>Sin cajas</div>
                                </div>
                            </div>
                        </div>

                        <div class="column nowms">
                            <div class="column-header">
                                <span class="column-title">‚ùå No WMS</span>
                                <span class="column-count" id="nowms-count-${tabId}">0</span>
                            </div>
                            <div class="column-pallet-info">
                                <div>Pallet: <span class="column-pallet-code" id="nowms-pallet-${tabId}">-</span></div>
                                <input type="text" class="column-location-input" id="location-nowms-${tabId}" placeholder="üìç Ubicaci√≥n destino...">
                                <button class="column-send-btn" onclick="TabManager.sendPallet('${tabId}', 'nowms')" id="send-nowms-btn-${tabId}" disabled>
                                    üì§ Enviar Tarima No WMS
                                </button>
                            </div>
                            <div class="column-list" id="nowms-list-${tabId}">
                                <div class="empty-state">
                                    <div class="empty-icon">üì≠</div>
                                    <div>Sin cajas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            getQuickCaptureHTML(tabId) {
                return `
                    <div class="header">
                        <h1>‚ö° Captura R√°pida</h1>
                    </div>

                    <div class="scan-section">
                        <div class="scan-row">
                            <div class="scan-input-group">
                                <label>üîç Escanear C√≥digo</label>
                                <input type="text" class="scan-input" id="quick-input-${tabId}" placeholder="Escanea c√≥digo..." autocomplete="off">
                            </div>
                        </div>
                    </div>

                    <div class="quick-log-container">
                        <div class="quick-log-header">üìã Log de Escaneos (BD2)</div>
                        <div class="quick-log-list" id="quick-log-${tabId}">
                            <div class="empty-state">
                                <div class="empty-icon">üìù</div>
                                <div>Sin escaneos</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            setupTabEventListeners(tabId, type) {
                if (type === 'quick') {
                    const input = document.getElementById(`quick-input-${tabId}`);
                    if (input) {
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' && input.value.trim()) {
                                e.preventDefault();
                                this.processQuickScan(tabId, input.value.trim());
                                input.value = '';
                            }
                        });
                    }
                } else {
                    const scanInput = document.getElementById(`scan-input-${tabId}`);
                    if (scanInput) {
                        scanInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' && scanInput.value.trim()) {
                                e.preventDefault();
                                this.processScan(tabId, scanInput.value.trim());
                                scanInput.value = '';
                            }
                        });
                    }

                    const code2Input = document.getElementById(`code2-input-${tabId}`);
                    if (code2Input) {
                        code2Input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' && code2Input.value.trim()) {
                                e.preventDefault();
                                this.processCode2(tabId, code2Input.value.trim());
                                code2Input.value = '';
                            }
                        });
                    }
                }
            },

            processQuickScan(tabId, rawCode) {
                const code = normalizeCode(rawCode);
                let item = STATE.inventory.get(code);
                let usedCode2 = false;
                let actualCode = code;

                // Si no se encuentra, intentar con c√≥digo 2 autom√°ticamente
                if (!item) {
                    const code2 = normalizeCode(rawCode + '-ALT'); // Aqu√≠ podr√≠as implementar l√≥gica m√°s sofisticada
                    item = STATE.inventory.get(code2);
                    if (item) {
                        usedCode2 = true;
                        actualCode = code2;
                    }
                }

                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10);
                const timeStr = now.toTimeString().slice(0, 8);

                let status, statusClass;

                if (!item) {
                    status = 'NO WMS';
                    statusClass = 'nowms';
                    playSound('error');
                } else if (item.isBlocked) {
                    status = 'BLOQUEADO';
                    statusClass = 'blocked';
                    playSound('warning');
                } else if (item.isAvailable) {
                    status = 'OK';
                    statusClass = 'success';
                    playSound('success');
                } else {
                    status = 'SIN STOCK';
                    statusClass = 'blocked';
                    playSound('warning');
                }

                // Guardar en historial r√°pido
                const entry = {
                    date: dateStr,
                    time: timeStr,
                    user: CURRENT_USER || 'Usuario',
                    scan1: rawCode,
                    scan2: usedCode2 ? actualCode : '',
                    location: item?.cellNo || '-',
                    status,
                    note: usedCode2 ? 'C√≥digo 2 usado autom√°ticamente' : '',
                    pallet: '-',
                    displayTime: now.toLocaleTimeString()
                };

                STATE.quickHistory.unshift(entry);
                STATE.quickHistory = STATE.quickHistory.slice(0, 100);

                // Agregar a cola de sincronizaci√≥n
                PENDING_SYNC_QUICK.push(entry);
                SyncManager.save();

                // Actualizar UI
                this.updateQuickLog(tabId);

                // Sincronizar autom√°ticamente si est√° online
                if (IS_ONLINE && gapi?.client?.getToken()) {
                    SyncManager.syncQuick(false);
                }
            },

            updateQuickLog(tabId) {
                const logEl = document.getElementById(`quick-log-${tabId}`);
                if (!logEl) return;

                if (STATE.quickHistory.length === 0) {
                    logEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìù</div>
                            <div>Sin escaneos</div>
                        </div>
                    `;
                    return;
                }

                logEl.innerHTML = STATE.quickHistory.map(entry => `
                    <div class="quick-log-item ${entry.status === 'OK' ? 'success' : entry.status === 'BLOQUEADO' ? 'blocked' : 'nowms'}">
                        <div class="quick-log-info">
                            <div class="quick-log-code">${entry.scan1}${entry.scan2 ? ` ‚Üí ${entry.scan2}` : ''}</div>
                            <div class="quick-log-status">
                                ${entry.status === 'OK' ? '‚úÖ' : entry.status === 'BLOQUEADO' ? '‚ö†Ô∏è' : '‚ùå'} 
                                ${entry.status}
                                ${entry.scan2 ? ' (C√≥digo 2)' : ''}
                            </div>
                        </div>
                        <div class="quick-log-time">${entry.displayTime}</div>
                    </div>
                `).join('');
            },

            processScan(tabId, rawCode) {
                const code = normalizeCode(rawCode);

                // Check duplicates
                const allBoxes = [
                    ...STATE.pallets.ok.boxes,
                    ...STATE.pallets.blocked.boxes,
                    ...STATE.pallets.nowms.boxes
                ];

                if (allBoxes.some(b => b.code === code)) {
                    showNotification('‚ö†Ô∏è C√≥digo duplicado', 'warning');
                    this.flashInput(tabId, 'warning');
                    playSound('warning');
                    return;
                }

                const item = STATE.inventory.get(code);

                if (!item) {
                    STATE.pendingCode1 = { raw: rawCode, code, tabId };
                    this.showResultBox(tabId, 'error', code, 'NO ENCONTRADO',
                        'C√≥digo no encontrado en WMS. Ingresa C√≥digo 2 o usa INSERTADO.', null);
                    document.getElementById(`code2-container-${tabId}`).classList.add('show');
                    this.flashInput(tabId, 'error');
                    playSound('error');
                    setTimeout(() => document.getElementById(`code2-input-${tabId}`)?.focus(), 100);
                    return;
                }

                document.getElementById(`code2-container-${tabId}`).classList.remove('show');
                STATE.pendingCode1 = null;
                this.flashInput(tabId, 'success');
                document.getElementById(`scan-input-${tabId}`)?.focus();
                this.updateTabUI(tabId);
            },

            forceInsert(tabId) {
                if (!STATE.pendingCode1 || STATE.pendingCode1.tabId !== tabId) {
                    showNotification('‚ö†Ô∏è Primero escanea un c√≥digo', 'warning');
                    return;
                }

                const code2Value = document.getElementById(`code2-input-${tabId}`)?.value.trim() || '';

                this.addBox('nowms', createBoxData(
                    STATE.pendingCode1.raw,
                    STATE.pendingCode1.code,
                    code2Value,
                    null
                ));

                const msg = code2Value
                    ? `Insertado con c√≥digos: ${STATE.pendingCode1.code} y ${code2Value}`
                    : `Insertado con c√≥digo: ${STATE.pendingCode1.code}`;

                this.showResultBox(tabId, 'error', STATE.pendingCode1.code, 'INSERTADO (No WMS)', msg, null);

                document.getElementById(`code2-container-${tabId}`).classList.remove('show');
                const code2Input = document.getElementById(`code2-input-${tabId}`);
                if (code2Input) code2Input.value = '';
                STATE.pendingCode1 = null;

                playSound('warning');
                this.flashInput(tabId, 'warning');
                document.getElementById(`scan-input-${tabId}`)?.focus();
                showNotification('‚ö° Registro insertado forzosamente', 'warning');
                this.updateTabUI(tabId);
            },

            addBox(category, boxData) {
                STATE.pallets[category].boxes.push(boxData);
                saveToStorage();
                updateUI();
            },

            showResultBox(tabId, type, code, title, message, item) {
                const box = document.getElementById(`result-box-${tabId}`);
                if (!box) return;

                const icons = { success: '‚úÖ', warning: '‚ö†Ô∏è', blocked: '‚ö†Ô∏è', error: '‚ùå' };

                box.className = `result-box show ${type}`;
                const iconEl = document.getElementById(`result-icon-${tabId}`);
                const titleEl = document.getElementById(`result-title-${tabId}`);
                const codeEl = document.getElementById(`result-code-${tabId}`);
                const detailsEl = document.getElementById(`result-details-${tabId}`);

                if (iconEl) iconEl.textContent = icons[type] || 'üì¶';
                if (titleEl) titleEl.textContent = title;
                if (codeEl) codeEl.textContent = code;

                if (detailsEl) {
                    if (item) {
                        detailsEl.innerHTML = `
                            <div><span class="result-detail-label">Ubicaci√≥n</span><div class="result-detail-value">${item.cellNo || '-'}</div></div>
                            <div><span class="result-detail-label">SKU</span><div class="result-detail-value">${item.sku || '-'}</div></div>
                            <div><span class="result-detail-label">Producto</span><div class="result-detail-value">${item.productName || '-'}</div></div>
                            <div><span class="result-detail-label">Stock</span><div class="result-detail-value">${item.availableStock || 0}</div></div>
                        `;
                    } else {
                        detailsEl.innerHTML = `<div style="grid-column: 1/-1; color: #666;">${message}</div>`;
                    }
                }
            },

            flashInput(tabId, type) {
                const input = document.getElementById(`scan-input-${tabId}`) || document.getElementById(`quick-input-${tabId}`);
                if (!input) return;
                input.classList.remove('success', 'error');
                input.classList.add(type === 'success' ? 'success' : type === 'error' ? 'error' : '');
                setTimeout(() => input.classList.remove('success', 'error'), 500);
            },

            updateTabUI(tabId) {
                // Update counts
                const okCount = document.getElementById(`ok-count-${tabId}`);
                const blockedCount = document.getElementById(`blocked-count-${tabId}`);
                const nowmsCount = document.getElementById(`nowms-count-${tabId}`);

                if (okCount) okCount.textContent = STATE.pallets.ok.boxes.length;
                if (blockedCount) blockedCount.textContent = STATE.pallets.blocked.boxes.length;
                if (nowmsCount) nowmsCount.textContent = STATE.pallets.nowms.boxes.length;

                // Update pallet IDs
                const okPallet = document.getElementById(`ok-pallet-${tabId}`);
                const blockedPallet = document.getElementById(`blocked-pallet-${tabId}`);
                const nowmsPallet = document.getElementById(`nowms-pallet-${tabId}`);

                if (okPallet) okPallet.textContent = STATE.pallets.ok.id;
                if (blockedPallet) blockedPallet.textContent = STATE.pallets.blocked.id;
                if (nowmsPallet) nowmsPallet.textContent = STATE.pallets.nowms.id;

                // Update lists
                this.updateList(tabId, 'ok');
                this.updateList(tabId, 'blocked');
                this.updateList(tabId, 'nowms');

                // Update send buttons
                const sendOkBtn = document.getElementById(`send-ok-btn-${tabId}`);
                const sendBlockedBtn = document.getElementById(`send-blocked-btn-${tabId}`);
                const sendNowmsBtn = document.getElementById(`send-nowms-btn-${tabId}`);

                if (sendOkBtn) sendOkBtn.disabled = STATE.pallets.ok.boxes.length === 0;
                if (sendBlockedBtn) sendBlockedBtn.disabled = STATE.pallets.blocked.boxes.length === 0;
                if (sendNowmsBtn) sendNowmsBtn.disabled = STATE.pallets.nowms.boxes.length === 0;
            },

            updateList(tabId, category) {
                const listEl = document.getElementById(`${category}-list-${tabId}`);
                if (!listEl) return;

                const boxes = STATE.pallets[category].boxes;

                if (boxes.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div>Sin cajas</div>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = boxes.map((box, index) => `
                    <div class="box-item">
                        <div class="box-info">
                            <div class="box-code">${box.code}${box.scan2 ? ` / ${box.scan2}` : ''}</div>
                            <div class="box-meta">${box.location} ‚Ä¢ ${box.timestamp}</div>
                        </div>
                        <button class="box-delete" onclick="TabManager.deleteBox('${tabId}', '${category}', ${index})">‚úï</button>
                    </div>
                `).join('');
            },

            deleteBox(tabId, category, index) {
                if (confirm('¬øEliminar esta caja?')) {
                    STATE.pallets[category].boxes.splice(index, 1);
                    saveToStorage();
                    this.updateTabUI(tabId);
                    updateUI();
                    showNotification('Caja eliminada', 'info');
                }
            },

            async sendPallet(tabId, category) {
                const pallet = STATE.pallets[category];
                const locationInput = document.getElementById(`location-${category}-${tabId}`);
                const location = locationInput?.value.trim() || '';

                if (pallet.boxes.length === 0) {
                    showNotification('‚ö†Ô∏è No hay cajas en esta tarima', 'warning');
                    return;
                }

                if (!location) {
                    showNotification('‚ö†Ô∏è Ingresa la ubicaci√≥n destino', 'warning');
                    locationInput?.focus();
                    return;
                }

                // Validar formato de ubicaci√≥n
                const locationCheck = confirmInvalidLocation(location);
                if (!locationCheck.confirmed) {
                    showNotification('‚ùå Env√≠o cancelado - Verifica la ubicaci√≥n', 'warning');
                    locationInput?.focus();
                    return;
                }

                const finalLocation = locationCheck.formatted;
                if (locationInput) locationInput.value = finalLocation;

                const statusMap = { ok: 'OK', blocked: 'BLOQUEADO', nowms: 'NO WMS' };
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10);
                const timeStr = now.toTimeString().slice(0, 8);

                const records = pallet.boxes.map(box => ({
                    date: dateStr,
                    time: timeStr,
                    user: CURRENT_USER || 'Usuario',
                    scan1: box.scan1 || box.raw,
                    scan2: box.scan2 || '',
                    location: finalLocation,
                    status: statusMap[category],
                    note: '',
                    pallet: pallet.id
                }));

                STATE.history = [...records, ...STATE.history].slice(0, 1000);
                PENDING_SYNC = [...PENDING_SYNC, ...records];
                SyncManager.save();

                showNotification(`üíæ ${records.length} registros agregados`, 'info');

                if (IS_ONLINE && gapi?.client?.getToken()) {
                    await SyncManager.sync();
                } else {
                    SyncManager.updateUI(false);
                }

                const prefixes = { ok: 'OK', blocked: 'BLK', nowms: 'NW' };
                STATE.pallets[category] = {
                    id: generatePalletId(prefixes[category]),
                    boxes: [],
                    location: ''
                };
                if (locationInput) locationInput.value = '';

                saveToStorage();
                this.updateTabUI(tabId);
                updateUI();
                playSound('success');
                document.getElementById(`scan-input-${tabId}`)?.focus();
            },

            closeTab(tabId) {
                const tabIndex = this.tabs.findIndex(t => t.id === tabId);
                if (tabIndex === -1) return;

                const tab = this.tabs[tabIndex];

                // Check if normal tab has unsent boxes
                if (tab.type === 'normal') {
                    const totalBoxes = STATE.pallets.ok.boxes.length +
                                      STATE.pallets.blocked.boxes.length +
                                      STATE.pallets.nowms.boxes.length;
                    if (totalBoxes > 0) {
                        if (!confirm(`Hay ${totalBoxes} cajas sin enviar. ¬øCerrar de todas formas?`)) {
                            return;
                        }
                    }
                }

                this.tabs.splice(tabIndex, 1);
                const contentEl = document.getElementById(tabId);
                if (contentEl) contentEl.remove();

                if (this.activeTabId === tabId) {
                    if (this.tabs.length > 0) {
                        const newActiveTab = this.tabs[Math.max(0, tabIndex - 1)];
                        this.setActiveTab(newActiveTab.id);
                    } else {
                        this.activeTabId = null;
                        const emptyState = document.getElementById('empty-workspace');
                        if (emptyState) emptyState.style.display = 'flex';
                    }
                }

                this.updateUI();
                this.saveState();
            },

            setActiveTab(tabId) {
                this.activeTabId = tabId;
                
                // Update tab content visibility
                document.querySelectorAll('.tab-content').forEach(el => {
                    el.classList.toggle('active', el.id === tabId);
                });

                // Update tab buttons
                document.querySelectorAll('.tab-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.tabId === tabId);
                });

                // Focus input
                setTimeout(() => {
                    const tab = this.tabs.find(t => t.id === tabId);
                    if (tab) {
                        if (tab.type === 'quick') {
                            document.getElementById(`quick-input-${tabId}`)?.focus();
                        } else {
                            document.getElementById(`scan-input-${tabId}`)?.focus();
                        }
                    }
                }, 100);

                this.saveState();
            },

            updateUI() {
                const tabsList = document.getElementById('tabs-list');
                if (!tabsList) return;

                if (this.tabs.length === 0) {
                    tabsList.innerHTML = '';
                    const emptyState = document.getElementById('empty-workspace');
                    if (emptyState) emptyState.style.display = 'flex';
                    return;
                }

                const emptyState = document.getElementById('empty-workspace');
                if (emptyState) emptyState.style.display = 'none';

                tabsList.innerHTML = this.tabs.map(tab => `
                    <div class="tab-item ${tab.id === this.activeTabId ? 'active' : ''}" 
                         data-tab-id="${tab.id}"
                         onclick="TabManager.setActiveTab('${tab.id}')">
                        <span>${tab.title}</span>
                        <button class="tab-close" onclick="event.stopPropagation(); TabManager.closeTab('${tab.id}')">√ó</button>
                    </div>
                `).join('');
            },

            saveState() {
                try {
                    const state = {
                        tabs: this.tabs,
                        activeTabId: this.activeTabId,
                        nextId: this.nextId
                    };
                    localStorage.setItem('pd_tabs_state', JSON.stringify(state));
                } catch (e) {
                    console.error('Error saving tabs:', e);
                }
            },

            loadState() {
                try {
                    const saved = localStorage.getItem('pd_tabs_state');
                    if (saved) {
                        const state = JSON.parse(saved);
                        this.nextId = state.nextId || 1;
                        // Don't restore tabs on load, start fresh
                    }
                } catch (e) {
                    console.error('Error loading tabs:', e);
                }
            }
        };

        // ==================== SYNC MANAGER ====================
        const SyncManager = {
            inProgress: false,
            retryCount: 0,
            intervalId: null,
            AUTO_SYNC_INTERVAL: 30000,

            init() {
                this.load();
                this.startAutoSync();
                this.setupExitProtection();
                this.updateUI(PENDING_SYNC.length === 0 && PENDING_SYNC_QUICK.length === 0);
            },

            setupExitProtection() {
                window.addEventListener('beforeunload', (e) => {
                    const hasUnsavedData = PENDING_SYNC.length > 0 ||
                        PENDING_SYNC_QUICK.length > 0 ||
                        STATE.pallets.ok.boxes.length > 0 ||
                        STATE.pallets.blocked.boxes.length > 0 ||
                        STATE.pallets.nowms.boxes.length > 0;

                    if (hasUnsavedData) {
                        e.preventDefault();
                        e.returnValue = '¬°Tienes datos sin sincronizar! ¬øSeguro que quieres salir?';
                        return e.returnValue;
                    }
                });
            },

            startAutoSync() {
                if (this.intervalId) clearInterval(this.intervalId);
                this.intervalId = setInterval(() => {
                    if (IS_ONLINE && gapi?.client?.getToken()) {
                        if (PENDING_SYNC.length > 0) this.sync(false);
                        if (PENDING_SYNC_QUICK.length > 0) this.syncQuick(false);
                    }
                }, this.AUTO_SYNC_INTERVAL);
            },

            async sync(showMessages = true) {
                if (this.inProgress) {
                    if (showMessages) showNotification('‚è≥ Sincronizaci√≥n en progreso...', 'info');
                    return { success: false };
                }

                if (!IS_ONLINE) {
                    if (showMessages) showNotification('‚ö†Ô∏è Sin conexi√≥n a internet', 'warning');
                    return { success: false };
                }

                if (!gapi?.client?.getToken()) {
                    if (showMessages) showNotification('‚ö†Ô∏è No conectado a Google', 'warning');
                    return { success: false };
                }

                if (PENDING_SYNC.length === 0) {
                    this.updateUI(PENDING_SYNC_QUICK.length === 0);
                    if (showMessages) showNotification('‚úÖ Todo sincronizado', 'success');
                    return { success: true, synced: 0 };
                }

                return await this._doSync(showMessages, CONFIG.SHEET_NAME, PENDING_SYNC, 'PENDING_SYNC');
            },

            async syncQuick(showMessages = true) {
                if (this.inProgress) {
                    if (showMessages) showNotification('‚è≥ Sincronizaci√≥n en progreso...', 'info');
                    return { success: false };
                }

                if (!IS_ONLINE || !gapi?.client?.getToken()) {
                    return { success: false };
                }

                if (PENDING_SYNC_QUICK.length === 0) {
                    return { success: true, synced: 0 };
                }

                return await this._doSync(showMessages, CONFIG.SHEET_QUICK, PENDING_SYNC_QUICK, 'PENDING_SYNC_QUICK');
            },

            async _doSync(showMessages, sheetName, pendingArray, arrayName) {
                this.inProgress = true;
                updateConnectionIndicator(true);

                if (showMessages) showNotification('üîÑ Sincronizando...', 'info');

                try {
                    const values = pendingArray.map(r => [
                        r.date, r.time, r.user, r.scan1, r.scan2,
                        r.location, r.status, r.note, r.pallet
                    ]);

                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                        range: `${sheetName}!A:I`,
                        valueInputOption: 'USER_ENTERED',
                        insertDataOption: 'INSERT_ROWS',
                        resource: { values }
                    });

                    const synced = pendingArray.length;
                    
                    if (arrayName === 'PENDING_SYNC') {
                        PENDING_SYNC = [];
                    } else {
                        PENDING_SYNC_QUICK = [];
                    }

                    this.save();
                    this.updateUI(PENDING_SYNC.length === 0 && PENDING_SYNC_QUICK.length === 0);

                    if (showMessages) showNotification(`‚úÖ ${synced} registros sincronizados a ${sheetName}`, 'success');
                    return { success: true, synced };
                } catch (e) {
                    console.error('Sync error:', e);
                    this.updateUI(false);
                    if (showMessages) showNotification(`‚ùå Error: ${e.result?.error?.message || e.message || 'Error desconocido'}`, 'error');
                    return { success: false };
                } finally {
                    this.inProgress = false;
                    updateConnectionIndicator();
                }
            },

            async save() {
                try {
                    localStorage.setItem('pd_pending_sync', JSON.stringify(PENDING_SYNC));
                    localStorage.setItem('pd_pending_sync_quick', JSON.stringify(PENDING_SYNC_QUICK));
                } catch (e) {}
            },

            async load() {
                try {
                    const saved = localStorage.getItem('pd_pending_sync');
                    if (saved) PENDING_SYNC = JSON.parse(saved);
                    
                    const savedQuick = localStorage.getItem('pd_pending_sync_quick');
                    if (savedQuick) PENDING_SYNC_QUICK = JSON.parse(savedQuick);
                } catch (e) {}
            },

            updateUI(synced) {
                const el = document.getElementById('sync-status');
                if (!el) return;

                const totalPending = PENDING_SYNC.length + PENDING_SYNC_QUICK.length;

                if (!IS_ONLINE) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `‚ö†Ô∏è Sin conexi√≥n${totalPending > 0 ? ` (${totalPending})` : ''}`;
                } else if (totalPending > 0) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `‚è≥ ${totalPending} pendientes`;
                } else if (synced) {
                    el.className = 'sync-status sync-ok';
                    el.textContent = '‚úÖ Sincronizado';
                } else {
                    el.className = 'sync-status sync-error';
                    el.textContent = '‚ùå Error sync';
                }
            },

            showPanel() {
                const totalPending = PENDING_SYNC.length + PENDING_SYNC_QUICK.length;
                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay show';
                overlay.innerHTML = `
                    <div class="popup-content" style="max-width: 450px;">
                        <div class="popup-header">
                            <span>üìä Estado de Sincronizaci√≥n</span>
                            <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px; text-align: center;">
                                <div style="font-size: 0.85em; color: #666;">Pendientes de sincronizar</div>
                                <div style="font-size: 2em; font-weight: 700; color: ${totalPending > 0 ? 'var(--warning)' : 'var(--success)'};">
                                    ${totalPending}
                                </div>
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                                    BD: ${PENDING_SYNC.length} | BD2: ${PENDING_SYNC_QUICK.length}
                                </div>
                            </div>
                            <div style="font-size: 0.9em; padding: 10px; background: #f9f9f9; border-radius: 6px;">
                                ${IS_ONLINE ? 'üü¢ Conectado a internet' : 'üî¥ Sin conexi√≥n'}<br>
                                ${gapi?.client?.getToken() ? 'üü¢ Google conectado' : 'üî¥ Google desconectado'}<br>
                                üìÑ Hojas destino: <strong>${CONFIG.SHEET_NAME}</strong> y <strong>${CONFIG.SHEET_QUICK}</strong>
                            </div>
                        </div>
                        <div class="popup-buttons">
                            ${totalPending > 0 && IS_ONLINE && gapi?.client?.getToken() ? `
                                <button class="btn btn-success btn-full" onclick="this.closest('.popup-overlay').remove(); SyncManager.sync(); SyncManager.syncQuick();">
                                    üîÑ Sincronizar Todo
                                </button>
                            ` : ''}
                            <button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">
                                Cerrar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) overlay.remove();
                });
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            initAudio();
            loadFromStorage();
            setupConnectionMonitor();
            TabManager.init();
            gapi.load('client', initGAPI);
        });

        function initAudio() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.addEventListener('click', () => {
                    if (audioCtx?.state === 'suspended') audioCtx.resume();
                }, { once: true });
            } catch (e) {}
        }

        async function initGAPI() {
            try {
                await gapi.client.init({
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
                });
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: handleAuthCallback
                });
            } catch (e) {
                showNotification('Error inicializando API', 'error');
            }
        }

        async function handleAuthCallback(response) {
            if (response?.access_token) {
                gapi.client.setToken(response);
                await getUserProfile();
                await loadInventory();
                SyncManager.init();
                if (PENDING_SYNC.length > 0) SyncManager.sync();
                if (PENDING_SYNC_QUICK.length > 0) SyncManager.syncQuick();
                showApp();
            }
        }

        function handleLogin() {
            TOKEN_CLIENT?.requestAccessToken();
        }

        async function getUserProfile() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` }
                });
                const data = await response.json();
                USER_EMAIL = data.email || '';
                USER_GOOGLE_NAME = data.name || 'Usuario';

                const savedAlias = localStorage.getItem(`pd_alias_${USER_EMAIL}`);
                if (savedAlias) {
                    CURRENT_USER = savedAlias;
                    showNotification(`‚úÖ Bienvenido, ${CURRENT_USER}`, 'success');
                    updateUserFooter();
                } else {
                    showAliasPopup();
                }
            } catch (e) {
                CURRENT_USER = 'Usuario';
                updateUserFooter();
            }
        }

        function showApp() {
            hideLoading();
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateUserFooter();
            updateUI();
        }

        function handleLogout() {
            const hasData = PENDING_SYNC.length > 0 ||
                PENDING_SYNC_QUICK.length > 0 ||
                STATE.pallets.ok.boxes.length > 0 ||
                STATE.pallets.blocked.boxes.length > 0 ||
                STATE.pallets.nowms.boxes.length > 0;

            if (hasData) {
                if (!confirm('‚ö†Ô∏è Tienes datos sin sincronizar. ¬øSeguro que quieres salir?')) {
                    return;
                }
            }

            if (gapi.client.getToken()) {
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                gapi.client.setToken(null);
            }

            CURRENT_USER = '';
            USER_EMAIL = '';
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        // ==================== LOADING INDICATOR ====================
        function showLoading(text = 'Cargando Inventario...', subtext = 'Por favor espera') {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.querySelector('.loading-text').textContent = text;
                overlay.querySelector('.loading-subtext').textContent = subtext;
                overlay.classList.add('show');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.remove('show');
        }

        // ==================== QUICK CAPTURE ====================
        function openQuickCapture() {
            const existing = TabManager.tabs.find(t => t.type === 'quick');
            if (existing) {
                TabManager.setActiveTab(existing.id);
                showNotification('‚ö° Captura R√°pida ya est√° abierta', 'info');
            } else {
                TabManager.createTab('quick');
                showNotification('‚ö° Captura R√°pida iniciada', 'success');
            }
        }

        // ==================== ALIAS/NICKNAME SYSTEM ====================
        function showAliasPopup() {
            document.querySelectorAll('.alias-popup').forEach(e => e.remove());

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show alias-popup';
            overlay.innerHTML = `
                <div class="popup-content" style="max-width: 400px;">
                    <div class="popup-header">üë§ ¬øC√≥mo te llamamos?</div>
                    <p style="margin-bottom: 15px; color: #666;">
                        Hola <strong>${USER_GOOGLE_NAME}</strong>, elige c√≥mo aparecer√° tu nombre en los registros:
                    </p>
                    <div class="popup-buttons">
                        <button class="btn btn-primary btn-full" onclick="saveUserAlias('${USER_GOOGLE_NAME}', true)">
                            üë§ Usar mi nombre de Google
                        </button>
                        <div style="text-align: center; color: #999; font-size: 0.85em;">o</div>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="alias-input" placeholder="Escribe un alias..."
                                style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em;"
                                maxlength="20">
                            <button class="btn btn-success" onclick="saveUserAlias(document.getElementById('alias-input').value)">
                                üíæ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            const input = overlay.querySelector('#alias-input');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    saveUserAlias(input.value);
                }
            });
            input.focus();
        }

        function saveUserAlias(alias, isGoogleName = false) {
            const finalAlias = alias?.trim() || USER_GOOGLE_NAME;
            if (!finalAlias) {
                showNotification('‚ö†Ô∏è Ingresa un nombre v√°lido', 'warning');
                return;
            }

            CURRENT_USER = finalAlias;
            localStorage.setItem(`pd_alias_${USER_EMAIL}`, finalAlias);

            document.querySelectorAll('.alias-popup').forEach(e => e.remove());
            showNotification(`‚úÖ ${isGoogleName ? 'Nombre' : 'Alias'} guardado: ${finalAlias}`, 'success');
            updateUserFooter();
        }

        function changeUserAlias() {
            showAliasPopup();
        }

        function updateUserFooter() {
            const avatar = document.getElementById('user-avatar');
            const nameDisplay = document.getElementById('user-name-display');

            if (avatar) {
                avatar.textContent = CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : '?';
                avatar.title = USER_EMAIL || 'No conectado';
            }
            if (nameDisplay) {
                nameDisplay.textContent = CURRENT_USER || 'No conectado';
                nameDisplay.title = `Click para cambiar alias\n${USER_EMAIL}`;
            }

            updateConnectionIndicator();
        }

        // ==================== INVENTORY ====================
        async function loadInventory() {
            try {
                showLoading('üì¶ Cargando Inventario...', 'Descargando base de datos desde Google Sheets');
                updateConnectionIndicator(true);

                const response = await fetch(CONFIG.INVENTORY_CSV_URL, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const csv = await response.text();
                if (!csv || csv.trim().length === 0) throw new Error('CSV vac√≠o');

                parseInventoryCSV(csv);
                await saveToStorage();
                hideLoading();
                showNotification(`‚úÖ ${STATE.inventory.size} c√≥digos cargados`, 'success');
                updateBdInfo();
            } catch (e) {
                console.error('Error cargando inventario:', e);
                hideLoading();
                showNotification(`‚ö†Ô∏è ${e.message}`, 'warning');

                if (STATE.inventory.size > 0) {
                    showNotification(`Usando ${STATE.inventory.size} c√≥digos en cach√©`, 'info');
                }
            } finally {
                updateConnectionIndicator();
            }
        }

        function parseInventoryCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim().length > 0);
            STATE.inventory.clear();

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);

                if (cols.length >= 11) {
                    const code = (cols[1] || '').toString().trim().toUpperCase();

                    if (code && code.length > 0) {
                        const availableStock = parseFloat(cols[9]) || 0;
                        const lockedInventory = parseFloat(cols[10]) || 0;

                        STATE.inventory.set(code, {
                            code,
                            boxType: cols[0] || '',
                            warehouse: cols[3] || '',
                            cellNo: cols[6] || '',
                            area: cols[8] || '',
                            availableStock,
                            lockedInventory,
                            sku: cols[12] || '',
                            productName: cols[13] || '',
                            isAvailable: availableStock > 0,
                            isBlocked: lockedInventory > 0
                        });
                    }
                }
            }

            STATE.inventoryLastUpdate = new Date().toLocaleString();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function refreshInventory() {
            loadInventory();
        }

        function updateBdInfo() {
            document.getElementById('bd-count').textContent = STATE.inventory.size.toLocaleString();
            document.getElementById('bd-update-time').textContent = STATE.inventoryLastUpdate || 'Sin actualizar';
        }

        // ==================== UTILITIES ====================
        function createBoxData(raw, code, scan2, item) {
            return {
                raw,
                code,
                scan1: raw,
                scan2: scan2 || '',
                location: item?.cellNo || '-',
                sku: item?.sku || '-',
                product: item?.productName || '-',
                timestamp: new Date().toLocaleTimeString()
            };
        }

        function normalizeCode(raw) {
            let code = raw.trim().toUpperCase();

            const patterns = [
                /\[id\[.*?\[([^\[]+)\[/i,
                /¬®id¬®.*?¬®([^¬®]+)¬®/i,
                /"id"\s*:\s*"([^"]+)"/i
            ];

            for (const pattern of patterns) {
                const match = code.match(pattern);
                if (match) return match[1];
            }

            const hasValidDash = /^[A-Z]+\d+\-\d+$/i.test(code);

            if (!hasValidDash) {
                code = code.replace(/(\d)-(\d)/g, '$1/$2');
            }

            return code.replace(/[^a-zA-Z0-9\-\/]/g, '');
        }

        function validateLocation(location) {
            const loc = location.trim().toUpperCase();
            const pattern = /^([A-Z])(\d{1,3})-(\d{1,2})-(\d{1,2})-(\d{1,2})$/;
            const match = loc.match(pattern);

            if (!match) {
                return {
                    valid: false,
                    message: '‚ùå Formato inv√°lido',
                    details: 'La ubicaci√≥n debe seguir el formato: [LETRA][NUM]-[NUM]-[NUM]-[NUM]\nEjemplo: A21-06-05-01',
                    parsed: null
                };
            }

            const [, area, pasillo, rack, nivel, palet] = match;

            return {
                valid: true,
                message: '‚úÖ Ubicaci√≥n v√°lida',
                parsed: {
                    area: area,
                    pasillo: pasillo.padStart(2, '0'),
                    rack: rack.padStart(2, '0'),
                    nivel: nivel.padStart(2, '0'),
                    palet: palet.padStart(2, '0'),
                    formatted: `${area}${pasillo.padStart(2, '0')}-${rack.padStart(2, '0')}-${nivel.padStart(2, '0')}-${palet.padStart(2, '0')}`
                }
            };
        }

        function confirmInvalidLocation(location) {
            const validation = validateLocation(location);

            if (validation.valid) {
                return { confirmed: true, formatted: validation.parsed.formatted };
            }

            const firstConfirm = confirm(
                `‚ö†Ô∏è UBICACI√ìN CON FORMATO INCORRECTO ‚ö†Ô∏è\n\n` +
                `Ubicaci√≥n ingresada: "${location}"\n\n` +
                `${validation.message}\n` +
                `${validation.details}\n\n` +
                `Formato correcto:\n` +
                `‚Ä¢ √Årea (letra): A, B, C, etc.\n` +
                `‚Ä¢ Pasillo (n√∫meros): 01-99\n` +
                `‚Ä¢ Rack (n√∫meros): 01-99\n` +
                `‚Ä¢ Nivel (n√∫meros): 01-99\n` +
                `‚Ä¢ Palet (n√∫meros): 01-99\n\n` +
                `Ejemplos v√°lidos:\n` +
                `‚Ä¢ A21-06-05-01\n` +
                `‚Ä¢ B27-01-04-01\n` +
                `‚Ä¢ C15-03-02-05\n\n` +
                `¬øEst√°s seguro que deseas usar "${location}"?`
            );

            if (!firstConfirm) {
                return { confirmed: false, formatted: null };
            }

            const secondConfirm = confirm(
                `‚ö†Ô∏è SEGUNDA CONFIRMACI√ìN REQUERIDA ‚ö†Ô∏è\n\n` +
                `Confirma nuevamente que deseas registrar esta ubicaci√≥n:\n\n` +
                `"${location}"\n\n` +
                `Esta ubicaci√≥n NO cumple con el formato est√°ndar del almac√©n.\n\n` +
                `¬øCONFIRMAS el uso de esta ubicaci√≥n?`
            );

            return { confirmed: secondConfirm, formatted: secondConfirm ? location.toUpperCase() : null };
        }

        function generatePalletId(prefix = 'PD') {
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}-${timestamp}-${random}`;
        }

        function newSession() {
            const total = STATE.pallets.ok.boxes.length +
                          STATE.pallets.blocked.boxes.length +
                          STATE.pallets.nowms.boxes.length;

            if (total > 0) {
                if (!confirm(`Hay ${total} cajas en las tarimas. ¬øIniciar nueva sesi√≥n sin enviar?`)) {
                    return;
                }
            }

            STATE.pallets = {
                ok: { id: generatePalletId('OK'), boxes: [], location: '' },
                blocked: { id: generatePalletId('BLK'), boxes: [], location: '' },
                nowms: { id: generatePalletId('NW'), boxes: [], location: '' }
            };
            STATE.pendingCode1 = null;

            // Clear all tab result boxes
            document.querySelectorAll('.result-box').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.code2-container').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.column-location-input').forEach(el => el.value = '');

            saveToStorage();
            updateUI();
            showNotification('‚úÖ Nueva sesi√≥n iniciada', 'success');
        }

        // ==================== RESUMEN MODULE ====================
        function showResumen() {
            updateResumen();
            document.getElementById('resumen-popup').classList.add('show');
        }

        function closeResumen() {
            document.getElementById('resumen-popup').classList.remove('show');
        }

        function updateResumen() {
            document.getElementById('resumen-ok').textContent = STATE.pallets.ok.boxes.length;
            document.getElementById('resumen-blocked').textContent = STATE.pallets.blocked.boxes.length;
            document.getElementById('resumen-nowms').textContent = STATE.pallets.nowms.boxes.length;
            document.getElementById('resumen-pending').textContent = PENDING_SYNC.length + PENDING_SYNC_QUICK.length;

            const tbody = document.getElementById('resumen-table-body');
            const recentHistory = STATE.history.slice(0, 50);

            if (recentHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">Sin registros recientes</td></tr>';
            } else {
                tbody.innerHTML = recentHistory.map(r => `
                    <tr>
                        <td>${r.time}</td>
                        <td><code>${r.scan1}</code></td>
                        <td><code>${r.scan2 || '-'}</code></td>
                        <td><span style="color: ${r.status === 'OK' ? 'var(--success)' : r.status === 'BLOQUEADO' ? 'var(--blocked)' : 'var(--error)'}">${r.status}</span></td>
                        <td>${r.location}</td>
                        <td style="font-size: 0.8em;">${r.pallet}</td>
                    </tr>
                `).join('');
            }
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            updateCounts();
            updateSidebar();
        }

        function updateCounts() {
            // Update all tabs
            TabManager.tabs.forEach(tab => {
                if (tab.type === 'normal') {
                    TabManager.updateTabUI(tab.id);
                }
            });
        }

        function updateSidebar() {
            document.getElementById('sidebar-ok-count').textContent = STATE.pallets.ok.boxes.length;
            document.getElementById('sidebar-blocked-count').textContent = STATE.pallets.blocked.boxes.length;
            document.getElementById('sidebar-nowms-count').textContent = STATE.pallets.nowms.boxes.length;

            document.getElementById('sidebar-ok-pallet').textContent = STATE.pallets.ok.id;
            document.getElementById('sidebar-blocked-pallet').textContent = STATE.pallets.blocked.id;
            document.getElementById('sidebar-nowms-pallet').textContent = STATE.pallets.nowms.id;
        }

        // ==================== CONNECTION ====================
        function setupConnectionMonitor() {
            window.addEventListener('online', () => {
                IS_ONLINE = true;
                showConnectionBanner('online');
                updateConnectionIndicator();
                showNotification('‚úÖ Conexi√≥n restaurada', 'success');
                setTimeout(() => {
                    SyncManager.sync();
                    SyncManager.syncQuick();
                }, 1000);
            });

            window.addEventListener('offline', () => {
                IS_ONLINE = false;
                showConnectionBanner('offline');
                updateConnectionIndicator();
                showNotification('‚ö†Ô∏è Sin conexi√≥n - Modo offline', 'warning');
            });

            updateConnectionIndicator();
        }

        function showConnectionBanner(status) {
            const banner = document.getElementById('connection-banner');
            banner.className = `connection-banner ${status}`;
            banner.textContent = status === 'online' ? '‚úÖ Conexi√≥n restaurada' :
                                 status === 'offline' ? '‚ö†Ô∏è Sin conexi√≥n a internet' :
                                 'üîÑ Sincronizando...';
            if (status === 'online') {
                setTimeout(() => banner.style.display = 'none', 3000);
            }
        }

        function updateConnectionIndicator(syncing = false) {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');

            if (!dot || !text) return;

            if (syncing) {
                dot.className = 'connection-dot syncing';
                text.textContent = 'Sincronizando...';
            } else if (IS_ONLINE) {
                dot.className = 'connection-dot online';
                text.textContent = 'En l√≠nea';
            } else {
                dot.className = 'connection-dot offline';
                text.textContent = 'Sin conexi√≥n';
            }
        }

        function toggleConnection() {
            if (gapi?.client?.getToken()) {
                if (confirm('¬øDesconectar de Google?')) {
                    google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                    gapi.client.setToken(null);
                    showNotification('Desconectado de Google', 'info');
                    updateConnectionIndicator();
                }
            } else {
                handleLogin();
            }
        }

        // ==================== STORAGE ====================
        async function loadFromStorage() {
            try {
                const saved = localStorage.getItem('pd_system_state');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.inventory) STATE.inventory = new Map(data.inventory);
                    STATE.inventoryLastUpdate = data.inventoryLastUpdate;
                    if (data.pallets) STATE.pallets = data.pallets;
                    STATE.history = data.history || [];
                    STATE.quickHistory = data.quickHistory || [];
                }
                updateBdInfo();
            } catch (e) {
                console.error('Error loading from storage:', e);
            }
        }

        async function saveToStorage() {
            try {
                const data = {
                    inventory: Array.from(STATE.inventory.entries()),
                    inventoryLastUpdate: STATE.inventoryLastUpdate,
                    pallets: STATE.pallets,
                    history: STATE.history.slice(0, 1000),
                    quickHistory: STATE.quickHistory.slice(0, 100)
                };
                localStorage.setItem('pd_system_state', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving to storage:', e);
            }
        }

        // ==================== EXPORT ====================
        function exportData() {
            if (STATE.history.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }

            const headers = ['FECHA', 'HORA', 'RESPONSABLE', 'SCAN 1', 'SCAN 2', 'UBICACION', 'ESTATUS', 'NOTA', 'PALLET'];
            const rows = STATE.history.map(r => [
                r.date, r.time, r.user, r.scan1, r.scan2, r.location, r.status, r.note, r.pallet
            ]);

            const csv = '\ufeff' + [
                headers.join(','),
                ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `inventario_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();

            showNotification('‚úÖ Datos exportados', 'success');
        }

        // ==================== NOTIFICATIONS ====================
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span style="margin-right: 8px;">${icons[type]}</span>${message}`;

            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function playSound(type) {
            if (!audioCtx) return;

            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);

                if (type === 'success') {
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.15);
                } else if (type === 'error') {
                    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.35);
                } else if (type === 'warning') {
                    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.1);
                }
            } catch (e) {}
        },

        // ==================== TAB MANAGER METHODS ====================
        processCode1(tabId, rawCode) {
            const code = normalizeCode(rawCode);
            const item = STATE.inventory.get(code);

            if (!item) {
                // Show code2 input
                document.getElementById(`code2-container-${tabId}`).classList.add('show');
                document.getElementById(`code2-input-${tabId}`).focus();
                STATE.pendingCode1 = { tabId, code, raw: rawCode };
                return;
            }

            if (item.isBlocked) {
                this.addBox('blocked', createBoxData(rawCode, code, '', item));
                this.showResultBox(tabId, 'blocked', code, 'BLOQUEADO', 'Inventario bloqueado', item);
                playSound('warning');
            } else if (item.isAvailable) {
                this.addBox('ok', createBoxData(rawCode, code, '', item));
                this.showResultBox(tabId, 'success', code, 'OK', 'Validado correctamente', item);
                playSound('success');
            } else {
                this.addBox('blocked', createBoxData(rawCode, code, '', item));
                this.showResultBox(tabId, 'blocked', code, 'SIN STOCK', 'Sin stock disponible', item);
                playSound('warning');
            }

            this.flashInput(tabId, 'success');
            this.updateTabUI(tabId);
        },

        processCode2(tabId, rawCode2) {
            if (!STATE.pendingCode1 || STATE.pendingCode1.tabId !== tabId) return;

            const code2 = normalizeCode(rawCode2);
            const item = STATE.inventory.get(code2);

            document.getElementById(`code2-container-${tabId}`).classList.remove('show');

            if (!item) {
                this.addBox('nowms', createBoxData(STATE.pendingCode1.raw, STATE.pendingCode1.code, rawCode2, null));
                this.showResultBox(tabId, 'error', STATE.pendingCode1.code, 'NO WMS',
                    `Ambos c√≥digos no encontrados. Guardados: ${STATE.pendingCode1.code} y ${code2}`, null);
                playSound('error');
            } else if (item.isBlocked) {
                this.addBox('blocked', createBoxData(STATE.pendingCode1.raw, code2, rawCode2, item));
                this.showResultBox(tabId, 'blocked', code2, 'BLOQUEADO (C√≥digo 2)',
                    'Validado con C√≥digo 2 - Bloqueado', item);
                playSound('warning');
            } else {
                this.addBox('ok', createBoxData(STATE.pendingCode1.raw, code2, rawCode2, item));
                this.showResultBox(tabId, 'success', code2, 'OK (C√≥digo 2)',
                    'Validado correctamente con C√≥digo 2', item);
                playSound('success');
            }

            STATE.pendingCode1 = null;
            this.updateTabUI(tabId);
        }
    };

    // Close the script tag and body/html tags
    </script>
</body>
</html>
