<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Validaci√≥n WMS</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>">
    <link rel="stylesheet" href="../../shared/css/variables.css?v=2.3">
    <link rel="stylesheet" href="../../shared/css/base.css?v=2.3">
    <link rel="stylesheet" href="../../shared/css/layout.css?v=2.3">
    <link rel="stylesheet" href="../../shared/css/components.css?v=2.3">
    <link rel="stylesheet" href="../../shared/css/sidebar.css?v=2.3">
    <link rel="stylesheet" href="../../shared/css/avatar-system.css?v=2.3">
    <link rel="stylesheet" href="../../shared/css/validador.css?v=2.3">
    <link rel="stylesheet" href="../../shared/css/location-validator.css?v=1.0">
</head>
<body>
    <div class="connection-banner" id="connection-banner"></div>
    <div class="notification-container" id="notifications"></div>

    <div class="preloader-overlay" id="loading-overlay">
        <div class="preloader-content">
            <div class="preloader-spinner"></div>
            <div class="preloader-text" style="color: #333;">üéØ Cargando Validador...</div>
            <div class="preloader-subtext" style="color: #666;">Descargando base de datos desde Google Sheets</div>
        </div>
    </div>

    <div class="popup-overlay-dark" id="user-stats-overlay" onclick="closeUserStats()"></div>

    <!-- User Stats Popup -->
    <div class="user-stats-popup" id="user-stats-popup">
        <button class="popup-close-x" onclick="closeUserStats()">√ó</button>
        <h2 style="margin-bottom: 20px; color: var(--primary);">üìä Validaciones por Usuario</h2>
        <div id="user-stats-content"></div>
    </div>

    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">üéØ</div>
            <h1 class="login-title">Sistema de Validaci√≥n WMS</h1>
            <p class="login-subtitle">Validaci√≥n de c√≥digos en tiempo real</p>
            <button class="btn btn-google" onclick="handleLogin()" style="padding: 15px; font-size: 1.1em; width: 100%;">
                üîê Iniciar sesi√≥n con Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">

    <!-- VALIDATION SCREEN -->
    <div id="validation" style="display: block;">
        <div class="container">
            <!-- Sidebar renderizado completamente por SidebarComponent -->
            <div class="sidebar" id="sidebar"></div>

            <div class="main-content">
                <div class="header">
                    <h1>üîç Validaci√≥n de Cajas</h1>
                    <button class="btn btn-secondary btn-small" onclick="exportData()">üì• CSV</button>
                </div>

                <div id="content-area">
                    <div id="empty-state" class="empty-state module-visible">
                        <div class="empty-state-content">
                            <div class="empty-state-icon">üéØ</div>
                            <h2 class="empty-state-title">Sistema de Validaci√≥n</h2>
                            <p class="empty-state-subtitle">Comienza agregando una nueva orden para validar</p>
                            <button class="btn btn-success btn-start" onclick="addOBC()">
                                üöÄ Iniciar Validaci√≥n
                            </button>
                        </div>
                    </div>

                    <div id="validation-content" style="display: none;">
                        <div class="tab-bar" id="tab-bar"></div>

                        <div class="progress-card">
                            <div class="progress-header">
                                <div class="progress-obc-name" id="prog-obc">-</div>
                                <div class="progress-percentage" id="prog-pct">0%</div>
                            </div>
                            <div class="progress-counts">
                                <div class="progress-count-item">
                                    <div class="progress-count-number" id="prog-scan">0</div>
                                    <div class="progress-count-label">Escaneadas</div>
                                </div>
                                <div class="progress-count-item">
                                    <div class="progress-count-number" id="prog-total">0</div>
                                    <div class="progress-count-label">Total</div>
                                </div>
                                <div class="progress-count-item">
                                    <div class="progress-count-number" id="prog-rest">0</div>
                                    <div class="progress-count-label">Faltantes</div>
                                </div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="prog-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="inline-inputs">
                                <div class="input-group">
                                    <label>üì¶ Orden:</label>
                                    <input type="text" id="obc-display" disabled>
                                </div>
                                <div class="input-group">
                                    <label>üè¢ Destino:</label>
                                    <input type="text" id="recipient-display" disabled>
                                </div>
                                <div class="input-group">
                                    <label>üïê Horario:</label>
                                    <input type="text" id="time-display" disabled>
                                </div>
                                <div class="input-group">
                                    <label>üìç Ubicaci√≥n:</label>
                                    <input type="text" id="location-input" placeholder="Ej: A30-01-01-01" onchange="updateState()">
                                </div>
                            </div>
                            <div class="scanner-section">
                                <div class="scanner-wrapper">
                                    <div class="input-group">
                                        <label style="font-size: 1.1em; color: var(--primary);">üì∑ ESCANEAR C√ìDIGO:</label>
                                        <input type="text" id="scanner" class="scanner-input" placeholder="Escanea aqu√≠..." autofocus>
                                    </div>
                                </div>
                                <button class="btn-manual" onclick="openManualInput()">‚úèÔ∏è Manual</button>
                                <button class="btn-reconteo" onclick="openReconteo()">üîÑ Reconteo</button>
                            </div>
                        </div>

                        <div class="logs-container">
                            <div class="card">
                                <div class="log-header-with-badge">
                                    <h3>‚úÖ Validaciones OK</h3>
                                    <span class="log-count-badge ok" id="stat-ok">0</span>
                                </div>
                                <ul id="log-ok" class="log-list"></ul>
                            </div>
                            <div class="card">
                                <div class="log-header-with-badge">
                                    <h3>‚ùå Rechazos</h3>
                                    <span class="log-count-badge error" id="stat-error">0</span>
                                </div>
                                <ul id="log-reject" class="log-list"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESUMEN MODULE -->
    <div id="resumen-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üìã Resumen de √ìrdenes</h1>
                    <button class="btn btn-secondary btn-small" onclick="hideResumen()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <input type="text" id="search-resumen" class="search-bar" placeholder="üîç Buscar orden..." oninput="filterResumen()">
                    <div style="overflow-x: auto;">
                        <table class="resumen-table">
                            <thead>
                                <tr>
                                    <th>Orden</th>
                                    <th>Total</th>
                                    <th>Validadas</th>
                                    <th>Progreso</th>
                                    <th>Destino</th>
                                    <th>Horario</th>
                                </tr>
                            </thead>
                            <tbody id="resumen-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FALTANTES MODULE -->
    <div id="faltantes-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üîç C√≥digos Faltantes</h1>
                    <button class="btn btn-secondary btn-small" onclick="hideFaltantes()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <div class="faltantes-controls">
                        <select id="faltantes-order-select" onchange="renderFaltantes()">
                            <option value="">Seleccionar orden...</option>
                        </select>
                        <input type="text" id="search-faltantes" class="search-bar" placeholder="üîç Buscar c√≥digo..." oninput="filterFaltantes()">
                    </div>
                    <p style="margin-bottom: 15px;"><span style="color: var(--success);">‚úÖ Validados</span> | <span style="color: var(--error);">‚ùå Faltantes</span></p>
                    <div class="faltantes-grid" id="faltantes-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONSULTA RAPIDA MODULE -->
    <div id="consulta-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üîé Consulta R√°pida de Trazabilidad</h1>
                    <button class="btn btn-secondary btn-small" onclick="hideConsulta()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <div class="input-group">
                        <label style="font-size: 1.1em; color: var(--primary);">üì¶ Escanear c√≥digo de caja:</label>
                        <input type="text" id="consulta-scanner" class="scanner-input" placeholder="Escanea o ingresa el c√≥digo..." onkeydown="handleConsultaScan(event)">
                    </div>
                    <button class="btn btn-primary" onclick="executeConsulta()" style="margin-top: 15px;">üîç Consultar</button>
                </div>
                <div id="consulta-result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- RECONTEO MODULE -->
    <div id="reconteo-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üîÑ Reconteo de Orden</h1>
                    <button class="btn btn-secondary btn-small" onclick="hideReconteo()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <div class="faltantes-controls">
                        <select id="reconteo-order-select" onchange="initReconteo()">
                            <option value="">Seleccionar orden...</option>
                        </select>
                        <button class="btn btn-primary btn-small" onclick="clearReconteo()">üóëÔ∏è Limpiar Reconteo</button>
                    </div>
                </div>
                <div id="reconteo-content" style="display: none;">
                    <div class="card">
                        <div class="input-group">
                            <label style="font-size: 1.1em; color: #9c27b0;">üì¶ Escanear para reconteo:</label>
                            <input type="text" id="reconteo-scanner" class="scanner-input" placeholder="Escanea aqu√≠..." onkeydown="handleReconteoScan(event)" style="background: #f3e5f5 !important;">
                        </div>
                    </div>
                    <div class="reconteo-stats" id="reconteo-stats">
                        <div class="reconteo-stat ok">
                            <div class="reconteo-stat-number" id="reconteo-ok">0</div>
                            <div class="reconteo-stat-label">OK</div>
                        </div>
                        <div class="reconteo-stat dup">
                            <div class="reconteo-stat-number" id="reconteo-dup">0</div>
                            <div class="reconteo-stat-label">Duplicados</div>
                        </div>
                        <div class="reconteo-stat missing">
                            <div class="reconteo-stat-number" id="reconteo-missing">0</div>
                            <div class="reconteo-stat-label">Faltantes BD</div>
                        </div>
                        <div class="reconteo-stat extra">
                            <div class="reconteo-stat-number" id="reconteo-extra">0</div>
                            <div class="reconteo-stat-label">No en Orden</div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">üìã Registro de Escaneos</h3>
                        <div class="reconteo-table-container">
                            <table class="reconteo-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>C√≥digo</th>
                                        <th>Estatus</th>
                                        <th>Hora</th>
                                        <th>Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="reconteo-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 15px;">
                        <h3 style="margin-bottom: 15px; color: var(--error);">‚ùå C√≥digos NO escaneados en Reconteo</h3>
                        <p style="margin-bottom: 10px; color: #666;">C√≥digos validados previamente que no han sido escaneados en este reconteo:</p>
                        <div class="faltantes-grid" id="reconteo-not-scanned"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- POPUPS -->
    <div id="popup-error" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('error')">√ó</button>
            <div class="popup-header" style="color: var(--error);">‚ùå C√ìDIGO RECHAZADO</div>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="err-code"></span><br>
                <strong>Motivo:</strong> <span id="err-reason" style="color: var(--error);"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="closePopup('error')">Continuar</button>
            </div>
        </div>
    </div>

    <div id="popup-history" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('history')">√ó</button>
            <div class="popup-header" style="color: var(--warning);">‚ö†Ô∏è C√ìDIGO YA VALIDADO EN HISTORIAL</div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="hist-code"></span><br>
                <strong>Orden Original:</strong> <span id="hist-obc"></span><br>
                <strong>Validado:</strong> <span id="hist-when"></span><br>
                <strong>Usuario:</strong> <span id="hist-user"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('history')">Cancelar</button>
                <button class="btn btn-primary" onclick="forceHistoryValidation()">Forzar Validaci√≥n con Nota</button>
            </div>
        </div>
    </div>

    <div id="popup-dup" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('dup')">√ó</button>
            <div class="popup-header" style="color: var(--warning);">‚ö†Ô∏è DUPLICADO</div>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="dup-code"></span><br>
                <strong>Validado:</strong> <span id="dup-when"></span><br>
                <strong>Usuario:</strong> <span id="dup-user"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('dup')">Ignorar</button>
                <button class="btn btn-primary" onclick="forceDuplicate()">Forzar con Nota</button>
            </div>
        </div>
    </div>

    <div id="popup-completed" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="continueViewing()">√ó</button>
            <div class="popup-header" style="color: var(--success);">‚úÖ ORDEN COMPLETADA</div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin: 15px 0; text-align: center;">
                <div style="font-size: 1.8em; font-weight: 700; color: var(--success); margin-bottom: 10px;">üéâ</div>
                <strong>Orden:</strong> <span id="completed-obc"></span><br>
                <strong>Cajas validadas:</strong> <span id="completed-count"></span><br>
                <strong>Usuario:</strong> <span id="completed-user"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-success" onclick="continueToNewOrder()" style="background: var(--warning);">Guardar y Abrir Nueva</button>
                <button class="btn btn-primary" onclick="saveAndContinue()">Guardar y Cerrar</button>
                <button class="btn btn-secondary" onclick="saveAndClose()">Cerrar Validaci√≥n</button>
            </div>
        </div>
    </div>

    <div id="popup-manual" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('manual')">√ó</button>
            <div class="popup-header" style="color: var(--warning);">‚úèÔ∏è INGRESO MANUAL DE C√ìDIGO</div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <p style="margin-bottom: 15px; color: #e65100;"><strong>‚ö†Ô∏è Advertencia:</strong> Solo usar para casos excepcionales</p>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>C√≥digo:</label>
                    <input type="text" id="manual-code" placeholder="Ingresa el c√≥digo">
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Motivo:</label>
                    <select id="manual-reason" onchange="toggleManualOtherNote()">
                        <option value="">Seleccionar motivo...</option>
                        <option value="Codigo Borroso">C√≥digo Borroso</option>
                        <option value="Etiqueta Da√±ada">Etiqueta Da√±ada</option>
                        <option value="Error Surtido">Error Surtido</option>
                        <option value="Mercancia Reetiquetada">Mercanc√≠a Reetiquetada</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="input-group" id="manual-other-container" style="display: none;">
                    <label>Especificar motivo (obligatorio):</label>
                    <textarea id="manual-other-note" rows="3" placeholder="Describe el motivo..."></textarea>
                </div>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('manual')">Cancelar</button>
                <button class="btn btn-primary" onclick="submitManualCode()">Validar C√≥digo</button>
            </div>
        </div>
    </div>

    <div id="popup-reload-order" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--primary);">üì¶ ORDEN PARCIALMENTE VALIDADA</div>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>Orden:</strong> <span id="reload-obc"></span><br>
                <strong>Ya validadas:</strong> <span id="reload-validated"></span><br>
                <strong>Total:</strong> <span id="reload-total"></span><br>
                <strong>Pendientes:</strong> <span id="reload-pending"></span>
            </div>
            <p style="margin: 15px 0; color: #666;">Esta orden ya tiene validaciones previas. ¬øDeseas continuar donde se dej√≥?</p>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="cancelReloadOrder()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmReloadOrder()">Continuar Validaci√≥n</button>
            </div>
        </div>
    </div>

    <div id="popup-already-complete" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--success);">‚úÖ ORDEN YA COMPLETADA</div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin: 15px 0; text-align: center;">
                <div style="font-size: 1.8em; margin-bottom: 10px;">üéâ</div>
                <strong>Orden:</strong> <span id="complete-obc"></span><br>
                <strong>Validadas:</strong> <span id="complete-count"></span><br>
                <p style="margin-top: 10px; color: #666;">Esta orden ya fue validada al 100%</p>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="closePopup('already-complete')">Entendido</button>
            </div>
        </div>
    </div>

    <!-- PRERECEPCION POPUP -->
    <div id="popup-prerec" class="popup-overlay">
        <div class="popup-content" style="max-width: 600px;">
            <button class="popup-close-x" onclick="closePrerecepcion()">√ó</button>
            <div class="popup-header" style="color: var(--primary);">üìã Prerecepci√≥n de Orden</div>
            <div class="card" style="margin: 15px 0;">
                <div class="input-group">
                    <label style="font-size: 1.1em; color: var(--primary);">üì¶ Escanear OBC:</label>
                    <input type="text" id="prerec-scanner" class="scanner-input" placeholder="Escanea aqu√≠..." onkeydown="handlePrerecScan(event)">
                </div>
            </div>
            <div id="prerec-order-info" style="display: none;"></div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePrerecepcion()">Cancelar</button>
                <button class="btn btn-success" id="prerec-confirm-btn" onclick="confirmPrerecepcion()" disabled>‚úÖ Confirmar Prerecepci√≥n</button>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 6px;">
                <strong>Hoy:</strong> <span id="prerec-today-count">0</span> √≥rdenes prerecibidas
            </div>
        </div>
    </div>

    <!-- POPUP UBICACI√ìN INV√ÅLIDA -->
    <div id="popup-invalid-location" class="popup-overlay">
        <div class="popup-content" style="max-width: 500px;">
            <button class="popup-close-x" onclick="closePopup('invalid-location')">√ó</button>
            <div class="popup-header" style="color: var(--warning);">‚ö†Ô∏è UBICACI√ìN INV√ÅLIDA</div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>Ubicaci√≥n ingresada:</strong> <span id="invalid-location-code" style="color: var(--error); font-weight: 700;"></span><br>
                <strong>Error:</strong> <span id="invalid-location-message"></span><br><br>
                <strong>Formato esperado:</strong> A1-01-01-01<br>
                <strong>Ejemplos v√°lidos:</strong> A26-06-01-02, B11-11-02-01
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Justificaci√≥n (opcional):</label>
                <textarea id="invalid-location-justification" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-family: inherit;" placeholder="¬øPor qu√© necesitas forzar esta ubicaci√≥n?"></textarea>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('invalid-location')">‚Üê Corregir</button>
                <button class="btn btn-warning" onclick="forceInvalidLocation()">‚ö†Ô∏è Forzar de Todos Modos</button>
            </div>
        </div>
    </div>

    </div>
    <!-- End MAIN APP -->

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js" onload="console.log('‚úÖ GAPI loaded')" onerror="console.error('‚ùå Error loading GAPI')"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="console.log('‚úÖ GIS loaded')" onerror="console.error('‚ùå Error loading GIS')"></script>

    <!-- Shared Scripts -->
    <script src="../../shared/js/debug-mode.js"></script>
    <script src="../../shared/js/wms-utils.js"></script>
    <script src="../../shared/js/auth-manager.js?v=3.0.1"></script>
    <script src="../../shared/js/sidebar-component.js"></script>
    <script src="../../shared/js/avatar-system.js"></script>
    <script src="../../shared/js/location-validator-ui.js"></script>

    <!-- Advanced Sync System -->
    <script src="../../shared/js/sync-utils.js?v=3.0.3"></script>
    <script src="../../shared/js/distributed-lock-manager.js?v=3.2.0"></script>
    <script src="../../shared/js/integrity-validator.js?v=3.2.0"></script>
    <script src="../../shared/js/persistent-state-manager.js?v=3.2.0"></script>
    <script src="../../shared/js/processed-cache-manager.js?v=3.0.3"></script>
    <script src="../../shared/js/advanced-sync-manager.js?v=3.2.0"></script>

    <!-- Sync Configuration -->
    <script src="sync-config.js?v=3.0.3"></script>

    <!-- App Script -->
    <script src="app.js?v=3.2.2"></script>
</body>
</html>
