<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö Sistema de Despacho Log√≠stico</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --info: #00BCD4;
            --bg: #f7f7f7;
            --text: #333;
            --card: #ffffff;
            --border: #e2e8f0;
            --gray: #6c757d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        /* MAIN LAYOUT */
        .main-container {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #555;
        }

        .sidebar-header h2 {
            color: var(--primary);
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.8em;
            color: #aaa;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }

        .sidebar-section-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .sidebar-btn:hover {
            transform: translateX(3px);
        }

        .sidebar-btn-primary {
            background: var(--primary);
            color: white;
        }

        .sidebar-btn-secondary {
            background: #555;
            color: white;
        }

        .sidebar-btn-success {
            background: var(--success);
            color: white;
        }

        /* Sync Status */
        .sync-status {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            cursor: pointer;
        }
        .sync-ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .sync-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }
        .sync-warning {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* User Footer */
        .user-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            color: white;
            cursor: pointer;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .connection-indicator {
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }

        .user-footer-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .user-footer-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.75em;
        }

        .bd-info {
            font-size: 0.7em;
            color: #aaa;
            text-align: center;
            line-height: 1.4;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.4em;
        }

        /* Resumen Cajas del D√≠a */
        .day-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .day-summary-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .day-summary-card.total { border-color: var(--primary); }
        .day-summary-card.validated { border-color: var(--success); }
        .day-summary-card.pending { border-color: var(--warning); }
        .day-summary-card.problems { border-color: var(--error); }

        .day-summary-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .day-summary-value {
            font-size: 2em;
            font-weight: 700;
        }

        /* Scan Section */
        .scan-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scan-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .scan-input-group {
            flex: 1;
        }

        .scan-input-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .scan-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.3em;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
        }

        .scan-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Result Cards (like track.html) */
        .result-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .result-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 3px solid;
        }

        .result-card-label {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 4px;
        }

        .result-card-value {
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Panels */
        .panels-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            min-height: 0;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .panel-title {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .panel-count {
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
        }

        .panel-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .panel-filter-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .panel-filter-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .panel-list {
            flex: 1;
            overflow-y: auto;
        }

        .panel-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-item.validated { border-color: var(--success); }
        .panel-item.pending { border-color: var(--warning); }

        .panel-item-info {
            flex: 1;
        }

        .panel-item-order {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .panel-item-meta {
            font-size: 0.75em;
            color: #666;
        }

        .panel-item-actions {
            display: flex;
            gap: 6px;
        }

        .btn-expand {
            padding: 6px 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-google { background: #4285F4; color: white; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.show { display: flex; }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            font-size: 1.1em;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .modal-field {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .modal-field-label {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 4px;
        }

        .modal-field-value {
            font-weight: 700;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .modal-input-group input,
        .modal-input-group select,
        .modal-input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 6px;
        }

        .badge.success { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        .badge.warning { background: rgba(255, 152, 0, 0.15); color: var(--warning); }
        .badge.error { background: rgba(244, 67, 54, 0.15); color: var(--error); }
        .badge.info { background: rgba(0, 188, 212, 0.15); color: var(--info); }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .notification {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }

        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 1024px) {
            .panels-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="notification-container" id="notifications"></div>

    <!-- LOGIN -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">üöö</div>
            <h1 class="login-title">Sistema de Despacho</h1>
            <p class="login-subtitle">Validaci√≥n y Control Log√≠stico</p>
            <button class="btn btn-google" style="width: 100%; padding: 15px; font-size: 1.1em;" onclick="handleLogin()">
                üîê Iniciar sesi√≥n con Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <div class="main-container">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>üöö Despacho</h2>
                    <p>Control Log√≠stico</p>
                </div>

                <div id="sync-status" class="sync-status sync-ok" onclick="showSyncPanel()">
                    ‚úÖ Sincronizado
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Acciones</div>
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showManualOrderModal()">
                        ‚ûï Orden Manual
                    </button>
                    <button class="sidebar-btn sidebar-btn-success" onclick="showPrintModal()">
                        üñ®Ô∏è Imprimir Listas
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="exportData()">
                        üì• Exportar
                    </button>
                </div>

                <div class="user-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar" onclick="changeUserAlias()">?</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name-display" onclick="changeUserAlias()">No conectado</div>
                            <div class="connection-indicator">
                                <div class="connection-dot" id="connection-dot"></div>
                                <span id="connection-text">Offline</span>
                            </div>
                        </div>
                    </div>
                    <div class="user-footer-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshData()">üîÑ BD</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleConnection()" id="sidebar-auth-btn">üîó</button>
                        <button class="btn btn-danger btn-small" onclick="handleLogout()">üö™</button>
                    </div>
                    <div class="bd-info">
                        <div><span id="bd-count">0</span> √≥rdenes cargadas</div>
                        <div id="bd-update-time">Sin actualizar</div>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- Header -->
                <div class="header">
                    <h1>üì¶ Validaci√≥n de Despacho</h1>
                </div>

                <!-- Resumen del D√≠a -->
                <div class="day-summary">
                    <div class="day-summary-card total">
                        <div class="day-summary-label">Total √ìrdenes</div>
                        <div class="day-summary-value" id="summary-total">0</div>
                    </div>
                    <div class="day-summary-card validated">
                        <div class="day-summary-label">Validadas</div>
                        <div class="day-summary-value" id="summary-validated">0</div>
                    </div>
                    <div class="day-summary-card pending">
                        <div class="day-summary-label">Pendientes</div>
                        <div class="day-summary-value" id="summary-pending">0</div>
                    </div>
                    <div class="day-summary-card problems">
                        <div class="day-summary-label">Con Problemas</div>
                        <div class="day-summary-value" id="summary-problems">0</div>
                    </div>
                </div>

                <!-- Scan Section -->
                <div class="scan-section">
                    <div class="scan-row">
                        <div class="scan-input-group">
                            <label>üîç Escanear C√≥digo de Caja</label>
                            <input type="text" class="scan-input" id="scan-input" placeholder="Escanea aqu√≠..." autocomplete="off">
                        </div>
                        <button class="btn btn-primary" onclick="processScan()">üîç Buscar</button>
                        <button class="btn btn-secondary" onclick="clearScan()">üóëÔ∏è Limpiar</button>
                    </div>
                </div>

                <!-- Result Cards (Cabeceras Resumen) -->
                <div class="result-cards" id="result-cards" style="display: none;">
                    <!-- Se generan din√°micamente -->
                </div>

                <!-- Panels: Validadas | Pendientes -->
                <div class="panels-container">
                    <!-- Panel Validadas -->
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">
                                ‚úÖ Validadas
                                <span class="panel-count" style="background: rgba(76, 175, 80, 0.15); color: var(--success);" id="validated-count">0</span>
                            </span>
                        </div>
                        <div class="panel-filters">
                            <input type="text" class="panel-filter-input" id="filter-validated" placeholder="üîç Buscar..." oninput="filterPanel('validated')">
                            <select class="panel-filter-select" id="sort-validated" onchange="sortPanel('validated')">
                                <option value="recent">M√°s recientes</option>
                                <option value="order">Por orden</option>
                                <option value="destino">Por destino</option>
                                <option value="horario">Por horario</option>
                            </select>
                        </div>
                        <div class="panel-list" id="validated-list">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                                <div>Sin validaciones</div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Pendientes -->
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">
                                ‚è≥ Pendientes
                                <span class="panel-count" style="background: rgba(255, 152, 0, 0.15); color: var(--warning);" id="pending-count">0</span>
                            </span>
                        </div>
                        <div class="panel-filters">
                            <input type="text" class="panel-filter-input" id="filter-pending" placeholder="üîç Buscar..." oninput="filterPanel('pending')">
                            <select class="panel-filter-select" id="sort-pending" onchange="sortPanel('pending')">
                                <option value="recent">M√°s recientes</option>
                                <option value="order">Por orden</option>
                                <option value="destino">Por destino</option>
                                <option value="horario">Por horario</option>
                            </select>
                        </div>
                        <div class="panel-list" id="pending-list">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                                <div>Sin pendientes</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VALIDATION MODAL -->
    <div class="modal-overlay" id="validation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üì¶ Validaci√≥n de Despacho</span>
                <button class="modal-close" onclick="closeValidationModal()">√ó</button>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Informaci√≥n de la Orden</div>
                <div class="modal-grid">
                    <div class="modal-field">
                        <div class="modal-field-label">Orden (OBC)</div>
                        <div class="modal-field-value" id="modal-order">-</div>
                    </div>
                    <div class="modal-field">
                        <div class="modal-field-label">Destino</div>
                        <div class="modal-field-value" id="modal-destino">-</div>
                    </div>
                    <div class="modal-field">
                        <div class="modal-field-label">Horario</div>
                        <div class="modal-field-value" id="modal-horario">-</div>
                    </div>
                    <div class="modal-field">
                        <div class="modal-field-label">Cantidad Esperada</div>
                        <div class="modal-field-value" id="modal-qty-expected">-</div>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Validaci√≥n de Etiquetado</div>
                <div id="modal-etiquetado-info" style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <!-- Se genera din√°micamente -->
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Cantidad a Despachar</div>
                <div class="modal-input-group">
                    <label>Cantidad que se enviar√° <span style="color: var(--error);">*</span></label>
                    <input type="number" id="modal-qty-dispatch" min="0" placeholder="Ingresa cantidad...">
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Estatus</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="modal-input-group">
                        <label>Estatus de Orden</label>
                        <select id="modal-status-order">
                            <option value="OK">OK - Completa</option>
                            <option value="Env√≠o Parcial">Env√≠o Parcial</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Anormalidad">Anormalidad</option>
                        </select>
                    </div>
                    <div class="modal-input-group">
                        <label>Control de Calidad</label>
                        <select id="modal-status-quality">
                            <option value="Completado">Completado</option>
                            <option value="Pendiente">Pendiente</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Asignaci√≥n de Viaje</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="modal-input-group">
                        <label>Operador/Conductor</label>
                        <select id="modal-operador">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="modal-input-group">
                        <label>Unidad/Veh√≠culo</label>
                        <select id="modal-unidad">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-input-group">
                    <label>Observaciones/Incidencias</label>
                    <textarea id="modal-observaciones" rows="3" placeholder="Notas adicionales..."></textarea>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-success" onclick="confirmValidation()" style="flex: 1;">
                    ‚úÖ Validar y Guardar
                </button>
                <button class="btn btn-secondary" onclick="closeValidationModal()">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            CLIENT_ID: '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile',
            SPREADSHEET_WRITE: '1T_yXd4MFyp-Ks2iTTr0KAd12QhXjW2eUMVqnAx8XSJM',
            SOURCES: {
                BD_STOCK: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-HG8HPf-94Ki5Leo5iEF5pyqsiD9CVk-mcl-F8BAw34kT0s3nzNn532YTYDCtkG76NbauiVx0Ffmd/pub?output=csv',
                OBC_BD: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSdSDQ8ktYA3YAsWMUokYd_S6_rANUz8XdfEAjsV-v0eAlfiYZctHuj3hP4m3wOghf4rnT_YvuA4BPA/pub?output=csv',
                VALIDACION: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZMZZCDtTFCebvsme1GMEBiZ1S2Cloh37AR8hHFAwhFPNEMD27G04bzX0theCMJE-nlYOyH2ev115q/pub?output=csv',
                MNE: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHzXpt4q7KYo8QMnrO92LGcXQbx14lBCQ0wxHGHm2Lz4v5RCJCpQHmS0NhUTHUCCG2Hc1bkvTYhdpz/pub?gid=883314398&single=true&output=csv',
                TRS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2NOvCCzIW0IS9ANzOYl7GKBq5I-XQM9e_V1tu_2VrDMq4Frgjol5uj6-4dBgEQcfB8b-k6ovaOJGc/pub?output=csv',
                LISTAS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTmbzg922y1KMVnV0JqBijR43Ma8e5X_AO2KVzjHBnRtGBx-0aXLZ8UUlKCO_XHOpV1qfggQyNjtqde/pub?gid=799838428&single=true&output=csv'
            }
        };

        // ==================== STATE ====================
        let STATE = {
            obcData: new Map(),
            validacionData: new Map(),
            mneData: new Map(),
            trsData: [],
            operadores: [],
            unidades: [],
            validatedOrders: [],
            pendingOrders: [],
            currentScan: null,
            folioCounter: 1
        };

        let CURRENT_USER = '';
        let USER_EMAIL = '';
        let USER_GOOGLE_NAME = '';
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];
        let TOKEN_CLIENT = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            gapi.load('client', initGAPI);
        });

        function setupEventListeners() {
            const scanInput = document.getElementById('scan-input');
            scanInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && scanInput.value.trim()) {
                    e.preventDefault();
                    processScan();
                }
            });
        }

        async function initGAPI() {
            try {
                await gapi.client.init({
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
                });
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: handleAuthCallback
                });
            } catch (e) {
                showNotification('Error inicializando API', 'error');
            }
        }

        async function handleAuthCallback(response) {
            if (response?.access_token) {
                gapi.client.setToken(response);
                await getUserProfile();
                await loadAllData();
                showApp();
            }
        }

        function handleLogin() {
            TOKEN_CLIENT?.requestAccessToken();
        }

        async function getUserProfile() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` }
                });
                const data = await response.json();
                USER_EMAIL = data.email || '';
                USER_GOOGLE_NAME = data.name || 'Usuario';

                const savedAlias = localStorage.getItem(`desp_alias_${USER_EMAIL}`);
                if (savedAlias) {
                    CURRENT_USER = savedAlias;
                } else {
                    CURRENT_USER = USER_GOOGLE_NAME;
                    localStorage.setItem(`desp_alias_${USER_EMAIL}`, USER_GOOGLE_NAME);
                }
                updateUserFooter();
            } catch (e) {
                CURRENT_USER = 'Usuario';
            }
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateUI();
            document.getElementById('scan-input').focus();
        }

        function handleLogout() {
            if (gapi.client.getToken()) {
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                gapi.client.setToken(null);
            }
            location.reload();
        }

        function changeUserAlias() {
            const newAlias = prompt('Ingresa tu nombre:', CURRENT_USER);
            if (newAlias && newAlias.trim()) {
                CURRENT_USER = newAlias.trim();
                localStorage.setItem(`desp_alias_${USER_EMAIL}`, CURRENT_USER);
                updateUserFooter();
            }
        }

        function updateUserFooter() {
            const avatar = document.getElementById('user-avatar');
            const nameDisplay = document.getElementById('user-name-display');

            if (avatar) {
                avatar.textContent = CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : '?';
            }
            if (nameDisplay) {
                nameDisplay.textContent = CURRENT_USER || 'No conectado';
            }
        }

        function toggleConnection() {
            if (gapi?.client?.getToken()) {
                if (confirm('¬øDesconectar?')) {
                    google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                    gapi.client.setToken(null);
                    location.reload();
                }
            } else {
                handleLogin();
            }
        }

        // ==================== DATA LOADING ====================
        async function loadAllData() {
            showNotification('üîÑ Cargando datos...', 'info');

            try {
                // Load OBC_BD
                const obcResponse = await fetch(CONFIG.SOURCES.OBC_BD);
                const obcCsv = await obcResponse.text();
                parseOBCData(obcCsv);

                // Load LISTAS (Operadores y Unidades)
                const listasResponse = await fetch(CONFIG.SOURCES.LISTAS);
                const listasCsv = await listasResponse.text();
                parseListasData(listasCsv);

                // Load TRS
                const trsResponse = await fetch(CONFIG.SOURCES.TRS);
                const trsCsv = await trsResponse.text();
                parseTRSData(trsCsv);

                showNotification(`‚úÖ ${STATE.obcData.size} √≥rdenes cargadas`, 'success');
                updateBdInfo();
            } catch (e) {
                showNotification('‚ùå Error cargando datos', 'error');
            }
        }

        function parseOBCData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.obcData.clear();

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length >= 6) {
                    const orden = cols[0]?.trim();
                    if (orden) {
                        STATE.obcData.set(orden, {
                            orden,
                            ref1: cols[1]?.trim() || '',
                            ref2: cols[2]?.trim() || '',
                            horario: cols[3]?.trim() || '',
                            destino: cols[4]?.trim() || '',
                            codigo: cols[5]?.trim() || ''
                        });
                    }
                }
            }
        }

        function parseListasData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.operadores = [];
            STATE.unidades = [];

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                // Columna B (√≠ndice 1): Operadores
                // Columna D (√≠ndice 3): Unidades
                const operador = cols[1]?.trim().toUpperCase();
                const unidad = cols[3]?.trim().toUpperCase();

                if (operador && !STATE.operadores.includes(operador)) {
                    STATE.operadores.push(operador);
                }
                if (unidad && !STATE.unidades.includes(unidad)) {
                    STATE.unidades.push(unidad);
                }
            }

            // Populate selects
            populateOperadoresUnidades();
        }

        function populateOperadoresUnidades() {
            const operadorSelect = document.getElementById('modal-operador');
            const unidadSelect = document.getElementById('modal-unidad');

            operadorSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                STATE.operadores.map(op => `<option value="${op}">${op}</option>`).join('');

            unidadSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                STATE.unidades.map(un => `<option value="${un}">${un}</option>`).join('');
        }

        function parseTRSData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.trsData = [];

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length >= 15 && cols[0]?.startsWith('TRS')) {
                    STATE.trsData.push({
                        trs: cols[0]?.trim(),
                        referencia: cols[6]?.trim() || '',
                        codigoOriginal: cols[13]?.trim() || '',
                        codigoNuevo: cols[14]?.trim() || ''
                    });
                }
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function updateBdInfo() {
            document.getElementById('bd-count').textContent = STATE.obcData.size;
            document.getElementById('bd-update-time').textContent = new Date().toLocaleTimeString();
        }

        function refreshData() {
            loadAllData();
        }

        // ==================== SCAN PROCESSING ====================
        function processScan() {
            const input = document.getElementById('scan-input');
            const rawCode = input.value.trim().toUpperCase();

            if (!rawCode) {
                showNotification('‚ö†Ô∏è Ingresa un c√≥digo', 'warning');
                return;
            }

            // Buscar en OBC_BD
            const orderInfo = findOrderByCode(rawCode);
            if (!orderInfo) {
                showNotification('‚ùå C√≥digo no encontrado en OBC_BD', 'error');
                return;
            }

            // Buscar en TRS
            const trsInfo = findTRSByCode(rawCode);

            // Mostrar resultado
            showScanResult(rawCode, orderInfo, trsInfo);
            input.value = '';
        }

        function findOrderByCode(code) {
            for (const [orden, data] of STATE.obcData.entries()) {
                if (data.codigo.toUpperCase().includes(code)) {
                    return data;
                }
            }
            return null;
        }

        function findTRSByCode(code) {
            const normalizedCode = normalizeCode(code);
            for (const trs of STATE.trsData) {
                const normalizedOriginal = normalizeCode(trs.codigoOriginal);
                const normalizedNuevo = normalizeCode(trs.codigoNuevo);
                
                if (normalizedOriginal === normalizedCode || normalizedNuevo === normalizedCode || 
                    trs.referencia.toUpperCase().includes(code)) {
                    return trs;
                }
            }
            return null;
        }

        function normalizeCode(code) {
            return code.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        }

        function showScanResult(code, orderInfo, trsInfo) {
            STATE.currentScan = { code, orderInfo, trsInfo };

            // Mostrar cards resumen
            const cardsContainer = document.getElementById('result-cards');
            cardsContainer.style.display = 'grid';
            cardsContainer.innerHTML = `
                <div class="result-card" style="border-color: var(--primary);">
                    <div class="result-card-label">Orden (OBC)</div>
                    <div class="result-card-value">${orderInfo.orden}</div>
                </div>
                <div class="result-card" style="border-color: var(--info);">
                    <div class="result-card-label">Destino</div>
                    <div class="result-card-value">${orderInfo.destino}</div>
                </div>
                <div class="result-card" style="border-color: var(--warning);">
                    <div class="result-card-label">Horario</div>
                    <div class="result-card-value">${orderInfo.horario}</div>
                </div>
                <div class="result-card" style="border-color: ${trsInfo ? 'var(--warning)' : 'var(--success)'};">
                    <div class="result-card-label">Etiquetado</div>
                    <div class="result-card-value">${trsInfo ? '‚ö†Ô∏è Requiere cambio' : '‚úÖ OK'}</div>
                </div>
            `;

            // Abrir modal de validaci√≥n
            openValidationModal();
        }

        function clearScan() {
            document.getElementById('scan-input').value = '';
            document.getElementById('result-cards').style.display = 'none';
            STATE.currentScan = null;
            document.getElementById('scan-input').focus();
        }

        // ==================== VALIDATION MODAL ====================
        function openValidationModal() {
            if (!STATE.currentScan) return;

            const { code, orderInfo, trsInfo } = STATE.currentScan;

            // Llenar informaci√≥n
            document.getElementById('modal-order').textContent = orderInfo.orden;
            document.getElementById('modal-destino').textContent = orderInfo.destino;
            document.getElementById('modal-horario').textContent = orderInfo.horario;
            
            // Cantidad esperada (simulada, deber√≠a venir de OBC_BD)
            const expectedQty = 10; // TODO: obtener de BD
            document.getElementById('modal-qty-expected').textContent = expectedQty;
            document.getElementById('modal-qty-dispatch').value = expectedQty;

            // Informaci√≥n de etiquetado
            const etiquetadoDiv = document.getElementById('modal-etiquetado-info');
            if (trsInfo) {
                etiquetadoDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>‚ö†Ô∏è Cambio de Etiqueta Detectado</strong>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="font-size: 0.8em; color: #666;">C√≥digo Original</div>
                            <div style="font-weight: 700;">${trsInfo.codigoOriginal}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8em; color: #666;">C√≥digo Nuevo</div>
                            <div style="font-weight: 700; color: var(--warning);">${trsInfo.codigoNuevo}</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <div style="font-size: 0.8em; color: #666;">Orden TRS</div>
                        <div style="font-weight: 700;">${trsInfo.trs}</div>
                    </div>
                `;
            } else if (orderInfo.ref1 || orderInfo.ref2) {
                etiquetadoDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>üìã Referencias OBC</strong>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="font-size: 0.8em; color: #666;">Referencia 1</div>
                            <div style="font-weight: 700;">${orderInfo.ref1 || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8em; color: #666;">Referencia 2</div>
                            <div style="font-weight: 700;">${orderInfo.ref2 || '-'}</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 6px;">
                        ‚úÖ Sin cambio de etiqueta detectado
                    </div>
                `;
            } else {
                etiquetadoDiv.innerHTML = `
                    <div style="padding: 15px; background: #fff3e0; border-radius: 6px; border-left: 3px solid var(--warning);">
                        ‚ö†Ô∏è No se encontr√≥ informaci√≥n de etiquetado. Por favor verifica manualmente.
                    </div>
                `;
            }

            document.getElementById('validation-modal').classList.add('show');
        }

        function closeValidationModal() {
            document.getElementById('validation-modal').classList.remove('show');
        }

        async function confirmValidation() {
            if (!STATE.currentScan) return;

            const { code, orderInfo, trsInfo } = STATE.currentScan;

            // Validar campos obligatorios
            const qtyDispatch = parseInt(document.getElementById('modal-qty-dispatch').value);
            const qtyExpected = parseInt(document.getElementById('modal-qty-expected').textContent);
            const statusOrder = document.getElementById('modal-status-order').value;
            const statusQuality = document.getElementById('modal-status-quality').value;
            const operador = document.getElementById('modal-operador').value;
            const unidad = document.getElementById('modal-unidad').value;
            const observaciones = document.getElementById('modal-observaciones').value;

            if (!qtyDispatch || qtyDispatch <= 0) {
                showNotification('‚ö†Ô∏è Ingresa cantidad a despachar', 'warning');
                return;
            }

            // Validar env√≠o parcial
            if (qtyDispatch < qtyExpected) {
                if (!confirm(`‚ö†Ô∏è ENV√çO PARCIAL\n\nEsperado: ${qtyExpected}\nA despachar: ${qtyDispatch}\n\n¬øConfirmar env√≠o parcial?`)) {
                    return;
                }
            }

            // Generar folio
            const folio = generateFolio();

            // Crear registro
            const now = new Date();
            const record = {
                folio,
                fecha: now.toISOString().slice(0, 10),
                hora: now.toTimeString().slice(0, 8),
                usuario: CURRENT_USER,
                orden: orderInfo.orden,
                destino: orderInfo.destino,
                horario: orderInfo.horario,
                codigo: code,
                codigo2: trsInfo?.codigoNuevo || '',
                estatus: statusOrder,
                cambioEtiqueta: trsInfo ? 'S√ç' : 'NO',
                estatus2: statusQuality,
                incidencias: qtyDispatch < qtyExpected ? 'Env√≠o Parcial' : '',
                operador: operador || '',
                unidad: unidad || '',
                observaciones
            };

            // Agregar a validadas o pendientes
            if (statusOrder === 'OK' && statusQuality === 'Completado') {
                STATE.validatedOrders.push(record);
            } else {
                STATE.pendingOrders.push(record);
            }

            // Agregar a pending sync
            PENDING_SYNC.push(record);
            savePendingSync();

            // Intentar sincronizar
            if (IS_ONLINE && gapi?.client?.getToken()) {
                await syncData();
            }

            showNotification('‚úÖ Validaci√≥n registrada', 'success');
            closeValidationModal();
            clearScan();
            updateUI();
        }

        function generateFolio() {
            const today = new Date();
            const dateStr = today.toISOString().slice(2, 10).replace(/-/g, '');
            const counter = STATE.folioCounter.toString().padStart(3, '0');
            STATE.folioCounter++;
            return `FE${dateStr}-${counter}`;
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            updateDaySummary();
            updatePanels();
        }

        function updateDaySummary() {
            const total = STATE.validatedOrders.length + STATE.pendingOrders.length;
            const validated = STATE.validatedOrders.length;
            const pending = STATE.pendingOrders.length;
            const problems = STATE.pendingOrders.filter(o => o.estatus === 'Anormalidad').length;

            document.getElementById('summary-total').textContent = total;
            document.getElementById('summary-validated').textContent = validated;
            document.getElementById('summary-pending').textContent = pending;
            document.getElementById('summary-problems').textContent = problems;
        }

        function updatePanels() {
            updatePanel('validated', STATE.validatedOrders);
            updatePanel('pending', STATE.pendingOrders);
        }

        function updatePanel(type, orders) {
            const listEl = document.getElementById(`${type}-list`);
            const countEl = document.getElementById(`${type}-count`);

            countEl.textContent = orders.length;

            if (orders.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                        <div>Sin ${type === 'validated' ? 'validaciones' : 'pendientes'}</div>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = orders.map(order => `
                <div class="panel-item ${type === 'validated' ? 'validated' : 'pending'}" data-order="${order.orden}">
                    <div class="panel-item-info">
                        <div class="panel-item-order">
                            ${order.orden}
                            ${order.cambioEtiqueta === 'S√ç' ? '<span class="badge warning">Etiqueta</span>' : ''}
                        </div>
                        <div class="panel-item-meta">
                            ${order.destino} ‚Ä¢ ${order.horario} ‚Ä¢ ${order.fecha} ${order.hora}
                        </div>
                        <div class="panel-item-meta">
                            ${order.estatus} ‚Ä¢ ${order.estatus2}
                            ${order.operador ? ` ‚Ä¢ üöõ ${order.operador}` : ''}
                        </div>
                    </div>
                    <div class="panel-item-actions">
                        <button class="btn-expand" onclick="showOrderDetails('${order.folio}', '${type}')">
                            üìã Ver
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterPanel(type) {
            const searchTerm = document.getElementById(`filter-${type}`).value.toLowerCase();
            const items = document.querySelectorAll(`#${type}-list .panel-item`);

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function sortPanel(type) {
            const sortBy = document.getElementById(`sort-${type}`).value;
            const orders = type === 'validated' ? STATE.validatedOrders : STATE.pendingOrders;

            orders.sort((a, b) => {
                switch(sortBy) {
                    case 'recent':
                        return new Date(`${b.fecha} ${b.hora}`) - new Date(`${a.fecha} ${a.hora}`);
                    case 'order':
                        return a.orden.localeCompare(b.orden);
                    case 'destino':
                        return a.destino.localeCompare(b.destino);
                    case 'horario':
                        return a.horario.localeCompare(b.horario);
                    default:
                        return 0;
                }
            });

            updatePanel(type, orders);
        }

        function showOrderDetails(folio, type) {
            const orders = type === 'validated' ? STATE.validatedOrders : STATE.pendingOrders;
            const order = orders.find(o => o.folio === folio);

            if (!order) return;

            alert(`üìã DETALLE DE ORDEN\n\nFolio: ${order.folio}\nOrden: ${order.orden}\nDestino: ${order.destino}\nHorario: ${order.horario}\nC√≥digo: ${order.codigo}\n${order.codigo2 ? `C√≥digo 2: ${order.codigo2}\n` : ''}Estatus: ${order.estatus}\nControl Calidad: ${order.estatus2}\nOperador: ${order.operador || '-'}\nUnidad: ${order.unidad || '-'}\nObservaciones: ${order.observaciones || '-'}`);
        }

        // ==================== SYNC ====================
        async function syncData() {
            if (PENDING_SYNC.length === 0) return;

            try {
                const values = PENDING_SYNC.map(r => [
                    r.folio, r.fecha, r.hora, r.usuario, r.orden, r.destino,
                    r.horario, r.codigo, r.codigo2, r.estatus, r.cambioEtiqueta,
                    r.estatus2, r.incidencias, r.operador, r.unidad, r.observaciones
                ]);

                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                    range: 'BD!A:P',
                    valueInputOption: 'USER_ENTERED',
                    insertDataOption: 'INSERT_ROWS',
                    resource: { values }
                });

                PENDING_SYNC = [];
                savePendingSync();
                showNotification(`‚úÖ ${values.length} registros sincronizados`, 'success');
            } catch (e) {
                showNotification('‚ùå Error en sincronizaci√≥n', 'error');
            }
        }

        function savePendingSync() {
            localStorage.setItem('desp_pending_sync', JSON.stringify(PENDING_SYNC));
        }

        function showSyncPanel() {
            alert(`üìä ESTADO DE SINCRONIZACI√ìN\n\nPendientes: ${PENDING_SYNC.length}\nValidadas: ${STATE.validatedOrders.length}\nPendientes: ${STATE.pendingOrders.length}`);
        }

        // ==================== MANUAL ORDER ====================
        function showManualOrderModal() {
            alert('üöß Funci√≥n en desarrollo');
        }

        // ==================== PRINT ====================
        function showPrintModal() {
            alert('üöß Funci√≥n de impresi√≥n en desarrollo');
        }

        // ==================== EXPORT ====================
        function exportData() {
            const allOrders = [...STATE.validatedOrders, ...STATE.pendingOrders];
            if (allOrders.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }

            const headers = ['Folio','Fecha','Hora','Usuario','Orden','Destino','Horario','C√≥digo','C√≥digo 2','Estatus','Cambio Etiqueta','Estatus 2','Incidencias','Operador','Unidad','Observaciones'];
            const rows = allOrders.map(r => [
                r.folio, r.fecha, r.hora, r.usuario, r.orden, r.destino,
                r.horario, r.codigo, r.codigo2, r.estatus, r.cambioEtiqueta,
                r.estatus2, r.incidencias, r.operador, r.unidad, r.observaciones
            ]);

            const csv = '\ufeff' + [
                headers.join(','),
                ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `despacho_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();

            showNotification('‚úÖ Datos exportados', 'success');
        }

        // ==================== UTILITIES ====================
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span style="margin-right: 8px;">${icons[type]}</span>${message}`;

            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }
    </script>
</body>
</html>
