<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö Sistema de Despacho Log√≠stico</title>
    <style>
        :root {
            --primary: #f97316;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --info: #2563eb;
            --bg: #f7f7f7;
            --text: #333;
            --card: #ffffff;
            --border: #e2e8f0;
            --gray: #6c757d;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 12px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, #ea580c 100%);
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        /* MAIN LAYOUT */
        .main-container {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #555;
        }

        .sidebar-header h2 {
            color: var(--primary);
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.8em;
            color: #aaa;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }

        .sidebar-section-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .sidebar-btn:hover {
            transform: translateX(3px);
        }

        .sidebar-btn-primary {
            background: var(--primary);
            color: white;
        }

        .sidebar-btn-secondary {
            background: #555;
            color: white;
        }

        .sidebar-btn-success {
            background: var(--success);
            color: white;
        }

        /* Sync Status */
        .sync-status {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            cursor: pointer;
        }
        .sync-ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .sync-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }
        .sync-warning {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* User Footer */
        .user-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            color: white;
            cursor: pointer;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .connection-indicator {
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }

        .user-footer-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .user-footer-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.75em;
        }

        .bd-info {
            font-size: 0.7em;
            color: #aaa;
            text-align: center;
            line-height: 1.4;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.4em;
        }

        /* Resumen Cajas del D√≠a */
        .day-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .day-summary-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .day-summary-card.total { border-color: var(--primary); }
        .day-summary-card.validated { border-color: var(--success); }
        .day-summary-card.pending { border-color: var(--warning); }
        .day-summary-card.problems { border-color: var(--error); }

        .day-summary-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .day-summary-value {
            font-size: 2em;
            font-weight: 700;
        }

        /* Scan Section */
        .scan-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scan-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .scan-input-group {
            flex: 1;
        }

        .scan-input-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .scan-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.3em;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
        }

        .scan-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Result Cards (like track.html) */
        .result-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .result-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 3px solid;
        }

        .result-card-label {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 4px;
        }

        .result-card-value {
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Panels */
        .panels-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            min-height: 0;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .panel-title {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .panel-count {
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
        }

        .panel-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .panel-filter-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .panel-filter-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .panel-list {
            flex: 1;
            overflow-y: auto;
        }

        .panel-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-item.validated { border-color: var(--success); }
        .panel-item.pending { border-color: var(--warning); }

        .panel-item-info {
            flex: 1;
        }

        .panel-item-order {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .panel-item-meta {
            font-size: 0.75em;
            color: #666;
        }

        .panel-item-actions {
            display: flex;
            gap: 6px;
        }

        .btn-expand {
            padding: 6px 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-google { background: #4285F4; color: white; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        /* KPI Cards Header (Estilo track.html exacto) */
        .modal-kpi-header {
            padding: 18px 20px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .kpi-card {
            padding: 12px 14px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .kpi-card:hover {
            background: #fafafa;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .kpi-card.orden { border-left: 3px solid var(--primary); }
        .kpi-card.destino { border-left: 3px solid var(--info); }
        .kpi-card.estatus { border-left: 3px solid var(--success); }
        .kpi-card.trs { border-left: 3px solid var(--warning); }
        .kpi-card.rastreo { border-left: 3px solid #9333ea; }

        .kpi-card-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .kpi-card-value {
            font-size: 1em;
            font-weight: 700;
            word-break: break-word;
            line-height: 1.3;
        }

        .kpi-card-subtitle {
            font-size: 0.75em;
            color: #666;
            margin-top: 4px;
        }

        .kpi-progress {
            margin-top: 6px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .kpi-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, #22c55e 100%);
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Copyable text (track.html) */
        .copyable {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .copy-icon {
            opacity: 0;
            cursor: pointer;
            font-size: 0.85em;
            transition: opacity 0.2s;
            color: #999;
        }

        .copyable:hover .copy-icon {
            opacity: 1;
        }

        .copy-icon:hover {
            color: var(--primary);
        }

        .copy-icon.copied {
            color: var(--success);
        }

        /* Sections (estilo track.html exacto) */
        .section-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .section-header:hover {
            background: #f8f9fa;
        }

        .section-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .section-title-wrapper {
            cursor: pointer;
            flex: 1;
        }

        .section-title {
            font-size: 1.05em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.2s;
        }

        .section-title-wrapper:hover .section-title {
            color: var(--primary);
        }

        .section-toggle {
            cursor: pointer;
            transition: transform 0.3s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .section-content.collapsed {
            max-height: 0;
        }

        /* Tabla de datos (estilo track.html) */
        /* Table Wrapper with Scroll (track.html style) */
        .table-wrapper {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            background: white;
        }

        .data-table th {
            background: #f9f9f9;
            padding: 12px;
            text-align: left;
            font-weight: 700;
            font-size: 0.8em;
            color: var(--text);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .data-table tr:hover {
            background: #f9f9f9;
        }

        .data-table code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        /* Modal Body */
        .modal-body {
            padding: 20px 25px;
            flex: 1;
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .modal-section-title {
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .modal-field {
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .modal-field-label {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .modal-field-value {
            font-weight: 700;
            color: var(--text);
            font-size: 0.95em;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: #374151;
        }

        .modal-input-group input,
        .modal-input-group select,
        .modal-input-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        .modal-input-group input:focus,
        .modal-input-group select:focus,
        .modal-input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Modal Footer */
        .modal-footer {
            padding: 20px 25px;
            border-top: 2px solid var(--border);
            background: #f8f9fa;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .modal-footer-selectors {
            display: flex;
            gap: 12px;
            flex: 1;
        }

        .modal-footer-selectors select {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 6px;
        }

        .badge.success { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        .badge.warning { background: rgba(255, 152, 0, 0.15); color: var(--warning); }
        .badge.error { background: rgba(244, 67, 54, 0.15); color: var(--error); }
        .badge.info { background: rgba(0, 188, 212, 0.15); color: var(--info); }
        .badge.primary { background: rgba(249, 115, 22, 0.15); color: var(--primary); }
        .badge.gray { background: rgba(108, 117, 125, 0.15); color: var(--gray); }

        /* Copyable value with hover icon (from track.html) */
        .copyable {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        .copy-icon {
            opacity: 0;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: all 0.2s;
            color: #888;
            display: inline-flex;
            align-items: center;
        }

        .copyable:hover .copy-icon {
            opacity: 1;
        }

        .copy-icon:hover {
            background: #e0e0e0;
            color: var(--primary);
        }

        .copy-icon.copied {
            opacity: 1;
            color: var(--success);
        }

        .copy-icon svg {
            width: 14px;
            height: 14px;
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .notification {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }

        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .hidden { display: none !important; }

        /* Welcome Screen */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .welcome-card {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .welcome-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        .welcome-title {
            font-size: 2em;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 30px;
        }

        .welcome-btn {
            padding: 16px 40px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }

        .welcome-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
        }

        /* Preloader */
        .preloader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .preloader-overlay.show { display: flex; }

        .preloader-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .preloader-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .preloader-text {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 10px;
        }

        .preloader-subtext {
            font-size: 0.9em;
            color: #666;
        }

        /* Date Filter Modal */
        .date-filter-modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 95%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .date-filter-header {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
            text-align: center;
        }

        .date-input-group {
            margin-bottom: 20px;
        }

        .date-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .date-input-group input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .date-input-group input[type="date"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .panels-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="notification-container" id="notifications"></div>

    <!-- LOGIN -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">üöö</div>
            <h1 class="login-title">Sistema de Despacho</h1>
            <p class="login-subtitle">Validaci√≥n y Control Log√≠stico</p>
            <button class="btn btn-google" style="width: 100%; padding: 15px; font-size: 1.1em;" onclick="handleLogin()">
                üîê Iniciar sesi√≥n con Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <div class="main-container">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>üöö Despacho</h2>
                    <p>Control Log√≠stico</p>
                </div>

                <div id="sync-status" class="sync-status sync-ok" onclick="showSyncPanel()">
                    ‚úÖ Sincronizado
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Acciones</div>
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showDateFilterModal()">
                        üìÖ Filtrar por Fecha
                    </button>
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showManualOrderModal()">
                        ‚ûï Orden Manual
                    </button>
                    <button class="sidebar-btn sidebar-btn-success" onclick="showPrintModal()">
                        üñ®Ô∏è Imprimir Listas
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="exportData()">
                        üì• Exportar
                    </button>
                </div>

                <div class="user-footer">
                    <div class="user-avatar" id="user-avatar" onclick="changeUserAlias()">?</div>
                    <div class="user-name" id="user-name-display">No conectado</div>
                    <div id="sync-status" class="sync-status">‚è≥</div>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- Empty Dashboard (shown initially) -->
                <div id="empty-dashboard" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
                    <div style="font-size: 5em; margin-bottom: 20px;">üöö</div>
                    <h2 style="font-size: 1.8em; color: var(--text); margin-bottom: 10px;">Sistema de Despacho</h2>
                    <p style="font-size: 1.1em; color: #666; margin-bottom: 30px;">Bienvenido al sistema de validaci√≥n log√≠stica</p>
                    <button class="btn btn-primary" onclick="showDateFilterModal()" style="padding: 16px 40px; font-size: 1.2em;">
                        üöÄ Iniciar Validaci√≥n
                    </button>
                </div>

                <!-- Validation Content (shown after selecting date range) -->
                <div id="validation-content" style="display: none; height: 100%; display: flex; flex-direction: column;">
                    <!-- Header -->
                    <div class="header">
                        <h1>üì¶ Validaci√≥n de Despacho</h1>
                    </div>

                    <!-- Resumen del D√≠a -->
                <div class="day-summary">
                    <div class="day-summary-card total">
                        <div class="day-summary-label">Total √ìrdenes</div>
                        <div class="day-summary-value" id="summary-total">0</div>
                    </div>
                    <div class="day-summary-card validated">
                        <div class="day-summary-label">Validadas</div>
                        <div class="day-summary-value" id="summary-validated">0</div>
                    </div>
                    <div class="day-summary-card pending">
                        <div class="day-summary-label">Pendientes</div>
                        <div class="day-summary-value" id="summary-pending">0</div>
                    </div>
                    <div class="day-summary-card problems">
                        <div class="day-summary-label">Con Problemas</div>
                        <div class="day-summary-value" id="summary-problems">0</div>
                    </div>
                </div>

                <!-- Scan Section -->
                <div class="scan-section">
                    <div class="scan-row">
                        <div class="scan-input-group">
                            <label>üîç Buscar por C√≥digo de Barras o N√∫mero de OBC</label>
                            <input type="text" class="scan-input" id="scan-input" placeholder="Escanea c√≥digo o ingresa OBC..." autocomplete="off">
                        </div>
                        <button class="btn btn-primary" onclick="processScan()">üîç Buscar</button>
                        <button class="btn btn-secondary" onclick="clearScan()">üóëÔ∏è Limpiar</button>
                    </div>
                </div>

                <!-- Result Cards (Cabeceras Resumen) -->
                <div class="result-cards" id="result-cards" style="display: none;">
                    <!-- Se generan din√°micamente -->
                </div>

                <!-- Panels: Validadas | Pendientes -->
                <div class="panels-container">
                    <!-- Panel Validadas -->
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">
                                ‚úÖ Validadas
                                <span class="panel-count" style="background: rgba(76, 175, 80, 0.15); color: var(--success);" id="validated-count">0</span>
                            </span>
                        </div>
                        <div class="panel-filters">
                            <input type="text" class="panel-filter-input" id="filter-validated" placeholder="üîç Buscar..." oninput="filterPanel('validated')">
                            <select class="panel-filter-select" id="sort-validated" onchange="sortPanel('validated')">
                                <option value="recent">M√°s recientes</option>
                                <option value="order">Por orden</option>
                                <option value="destino">Por destino</option>
                                <option value="horario">Por horario</option>
                            </select>
                        </div>
                        <div class="panel-list" id="validated-list">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                                <div>Sin validaciones</div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Pendientes -->
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">
                                ‚è≥ Pendientes
                                <span class="panel-count" style="background: rgba(255, 152, 0, 0.15); color: var(--warning);" id="pending-count">0</span>
                            </span>
                        </div>
                        <div class="panel-filters">
                            <input type="text" class="panel-filter-input" id="filter-pending" placeholder="üîç Buscar..." oninput="filterPanel('pending')">
                            <select class="panel-filter-select" id="sort-pending" onchange="sortPanel('pending')">
                                <option value="recent">M√°s recientes</option>
                                <option value="order">Por orden</option>
                                <option value="destino">Por destino</option>
                                <option value="horario">Por horario</option>
                            </select>
                        </div>
                        <div class="panel-list" id="pending-list">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                                <div>Sin pendientes</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                <!-- End validation-content -->
            </div>
        </div>
    </div>

    <!-- DATE FILTER MODAL -->
    <div class="modal-overlay" id="date-filter-modal">
        <div class="date-filter-modal">
            <div class="date-filter-header">üìÖ Filtro Temporal</div>
            <p style="text-align: center; color: #666; margin-bottom: 25px;">
                Selecciona el rango de fechas para cargar las √≥rdenes
            </p>
            <div class="date-input-group">
                <label>üìÜ Fecha Inicial</label>
                <input type="date" id="date-start" required>
            </div>
            <div class="date-input-group">
                <label>üìÜ Fecha Final</label>
                <input type="date" id="date-end" required>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyDateFilter()" style="flex: 1;">
                    ‚úÖ Aplicar Filtro
                </button>
                <button class="btn btn-warning" onclick="clearDateFilterAndClose()">
                    üîÑ Quitar Filtro
                </button>
                <button class="btn btn-secondary" onclick="closeDateFilterModal()">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- PRELOADER -->
    <div class="preloader-overlay" id="preloader">
        <div class="preloader-content">
            <div class="preloader-spinner"></div>
            <div class="preloader-text" id="preloader-text">Conectando con Google Sheets...</div>
            <div class="preloader-subtext" id="preloader-subtext">Por favor espera un momento</div>
        </div>
    </div>

    <!-- VALIDATION MODAL -->
    <div class="modal-overlay" id="validation-modal">
        <div class="modal-content">
            <!-- HEADER -->
            <div class="modal-header">
                <div class="modal-title">üì¶ Validaci√≥n de Despacho</div>
                <button class="modal-close" onclick="closeValidationModal()">√ó</button>
            </div>

            <!-- KPI CARDS HEADER (Compactas con navegaci√≥n) -->
            <div class="modal-kpi-header">
                <div class="kpi-cards">
                    <!-- KPI 1: Orden (OBC) -->
                    <div class="kpi-card orden" onclick="jumpToSection('section-obc')">
                        <div class="kpi-card-label">üì¶ Orden OBC</div>
                        <div class="kpi-card-value" id="kpi-orden">-</div>
                        <div class="kpi-card-subtitle" id="kpi-orden-boxes">-</div>
                    </div>

                    <!-- KPI 2: Destino y Horario -->
                    <div class="kpi-card destino" onclick="jumpToSection('section-obc')">
                        <div class="kpi-card-label">üåç Destino</div>
                        <div class="kpi-card-value" id="kpi-destino">-</div>
                        <div class="kpi-card-subtitle" id="kpi-horario">-</div>
                    </div>

                    <!-- KPI 3: Validaci√≥n de Surtido -->
                    <div class="kpi-card estatus" onclick="jumpToSection('section-val3')">
                        <div class="kpi-card-label">‚úÖ Validaci√≥n Surtido</div>
                        <div class="kpi-card-value" id="kpi-validacion">0%</div>
                        <div class="kpi-progress">
                            <div class="kpi-progress-bar" id="kpi-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- KPI 4: Orden TRS -->
                    <div class="kpi-card trs" onclick="jumpToSection('section-trs')">
                        <div class="kpi-card-label">üîÑ Orden TRS</div>
                        <div class="kpi-card-value" id="kpi-trs">-</div>
                        <div class="kpi-card-subtitle" id="kpi-trs-match">-</div>
                    </div>

                    <!-- KPI 5: Rastreo -->
                    <div class="kpi-card rastreo" onclick="jumpToSection('section-rastreo')">
                        <div class="kpi-card-label">üìç Rastreo</div>
                        <div class="kpi-card-value" id="kpi-tracking">-</div>
                        <div class="kpi-card-subtitle" id="kpi-tracking-status">-</div>
                    </div>
                </div>
            </div>

            <!-- MODAL BODY (Estilo track.html) -->
            <div class="modal-body">
                <!-- Secci√≥n 1: Orden OBC (con validaci√≥n integrada) -->
                <div class="section-card" id="section-obc" style="scroll-margin-top: 20px;">
                    <div class="section-header" onclick="toggleSection('section-obc-content')">
                        <div class="section-header-left">
                            <div class="section-title-wrapper" onclick="event.stopPropagation(); toggleSection('section-obc-content')">
                                <div class="section-title">üì¶ Orden OBC</div>
                            </div>
                        </div>
                        <span class="section-toggle" id="section-obc-toggle" onclick="toggleSection('section-obc-content')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </div>
                    <div class="section-content" id="section-obc-content">
                        <div id="obc-table-container">
                            <!-- Tabla horizontal generada din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 2: Orden TRS (con validaci√≥n integrada) -->
                <div class="section-card" id="section-trs" style="scroll-margin-top: 20px; display: none;">
                    <div class="section-header" onclick="toggleSection('section-trs-content')">
                        <div class="section-header-left">
                            <div class="section-title-wrapper" onclick="event.stopPropagation(); toggleSection('section-trs-content')">
                                <div class="section-title">üîÑ Orden TRS</div>
                            </div>
                        </div>
                        <span class="section-toggle" id="section-trs-toggle" onclick="toggleSection('section-trs-content')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </div>
                    <div class="section-content" id="section-trs-content">
                        <div id="trs-table-container">
                            <!-- Tabla horizontal generada din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 3: Validaci√≥n de Surtido (BD Val3) -->
                <div class="section-card" id="section-val3" style="scroll-margin-top: 20px; display: none;">
                    <div class="section-header" onclick="toggleSection('section-val3-content')">
                        <div class="section-header-left">
                            <div class="section-title-wrapper" onclick="event.stopPropagation(); toggleSection('section-val3-content')">
                                <div class="section-title">‚úÖ Validaci√≥n de Surtido</div>
                            </div>
                        </div>
                        <span class="section-toggle" id="section-val3-toggle" onclick="toggleSection('section-val3-content')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </div>
                    <div class="section-content" id="section-val3-content">
                        <div id="val3-table-container">
                            <!-- Tabla horizontal generada din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 4: Rastreo MNE -->
                <div class="section-card" id="section-rastreo" style="scroll-margin-top: 20px; display: none;">
                    <div class="section-header" onclick="toggleSection('section-rastreo-content')">
                        <div class="section-header-left">
                            <div class="section-title-wrapper" onclick="event.stopPropagation(); toggleSection('section-rastreo-content')">
                                <div class="section-title">üìç Rastreo de Cajas</div>
                            </div>
                        </div>
                        <span class="section-toggle" id="section-rastreo-toggle" onclick="toggleSection('section-rastreo-content')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </div>
                    <div class="section-content" id="section-rastreo-content">
                        <div id="rastreo-table-container">
                            <!-- Tabla horizontal generada din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
                <div class="modal-footer-selectors">
                    <select id="modal-operador">
                        <option value="">üë§ Conductor...</option>
                    </select>
                    <select id="modal-unidad">
                        <option value="">üöõ Unidad/Placas...</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-success" onclick="confirmValidation()">
                        ‚úÖ Confirmar Despacho
                    </button>
                    <button class="btn btn-secondary" onclick="closeValidationModal()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            CLIENT_ID: '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile',
            SPREADSHEET_WRITE: '1T_yXd4MFyp-Ks2iTTr0KAd12QhXjW2eUMVqnAx8XSJM',
            SOURCES: {
                BD_STOCK: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-HG8HPf-94Ki5Leo5iEF5pyqsiD9CVk-mcl-F8BAw34kT0s3nzNn532YTYDCtkG76NbauiVx0Ffmd/pub?output=csv',
                OBC_BD: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSdSDQ8ktYA3YAsWMUokYd_S6_rANUz8XdfEAjsV-v0eAlfiYZctHuj3hP4m3wOghf4rnT_YvuA4BPA/pub?output=csv',
                VALIDACION: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZMZZCDtTFCebvsme1GMEBiZ1S2Cloh37AR8hHFAwhFPNEMD27G04bzX0theCMJE-nlYOyH2ev115q/pub?output=csv',
                MNE: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHzXpt4q7KYo8QMnrO92LGcXQbx14lBCQ0wxHGHm2Lz4v5RCJCpQHmS0NhUTHUCCG2Hc1bkvTYhdpz/pub?gid=883314398&single=true&output=csv',
                TRS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2NOvCCzIW0IS9ANzOYl7GKBq5I-XQM9e_V1tu_2VrDMq4Frgjol5uj6-4dBgEQcfB8b-k6ovaOJGc/pub?output=csv',
                LISTAS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTmbzg922y1KMVnV0JqBijR43Ma8e5X_AO2KVzjHBnRtGBx-0aXLZ8UUlKCO_XHOpV1qfggQyNjtqde/pub?gid=799838428&single=true&output=csv'
            }
        };

        // ==================== STATE ====================
        let STATE = {
            obcData: new Map(), // TODA la BD OBC (sin filtro)
            obcDataFiltered: new Map(), // Solo las √≥rdenes del rango de fechas seleccionado
            validacionData: new Map(),
            mneData: new Map(),
            trsData: [],
            operadores: [],
            unidades: [],
            validatedOrders: [],
            pendingOrders: [],
            currentScan: null,
            folioCounter: 1,
            dateFilter: {
                startDate: null,
                endDate: null,
                active: false // Indica si hay un filtro activo
            }
        };

        let CURRENT_USER = '';
        let USER_EMAIL = '';
        let USER_GOOGLE_NAME = '';
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];
        let TOKEN_CLIENT = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadPendingSync(); // Cargar registros pendientes de localStorage
            setupConnectionMonitoring(); // Monitorear conexi√≥n a internet
            gapi.load('client', initGAPI);
        });

        function setupConnectionMonitoring() {
            // Actualizar IS_ONLINE cuando cambie la conectividad
            window.addEventListener('online', () => {
                IS_ONLINE = true;
                updateSyncStatus();
                updateConnectionIndicator();
                showNotification('üåê Conexi√≥n restaurada', 'success');
                // Intentar sincronizar autom√°ticamente
                if (gapi?.client?.getToken() && PENDING_SYNC.length > 0) {
                    syncData(false);
                }
            });

            window.addEventListener('offline', () => {
                IS_ONLINE = false;
                updateSyncStatus();
                updateConnectionIndicator();
                showNotification('‚ö†Ô∏è Sin conexi√≥n a Internet', 'warning');
            });

            // Inicializar indicador
            updateConnectionIndicator();
        }

        function updateConnectionIndicator() {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');

            if (!dot || !text) return;

            if (IS_ONLINE && gapi?.client?.getToken()) {
                dot.className = 'connection-dot online';
                text.textContent = 'Online';
            } else if (IS_ONLINE) {
                dot.className = 'connection-dot offline';
                text.textContent = 'No autenticado';
            } else {
                dot.className = 'connection-dot offline';
                text.textContent = 'Offline';
            }
        }

        function setupEventListeners() {
            const scanInput = document.getElementById('scan-input');
            scanInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && scanInput.value.trim()) {
                    e.preventDefault();
                    processScan();
                }
            });
        }

        async function initGAPI() {
            try {
                await gapi.client.init({
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
                });
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: handleAuthCallback,
                    error_callback: (error) => {
                        hidePreloader();
                        if (error.type !== 'popup_closed') {
                            showNotification('‚ùå Error de autenticaci√≥n: ' + error.message, 'error');
                        } else {
                            showNotification('‚ö†Ô∏è Autenticaci√≥n cancelada', 'warning');
                        }
                    }
                });
            } catch (e) {
                hidePreloader();
                showNotification('Error inicializando API', 'error');
            }
        }

        async function handleAuthCallback(response) {
            if (response?.access_token) {
                gapi.client.setToken(response);
                showPreloader('Cargando base de datos...', 'Obteniendo informaci√≥n del sistema');
                await getUserProfile();
                await loadAllData(); // Carga TODA la BD sin filtro
                hidePreloader();
                updateConnectionIndicator();
                updateSyncStatus();
                showNotification('‚úÖ Conexi√≥n exitosa - BD cargada completa', 'success');
                showApp();

                // Si hay registros pendientes, intentar sincronizar
                if (PENDING_SYNC.length > 0) {
                    setTimeout(() => syncData(true), 1000);
                }
            }
        }

        function handleLogin() {
            showPreloader('Conectando con Google Sheets...', 'Por favor autoriza el acceso en la ventana emergente');
            TOKEN_CLIENT?.requestAccessToken();
        }

        // ================= AVATAR / USER SYSTEM =================
        async function getUserProfile() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` }
                });
                const data = await response.json();

                USER_EMAIL = data.email || '';
                USER_GOOGLE_NAME = data.name || 'Usuario';

                const savedAlias = localStorage.getItem(`pd_alias_${USER_EMAIL}`);
                if (savedAlias) {
                    CURRENT_USER = savedAlias;
                    updateUserFooter();
                } else {
                    showAliasPopup();
                }
            } catch (e) {
                console.error('Error obteniendo perfil', e);
            }
        }

        function showAliasPopup() {
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show alias-popup';
            overlay.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">üë§ ¬øC√≥mo te llamamos?</div>
                    <button onclick="saveUserAlias('${USER_GOOGLE_NAME}', true)">Usar nombre de Google</button>
                    <input id="alias-input" placeholder="Alias personalizado">
                    <button onclick="saveUserAlias(document.getElementById('alias-input').value)">Guardar</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function saveUserAlias(alias) {
            const finalAlias = alias.trim() || USER_GOOGLE_NAME;
            CURRENT_USER = finalAlias;
            localStorage.setItem(`pd_alias_${USER_EMAIL}`, finalAlias);
            document.querySelectorAll('.alias-popup').forEach(e => e.remove());
            updateUserFooter();
        }

        function changeUserAlias() {
            showAliasPopup();
        }

        function updateUserFooter() {
            const avatar = document.getElementById('user-avatar');
            const nameDisplay = document.getElementById('user-name-display');

            if (!avatar || !nameDisplay) return;

            avatar.textContent = CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : '?';
            nameDisplay.textContent = CURRENT_USER || 'No conectado';

            SyncManager.updateUI(PENDING_SYNC.length === 0);
        }

        // ================= SYNC MANAGER =================
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];

        window.addEventListener('online', () => {
            IS_ONLINE = true;
            SyncManager.updateUI(false);
        });
        window.addEventListener('offline', () => {
            IS_ONLINE = false;
            SyncManager.updateUI(false);
        });

        const SyncManager = {
            inProgress: false,
            AUTO_SYNC_INTERVAL: 30000,
            intervalId: null,

            init() {
                this.load();
                this.startAutoSync();
                this.setupExitProtection();
                this.updateUI(PENDING_SYNC.length === 0);
            },

            setupExitProtection() {
                window.addEventListener('beforeunload', (e) => {
                    if (PENDING_SYNC.length > 0) {
                        e.preventDefault();
                        e.returnValue = 'Hay datos pendientes por sincronizar';
                    }
                });
            },

            startAutoSync() {
                this.intervalId = setInterval(() => {
                    if (IS_ONLINE && gapi?.client?.getToken() && PENDING_SYNC.length > 0) {
                        this.sync(false);
                    }
                }, this.AUTO_SYNC_INTERVAL);
            },

            async sync(showMessages = true) {
                if (!IS_ONLINE || !gapi?.client?.getToken() || PENDING_SYNC.length === 0) return;

                try {
                    this.inProgress = true;

                    const values = PENDING_SYNC.map(r => Object.values(r));

                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                        range: `${CONFIG.SHEET_NAME}!A:Z`,
                        valueInputOption: 'USER_ENTERED',
                        insertDataOption: 'INSERT_ROWS',
                        resource: { values }
                    });

                    PENDING_SYNC = [];
                    this.save();
                    this.updateUI(true);
                } catch (e) {
                    console.error('Error sincronizando', e);
                } finally {
                    this.inProgress = false;
                }
            },

            save() {
                localStorage.setItem('pd_pending_sync', JSON.stringify(PENDING_SYNC));
            },

            load() {
                const saved = localStorage.getItem('pd_pending_sync');
                if (saved) PENDING_SYNC = JSON.parse(saved);
            },

            updateUI(synced) {
                const el = document.getElementById('sync-status');
                if (!el) return;

                if (!IS_ONLINE) {
                    el.className = 'sync-status sync-warning';
                    el.textContent = '‚ö†Ô∏è Sin conexi√≥n';
                } else if (PENDING_SYNC.length > 0) {
                    el.className = 'sync-status sync-warning';
                    el.textContent = `‚è≥ ${PENDING_SYNC.length} pendientes`;
                } else {
                    el.className = 'sync-status sync-ok';
                    el.textContent = '‚úÖ Sincronizado';
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            SyncManager.init();
        });

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

            // Mostrar dashboard vac√≠o al inicio
            document.getElementById('empty-dashboard').style.display = 'flex';
            document.getElementById('validation-content').style.display = 'none';

            updateUI();
        }

        function handleLogout() {
            if (gapi.client.getToken()) {
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                gapi.client.setToken(null);
            }
            location.reload();
        }

        // ==================== DATE FILTER MODAL ====================
        function showDateFilterModal() {
            // Set default dates based on current filter or defaults
            const today = new Date();
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 7);

            // If filter is already set, use those dates
            if (STATE.dateFilter.startDate && STATE.dateFilter.endDate) {
                document.getElementById('date-start').value = STATE.dateFilter.startDate;
                document.getElementById('date-end').value = STATE.dateFilter.endDate;
            } else {
                document.getElementById('date-start').value = today.toISOString().slice(0, 10);
                document.getElementById('date-end').value = endDate.toISOString().slice(0, 10);
            }

            document.getElementById('date-filter-modal').classList.add('show');
        }

        function closeDateFilterModal() {
            document.getElementById('date-filter-modal').classList.remove('show');
        }

        async function applyDateFilter() {
            const startDate = document.getElementById('date-start').value;
            const endDate = document.getElementById('date-end').value;

            if (!startDate || !endDate) {
                showNotification('‚ö†Ô∏è Por favor selecciona ambas fechas', 'warning');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showNotification('‚ö†Ô∏è La fecha inicial debe ser menor o igual a la fecha final', 'warning');
                return;
            }

            // Save date filter
            STATE.dateFilter.startDate = startDate;
            STATE.dateFilter.endDate = endDate;
            STATE.dateFilter.active = true;

            closeDateFilterModal();

            // Filtrar las √≥rdenes cargadas por el rango de fechas
            showPreloader('Filtrando √≥rdenes...', 'Seleccionando √≥rdenes del periodo');
            filterOrdersByDateRange();
            hidePreloader();

            // Mostrar contenido de validaci√≥n y ocultar dashboard vac√≠o
            document.getElementById('empty-dashboard').style.display = 'none';
            document.getElementById('validation-content').style.display = 'flex';

            // Focus en el input de escaneo
            setTimeout(() => {
                document.getElementById('scan-input')?.focus();
            }, 100);

            // Show notification about the selected range
            const start = new Date(startDate).toLocaleDateString('es-ES');
            const end = new Date(endDate).toLocaleDateString('es-ES');
            const count = STATE.obcDataFiltered.size;
            showNotification(`üìÖ Filtro aplicado: ${start} - ${end} (${count} √≥rdenes)`, 'success');

            updateUI();
        }

        function filterOrdersByDateRange() {
            STATE.obcDataFiltered.clear();

            const startDate = new Date(STATE.dateFilter.startDate);
            const endDate = new Date(STATE.dateFilter.endDate);
            endDate.setHours(23, 59, 59, 999); // Include full end date

            // Filtrar √≥rdenes por fecha
            for (const [orden, data] of STATE.obcData.entries()) {
                if (data.expectedArrival) {
                    const orderDate = parseOrderDate(data.expectedArrival);
                    if (orderDate && orderDate >= startDate && orderDate <= endDate) {
                        STATE.obcDataFiltered.set(orden, data);
                    }
                }
            }

            console.log(`Filtradas ${STATE.obcDataFiltered.size} √≥rdenes de ${STATE.obcData.size} totales`);
        }

        async function clearDateFilterAndClose() {
            STATE.dateFilter.startDate = null;
            STATE.dateFilter.endDate = null;
            STATE.dateFilter.active = false;
            STATE.obcDataFiltered.clear();

            closeDateFilterModal();

            // Volver al dashboard vac√≠o
            document.getElementById('validation-content').style.display = 'none';
            document.getElementById('empty-dashboard').style.display = 'flex';

            showNotification('üîÑ Filtro removido - Volviendo al dashboard', 'info');
        }

        // ==================== PRELOADER ====================
        function showPreloader(text = 'Cargando...', subtext = 'Por favor espera') {
            document.getElementById('preloader-text').textContent = text;
            document.getElementById('preloader-subtext').textContent = subtext;
            document.getElementById('preloader').classList.add('show');
        }

        function hidePreloader() {
            document.getElementById('preloader').classList.remove('show');
        }

        function changeUserAlias() {
            const newAlias = prompt('Ingresa tu nombre:', CURRENT_USER);
            if (newAlias && newAlias.trim()) {
                CURRENT_USER = newAlias.trim();
                localStorage.setItem(`desp_alias_${USER_EMAIL}`, CURRENT_USER);
                updateUserFooter();
            }
        }

        function updateUserFooter() {
            const avatar = document.getElementById('user-avatar');
            const nameDisplay = document.getElementById('user-name-display');

            if (avatar) {
                avatar.textContent = CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : '?';
            }
            if (nameDisplay) {
                nameDisplay.textContent = CURRENT_USER || 'No conectado';
            }
        }

        function toggleConnection() {
            if (gapi?.client?.getToken()) {
                if (confirm('¬øDesconectar?')) {
                    google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                    gapi.client.setToken(null);
                    location.reload();
                }
            } else {
                handleLogin();
            }
        }

        // ==================== DATA LOADING ====================
        async function loadAllData() {
            showNotification('üîÑ Cargando datos...', 'info');

            try {
                // Load OBC_BD
                const obcResponse = await fetch(CONFIG.SOURCES.OBC_BD);
                const obcCsv = await obcResponse.text();
                parseOBCData(obcCsv);

                // Load LISTAS (Operadores y Unidades)
                const listasResponse = await fetch(CONFIG.SOURCES.LISTAS);
                const listasCsv = await listasResponse.text();
                parseListasData(listasCsv);

                // Load TRS
                const trsResponse = await fetch(CONFIG.SOURCES.TRS);
                const trsCsv = await trsResponse.text();
                parseTRSData(trsCsv);

                // Load VALIDACION (Val3)
                const validacionResponse = await fetch(CONFIG.SOURCES.VALIDACION);
                const validacionCsv = await validacionResponse.text();
                parseValidacionData(validacionCsv);

                // Load MNE (Rastreo)
                const mneResponse = await fetch(CONFIG.SOURCES.MNE);
                const mneCsv = await mneResponse.text();
                parseMNEData(mneCsv);

                // Show notification with date range if filtered
                let message = `‚úÖ ${STATE.obcData.size} √≥rdenes cargadas`;
                if (STATE.dateFilter.startDate && STATE.dateFilter.endDate) {
                    const start = new Date(STATE.dateFilter.startDate).toLocaleDateString('es-ES');
                    const end = new Date(STATE.dateFilter.endDate).toLocaleDateString('es-ES');
                    message += ` (${start} - ${end})`;
                }
                showNotification(message, 'success');
                updateBdInfo();
            } catch (e) {
                console.error('Error loading data:', e);
                showNotification('‚ùå Error cargando datos', 'error');
            }
        }

        function parseOBCData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.obcData.clear(); // Limpiar TODA la BD

            /**
             * Base de datos OBC (Outbound) - Estructura de columnas:
             * Columna 0: Outbound_Âá∫Â∫ìÂçïÂè∑ (N√∫mero de orden de salida)
             * Columna 1: Reference order No._ÂèÇËÄÉÂçïÂè∑ (N√∫mero de orden de referencia)
             * Columna 2: Shipping service_Áâ©ÊµÅÊ∏†ÈÅì (Servicio de env√≠o/Canal log√≠stico)
             * Columna 3: Ë¥ß‰ª∂ËøΩË∏™Á†Å/Reference ID (C√≥digo de seguimiento de env√≠o)
             * Columna 4: Expected Arrival Time _ ÊúüÊúõÂà∞‰ªìÊó∂Èó¥ (Fecha esperada de llegada a almac√©n)
             * Columna 5: Remark_Â§áÊ≥® (Observaciones)
             * Columna 6: Recipient_Êî∂‰ª∂‰∫∫ (Destinatario)
             * Columna 7: Box type No_ÁÆ±Á±ªÂûãÂè∑ (Tipo de caja)
             * Columna 8: Custom box barcode_Ëá™ÂÆö‰πâÁÆ±Êù°Á†Å (C√≥digo de barras personalizado de la caja) ‚ö†Ô∏è USADO PARA B√öSQUEDA
             */
            const outboundIdx = 0;
            const refNoIdx = 1;
            const shippingServiceIdx = 2;
            const trackingCodeIdx = 3;
            const expectedArrivalIdx = 4;
            const remarkIdx = 5;
            const recipientIdx = 6;
            const boxTypeIdx = 7;
            const customBarcodeIdx = 8; // ‚ö†Ô∏è COLUMNA I - Usada para buscar c√≥digos escaneados

            // Cargar TODO sin filtro
            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length >= 6) {
                    const orden = cols[outboundIdx]?.trim();
                    const expectedArrival = cols[expectedArrivalIdx]?.trim();
                    const customBarcode = cols[customBarcodeIdx]?.trim();

                    if (orden) {
                        STATE.obcData.set(orden, {
                            orden, // Outbound_Âá∫Â∫ìÂçïÂè∑
                            referenceNo: cols[refNoIdx]?.trim() || '', // Reference order No._ÂèÇËÄÉÂçïÂè∑
                            shippingService: cols[shippingServiceIdx]?.trim() || '', // Shipping service_Áâ©ÊµÅÊ∏†ÈÅì
                            trackingCode: cols[trackingCodeIdx]?.trim() || '', // Ë¥ß‰ª∂ËøΩË∏™Á†Å/Reference ID
                            expectedArrival: expectedArrival || '', // Expected Arrival Time _ ÊúüÊúõÂà∞‰ªìÊó∂Èó¥
                            remark: cols[remarkIdx]?.trim() || '', // Remark_Â§áÊ≥®
                            recipient: cols[recipientIdx]?.trim() || '', // Recipient_Êî∂‰ª∂‰∫∫
                            boxType: cols[boxTypeIdx]?.trim() || '', // Box type No_ÁÆ±Á±ªÂûãÂè∑
                            customBarcode: customBarcode || '', // Custom box barcode_Ëá™ÂÆö‰πâÁÆ±Êù°Á†Å

                            // Legacy fields for backward compatibility
                            ref1: cols[refNoIdx]?.trim() || '',
                            ref2: cols[shippingServiceIdx]?.trim() || '',
                            horario: cols[trackingCodeIdx]?.trim() || '',
                            destino: cols[recipientIdx]?.trim() || '',
                            codigo: customBarcode || '' // Usa customBarcode para b√∫squeda
                        });
                    }
                }
            }
        }

        // Helper function to parse dates from OBC (handles various formats)
        function parseOrderDate(dateStr) {
            if (!dateStr) return null;

            // Try ISO format first (YYYY-MM-DD)
            let date = new Date(dateStr);
            if (!isNaN(date.getTime())) return date;

            // Try DD/MM/YYYY
            const parts = dateStr.split(/[/-]/);
            if (parts.length === 3) {
                // Assume DD/MM/YYYY or MM/DD/YYYY
                const d = parseInt(parts[0]);
                const m = parseInt(parts[1]);
                const y = parseInt(parts[2]);

                // If year is 2 digits, convert to 4
                const year = y < 100 ? 2000 + y : y;

                // Try DD/MM/YYYY first
                date = new Date(year, m - 1, d);
                if (!isNaN(date.getTime())) return date;

                // Try MM/DD/YYYY
                date = new Date(year, d - 1, m);
                if (!isNaN(date.getTime())) return date;
            }

            return null;
        }

        function parseListasData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.operadores = [];
            STATE.unidades = [];

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                // Columna B (√≠ndice 1): Operadores
                // Columna D (√≠ndice 3): Unidades
                const operador = cols[1]?.trim().toUpperCase();
                const unidad = cols[3]?.trim().toUpperCase();

                if (operador && !STATE.operadores.includes(operador)) {
                    STATE.operadores.push(operador);
                }
                if (unidad && !STATE.unidades.includes(unidad)) {
                    STATE.unidades.push(unidad);
                }
            }

            // Populate selects
            populateOperadoresUnidades();
        }

        function populateOperadoresUnidades() {
            const operadorSelect = document.getElementById('modal-operador');
            const unidadSelect = document.getElementById('modal-unidad');

            operadorSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                STATE.operadores.map(op => `<option value="${op}">${op}</option>`).join('');

            unidadSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                STATE.unidades.map(un => `<option value="${un}">${un}</option>`).join('');
        }

        function parseTRSData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.trsData = [];

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length >= 15 && cols[0]?.startsWith('TRS')) {
                    STATE.trsData.push({
                        trs: cols[0]?.trim(),
                        referencia: cols[6]?.trim() || '',
                        codigoOriginal: cols[13]?.trim() || '',
                        codigoNuevo: cols[14]?.trim() || ''
                    });
                }
            }
        }

        function parseValidacionData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.validacionData.clear();

            /**
             * Base de datos VALIDACION (Validaci√≥n de Surtido) - Estructura:
             * Columna 0: Fecha
             * Columna 1: Hora
             * Columna 2: Validador (Usuario)
             * Columna 3: Orden (OBC)
             * Columna 4: Codigo
             * Columna 5: Ubicaci√≥n
             * Columna 6: Porcentaje Validado
             * Columna 7: Nota
             */
            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length >= 5) {
                    const orden = cols[3]?.trim();
                    if (orden) {
                        if (!STATE.validacionData.has(orden)) {
                            STATE.validacionData.set(orden, []);
                        }
                        STATE.validacionData.get(orden).push({
                            fecha: cols[0]?.trim() || '',
                            hora: cols[1]?.trim() || '',
                            usuario: cols[2]?.trim() || '',
                            orden: orden,
                            codigo: cols[4]?.trim() || '',
                            ubicacion: cols[5]?.trim() || '',
                            porcentaje: cols[6]?.trim() || '',
                            nota: cols[7]?.trim() || ''
                        });
                    }
                }
            }
        }

        function parseMNEData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.mneData.clear();

            /**
             * Base de datos MNE (Rastreo) - Estructura:
             * Columna 0: Fecha
             * Columna 1: Mes
             * Columna 2: Mes2
             * Columna 3: OBC Âá∫Â∫ìÂçï (Orden OBC)
             * Columna 4: IB
             * Columna 5: C√≥digo Ë¥ßÂè∑
             * Columna 12: Responsable
             * Columna 16: Estado/Estatus Áä∂ÊÄÅ (Columna Q)
             */
            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length >= 6) {
                    const obc = cols[3]?.trim();
                    if (obc && !cols[0]?.toLowerCase().includes('fecha')) {
                        if (!STATE.mneData.has(obc)) {
                            STATE.mneData.set(obc, []);
                        }
                        STATE.mneData.get(obc).push({
                            fecha: cols[0]?.trim() || '',
                            mes: cols[1]?.trim() || '',
                            obc: obc,
                            ib: cols[4]?.trim() || '',
                            codigo: cols[5]?.trim() || '',
                            responsable: cols[12]?.trim() || '',
                            estado: cols[16]?.trim() || 'üì¶ En proceso'
                        });
                    }
                }
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function updateBdInfo() {
            document.getElementById('bd-count').textContent = STATE.obcData.size;
            const updateTime = new Date().toLocaleTimeString();
            let timeText = updateTime;

            if (STATE.dateFilter.startDate && STATE.dateFilter.endDate) {
                const start = new Date(STATE.dateFilter.startDate).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                const end = new Date(STATE.dateFilter.endDate).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                timeText += `<br><small style="font-size: 0.85em;">üìÖ ${start} - ${end}</small>`;
            }

            document.getElementById('bd-update-time').innerHTML = timeText;
        }

        function refreshData() {
            loadAllData();
        }

        // ==================== SCAN PROCESSING (Algoritmo track.html) ====================
        function processScan() {
            const input = document.getElementById('scan-input');
            const rawCode = input.value.trim();

            if (!rawCode) {
                showNotification('‚ö†Ô∏è Ingresa un c√≥digo', 'warning');
                return;
            }

            if (STATE.obcData.size === 0) {
                showNotification('‚ö†Ô∏è Base de datos no cargada', 'warning');
                return;
            }

            console.log(`üîç Iniciando b√∫squeda para: "${rawCode}"`);

            // Extraer y normalizar c√≥digo
            const extracted = extractCode(rawCode);
            const normalized = normalizeCode(extracted);
            const baseCode = extractBaseCode(normalized);

            console.log(`üìä C√≥digos generados:
  Raw: "${rawCode}"
  Extracted: "${extracted}"
  Normalized: "${normalized}"
  Base: "${baseCode}"`);

            // ALGORITMO DE B√öSQUEDA MULTI-NIVEL (basado en track.html)
            let orderInfo = null;
            let matchType = 'none';
            let bestMatch = { order: null, similarity: 0 };

            // NIVEL 1: B√∫squeda exacta por n√∫mero de OBC
            const upperRaw = rawCode.toUpperCase().trim();
            orderInfo = STATE.obcData.get(upperRaw);
            if (orderInfo) {
                matchType = 'obc-exact';
                console.log(`‚úÖ NIVEL 1: Encontrado por n√∫mero OBC exacto: ${upperRaw}`);
            }

            // NIVEL 2: B√∫squeda exacta en customBarcode (Columna I)
            if (!orderInfo) {
                for (const [orden, data] of STATE.obcData.entries()) {
                    if (data.customBarcode) {
                        const dbNormalized = normalizeCode(data.customBarcode);

                        // Coincidencia exacta
                        if (dbNormalized === normalized) {
                            orderInfo = data;
                            matchType = 'barcode-exact';
                            console.log(`‚úÖ NIVEL 2: Coincidencia exacta en customBarcode: ${orden}`);
                            break;
                        }
                    }
                }
            }

            // NIVEL 3: B√∫squeda por c√≥digo base (sin sufijos)
            if (!orderInfo && baseCode && baseCode !== normalized) {
                for (const [orden, data] of STATE.obcData.entries()) {
                    if (data.customBarcode) {
                        const dbNormalized = normalizeCode(data.customBarcode);
                        const dbBaseCode = extractBaseCode(dbNormalized);

                        if (dbBaseCode === baseCode) {
                            orderInfo = data;
                            matchType = 'base-code';
                            console.log(`‚úÖ NIVEL 3: Coincidencia por c√≥digo base: ${orden} (${baseCode})`);
                            break;
                        }
                    }
                }
            }

            // NIVEL 4: B√∫squeda flexible en m√∫ltiples campos
            if (!orderInfo) {
                console.log('üîÑ NIVEL 4: B√∫squeda flexible en todos los campos...');

                for (const [orden, data] of STATE.obcData.entries()) {
                    let similarity = 0;

                    // Buscar en customBarcode
                    if (data.customBarcode) {
                        const sim = calculateFieldSimilarity(normalized, data.customBarcode);
                        similarity = Math.max(similarity, sim);
                    }

                    // Buscar en n√∫mero de orden
                    if (data.orden) {
                        const sim = calculateFieldSimilarity(normalized, data.orden);
                        similarity = Math.max(similarity, sim);
                    }

                    // Buscar en referenceNo
                    if (data.referenceNo) {
                        const sim = calculateFieldSimilarity(normalized, data.referenceNo);
                        similarity = Math.max(similarity, sim);
                    }

                    // Buscar en trackingCode
                    if (data.trackingCode) {
                        const sim = calculateFieldSimilarity(normalized, data.trackingCode);
                        similarity = Math.max(similarity, sim);
                    }

                    // Si encontramos alta similitud (>= 75%), considerarlo
                    if (similarity >= 75 && similarity > bestMatch.similarity) {
                        bestMatch = { order: data, similarity };
                    }
                }

                // Si encontramos coincidencia flexible
                if (bestMatch.order) {
                    orderInfo = bestMatch.order;
                    matchType = 'flexible';
                    console.log(`‚úÖ NIVEL 4: Coincidencia flexible (${bestMatch.similarity.toFixed(1)}%): ${orderInfo.orden}`);
                }
            }

            // Si no se encontr√≥ nada
            if (!orderInfo) {
                showNotification(`‚ùå C√≥digo/OBC no encontrado en BD: ${rawCode}`, 'error');
                console.log(`‚ùå No se encontr√≥ en ${STATE.obcData.size} √≥rdenes cargadas`);
                console.log(`üí° Tip: Verifica que el c√≥digo est√© en la columna "Custom box barcode" de OBC_BD`);
                return;
            }

            // Buscar en TRS
            const trsInfo = findTRSByCode(normalized);

            // Mostrar resultado con info de match
            console.log(`‚úÖ Orden encontrada: ${orderInfo.orden} (Tipo: ${matchType})`);
            showScanResult(rawCode, orderInfo, trsInfo);
            input.value = '';
        }

        /**
         * Extraer c√≥digo base (sin sufijos num√©ricos)
         * Ejemplo: "ABC123/456-001" ‚Üí "ABC123/456"
         */
        function extractBaseCode(code) {
            if (!code) return '';

            // Remover sufijos num√©ricos comunes al final
            // Patrones: -001, -01, /001, /01, _001, _01
            let base = code.replace(/[-\/_]\d{1,3}$/i, '');

            // Si el c√≥digo termina en n√∫meros despu√©s de letra, quitar n√∫meros finales
            // Ejemplo: XZH2510237543U002 ‚Üí XZH2510237543U
            base = base.replace(/([A-Z])\d+$/i, '$1');

            return base || code;
        }

        /**
         * Calcular similitud entre dos c√≥digos (versi√≥n simplificada de track.html)
         */
        function calculateFieldSimilarity(query, fieldValue) {
            if (!fieldValue) return 0;

            const normalized = normalizeCode(fieldValue);
            const queryNorm = normalizeCode(query);

            // Coincidencia exacta
            if (normalized === queryNorm) return 100;

            // Uno contiene al otro
            if (normalized.includes(queryNorm) || queryNorm.includes(normalized)) {
                const overlapRatio = Math.min(queryNorm.length, normalized.length) /
                                    Math.max(queryNorm.length, normalized.length);
                return overlapRatio * 100;
            }

            // Similitud de Levenshtein (simple)
            return calculateLevenshteinSimilarity(queryNorm, normalized);
        }

        /**
         * Calcular similitud usando distancia de Levenshtein
         */
        function calculateLevenshteinSimilarity(s1, s2) {
            const len1 = s1.length;
            const len2 = s2.length;
            const matrix = [];

            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j - 1] + cost
                    );
                }
            }

            const distance = matrix[len1][len2];
            const maxLen = Math.max(len1, len2);
            return maxLen === 0 ? 100 : ((maxLen - distance) / maxLen) * 100;
        }

        function findTRSByCode(normalizedCode) {
            for (const trs of STATE.trsData) {
                const normalizedOriginal = normalizeCode(trs.codigoOriginal);
                const normalizedNuevo = normalizeCode(trs.codigoNuevo);

                if (normalizedOriginal === normalizedCode || normalizedNuevo === normalizedCode) {
                    return trs;
                }
            }
            return null;
        }

        /**
         * Extraer c√≥digo de barras del texto escaneado (como en validador.html)
         */
        function extractCode(raw) {
            if (raw === null || raw === undefined) return '';
            let code = String(raw).trim();

            // Remover caracteres invisibles
            code = code.replace(/[\u0000-\u001F\u007F-\u009F\u200B-\u200F\uFEFF]/g, '').trim();

            // Convertir *, & y - (entre n√∫meros) a /
            code = code.replace(/\*/g, '/');
            code = code.replace(/&/g, '/');
            code = code.replace(/(\d)-(\d)/g, '$1/$2');

            // Normalizar comillas
            code = code.replace(/[""¬´¬ª‚Äû‚Äü‚Äö‚Äõ''¬®]/g, '"');

            // Patrones de extracci√≥n (en orden de prioridad)
            const patterns = [
                // N√∫meros con slash: 123/456
                /([0-9]+\/[0-9]+)/,
                // Alfanum√©rico con slash: ABC/123
                /([A-Za-z0-9]{2,}\/[A-Za-z0-9\/\-\._:]{1,})/,
                // Tokens largos alfanum√©ricos
                /.*?([A-Za-z0-9]{6,}).*/,
                // N√∫meros largos
                /([0-9]{6,})/
            ];

            for (const p of patterns) {
                const m = code.match(p);
                if (m && m[1]) return m[1].trim();
            }

            return code.trim();
        }

        /**
         * Normalizar c√≥digo para comparaci√≥n (como en validador.html)
         */
        function normalizeCode(code) {
            if (!code) return '';

            return String(code)
                .replace(/&/g, '/')
                .replace(/-/g, '/')
                .toLowerCase()
                .trim();
        }

        function showScanResult(code, orderInfo, trsInfo) {
            STATE.currentScan = { code, orderInfo, trsInfo };

            // NO mostrar tarjetas resumen - ir directo al modal
            // Abrir modal de validaci√≥n
            openValidationModal();
        }

        function clearScan() {
            document.getElementById('scan-input').value = '';
            document.getElementById('result-cards').style.display = 'none';
            STATE.currentScan = null;
            document.getElementById('scan-input').focus();
        }

        // ==================== COPY FUNCTION (track.html) ====================
        function makeCopyable(text) {
            if (!text || text === '-') return text;
            const sanitized = String(text).replace(/'/g, "\\'");
            return `<span class="copyable">${text}<span class="copy-icon" onclick="event.stopPropagation(); copyToClipboard('${sanitized}', this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></span></span>`;
        }

        function copyToClipboard(text, iconElement) {
            if (!text || text === '-') return;

            navigator.clipboard.writeText(text).then(() => {
                iconElement.classList.add('copied');
                iconElement.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

                setTimeout(() => {
                    iconElement.classList.remove('copied');
                    iconElement.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
                }, 1500);

                showNotification('üìã Copiado al portapapeles', 'success');
            }).catch(err => {
                console.error('Error copiando:', err);
                showNotification('‚ùå Error al copiar', 'error');
            });
        }

        // ==================== VALIDATION MODAL (Estilo track.html) ====================
        function openValidationModal() {
            if (!STATE.currentScan) return;

            const { code, orderInfo, trsInfo } = STATE.currentScan;

            // Cantidad esperada (TODO: obtener real de BD)
            const expectedQty = 10;

            // Buscar datos de validaci√≥n de surtido (Val3)
            const val3Info = findVal3ByOrder(orderInfo.orden);

            // Buscar datos de rastreo (MNE)
            const mneInfo = findMNEByOrder(orderInfo.orden);

            // ===== KPI CARDS =====
            document.getElementById('kpi-orden').innerHTML = makeCopyable(orderInfo.orden);
            document.getElementById('kpi-orden-boxes').textContent = `${expectedQty} cajas`;

            document.getElementById('kpi-destino').textContent = orderInfo.recipient || 'Sin destino';
            document.getElementById('kpi-horario').textContent = `üìÖ ${orderInfo.expectedArrival || 'Sin fecha'}`;

            // KPI Validaci√≥n de Surtido
            if (val3Info) {
                const validatedCount = val3Info.validatedCount || 0;
                const totalCount = expectedQty;
                const percent = totalCount > 0 ? Math.min(100, Math.round((validatedCount / totalCount) * 100)) : 0;
                document.getElementById('kpi-validacion').textContent = `${percent}%`;
                document.getElementById('kpi-progress-bar').style.width = `${percent}%`;
            } else {
                document.getElementById('kpi-validacion').textContent = '0%';
                document.getElementById('kpi-progress-bar').style.width = '0%';
            }

            if (trsInfo) {
                document.getElementById('kpi-trs').innerHTML = makeCopyable(trsInfo.trs);
                document.getElementById('kpi-trs-match').textContent = '‚úÖ Detectado';
            } else {
                document.getElementById('kpi-trs').textContent = 'Sin TRS';
                document.getElementById('kpi-trs-match').textContent = '‚úÖ Sin cambios';
            }

            // KPI Rastreo
            if (mneInfo) {
                const shortTrack = orderInfo.trackingCode && orderInfo.trackingCode.length > 12 ? orderInfo.trackingCode.substring(0, 12) + '...' : orderInfo.trackingCode || 'REGISTRADA';
                document.getElementById('kpi-tracking').innerHTML = makeCopyable(shortTrack);
                document.getElementById('kpi-tracking-status').textContent = mneInfo.estado || 'üì¶ En proceso';
            } else {
                document.getElementById('kpi-tracking').textContent = 'Sin registro';
                document.getElementById('kpi-tracking-status').textContent = '‚ö†Ô∏è Sin rastreo';
            }

            // ===== TABLA HORIZONTAL OBC (con validaci√≥n integrada) =====
            const obcContainer = document.getElementById('obc-table-container');
            obcContainer.innerHTML = `
                <div style="overflow-x: auto; width: 100%;">
                    <table class="data-table" style="min-width: 900px; width: 100%;">
                        <thead>
                            <tr>
                                <th>N√∫mero Orden</th>
                                <th>Referencia</th>
                                <th>Destinatario</th>
                                <th>Fecha Esperada</th>
                                <th>C√≥digo Barras</th>
                                <th>Qty Esperada</th>
                                <th>Qty Despacho</th>
                                <th>Estatus</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>${makeCopyable(orderInfo.orden)}</code></td>
                                <td>${orderInfo.referenceNo || '-'}</td>
                                <td>${orderInfo.recipient || '-'}</td>
                                <td>${orderInfo.expectedArrival || '-'}</td>
                                <td><code>${makeCopyable(orderInfo.customBarcode || '-')}</code></td>
                                <td><strong style="color: var(--primary);">${expectedQty}</strong></td>
                                <td>
                                    <input type="number" id="modal-qty-dispatch" min="0" value="${expectedQty}"
                                           style="width: 80px; padding: 4px 8px; border: 2px solid #e5e7eb; border-radius: 4px;">
                                </td>
                                <td>
                                    <select id="modal-status-order" style="padding: 4px 8px; border: 2px solid #e5e7eb; border-radius: 4px;">
                                        <option value="OK">OK</option>
                                        <option value="Env√≠o Parcial">Parcial</option>
                                        <option value="Pendiente">Pendiente</option>
                                        <option value="Anormalidad">Anormalidad</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="text" id="modal-observaciones-obc" placeholder="Notas..."
                                           style="width: 150px; padding: 4px 8px; border: 2px solid #e5e7eb; border-radius: 4px;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // ===== TABLA HORIZONTAL TRS (con validaci√≥n integrada) - SIEMPRE PRESENTE =====
            const trsSection = document.getElementById('section-trs');
            const trsContainer = document.getElementById('trs-table-container');

            // Mostrar siempre la secci√≥n TRS, pero en forma compacta si no hay informaci√≥n
            trsSection.style.display = 'block';
            
            if (trsInfo) {
                // Versi√≥n completa cuando hay informaci√≥n TRS
                trsContainer.innerHTML = `
                    <div style="display: flex; align-items: center; padding: 8px 12px; background: #fff8e1; border-radius: 6px; margin-bottom: 12px; font-size: 0.9em;">
                        <span style="margin-right: 8px;">‚ö†Ô∏è</span>
                        <strong>Cambio de etiqueta detectado</strong>
                    </div>
                    <div style="overflow-x: auto; width: 100%;">
                        <table class="data-table" style="min-width: 800px; width: 100%;">
                            <thead>
                                <tr>
                                    <th>Orden TRS</th>
                                    <th>Ref</th>
                                    <th>C√≥digo Original</th>
                                    <th>C√≥digo Nuevo</th>
                                    <th>Estatus</th>
                                    <th>Notas</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>${makeCopyable(trsInfo.trs)}</code></td>
                                    <td>${trsInfo.referencia || '-'}</td>
                                    <td><code>${makeCopyable(trsInfo.codigoOriginal)}</code></td>
                                    <td><code style="color: var(--warning);">${makeCopyable(trsInfo.codigoNuevo)}</code></td>
                                    <td style="white-space: nowrap;">
                                        <select id="modal-status-trs" style="padding: 4px 6px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.9em; width: 100%;">
                                            <option value="Aplicado">Aplicado</option>
                                            <option value="Pendiente">Pendiente</option>
                                            <option value="No Aplica">No Aplica</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" id="modal-observaciones-trs" placeholder="Notas..."
                                               style="width: 100%; padding: 4px 6px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.9em;">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                // Versi√≥n compacta cuando NO hay informaci√≥n TRS
                trsContainer.innerHTML = `
                    <div style="display: flex; align-items: center; padding: 8px 12px; background: #f5f5f5; border-radius: 6px; margin-bottom: 12px; font-size: 0.9em;">
                        <span style="margin-right: 8px;">‚ÑπÔ∏è</span>
                        <span>Sin cambios de etiqueta para esta orden</span>
                    </div>
                `;
            }

            // ===== TABLA VALIDACI√ìN DE SURTIDO (Val3) =====
            const val3Section = document.getElementById('section-val3');
            const val3Container = document.getElementById('val3-table-container');
            if (val3Info && val3Info.records && val3Info.records.length > 0) {
                val3Section.style.display = 'block';
                val3Container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Usuario</th>
                                <th>C√≥digo</th>
                                <th>Ubicaci√≥n</th>
                                <th>% Validado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${val3Info.records.map(record => `
                                <tr>
                                    <td>${record.fecha || '-'}</td>
                                    <td>${record.hora || '-'}</td>
                                    <td>${record.usuario || '-'}</td>
                                    <td><code>${makeCopyable(record.codigo || '-')}</code></td>
                                    <td>${record.ubicacion || '-'}</td>
                                    <td><strong style="color: var(--success);">${val3Info.percent || 0}%</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                val3Section.style.display = 'none';
            }

            // ===== TABLA HORIZONTAL RASTREO (MNE) =====
            const rastreoSection = document.getElementById('section-rastreo');
            const rastreoContainer = document.getElementById('rastreo-table-container');
            if (mneInfo && mneInfo.records && mneInfo.records.length > 0) {
                rastreoSection.style.display = 'block';
                rastreoContainer.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Orden OBC</th>
                                <th>C√≥digo</th>
                                <th>Responsable</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${mneInfo.records.map(record => `
                                <tr>
                                    <td>${record.fecha || '-'}</td>
                                    <td><code>${makeCopyable(record.obc || '-')}</code></td>
                                    <td><code>${makeCopyable(record.codigo || '-')}</code></td>
                                    <td>${record.responsable || '-'}</td>
                                    <td><strong>${record.estado || 'üì¶ En proceso'}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                rastreoSection.style.display = 'none';
            }

            document.getElementById('validation-modal').classList.add('show');
        }

        // ===== BUSCAR EN BD VAL3 (Validaci√≥n de Surtido) =====
        function findVal3ByOrder(ordenOBC) {
            if (!ordenOBC || !STATE.validacionData.has(ordenOBC)) {
                return null;
            }

            const records = STATE.validacionData.get(ordenOBC);
            const validatedCount = records.length;

            // Calcular el porcentaje promedio si est√° disponible
            let totalPercent = 0;
            records.forEach(r => {
                const percent = parseFloat(r.porcentaje) || 0;
                totalPercent += percent;
            });
            const avgPercent = validatedCount > 0 ? Math.round(totalPercent / validatedCount) : 0;

            return {
                records: records,
                validatedCount: validatedCount,
                percent: avgPercent
            };
        }

        // ===== BUSCAR EN BD MNE (Rastreo) =====
        function findMNEByOrder(ordenOBC) {
            if (!ordenOBC || !STATE.mneData.has(ordenOBC)) {
                return null;
            }

            const records = STATE.mneData.get(ordenOBC);

            // Obtener el √∫ltimo registro (m√°s reciente)
            const lastRecord = records[records.length - 1];

            return {
                records: records,
                estado: lastRecord?.estado || 'üì¶ En proceso',
                codigo: lastRecord?.codigo || '',
                responsable: lastRecord?.responsable || ''
            };
        }

        // ===== NAVEGACI√ìN POR ANCLAS (Mejorada para abrir secciones) =====
        function jumpToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            // Buscar el content asociado a esta secci√≥n
            const contentId = sectionId + '-content';
            const content = document.getElementById(contentId);
            const toggle = document.getElementById(contentId.replace('-content', '-toggle'));

            // Si la secci√≥n est√° colapsada, expandirla
            if (content && content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + 'px';
                if (toggle) toggle.classList.remove('collapsed');
            }

            // Scroll suave a la secci√≥n
            setTimeout(() => {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // ===== TOGGLE DE SECCIONES =====
        function toggleSection(sectionId, event) {
            if (event) event.stopPropagation();
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId.replace('-content', '-toggle'));
            if (section && toggle) {
                const isShowing = !section.classList.contains('show');
                section.classList.toggle('show');
                toggle.style.transform = isShowing ? 'rotate(180deg)' : 'rotate(0)';
                
                // Save the state to localStorage
                const sectionName = sectionId.replace('-content', '');
                const sectionStates = JSON.parse(localStorage.getItem('sectionStates') || '{}');
                sectionStates[sectionName] = isShowing;
                localStorage.setItem('sectionStates', JSON.stringify(sectionStates));
            }
        }
        
        // Restore section states on page load
        function restoreSectionStates() {
            const sectionStates = JSON.parse(localStorage.getItem('sectionStates') || '{}');
            Object.entries(sectionStates).forEach(([sectionName, isExpanded]) => {
                const section = document.getElementById(`${sectionName}-content`);
                const toggle = document.getElementById(`${sectionName}-toggle`);
                if (section && toggle) {
                    if (isExpanded) {
                        section.classList.add('show');
                        toggle.style.transform = 'rotate(180deg)';
                    } else {
                        section.classList.remove('show');
                        toggle.style.transform = 'rotate(0)';
                    }
                }
            });
        }

        function closeValidationModal() {
            document.getElementById('validation-modal').classList.remove('show');
        }

        // Variable global para prevenir m√∫ltiples guardados
        let IS_SAVING = false;

        async function confirmValidation() {
            if (!STATE.currentScan) return;

            // PREVENIR GUARDADO M√öLTIPLE - Verificar si ya est√° guardando
            if (IS_SAVING) {
                showNotification('‚è≥ Ya se est√° procesando la validaci√≥n...', 'warning');
                return;
            }

            const { code, orderInfo, trsInfo } = STATE.currentScan;

            // Validar campos obligatorios (ahora est√°n en la tabla)
            const qtyDispatch = parseInt(document.getElementById('modal-qty-dispatch').value);
            const qtyExpected = 10; // TODO: obtener de BD
            const statusOrder = document.getElementById('modal-status-order').value;
            const statusQuality = 'Completado'; // Por defecto en despacho
            const operador = document.getElementById('modal-operador').value;
            const unidad = document.getElementById('modal-unidad').value;
            const observaciones = document.getElementById('modal-observaciones-obc')?.value || '';

            if (!qtyDispatch || qtyDispatch <= 0) {
                showNotification('‚ö†Ô∏è Ingresa cantidad a despachar', 'warning');
                return;
            }

            // Validar env√≠o parcial
            if (qtyDispatch < qtyExpected) {
                if (!confirm(`‚ö†Ô∏è ENV√çO PARCIAL\n\nEsperado: ${qtyExpected}\nA despachar: ${qtyDispatch}\n\n¬øConfirmar env√≠o parcial?`)) {
                    return;
                }
            }

            // Marcar como guardando y deshabilitar bot√≥n
            IS_SAVING = true;
            const confirmBtn = document.querySelector('.btn-success');
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.textContent = '‚è≥ Guardando...';
            }

            try {
                // Generar folio
                const folio = generateFolio();

                // Crear registro
                const now = new Date();
                const record = {
                    folio,
                    fecha: now.toISOString().slice(0, 10),
                    hora: now.toTimeString().slice(0, 8),
                    usuario: CURRENT_USER,
                    orden: orderInfo.orden,
                    destino: orderInfo.recipient || orderInfo.destino || '',
                    horario: orderInfo.trackingCode || orderInfo.horario || '',
                    codigo: code,
                    codigo2: trsInfo?.codigoNuevo || '',
                    estatus: statusOrder,
                    cambioEtiqueta: trsInfo ? 'S√ç' : 'NO',
                    estatus2: statusQuality,
                    incidencias: qtyDispatch < qtyExpected ? 'Env√≠o Parcial' : '',
                    operador: operador || '',
                    unidad: unidad || '',
                    observaciones,
                    qtyExpected,
                    qtyDispatch
                };

                console.log('Guardando registro de validaci√≥n:', record);

                // Agregar a validadas o pendientes
                if (statusOrder === 'OK' && statusQuality === 'Completado') {
                    STATE.validatedOrders.push(record);
                } else {
                    STATE.pendingOrders.push(record);
                }

                // Agregar a pending sync
                PENDING_SYNC.push(record);
                savePendingSync();
                updateSyncStatus();

                // Intentar sincronizar
                if (IS_ONLINE && gapi?.client?.getToken()) {
                    await syncData(false); // Sin mensajes para no molestar
                }

                showNotification('‚úÖ Validaci√≥n registrada correctamente', 'success');
                closeValidationModal();
                clearScan();
                updateUI();
            } catch (error) {
                console.error('Error al guardar validaci√≥n:', error);
                showNotification('‚ùå Error al guardar la validaci√≥n', 'error');
            } finally {
                // Siempre restablecer el estado
                IS_SAVING = false;
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '‚úÖ Confirmar Despacho';
                }
            }
        }

        function generateFolio() {
            const today = new Date();
            const dateStr = today.toISOString().slice(2, 10).replace(/-/g, '');
            const counter = STATE.folioCounter.toString().padStart(3, '0');
            STATE.folioCounter++;
            return `FE${dateStr}-${counter}`;
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            updateDaySummary();
            updatePanels();
        }

        function updateDaySummary() {
            // Usar √≥rdenes filtradas si hay filtro activo
            const totalOBC = STATE.dateFilter.active ? STATE.obcDataFiltered.size : 0;
            const validated = STATE.validatedOrders.length;
            const pending = STATE.dateFilter.active ? STATE.obcDataFiltered.size - validated : 0;
            const problems = STATE.pendingOrders.filter(o => o.estatus === 'Anormalidad').length;

            document.getElementById('summary-total').textContent = totalOBC;
            document.getElementById('summary-validated').textContent = validated;
            document.getElementById('summary-pending').textContent = pending;
            document.getElementById('summary-problems').textContent = problems;
        }

        function updatePanels() {
            // Panel de validadas: mostrar √≥rdenes validadas
            updateValidatedPanel();

            // Panel de pendientes: mostrar √≥rdenes OBC filtradas que NO han sido validadas
            updatePendingPanel();
        }

        function updateValidatedPanel() {
            const listEl = document.getElementById('validated-list');
            const countEl = document.getElementById('validated-count');
            const orders = STATE.validatedOrders;

            countEl.textContent = orders.length;

            if (orders.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                        <div>Sin validaciones</div>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = orders.map(order => `
                <div class="panel-item validated" data-order="${order.orden}">
                    <div class="panel-item-info">
                        <div class="panel-item-order">
                            ${order.orden}
                            ${order.cambioEtiqueta === 'S√ç' ? '<span class="badge warning">Etiqueta</span>' : ''}
                        </div>
                        <div class="panel-item-meta">
                            ${order.destino} ‚Ä¢ ${order.horario} ‚Ä¢ ${order.fecha} ${order.hora}
                        </div>
                        <div class="panel-item-meta">
                            ${order.estatus} ‚Ä¢ ${order.estatus2}
                            ${order.operador ? ` ‚Ä¢ üöõ ${order.operador}` : ''}
                        </div>
                    </div>
                    <div class="panel-item-actions">
                        <button class="btn-expand" onclick="showOrderDetails('${order.folio}', 'validated')">
                            üìã Ver
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updatePendingPanel() {
            const listEl = document.getElementById('pending-list');
            const countEl = document.getElementById('pending-count');

            if (!STATE.dateFilter.active || STATE.obcDataFiltered.size === 0) {
                countEl.textContent = '0';
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                        <div>Selecciona un rango de fechas para ver √≥rdenes pendientes</div>
                    </div>
                `;
                return;
            }

            // Obtener OBC validadas
            const validatedOBCs = new Set(STATE.validatedOrders.map(o => o.orden));

            // Filtrar √≥rdenes pendientes (no validadas)
            const pendingOrders = Array.from(STATE.obcDataFiltered.values())
                .filter(order => !validatedOBCs.has(order.orden));

            countEl.textContent = pendingOrders.length;

            if (pendingOrders.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">‚úÖ</div>
                        <div>Todas las √≥rdenes del periodo han sido validadas</div>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = pendingOrders.map(order => `
                <div class="panel-item pending" data-order="${order.orden}">
                    <div class="panel-item-info">
                        <div class="panel-item-order">
                            ${order.orden}
                        </div>
                        <div class="panel-item-meta">
                            üë§ ${order.recipient || 'Sin destinatario'} ‚Ä¢
                            üì¶ ${order.shippingService || 'Sin servicio'} ‚Ä¢
                            üïê ${order.expectedArrival || 'Sin fecha'}
                        </div>
                        <div class="panel-item-meta">
                            üìã Ref: ${order.referenceNo || '-'} ‚Ä¢
                            üî¢ Tracking: ${order.trackingCode || '-'}
                        </div>
                    </div>
                    <div class="panel-item-actions">
                        <button class="btn-expand" onclick="showOBCDetails('${order.orden}')">
                            üìã Ver
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showOBCDetails(ordenOBC) {
            const order = STATE.obcDataFiltered.get(ordenOBC) || STATE.obcData.get(ordenOBC);

            if (!order) return;

            const details = `
üì¶ DETALLE DE ORDEN OBC

Orden: ${order.orden}
Destinatario: ${order.recipient || '-'}
Servicio: ${order.shippingService || '-'}
Tracking: ${order.trackingCode || '-'}
Fecha Esperada: ${order.expectedArrival || '-'}
Referencia: ${order.referenceNo || '-'}
Tipo de Caja: ${order.boxType || '-'}
C√≥digo de Barras: ${order.customBarcode || '-'}
Observaciones: ${order.remark || '-'}
            `.trim();

            alert(details);
        }

        function filterPanel(type) {
            const searchTerm = document.getElementById(`filter-${type}`).value.toLowerCase();
            const items = document.querySelectorAll(`#${type}-list .panel-item`);

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function sortPanel(type) {
            const sortBy = document.getElementById(`sort-${type}`).value;
            const orders = type === 'validated' ? STATE.validatedOrders : STATE.pendingOrders;

            orders.sort((a, b) => {
                switch(sortBy) {
                    case 'recent':
                        return new Date(`${b.fecha} ${b.hora}`) - new Date(`${a.fecha} ${a.hora}`);
                    case 'order':
                        return a.orden.localeCompare(b.orden);
                    case 'destino':
                        return a.destino.localeCompare(b.destino);
                    case 'horario':
                        return a.horario.localeCompare(b.horario);
                    default:
                        return 0;
                }
            });

            updatePanel(type, orders);
        }

        function showOrderDetails(folio, type) {
            const orders = type === 'validated' ? STATE.validatedOrders : STATE.pendingOrders;
            const order = orders.find(o => o.folio === folio);

            if (!order) return;

            alert(`üìã DETALLE DE ORDEN\n\nFolio: ${order.folio}\nOrden: ${order.orden}\nDestino: ${order.destino}\nHorario: ${order.horario}\nC√≥digo: ${order.codigo}\n${order.codigo2 ? `C√≥digo 2: ${order.codigo2}\n` : ''}Estatus: ${order.estatus}\nControl Calidad: ${order.estatus2}\nOperador: ${order.operador || '-'}\nUnidad: ${order.unidad || '-'}\nObservaciones: ${order.observaciones || '-'}`);
        }

        // ==================== SYNC (Patr√≥n validador.html) ====================
        /**
         * Escribir un registro individual a Google Sheets
         */
        async function writeToSheets(log) {
            // Estructura de columnas para BD de Despacho:
            // Folio, Fecha, Hora, Usuario, Orden, Destino, Horario, Codigo, Codigo2,
            // Estatus, CambioEtiqueta, Estatus2, Incidencias, Operador, Unidad, Observaciones,
            // QtyExpected, QtyDispatch
            const values = [[
                log.folio,
                log.fecha,
                log.hora,
                log.usuario,
                log.orden,
                log.destino,
                log.horario,
                log.codigo,
                log.codigo2,
                log.estatus,
                log.cambioEtiqueta,
                log.estatus2,
                log.incidencias,
                log.operador,
                log.unidad,
                log.observaciones,
                log.qtyExpected,
                log.qtyDispatch
            ]];

            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                range: 'BD!A:R', // Hasta columna R (18 columnas)
                valueInputOption: 'USER_ENTERED',
                insertDataOption: 'INSERT_ROWS',
                resource: { values }
            });
        }

        // Constantes para la sincronizaci√≥n
        const MAX_SYNC_RETRIES = 3;
        const MAX_PENDING_ITEMS = 100;
        const MAX_SYNC_AGE_DAYS = 7;

        /**
         * Valida un √≠tem antes de sincronizar
         */
        function validateSyncItem(item) {
            if (!item) return false;
            
            const required = ['folio', 'fecha', 'usuario', 'orden'];
            const isValid = required.every(field => {
                const value = item[field];
                return value !== undefined && value !== null && String(value).trim() !== '';
            });
            
            if (!isValid) {
                console.warn('√çtem inv√°lido para sincronizar:', item);
            }
            
            return isValid;
        }

        /**
         * Limpia √≠tems antiguos o excedentes de la cola de sincronizaci√≥n
         */
        function cleanupSyncQueue() {
            if (!PENDING_SYNC.length) return;
            
            const now = new Date();
            const oneDayMs = 24 * 60 * 60 * 1000;
            
            // Filtrar √≠tems v√°lidos y no expirados
            PENDING_SYNC = PENDING_SYNC.filter(item => {
                // Validar estructura
                if (!validateSyncItem(item)) return false;
                
                // Verificar antig√ºedad
                const itemDate = new Date(item.timestamp || item.fecha || 0);
                const ageInDays = (now - itemDate) / oneDayMs;
                return ageInDays <= MAX_SYNC_AGE_DAYS;
            });
            
            // Limitar el n√∫mero total de √≠tems
            if (PENDING_SYNC.length > MAX_PENDING_ITEMS) {
                // Mantener los m√°s recientes
                PENDING_SYNC.sort((a, b) => {
                    const dateA = new Date(a.timestamp || a.fecha || 0);
                    const dateB = new Date(b.timestamp || b.fecha || 0);
                    return dateB - dateA;
                });
                PENDING_SYNC = PENDING_SYNC.slice(0, MAX_PENDING_ITEMS);
            }
            
            savePendingSync();
        }

        /**
         * Sincroniza un √≠tem con reintentos autom√°ticos
         */
        async function syncItemWithRetry(item, attempt = 1) {
            try {
                if (!validateSyncItem(item)) {
                    throw new Error('√çtem inv√°lido');
                }
                
                await writeToSheets(item);
                return { success: true };
            } catch (error) {
                if (attempt >= MAX_SYNC_RETRIES) {
                    console.error(`‚ùå Error despu√©s de ${attempt} intentos:`, item.folio, error);
                    return { 
                        success: false, 
                        error: error.message || 'Error desconocido',
                        item
                    };
                }
                
                // Espera exponencial antes de reintentar
                const delay = Math.min(1000 * Math.pow(2, attempt), 30000); // M√°ximo 30 segundos
                console.log(`Reintentando (${attempt}/${MAX_SYNC_RETRIES}) en ${delay}ms:`, item.folio);
                await new Promise(r => setTimeout(r, delay));
                
                return syncItemWithRetry(item, attempt + 1);
            }
        }

        /**
         * Sincroniza registros pendientes con manejo mejorado de errores
         */
        async function syncData(showMessages = true) {
            // Limpiar la cola antes de comenzar
            cleanupSyncQueue();
            
            if (PENDING_SYNC.length === 0) {
                if (showMessages) showNotification('‚úÖ Todo sincronizado', 'success');
                updateSyncStatus();
                return { success: true, synced: 0 };
            }

            if (!IS_ONLINE) {
                if (showMessages) showNotification('‚ö†Ô∏è Sin conexi√≥n a Internet', 'warning');
                updateSyncStatus();
                return { success: false, reason: 'offline' };
            }

            if (!gapi?.client?.getToken()) {
                if (showMessages) showNotification('‚ö†Ô∏è No conectado a Google Sheets', 'warning');
                updateSyncStatus();
                return { success: false, reason: 'no_token' };
            }

            const total = PENDING_SYNC.length;
            if (showMessages) showNotification(`üîÑ Sincronizando ${total} registros...`, 'info');

            const results = {
                success: 0,
                failed: 0,
                errors: []
            };

            // Procesar √≠tems en lotes peque√±os para mejor rendimiento
            const BATCH_SIZE = 5;
            for (let i = 0; i < PENDING_SYNC.length; i += BATCH_SIZE) {
                const batch = PENDING_SYNC.slice(i, i + BATCH_SIZE);
                const batchResults = await Promise.all(
                    batch.map(item => syncItemWithRetry(item))
                );

                // Actualizar contadores
                batchResults.forEach(result => {
                    if (result.success) {
                        results.success++;
                    } else {
                        results.failed++;
                        results.errors.push({
                            folio: result.item?.folio || 'desconocido',
                            error: result.error
                        });
                    }
                });

                // Actualizar UI peri√≥dicamente
                updateSyncStatus();
                if (showMessages && i + BATCH_SIZE < PENDING_SYNC.length) {
                    showNotification(
                        `üîÑ Procesando... ${Math.min(i + BATCH_SIZE, PENDING_SYNC.length)}/${total}`,
                        'info',
                        1500
                    );
                }

                // Peque√±a pausa entre lotes
                await new Promise(r => setTimeout(r, 300));
            }

            // Actualizar la cola de sincronizaci√≥n
            PENDING_SYNC = PENDING_SYNC.filter(item => 
                results.errors.some(err => err.folio === item.folio)
            );
            savePendingSync();
            updateSyncStatus();

            // Mostrar resumen
            if (results.failed === 0) {
                if (showMessages) {
                    showNotification(
                        `‚úÖ ${results.success} registros sincronizados correctamente`,
                        'success'
                    );
                }
            } else {
                console.warn('Errores de sincronizaci√≥n:', results.errors);
                if (showMessages) {
                    showNotification(
                        `‚ö†Ô∏è ${results.success} OK, ${results.failed} fallaron`,
                        'warning'
                    );
                }
            }

            return {
                success: results.failed === 0,
                synced: results.success,
                failed: results.failed,
                errors: results.errors
            };
        }

        function savePendingSync() {
            localStorage.setItem('desp_pending_sync', JSON.stringify(PENDING_SYNC));
        }

        function loadPendingSync() {
            try {
                const saved = localStorage.getItem('desp_pending_sync');
                if (saved) {
                    PENDING_SYNC = JSON.parse(saved);
                    console.log(`üì¶ Cargados ${PENDING_SYNC.length} registros pendientes de sincronizar`);
                    updateSyncStatus();
                }
            } catch (e) {
                console.error('Error cargando pending sync:', e);
            }
        }

        function updateSyncStatus() {
            const syncEl = document.getElementById('sync-status');
            if (!syncEl) return;

            if (!IS_ONLINE) {
                syncEl.className = 'sync-status sync-warning';
                syncEl.textContent = `‚ö†Ô∏è Sin conexi√≥n${PENDING_SYNC.length > 0 ? ` (${PENDING_SYNC.length})` : ''}`;
            } else if (PENDING_SYNC.length > 0) {
                syncEl.className = 'sync-status sync-warning';
                syncEl.textContent = `‚ö†Ô∏è ${PENDING_SYNC.length} pendientes`;
            } else {
                syncEl.className = 'sync-status sync-ok';
                syncEl.textContent = '‚úÖ Sincronizado';
            }
        }

        async function showSyncPanel() {
            const hasToken = gapi?.client?.getToken();
            const message = `üìä ESTADO DE SINCRONIZACI√ìN

Registros pendientes de sincronizar: ${PENDING_SYNC.length}
√ìrdenes validadas: ${STATE.validatedOrders.length}
√ìrdenes pendientes: ${STATE.pendingOrders.length}

Estado de conexi√≥n:
- Internet: ${IS_ONLINE ? '‚úÖ Conectado' : '‚ùå Sin conexi√≥n'}
- Google Sheets: ${hasToken ? '‚úÖ Autenticado' : '‚ùå No autenticado'}

${PENDING_SYNC.length > 0 ? '\n¬øDeseas sincronizar ahora?' : ''}`;

            if (PENDING_SYNC.length > 0 && confirm(message)) {
                await syncData(true);
            } else {
                alert(message);
            }
        }

        // ==================== MANUAL ORDER ====================
        function showManualOrderModal() {
            alert('üöß Funci√≥n en desarrollo');
        }

        // ==================== PRINT ====================
        function showPrintModal() {
            alert('üöß Funci√≥n de impresi√≥n en desarrollo');
        }

        // ==================== EXPORT ====================
        function exportData() {
            const allOrders = [...STATE.validatedOrders, ...STATE.pendingOrders];
            if (allOrders.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }

            const headers = ['Folio','Fecha','Hora','Usuario','Orden','Destino','Horario','C√≥digo','C√≥digo 2','Estatus','Cambio Etiqueta','Estatus 2','Incidencias','Operador','Unidad','Observaciones'];
            const rows = allOrders.map(r => [
                r.folio, r.fecha, r.hora, r.usuario, r.orden, r.destino,
                r.horario, r.codigo, r.codigo2, r.estatus, r.cambioEtiqueta,
                r.estatus2, r.incidencias, r.operador, r.unidad, r.observaciones
            ]);

            const csv = '\ufeff' + [
                headers.join(','),
                ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `despacho_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();

            showNotification('‚úÖ Datos exportados', 'success');
        }

        // ==================== UTILITIES ====================
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span style="margin-right: 8px;">${icons[type]}</span>${message}`;

            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }
    </script>
</body>
</html>
