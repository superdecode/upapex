<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö Sistema de Despacho Log√≠stico</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --info: #00BCD4;
            --bg: #f7f7f7;
            --text: #333;
            --card: #ffffff;
            --border: #e2e8f0;
            --gray: #6c757d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        /* MAIN LAYOUT */
        .main-container {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #555;
        }

        .sidebar-header h2 {
            color: var(--primary);
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.8em;
            color: #aaa;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }

        .sidebar-section-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .sidebar-btn:hover {
            transform: translateX(3px);
        }

        .sidebar-btn-primary {
            background: var(--primary);
            color: white;
        }

        .sidebar-btn-secondary {
            background: #555;
            color: white;
        }

        .sidebar-btn-success {
            background: var(--success);
            color: white;
        }

        /* Sync Status */
        .sync-status {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            cursor: pointer;
        }
        .sync-ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .sync-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }
        .sync-warning {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* User Footer */
        .user-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            color: white;
            cursor: pointer;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .connection-indicator {
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }

        .user-footer-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .user-footer-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.75em;
        }

        .bd-info {
            font-size: 0.7em;
            color: #aaa;
            text-align: center;
            line-height: 1.4;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.4em;
        }

        /* Resumen Cajas del D√≠a */
        .day-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .day-summary-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .day-summary-card.total { border-color: var(--primary); }
        .day-summary-card.validated { border-color: var(--success); }
        .day-summary-card.pending { border-color: var(--warning); }
        .day-summary-card.problems { border-color: var(--error); }

        .day-summary-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .day-summary-value {
            font-size: 2em;
            font-weight: 700;
        }

        /* Scan Section */
        .scan-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scan-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .scan-input-group {
            flex: 1;
        }

        .scan-input-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .scan-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.3em;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
        }

        .scan-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Result Cards (like track.html) */
        .result-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .result-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 3px solid;
        }

        .result-card-label {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 4px;
        }

        .result-card-value {
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Panels */
        .panels-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            min-height: 0;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .panel-title {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .panel-count {
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
        }

        .panel-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .panel-filter-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .panel-filter-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .panel-list {
            flex: 1;
            overflow-y: auto;
        }

        .panel-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-item.validated { border-color: var(--success); }
        .panel-item.pending { border-color: var(--warning); }

        .panel-item-info {
            flex: 1;
        }

        .panel-item-order {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .panel-item-meta {
            font-size: 0.75em;
            color: #666;
        }

        .panel-item-actions {
            display: flex;
            gap: 6px;
        }

        .btn-expand {
            padding: 6px 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-google { background: #4285F4; color: white; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        /* KPI Cards Header (Compactas estilo track.html) */
        .modal-kpi-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid var(--border);
        }

        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .kpi-card {
            padding: 10px 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 6px;
            border-left: 3px solid;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: all 0.2s;
            cursor: pointer;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        .kpi-card.orden { border-color: var(--primary); }
        .kpi-card.destino { border-color: var(--info); }
        .kpi-card.estatus { border-color: var(--success); }
        .kpi-card.trs { border-color: var(--warning); }
        .kpi-card.rastreo { border-color: #9333ea; }

        .kpi-card-label {
            font-size: 0.65em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .kpi-card-value {
            font-size: 1em;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 2px;
        }

        .kpi-card-subtitle {
            font-size: 0.7em;
            color: #888;
        }

        .kpi-progress {
            margin-top: 6px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .kpi-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, #22c55e 100%);
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Sections (estilo track.html) */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .section-header:hover {
            background: #e9ecef;
        }

        .section-title {
            font-size: 0.95em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text);
        }

        .section-toggle {
            color: #999;
            font-size: 0.9em;
            transition: transform 0.3s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .section-content.collapsed {
            max-height: 0;
        }

        /* Tabla de datos (estilo track.html) */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            background: white;
        }

        .data-table th {
            background: #f3f4f6;
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8em;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .data-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .data-table code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        /* Modal Body */
        .modal-body {
            padding: 20px 25px;
            flex: 1;
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .modal-section-title {
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .modal-field {
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .modal-field-label {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .modal-field-value {
            font-weight: 700;
            color: var(--text);
            font-size: 0.95em;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: #374151;
        }

        .modal-input-group input,
        .modal-input-group select,
        .modal-input-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        .modal-input-group input:focus,
        .modal-input-group select:focus,
        .modal-input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Modal Footer */
        .modal-footer {
            padding: 20px 25px;
            border-top: 2px solid var(--border);
            background: #f8f9fa;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .modal-footer-selectors {
            display: flex;
            gap: 12px;
            flex: 1;
        }

        .modal-footer-selectors select {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 6px;
        }

        .badge.success { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        .badge.warning { background: rgba(255, 152, 0, 0.15); color: var(--warning); }
        .badge.error { background: rgba(244, 67, 54, 0.15); color: var(--error); }
        .badge.info { background: rgba(0, 188, 212, 0.15); color: var(--info); }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .notification {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }

        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .hidden { display: none !important; }

        /* Welcome Screen */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .welcome-card {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .welcome-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        .welcome-title {
            font-size: 2em;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 30px;
        }

        .welcome-btn {
            padding: 16px 40px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }

        .welcome-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
        }

        /* Preloader */
        .preloader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .preloader-overlay.show { display: flex; }

        .preloader-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .preloader-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .preloader-text {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 10px;
        }

        .preloader-subtext {
            font-size: 0.9em;
            color: #666;
        }

        /* Date Filter Modal */
        .date-filter-modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 95%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .date-filter-header {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
            text-align: center;
        }

        .date-input-group {
            margin-bottom: 20px;
        }

        .date-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .date-input-group input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .date-input-group input[type="date"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .panels-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="notification-container" id="notifications"></div>

    <!-- LOGIN -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">üöö</div>
            <h1 class="login-title">Sistema de Despacho</h1>
            <p class="login-subtitle">Validaci√≥n y Control Log√≠stico</p>
            <button class="btn btn-google" style="width: 100%; padding: 15px; font-size: 1.1em;" onclick="handleLogin()">
                üîê Iniciar sesi√≥n con Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <div class="main-container">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>üöö Despacho</h2>
                    <p>Control Log√≠stico</p>
                </div>

                <div id="sync-status" class="sync-status sync-ok" onclick="showSyncPanel()">
                    ‚úÖ Sincronizado
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Acciones</div>
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showDateFilterModal()">
                        üìÖ Filtrar por Fecha
                    </button>
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showManualOrderModal()">
                        ‚ûï Orden Manual
                    </button>
                    <button class="sidebar-btn sidebar-btn-success" onclick="showPrintModal()">
                        üñ®Ô∏è Imprimir Listas
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="exportData()">
                        üì• Exportar
                    </button>
                </div>

                <div class="user-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar" onclick="changeUserAlias()">?</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name-display" onclick="changeUserAlias()">No conectado</div>
                            <div class="connection-indicator">
                                <div class="connection-dot" id="connection-dot"></div>
                                <span id="connection-text">Offline</span>
                            </div>
                        </div>
                    </div>
                    <div class="user-footer-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshData()">üîÑ BD</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleConnection()" id="sidebar-auth-btn">üîó</button>
                        <button class="btn btn-danger btn-small" onclick="handleLogout()">üö™</button>
                    </div>
                    <div class="bd-info">
                        <div><span id="bd-count">0</span> √≥rdenes cargadas</div>
                        <div id="bd-update-time">Sin actualizar</div>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- Empty Dashboard (shown initially) -->
                <div id="empty-dashboard" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
                    <div style="font-size: 5em; margin-bottom: 20px;">üöö</div>
                    <h2 style="font-size: 1.8em; color: var(--text); margin-bottom: 10px;">Sistema de Despacho</h2>
                    <p style="font-size: 1.1em; color: #666; margin-bottom: 30px;">Bienvenido al sistema de validaci√≥n log√≠stica</p>
                    <button class="btn btn-primary" onclick="showDateFilterModal()" style="padding: 16px 40px; font-size: 1.2em;">
                        üöÄ Iniciar Validaci√≥n
                    </button>
                </div>

                <!-- Validation Content (shown after selecting date range) -->
                <div id="validation-content" style="display: none; height: 100%; display: flex; flex-direction: column;">
                    <!-- Header -->
                    <div class="header">
                        <h1>üì¶ Validaci√≥n de Despacho</h1>
                    </div>

                    <!-- Resumen del D√≠a -->
                <div class="day-summary">
                    <div class="day-summary-card total">
                        <div class="day-summary-label">Total √ìrdenes</div>
                        <div class="day-summary-value" id="summary-total">0</div>
                    </div>
                    <div class="day-summary-card validated">
                        <div class="day-summary-label">Validadas</div>
                        <div class="day-summary-value" id="summary-validated">0</div>
                    </div>
                    <div class="day-summary-card pending">
                        <div class="day-summary-label">Pendientes</div>
                        <div class="day-summary-value" id="summary-pending">0</div>
                    </div>
                    <div class="day-summary-card problems">
                        <div class="day-summary-label">Con Problemas</div>
                        <div class="day-summary-value" id="summary-problems">0</div>
                    </div>
                </div>

                <!-- Scan Section -->
                <div class="scan-section">
                    <div class="scan-row">
                        <div class="scan-input-group">
                            <label>üîç Buscar por C√≥digo de Barras o N√∫mero de OBC</label>
                            <input type="text" class="scan-input" id="scan-input" placeholder="Escanea c√≥digo o ingresa OBC..." autocomplete="off">
                        </div>
                        <button class="btn btn-primary" onclick="processScan()">üîç Buscar</button>
                        <button class="btn btn-secondary" onclick="clearScan()">üóëÔ∏è Limpiar</button>
                    </div>
                </div>

                <!-- Result Cards (Cabeceras Resumen) -->
                <div class="result-cards" id="result-cards" style="display: none;">
                    <!-- Se generan din√°micamente -->
                </div>

                <!-- Panels: Validadas | Pendientes -->
                <div class="panels-container">
                    <!-- Panel Validadas -->
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">
                                ‚úÖ Validadas
                                <span class="panel-count" style="background: rgba(76, 175, 80, 0.15); color: var(--success);" id="validated-count">0</span>
                            </span>
                        </div>
                        <div class="panel-filters">
                            <input type="text" class="panel-filter-input" id="filter-validated" placeholder="üîç Buscar..." oninput="filterPanel('validated')">
                            <select class="panel-filter-select" id="sort-validated" onchange="sortPanel('validated')">
                                <option value="recent">M√°s recientes</option>
                                <option value="order">Por orden</option>
                                <option value="destino">Por destino</option>
                                <option value="horario">Por horario</option>
                            </select>
                        </div>
                        <div class="panel-list" id="validated-list">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                                <div>Sin validaciones</div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Pendientes -->
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">
                                ‚è≥ Pendientes
                                <span class="panel-count" style="background: rgba(255, 152, 0, 0.15); color: var(--warning);" id="pending-count">0</span>
                            </span>
                        </div>
                        <div class="panel-filters">
                            <input type="text" class="panel-filter-input" id="filter-pending" placeholder="üîç Buscar..." oninput="filterPanel('pending')">
                            <select class="panel-filter-select" id="sort-pending" onchange="sortPanel('pending')">
                                <option value="recent">M√°s recientes</option>
                                <option value="order">Por orden</option>
                                <option value="destino">Por destino</option>
                                <option value="horario">Por horario</option>
                            </select>
                        </div>
                        <div class="panel-list" id="pending-list">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                                <div>Sin pendientes</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                <!-- End validation-content -->
            </div>
        </div>
    </div>

    <!-- DATE FILTER MODAL -->
    <div class="modal-overlay" id="date-filter-modal">
        <div class="date-filter-modal">
            <div class="date-filter-header">üìÖ Filtro Temporal</div>
            <p style="text-align: center; color: #666; margin-bottom: 25px;">
                Selecciona el rango de fechas para cargar las √≥rdenes
            </p>
            <div class="date-input-group">
                <label>üìÜ Fecha Inicial</label>
                <input type="date" id="date-start" required>
            </div>
            <div class="date-input-group">
                <label>üìÜ Fecha Final</label>
                <input type="date" id="date-end" required>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyDateFilter()" style="flex: 1;">
                    ‚úÖ Aplicar Filtro
                </button>
                <button class="btn btn-warning" onclick="clearDateFilterAndClose()">
                    üîÑ Quitar Filtro
                </button>
                <button class="btn btn-secondary" onclick="closeDateFilterModal()">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- PRELOADER -->
    <div class="preloader-overlay" id="preloader">
        <div class="preloader-content">
            <div class="preloader-spinner"></div>
            <div class="preloader-text" id="preloader-text">Conectando con Google Sheets...</div>
            <div class="preloader-subtext" id="preloader-subtext">Por favor espera un momento</div>
        </div>
    </div>

    <!-- VALIDATION MODAL -->
    <div class="modal-overlay" id="validation-modal">
        <div class="modal-content">
            <!-- HEADER -->
            <div class="modal-header">
                <div class="modal-title">üì¶ Validaci√≥n de Despacho</div>
                <button class="modal-close" onclick="closeValidationModal()">√ó</button>
            </div>

            <!-- KPI CARDS HEADER (Compactas con navegaci√≥n) -->
            <div class="modal-kpi-header">
                <div class="kpi-cards">
                    <!-- KPI 1: Orden (OBC) -->
                    <div class="kpi-card orden" onclick="jumpToSection('section-obc')">
                        <div class="kpi-card-label">üì¶ Orden OBC</div>
                        <div class="kpi-card-value" id="kpi-orden">-</div>
                        <div class="kpi-card-subtitle" id="kpi-orden-boxes">-</div>
                    </div>

                    <!-- KPI 2: Destino y Horario -->
                    <div class="kpi-card destino" onclick="jumpToSection('section-obc')">
                        <div class="kpi-card-label">üåç Destino</div>
                        <div class="kpi-card-value" id="kpi-destino">-</div>
                        <div class="kpi-card-subtitle" id="kpi-horario">-</div>
                    </div>

                    <!-- KPI 3: Estatus de Validaci√≥n -->
                    <div class="kpi-card estatus" onclick="jumpToSection('section-validacion')">
                        <div class="kpi-card-label">‚úÖ Validaci√≥n</div>
                        <div class="kpi-card-value" id="kpi-validacion">0%</div>
                        <div class="kpi-progress">
                            <div class="kpi-progress-bar" id="kpi-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- KPI 4: Orden TRS -->
                    <div class="kpi-card trs" onclick="jumpToSection('section-trs')">
                        <div class="kpi-card-label">üîÑ Orden TRS</div>
                        <div class="kpi-card-value" id="kpi-trs">-</div>
                        <div class="kpi-card-subtitle" id="kpi-trs-match">-</div>
                    </div>

                    <!-- KPI 5: Rastreo -->
                    <div class="kpi-card rastreo" onclick="jumpToSection('section-rastreo')">
                        <div class="kpi-card-label">üìç Rastreo</div>
                        <div class="kpi-card-value" id="kpi-tracking">-</div>
                        <div class="kpi-card-subtitle" id="kpi-tracking-status">-</div>
                    </div>
                </div>
            </div>

            <!-- MODAL BODY (Estilo track.html) -->
            <div class="modal-body">
                <!-- Secci√≥n 1: Detalle OBC -->
                <div id="section-obc" style="scroll-margin-top: 20px;">
                    <div class="section-header" onclick="toggleSection('section-obc-content')">
                        <div class="section-title">
                            üì¶ Orden OBC
                        </div>
                        <span class="section-toggle" id="section-obc-toggle">‚ñº</span>
                    </div>
                    <div class="section-content" id="section-obc-content">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Campo</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="obc-table-body">
                                <!-- Se genera din√°micamente -->
                            </tbody>
                        </table>
                        <div class="modal-input-group" style="margin-top: 15px;">
                            <label>Cantidad a Despachar <span style="color: var(--error);">*</span></label>
                            <input type="number" id="modal-qty-dispatch" min="0" placeholder="Ingresa cantidad...">
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 2: TRS (Cambio de Etiqueta) -->
                <div id="section-trs" style="scroll-margin-top: 20px; margin-top: 15px;">
                    <div class="section-header" onclick="toggleSection('section-trs-content')">
                        <div class="section-title">
                            üîÑ Orden TRS
                        </div>
                        <span class="section-toggle" id="section-trs-toggle">‚ñº</span>
                    </div>
                    <div class="section-content" id="section-trs-content">
                        <div id="trs-table-container">
                            <!-- Se genera din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 3: Validaci√≥n -->
                <div id="section-validacion" style="scroll-margin-top: 20px; margin-top: 15px;">
                    <div class="section-header" onclick="toggleSection('section-validacion-content')">
                        <div class="section-title">
                            ‚úÖ Validaci√≥n
                        </div>
                        <span class="section-toggle" id="section-validacion-toggle">‚ñº</span>
                    </div>
                    <div class="section-content" id="section-validacion-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <div class="modal-input-group">
                                <label>Estatus de Orden</label>
                                <select id="modal-status-order">
                                    <option value="OK">OK - Completa</option>
                                    <option value="Env√≠o Parcial">Env√≠o Parcial</option>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Anormalidad">Anormalidad</option>
                                </select>
                            </div>
                            <div class="modal-input-group">
                                <label>Control de Calidad</label>
                                <select id="modal-status-quality">
                                    <option value="Completado">Completado</option>
                                    <option value="Pendiente">Pendiente</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-input-group">
                            <label>Observaciones/Incidencias</label>
                            <textarea id="modal-observaciones" rows="3" placeholder="Notas adicionales..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 4: Rastreo -->
                <div id="section-rastreo" style="scroll-margin-top: 20px; margin-top: 15px; display: none;">
                    <div class="section-header" onclick="toggleSection('section-rastreo-content')">
                        <div class="section-title">
                            üìç Rastreo de Cajas
                        </div>
                        <span class="section-toggle" id="section-rastreo-toggle">‚ñº</span>
                    </div>
                    <div class="section-content" id="section-rastreo-content">
                        <div id="rastreo-table-container">
                            <!-- Se genera din√°micamente si hay tracking -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
                <div class="modal-footer-selectors">
                    <select id="modal-operador">
                        <option value="">üë§ Conductor...</option>
                    </select>
                    <select id="modal-unidad">
                        <option value="">üöõ Unidad/Placas...</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-success" onclick="confirmValidation()">
                        ‚úÖ Confirmar Despacho
                    </button>
                    <button class="btn btn-secondary" onclick="closeValidationModal()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            CLIENT_ID: '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile',
            SPREADSHEET_WRITE: '1T_yXd4MFyp-Ks2iTTr0KAd12QhXjW2eUMVqnAx8XSJM',
            SOURCES: {
                BD_STOCK: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-HG8HPf-94Ki5Leo5iEF5pyqsiD9CVk-mcl-F8BAw34kT0s3nzNn532YTYDCtkG76NbauiVx0Ffmd/pub?output=csv',
                OBC_BD: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSdSDQ8ktYA3YAsWMUokYd_S6_rANUz8XdfEAjsV-v0eAlfiYZctHuj3hP4m3wOghf4rnT_YvuA4BPA/pub?output=csv',
                VALIDACION: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZMZZCDtTFCebvsme1GMEBiZ1S2Cloh37AR8hHFAwhFPNEMD27G04bzX0theCMJE-nlYOyH2ev115q/pub?output=csv',
                MNE: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHzXpt4q7KYo8QMnrO92LGcXQbx14lBCQ0wxHGHm2Lz4v5RCJCpQHmS0NhUTHUCCG2Hc1bkvTYhdpz/pub?gid=883314398&single=true&output=csv',
                TRS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2NOvCCzIW0IS9ANzOYl7GKBq5I-XQM9e_V1tu_2VrDMq4Frgjol5uj6-4dBgEQcfB8b-k6ovaOJGc/pub?output=csv',
                LISTAS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTmbzg922y1KMVnV0JqBijR43Ma8e5X_AO2KVzjHBnRtGBx-0aXLZ8UUlKCO_XHOpV1qfggQyNjtqde/pub?gid=799838428&single=true&output=csv'
            }
        };

        // ==================== STATE ====================
        let STATE = {
            obcData: new Map(), // TODA la BD OBC (sin filtro)
            obcDataFiltered: new Map(), // Solo las √≥rdenes del rango de fechas seleccionado
            validacionData: new Map(),
            mneData: new Map(),
            trsData: [],
            operadores: [],
            unidades: [],
            validatedOrders: [],
            pendingOrders: [],
            currentScan: null,
            folioCounter: 1,
            dateFilter: {
                startDate: null,
                endDate: null,
                active: false // Indica si hay un filtro activo
            }
        };

        let CURRENT_USER = '';
        let USER_EMAIL = '';
        let USER_GOOGLE_NAME = '';
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];
        let TOKEN_CLIENT = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadPendingSync(); // Cargar registros pendientes de localStorage
            setupConnectionMonitoring(); // Monitorear conexi√≥n a internet
            gapi.load('client', initGAPI);
        });

        function setupConnectionMonitoring() {
            // Actualizar IS_ONLINE cuando cambie la conectividad
            window.addEventListener('online', () => {
                IS_ONLINE = true;
                updateSyncStatus();
                updateConnectionIndicator();
                showNotification('üåê Conexi√≥n restaurada', 'success');
                // Intentar sincronizar autom√°ticamente
                if (gapi?.client?.getToken() && PENDING_SYNC.length > 0) {
                    syncData(false);
                }
            });

            window.addEventListener('offline', () => {
                IS_ONLINE = false;
                updateSyncStatus();
                updateConnectionIndicator();
                showNotification('‚ö†Ô∏è Sin conexi√≥n a Internet', 'warning');
            });

            // Inicializar indicador
            updateConnectionIndicator();
        }

        function updateConnectionIndicator() {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');

            if (!dot || !text) return;

            if (IS_ONLINE && gapi?.client?.getToken()) {
                dot.className = 'connection-dot online';
                text.textContent = 'Online';
            } else if (IS_ONLINE) {
                dot.className = 'connection-dot offline';
                text.textContent = 'No autenticado';
            } else {
                dot.className = 'connection-dot offline';
                text.textContent = 'Offline';
            }
        }

        function setupEventListeners() {
            const scanInput = document.getElementById('scan-input');
            scanInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && scanInput.value.trim()) {
                    e.preventDefault();
                    processScan();
                }
            });
        }

        async function initGAPI() {
            try {
                await gapi.client.init({
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
                });
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: handleAuthCallback,
                    error_callback: (error) => {
                        hidePreloader();
                        if (error.type !== 'popup_closed') {
                            showNotification('‚ùå Error de autenticaci√≥n: ' + error.message, 'error');
                        } else {
                            showNotification('‚ö†Ô∏è Autenticaci√≥n cancelada', 'warning');
                        }
                    }
                });
            } catch (e) {
                hidePreloader();
                showNotification('Error inicializando API', 'error');
            }
        }

        async function handleAuthCallback(response) {
            if (response?.access_token) {
                gapi.client.setToken(response);
                showPreloader('Cargando base de datos...', 'Obteniendo informaci√≥n del sistema');
                await getUserProfile();
                await loadAllData(); // Carga TODA la BD sin filtro
                hidePreloader();
                updateConnectionIndicator();
                updateSyncStatus();
                showNotification('‚úÖ Conexi√≥n exitosa - BD cargada completa', 'success');
                showApp();

                // Si hay registros pendientes, intentar sincronizar
                if (PENDING_SYNC.length > 0) {
                    setTimeout(() => syncData(true), 1000);
                }
            }
        }

        function handleLogin() {
            showPreloader('Conectando con Google Sheets...', 'Por favor autoriza el acceso en la ventana emergente');
            TOKEN_CLIENT?.requestAccessToken();
        }

        async function getUserProfile() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` }
                });
                const data = await response.json();
                USER_EMAIL = data.email || '';
                USER_GOOGLE_NAME = data.name || 'Usuario';

                const savedAlias = localStorage.getItem(`desp_alias_${USER_EMAIL}`);
                if (savedAlias) {
                    CURRENT_USER = savedAlias;
                } else {
                    CURRENT_USER = USER_GOOGLE_NAME;
                    localStorage.setItem(`desp_alias_${USER_EMAIL}`, USER_GOOGLE_NAME);
                }
                updateUserFooter();
            } catch (e) {
                CURRENT_USER = 'Usuario';
            }
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

            // Mostrar dashboard vac√≠o al inicio
            document.getElementById('empty-dashboard').style.display = 'flex';
            document.getElementById('validation-content').style.display = 'none';

            updateUI();
        }

        function handleLogout() {
            if (gapi.client.getToken()) {
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                gapi.client.setToken(null);
            }
            location.reload();
        }

        // ==================== DATE FILTER MODAL ====================
        function showDateFilterModal() {
            // Set default dates based on current filter or defaults
            const today = new Date();
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 7);

            // If filter is already set, use those dates
            if (STATE.dateFilter.startDate && STATE.dateFilter.endDate) {
                document.getElementById('date-start').value = STATE.dateFilter.startDate;
                document.getElementById('date-end').value = STATE.dateFilter.endDate;
            } else {
                document.getElementById('date-start').value = today.toISOString().slice(0, 10);
                document.getElementById('date-end').value = endDate.toISOString().slice(0, 10);
            }

            document.getElementById('date-filter-modal').classList.add('show');
        }

        function closeDateFilterModal() {
            document.getElementById('date-filter-modal').classList.remove('show');
        }

        async function applyDateFilter() {
            const startDate = document.getElementById('date-start').value;
            const endDate = document.getElementById('date-end').value;

            if (!startDate || !endDate) {
                showNotification('‚ö†Ô∏è Por favor selecciona ambas fechas', 'warning');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showNotification('‚ö†Ô∏è La fecha inicial debe ser menor o igual a la fecha final', 'warning');
                return;
            }

            // Save date filter
            STATE.dateFilter.startDate = startDate;
            STATE.dateFilter.endDate = endDate;
            STATE.dateFilter.active = true;

            closeDateFilterModal();

            // Filtrar las √≥rdenes cargadas por el rango de fechas
            showPreloader('Filtrando √≥rdenes...', 'Seleccionando √≥rdenes del periodo');
            filterOrdersByDateRange();
            hidePreloader();

            // Mostrar contenido de validaci√≥n y ocultar dashboard vac√≠o
            document.getElementById('empty-dashboard').style.display = 'none';
            document.getElementById('validation-content').style.display = 'flex';

            // Focus en el input de escaneo
            setTimeout(() => {
                document.getElementById('scan-input')?.focus();
            }, 100);

            // Show notification about the selected range
            const start = new Date(startDate).toLocaleDateString('es-ES');
            const end = new Date(endDate).toLocaleDateString('es-ES');
            const count = STATE.obcDataFiltered.size;
            showNotification(`üìÖ Filtro aplicado: ${start} - ${end} (${count} √≥rdenes)`, 'success');

            updateUI();
        }

        function filterOrdersByDateRange() {
            STATE.obcDataFiltered.clear();

            const startDate = new Date(STATE.dateFilter.startDate);
            const endDate = new Date(STATE.dateFilter.endDate);
            endDate.setHours(23, 59, 59, 999); // Include full end date

            // Filtrar √≥rdenes por fecha
            for (const [orden, data] of STATE.obcData.entries()) {
                if (data.expectedArrival) {
                    const orderDate = parseOrderDate(data.expectedArrival);
                    if (orderDate && orderDate >= startDate && orderDate <= endDate) {
                        STATE.obcDataFiltered.set(orden, data);
                    }
                }
            }

            console.log(`Filtradas ${STATE.obcDataFiltered.size} √≥rdenes de ${STATE.obcData.size} totales`);
        }

        async function clearDateFilterAndClose() {
            STATE.dateFilter.startDate = null;
            STATE.dateFilter.endDate = null;
            STATE.dateFilter.active = false;
            STATE.obcDataFiltered.clear();

            closeDateFilterModal();

            // Volver al dashboard vac√≠o
            document.getElementById('validation-content').style.display = 'none';
            document.getElementById('empty-dashboard').style.display = 'flex';

            showNotification('üîÑ Filtro removido - Volviendo al dashboard', 'info');
        }

        // ==================== PRELOADER ====================
        function showPreloader(text = 'Cargando...', subtext = 'Por favor espera') {
            document.getElementById('preloader-text').textContent = text;
            document.getElementById('preloader-subtext').textContent = subtext;
            document.getElementById('preloader').classList.add('show');
        }

        function hidePreloader() {
            document.getElementById('preloader').classList.remove('show');
        }

        function changeUserAlias() {
            const newAlias = prompt('Ingresa tu nombre:', CURRENT_USER);
            if (newAlias && newAlias.trim()) {
                CURRENT_USER = newAlias.trim();
                localStorage.setItem(`desp_alias_${USER_EMAIL}`, CURRENT_USER);
                updateUserFooter();
            }
        }

        function updateUserFooter() {
            const avatar = document.getElementById('user-avatar');
            const nameDisplay = document.getElementById('user-name-display');

            if (avatar) {
                avatar.textContent = CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : '?';
            }
            if (nameDisplay) {
                nameDisplay.textContent = CURRENT_USER || 'No conectado';
            }
        }

        function toggleConnection() {
            if (gapi?.client?.getToken()) {
                if (confirm('¬øDesconectar?')) {
                    google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                    gapi.client.setToken(null);
                    location.reload();
                }
            } else {
                handleLogin();
            }
        }

        // ==================== DATA LOADING ====================
        async function loadAllData() {
            showNotification('üîÑ Cargando datos...', 'info');

            try {
                // Load OBC_BD
                const obcResponse = await fetch(CONFIG.SOURCES.OBC_BD);
                const obcCsv = await obcResponse.text();
                parseOBCData(obcCsv);

                // Load LISTAS (Operadores y Unidades)
                const listasResponse = await fetch(CONFIG.SOURCES.LISTAS);
                const listasCsv = await listasResponse.text();
                parseListasData(listasCsv);

                // Load TRS
                const trsResponse = await fetch(CONFIG.SOURCES.TRS);
                const trsCsv = await trsResponse.text();
                parseTRSData(trsCsv);

                // Show notification with date range if filtered
                let message = `‚úÖ ${STATE.obcData.size} √≥rdenes cargadas`;
                if (STATE.dateFilter.startDate && STATE.dateFilter.endDate) {
                    const start = new Date(STATE.dateFilter.startDate).toLocaleDateString('es-ES');
                    const end = new Date(STATE.dateFilter.endDate).toLocaleDateString('es-ES');
                    message += ` (${start} - ${end})`;
                }
                showNotification(message, 'success');
                updateBdInfo();
            } catch (e) {
                showNotification('‚ùå Error cargando datos', 'error');
            }
        }

        function parseOBCData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.obcData.clear(); // Limpiar TODA la BD

            /**
             * Base de datos OBC (Outbound) - Estructura de columnas:
             * Columna 0: Outbound_Âá∫Â∫ìÂçïÂè∑ (N√∫mero de orden de salida)
             * Columna 1: Reference order No._ÂèÇËÄÉÂçïÂè∑ (N√∫mero de orden de referencia)
             * Columna 2: Shipping service_Áâ©ÊµÅÊ∏†ÈÅì (Servicio de env√≠o/Canal log√≠stico)
             * Columna 3: Ë¥ß‰ª∂ËøΩË∏™Á†Å/Reference ID (C√≥digo de seguimiento de env√≠o)
             * Columna 4: Expected Arrival Time _ ÊúüÊúõÂà∞‰ªìÊó∂Èó¥ (Fecha esperada de llegada a almac√©n)
             * Columna 5: Remark_Â§áÊ≥® (Observaciones)
             * Columna 6: Recipient_Êî∂‰ª∂‰∫∫ (Destinatario)
             * Columna 7: Box type No_ÁÆ±Á±ªÂûãÂè∑ (Tipo de caja)
             * Columna 8: Custom box barcode_Ëá™ÂÆö‰πâÁÆ±Êù°Á†Å (C√≥digo de barras personalizado de la caja) ‚ö†Ô∏è USADO PARA B√öSQUEDA
             */
            const outboundIdx = 0;
            const refNoIdx = 1;
            const shippingServiceIdx = 2;
            const trackingCodeIdx = 3;
            const expectedArrivalIdx = 4;
            const remarkIdx = 5;
            const recipientIdx = 6;
            const boxTypeIdx = 7;
            const customBarcodeIdx = 8; // ‚ö†Ô∏è COLUMNA I - Usada para buscar c√≥digos escaneados

            // Cargar TODO sin filtro
            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length >= 6) {
                    const orden = cols[outboundIdx]?.trim();
                    const expectedArrival = cols[expectedArrivalIdx]?.trim();
                    const customBarcode = cols[customBarcodeIdx]?.trim();

                    if (orden) {
                        STATE.obcData.set(orden, {
                            orden, // Outbound_Âá∫Â∫ìÂçïÂè∑
                            referenceNo: cols[refNoIdx]?.trim() || '', // Reference order No._ÂèÇËÄÉÂçïÂè∑
                            shippingService: cols[shippingServiceIdx]?.trim() || '', // Shipping service_Áâ©ÊµÅÊ∏†ÈÅì
                            trackingCode: cols[trackingCodeIdx]?.trim() || '', // Ë¥ß‰ª∂ËøΩË∏™Á†Å/Reference ID
                            expectedArrival: expectedArrival || '', // Expected Arrival Time _ ÊúüÊúõÂà∞‰ªìÊó∂Èó¥
                            remark: cols[remarkIdx]?.trim() || '', // Remark_Â§áÊ≥®
                            recipient: cols[recipientIdx]?.trim() || '', // Recipient_Êî∂‰ª∂‰∫∫
                            boxType: cols[boxTypeIdx]?.trim() || '', // Box type No_ÁÆ±Á±ªÂûãÂè∑
                            customBarcode: customBarcode || '', // Custom box barcode_Ëá™ÂÆö‰πâÁÆ±Êù°Á†Å

                            // Legacy fields for backward compatibility
                            ref1: cols[refNoIdx]?.trim() || '',
                            ref2: cols[shippingServiceIdx]?.trim() || '',
                            horario: cols[trackingCodeIdx]?.trim() || '',
                            destino: cols[recipientIdx]?.trim() || '',
                            codigo: customBarcode || '' // Usa customBarcode para b√∫squeda
                        });
                    }
                }
            }
        }

        // Helper function to parse dates from OBC (handles various formats)
        function parseOrderDate(dateStr) {
            if (!dateStr) return null;

            // Try ISO format first (YYYY-MM-DD)
            let date = new Date(dateStr);
            if (!isNaN(date.getTime())) return date;

            // Try DD/MM/YYYY
            const parts = dateStr.split(/[/-]/);
            if (parts.length === 3) {
                // Assume DD/MM/YYYY or MM/DD/YYYY
                const d = parseInt(parts[0]);
                const m = parseInt(parts[1]);
                const y = parseInt(parts[2]);

                // If year is 2 digits, convert to 4
                const year = y < 100 ? 2000 + y : y;

                // Try DD/MM/YYYY first
                date = new Date(year, m - 1, d);
                if (!isNaN(date.getTime())) return date;

                // Try MM/DD/YYYY
                date = new Date(year, d - 1, m);
                if (!isNaN(date.getTime())) return date;
            }

            return null;
        }

        function parseListasData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.operadores = [];
            STATE.unidades = [];

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                // Columna B (√≠ndice 1): Operadores
                // Columna D (√≠ndice 3): Unidades
                const operador = cols[1]?.trim().toUpperCase();
                const unidad = cols[3]?.trim().toUpperCase();

                if (operador && !STATE.operadores.includes(operador)) {
                    STATE.operadores.push(operador);
                }
                if (unidad && !STATE.unidades.includes(unidad)) {
                    STATE.unidades.push(unidad);
                }
            }

            // Populate selects
            populateOperadoresUnidades();
        }

        function populateOperadoresUnidades() {
            const operadorSelect = document.getElementById('modal-operador');
            const unidadSelect = document.getElementById('modal-unidad');

            operadorSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                STATE.operadores.map(op => `<option value="${op}">${op}</option>`).join('');

            unidadSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                STATE.unidades.map(un => `<option value="${un}">${un}</option>`).join('');
        }

        function parseTRSData(csv) {
            const lines = csv.split('\n').filter(l => l.trim());
            STATE.trsData = [];

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length >= 15 && cols[0]?.startsWith('TRS')) {
                    STATE.trsData.push({
                        trs: cols[0]?.trim(),
                        referencia: cols[6]?.trim() || '',
                        codigoOriginal: cols[13]?.trim() || '',
                        codigoNuevo: cols[14]?.trim() || ''
                    });
                }
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function updateBdInfo() {
            document.getElementById('bd-count').textContent = STATE.obcData.size;
            const updateTime = new Date().toLocaleTimeString();
            let timeText = updateTime;

            if (STATE.dateFilter.startDate && STATE.dateFilter.endDate) {
                const start = new Date(STATE.dateFilter.startDate).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                const end = new Date(STATE.dateFilter.endDate).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                timeText += `<br><small style="font-size: 0.85em;">üìÖ ${start} - ${end}</small>`;
            }

            document.getElementById('bd-update-time').innerHTML = timeText;
        }

        function refreshData() {
            loadAllData();
        }

        // ==================== SCAN PROCESSING (Algoritmo track.html) ====================
        function processScan() {
            const input = document.getElementById('scan-input');
            const rawCode = input.value.trim();

            if (!rawCode) {
                showNotification('‚ö†Ô∏è Ingresa un c√≥digo', 'warning');
                return;
            }

            if (STATE.obcData.size === 0) {
                showNotification('‚ö†Ô∏è Base de datos no cargada', 'warning');
                return;
            }

            console.log(`üîç Iniciando b√∫squeda para: "${rawCode}"`);

            // Extraer y normalizar c√≥digo
            const extracted = extractCode(rawCode);
            const normalized = normalizeCode(extracted);
            const baseCode = extractBaseCode(normalized);

            console.log(`üìä C√≥digos generados:
  Raw: "${rawCode}"
  Extracted: "${extracted}"
  Normalized: "${normalized}"
  Base: "${baseCode}"`);

            // ALGORITMO DE B√öSQUEDA MULTI-NIVEL (basado en track.html)
            let orderInfo = null;
            let matchType = 'none';
            let bestMatch = { order: null, similarity: 0 };

            // NIVEL 1: B√∫squeda exacta por n√∫mero de OBC
            const upperRaw = rawCode.toUpperCase().trim();
            orderInfo = STATE.obcData.get(upperRaw);
            if (orderInfo) {
                matchType = 'obc-exact';
                console.log(`‚úÖ NIVEL 1: Encontrado por n√∫mero OBC exacto: ${upperRaw}`);
            }

            // NIVEL 2: B√∫squeda exacta en customBarcode (Columna I)
            if (!orderInfo) {
                for (const [orden, data] of STATE.obcData.entries()) {
                    if (data.customBarcode) {
                        const dbNormalized = normalizeCode(data.customBarcode);

                        // Coincidencia exacta
                        if (dbNormalized === normalized) {
                            orderInfo = data;
                            matchType = 'barcode-exact';
                            console.log(`‚úÖ NIVEL 2: Coincidencia exacta en customBarcode: ${orden}`);
                            break;
                        }
                    }
                }
            }

            // NIVEL 3: B√∫squeda por c√≥digo base (sin sufijos)
            if (!orderInfo && baseCode && baseCode !== normalized) {
                for (const [orden, data] of STATE.obcData.entries()) {
                    if (data.customBarcode) {
                        const dbNormalized = normalizeCode(data.customBarcode);
                        const dbBaseCode = extractBaseCode(dbNormalized);

                        if (dbBaseCode === baseCode) {
                            orderInfo = data;
                            matchType = 'base-code';
                            console.log(`‚úÖ NIVEL 3: Coincidencia por c√≥digo base: ${orden} (${baseCode})`);
                            break;
                        }
                    }
                }
            }

            // NIVEL 4: B√∫squeda flexible en m√∫ltiples campos
            if (!orderInfo) {
                console.log('üîÑ NIVEL 4: B√∫squeda flexible en todos los campos...');

                for (const [orden, data] of STATE.obcData.entries()) {
                    let similarity = 0;

                    // Buscar en customBarcode
                    if (data.customBarcode) {
                        const sim = calculateFieldSimilarity(normalized, data.customBarcode);
                        similarity = Math.max(similarity, sim);
                    }

                    // Buscar en n√∫mero de orden
                    if (data.orden) {
                        const sim = calculateFieldSimilarity(normalized, data.orden);
                        similarity = Math.max(similarity, sim);
                    }

                    // Buscar en referenceNo
                    if (data.referenceNo) {
                        const sim = calculateFieldSimilarity(normalized, data.referenceNo);
                        similarity = Math.max(similarity, sim);
                    }

                    // Buscar en trackingCode
                    if (data.trackingCode) {
                        const sim = calculateFieldSimilarity(normalized, data.trackingCode);
                        similarity = Math.max(similarity, sim);
                    }

                    // Si encontramos alta similitud (>= 75%), considerarlo
                    if (similarity >= 75 && similarity > bestMatch.similarity) {
                        bestMatch = { order: data, similarity };
                    }
                }

                // Si encontramos coincidencia flexible
                if (bestMatch.order) {
                    orderInfo = bestMatch.order;
                    matchType = 'flexible';
                    console.log(`‚úÖ NIVEL 4: Coincidencia flexible (${bestMatch.similarity.toFixed(1)}%): ${orderInfo.orden}`);
                }
            }

            // Si no se encontr√≥ nada
            if (!orderInfo) {
                showNotification(`‚ùå C√≥digo/OBC no encontrado en BD: ${rawCode}`, 'error');
                console.log(`‚ùå No se encontr√≥ en ${STATE.obcData.size} √≥rdenes cargadas`);
                console.log(`üí° Tip: Verifica que el c√≥digo est√© en la columna "Custom box barcode" de OBC_BD`);
                return;
            }

            // Buscar en TRS
            const trsInfo = findTRSByCode(normalized);

            // Mostrar resultado con info de match
            console.log(`‚úÖ Orden encontrada: ${orderInfo.orden} (Tipo: ${matchType})`);
            showScanResult(rawCode, orderInfo, trsInfo);
            input.value = '';
        }

        /**
         * Extraer c√≥digo base (sin sufijos num√©ricos)
         * Ejemplo: "ABC123/456-001" ‚Üí "ABC123/456"
         */
        function extractBaseCode(code) {
            if (!code) return '';

            // Remover sufijos num√©ricos comunes al final
            // Patrones: -001, -01, /001, /01, _001, _01
            let base = code.replace(/[-\/_]\d{1,3}$/i, '');

            // Si el c√≥digo termina en n√∫meros despu√©s de letra, quitar n√∫meros finales
            // Ejemplo: XZH2510237543U002 ‚Üí XZH2510237543U
            base = base.replace(/([A-Z])\d+$/i, '$1');

            return base || code;
        }

        /**
         * Calcular similitud entre dos c√≥digos (versi√≥n simplificada de track.html)
         */
        function calculateFieldSimilarity(query, fieldValue) {
            if (!fieldValue) return 0;

            const normalized = normalizeCode(fieldValue);
            const queryNorm = normalizeCode(query);

            // Coincidencia exacta
            if (normalized === queryNorm) return 100;

            // Uno contiene al otro
            if (normalized.includes(queryNorm) || queryNorm.includes(normalized)) {
                const overlapRatio = Math.min(queryNorm.length, normalized.length) /
                                    Math.max(queryNorm.length, normalized.length);
                return overlapRatio * 100;
            }

            // Similitud de Levenshtein (simple)
            return calculateLevenshteinSimilarity(queryNorm, normalized);
        }

        /**
         * Calcular similitud usando distancia de Levenshtein
         */
        function calculateLevenshteinSimilarity(s1, s2) {
            const len1 = s1.length;
            const len2 = s2.length;
            const matrix = [];

            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j - 1] + cost
                    );
                }
            }

            const distance = matrix[len1][len2];
            const maxLen = Math.max(len1, len2);
            return maxLen === 0 ? 100 : ((maxLen - distance) / maxLen) * 100;
        }

        function findTRSByCode(normalizedCode) {
            for (const trs of STATE.trsData) {
                const normalizedOriginal = normalizeCode(trs.codigoOriginal);
                const normalizedNuevo = normalizeCode(trs.codigoNuevo);

                if (normalizedOriginal === normalizedCode || normalizedNuevo === normalizedCode) {
                    return trs;
                }
            }
            return null;
        }

        /**
         * Extraer c√≥digo de barras del texto escaneado (como en validador.html)
         */
        function extractCode(raw) {
            if (raw === null || raw === undefined) return '';
            let code = String(raw).trim();

            // Remover caracteres invisibles
            code = code.replace(/[\u0000-\u001F\u007F-\u009F\u200B-\u200F\uFEFF]/g, '').trim();

            // Convertir *, & y - (entre n√∫meros) a /
            code = code.replace(/\*/g, '/');
            code = code.replace(/&/g, '/');
            code = code.replace(/(\d)-(\d)/g, '$1/$2');

            // Normalizar comillas
            code = code.replace(/[""¬´¬ª‚Äû‚Äü‚Äö‚Äõ''¬®]/g, '"');

            // Patrones de extracci√≥n (en orden de prioridad)
            const patterns = [
                // N√∫meros con slash: 123/456
                /([0-9]+\/[0-9]+)/,
                // Alfanum√©rico con slash: ABC/123
                /([A-Za-z0-9]{2,}\/[A-Za-z0-9\/\-\._:]{1,})/,
                // Tokens largos alfanum√©ricos
                /.*?([A-Za-z0-9]{6,}).*/,
                // N√∫meros largos
                /([0-9]{6,})/
            ];

            for (const p of patterns) {
                const m = code.match(p);
                if (m && m[1]) return m[1].trim();
            }

            return code.trim();
        }

        /**
         * Normalizar c√≥digo para comparaci√≥n (como en validador.html)
         */
        function normalizeCode(code) {
            if (!code) return '';

            return String(code)
                .replace(/&/g, '/')
                .replace(/-/g, '/')
                .toLowerCase()
                .trim();
        }

        function showScanResult(code, orderInfo, trsInfo) {
            STATE.currentScan = { code, orderInfo, trsInfo };

            // NO mostrar tarjetas resumen - ir directo al modal
            // Abrir modal de validaci√≥n
            openValidationModal();
        }

        function clearScan() {
            document.getElementById('scan-input').value = '';
            document.getElementById('result-cards').style.display = 'none';
            STATE.currentScan = null;
            document.getElementById('scan-input').focus();
        }

        // ==================== VALIDATION MODAL (Estilo track.html) ====================
        function openValidationModal() {
            if (!STATE.currentScan) return;

            const { code, orderInfo, trsInfo } = STATE.currentScan;

            // Cantidad esperada (TODO: obtener real de BD)
            const expectedQty = 10;

            // ===== KPI CARDS =====
            document.getElementById('kpi-orden').textContent = orderInfo.orden;
            document.getElementById('kpi-orden-boxes').textContent = `${expectedQty} cajas`;

            document.getElementById('kpi-destino').textContent = orderInfo.recipient || 'Sin destino';
            document.getElementById('kpi-horario').textContent = `üìÖ ${orderInfo.expectedArrival || 'Sin fecha'}`;

            document.getElementById('kpi-validacion').textContent = '0%';
            document.getElementById('kpi-progress-bar').style.width = '0%';

            if (trsInfo) {
                document.getElementById('kpi-trs').textContent = trsInfo.trs;
                document.getElementById('kpi-trs-match').textContent = '‚úÖ Detectado';
            } else {
                document.getElementById('kpi-trs').textContent = 'Sin TRS';
                document.getElementById('kpi-trs-match').textContent = '‚úÖ Sin cambios';
            }

            if (orderInfo.trackingCode) {
                const shortTrack = orderInfo.trackingCode.length > 12 ? orderInfo.trackingCode.substring(0, 12) + '...' : orderInfo.trackingCode;
                document.getElementById('kpi-tracking').textContent = shortTrack;
                document.getElementById('kpi-tracking-status').textContent = '‚úÖ Activo';
            } else {
                document.getElementById('kpi-tracking').textContent = 'Sin c√≥digo';
                document.getElementById('kpi-tracking-status').textContent = '‚ö†Ô∏è Sin rastreo';
            }

            // ===== TABLA OBC =====
            const obcTableBody = document.getElementById('obc-table-body');
            obcTableBody.innerHTML = `
                <tr>
                    <td><strong>N√∫mero de Orden</strong></td>
                    <td><code>${orderInfo.orden}</code></td>
                </tr>
                <tr>
                    <td><strong>Referencia</strong></td>
                    <td>${orderInfo.referenceNo || '-'}</td>
                </tr>
                <tr>
                    <td><strong>Servicio de Env√≠o</strong></td>
                    <td>${orderInfo.shippingService || '-'}</td>
                </tr>
                <tr>
                    <td><strong>Fecha Esperada</strong></td>
                    <td>${orderInfo.expectedArrival || '-'}</td>
                </tr>
                <tr>
                    <td><strong>Destinatario</strong></td>
                    <td>${orderInfo.recipient || '-'}</td>
                </tr>
                <tr>
                    <td><strong>Tipo de Caja</strong></td>
                    <td>${orderInfo.boxType || '-'}</td>
                </tr>
                <tr>
                    <td><strong>C√≥digo de Barras</strong></td>
                    <td><code>${orderInfo.customBarcode || '-'}</code></td>
                </tr>
                <tr>
                    <td><strong>Cantidad Esperada</strong></td>
                    <td><strong style="color: var(--primary);">${expectedQty}</strong></td>
                </tr>
            `;
            document.getElementById('modal-qty-dispatch').value = expectedQty;

            // ===== TABLA TRS =====
            const trsContainer = document.getElementById('trs-table-container');
            if (trsInfo) {
                trsContainer.innerHTML = `
                    <div style="padding: 12px; background: #fff3e0; border-radius: 6px; border-left: 4px solid var(--warning); margin-bottom: 12px;">
                        <strong>‚ö†Ô∏è CAMBIO DE ETIQUETA DETECTADO</strong>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Campo</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Orden TRS</strong></td>
                                <td><code>${trsInfo.trs}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Referencia</strong></td>
                                <td>${trsInfo.referencia || '-'}</td>
                            </tr>
                            <tr>
                                <td><strong>C√≥digo Original</strong></td>
                                <td><code>${trsInfo.codigoOriginal}</code></td>
                            </tr>
                            <tr>
                                <td><strong>C√≥digo Nuevo</strong></td>
                                <td><code style="color: var(--warning);">${trsInfo.codigoNuevo}</code></td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } else {
                trsContainer.innerHTML = `
                    <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid var(--success);">
                        ‚úÖ Sin cambio de etiqueta detectado
                    </div>
                `;
            }

            // ===== TABLA RASTREO =====
            const rastreoSection = document.getElementById('section-rastreo');
            const rastreoContainer = document.getElementById('rastreo-table-container');
            if (orderInfo.trackingCode) {
                rastreoSection.style.display = 'block';
                rastreoContainer.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Campo</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>C√≥digo de Rastreo</strong></td>
                                <td><code>${orderInfo.trackingCode}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Servicio</strong></td>
                                <td>${orderInfo.shippingService || '-'}</td>
                            </tr>
                            <tr>
                                <td><strong>Estado</strong></td>
                                <td>üì¶ En proceso de entrega</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } else {
                rastreoSection.style.display = 'none';
            }

            // Limpiar formulario
            document.getElementById('modal-observaciones').value = '';
            document.getElementById('modal-status-order').value = 'OK';
            document.getElementById('modal-status-quality').value = 'Completado';

            document.getElementById('validation-modal').classList.add('show');
        }

        // ===== NAVEGACI√ìN POR ANCLAS =====
        function jumpToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ===== TOGGLE DE SECCIONES =====
        function toggleSection(contentId) {
            const content = document.getElementById(contentId);
            const toggle = document.getElementById(contentId.replace('-content', '-toggle'));

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + 'px';
                if (toggle) toggle.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                content.style.maxHeight = '0';
                if (toggle) toggle.classList.add('collapsed');
            }
        }

        function closeValidationModal() {
            document.getElementById('validation-modal').classList.remove('show');
        }

        async function confirmValidation() {
            if (!STATE.currentScan) return;

            const { code, orderInfo, trsInfo } = STATE.currentScan;

            // Validar campos obligatorios
            const qtyDispatch = parseInt(document.getElementById('modal-qty-dispatch').value);
            const qtyExpected = parseInt(document.getElementById('modal-qty-expected').textContent);
            const statusOrder = document.getElementById('modal-status-order').value;
            const statusQuality = document.getElementById('modal-status-quality').value;
            const operador = document.getElementById('modal-operador').value;
            const unidad = document.getElementById('modal-unidad').value;
            const observaciones = document.getElementById('modal-observaciones').value;

            if (!qtyDispatch || qtyDispatch <= 0) {
                showNotification('‚ö†Ô∏è Ingresa cantidad a despachar', 'warning');
                return;
            }

            // Validar env√≠o parcial
            if (qtyDispatch < qtyExpected) {
                if (!confirm(`‚ö†Ô∏è ENV√çO PARCIAL\n\nEsperado: ${qtyExpected}\nA despachar: ${qtyDispatch}\n\n¬øConfirmar env√≠o parcial?`)) {
                    return;
                }
            }

            // Generar folio
            const folio = generateFolio();

            // Crear registro
            const now = new Date();
            const record = {
                folio,
                fecha: now.toISOString().slice(0, 10),
                hora: now.toTimeString().slice(0, 8),
                usuario: CURRENT_USER,
                orden: orderInfo.orden,
                destino: orderInfo.recipient || orderInfo.destino || '',
                horario: orderInfo.trackingCode || orderInfo.horario || '',
                codigo: code,
                codigo2: trsInfo?.codigoNuevo || '',
                estatus: statusOrder,
                cambioEtiqueta: trsInfo ? 'S√ç' : 'NO',
                estatus2: statusQuality,
                incidencias: qtyDispatch < qtyExpected ? 'Env√≠o Parcial' : '',
                operador: operador || '',
                unidad: unidad || '',
                observaciones,
                qtyExpected,
                qtyDispatch
            };

            console.log('Guardando registro de validaci√≥n:', record);

            // Agregar a validadas o pendientes
            if (statusOrder === 'OK' && statusQuality === 'Completado') {
                STATE.validatedOrders.push(record);
            } else {
                STATE.pendingOrders.push(record);
            }

            // Agregar a pending sync
            PENDING_SYNC.push(record);
            savePendingSync();
            updateSyncStatus();

            // Intentar sincronizar
            if (IS_ONLINE && gapi?.client?.getToken()) {
                await syncData(false); // Sin mensajes para no molestar
            }

            showNotification('‚úÖ Validaci√≥n registrada correctamente', 'success');
            closeValidationModal();
            clearScan();
            updateUI();
        }

        function generateFolio() {
            const today = new Date();
            const dateStr = today.toISOString().slice(2, 10).replace(/-/g, '');
            const counter = STATE.folioCounter.toString().padStart(3, '0');
            STATE.folioCounter++;
            return `FE${dateStr}-${counter}`;
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            updateDaySummary();
            updatePanels();
        }

        function updateDaySummary() {
            // Usar √≥rdenes filtradas si hay filtro activo
            const totalOBC = STATE.dateFilter.active ? STATE.obcDataFiltered.size : 0;
            const validated = STATE.validatedOrders.length;
            const pending = STATE.dateFilter.active ? STATE.obcDataFiltered.size - validated : 0;
            const problems = STATE.pendingOrders.filter(o => o.estatus === 'Anormalidad').length;

            document.getElementById('summary-total').textContent = totalOBC;
            document.getElementById('summary-validated').textContent = validated;
            document.getElementById('summary-pending').textContent = pending;
            document.getElementById('summary-problems').textContent = problems;
        }

        function updatePanels() {
            // Panel de validadas: mostrar √≥rdenes validadas
            updateValidatedPanel();

            // Panel de pendientes: mostrar √≥rdenes OBC filtradas que NO han sido validadas
            updatePendingPanel();
        }

        function updateValidatedPanel() {
            const listEl = document.getElementById('validated-list');
            const countEl = document.getElementById('validated-count');
            const orders = STATE.validatedOrders;

            countEl.textContent = orders.length;

            if (orders.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                        <div>Sin validaciones</div>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = orders.map(order => `
                <div class="panel-item validated" data-order="${order.orden}">
                    <div class="panel-item-info">
                        <div class="panel-item-order">
                            ${order.orden}
                            ${order.cambioEtiqueta === 'S√ç' ? '<span class="badge warning">Etiqueta</span>' : ''}
                        </div>
                        <div class="panel-item-meta">
                            ${order.destino} ‚Ä¢ ${order.horario} ‚Ä¢ ${order.fecha} ${order.hora}
                        </div>
                        <div class="panel-item-meta">
                            ${order.estatus} ‚Ä¢ ${order.estatus2}
                            ${order.operador ? ` ‚Ä¢ üöõ ${order.operador}` : ''}
                        </div>
                    </div>
                    <div class="panel-item-actions">
                        <button class="btn-expand" onclick="showOrderDetails('${order.folio}', 'validated')">
                            üìã Ver
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updatePendingPanel() {
            const listEl = document.getElementById('pending-list');
            const countEl = document.getElementById('pending-count');

            if (!STATE.dateFilter.active || STATE.obcDataFiltered.size === 0) {
                countEl.textContent = '0';
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                        <div>Selecciona un rango de fechas para ver √≥rdenes pendientes</div>
                    </div>
                `;
                return;
            }

            // Obtener OBC validadas
            const validatedOBCs = new Set(STATE.validatedOrders.map(o => o.orden));

            // Filtrar √≥rdenes pendientes (no validadas)
            const pendingOrders = Array.from(STATE.obcDataFiltered.values())
                .filter(order => !validatedOBCs.has(order.orden));

            countEl.textContent = pendingOrders.length;

            if (pendingOrders.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">‚úÖ</div>
                        <div>Todas las √≥rdenes del periodo han sido validadas</div>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = pendingOrders.map(order => `
                <div class="panel-item pending" data-order="${order.orden}">
                    <div class="panel-item-info">
                        <div class="panel-item-order">
                            ${order.orden}
                        </div>
                        <div class="panel-item-meta">
                            üë§ ${order.recipient || 'Sin destinatario'} ‚Ä¢
                            üì¶ ${order.shippingService || 'Sin servicio'} ‚Ä¢
                            üïê ${order.expectedArrival || 'Sin fecha'}
                        </div>
                        <div class="panel-item-meta">
                            üìã Ref: ${order.referenceNo || '-'} ‚Ä¢
                            üî¢ Tracking: ${order.trackingCode || '-'}
                        </div>
                    </div>
                    <div class="panel-item-actions">
                        <button class="btn-expand" onclick="showOBCDetails('${order.orden}')">
                            üìã Ver
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showOBCDetails(ordenOBC) {
            const order = STATE.obcDataFiltered.get(ordenOBC) || STATE.obcData.get(ordenOBC);

            if (!order) return;

            const details = `
üì¶ DETALLE DE ORDEN OBC

Orden: ${order.orden}
Destinatario: ${order.recipient || '-'}
Servicio: ${order.shippingService || '-'}
Tracking: ${order.trackingCode || '-'}
Fecha Esperada: ${order.expectedArrival || '-'}
Referencia: ${order.referenceNo || '-'}
Tipo de Caja: ${order.boxType || '-'}
C√≥digo de Barras: ${order.customBarcode || '-'}
Observaciones: ${order.remark || '-'}
            `.trim();

            alert(details);
        }

        function filterPanel(type) {
            const searchTerm = document.getElementById(`filter-${type}`).value.toLowerCase();
            const items = document.querySelectorAll(`#${type}-list .panel-item`);

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function sortPanel(type) {
            const sortBy = document.getElementById(`sort-${type}`).value;
            const orders = type === 'validated' ? STATE.validatedOrders : STATE.pendingOrders;

            orders.sort((a, b) => {
                switch(sortBy) {
                    case 'recent':
                        return new Date(`${b.fecha} ${b.hora}`) - new Date(`${a.fecha} ${a.hora}`);
                    case 'order':
                        return a.orden.localeCompare(b.orden);
                    case 'destino':
                        return a.destino.localeCompare(b.destino);
                    case 'horario':
                        return a.horario.localeCompare(b.horario);
                    default:
                        return 0;
                }
            });

            updatePanel(type, orders);
        }

        function showOrderDetails(folio, type) {
            const orders = type === 'validated' ? STATE.validatedOrders : STATE.pendingOrders;
            const order = orders.find(o => o.folio === folio);

            if (!order) return;

            alert(`üìã DETALLE DE ORDEN\n\nFolio: ${order.folio}\nOrden: ${order.orden}\nDestino: ${order.destino}\nHorario: ${order.horario}\nC√≥digo: ${order.codigo}\n${order.codigo2 ? `C√≥digo 2: ${order.codigo2}\n` : ''}Estatus: ${order.estatus}\nControl Calidad: ${order.estatus2}\nOperador: ${order.operador || '-'}\nUnidad: ${order.unidad || '-'}\nObservaciones: ${order.observaciones || '-'}`);
        }

        // ==================== SYNC (Patr√≥n validador.html) ====================
        /**
         * Escribir un registro individual a Google Sheets
         */
        async function writeToSheets(log) {
            // Estructura de columnas para BD de Despacho:
            // Folio, Fecha, Hora, Usuario, Orden, Destino, Horario, Codigo, Codigo2,
            // Estatus, CambioEtiqueta, Estatus2, Incidencias, Operador, Unidad, Observaciones,
            // QtyExpected, QtyDispatch
            const values = [[
                log.folio,
                log.fecha,
                log.hora,
                log.usuario,
                log.orden,
                log.destino,
                log.horario,
                log.codigo,
                log.codigo2,
                log.estatus,
                log.cambioEtiqueta,
                log.estatus2,
                log.incidencias,
                log.operador,
                log.unidad,
                log.observaciones,
                log.qtyExpected,
                log.qtyDispatch
            ]];

            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                range: 'BD!A:R', // Hasta columna R (18 columnas)
                valueInputOption: 'USER_ENTERED',
                insertDataOption: 'INSERT_ROWS',
                resource: { values }
            });
        }

        /**
         * Sincronizar registros pendientes (uno por uno)
         */
        async function syncData(showMessages = true) {
            if (PENDING_SYNC.length === 0) {
                if (showMessages) showNotification('‚úÖ Todo sincronizado', 'success');
                updateSyncStatus();
                return { success: true, synced: 0 };
            }

            if (!IS_ONLINE) {
                if (showMessages) showNotification('‚ö†Ô∏è Sin conexi√≥n a Internet', 'warning');
                updateSyncStatus();
                return { success: false, reason: 'offline' };
            }

            if (!gapi?.client?.getToken()) {
                if (showMessages) showNotification('‚ö†Ô∏è No conectado a Google Sheets', 'warning');
                updateSyncStatus();
                return { success: false, reason: 'no_token' };
            }

            const total = PENDING_SYNC.length;
            if (showMessages) showNotification(`üîÑ Sincronizando ${total} registros...`, 'info');

            let success = 0;
            const errors = [];
            const toRetry = [];

            // Sincronizar uno por uno (como en validador.html)
            for (let i = 0; i < PENDING_SYNC.length; i++) {
                const item = PENDING_SYNC[i];
                try {
                    await writeToSheets(item);
                    success++;
                    console.log(`‚úÖ Sincronizado ${success}/${total}:`, item.folio);
                } catch (e) {
                    console.error('‚ùå Error sincronizando:', item.folio, e);
                    toRetry.push(item);
                    errors.push({ folio: item.folio, error: e.message || 'Error' });
                }

                // Peque√±a pausa entre escrituras para evitar rate limiting
                if (i < PENDING_SYNC.length - 1) {
                    await new Promise(r => setTimeout(r, 200));
                }
            }

            // Actualizar PENDING_SYNC solo con los que fallaron
            PENDING_SYNC = toRetry;
            savePendingSync();
            updateSyncStatus();

            if (errors.length === 0) {
                if (showMessages) showNotification(`‚úÖ ${success} registros sincronizados`, 'success');
                return { success: true, synced: success };
            } else {
                if (showMessages) showNotification(`‚ö†Ô∏è ${success} OK, ${errors.length} fallaron`, 'warning');
                return { success: false, synced: success, failed: errors.length };
            }
        }

        function savePendingSync() {
            localStorage.setItem('desp_pending_sync', JSON.stringify(PENDING_SYNC));
        }

        function loadPendingSync() {
            try {
                const saved = localStorage.getItem('desp_pending_sync');
                if (saved) {
                    PENDING_SYNC = JSON.parse(saved);
                    console.log(`üì¶ Cargados ${PENDING_SYNC.length} registros pendientes de sincronizar`);
                    updateSyncStatus();
                }
            } catch (e) {
                console.error('Error cargando pending sync:', e);
            }
        }

        function updateSyncStatus() {
            const syncEl = document.getElementById('sync-status');
            if (!syncEl) return;

            if (!IS_ONLINE) {
                syncEl.className = 'sync-status sync-warning';
                syncEl.textContent = `‚ö†Ô∏è Sin conexi√≥n${PENDING_SYNC.length > 0 ? ` (${PENDING_SYNC.length})` : ''}`;
            } else if (PENDING_SYNC.length > 0) {
                syncEl.className = 'sync-status sync-warning';
                syncEl.textContent = `‚ö†Ô∏è ${PENDING_SYNC.length} pendientes`;
            } else {
                syncEl.className = 'sync-status sync-ok';
                syncEl.textContent = '‚úÖ Sincronizado';
            }
        }

        async function showSyncPanel() {
            const hasToken = gapi?.client?.getToken();
            const message = `üìä ESTADO DE SINCRONIZACI√ìN

Registros pendientes de sincronizar: ${PENDING_SYNC.length}
√ìrdenes validadas: ${STATE.validatedOrders.length}
√ìrdenes pendientes: ${STATE.pendingOrders.length}

Estado de conexi√≥n:
- Internet: ${IS_ONLINE ? '‚úÖ Conectado' : '‚ùå Sin conexi√≥n'}
- Google Sheets: ${hasToken ? '‚úÖ Autenticado' : '‚ùå No autenticado'}

${PENDING_SYNC.length > 0 ? '\n¬øDeseas sincronizar ahora?' : ''}`;

            if (PENDING_SYNC.length > 0 && confirm(message)) {
                await syncData(true);
            } else {
                alert(message);
            }
        }

        // ==================== MANUAL ORDER ====================
        function showManualOrderModal() {
            alert('üöß Funci√≥n en desarrollo');
        }

        // ==================== PRINT ====================
        function showPrintModal() {
            alert('üöß Funci√≥n de impresi√≥n en desarrollo');
        }

        // ==================== EXPORT ====================
        function exportData() {
            const allOrders = [...STATE.validatedOrders, ...STATE.pendingOrders];
            if (allOrders.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }

            const headers = ['Folio','Fecha','Hora','Usuario','Orden','Destino','Horario','C√≥digo','C√≥digo 2','Estatus','Cambio Etiqueta','Estatus 2','Incidencias','Operador','Unidad','Observaciones'];
            const rows = allOrders.map(r => [
                r.folio, r.fecha, r.hora, r.usuario, r.orden, r.destino,
                r.horario, r.codigo, r.codigo2, r.estatus, r.cambioEtiqueta,
                r.estatus2, r.incidencias, r.operador, r.unidad, r.observaciones
            ]);

            const csv = '\ufeff' + [
                headers.join(','),
                ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `despacho_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();

            showNotification('‚úÖ Datos exportados', 'success');
        }

        // ==================== UTILITIES ====================
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span style="margin-right: 8px;">${icons[type]}</span>${message}`;

            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }
    </script>
</body>
</html>
