<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Validaci√≥n WMS</title>
    <style>
        :root {
            --primary: #ed5224;
            --success: #4CAF50;
            --error: #F44336;
            --warning: #FF9800;
            --text: #333;
            --bg: #f7f7f7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: var(--bg); 
            color: var(--text);
        }

        /* === DASHBOARD === */
        #dashboard { max-width: 1100px; margin: 0 auto; padding: 30px 20px; }
        .dash-header { text-align: center; margin-bottom: 40px; }
        .dash-header h1 { font-size: 2.2em; color: var(--primary); margin-bottom: 8px; }
        
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; cursor: pointer; transition: all 0.3s; }
        .dash-card:hover { transform: translateY(-5px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
        .dash-card.no-hover { cursor: default; }
        .dash-card.no-hover:hover { transform: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .dash-card-icon { font-size: 2.5em; margin-bottom: 10px; }
        .dash-card-value { font-size: 2em; font-weight: 700; color: var(--primary); margin-top: 5px; }
        
        .status-grid { display: grid; gap: 12px; margin-bottom: 20px; }
        .status-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 6px; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-ok { background: var(--success); }
        .status-error { background: var(--error); }
        .status-warning { background: var(--warning); }
        
        .btn { padding: 15px 30px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 1.1em; transition: all 0.2s; width: 100%; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-size: 1.4em; padding: 20px; }
        .btn-google { background: #4285F4; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-small { padding: 8px 15px; font-size: 0.85em; width: auto; }
        /* Bot√≥n de salida segura */
        .btn-exit {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            margin-top: 15px;
        }
        .btn-exit:hover:not(:disabled) {
            background: linear-gradient(135deg, #5a6268, #495057);
        }

        /* Connection banner */
        .connection-banner {
            position: relative;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s;
        }
        .connection-banner.offline {
            background: var(--error);
            color: white;
            display: block;
        }
        .connection-banner.online {
            background: var(--success);
            color: white;
            display: block;
        }
        .connection-banner.syncing {
            background: var(--warning);
            color: white;
            display: block;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* User stats popup */
        .user-stats-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 9999;
            display: none;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .user-stats-popup.active {
            display: block;
        }
        .popup-overlay-dark {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
            display: none;
        }
        .popup-overlay-dark.active {
            display: block;
        }
        .user-stat-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .user-stat-bar {
            height: 8px;
            background: var(--primary);
            border-radius: 4px;
            margin-top: 8px;
            transition: width 0.5s;
        }
        .user-stat-name {
            font-weight: 700;
            font-size: 1.1em;
        }
        .user-stat-count {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary);
        }

        /* === VALIDATION SCREEN === */
        #validation { display: none; min-height: 100vh; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 200px; background: #333; color: white; padding: 18px; overflow-y: auto; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 15px; overflow-y: auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header h1 { color: var(--primary); font-size: 1.6em; flex: 1; }
        
        .card { background: white; padding: 18px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* Progress Card */
        .progress-card { 
            background: linear-gradient(135deg, #ffa07a 0%, #ff8a52 100%); 
            color: white; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
        }
        .progress-card.completed {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
        }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .progress-obc-name { font-size: 1.2em; font-weight: 700; }
        .progress-percentage { font-size: 2em; font-weight: 800; }
        .progress-counts { display: flex; justify-content: space-around; margin-bottom: 10px; }
        .progress-count-item { text-align: center; }
        .progress-count-number { font-size: 1.4em; font-weight: 700; }
        .progress-count-label { font-size: 0.7em; opacity: 0.85; }
        .progress-bar-container { background: rgba(0,0,0,0.25); height: 10px; border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #fff, #ffd966); transition: width 0.5s; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .progress-bar-fill.completed { background: linear-gradient(90deg, #fff, #81c784) !important; }
        
        /* Inputs en l√≠nea */
        .inline-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.85em; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95em; }
        .input-group textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95em; font-family: inherit; resize: vertical; }
        .scanner-input { font-size: 1.6em !important; text-transform: uppercase; font-weight: bold; text-align: center; background: #fff5ed !important; }
        
        /* Scanner section with manual button */
        .scanner-section {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .scanner-wrapper {
            flex: 1;
        }
        .btn-manual {
            padding: 10px 15px;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-manual:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,152,0,0.3);
        }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .stat-box { text-align: center; padding: 15px; border-radius: 8px; }
        .stat-number { font-size: 2em; font-weight: 700; margin-top: 5px; }
        .stat-ok { background: #e8f5e9; border: 2px solid var(--success); color: var(--success); }
        .stat-error { background: #ffebee; border: 2px solid var(--error); color: var(--error); }
        
        /* Logs con numeraci√≥n */
        .logs-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .log-list { max-height: 350px; overflow-y: auto; list-style: none; background: #fafafa; padding: 10px; border-radius: 8px; counter-reset: log-counter; }
        .log-item { display: flex; gap: 8px; padding: 8px; margin-bottom: 6px; background: white; border-radius: 4px; border-left: 4px solid; }
        .log-item::before { content: counter(log-counter) "."; counter-increment: log-counter; font-weight: 700; min-width: 25px; }
        .log-ok { border-color: var(--success); }
        .log-ok::before { color: var(--success); }
        .log-reject { border-color: var(--error); }
        .log-reject::before { color: var(--error); }
        .log-info { flex: 1; }
        .log-code { font-weight: 600; }
        
        /* Tabs */
        .tab-bar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; align-items: center; }
        .tab { 
            padding: 8px 12px; 
            cursor: pointer; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            background: white; 
            font-weight: 600; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .tab.completed { background: var(--success) !important; color: white !important; border-color: var(--success) !important; }
        .tab.new-tab { background: linear-gradient(135deg, #ffb399, #ff9d7a); color: white; }
        .tab-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin: 0;
            line-height: 1;
            opacity: 0.7;
        }
        .tab-close:hover {
            opacity: 1;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .empty-state-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }
        
        /* Notificaciones */
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px; }
        .notification { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-left: 4px solid; animation: slideIn 0.3s; }
        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: #2196F3; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Popups */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .popup-content { background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; }
        .popup-header { font-size: 1.4em; font-weight: 700; margin-bottom: 15px; }
        .popup-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .popup-close-x {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e0e0e0;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.2s;
        }
        .popup-close-x:hover {
            background: #d0d0d0;
            color: #333;
        }
        
        /* Mini alert */
        .mini-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(244, 67, 54, 0.95);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 10000;
            animation: fadeInOut 0.4s ease-in-out;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        
        /* Resumen Module */
        #resumen-module { display: none; }
        .search-bar { padding: 12px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px; width: 100%; font-size: 1em; }
        .resumen-table { width: 100%; border-collapse: collapse; background: white; }
        .resumen-table th, .resumen-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .resumen-table th { background: #f5f5f5; font-weight: 700; }
        
        /* Consulta Rapida Module */
        #consulta-module { display: none; }
        .consulta-result {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-top: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
        }
        .consulta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }
        .consulta-code-display {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 18px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        .consulta-code-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .consulta-code-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        .consulta-obc {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--primary);
        }
        .consulta-status {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .consulta-status.validated {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: var(--success);
            box-shadow: 0 2px 8px rgba(76,175,80,0.2);
        }
        .consulta-status.pending {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #e65100;
            box-shadow: 0 2px 8px rgba(255,152,0,0.2);
        }
        .consulta-status.not-found {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: var(--error);
            box-shadow: 0 2px 8px rgba(244,67,54,0.2);
        }
        .consulta-section-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .consulta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .consulta-item {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid #eee;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .consulta-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .consulta-item.highlight {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #90caf9;
        }
        .consulta-item-label {
            font-size: 0.7em;
            color: #888;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .consulta-item-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #333;
            word-break: break-word;
        }
        .consulta-progress-section {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .consulta-progress {
            background: #e0e0e0;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .consulta-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #ff8a52);
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.85em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .consulta-progress-bar.complete {
            background: linear-gradient(90deg, var(--success), #45a049);
        }
        .consulta-action {
            text-align: center;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }
        .consulta-validation-info {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 1px solid #a5d6a7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        /* Prerecepci√≥n Module */
        .prerec-order-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 16px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
        }
        .prerec-order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .prerec-order-code {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary);
        }
        .prerec-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
        }
        .prerec-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .prerec-item {
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
        }
        .prerec-item-label {
            font-size: 0.7em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .prerec-item-value {
            font-weight: 600;
            color: #333;
        }
        .prerec-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            background: #e3f2fd;
            color: #1565c0;
            margin-left: 6px;
        }

        /* Reconteo Module */
        #reconteo-module { display: none; }
        .reconteo-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .reconteo-stat {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .reconteo-stat-number {
            font-size: 1.8em;
            font-weight: 700;
        }
        .reconteo-stat-label {
            font-size: 0.8em;
            color: #666;
        }
        .reconteo-stat.ok { border: 2px solid var(--success); }
        .reconteo-stat.ok .reconteo-stat-number { color: var(--success); }
        .reconteo-stat.dup { border: 2px solid var(--warning); }
        .reconteo-stat.dup .reconteo-stat-number { color: var(--warning); }
        .reconteo-stat.missing { border: 2px solid var(--error); }
        .reconteo-stat.missing .reconteo-stat-number { color: var(--error); }
        .reconteo-stat.extra { border: 2px solid #9c27b0; }
        .reconteo-stat.extra .reconteo-stat-number { color: #9c27b0; }
        .reconteo-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        .reconteo-table th, .reconteo-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .reconteo-table th {
            background: #f5f5f5;
            font-weight: 700;
            position: sticky;
            top: 0;
        }
        .reconteo-table .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 700;
        }
        .reconteo-table .status-ok {
            background: #e8f5e9;
            color: var(--success);
        }
        .reconteo-table .status-dup {
            background: #fff3e0;
            color: var(--warning);
        }
        .reconteo-table .status-missing {
            background: #ffebee;
            color: var(--error);
        }
        .reconteo-table .status-extra {
            background: #f3e5f5;
            color: #9c27b0;
        }
        .reconteo-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .btn-add-validation {
            padding: 4px 10px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
        }
        .btn-add-validation:hover {
            background: #45a049;
        }
        .btn-reconteo {
            padding: 10px 15px;
            background: #9c27b0;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-reconteo:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(156,39,176,0.3);
        }
        .btn-consulta {
            padding: 10px 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-consulta:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33,150,243,0.3);
        }

        /* Faltantes Module */
        #faltantes-module { display: none; }
        .faltantes-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .faltantes-controls input {
            flex: 1;
            min-width: 200px;
        }
        .faltantes-controls select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            min-width: 200px;
        }
        .faltantes-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 8px; 
            max-height: 600px; 
            overflow-y: auto; 
        }
        .faltante-item { padding: 10px; border-radius: 6px; text-align: center; font-size: 0.8em; font-weight: 600; word-break: break-all; }
        .faltante-ok { background: #e8f5e9; color: var(--success); }
        .faltante-pending { background: #ffebee; color: var(--error); }
        
        /* Sync status indicator */
        .sync-status {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
        }
        .sync-ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .sync-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }
        .sync-warning {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        
        /* Pending sync indicator */
        .pending-sync-badge {
            display: inline-block;
            background: var(--warning);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 700;
            margin-left: 8px;
        }

        /* User Footer Sidebar */
        .user-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #555;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            color: white;
            flex-shrink: 0;
        }
        .user-details {
            flex: 1;
            overflow: hidden;
        }
        .user-name {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .connection-indicator {
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }
        .connection-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .user-footer-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }
        .user-footer-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.75em;
        }
        .bd-info {
            font-size: 0.7em;
            color: #aaa;
            text-align: center;
            line-height: 1.4;
        }

        @media (max-width: 1024px) {
            .sidebar { width: 180px; }
        }
        
        @media (max-width: 768px) {
            .container { flex-direction: column; height: auto; }
            .sidebar { width: 100%; }
            .inline-inputs { grid-template-columns: 1fr; }
            .faltantes-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="connection-banner" id="connection-banner"></div>
    <div class="notification-container" id="notifications"></div>
    <div class="popup-overlay-dark" id="user-stats-overlay" onclick="closeUserStats()"></div>
    
    <!-- User Stats Popup -->
    <div class="user-stats-popup" id="user-stats-popup">
        <button class="popup-close-x" onclick="closeUserStats()">√ó</button>
        <h2 style="margin-bottom: 20px; color: var(--primary);">üìä Validaciones por Usuario</h2>
        <div id="user-stats-content"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <div class="dash-header">
            <h1>üè≠ Sistema de Validaci√≥n WMS</h1>
            <p>Warehouse Management System</p>
        </div>

        <div class="dash-grid">
            <div class="dash-card no-hover">
                <div class="dash-card-icon">üì¶</div>
                <div>√ìrdenes de Hoy</div>
                <div class="dash-card-value" id="dash-orders">-</div>
            </div>
            <div class="dash-card" onclick="showUserStats()">
                <div class="dash-card-icon">‚úÖ</div>
                <div>Cajas Validadas Hoy</div>
                <div class="dash-card-value" id="dash-validated">-</div>
                <div style="font-size: 0.8em; color: #666; margin-top: 10px;">üëÜ Click para ver por usuario</div>
            </div>
            <div class="dash-card no-hover">
                <div class="dash-card-icon">üìä</div>
                <div>C√≥digos en BD</div>
                <div class="dash-card-value" id="dash-bd">0</div>
            </div>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 20px; color: var(--primary);">Estado del Sistema</h2>
            <div class="status-grid">
                <div class="status-row">
                    <div style="display: flex; align-items: center;">
                        <div class="status-indicator" id="status-conn"></div>
                        Conexi√≥n Google Sheets
                    </div>
                    <span id="conn-label">Desconectado</span>
                </div>
                <div class="status-row">
                    <div style="display: flex; align-items: center;">
                        <div class="status-indicator" id="status-bd"></div>
                        Base de Datos
                    </div>
                    <span id="bd-label">No cargada</span>
                </div>
                <div class="status-row">
                    <div style="display: flex; align-items: center;">
                        <div class="status-indicator" id="status-sync"></div>
                        Sincronizaci√≥n
                    </div>
                    <span id="sync-label">Pendiente</span>
                </div>
            </div>
            <button id="connect-btn" class="btn btn-google" onclick="handleAuthClick()">üîó Conectar con Google Sheets</button>
            <button id="load-bd-btn" class="btn btn-secondary" onclick="loadDatabase()" style="display:none; margin-top:10px;">üìä Cargar Base de Datos</button>
            <button id="safe-exit-btn-dash" class="btn btn-exit" onclick="showSafeExitDialog()">üö™ Salida Segura</button>
        </div>

        <button id="start-btn" class="btn btn-success" onclick="startValidation()" disabled style="margin-top: 20px;">
            üöÄ Iniciar Validaci√≥n
        </button>
    </div>

    <!-- VALIDATION SCREEN -->
    <div id="validation">
        <div class="container">
            <div class="sidebar">
                <h2 style="color: var(--primary); margin-bottom: 15px; font-size: 1.3em;">WMS</h2>
                <button class="btn btn-primary btn-small" onclick="returnToDashboard()" style="margin-bottom: 10px; width: 100%;">‚Üê Dashboard</button>
                <button class="btn btn-secondary btn-small" onclick="showResumen()" style="margin-bottom: 10px; width: 100%;">
                    üìã Resumen <span id="pending-badge"></span>
                </button>
                <button class="btn btn-secondary btn-small" onclick="showFaltantes()" style="margin-bottom: 10px; width: 100%;">üîç Faltantes</button>
                <button class="btn btn-small" onclick="showPrerecepcion()" style="margin-bottom: 10px; width: 100%; background: #6c757d; color: white;">üìã Prerecepci√≥n</button>
                <button class="btn btn-small btn-consulta" onclick="showConsulta()" style="margin-bottom: 10px; width: 100%;">üîé Consulta</button>
                <hr style="border-color: #555; margin: 15px 0;">
                <div id="sync-status-sidebar" class="sync-status sync-ok" style="display: none; cursor: pointer;" onclick="SyncManager.showPanel()">
                    ‚úÖ Sincronizado
                </div>
                <div id="obc-list" style="flex: 1; overflow-y: auto;"></div>

                <!-- User Footer -->
                <div class="user-footer" id="user-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">?</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name-display">No conectado</div>
                            <div class="connection-indicator">
                                <div class="connection-dot" id="connection-dot"></div>
                                <span id="connection-text">Offline</span>
                            </div>
                        </div>
                    </div>
                    <div class="user-footer-actions">
                        <button class="btn btn-secondary btn-small" onclick="reloadBD()" title="Actualizar BD">üîÑ BD</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleGoogleConnection()" id="sidebar-auth-btn" title="Conectar/Desconectar">üîó Conectar</button>
                    </div>
                    <div class="bd-info">
                        <div id="bd-count-footer"><span id="bd-count-sidebar">0</span> c√≥digos cargados</div>
                        <div id="bd-update-time">Sin actualizar</div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="header">
                    <h1>üîç Validaci√≥n de Cajas</h1>
                    <button class="btn btn-secondary btn-small" onclick="exportData()">üì• CSV</button>
                </div>

                <div id="content-area">
                    <div id="empty-state" class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-text">No hay √≥rdenes activas</div>
                        <button class="btn btn-primary" onclick="addOBC()" style="width: auto; padding: 12px 30px;">+ Nueva Orden</button>
                    </div>

                    <div id="validation-content" style="display: none;">
                        <div class="tab-bar" id="tab-bar"></div>

                        <div class="progress-card">
                            <div class="progress-header">
                                <div class="progress-obc-name" id="prog-obc">-</div>
                                <div class="progress-percentage" id="prog-pct">0%</div>
                            </div>
                            <div class="progress-counts">
                                <div class="progress-count-item">
                                    <div class="progress-count-number" id="prog-scan">0</div>
                                    <div class="progress-count-label">Escaneadas</div>
                                </div>
                                <div class="progress-count-item">
                                    <div class="progress-count-number" id="prog-total">0</div>
                                    <div class="progress-count-label">Total</div>
                                </div>
                                <div class="progress-count-item">
                                    <div class="progress-count-number" id="prog-rest">0</div>
                                    <div class="progress-count-label">Faltantes</div>
                                </div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="prog-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="inline-inputs">
                                <div class="input-group">
                                    <label>üì¶ Orden:</label>
                                    <input type="text" id="obc-display" disabled>
                                </div>
                                <div class="input-group">
                                    <label>üè¢ Destino:</label>
                                    <input type="text" id="recipient-display" disabled>
                                </div>
                                <div class="input-group">
                                    <label>üïê Horario:</label>
                                    <input type="text" id="time-display" disabled>
                                </div>
                                <div class="input-group">
                                    <label>üìç Ubicaci√≥n:</label>
                                    <input type="text" id="location-input" placeholder="Ej: PLEC123" onchange="updateState()">
                                </div>
                            </div>
                            <div class="scanner-section">
                                <div class="scanner-wrapper">
                                    <div class="input-group">
                                        <label style="font-size: 1.1em; color: var(--primary);">üì∑ ESCANEAR C√ìDIGO:</label>
                                        <input type="text" id="scanner" class="scanner-input" placeholder="Escanea aqu√≠..." autofocus>
                                    </div>
                                </div>
                                <button class="btn-manual" onclick="openManualInput()">‚úèÔ∏è Manual</button>
                                <button class="btn-reconteo" onclick="openReconteo()">üîÑ Reconteo</button>
                            </div>
                        </div>

                        <div class="stats">
                            <div class="stat-box stat-ok">
                                VALIDADAS
                                <div class="stat-number" id="stat-ok">0</div>
                            </div>
                            <div class="stat-box stat-error">
                                RECHAZADAS
                                <div class="stat-number" id="stat-error">0</div>
                            </div>
                        </div>

                        <div class="logs-container">
                            <div class="card">
                                <h3>‚úÖ Validaciones OK</h3>
                                <ul id="log-ok" class="log-list"></ul>
                            </div>
                            <div class="card">
                                <h3>‚ùå Rechazos</h3>
                                <ul id="log-reject" class="log-list"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESUMEN MODULE -->
    <div id="resumen-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üìã Resumen de √ìrdenes</h1>
                    <button class="btn btn-secondary btn-small" onclick="hideResumen()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <input type="text" id="search-resumen" class="search-bar" placeholder="üîç Buscar orden..." oninput="filterResumen()">
                    <div style="overflow-x: auto;">
                        <table class="resumen-table">
                            <thead>
                                <tr>
                                    <th>Orden</th>
                                    <th>Total</th>
                                    <th>Validadas</th>
                                    <th>Progreso</th>
                                    <th>Destino</th>
                                    <th>Horario</th>
                                </tr>
                            </thead>
                            <tbody id="resumen-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FALTANTES MODULE -->
    <div id="faltantes-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üîç C√≥digos Faltantes</h1>
                    <button class="btn btn-secondary btn-small" onclick="hideFaltantes()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <div class="faltantes-controls">
                        <select id="faltantes-order-select" onchange="renderFaltantes()">
                            <option value="">Seleccionar orden...</option>
                        </select>
                        <input type="text" id="search-faltantes" class="search-bar" placeholder="üîç Buscar c√≥digo..." oninput="filterFaltantes()">
                    </div>
                    <p style="margin-bottom: 15px;"><span style="color: var(--success);">‚úÖ Validados</span> | <span style="color: var(--error);">‚ùå Faltantes</span></p>
                    <div class="faltantes-grid" id="faltantes-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONSULTA RAPIDA MODULE -->
    <div id="consulta-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üîé Consulta R√°pida de Trazabilidad</h1>
                    <button class="btn btn-secondary btn-small" onclick="hideConsulta()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <div class="input-group">
                        <label style="font-size: 1.1em; color: var(--primary);">üì¶ Escanear c√≥digo de caja:</label>
                        <input type="text" id="consulta-scanner" class="scanner-input" placeholder="Escanea o ingresa el c√≥digo..." onkeydown="handleConsultaScan(event)">
                    </div>
                    <button class="btn btn-primary" onclick="executeConsulta()" style="margin-top: 15px;">üîç Consultar</button>
                </div>
                <div id="consulta-result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- RECONTEO MODULE -->
    <div id="reconteo-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üîÑ Reconteo de Orden</h1>
                    <button class="btn btn-secondary btn-small" onclick="hideReconteo()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <div class="faltantes-controls">
                        <select id="reconteo-order-select" onchange="initReconteo()">
                            <option value="">Seleccionar orden...</option>
                        </select>
                        <button class="btn btn-primary btn-small" onclick="clearReconteo()">üóëÔ∏è Limpiar Reconteo</button>
                    </div>
                </div>
                <div id="reconteo-content" style="display: none;">
                    <div class="card">
                        <div class="input-group">
                            <label style="font-size: 1.1em; color: #9c27b0;">üì¶ Escanear para reconteo:</label>
                            <input type="text" id="reconteo-scanner" class="scanner-input" placeholder="Escanea aqu√≠..." onkeydown="handleReconteoScan(event)" style="background: #f3e5f5 !important;">
                        </div>
                    </div>
                    <div class="reconteo-stats" id="reconteo-stats">
                        <div class="reconteo-stat ok">
                            <div class="reconteo-stat-number" id="reconteo-ok">0</div>
                            <div class="reconteo-stat-label">OK</div>
                        </div>
                        <div class="reconteo-stat dup">
                            <div class="reconteo-stat-number" id="reconteo-dup">0</div>
                            <div class="reconteo-stat-label">Duplicados</div>
                        </div>
                        <div class="reconteo-stat missing">
                            <div class="reconteo-stat-number" id="reconteo-missing">0</div>
                            <div class="reconteo-stat-label">Faltantes BD</div>
                        </div>
                        <div class="reconteo-stat extra">
                            <div class="reconteo-stat-number" id="reconteo-extra">0</div>
                            <div class="reconteo-stat-label">No en Orden</div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">üìã Registro de Escaneos</h3>
                        <div class="reconteo-table-container">
                            <table class="reconteo-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>C√≥digo</th>
                                        <th>Estatus</th>
                                        <th>Hora</th>
                                        <th>Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="reconteo-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 15px;">
                        <h3 style="margin-bottom: 15px; color: var(--error);">‚ùå C√≥digos NO escaneados en Reconteo</h3>
                        <p style="margin-bottom: 10px; color: #666;">C√≥digos validados previamente que no han sido escaneados en este reconteo:</p>
                        <div class="faltantes-grid" id="reconteo-not-scanned"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- POPUPS -->
    <div id="popup-error" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('error')">√ó</button>
            <div class="popup-header" style="color: var(--error);">‚ùå C√ìDIGO RECHAZADO</div>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="err-code"></span><br>
                <strong>Motivo:</strong> <span id="err-reason" style="color: var(--error);"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="closePopup('error')">Continuar</button>
            </div>
        </div>
    </div>

    <div id="popup-history" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('history')">√ó</button>
            <div class="popup-header" style="color: var(--warning);">‚ö†Ô∏è C√ìDIGO YA VALIDADO EN HISTORIAL</div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="hist-code"></span><br>
                <strong>Orden Original:</strong> <span id="hist-obc"></span><br>
                <strong>Validado:</strong> <span id="hist-when"></span><br>
                <strong>Usuario:</strong> <span id="hist-user"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('history')">Cancelar</button>
                <button class="btn btn-primary" onclick="forceHistoryValidation()">Forzar Validaci√≥n con Nota</button>
            </div>
        </div>
    </div>

    <div id="popup-dup" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('dup')">√ó</button>
            <div class="popup-header" style="color: var(--warning);">‚ö†Ô∏è DUPLICADO</div>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="dup-code"></span><br>
                <strong>Validado:</strong> <span id="dup-when"></span><br>
                <strong>Usuario:</strong> <span id="dup-user"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('dup')">Ignorar</button>
                <button class="btn btn-primary" onclick="forceDuplicate()">Forzar con Nota</button>
            </div>
        </div>
    </div>

    <div id="popup-completed" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="continueViewing()">√ó</button>
            <div class="popup-header" style="color: var(--success);">‚úÖ ORDEN COMPLETADA</div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin: 15px 0; text-align: center;">
                <div style="font-size: 1.8em; font-weight: 700; color: var(--success); margin-bottom: 10px;">üéâ</div>
                <strong>Orden:</strong> <span id="completed-obc"></span><br>
                <strong>Cajas validadas:</strong> <span id="completed-count"></span><br>
                <strong>Usuario:</strong> <span id="completed-user"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="continueToNewOrder()" style="background: var(--warning);">Nueva Orden</button>
                <button class="btn btn-success" onclick="saveAndContinue()">Guardar y Continuar</button>
                <button class="btn btn-secondary" onclick="saveAndClose()">Cerrar Validaci√≥n</button>
            </div>
        </div>
    </div>

    <div id="popup-manual" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('manual')">√ó</button>
            <div class="popup-header" style="color: var(--warning);">‚úèÔ∏è INGRESO MANUAL DE C√ìDIGO</div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <p style="margin-bottom: 15px; color: #e65100;"><strong>‚ö†Ô∏è Advertencia:</strong> Solo usar para casos excepcionales</p>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>C√≥digo:</label>
                    <input type="text" id="manual-code" placeholder="Ingresa el c√≥digo">
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Motivo:</label>
                    <select id="manual-reason" onchange="toggleManualOtherNote()">
                        <option value="">Seleccionar motivo...</option>
                        <option value="Codigo Borroso">C√≥digo Borroso</option>
                        <option value="Etiqueta Da√±ada">Etiqueta Da√±ada</option>
                        <option value="Error Surtido">Error Surtido</option>
                        <option value="Mercancia Reetiquetada">Mercanc√≠a Reetiquetada</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="input-group" id="manual-other-container" style="display: none;">
                    <label>Especificar motivo (obligatorio):</label>
                    <textarea id="manual-other-note" rows="3" placeholder="Describe el motivo..."></textarea>
                </div>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('manual')">Cancelar</button>
                <button class="btn btn-primary" onclick="submitManualCode()">Validar C√≥digo</button>
            </div>
        </div>
    </div>

    <div id="popup-reload-order" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--primary);">üì¶ ORDEN PARCIALMENTE VALIDADA</div>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>Orden:</strong> <span id="reload-obc"></span><br>
                <strong>Ya validadas:</strong> <span id="reload-validated"></span><br>
                <strong>Total:</strong> <span id="reload-total"></span><br>
                <strong>Pendientes:</strong> <span id="reload-pending"></span>
            </div>
            <p style="margin: 15px 0; color: #666;">Esta orden ya tiene validaciones previas. ¬øDeseas continuar donde se dej√≥?</p>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="cancelReloadOrder()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmReloadOrder()">Continuar Validaci√≥n</button>
            </div>
        </div>
    </div>

    <div id="popup-already-complete" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--success);">‚úÖ ORDEN YA COMPLETADA</div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin: 15px 0; text-align: center;">
                <div style="font-size: 1.8em; margin-bottom: 10px;">üéâ</div>
                <strong>Orden:</strong> <span id="complete-obc"></span><br>
                <strong>Validadas:</strong> <span id="complete-count"></span><br>
                <p style="margin-top: 10px; color: #666;">Esta orden ya fue validada al 100%</p>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="closePopup('already-complete')">Entendido</button>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        const CLIENT_ID = '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com';
        const SPREADSHEET_BD = '1nKqd0mqEkZ1l8wqW83_d5fyarp5BKbV1nXSNJBk4-Ck';
        const SPREADSHEET_WRITE = '1gU5yDb0R4_Mf1fE-lOA7vwYmTUBR0wV7EPGg5zUt2Xo';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile';
        
        let CURRENT_USER = '';
        let USER_EMAIL = '';
        let USER_GOOGLE_NAME = '';
        let LAST_BD_UPDATE = null;
        let BD_CODES = new Set();
        let OBC_MAP = new Map();
        let OBC_TOTALS = new Map();
        let OBC_INFO = new Map();
        let HISTORY = new Map();
        let PENDING_SYNC = [];
        let IS_ONLINE = navigator.onLine;
        let SYNC_INTERVAL = null;
        let STATE = {
            activeOBC: null,
            tabs: {},
            closedTabs: {}
        };
        let TOKEN_CLIENT, audioCtx;
        let SYNC_RETRY_COUNT = 0;
        let SYNC_IN_PROGRESS = false;
        let LAST_SYNC_ERROR = null;
        let lastScanned = null;
        let typingTimer = null;
        let scannerBuffer = '';
        let pendingReloadOBC = null;

        document.addEventListener('DOMContentLoaded', async () => {
            initAudio();
            await loadFromStorage();
            setupListeners();
            setupConnectionMonitor();
            SyncManager.init();  // Inicializa sync + protecci√≥n de salida
            loadPrerecData();   // Cargar datos de prerecepci√≥n
            renderValidation();
            gapi.load('client', initGAPI);
        });
        function initAudio() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.addEventListener('click', () => audioCtx.state === 'suspended' && audioCtx.resume(), { once: true });
            } catch (e) {}
        }

        function setupConnectionMonitor() {
            window.addEventListener('online', () => {
                IS_ONLINE = true;
                showConnectionBanner('online');
                showNotification('‚úÖ Conexi√≥n restaurada - Sincronizando datos...', 'success');
                updateConnectionIndicator();
                setTimeout(() => syncPendingData(), 1000);
            });

            window.addEventListener('offline', () => {
                IS_ONLINE = false;
                showConnectionBanner('offline');
                showNotification('‚ö†Ô∏è Sin conexi√≥n - Los datos se guardar√°n localmente', 'warning');
                updateSyncStatus(false);
                updateConnectionIndicator();
            });

            if (!IS_ONLINE) {
                showConnectionBanner('offline');
                updateSyncStatus(false);
            }
            updateConnectionIndicator();
        }
            
// ============================================================
        // SYNC MANAGER - Sistema Unificado de Sincronizaci√≥n
        // ============================================================
        const SyncManager = {
            // Configuraci√≥n
            AUTO_SYNC_INTERVAL: 3600000, // 1 hora
            BATCH_SIZE: 5,
            BATCH_DELAY: 200,
            SLOW_SYNC_DELAY: 2000,
            MAX_AUTO_RETRIES: 3,

            // Estado interno
            intervalId: null,
            inProgress: false,
            retryCount: 0,
            lastErrors: null,

            // ========== INICIALIZACI√ìN ==========
            init() {
                this.setupExitProtection();
                this.startAutoSync();
                console.log('‚úÖ SyncManager inicializado');
            },

            setupExitProtection() {
                window.addEventListener('beforeunload', (e) => {
                    const stats = this.getStats();
                    if (stats.pendingSync > 0 || (stats.activeOrders > 0 && this.isInValidationScreen())) {
                        e.preventDefault();
                        e.returnValue = '‚ö†Ô∏è Tienes datos sin sincronizar';
                        return e.returnValue;
                    }
                });
            },

            isInValidationScreen() {
                const el = document.getElementById('validation');
                return el && el.style.display === 'block';
            },

            // ========== ESTAD√çSTICAS ==========
            getStats() {
                let activeOrders = 0, totalValidations = 0;
                for (const obc in STATE.tabs) {
                    if (STATE.tabs[obc].validations?.length > 0) {
                        activeOrders++;
                        totalValidations += STATE.tabs[obc].validations.length;
                    }
                }
                return {
                    pendingSync: PENDING_SYNC.length,
                    activeOrders,
                    totalValidations,
                    isOnline: IS_ONLINE,
                    hasToken: !!(gapi?.client?.getToken()),
                    retryCount: this.retryCount,
                    inProgress: this.inProgress
                };
            },

            // ========== AUTO SYNC ==========
            startAutoSync() {
                if (this.intervalId) clearInterval(this.intervalId);
                this.intervalId = setInterval(() => {
                    if (IS_ONLINE && gapi?.client?.getToken() && PENDING_SYNC.length > 0) {
                        console.log('‚è∞ Auto-sync triggered');
                        this.sync(false);
                    }
                }, this.AUTO_SYNC_INTERVAL);
                SYNC_INTERVAL = this.intervalId;
            },

            // ========== SINCRONIZACI√ìN PRINCIPAL ==========
            async sync(showMessages = true) {
                if (this.inProgress) {
                    if (showMessages) showNotification('‚è≥ Sincronizaci√≥n en progreso...', 'info');
                    return { success: false, reason: 'in_progress' };
                }

                if (!IS_ONLINE) {
                    if (showMessages) showNotification('‚ö†Ô∏è Sin conexi√≥n a Internet', 'warning');
                    this.updateUI(false);
                    return { success: false, reason: 'offline' };
                }

                if (!gapi?.client?.getToken()) {
                    if (showMessages) showNotification('‚ö†Ô∏è No conectado a Google Sheets', 'warning');
                    this.updateUI(false);
                    return { success: false, reason: 'no_token' };
                }

                if (PENDING_SYNC.length === 0) {
                    this.updateUI(true);
                    if (showMessages) showNotification('‚úÖ Todo sincronizado', 'success');
                    return { success: true, synced: 0 };
                }

                return await this._doSync(showMessages);
            },

            async _doSync(showMessages, slow = false) {
                this.inProgress = true;
                SYNC_IN_PROGRESS = true;
                updateConnectionIndicator(true); // Mostrar "sincronizando"
                const total = PENDING_SYNC.length;
                if (showMessages) showNotification(`üîÑ Sincronizando ${total} pendientes...`, 'info');

                let success = 0, errors = [];
                const toRetry = [];
                const delay = slow ? this.SLOW_SYNC_DELAY : this.BATCH_DELAY;

                for (let i = 0; i < PENDING_SYNC.length; i++) {
                    const item = PENDING_SYNC[i];
                    try {
                        await writeToSheets(item.sheet, item.log);
                        success++;
                        if (slow && showMessages) {
                            showNotification(`‚úÖ ${success}/${total} sincronizado`, 'success');
                        }
                    } catch (e) {
                        toRetry.push(item);
                        errors.push({ code: item.log.code, error: e.message || 'Error' });
                    }
                    if (i < PENDING_SYNC.length - 1) {
                        await new Promise(r => setTimeout(r, delay));
                    }
                }

                PENDING_SYNC = toRetry;
                this.lastErrors = errors.length > 0 ? errors : null;
                LAST_SYNC_ERROR = this.lastErrors;
                await this.save();
                this.updateBadge();
                this.inProgress = false;
                SYNC_IN_PROGRESS = false;
                updateConnectionIndicator(false); // Restaurar indicador normal

                if (errors.length === 0) {
                    this.retryCount = 0;
                    SYNC_RETRY_COUNT = 0;
                    this.updateUI(true);
                    if (showMessages) showNotification(`‚úÖ ${success} sincronizadas correctamente`, 'success');
                    return { success: true, synced: success };
                } else {
                    this.retryCount++;
                    SYNC_RETRY_COUNT = this.retryCount;
                    this.updateUI(false);
                    if (showMessages) showNotification(`‚ö†Ô∏è ${success} OK, ${errors.length} fallaron`, 'warning');
                    return { success: false, synced: success, failed: errors.length };
                }
            },

            async syncSlow() {
                return await this._doSync(true, true);
            },

            // ========== STORAGE ==========
            async save() {
                try {
                    await window.storage.set('wms_pending_sync', JSON.stringify(PENDING_SYNC));
                } catch (e) {}
            },

            async load() {
                try {
                    const res = await window.storage.get('wms_pending_sync');
                    if (res?.value) {
                        PENDING_SYNC = JSON.parse(res.value);
                        this.updateBadge();
                    }
                } catch (e) {}
            },

            // ========== UI UPDATES ==========
            updateUI(synced) {
                const el = document.getElementById('sync-status-sidebar');
                const indicator = document.getElementById('status-sync');
                const label = document.getElementById('sync-label');
                const exportBtn = document.getElementById('export-pending-btn');
                if (!el) return;

                el.style.display = 'block';
                if (!IS_ONLINE) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `‚ö†Ô∏è Sin conexi√≥n${PENDING_SYNC.length > 0 ? ` (${PENDING_SYNC.length})` : ''}`;
                    if (indicator) indicator.className = 'status-indicator status-warning';
                    if (label) label.textContent = 'Sin conexi√≥n';
                } else if (PENDING_SYNC.length > 0) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `‚ö†Ô∏è ${PENDING_SYNC.length} pendientes`;
                    if (indicator) indicator.className = 'status-indicator status-warning';
                    if (label) label.textContent = `${PENDING_SYNC.length} pendientes`;
                } else if (synced) {
                    el.className = 'sync-status sync-ok';
                    el.textContent = '‚úÖ Sincronizado';
                    if (indicator) indicator.className = 'status-indicator status-ok';
                    if (label) label.textContent = 'Sincronizado';
                } else {
                    el.className = 'sync-status sync-error';
                    el.textContent = '‚ùå Error sync';
                    if (indicator) indicator.className = 'status-indicator status-error';
                    if (label) label.textContent = 'Error';
                }
                // Mostrar/ocultar bot√≥n de exportaci√≥n r√°pida
                if (exportBtn) {
                    exportBtn.style.display = PENDING_SYNC.length > 0 ? 'block' : 'none';
                }
                this.updateBadge();
            },

            updateBadge() {
                const badge = document.getElementById('pending-badge');
                if (badge) {
                    badge.textContent = PENDING_SYNC.length || '';
                    badge.style.display = PENDING_SYNC.length > 0 ? 'inline-block' : 'none';
                }
            },

            // ========== ACCIONES ==========
            async reconnectGoogle() {
                showNotification('üîÑ Reconectando...', 'info');
                if (gapi?.client?.getToken()) {
                    google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                    gapi.client.setToken(null);
                }
                setTimeout(() => TOKEN_CLIENT?.requestAccessToken(), 500);
            },

            exportPending() {
                // Solo exportar validaciones OK (Val3), excluir rechazos
                const validData = PENDING_SYNC.filter(item => item.sheet === 'Val3');
                if (validData.length === 0) {
                    showNotification('‚ö†Ô∏è No hay datos v√°lidos pendientes', 'warning');
                    return;
                }
                const rows = ['Fecha,Hora,Usuario,Orden,C√≥digo,Ubicaci√≥n,Nota'];
                validData.forEach(item => {
                    const l = item.log;
                    rows.push(`${l.date},${l.timestamp},${l.user},${l.obc},${l.code},${l.location || ''},${l.note || ''}`);
                });
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `backup_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
                showNotification(`üì• ${validData.length} registros exportados`, 'success');
            },

            // ========== PANEL UNIFICADO ==========
            showPanel() {
                document.querySelectorAll('.sync-panel-overlay').forEach(e => e.remove());
                const stats = this.getStats();
                const statusColor = stats.pendingSync === 0 ? 'var(--success)' : 'var(--warning)';

                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay sync-panel-overlay';
                overlay.style.display = 'flex';

                overlay.innerHTML = `
                    <div class="popup-content" style="max-width: 500px;">
                        <button class="popup-close-x" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                        <div class="popup-header" style="color: ${statusColor};">
                            ‚ö° ESTADO DEL SISTEMA
                        </div>

                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                                <div style="padding: 10px; background: white; border-radius: 6px;">
                                    <div style="font-size: 1.8em; font-weight: 700; color: ${stats.pendingSync > 0 ? 'var(--warning)' : 'var(--success)'};">${stats.pendingSync}</div>
                                    <div style="font-size: 0.8em; color: #666;">Pendientes</div>
                                </div>
                                <div style="padding: 10px; background: white; border-radius: 6px;">
                                    <div style="font-size: 1.8em; font-weight: 700; color: var(--primary);">${stats.activeOrders}</div>
                                    <div style="font-size: 0.8em; color: #666;">√ìrdenes activas</div>
                                </div>
                            </div>
                            <div style="margin-top: 12px; font-size: 0.85em; color: #555;">
                                ${stats.isOnline ? 'üü¢ En l√≠nea' : 'üî¥ Sin conexi√≥n'} ¬∑
                                ${stats.hasToken ? 'üü¢ Google OK' : 'üî¥ No conectado'} ¬∑
                                Reintentos: ${stats.retryCount}
                            </div>
                        </div>

                        ${stats.pendingSync > 0 ? `
                            <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid var(--warning);">
                                <strong>‚ö†Ô∏è ${stats.pendingSync} validaciones pendientes</strong><br>
                                <span style="font-size: 0.85em;">Los datos est√°n guardados localmente.</span>
                            </div>
                        ` : `
                            <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid var(--success);">
                                <strong>‚úÖ Todo sincronizado</strong>
                            </div>
                        `}

                        ${this.lastErrors ? `
                            <details style="margin-bottom: 15px;">
                                <summary style="cursor: pointer; color: var(--error); font-weight: 600;">‚ùå Ver √∫ltimos errores (${this.lastErrors.length})</summary>
                                <ul style="font-size: 0.8em; margin: 10px 0 0 20px; max-height: 100px; overflow-y: auto;">
                                    ${this.lastErrors.slice(0,5).map(e => `<li>${e.code}: ${e.error}</li>`).join('')}
                                </ul>
                            </details>
                        ` : ''}

                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${stats.pendingSync > 0 && stats.isOnline && stats.hasToken ? `
                                <button class="btn btn-primary" onclick="this.closest('.popup-overlay').remove(); SyncManager.sync();">
                                    üîÑ Sincronizar Ahora
                                </button>
                                <button class="btn btn-success" onclick="this.closest('.popup-overlay').remove(); SyncManager.syncSlow();">
                                    ‚è±Ô∏è Sync Lenta (m√°s segura)
                                </button>
                            ` : ''}
                            ${!stats.hasToken ? `
                                <button class="btn btn-google" onclick="this.closest('.popup-overlay').remove(); handleAuthClick();">
                                    üîó Conectar Google Sheets
                                </button>
                            ` : ''}
                            ${stats.pendingSync > 0 ? `
                                <button class="btn btn-warning" onclick="this.closest('.popup-overlay').remove(); SyncManager.exportPending();">
                                    üì• Exportar Respaldo
                                </button>
                            ` : ''}
                            <button class="btn btn-secondary" onclick="this.closest('.popup-overlay').remove();">
                                ‚Üê Cerrar
                            </button>
                        </div>

                        <p style="margin-top: 12px; text-align: center; font-size: 0.8em; color: #888;">
                            üí° Los datos se guardan localmente y se sincronizan autom√°ticamente cada hora
                        </p>
                    </div>
                `;
                document.body.appendChild(overlay);
            },

            // ========== SALIDA SEGURA ==========
            showExitDialog() {
                document.querySelectorAll('.safe-exit-overlay').forEach(e => e.remove());
                const stats = this.getStats();
                const canSync = stats.pendingSync > 0 && stats.isOnline && stats.hasToken;

                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay safe-exit-overlay';
                overlay.style.display = 'flex';

                overlay.innerHTML = `
                    <div class="popup-content" style="max-width: 450px;">
                        <button class="popup-close-x" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                        <div class="popup-header" style="color: var(--primary);">
                            üö™ Salida Segura
                        </div>

                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center;">
                            <div style="font-size: 0.9em; line-height: 1.8;">
                                üì¶ <strong>${stats.activeOrders}</strong> orden(es) activa(s)<br>
                                üìã <strong>${stats.totalValidations}</strong> validaciones<br>
                                ‚è≥ <strong>${stats.pendingSync}</strong> pendientes de sync<br>
                                ${stats.isOnline ? 'üü¢ En l√≠nea' : 'üî¥ Sin conexi√≥n'}
                            </div>
                        </div>

                        ${stats.pendingSync > 0 ? `
                            <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid var(--warning);">
                                <strong>‚ö†Ô∏è ${stats.pendingSync} sin sincronizar</strong><br>
                                <span style="font-size: 0.85em;">${canSync ? 'Se recomienda sincronizar antes de salir.' : 'Se sincronizar√°n autom√°ticamente.'}</span>
                            </div>
                        ` : ''}

                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${canSync ? `
                                <button id="sync-exit-btn" class="btn btn-success">
                                    üîÑ Sincronizar y Salir
                                </button>
                            ` : ''}
                            <button class="btn btn-secondary" onclick="showNotification('üíæ Datos guardados', 'success'); this.closest('.popup-overlay').remove();">
                                üíæ Guardar y Continuar
                            </button>
                            <button class="btn btn-primary" onclick="this.closest('.popup-overlay').remove();">
                                ‚Üê Volver
                            </button>
                        </div>

                        <p style="margin-top: 12px; text-align: center; font-size: 0.8em; color: #888;">
                            üí° Tus datos est√°n seguros localmente
                        </p>
                    </div>
                `;
                document.body.appendChild(overlay);

                const syncBtn = overlay.querySelector('#sync-exit-btn');
                if (syncBtn) {
                    syncBtn.addEventListener('click', async () => {
                        syncBtn.disabled = true;
                        syncBtn.innerHTML = 'üîÑ Sincronizando...';
                        const result = await this.sync();
                        if (result.success || PENDING_SYNC.length === 0) {
                            showNotification('‚úÖ Sincronizado', 'success');
                            overlay.remove();
                            for (const obc in STATE.tabs) STATE.closedTabs[obc] = STATE.tabs[obc];
                            STATE.tabs = {};
                            STATE.activeOBC = null;
                            saveState();
                            returnToDashboard();
                        } else {
                            syncBtn.disabled = false;
                            syncBtn.innerHTML = 'üîÑ Reintentar';
                            showNotification(`‚ö†Ô∏è ${PENDING_SYNC.length} pendientes a√∫n`, 'warning');
                        }
                    });
                }
            }
        };

        // Funciones de compatibilidad (para c√≥digo existente)
        function setupExitProtection() { /* Manejado por SyncManager */ }
        function startAutoSync() { /* Manejado por SyncManager */ }
        async function syncPendingData(isManual = false) { return await SyncManager.sync(true); }
        async function savePendingSync() { return await SyncManager.save(); }
        async function loadPendingSync() { return await SyncManager.load(); }
        function updatePendingBadge() { SyncManager.updateBadge(); }
        function updateSyncStatus(synced) { SyncManager.updateUI(synced); }
        function forceSync() { SyncManager.sync(); }
        function showSyncOptions() { SyncManager.showPanel(); }
        function showSyncDiagnostic() { SyncManager.showPanel(); }
        function showSyncRecoveryDialog() { SyncManager.showPanel(); }
        function showSafeExitDialog() { SyncManager.showExitDialog(); }
        function batchSyncWithDelay() { SyncManager.syncSlow(); }
        function retryConnection() { SyncManager.sync(); }
        function retryConnectionFull() { SyncManager.sync(); }
        function reconnectGoogleSheets() { SyncManager.reconnectGoogle(); }
        function exportPendingData() { SyncManager.exportPending(); }
        function addSafeExitButtonToSidebar() { /* Ya no es necesario */ }

        function showConnectionBanner(status) {
            const banner = document.getElementById('connection-banner');
            if (!banner) return;
            banner.className = `connection-banner ${status}`;
            banner.textContent = status === 'online'
                ? '‚úÖ Conexi√≥n restaurada'
                : '‚ùå Sin conexi√≥n - Modo offline';
            if (status === 'online') setTimeout(() => banner.style.display = 'none', 5000);
        }
    
            async function initGAPI() {
            try {
                await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: async (res) => {
                        if (res?.access_token) {
                            gapi.client.setToken(res);
                            await getUserProfile();
                            updateConnectionStatus(true);
                            updateSidebarAuthButton(true);  // Actualizar bot√≥n sidebar
                            updateConnectionIndicator();     // Actualizar indicador
                            loadDatabase();
                            await loadPendingSync();
                            if (PENDING_SYNC.length > 0) syncPendingData();
                        }
                    }
                });
            } catch (e) {
                showNotification('‚ùå Error al inicializar Google API', 'error');
            }
            }
    
            async function getUserProfile() {
                try {
                    const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                        headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` }
                    });
                    const data = await response.json();
                    USER_EMAIL = data.email || '';
                    USER_GOOGLE_NAME = data.name || 'Usuario';

                    // Verificar si hay alias guardado para este email
                    const savedAlias = localStorage.getItem(`wms_alias_${USER_EMAIL}`);
                    if (savedAlias) {
                        CURRENT_USER = savedAlias;
                        showNotification(`‚úÖ Bienvenido, ${CURRENT_USER}`, 'success');
                        updateUserFooter();
                    } else {
                        // Primera vez - mostrar popup de alias
                        showAliasPopup();
                    }
                } catch (e) {
                    CURRENT_USER = 'Usuario';
                    updateUserFooter();
                }
            }

            function showAliasPopup() {
                document.querySelectorAll('.alias-popup-overlay').forEach(e => e.remove());

                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay alias-popup-overlay';
                overlay.style.display = 'flex';

                overlay.innerHTML = `
                    <div class="popup-content" style="max-width: 400px;">
                        <div class="popup-header" style="color: var(--primary);">
                            üë§ Configura tu Nombre
                        </div>

                        <div style="text-align: center; margin: 20px 0;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary); margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 1.8em; color: white;">
                                ${USER_GOOGLE_NAME.charAt(0).toUpperCase()}
                            </div>
                            <p style="color: #666; font-size: 0.9em;">${USER_EMAIL}</p>
                        </div>

                        <p style="margin-bottom: 15px; text-align: center;">
                            ¬øC√≥mo quieres que te identifiquemos en el sistema?
                        </p>

                        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="saveUserAlias('${USER_GOOGLE_NAME}', true)">
                                ‚úÖ Usar mi nombre: ${USER_GOOGLE_NAME}
                            </button>

                            <div style="text-align: center; color: #999; font-size: 0.85em;">o</div>

                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="alias-input" placeholder="Escribe un alias..."
                                    style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em;"
                                    maxlength="20">
                                <button class="btn btn-success" onclick="saveUserAlias(document.getElementById('alias-input').value)" style="width: auto;">
                                    üíæ
                                </button>
                            </div>
                        </div>

                        <p style="text-align: center; font-size: 0.8em; color: #888;">
                            üí° Puedes cambiar esto m√°s tarde desde el panel de usuario
                        </p>
                    </div>
                `;

                document.body.appendChild(overlay);

                // Focus en el input y enter para guardar
                const input = overlay.querySelector('#alias-input');
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && input.value.trim()) {
                        saveUserAlias(input.value);
                    }
                });
            }

            function saveUserAlias(alias, isGoogleName = false) {
                const finalAlias = alias?.trim() || USER_GOOGLE_NAME;
                if (!finalAlias) {
                    showNotification('‚ö†Ô∏è Ingresa un nombre v√°lido', 'warning');
                    return;
                }

                CURRENT_USER = finalAlias;
                localStorage.setItem(`wms_alias_${USER_EMAIL}`, finalAlias);

                document.querySelectorAll('.alias-popup-overlay').forEach(e => e.remove());
                showNotification(`‚úÖ ${isGoogleName ? 'Nombre' : 'Alias'} guardado: ${finalAlias}`, 'success');
                updateUserFooter();
            }

            function changeUserAlias() {
                showAliasPopup();
            }

            function updateUserFooter() {
                const avatar = document.getElementById('user-avatar');
                const nameDisplay = document.getElementById('user-name-display');

                if (avatar) {
                    avatar.textContent = CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : '?';
                    avatar.title = USER_EMAIL || 'No conectado';
                    avatar.style.cursor = 'pointer';
                    avatar.onclick = changeUserAlias;
                }
                if (nameDisplay) {
                    nameDisplay.textContent = CURRENT_USER || 'No conectado';
                    nameDisplay.title = `Click para cambiar alias\n${USER_EMAIL}`;
                    nameDisplay.style.cursor = 'pointer';
                    nameDisplay.onclick = changeUserAlias;
                }

                updateConnectionIndicator();
            }

            function updateConnectionIndicator(syncing = false) {
                const dot = document.getElementById('connection-dot');
                const text = document.getElementById('connection-text');

                if (!dot || !text) return;

                if (syncing) {
                    dot.className = 'connection-dot syncing';
                    text.textContent = 'Sincronizando...';
                } else if (IS_ONLINE) {
                    dot.className = 'connection-dot online';
                    text.textContent = 'Online';
                } else {
                    dot.className = 'connection-dot offline';
                    text.textContent = 'Offline';
                }
            }

            function updateBdInfo() {
                const countEl = document.getElementById('bd-count-sidebar');
                const timeEl = document.getElementById('bd-update-time');

                if (countEl) countEl.textContent = BD_CODES.size.toLocaleString();
                if (timeEl) {
                    if (LAST_BD_UPDATE) {
                        const time = new Date(LAST_BD_UPDATE).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                        timeEl.textContent = `Actualizado: ${time}`;
                    } else {
                        timeEl.textContent = 'Sin actualizar';
                    }
                }
            }
    
            async function loadFromStorage() {
            try {
                const stateRes = await window.storage.get('wms_state');
                if (stateRes?.value) {
                    const loaded = JSON.parse(stateRes.value);
                    STATE.tabs = loaded.tabs || {};
                    STATE.closedTabs = loaded.closedTabs || {};
                    STATE.activeOBC = loaded.activeOBC;
                }
                
                const bdRes = await window.storage.get('wms_bd');
                if (bdRes?.value) {
                    const cached = JSON.parse(bdRes.value);
                    BD_CODES = new Set(cached.codes);
                    OBC_MAP = new Map(cached.obcMap?.map(([k, v]) => [k, new Set(v)]));
                    OBC_TOTALS = new Map(cached.totals);
                    OBC_INFO = new Map(cached.info);
                    updateDashboardStats();
                }

                const histRes = await window.storage.get('wms_history');
                if (histRes?.value) {
                    const cached = JSON.parse(histRes.value);
                    HISTORY = new Map(cached.history);
                }

                await loadPendingSync();
            } catch (e) {}
            }
    
            async function saveState() {
            try {
                await window.storage.set('wms_state', JSON.stringify(STATE));
            } catch (e) {}
            }
    
            async function saveBD() {
            try {
                await window.storage.set('wms_bd', JSON.stringify({
                    codes: Array.from(BD_CODES),
                    obcMap: Array.from(OBC_MAP.entries()).map(([k, v]) => [k, Array.from(v)]),
                    totals: Array.from(OBC_TOTALS.entries()),
                    info: Array.from(OBC_INFO.entries())
                }));
            } catch (e) {}
            }
    
            async function saveHistory() {
            try {
                await window.storage.set('wms_history', JSON.stringify({
                    history: Array.from(HISTORY.entries())
                }));
            } catch (e) {}
            }
    
            function handleAuthClick() {
                if (gapi.client.getToken()) {
                    google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {
                        gapi.client.setToken(null);
                        updateConnectionStatus(false);
                        updateSidebarAuthButton(false);
                        showNotification('üîì Sesi√≥n cerrada', 'info');
                    });
                } else {
                    TOKEN_CLIENT.requestAccessToken();
                }
            }

            // Funci√≥n robusta para conectar/desconectar desde el sidebar
            function toggleGoogleConnection() {
                const hasToken = gapi?.client?.getToken();

                if (hasToken) {
                    // Desconectar
                    showNotification('üîÑ Cerrando sesi√≥n...', 'info');
                    google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {
                        gapi.client.setToken(null);
                        updateConnectionStatus(false);
                        updateSidebarAuthButton(false);
                        updateUserFooterDisconnected();
                        showNotification('üîì Sesi√≥n cerrada', 'info');
                    });
                } else {
                    // Conectar - igual que el bot√≥n del dashboard
                    showNotification('üîÑ Conectando con Google...', 'info');
                    try {
                        TOKEN_CLIENT.requestAccessToken();
                    } catch (e) {
                        showNotification('‚ùå Error al conectar. Intenta de nuevo.', 'error');
                        console.error('Error conectando:', e);
                    }
                }
            }

            // Actualizar bot√≥n del sidebar seg√∫n estado de conexi√≥n
            function updateSidebarAuthButton(connected) {
                const btn = document.getElementById('sidebar-auth-btn');
                if (btn) {
                    btn.innerHTML = connected ? 'üö™ Salir' : 'üîó Conectar';
                    btn.title = connected ? 'Cerrar sesi√≥n de Google' : 'Conectar con Google';
                }
            }

            // Actualizar footer cuando se desconecta
            function updateUserFooterDisconnected() {
                const avatar = document.getElementById('user-avatar');
                const nameDisplay = document.getElementById('user-name-display');

                if (avatar) {
                    avatar.textContent = '?';
                    avatar.style.cursor = 'default';
                    avatar.onclick = null;
                }
                if (nameDisplay) {
                    nameDisplay.textContent = 'No conectado';
                    nameDisplay.style.cursor = 'default';
                    nameDisplay.onclick = null;
                }

                CURRENT_USER = '';
                USER_EMAIL = '';
                updateConnectionIndicator();
            }

            // Funci√≥n robusta para recargar BD
            async function reloadBD() {
                if (!gapi?.client?.getToken()) {
                    showNotification('‚ö†Ô∏è Primero conecta con Google', 'warning');
                    // Ofrecer conectar autom√°ticamente
                    if (confirm('¬øDeseas conectar con Google ahora?')) {
                        toggleGoogleConnection();
                    }
                    return;
                }

                if (!IS_ONLINE) {
                    showNotification('‚ö†Ô∏è Sin conexi√≥n a Internet', 'warning');
                    return;
                }

                showNotification('üîÑ Recargando base de datos...', 'info');

                try {
                    await loadDatabase();
                } catch (e) {
                    showNotification('‚ùå Error al recargar BD', 'error');
                    console.error('Error recargando BD:', e);
                }
            }
    
            function updateConnectionStatus(connected) {
            document.getElementById('status-conn').className = `status-indicator ${connected ? 'status-ok' : 'status-error'}`;
            document.getElementById('conn-label').textContent = connected ? 'Conectado' : 'Desconectado';
            document.getElementById('connect-btn').textContent = connected ? 'üîì Cerrar Sesi√≥n' : 'üîó Conectar';
            document.getElementById('load-bd-btn').style.display = connected ? 'block' : 'none';
            updateStartButton();
            updateSyncStatus(connected);
            }
    
            // Funci√≥n unificada - siempre se basa en el estado REAL
            function updateSyncStatus(synced) {
                const syncEl = document.getElementById('sync-status-sidebar');
                const statusIndicator = document.getElementById('status-sync');
                const statusLabel = document.getElementById('sync-label');
                const pendingBadge = document.getElementById('pending-badge');
                const exportBtn = document.getElementById('export-pending-btn');
                const hasToken = gapi?.client?.getToken();

                if (!syncEl) return;
                syncEl.style.display = 'block';

                // Determinar estado REAL basado en conexi√≥n y pendientes
                const isConnected = IS_ONLINE && hasToken;
                const hasPending = PENDING_SYNC.length > 0;

                if (!IS_ONLINE) {
                    // Sin internet
                    syncEl.className = 'sync-status sync-warning';
                    syncEl.innerHTML = `‚ö†Ô∏è Sin conexi√≥n${hasPending ? ` (${PENDING_SYNC.length})` : ''}`;
                    if (statusIndicator) statusIndicator.className = 'status-indicator status-warning';
                    if (statusLabel) statusLabel.textContent = 'Offline';
                } else if (!hasToken) {
                    // Sin conexi√≥n a Google
                    syncEl.className = 'sync-status sync-warning';
                    syncEl.textContent = '‚ö†Ô∏è No conectado';
                    if (statusIndicator) statusIndicator.className = 'status-indicator status-warning';
                    if (statusLabel) statusLabel.textContent = 'No conectado';
                } else if (hasPending) {
                    // Hay pendientes
                    syncEl.className = 'sync-status sync-warning';
                    syncEl.innerHTML = `‚ö†Ô∏è ${PENDING_SYNC.length} pendientes`;
                    if (statusIndicator) statusIndicator.className = 'status-indicator status-warning';
                    if (statusLabel) statusLabel.textContent = `${PENDING_SYNC.length} pendientes`;
                } else {
                    // Todo sincronizado
                    syncEl.className = 'sync-status sync-ok';
                    syncEl.textContent = '‚úÖ Sincronizado';
                    if (statusIndicator) statusIndicator.className = 'status-indicator status-ok';
                    if (statusLabel) statusLabel.textContent = 'Sincronizado';
                }

                // Actualizar badge y bot√≥n de exportar
                if (pendingBadge) {
                    pendingBadge.textContent = hasPending ? PENDING_SYNC.length : '';
                    pendingBadge.style.display = hasPending ? 'inline-block' : 'none';
                }
                if (exportBtn) {
                    exportBtn.style.display = hasPending ? 'block' : 'none';
                }
            }
    
            function updateStartButton() {
            const canStart = gapi.client.getToken() && BD_CODES.size > 0;
            document.getElementById('start-btn').disabled = !canStart;
            }
    
            async function loadDatabase() {
            if (!gapi.client.getToken()) {
                showNotification('‚ö†Ô∏è Conecta primero con Google Sheets', 'warning');
                return;
            }

            if (!IS_ONLINE) {
                showNotification('‚ö†Ô∏è Sin conexi√≥n a Internet', 'warning');
                return;
            }

            showNotification('üîÑ Cargando base de datos...', 'info');
            
            try {
                const resRes = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_BD,
                    range: 'Resumen!A:F'
                });

                const resRows = resRes.result.values;
                if (resRows?.length > 1) {
                    OBC_TOTALS.clear();
                    OBC_INFO.clear();

                    for (let i = 1; i < resRows.length; i++) {
                        const [obc, ref, referenceId, time, recipient, count] = resRows[i];
                        if (obc && count) {
                            OBC_TOTALS.set(obc, parseInt(count));
                            OBC_INFO.set(obc, { recipient, arrivalTime: time, referenceOrder: ref, referenceId: referenceId || '' });
                        }
                    }
                }

                const sheets = ['BD', 'Outbound_Âá∫Â∫ìÂçï', 'Sheet1'];
                for (const sheet of sheets) {
                    try {
                        const codesRes = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: SPREADSHEET_BD,
                            range: `${sheet}!A:J`
                        });

                        const rows = codesRes.result.values;
                        if (rows?.length > 1) {
                            BD_CODES.clear();
                            OBC_MAP.clear();

                            for (let i = 1; i < rows.length; i++) {
                                const obc = rows[i][0]?.toString().trim();
                                const concat = rows[i][9]?.toString().trim(); // Column J (index 9) - moved from I due to new column D
                                if (obc && concat) {
                                    const norm = normalizeCode(concat);
                                    BD_CODES.add(norm);
                                    if (!OBC_MAP.has(obc)) OBC_MAP.set(obc, new Set());
                                    OBC_MAP.get(obc).add(norm);
                                }
                            }

                            await saveBD();
                            break;
                        }
                    } catch (e) {}
                }

                try {
                    const histRes = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_WRITE,
                        range: 'Val3!A:G'
                    });

                    const histRows = histRes.result.values;
                    if (histRows?.length > 1) {
                        HISTORY.clear();
                        
                        for (let i = 1; i < histRows.length; i++) {
                            const [date, timestamp, user, obc, code, location, note] = histRows[i];
                            if (code && obc) {
                                const key = `${normalizeCode(code)}_${obc.toLowerCase()}`;
                                HISTORY.set(key, {
                                    user: user || 'Usuario',
                                    timestamp: timestamp || '',
                                    date: date || '',
                                    obc: obc
                                });
                            }
                        }
                        
                        await saveHistory();
                        showNotification(`üìö Historial cargado: ${HISTORY.size} validaciones`, 'info');
                    }
                } catch (e) {
                    console.error('Error loading history:', e);
                }
                
                updateDashboardStats();
                document.getElementById('status-bd').className = 'status-indicator status-ok';
                document.getElementById('bd-label').textContent = 'Cargada';
                updateStartButton();
                showNotification(`‚úÖ BD cargada: ${BD_CODES.size} c√≥digos en ${OBC_TOTALS.size} √≥rdenes`, 'success');
                playSound('ok');
                updateSyncStatus(true);

                // Actualizar timestamp y footer
                LAST_BD_UPDATE = Date.now();
                updateBdInfo();
            } catch (err) {
                showNotification('‚ùå Error al cargar BD', 'error');
                console.error(err);
                updateSyncStatus(false);
            }
        }

        async function forceSync() {
            if (!gapi.client.getToken()) {
                showNotification('‚ö†Ô∏è No hay conexi√≥n con Google Sheets', 'warning');
                updateSyncStatus(false);
                return;
            }
        
            if (!IS_ONLINE) {
                showNotification('‚ö†Ô∏è Sin conexi√≥n a Internet - Modo offline', 'warning');
                // Mostrar di√°logo de diagn√≥stico
                showNetworkDiagnosticDialog();
                return;
            }
        
            showNotification('üîÑ Sincronizando...', 'info');
            
            try {
                await loadDatabase();
                await syncPendingData(true); // true = manual retry
                updateSyncStatus(PENDING_SYNC.length === 0);
                if (PENDING_SYNC.length === 0) {
                    showNotification('‚úÖ Sincronizaci√≥n completada', 'success');
                    SYNC_RETRY_COUNT = 0;
                }
            } catch (e) {
                updateSyncStatus(false);
                showNotification('‚ùå Error en sincronizaci√≥n', 'error');
                console.error('Sync error:', e);
                // Mostrar opciones de recuperaci√≥n
                showSyncRecoveryDialog(PENDING_SYNC.length);
            }
        }

        function updateDashboardStats() {
            document.getElementById('dash-bd').textContent = BD_CODES.size.toLocaleString();
            document.getElementById('bd-count-sidebar').textContent = BD_CODES.size.toLocaleString();
            document.getElementById('dash-orders').textContent = OBC_TOTALS.size || '-';
            
            let totalValidated = 0;
            for (const obc in STATE.tabs) {
                totalValidated += STATE.tabs[obc].validations.length;
            }
            document.getElementById('dash-validated').textContent = totalValidated || '-';
        }

        function showUserStats() {
            const allOrders = STATE.tabs;
            const userStats = {};
            let total = 0;

            for (const obc in allOrders) {
                allOrders[obc].validations.forEach(val => {
                    const user = val.user || 'Usuario';
                    if (!userStats[user]) userStats[user] = 0;
                    userStats[user]++;
                    total++;
                });
            }

            const sortedUsers = Object.entries(userStats).sort((a, b) => b[1] - a[1]);
            const content = document.getElementById('user-stats-content');
            content.innerHTML = '';

            if (sortedUsers.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No hay validaciones registradas hoy</p>';
            } else {
                sortedUsers.forEach(([user, count]) => {
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                    const div = document.createElement('div');
                    div.className = 'user-stat-item';
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <div class="user-stat-name">${user}</div>
                                <div style="color: #666; font-size: 0.9em;">${percentage}% del total</div>
                            </div>
                            <div class="user-stat-count">${count}</div>
                        </div>
                        <div style="background: #e0e0e0; height: 8px; border-radius: 4px;">
                            <div class="user-stat-bar" style="width: ${percentage}%"></div>
                        </div>
                    `;
                    content.appendChild(div);
                });

                const totalDiv = document.createElement('div');
                totalDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; text-align: center; font-weight: 700;';
                totalDiv.innerHTML = `Total del d√≠a: <span style="color: var(--primary); font-size: 1.5em;">${total}</span> cajas`;
                content.appendChild(totalDiv);
            }

            document.getElementById('user-stats-popup').classList.add('active');
            document.getElementById('user-stats-overlay').classList.add('active');
        }

        function closeUserStats() {
            document.getElementById('user-stats-popup').classList.remove('active');
            document.getElementById('user-stats-overlay').classList.remove('active');
        }

        // --------------------------------------
        // extractCode (versi√≥n final corregida)
        // --------------------------------------
        function extractCode(raw) {
            if (raw === null || raw === undefined) return '';
            let code = String(raw).trim();

            // Remover caracteres invisibles
            code = code.replace(/[\u0000-\u001F\u007F-\u009F\u200B-\u200F\uFEFF]/g, '').trim();

            // IMPORTANTE: Convertir *, & y - (entre n√∫meros) a / ANTES de cualquier extracci√≥n
            code = code.replace(/\*/g, '/');
            code = code.replace(/&/g, '/');
            code = code.replace(/(\d)-(\d)/g, '$1/$2'); // 37843434-1 ‚Üí 37843434/1

            // Normalizar comillas raras
            code = code.replace(/[""¬´¬ª‚Äû‚Äü‚Äö‚Äõ''¬®]/g, '"');

            // Eliminar caracteres intermedios problem√°ticos como √±[, ?
            // que aparecen entre delimitadores
            code = code.replace(/√±\[/g, '');
            code = code.replace(/\?/g, '');

            // 1) Intento de extraer JSON v√°lido dentro del texto
            try {
                const first = (() => {
                    const a = code.indexOf('{');
                    const b = code.indexOf('[');
                    const aa = a !== -1 ? a : Infinity;
                    const bb = b !== -1 ? b : Infinity;
                    return Math.min(aa, bb);
                })();

                const last = Math.max(code.lastIndexOf('}'), code.lastIndexOf(']'));

                let candidate = code;
                if (first !== Infinity && last > first) {
                    candidate = code.slice(first, last + 1);
                }

                const parsed = JSON.parse(candidate);

                function findKey(obj) {
                    if (!obj) return null;

                    if (typeof obj === 'string' || typeof obj === 'number') return null;

                    if (Array.isArray(obj)) {
                        for (const item of obj) {
                            const r = findKey(item);
                            if (r) return r;
                        }
                        return null;
                    }

                    if (typeof obj === 'object') {
                        for (const k of Object.keys(obj)) {
                            const val = obj[k];
                            const kl = k.toLowerCase();
                            if (['id', 'codigo', 'code', 'cod'].includes(kl)) {
                                if (typeof val === 'string' || typeof val === 'number') {
                                    return String(val).trim();
                                }
                            }
                        }
                        // B√∫squeda profunda
                        for (const k of Object.keys(obj)) {
                            const r = findKey(obj[k]);
                            if (r) return r;
                        }
                    }
                    return null;
                }
                const found = findKey(parsed);
                if (found) return found;

            } catch (e) {
            }

            const patterns = [
                // [id[ CODE [ - Prioridad alta: formato con slash (49987997/1)
                /\[id\[\s*([A-Za-z0-9]+\/[A-Za-z0-9\/\-\._:]+)\s*\[/i,

                // [id[ CODE [ - formato general
                /\[id\[\s*([A-Za-z0-9\/\-\._:]{3,})\s*\[/i,

                // "id": "CODE" o "id" CODE
                /(?:"|["'])?id(?:"|["'])?\s*[:=]?\s*["']?([A-Za-z0-9]+\/[A-Za-z0-9\/\-\._:]+)["']?/i,
                /(?:"|["'])?id(?:"|["'])?\s*[:=]?\s*["']?([A-Za-z0-9\/\-\._:]{3,})["']?/i,

                // id = CODE
                /\bid\s*[:=]\s*([A-Za-z0-9]+\/[A-Za-z0-9\/\-\._:]+)/i,
                /\bid\s*[:=]\s*([A-Za-z0-9\/\-\._:]{3,})/i,

                // Formatos con slash ABC/123 (alta prioridad)
                /([0-9]+\/[0-9]+)/,
                /([A-Za-z0-9]{2,}\/[A-Za-z0-9\/\-\._:]{1,})/,

                // Cualquier token alfanum√©rico largo dentro de texto
                /.*?([A-Za-z0-9]{6,}).*/,

                // Super fallback: n√∫meros largos (000123456)
                /([0-9]{6,})/
            ];

            for (const p of patterns) {
                const m = code.match(p);
                if (m && m[1]) return m[1].trim();
            }

            return code.trim();
        }

        function normalizeCode(code) {
            if (!code) return '';
        
            return String(code)
                .replace(/&/g, '/')   // nuevo: convertir & ‚Üí /
                .replace(/-/g, '/')   // ya estaba
                .toLowerCase()
                .trim();
        }

        function setupListeners() {
            const scanner = document.getElementById('scanner');
            const location = document.getElementById('location-input');
            
            scanner.addEventListener('input', (e) => {
                clearTimeout(typingTimer);
                scannerBuffer = e.target.value;
                typingTimer = setTimeout(() => {
                    if (scanner.value.length > 0 && scanner.value.length < 15) {
                        showMiniAlert('‚ö†Ô∏è Use solo escaneo o bot√≥n Manual');
                        scanner.value = '';
                        scannerBuffer = '';
                    }
                }, 500);
            });
            
            scanner.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && scanner.value.trim()) {
                    e.preventDefault();
                    clearTimeout(typingTimer);
                    if (!STATE.activeOBC) {
                        showNotification('‚ö†Ô∏è Crea una orden primero', 'warning');
                        playSound('error');
                        scanner.value = '';
                        return;
                    }
                    processScan(scanner.value.trim(), false);
                    scanner.value = '';
                    scannerBuffer = '';
                }
            });
            
            location.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    scanner.focus();
                }
            });
        }

        function showMiniAlert(message) {
            const alert = document.createElement('div');
            alert.className = 'mini-alert';
            alert.textContent = message;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 400);
        }

        async function processScan(raw, isManual = false) {
            if (BD_CODES.size === 0) {
                showNotification('‚ö†Ô∏è Carga la BD primero', 'warning');
                playSound('error');
                return;
            }

            const activeOBC = STATE.activeOBC;
            if (!activeOBC) {
                showNotification('‚ö†Ô∏è Crea una orden primero', 'warning');
                playSound('error');
                return;
            }

            const tab = STATE.tabs[activeOBC];
            if (tab.completed) {
                showNotification('‚ö†Ô∏è Esta orden ya est√° completada', 'warning');
                playSound('error');
                return;
            }
            
            const extracted = extractCode(raw);
            const normalized = normalizeCode(extracted);
            const concatenated = normalized + activeOBC.toLowerCase();
            
            if (!BD_CODES.has(concatenated)) {
                await handleRejection('NO_EXISTE_EN_BD', raw, normalized, activeOBC);
                return;
            }

            const histKey = concatenated;
            if (HISTORY.has(histKey)) {
                const histData = HISTORY.get(histKey);
                lastScanned = { raw, code: normalized, obc: activeOBC, location: tab.location, isManual, histData };
                showPopup('history', normalized, histData);
                playSound('duplicate');
                return;
            }
            
            const isDup = tab.validations.find(v => v.code === normalized);
            if (isDup) {
                lastScanned = { raw, code: normalized, obc: activeOBC, location: tab.location, duplicate: isDup, isManual };
                showPopup('dup', normalized, isDup);
                playSound('duplicate');
                return;
            }
            
            await handleValidationOK(raw, normalized, activeOBC, tab.location, '', isManual);
        }

        async function handleValidationOK(raw, code, obc, location, note = '', isManual = false) {
            const tab = STATE.tabs[obc];
            const now = new Date();
            const finalNote = isManual && note ? `Codigo Escrito Manualmente: ${note}` : note;
            
            const log = {
                id: now.getTime(),
                timestamp: now.toLocaleTimeString('es-MX'),
                date: new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 10),
                user: CURRENT_USER, obc, raw, code, location, note: finalNote
            };
            
            tab.validations.unshift(log);
            
            const histKey = `${code}_${obc.toLowerCase()}`;
            HISTORY.set(histKey, {
                user: CURRENT_USER,
                timestamp: log.timestamp,
                date: log.date,
                obc: obc
            });
            await saveHistory();
            
            playSound('ok');
            flashInput('success');
            
            const total = OBC_TOTALS.get(obc) || 0;
            if (tab.validations.length >= total && total > 0) {
                tab.completed = true;
                showOrderCompleted(obc);
            }
            
            renderValidation();
            await saveState();
            
            if (gapi.client.getToken() && IS_ONLINE) {
                try {
                    await writeToSheets('Val3', log);
                    updateSyncStatus(true);
                } catch (e) {
                    PENDING_SYNC.push({ sheet: 'Val3', log });
                    await savePendingSync();
                    updatePendingBadge();
                    updateSyncStatus(false);
                    showNotification('‚ö†Ô∏è Guardado localmente - Se sincronizar√° cuando haya conexi√≥n', 'warning');
                }
            } else {
                PENDING_SYNC.push({ sheet: 'Val3', log });
                await savePendingSync();
                updatePendingBadge();
                updateSyncStatus(false);
            }
        }

        async function handleRejection(reason, raw, code, obc) {
            const tab = STATE.tabs[obc];
            const now = new Date();
            
            const log = {
                id: now.getTime(),
                timestamp: now.toLocaleTimeString('es-MX'),
                date: new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 10),
                user: CURRENT_USER, obc, raw, code, reason
            };
            
            tab.rejections.unshift(log);
            playSound('error');
            flashInput('error');
            showPopup('error', code, reason);
            renderValidation();
            await saveState();
            
            if (gapi.client.getToken() && IS_ONLINE) {
                try {
                    await writeToSheets('Validaciones_RECHAZADAS', log);
                } catch (e) {
                    PENDING_SYNC.push({ sheet: 'Validaciones_RECHAZADAS', log });
                    await savePendingSync();
                    updatePendingBadge();
                }
            } else {
                PENDING_SYNC.push({ sheet: 'Validaciones_RECHAZADAS', log });
                await savePendingSync();
                updatePendingBadge();
            }
        }

        async function writeToSheets(sheet, log) {
            let values;
            if (sheet === 'Val3') {
                values = [[log.date, log.timestamp, log.user, log.obc, log.code, log.location, log.note]];
            } else if (sheet === 'Previa') {
                // Prerecepci√≥n: Fecha, Hora, Orden, Ubicaci√≥n
                values = [[log.date, log.timestamp, log.obc, log.location]];
            } else {
                // Rechazos
                values = [[log.date, log.timestamp, log.user, log.obc, log.raw, log.reason, log.code]];
            }

            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: SPREADSHEET_WRITE,
                range: `${sheet}!A1`,
                valueInputOption: 'USER_ENTERED',
                insertDataOption: 'INSERT_ROWS',
                resource: { values }
            });
        }

        function renderValidation() {
            const activeOBC = STATE.activeOBC;
            const hasOrders = Object.keys(STATE.tabs).length > 0;
            
            document.getElementById('empty-state').style.display = hasOrders ? 'none' : 'block';
            document.getElementById('validation-content').style.display = hasOrders ? 'block' : 'none';
            
            if (!hasOrders) {
                updateSidebar();
                return;
            }
            
            const tab = STATE.tabs[activeOBC];
            const total = OBC_TOTALS.get(activeOBC) || 0;
            const scanned = tab.validations.length;
            const remaining = Math.max(0, total - scanned);
            const pct = total > 0 ? Math.min(100, (scanned / total) * 100) : 0;
            const isCompleted = tab.completed;
            
            const progressCard = document.querySelector('.progress-card');
            const progressBar = document.getElementById('prog-bar');
            if (isCompleted) {
                progressCard.classList.add('completed');
                progressBar.classList.add('completed');
            } else {
                progressCard.classList.remove('completed');
                progressBar.classList.remove('completed');
            }
            
            document.getElementById('prog-obc').textContent = activeOBC;
            document.getElementById('prog-pct').textContent = `${pct.toFixed(0)}%`;
            document.getElementById('prog-scan').textContent = scanned;
            document.getElementById('prog-total').textContent = total;
            document.getElementById('prog-rest').textContent = remaining;
            document.getElementById('prog-bar').style.width = `${pct}%`;
            
            const rejected = tab.rejections.filter(r => r.reason === 'NO_EXISTE_EN_BD').length;
            document.getElementById('stat-ok').textContent = scanned;
            document.getElementById('stat-error').textContent = rejected;
            
            const tabBar = document.getElementById('tab-bar');
            tabBar.innerHTML = '';
            Object.keys(STATE.tabs).forEach(obc => {
                const t = document.createElement('div');
                const tabData = STATE.tabs[obc];
                t.className = `tab ${obc === activeOBC ? 'active' : ''} ${tabData.completed ? 'completed' : ''}`;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = obc;
                nameSpan.onclick = () => switchOBC(obc);
                t.appendChild(nameSpan);
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'tab-close';
                closeBtn.innerHTML = '√ó';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    closeTab(obc);
                };
                t.appendChild(closeBtn);
                tabBar.appendChild(t);
            });
            
            const newTab = document.createElement('div');
            newTab.className = 'tab new-tab';
            newTab.textContent = '+ Nueva Orden';
            newTab.onclick = addOBC;
            tabBar.appendChild(newTab);
            
            const info = OBC_INFO.get(activeOBC) || {};
            document.getElementById('obc-display').value = activeOBC;
            document.getElementById('recipient-display').value = info.recipient || '-';
            document.getElementById('time-display').value = info.arrivalTime || '-';
            document.getElementById('location-input').value = tab.location;
            
            const scanner = document.getElementById('scanner');
            scanner.disabled = isCompleted;
            scanner.placeholder = isCompleted ? '‚úÖ Orden completada' : 'Escanea aqu√≠...';
            
            const okList = document.getElementById('log-ok');
            const rejectList = document.getElementById('log-reject');
            okList.innerHTML = '';
            rejectList.innerHTML = '';
            
            tab.validations.forEach(log => {
                const li = document.createElement('li');
                li.className = 'log-item log-ok';
                li.innerHTML = `<div class="log-info"><div class="log-code">${log.code}</div><div class="log-meta">${log.timestamp} ‚Ä¢ ${log.location || '-'}</div></div>`;
                okList.appendChild(li);
            });

            tab.rejections.forEach(log => {
                const li = document.createElement('li');
                li.className = 'log-item log-reject';
                li.innerHTML = `<div class="log-info"><div class="log-code">${log.code}</div><div class="log-meta">${log.timestamp} ‚Ä¢ ${log.reason}</div></div>`;
                rejectList.appendChild(li);
            });
            
            updateSidebar();
            updateDashboardStats();
        }

        function updateSidebar() {
            const obcList = document.getElementById('obc-list');
            obcList.innerHTML = '';
            
            Object.keys(STATE.tabs).forEach(obc => {
                const tab = STATE.tabs[obc];
                const total = OBC_TOTALS.get(obc) || 0;
                const count = tab.validations.length;
                const pct = total > 0 ? ((count / total) * 100).toFixed(0) : 0;
                
                const div = document.createElement('div');
                div.style.cssText = `padding: 8px; margin-bottom: 8px; background: ${tab.completed ? 'rgba(76,175,80,0.2)' : 'rgba(255,255,255,0.1)'}; border-radius: 6px; font-size: 0.8em; cursor: pointer;`;
                div.innerHTML = `<div style="font-weight: 700; font-size: 0.9em;">${obc} ${tab.completed ? '‚úÖ' : ''}</div><div style="opacity: 0.8; font-size: 0.85em;">${count}/${total} (${pct}%)</div>`;
                div.onclick = () => {
                    if (document.getElementById('validation').style.display === 'block') {
                        switchOBC(obc);
                    }
                };
                obcList.appendChild(div);
            });
        }

        function switchOBC(obc) {
            STATE.activeOBC = obc;
            renderValidation();
            document.getElementById('location-input').focus();
            saveState();
        }

        function closeTab(obc) {
        if (!confirm(`¬øCerrar la orden ${obc}? Los datos se mantendr√°n en el historial.`)) return;
        
        // Mover la orden a closedTabs
        STATE.closedTabs[obc] = STATE.tabs[obc];
        STATE.closedTabs[obc].completed = true;
        delete STATE.tabs[obc];
        
        // Si era la orden activa, resetear
        if (STATE.activeOBC === obc) {
            const remainingOrders = Object.keys(STATE.tabs);
            STATE.activeOBC = remainingOrders.length > 0 ? remainingOrders[0] : null;
            }
            
            renderValidation();
            saveState();
            showNotification(`Orden ${obc} cerrada correctamente`, 'success');
        }    

        async function addOBC() {
            const obc = prompt('Ingresa el n√∫mero de la nueva orden:');
            if (!obc) return;
            const obcName = obc.toUpperCase().trim();
            if (STATE.tabs[obcName]) {
                showNotification('‚ö†Ô∏è Esta orden ya est√° abierta', 'warning');
                return;
            }
            const total = OBC_TOTALS.get(obcName) || 0;
            let validatedCount = 0;
            for (const [key, data] of HISTORY.entries()) {
                if (data.obc === obcName) validatedCount++;
            }
            if (total > 0 && validatedCount >= total) {
                document.getElementById('complete-obc').textContent = obcName;
                document.getElementById('complete-count').textContent = `${validatedCount}/${total}`;
                document.getElementById('popup-already-complete').style.display = 'flex';
                playSound('error');
                return;
            }
            if (validatedCount > 0) {
                pendingReloadOBC = obcName;
                document.getElementById('reload-obc').textContent = obcName;
                document.getElementById('reload-validated').textContent = validatedCount;
                document.getElementById('reload-total').textContent = total;
                document.getElementById('reload-pending').textContent = total - validatedCount;
                document.getElementById('popup-reload-order').style.display = 'flex';
                return;
            }
            createNewOBC(obcName);
        }

        function createNewOBC(obcName) {
            STATE.tabs[obcName] = { location: '', validations: [], rejections: [], completed: false };
            switchOBC(obcName);
            showNotification(`‚úÖ Orden ${obcName} creada`, 'success');
        }

        function confirmReloadOrder() {
            if (!pendingReloadOBC) return;
            const obcName = pendingReloadOBC;
            const validations = [];
            for (const [key, data] of HISTORY.entries()) {
                if (data.obc === obcName) {
                    const code = key.replace(`_${obcName.toLowerCase()}`, '');
                    validations.push({
                        id: Date.now() + Math.random(),
                        timestamp: data.timestamp,
                        date: data.date,
                        user: data.user,
                        obc: obcName,
                        raw: code,
                        code: code,
                        location: '',
                        note: 'Cargado desde historial'
                    });
                }
            }
            STATE.tabs[obcName] = { location: '', validations: validations, rejections: [], completed: false };
            closePopup('reload-order');
            pendingReloadOBC = null;
            switchOBC(obcName);
            showNotification(`‚úÖ Orden ${obcName} recargada con ${validations.length} validaciones`, 'success');
        }

        function cancelReloadOrder() {
            closePopup('reload-order');
            pendingReloadOBC = null;
        }

        function updateState() {
            if (!STATE.activeOBC) return;
            const tab = STATE.tabs[STATE.activeOBC];
            tab.location = document.getElementById('location-input').value.toUpperCase().trim();
            saveState();
        }

        function startValidation() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('validation').style.display = 'block';
            addSafeExitButtonToSidebar(); 
            renderValidation();
            if (STATE.activeOBC) document.getElementById('scanner').focus();
        }

        function returnToDashboard() {
            document.getElementById('validation').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateDashboardStats();
        }

        function showResumen() {
            document.getElementById('validation').style.display = 'none';
            document.getElementById('resumen-module').style.display = 'block';
            renderResumen();
        }

        function hideResumen() {
            document.getElementById('resumen-module').style.display = 'none';
            document.getElementById('validation').style.display = 'block';
        }

        function showFaltantes() {
            document.getElementById('validation').style.display = 'none';
            document.getElementById('faltantes-module').style.display = 'block';
            populateFaltantesOrders();
            renderFaltantes();
        }

        function hideFaltantes() {
            document.getElementById('faltantes-module').style.display = 'none';
            document.getElementById('validation').style.display = 'block';
        }

        function renderResumen() {
            const tbody = document.getElementById('resumen-tbody');
            tbody.innerHTML = '';

            // Primero mostrar √≥rdenes activas/cerradas
            const allOrders = { ...STATE.tabs, ...STATE.closedTabs };
            Object.keys(allOrders).forEach(obc => {
                const tab = allOrders[obc];
                const total = OBC_TOTALS.get(obc) || 0;
                const validated = tab.validations.length;
                const pct = total > 0 ? ((validated / total) * 100).toFixed(0) : 0;
                const info = OBC_INFO.get(obc) || {};
                const prerec = PREREC_DATA.get(obc);
                const prerecBadge = prerec ? `<span class="prerec-indicator">PRE</span>` : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><strong>${obc}</strong>${prerecBadge}</td><td>${total}</td><td>${validated}</td><td>${pct}%</td><td>${info.recipient || '-'}</td><td>${info.arrivalTime || '-'}</td>`;
                tbody.appendChild(tr);
            });

            // Luego mostrar √≥rdenes solo prerecibidas (sin validaciones activas)
            for (const [obc, prerec] of PREREC_DATA.entries()) {
                if (!allOrders[obc]) {
                    const total = OBC_TOTALS.get(obc) || 0;
                    const info = OBC_INFO.get(obc) || {};
                    const tr = document.createElement('tr');
                    tr.style.background = '#e3f2fd';
                    tr.innerHTML = `
                        <td><strong>${obc}</strong><span class="prerec-indicator">PRE ${prerec.time}</span></td>
                        <td>${total}</td>
                        <td>0</td>
                        <td>0%</td>
                        <td>${info.recipient || '-'}</td>
                        <td>${prerec.location || info.arrivalTime || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                }
            }
        }

        function filterResumen() {
            const search = document.getElementById('search-resumen').value.toLowerCase();
            const rows = document.querySelectorAll('#resumen-tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function populateFaltantesOrders() {
            const select = document.getElementById('faltantes-order-select');
            select.innerHTML = '<option value="">Seleccionar orden...</option>';
            const allOrders = { ...STATE.tabs, ...STATE.closedTabs };
            Object.keys(allOrders).forEach(obc => {
                const option = document.createElement('option');
                option.value = obc;
                option.textContent = obc;
                select.appendChild(option);
            });
            if (STATE.activeOBC && allOrders[STATE.activeOBC]) {
                select.value = STATE.activeOBC;
            }
        }

        function renderFaltantes() {
            const selectedOBC = document.getElementById('faltantes-order-select').value;
            const grid = document.getElementById('faltantes-grid');
            grid.innerHTML = '';
            if (!selectedOBC) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">Selecciona una orden para ver los c√≥digos</div>';
                return;
            }
            const allOrders = { ...STATE.tabs, ...STATE.closedTabs };
            const tab = allOrders[selectedOBC];
            const obcCodes = OBC_MAP.get(selectedOBC);
            if (!obcCodes || obcCodes.size === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">No hay datos para esta orden</div>';
                return;
            }
            const validated = new Set(tab.validations.map(v => v.code));
            const codesArray = Array.from(obcCodes).map(concatenated => {
                const obcLower = selectedOBC.toLowerCase();
                if (concatenated.endsWith(obcLower)) {
                    return concatenated.slice(0, -obcLower.length);
                }
                return concatenated;
            });
            const pendingCodes = codesArray.filter(code => !validated.has(code));
            if (pendingCodes.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--success);">‚úÖ ¬°Todos los c√≥digos han sido validados!</div>';
                return;
            }
            pendingCodes.forEach(code => {
                const div = document.createElement('div');
                div.className = 'faltante-item faltante-pending';
                div.textContent = code;
                div.dataset.code = code;
                grid.appendChild(div);
            });
        }

        function filterFaltantes() {
            const search = document.getElementById('search-faltantes').value.toLowerCase();
            const items = document.querySelectorAll('.faltante-item');
            items.forEach(item => {
                const code = item.dataset.code.toLowerCase();
                item.style.display = code.includes(search) ? '' : 'none';
            });
        }

        function showPopup(type, code, data) {
            if (type === 'error') {
                document.getElementById('err-code').textContent = code;
                document.getElementById('err-reason').textContent = data;
                document.getElementById('popup-error').style.display = 'flex';
            } else if (type === 'history') {
                document.getElementById('hist-code').textContent = code;
                document.getElementById('hist-obc').textContent = data.obc;
                document.getElementById('hist-when').textContent = `${data.date} ${data.timestamp}`;
                document.getElementById('hist-user').textContent = data.user;
                document.getElementById('popup-history').style.display = 'flex';
            } else if (type === 'dup') {
                document.getElementById('dup-code').textContent = code;
                document.getElementById('dup-when').textContent = `${data.date} ${data.timestamp}`;
                document.getElementById('dup-user').textContent = data.user;
                document.getElementById('popup-dup').style.display = 'flex';
            }
            document.getElementById('scanner').blur();
        }

        function closePopup(type) {
            document.getElementById(`popup-${type}`).style.display = 'none';
            if (!['completed', 'already-complete', 'reload-order'].includes(type)) {
                document.getElementById('scanner').focus();
            }
            lastScanned = null;
        }

        function forceHistoryValidation() {
            const note = prompt('Justificaci√≥n de la revalidaci√≥n:') || 'Sin justificaci√≥n';
            if (lastScanned) {
                const histInfo = `REVALIDACION - Original: ${lastScanned.histData.obc} por ${lastScanned.histData.user} el ${lastScanned.histData.date}`;
                let finalNote;
                if (lastScanned.isManual && lastScanned.manualNote) {
                    finalNote = `${histInfo} - Codigo Escrito Manualmente: ${lastScanned.manualNote} - ${note}`;
                } else if (lastScanned.isManual) {
                    finalNote = `${histInfo} - Codigo Escrito Manualmente: ${note}`;
                } else {
                    finalNote = `${histInfo} - ${note}`;
                }
                handleValidationOK(lastScanned.raw, lastScanned.code, lastScanned.obc, lastScanned.location, finalNote, false);
            }
            closePopup('history');
        }

        function forceDuplicate() {
            const note = prompt('Justificaci√≥n del duplicado:') || 'Sin justificaci√≥n';
            if (lastScanned) {
                let finalNote;
                if (lastScanned.isManual && lastScanned.manualNote) {
                    finalNote = `DUPLICADO FORZADO - Codigo Escrito Manualmente: ${lastScanned.manualNote} - ${note}`;
                } else if (lastScanned.isManual) {
                    finalNote = `DUPLICADO FORZADO - Codigo Escrito Manualmente: ${note}`;
                } else {
                    finalNote = `DUPLICADO FORZADO: ${note}`;
                }
                handleValidationOK(lastScanned.raw, lastScanned.code, lastScanned.obc, lastScanned.location, finalNote, false);
            }
            closePopup('dup');
        }

        function toggleManualOtherNote() {
            const reason = document.getElementById('manual-reason').value;
            const otherContainer = document.getElementById('manual-other-container');
            otherContainer.style.display = reason === 'Otro' ? 'block' : 'none';
        }

        function openManualInput() {
            if (!STATE.activeOBC) {
                showNotification('‚ö†Ô∏è Crea una orden primero', 'warning');
                return;
            }
            const tab = STATE.tabs[STATE.activeOBC];
            if (tab.completed) {
                showNotification('‚ö†Ô∏è Esta orden ya est√° completada', 'warning');
                return;
            }
            document.getElementById('manual-code').value = '';
            document.getElementById('manual-reason').value = '';
            document.getElementById('manual-other-note').value = '';
            document.getElementById('manual-other-container').style.display = 'none';
            document.getElementById('popup-manual').style.display = 'flex';
            document.getElementById('manual-code').focus();
        }

        async function submitManualCode() {
            const code = document.getElementById('manual-code').value.trim();
            const reason = document.getElementById('manual-reason').value;
            const otherNote = document.getElementById('manual-other-note').value.trim();
            
            if (!code) {
                showNotification('‚ö†Ô∏è Ingresa un c√≥digo', 'warning');
                return;
            }
            if (!reason) {
                showNotification('‚ö†Ô∏è Selecciona un motivo', 'warning');
                return;
            }
            if (reason === 'Otro' && !otherNote) {
                showNotification('‚ö†Ô∏è Especifica el motivo', 'warning');
                return;
            }
            
            const finalNote = reason === 'Otro' ? `Otro: ${otherNote}` : reason;
            closePopup('manual');
            
            const activeOBC = STATE.activeOBC;
            const tab = STATE.tabs[activeOBC];
            const normalized = normalizeCode(code);
            const concatenated = normalized + activeOBC.toLowerCase();
            
            if (!BD_CODES.has(concatenated)) {
                await handleRejection('NO_EXISTE_EN_BD', code, normalized, activeOBC);
                return;
            }

            if (HISTORY.has(concatenated)) {
                const histData = HISTORY.get(concatenated);
                lastScanned = { raw: code, code: normalized, obc: activeOBC, location: tab.location, isManual: true, manualNote: finalNote, histData };
                showPopup('history', normalized, histData);
                playSound('duplicate');
                return;
            }
            
            const isDup = tab.validations.find(v => v.code === normalized);
            if (isDup) {
                lastScanned = { raw: code, code: normalized, obc: activeOBC, location: tab.location, duplicate: isDup, isManual: true, manualNote: finalNote };
                showPopup('dup', normalized, isDup);
                playSound('duplicate');
                return;
            }
            
            await handleValidationOK(code, normalized, activeOBC, tab.location, finalNote, true);
        }

        function showOrderCompleted(obc) {
            const tab = STATE.tabs[obc];
            document.getElementById('completed-obc').textContent = obc;
            document.getElementById('completed-count').textContent = tab.validations.length;
            document.getElementById('completed-user').textContent = CURRENT_USER;
            document.getElementById('popup-completed').style.display = 'flex';
            playSound('ok');
            showNotification(`üéâ Orden ${obc} completada!`, 'success');
        }

        function continueToNewOrder() {
            const currentOBC = STATE.activeOBC;
            closePopup('completed');
            if (currentOBC && STATE.tabs[currentOBC]) {
                STATE.closedTabs[currentOBC] = STATE.tabs[currentOBC];
                delete STATE.tabs[currentOBC];
            }
            STATE.activeOBC = null;
            saveState();
            addOBC();
        }

        function saveAndContinue() {
            closePopup('completed');
            addOBC();
        }

        function saveAndClose() {
            const currentOBC = STATE.activeOBC;
            closePopup('completed');
            if (currentOBC && STATE.tabs[currentOBC]) {
                STATE.closedTabs[currentOBC] = STATE.tabs[currentOBC];
                delete STATE.tabs[currentOBC];
            }
            STATE.activeOBC = null;
            saveState();
            returnToDashboard();
        }

        function continueViewing() {
            closePopup('completed');
        }

        function playSound(type) {
            if (!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                
                if (type === 'ok') {
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.15);
                } else if (type === 'error') {
                    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.35);
                } else if (type === 'duplicate') {
                    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.1);
                    setTimeout(() => {
                        const osc2 = audioCtx.createOscillator();
                        const gain2 = audioCtx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioCtx.destination);
                        gain2.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        osc2.frequency.setValueAtTime(600, audioCtx.currentTime);
                        osc2.start();
                        osc2.stop(audioCtx.currentTime + 0.1);
                    }, 150);
                }
            } catch (e) {}
        }

        function flashInput(type) {
            const input = document.getElementById('scanner');
            input.style.borderColor = type === 'success' ? 'var(--success)' : 'var(--error)';
            setTimeout(() => input.style.borderColor = '#ddd', 300);
        }

        function showNotification(msg, type) {
            const container = document.getElementById('notifications');
            const div = document.createElement('div');
            div.className = `notification ${type}`;
            div.innerHTML = `<strong>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</strong> ${msg}`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        function exportData() {
            const rows = [];
            rows.push('Fecha,Hora,Usuario,Orden,C√≥digo,Ubicaci√≥n,Nota');
            const allOrders = { ...STATE.tabs, ...STATE.closedTabs };
            for (const obc in allOrders) {
                allOrders[obc].validations.forEach(log => {
                    rows.push(`${log.date},${log.timestamp},${log.user},${log.obc},${log.code},${log.location || ''},${log.note || ''}`);
                });
            }
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `validaciones_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            showNotification('üì• Datos exportados', 'success');
        }

        // ==================== CONSULTA RAPIDA MODULE ====================
        function showConsulta() {
            document.getElementById('validation').style.display = 'none';
            document.getElementById('consulta-module').style.display = 'block';
            document.getElementById('consulta-scanner').value = '';
            document.getElementById('consulta-result').style.display = 'none';
            document.getElementById('consulta-scanner').focus();
        }

        function hideConsulta() {
            document.getElementById('consulta-module').style.display = 'none';
            document.getElementById('validation').style.display = 'block';
        }

        function handleConsultaScan(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                executeConsulta();
            }
        }

        function executeConsulta() {
            const scanner = document.getElementById('consulta-scanner');
            const raw = scanner.value.trim();
            if (!raw) {
                showNotification('‚ö†Ô∏è Ingresa un c√≥digo o n√∫mero de orden', 'warning');
                return;
            }

            // Limpiar scanner despu√©s de ejecutar la consulta
            scanner.value = '';
            scanner.focus();

            // Verificar si es un n√∫mero de orden (OBC format)
            const upperRaw = raw.toUpperCase().trim();
            if (OBC_TOTALS.has(upperRaw) || OBC_MAP.has(upperRaw)) {
                // Es una b√∫squeda por orden directa
                renderConsultaResultByOrder(upperRaw);
                return;
            }

            const extracted = extractCode(raw);
            const normalized = normalizeCode(extracted);

            let foundOBC = null;
            let isValidatedInHistory = false;
            let historyData = null;
            let locationData = '';

            // Buscar en qu√© OBC est√° el c√≥digo
            for (const [obc, codes] of OBC_MAP.entries()) {
                const concatenated = normalized + obc.toLowerCase();
                if (codes.has(concatenated) || codes.has(normalized + obc.toLowerCase())) {
                    foundOBC = obc;
                    // Verificar si est√° validado en historial
                    const histKey = `${normalized}_${obc.toLowerCase()}`;
                    if (HISTORY.has(histKey)) {
                        isValidatedInHistory = true;
                        historyData = HISTORY.get(histKey);
                        locationData = historyData.location || '';
                    }
                    // Tambi√©n verificar ubicaci√≥n en tabs activos
                    if (STATE.tabs[obc]) {
                        locationData = STATE.tabs[obc].location || locationData;
                    }
                    break;
                }
            }

            // Tambi√©n buscar directamente en BD_CODES
            if (!foundOBC) {
                for (const code of BD_CODES) {
                    if (code.startsWith(normalized)) {
                        // Extraer el OBC del c√≥digo concatenado
                        const possibleOBC = code.slice(normalized.length).toUpperCase();
                        if (OBC_TOTALS.has(possibleOBC)) {
                            foundOBC = possibleOBC;
                            const histKey = `${normalized}_${possibleOBC.toLowerCase()}`;
                            if (HISTORY.has(histKey)) {
                                isValidatedInHistory = true;
                                historyData = HISTORY.get(histKey);
                                locationData = historyData.location || '';
                            }
                            if (STATE.tabs[possibleOBC]) {
                                locationData = STATE.tabs[possibleOBC].location || locationData;
                            }
                            break;
                        }
                    }
                }
            }

            renderConsultaResult(normalized, foundOBC, isValidatedInHistory, historyData, locationData);
        }

        // Nueva funci√≥n para mostrar resultado por orden
        function renderConsultaResultByOrder(obc) {
            const resultDiv = document.getElementById('consulta-result');
            const info = OBC_INFO.get(obc) || {};
            const total = OBC_TOTALS.get(obc) || 0;

            // Contar validaciones de esta orden
            let validatedCount = 0;
            for (const [key, data] of HISTORY.entries()) {
                if (data.obc === obc) validatedCount++;
            }

            const pct = total > 0 ? ((validatedCount / total) * 100).toFixed(1) : 0;
            const isComplete = validatedCount >= total && total > 0;

            // Obtener ubicaci√≥n del tab activo o de prerecepci√≥n
            const prerec = PREREC_DATA.get(obc);
            const locationData = STATE.tabs[obc]?.location || prerec?.location || '';

            // Determinar estado
            let statusClass = isComplete ? 'validated' : 'pending';
            let statusText = isComplete ? '‚úÖ COMPLETA' : (prerec ? 'üìã PRERECIBIDA' : '‚è≥ EN PROCESO');
            if (prerec && !isComplete) statusClass = 'pending';

            // Info de prerecepci√≥n
            const prerecInfo = prerec ? `
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #1565c0;">
                    <div style="font-weight: 600; color: #1565c0; margin-bottom: 4px;">üìã Prerecibida</div>
                    <div style="font-size: 0.85em; color: #555;">${prerec.date} a las ${prerec.time}${prerec.location ? ` - Ubicaci√≥n: ${prerec.location}` : ''}</div>
                </div>
            ` : '';

            resultDiv.innerHTML = `
                <div class="consulta-result">
                    <div class="consulta-header">
                        <div class="consulta-code-display" style="border-left-color: var(--primary);">
                            <div class="consulta-code-label">Orden Consultada</div>
                            <div class="consulta-code-value" style="color: var(--primary);">${obc}</div>
                        </div>
                        <div class="consulta-status ${statusClass}">${statusText}</div>
                    </div>

                    ${prerecInfo}

                    <div class="consulta-section-title">Informaci√≥n de la Orden</div>
                    <div class="consulta-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="consulta-item highlight">
                            <div class="consulta-item-label">Total Cajas</div>
                            <div class="consulta-item-value" style="color: var(--primary);">${total}</div>
                        </div>
                        <div class="consulta-item">
                            <div class="consulta-item-label">Destino</div>
                            <div class="consulta-item-value">${info.recipient || '-'}</div>
                        </div>
                        <div class="consulta-item">
                            <div class="consulta-item-label">Horario Llegada</div>
                            <div class="consulta-item-value">${info.arrivalTime || '-'}</div>
                        </div>
                    </div>

                    <div class="consulta-section-title">Referencias y Ubicaci√≥n</div>
                    <div class="consulta-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="consulta-item">
                            <div class="consulta-item-label">Referencia 1</div>
                            <div class="consulta-item-value">${info.referenceOrder || '-'}</div>
                        </div>
                        <div class="consulta-item">
                            <div class="consulta-item-label">Referencia 2</div>
                            <div class="consulta-item-value">${info.referenceId || '-'}</div>
                        </div>
                        <div class="consulta-item">
                            <div class="consulta-item-label">Ubicaci√≥n</div>
                            <div class="consulta-item-value">${locationData || '-'}</div>
                        </div>
                    </div>

                    <div class="consulta-progress-section">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #555;">Avance de la Orden</span>
                            <span style="font-weight: 700; color: ${isComplete ? 'var(--success)' : 'var(--primary)'};">${validatedCount} / ${total} cajas (${pct}%)</span>
                        </div>
                        <div class="consulta-progress">
                            <div class="consulta-progress-bar ${isComplete ? 'complete' : ''}" style="width: ${pct}%">
                                ${pct > 10 ? pct + '%' : ''}
                            </div>
                        </div>
                    </div>

                    ${!isComplete && total > 0 ? `
                        <div class="consulta-action">
                            <button class="btn btn-success" onclick="goToValidateFromConsulta('${obc}')">
                                ‚úÖ Ir a Validar Orden ${obc}
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            resultDiv.style.display = 'block';
            playSound(isComplete ? 'ok' : 'duplicate');
        }

        function renderConsultaResult(code, obc, isValidated, historyData, locationData = '') {
            const resultDiv = document.getElementById('consulta-result');

            if (!obc) {
                resultDiv.innerHTML = `
                    <div class="consulta-result">
                        <div class="consulta-header">
                            <div class="consulta-obc">C√≥digo: ${code}</div>
                            <div class="consulta-status not-found">NO ENCONTRADO</div>
                        </div>
                        <div style="text-align: center; padding: 30px; color: #666;">
                            <div style="font-size: 3em; margin-bottom: 15px;">‚ùì</div>
                            <p>Este c√≥digo no se encontr√≥ en ninguna orden de la base de datos.</p>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                playSound('error');
                return;
            }

            const info = OBC_INFO.get(obc) || {};
            const total = OBC_TOTALS.get(obc) || 0;

            // Contar validaciones de esta orden
            let validatedCount = 0;
            for (const [key, data] of HISTORY.entries()) {
                if (data.obc === obc) validatedCount++;
            }

            const pct = total > 0 ? ((validatedCount / total) * 100).toFixed(1) : 0;
            const isComplete = validatedCount >= total && total > 0;

            let statusClass = isValidated ? 'validated' : 'pending';
            let statusText = isValidated ? '‚úÖ VALIDADO' : '‚è≥ PENDIENTE';

            let actionButton = '';
            if (!isValidated) {
                actionButton = `
                    <div class="consulta-action">
                        <button class="btn btn-success" onclick="goToValidateFromConsulta('${obc}')">
                            ‚úÖ Validar Ahora - Ir a Orden ${obc}
                        </button>
                    </div>
                `;
            }

            let validationInfo = '';
            if (isValidated && historyData) {
                validationInfo = `
                    <div class="consulta-validation-info">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">‚úÖ</span>
                            <div>
                                <div style="font-weight: 700; color: var(--success);">Validado correctamente</div>
                                <div style="font-size: 0.85em; color: #666;">${historyData.date} a las ${historyData.timestamp} por ${historyData.user}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            resultDiv.innerHTML = `
                <div class="consulta-result">
                    <div class="consulta-header">
                        <div class="consulta-code-display">
                            <div class="consulta-code-label">C√≥digo escaneado</div>
                            <div class="consulta-code-value">${code}</div>
                        </div>
                        <div class="consulta-status ${statusClass}">${statusText}</div>
                    </div>

                    ${validationInfo}

                    <div class="consulta-section-title">Informaci√≥n de la Orden</div>
                    <div class="consulta-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="consulta-item highlight">
                            <div class="consulta-item-label">Orden (PO)</div>
                            <div class="consulta-item-value" style="color: var(--primary);">${obc}</div>
                        </div>
                        <div class="consulta-item">
                            <div class="consulta-item-label">Destino</div>
                            <div class="consulta-item-value">${info.recipient || '-'}</div>
                        </div>
                        <div class="consulta-item">
                            <div class="consulta-item-label">Horario Llegada</div>
                            <div class="consulta-item-value">${info.arrivalTime || '-'}</div>
                        </div>
                    </div>

                    <div class="consulta-section-title">Referencias y Ubicaci√≥n</div>
                    <div class="consulta-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="consulta-item">
                            <div class="consulta-item-label">Referencia 1</div>
                            <div class="consulta-item-value">${info.referenceOrder || '-'}</div>
                        </div>
                        <div class="consulta-item">
                            <div class="consulta-item-label">Referencia 2</div>
                            <div class="consulta-item-value">${info.referenceId || '-'}</div>
                        </div>
                        <div class="consulta-item">
                            <div class="consulta-item-label">Ubicaci√≥n</div>
                            <div class="consulta-item-value">${locationData || '-'}</div>
                        </div>
                    </div>

                    <div class="consulta-progress-section">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #555;">Avance de la Orden</span>
                            <span style="font-weight: 700; color: ${isComplete ? 'var(--success)' : 'var(--primary)'};">${validatedCount} / ${total} cajas (${pct}%)</span>
                        </div>
                        <div class="consulta-progress">
                            <div class="consulta-progress-bar ${isComplete ? 'complete' : ''}" style="width: ${pct}%">
                                ${pct > 10 ? pct + '%' : ''}
                            </div>
                        </div>
                    </div>

                    ${actionButton}
                </div>
            `;

            resultDiv.style.display = 'block';
            playSound(isValidated ? 'ok' : 'duplicate');
        }

        function goToValidateFromConsulta(obc) {
            hideConsulta();

            // Si la orden ya est√° abierta, ir a ella
            if (STATE.tabs[obc]) {
                switchOBC(obc);
                return;
            }

            // Si no, verificar si tiene validaciones previas
            const total = OBC_TOTALS.get(obc) || 0;
            let validatedCount = 0;
            for (const [key, data] of HISTORY.entries()) {
                if (data.obc === obc) validatedCount++;
            }

            if (total > 0 && validatedCount >= total) {
                showNotification('‚ö†Ô∏è Esta orden ya est√° completamente validada', 'warning');
                return;
            }

            if (validatedCount > 0) {
                // Cargar con validaciones previas
                const validations = [];
                for (const [key, data] of HISTORY.entries()) {
                    if (data.obc === obc) {
                        const code = key.replace(`_${obc.toLowerCase()}`, '');
                        validations.push({
                            id: Date.now() + Math.random(),
                            timestamp: data.timestamp,
                            date: data.date,
                            user: data.user,
                            obc: obc,
                            raw: code,
                            code: code,
                            location: '',
                            note: 'Cargado desde historial'
                        });
                    }
                }
                STATE.tabs[obc] = { location: '', validations: validations, rejections: [], completed: false };
                switchOBC(obc);
                showNotification(`‚úÖ Orden ${obc} cargada con ${validations.length} validaciones previas`, 'success');
            } else {
                // Crear orden nueva
                STATE.tabs[obc] = { location: '', validations: [], rejections: [], completed: false };
                switchOBC(obc);
                showNotification(`‚úÖ Orden ${obc} creada`, 'success');
            }
        }

        // ==================== PRERECEPCI√ìN MODULE ====================
        let PREREC_DATA = new Map(); // Almacena √≥rdenes prerecibidas: obc -> {date, time, location}
        let PREREC_CURRENT = null; // Orden actual siendo procesada en el modal

        async function loadPrerecData() {
            try {
                const res = await window.storage.get('wms_prerec_data');
                if (res?.value) {
                    const arr = JSON.parse(res.value);
                    PREREC_DATA = new Map(arr);
                }
            } catch (e) {}
        }

        async function savePrerecData() {
            try {
                await window.storage.set('wms_prerec_data', JSON.stringify(Array.from(PREREC_DATA.entries())));
            } catch (e) {}
        }

        function showPrerecepcion() {
            document.querySelectorAll('.prerec-overlay').forEach(e => e.remove());
            PREREC_CURRENT = null;

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay prerec-overlay';
            overlay.style.display = 'flex';

            overlay.innerHTML = `
                <div class="popup-content" style="max-width: 500px;">
                    <button class="popup-close-x" onclick="closePrerecepcion()">√ó</button>
                    <div class="popup-header" style="color: #6c757d;">
                        üìã PRERECEPCI√ìN DE ORDEN
                    </div>
                    <p style="text-align: center; color: #666; margin-bottom: 15px;">
                        Escanea o ingresa el n√∫mero de orden para registrar su llegada
                    </p>

                    <div class="input-group">
                        <label>N√∫mero de Orden *</label>
                        <input type="text" id="prerec-order-input" class="scanner-input"
                               placeholder="Escanea o escribe el n√∫mero de orden..."
                               onkeydown="handlePrerecScan(event)" autofocus>
                    </div>

                    <div id="prerec-order-info" style="display: none;"></div>

                    <div id="prerec-location-section" style="display: none;">
                        <div class="input-group">
                            <label>Ubicaci√≥n (opcional)</label>
                            <input type="text" id="prerec-location-input" class="scanner-input"
                                   placeholder="Ej: Rack 3, Mesa A, Zona B...">
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="resetPrerecModal()" style="flex: 1;">
                                üîÑ Otra Orden
                            </button>
                            <button class="btn btn-success" onclick="confirmPrerecepcion()" style="flex: 1;">
                                ‚úÖ Confirmar Llegada
                            </button>
                        </div>
                    </div>

                    <div id="prerec-history" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                        <div style="font-size: 0.85em; color: #888; margin-bottom: 10px;">
                            üì¶ Prerecibidas hoy: <strong id="prerec-today-count">0</strong>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
            updatePrerecTodayCount();
            setTimeout(() => document.getElementById('prerec-order-input').focus(), 100);
        }

        function closePrerecepcion() {
            document.querySelectorAll('.prerec-overlay').forEach(e => e.remove());
            PREREC_CURRENT = null;
        }

        function resetPrerecModal() {
            PREREC_CURRENT = null;
            document.getElementById('prerec-order-input').value = '';
            document.getElementById('prerec-order-info').style.display = 'none';
            document.getElementById('prerec-location-section').style.display = 'none';
            document.getElementById('prerec-order-input').focus();
        }

        function handlePrerecScan(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('prerec-order-input');
                const raw = input.value.trim().toUpperCase();

                if (!raw) {
                    showNotification('‚ö†Ô∏è Ingresa un n√∫mero de orden', 'warning');
                    return;
                }

                // Limpiar input
                input.value = '';

                // Verificar si la orden existe en la BD
                if (!OBC_TOTALS.has(raw) && !OBC_MAP.has(raw)) {
                    showNotification('‚ùå Orden no encontrada en la base de datos', 'error');
                    playSound('error');
                    return;
                }

                // Verificar si ya fue prerecibida
                if (PREREC_DATA.has(raw)) {
                    const existing = PREREC_DATA.get(raw);
                    showNotification(`‚ö†Ô∏è Orden ya prerecibida el ${existing.date} a las ${existing.time}`, 'warning');
                    playSound('duplicate');
                    return;
                }

                PREREC_CURRENT = raw;
                showPrerecOrderInfo(raw);
                playSound('ok');
            }
        }

        function showPrerecOrderInfo(obc) {
            const info = OBC_INFO.get(obc) || {};
            const total = OBC_TOTALS.get(obc) || 0;

            // Contar validaciones existentes
            let validatedCount = 0;
            for (const [key, data] of HISTORY.entries()) {
                if (data.obc === obc) validatedCount++;
            }
            const pct = total > 0 ? ((validatedCount / total) * 100).toFixed(1) : 0;

            const infoDiv = document.getElementById('prerec-order-info');
            infoDiv.innerHTML = `
                <div class="prerec-order-info">
                    <div class="prerec-order-header">
                        <span class="prerec-order-code">${obc}</span>
                        <span class="prerec-badge">üì¶ ${total} cajas</span>
                    </div>
                    <div class="prerec-grid">
                        <div class="prerec-item">
                            <div class="prerec-item-label">Destino</div>
                            <div class="prerec-item-value">${info.recipient || '-'}</div>
                        </div>
                        <div class="prerec-item">
                            <div class="prerec-item-label">Horario</div>
                            <div class="prerec-item-value">${info.arrivalTime || '-'}</div>
                        </div>
                        <div class="prerec-item">
                            <div class="prerec-item-label">Referencia 1</div>
                            <div class="prerec-item-value">${info.referenceOrder || '-'}</div>
                        </div>
                        <div class="prerec-item">
                            <div class="prerec-item-label">Referencia 2</div>
                            <div class="prerec-item-value">${info.referenceId || '-'}</div>
                        </div>
                    </div>
                    ${validatedCount > 0 ? `
                        <div style="margin-top: 10px; padding: 8px; background: #e8f5e9; border-radius: 6px; font-size: 0.85em;">
                            ‚úÖ Progreso actual: ${validatedCount}/${total} (${pct}%)
                        </div>
                    ` : ''}
                </div>
            `;
            infoDiv.style.display = 'block';
            document.getElementById('prerec-location-section').style.display = 'block';
            document.getElementById('prerec-location-input').focus();
        }

        async function confirmPrerecepcion() {
            if (!PREREC_CURRENT) {
                showNotification('‚ö†Ô∏è No hay orden seleccionada', 'warning');
                return;
            }

            try {
                const location = document.getElementById('prerec-location-input').value.trim();
                const now = new Date();
                const date = now.toLocaleDateString('es-MX');
                const time = now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });

                // Guardar en PREREC_DATA local
                PREREC_DATA.set(PREREC_CURRENT, {
                    date,
                    time,
                    location,
                    user: CURRENT_USER || 'Usuario'
                });
                await savePrerecData();

                // Agregar a PENDING_SYNC para sincronizar a hoja "Previa"
                const log = {
                    date,
                    timestamp: time,
                    obc: PREREC_CURRENT,
                    location: location || '-'
                };
                PENDING_SYNC.push({ sheet: 'Previa', log });
                await SyncManager.save();
                SyncManager.updateUI(false);

                showNotification(`‚úÖ Orden ${PREREC_CURRENT} prerecibida`, 'success');
                playSound('ok');

                // Actualizar contador y resetear para siguiente
                updatePrerecTodayCount();
                resetPrerecModal();

                // Intentar sincronizar si hay conexi√≥n
                if (IS_ONLINE && gapi?.client?.getToken()) {
                    SyncManager.sync(false);
                }
            } catch (e) {
                console.error('Error en confirmPrerecepcion:', e);
                showNotification('‚ùå Error al confirmar prerecepci√≥n', 'error');
            }
        }

        function updatePrerecTodayCount() {
            const today = new Date().toLocaleDateString('es-MX');
            let count = 0;
            for (const [obc, data] of PREREC_DATA.entries()) {
                if (data.date === today) count++;
            }
            const el = document.getElementById('prerec-today-count');
            if (el) el.textContent = count;
        }

        function isOrderPrereceived(obc) {
            return PREREC_DATA.has(obc);
        }

        function getPrerecInfo(obc) {
            return PREREC_DATA.get(obc);
        }

        // ==================== RECONTEO MODULE ====================
        let RECONTEO_DATA = {
            obc: null,
            scans: [],
            scannedCodes: new Set()
        };

        function openReconteo() {
            if (!STATE.activeOBC) {
                showNotification('‚ö†Ô∏è No hay orden activa', 'warning');
                return;
            }

            document.getElementById('validation').style.display = 'none';
            document.getElementById('reconteo-module').style.display = 'block';
            populateReconteoOrders();
            document.getElementById('reconteo-order-select').value = STATE.activeOBC;
            initReconteo();
        }

        function hideReconteo() {
            document.getElementById('reconteo-module').style.display = 'none';
            document.getElementById('validation').style.display = 'block';
        }

        function populateReconteoOrders() {
            const select = document.getElementById('reconteo-order-select');
            select.innerHTML = '<option value="">Seleccionar orden...</option>';
            const allOrders = { ...STATE.tabs, ...STATE.closedTabs };
            Object.keys(allOrders).forEach(obc => {
                const option = document.createElement('option');
                option.value = obc;
                option.textContent = obc;
                select.appendChild(option);
            });
        }

        function initReconteo() {
            const selectedOBC = document.getElementById('reconteo-order-select').value;
            const contentDiv = document.getElementById('reconteo-content');

            if (!selectedOBC) {
                contentDiv.style.display = 'none';
                return;
            }

            RECONTEO_DATA = {
                obc: selectedOBC,
                scans: [],
                scannedCodes: new Set()
            };

            contentDiv.style.display = 'block';
            updateReconteoStats();
            renderReconteoTable();
            renderReconteoNotScanned();
            document.getElementById('reconteo-scanner').focus();
        }

        function clearReconteo() {
            if (!RECONTEO_DATA.obc) return;

            if (RECONTEO_DATA.scans.length > 0 && !confirm('¬øLimpiar todos los escaneos del reconteo?')) {
                return;
            }

            RECONTEO_DATA.scans = [];
            RECONTEO_DATA.scannedCodes = new Set();
            updateReconteoStats();
            renderReconteoTable();
            renderReconteoNotScanned();
            document.getElementById('reconteo-scanner').focus();
            showNotification('üóëÔ∏è Reconteo limpiado', 'info');
        }

        function handleReconteoScan(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('reconteo-scanner');
                const raw = input.value.trim();
                if (raw) {
                    processReconteoScan(raw);
                    input.value = '';
                }
            }
        }

        function processReconteoScan(raw) {
            const obc = RECONTEO_DATA.obc;
            if (!obc) return;

            const extracted = extractCode(raw);
            const normalized = normalizeCode(extracted);
            const concatenated = normalized + obc.toLowerCase();
            const now = new Date();

            // Determinar estatus
            let status = 'OK';
            let statusClass = 'status-ok';

            // Verificar duplicado en este reconteo
            if (RECONTEO_DATA.scannedCodes.has(normalized)) {
                status = 'DUPLICADO';
                statusClass = 'status-dup';
                playSound('duplicate');
            }
            // Verificar si existe en la BD para esta orden
            else if (!BD_CODES.has(concatenated)) {
                // Verificar si existe en BD pero para otra orden
                let existsInOtherOrder = false;
                for (const code of BD_CODES) {
                    if (code.startsWith(normalized)) {
                        existsInOtherOrder = true;
                        break;
                    }
                }

                if (existsInOtherOrder) {
                    status = 'OTRA ORDEN';
                    statusClass = 'status-extra';
                } else {
                    status = 'NO EN BD';
                    statusClass = 'status-missing';
                }
                playSound('error');
            } else {
                playSound('ok');
            }

            // Verificar si est√° validado previamente
            const allOrders = { ...STATE.tabs, ...STATE.closedTabs };
            const tab = allOrders[obc];
            const wasValidated = tab?.validations?.some(v => v.code === normalized);

            const scanEntry = {
                id: now.getTime(),
                number: RECONTEO_DATA.scans.length + 1,
                code: normalized,
                raw: raw,
                status: status,
                statusClass: statusClass,
                timestamp: now.toLocaleTimeString('es-MX'),
                wasValidated: wasValidated,
                canAdd: status === 'OK' && !wasValidated && BD_CODES.has(concatenated)
            };

            RECONTEO_DATA.scans.unshift(scanEntry);
            if (status !== 'DUPLICADO') {
                RECONTEO_DATA.scannedCodes.add(normalized);
            }

            updateReconteoStats();
            renderReconteoTable();
            renderReconteoNotScanned();
        }

        function updateReconteoStats() {
            let ok = 0, dup = 0, missing = 0, extra = 0;

            RECONTEO_DATA.scans.forEach(scan => {
                switch(scan.status) {
                    case 'OK': ok++; break;
                    case 'DUPLICADO': dup++; break;
                    case 'NO EN BD': missing++; break;
                    case 'OTRA ORDEN': extra++; break;
                }
            });

            document.getElementById('reconteo-ok').textContent = ok;
            document.getElementById('reconteo-dup').textContent = dup;
            document.getElementById('reconteo-missing').textContent = missing;
            document.getElementById('reconteo-extra').textContent = extra;
        }

        function renderReconteoTable() {
            const tbody = document.getElementById('reconteo-tbody');
            tbody.innerHTML = '';

            RECONTEO_DATA.scans.forEach((scan, index) => {
                const tr = document.createElement('tr');

                let actionBtn = '';
                if (scan.canAdd && !scan.wasValidated) {
                    actionBtn = `<button class="btn-add-validation" onclick="addFromReconteo('${scan.code}')">+ Agregar</button>`;
                } else if (scan.wasValidated) {
                    actionBtn = '<span style="color: var(--success); font-size: 0.8em;">Ya validado</span>';
                }

                tr.innerHTML = `
                    <td><strong>${RECONTEO_DATA.scans.length - index}</strong></td>
                    <td><code>${scan.code}</code></td>
                    <td><span class="status-badge ${scan.statusClass}">${scan.status}</span></td>
                    <td>${scan.timestamp}</td>
                    <td>${actionBtn}</td>
                `;
                tbody.appendChild(tr);
            });

            if (RECONTEO_DATA.scans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999; padding: 30px;">Escanea c√≥digos para iniciar el reconteo</td></tr>';
            }
        }

        function renderReconteoNotScanned() {
            const grid = document.getElementById('reconteo-not-scanned');
            const obc = RECONTEO_DATA.obc;

            if (!obc) {
                grid.innerHTML = '';
                return;
            }

            const allOrders = { ...STATE.tabs, ...STATE.closedTabs };
            const tab = allOrders[obc];

            if (!tab || !tab.validations || tab.validations.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #999;">No hay validaciones previas para esta orden</div>';
                return;
            }

            const notScanned = tab.validations.filter(v => !RECONTEO_DATA.scannedCodes.has(v.code));

            if (notScanned.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--success);">‚úÖ Todos los c√≥digos validados han sido escaneados en el reconteo</div>';
                return;
            }

            grid.innerHTML = '';
            notScanned.forEach(v => {
                const div = document.createElement('div');
                div.className = 'faltante-item faltante-pending';
                div.textContent = v.code;
                grid.appendChild(div);
            });
        }

        async function addFromReconteo(code) {
            const obc = RECONTEO_DATA.obc;
            if (!obc) return;

            // Asegurarse de que la orden est√° abierta
            if (!STATE.tabs[obc]) {
                const allOrders = { ...STATE.closedTabs };
                if (allOrders[obc]) {
                    STATE.tabs[obc] = allOrders[obc];
                    delete STATE.closedTabs[obc];
                } else {
                    STATE.tabs[obc] = { location: '', validations: [], rejections: [], completed: false };
                }
            }

            const tab = STATE.tabs[obc];
            const location = tab.location || '';

            // Validar el c√≥digo
            await handleValidationOK(code, code, obc, location, 'Agregado desde Reconteo', false);

            // Actualizar la tabla de reconteo
            RECONTEO_DATA.scans.forEach(scan => {
                if (scan.code === code) {
                    scan.wasValidated = true;
                    scan.canAdd = false;
                }
            });

            renderReconteoTable();
            renderReconteoNotScanned();
            showNotification(`‚úÖ C√≥digo ${code} agregado a la validaci√≥n`, 'success');
        }

        // showNetworkDiagnosticDialog - ahora usa SyncManager.showPanel()
        function showNetworkDiagnosticDialog() { SyncManager.showPanel(); }

    </script>
</body>
</html>
