<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inventario</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --blocked: #f97316;
            --tab-active: #f97316; /* AGREGAR ESTA L√çNEA (PASO 2.1) */
            --bg: #f7f7f7;
            --text: #333;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* Loading Indicator (PASO 1.1) */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text);
        }

        .loading-subtext {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        /* Connection Banner */
        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s;
        }
        .connection-banner.offline {
            background: var(--error);
            color: white;
            display: block;
        }
        .connection-banner.online {
            background: var(--success);
            color: white;
            display: block;
        }
        .connection-banner.syncing {
            background: var(--warning);
            color: white;
            display: block;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        /* MAIN LAYOUT */
        .main-container {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #555;
        }

        .sidebar-header h2 {
            color: var(--primary);
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.8em;
            color: #aaa;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }

        .sidebar-section-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .sidebar-btn:hover {
            transform: translateX(3px);
        }

        .sidebar-btn-primary {
            background: var(--primary);
            color: white;
        }

        .sidebar-btn-secondary {
            background: #555;
            color: white;
        }

        .sidebar-btn-quick { /* PASO 4.1 */
            background: var(--blocked);
            color: white;
        }
        .sidebar-btn-quick:hover {
            background: #c36113;
        }

        /* Sync Status */
        .sync-status {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            cursor: pointer;
        }
        .sync-ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .sync-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }
        .sync-warning {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* Pallets por estatus */
        .pallet-status-list {
            flex: 1;
            overflow-y: auto;
        }

        .pallet-status-item {
            background: #444;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .pallet-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .pallet-status-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .pallet-status-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .pallet-code {
            font-family: monospace;
            font-size: 0.7em;
            color: #aaa;
            word-break: break-all;
        }

        .pallet-send-btn {
            margin-top: 6px;
            padding: 5px 10px;
            font-size: 0.7em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }

        .pallet-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pallet-send-btn.ok { background: var(--success); color: white; }
        .pallet-send-btn.blocked { background: var(--blocked); color: white; }
        .pallet-send-btn.nowms { background: var(--error); color: white; }

        /* User Footer */
        .user-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            color: white;
            flex-shrink: 0;
            cursor: pointer;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .connection-indicator {
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }
        .connection-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-footer-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .user-footer-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.75em;
        }

        .bd-info {
            font-size: 0.7em;
            color: #aaa;
            text-align: center;
            line-height: 1.4;
        }

        /* MAIN CONTENT - REEMPLAZADO (PASO 2.2) */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tabs Container */
        .tabs-container {
            background: white;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            padding: 8px 15px;
            gap: 8px;
        }

        .tab-new-btn {
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .tab-new-btn:hover {
            background: #1d4ed8;
        }

        .tabs-list {
            display: flex;
            gap: 5px;
            flex: 1;
            overflow-x: auto;
        }

        .tab-item {
            padding: 8px 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            transition: all 0.2s;
            font-size: 0.85em;
            min-width: 150px;
        }

        .tab-item.active {
            background: var(--tab-active);
            color: white;
            border-color: var(--tab-active);
            font-weight: 600;
        }

        .tab-item:not(.active):hover {
            background: #f5f5f5;
        }

        .tab-close {
            margin-left: auto;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.1em;
            padding: 0 4px;
            opacity: 0.7;
        }

        .tab-close:hover {
            opacity: 1;
        }

        /* Tab Content Area */
        .tab-content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-content {
            display: none;
            height: 100%;
            overflow: auto;
            padding: 15px;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Empty State */
        .empty-workspace {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }

        .empty-workspace-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-workspace-text {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .empty-workspace-subtext {
            font-size: 0.9em;
        }

        /* Quick Log (PASO 4.1) */
        .quick-log-container {
            flex: 1;
            background: #f8f8f8;
            border-radius: 12px;
            padding: 12px;
            margin-top: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .quick-log-header {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--primary);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .quick-log-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .quick-log-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 5px solid;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .quick-log-item.success {
            background: #e8f5e9;
            border-color: var(--success);
        }

        .quick-log-item.blocked {
            background: #fff3e0;
            border-color: var(--blocked);
        }

        .quick-log-item.nowms {
            background: #ffebee;
            border-color: var(--error);
        }

        .quick-log-info {
            flex: 1;
        }

        .quick-log-code {
            font-family: monospace;
            font-weight: 600;
            font-size: 1em;
        }

        .quick-log-status {
            font-size: 0.85em;
            margin-top: 4px;
        }

        .quick-log-time {
            font-size: 0.75em;
            color: #666;
        }
        /* Fin Quick Log */

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.4em;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        /* Scan Section */
        .scan-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scan-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .scan-input-group {
            flex: 1;
        }

        .scan-input-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .scan-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.3em;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
            transition: all 0.2s;
        }

        .scan-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .scan-input.error {
            border-color: var(--error);
            background: #ffebee;
        }

        .scan-input.success {
            border-color: var(--success);
            background: #e8f5e9;
        }

        /* Result Box */
        .result-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-box.show { display: block; }
        .result-box.success { background: #e8f5e9; border: 2px solid var(--success); }
        .result-box.warning { background: #fff3e0; border: 2px solid var(--warning); }
        .result-box.blocked { background: #fff3e0; border: 2px solid var(--blocked); }
        .result-box.error { background: #ffebee; border: 2px solid var(--error); }

        .result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .result-icon { font-size: 1.5rem; }
        .result-title { font-weight: 700; font-size: 1.1em; }
        .result-code { font-family: monospace; font-weight: 600; }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            font-size: 0.85em;
        }

        .result-detail-label { color: #666; font-size: 0.8em; }
        .result-detail-value { font-weight: 600; }

        /* Code2 Input */
        .code2-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px dashed var(--error);
            display: none;
        }

        .code2-container.show { display: block; }

        .code2-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn-insertado {
            padding: 12px 20px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-insertado:hover {
            background: #d32f2f;
        }

        /* Columns Container */
        .columns-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            flex: 1;
            min-height: 0;
        }

        .column {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .column-title {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .column-count {
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
        }

        .column.ok .column-title { color: var(--success); }
        .column.ok .column-count { background: rgba(76, 175, 80, 0.15); color: var(--success); }

        .column.blocked .column-title { color: var(--blocked); }
        .column.blocked .column-count { background: rgba(249, 115, 22, 0.15); color: var(--blocked); }

        .column.nowms .column-title { color: var(--error); }
        .column.nowms .column-count { background: rgba(244, 67, 54, 0.15); color: var(--error); }

        .column-pallet-info {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.8em;
        }

        .column-pallet-code {
            font-family: monospace;
            font-weight: 600;
            color: var(--primary);
        }

        .column-location-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
            margin-top: 6px;
        }

        .column-send-btn {
            margin-top: 8px;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.8em;
        }

        .column-send-btn:disabled {
            background: #ccc !important;
            cursor: not-allowed;
            color: #666 !important;
        }

        .column.ok .column-send-btn { background: var(--success); color: white; }
        .column.blocked .column-send-btn { background: var(--blocked); color: white; }
        .column.nowms .column-send-btn { background: var(--error); color: white; }

        .column-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            min-height: 0;
        }

        .box-item {
            background: white;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75em;
            border: 1px solid var(--border);
        }

        .box-code {
            font-weight: 600;
            font-family: monospace;
            word-break: break-all;
        }

        .box-meta {
            color: #999;
            font-size: 0.9em;
        }

        .box-delete {
            background: var(--error);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 700;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 30px 0;
            color: #999;
            font-size: 0.9em;
        }

        .empty-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* Resumen Screen */
        .resumen-screen {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .resumen-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
        }

        .stat-value.ok { color: var(--success); }
        .stat-value.blocked { color: var(--blocked); }
        .stat-value.nowms { color: var(--error); }
        .stat-value.pending { color: var(--warning); }
        .stat-value.total { color: var(--text); }

        .resumen-history {
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .resumen-history-header {
            font-weight: 700;
            font-size: 1.2em;
            color: var(--primary);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: grid;
            grid-template-columns: 1fr 2fr 1.5fr 1fr;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.85em;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date { font-weight: 600; }
        .history-pallet { font-family: monospace; }
        .history-status { font-weight: 700; }
        .history-user { color: #666; }

        .history-status.ok { color: var(--success); }
        .history-status.blocked { color: var(--blocked); }
        .history-status.nowms { color: var(--error); }


        /* Popups */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .popup-overlay.show {
            display: flex;
            opacity: 1;
        }

        .popup-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 300px;
            transform: scale(0.9);
            transition: transform 0.3s;
            position: relative;
        }

        .popup-overlay.show .popup-content {
            transform: scale(1);
        }

        .popup-header {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .popup-close:hover {
            color: #333;
        }

        .popup-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1em;
        }

        /* Buttons */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-google {
            background: #4285F4;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .btn-full {
            width: 100%;
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .notification {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }

        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Utilities */
        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 180px; }
            .columns-container { grid-template-columns: 1fr; }
            .resumen-stats { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; max-height: 200px; }
        }
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Cargando Inventario...</div>
            <div class="loading-subtext">Descargando base de datos desde Google Sheets</div>
        </div>
    </div>

    <div class="connection-banner" id="connection-banner"></div>
    <div class="notification-container" id="notifications"></div>

    <div class="popup-overlay" id="alias-popup-overlay">
        <div class="popup-content">
            <div class="popup-header">
                <span>üë§ Establecer Alias</span>
            </div>
            <p style="margin-bottom: 15px; font-size: 0.9em;">Ingresa un nombre corto que te identifique en el sistema:</p>
            <input type="text" id="alias-input" class="popup-input" placeholder="Ej: JUAN_ALM-01" maxlength="20">
            <button class="btn btn-primary btn-full" onclick="saveAlias()"> Guardar </button>
        </div>
    </div>

    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">üì¶</div>
            <h1 class="login-title">Sistema Inventario</h1>
            <p class="login-subtitle">Control y gesti√≥n de mercanc√≠a</p>
            <button class="btn btn-google btn-full" onclick="handleLogin()" style="padding: 15px; font-size: 1.1em;">
                üîê Iniciar sesi√≥n con Google
            </button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="main-container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>üì¶ Inventario</h2>
                    <p>Sistema de gesti√≥n</p>
                </div>

                <div id="sync-status" class="sync-status sync-ok">‚úÖ Sincronizado</div>

                <div class="sidebar-section">
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showResumen()"> üìä Resumen </button>
                    <button class="sidebar-btn sidebar-btn-quick" onclick="openQuickCapture()"> ‚ö° Captura R√°pida </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="newSession()"> üßπ Nueva Sesi√≥n </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="exportData()"> üì§ Exportar </button>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Pallets activos</div>
                    <div class="pallet-status-list">
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--success);">OK</span>
                                <span class="pallet-status-count" id="sidebar-ok-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-ok-pallet">-</div>
                        </div>
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--blocked);">Bloqueado</span>
                                <span class="pallet-status-count" id="sidebar-blocked-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-blocked-pallet">-</div>
                        </div>
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--error);">No WMS</span>
                                <span class="pallet-status-count" id="sidebar-nowms-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-nowms-pallet">-</div>
                        </div>
                    </div>
                </div>

                <div class="user-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar" onclick="showAliasPopup()">?</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name" onclick="showAliasPopup()">Usuario</div>
                            <div class="connection-indicator">
                                <div class="connection-dot offline" id="connection-dot"></div>
                                <span id="connection-text">Sin conexi√≥n</span>
                            </div>
                        </div>
                    </div>
                    <div class="user-footer-actions">
                        <button class="btn btn-secondary btn-small" onclick="loadInventory(true)">
                            üîÑ Actualizar BD
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="handleLogout()">
                            üö™ Salir
                        </button>
                    </div>
                    <div class="bd-info" id="bd-info">
                        BD: 0 c√≥digos cargados.
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="tabs-container">
                    <button class="tab-new-btn" onclick="TabManager.createTab('scan')"> + Nuevo</button>
                    <div class="tabs-list" id="tabs-list"></div>
                </div>

                <div class="tab-content-area" id="tab-content-area">
                    <div class="empty-workspace" id="empty-workspace">
                        <div class="empty-workspace-icon">üì¶</div>
                        <div class="empty-workspace-text">No hay pesta√±as abiertas</div>
                        <div class="empty-workspace-subtext">Haz clic en "+ Nuevo" para comenzar</div>
                    </div>
                    </div>
            </div>
            <div id="resumen-screen" class="resumen-screen hidden">
                <div class="header">
                    <h1>üìä Resumen General</h1>
                    <button class="btn btn-secondary" onclick="showApp()"> ‚¨Ö Volver al Escaneo</button>
                </div>
                <div class="resumen-stats">
                    <div class="stat-card">
                        <div class="stat-value total" id="resumen-total">0</div>
                        <div class="stat-label">Cajas Enviadas Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value ok" id="resumen-ok">0</div>
                        <div class="stat-label">Cajas OK</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value blocked" id="resumen-blocked">0</div>
                        <div class="stat-label">Cajas Bloqueadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value nowms" id="resumen-nowms">0</div>
                        <div class="stat-label">Cajas No WMS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value pending" id="resumen-pending">0</div>
                        <div class="stat-label">Pendientes por Sinc.</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--warning);" id="resumen-quick">0</div>
                        <div class="stat-label">Captura R√°pida (BD2)</div>
                    </div>
                </div>

                <div class="resumen-history">
                    <div class="resumen-history-header"> Historial de Pallets Enviados (√öltimos 10)</div>
                    <div class="history-list" id="history-list">
                        <div class="empty-state">
                            <div class="empty-icon">üìÇ</div>
                            <div>Sin historial</div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        const CONFIG = {
            CLIENT_ID: '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile',
            SPREADSHEET_WRITE: '1FBhZloEeT-xTe1yVKzdWxGJa6gKkZQOObmkBMuxqcv8',
            SHEET_NAME: 'BD',
            INVENTORY_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-HG8HPf-94Ki5Leo5iEF5pyqsiD9CVk-mcl-F8BAw34kT0s3nzNn532YTYDCtkG76NbauiVx0Ffmd/pub?output=csv',
            MAX_TABS: 4  /* AGREGAR ESTA L√çNEA (PASO 2.4) */
        };

        const STATE = {
            inventory: new Map(),
            inventoryLastUpdate: null,
            pallets: {
                ok: { id: generatePalletId('OK'), boxes: [], location: '' },
                blocked: { id: generatePalletId('BLK'), boxes: [], location: '' },
                nowms: { id: generatePalletId('NW'), boxes: [], location: '' }
            },
            pendingCode1: null,
            history: [],
            quickHistory: [] /* AGREGAR ESTA L√çNEA (PASO 4.7) */
        };

        let CURRENT_USER = '';
        let USER_EMAIL = '';
        let USER_GOOGLE_NAME = '';
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];
        let PENDING_SYNC_QUICK = []; /* AGREGAR ESTA L√çNEA (PASO 4.7) */
        let TOKEN_CLIENT = null;
        let audioCtx = null;


        // ==================== TAB MANAGER (PASO 3.1) ====================
        const TabManager = {
            tabs: [],
            activeTabId: null,
            nextId: 1,

            init() {
                this.loadState();
                this.updateUI();
                // Ensure there is at least one tab on first load if none are saved
                if (this.tabs.length === 0) {
                    this.createTab('scan');
                }
            },

            newSession() { /* FIX PARA PASO 4.5 */
                this.tabs = [];
                this.activeTabId = null;
                this.nextId = 1;
                this.updateUI();
                this.saveState();

                // Remove all tab content elements
                const contentArea = document.getElementById('tab-content-area');
                Array.from(contentArea.children).forEach(child => {
                    if (child.id !== 'empty-workspace') {
                        child.remove();
                    }
                });
                const emptyState = document.getElementById('empty-workspace');
                if (emptyState) emptyState.style.display = 'flex';
            },

            createTab(type = 'scan') { /* MODIFICADO (PASO 4.10) */
                if (this.tabs.length >= CONFIG.MAX_TABS) {
                    showNotification(`‚ùå M√°ximo ${CONFIG.MAX_TABS} pesta√±as`, 'warning');
                    return null;
                }

                const tabId = `tab-${this.nextId++}`;
                const title = type === 'quick' ? '‚ö° Captura R√°pida' : `üì¶ Escaneo ${this.nextId - 1}`;
                const tab = {
                    id: tabId,
                    title: title,
                    type: type,
                    timestamp: Date.now()
                };

                this.tabs.push(tab);
                this.createTabContent(tabId, type);
                this.setActiveTab(tabId);
                this.updateUI();
                this.saveState();

                return tabId;
            },

            createTabContent(tabId, type) { /* MODIFICADO (PASO 4.8) */
                const contentArea = document.getElementById('tab-content-area');
                const emptyState = document.getElementById('empty-workspace');
                if (emptyState) emptyState.style.display = 'none';

                const tabContent = document.createElement('div');
                tabContent.id = tabId;
                tabContent.className = 'tab-content';

                if (type === 'quick') {
                    tabContent.innerHTML = this.getQuickCaptureHTML(tabId);
                } else {
                    tabContent.innerHTML = this.getTabHTML(tabId);
                }

                contentArea.appendChild(tabContent);
                this.setupTabEventListeners(tabId, type);
            },

            getTabHTML(tabId) {
                return `
                    <div class="header">
                        <h1>üì¶ √Årea de Escaneo</h1>
                    </div>

                    <div class="scan-section">
                        <div class="scan-row">
                            <div class="scan-input-group">
                                <label>C√≥digo Principal</label>
                                <input type="text" class="scan-input" id="scan-input-${tabId}" placeholder="Escanea o ingresa c√≥digo..." autocomplete="off">
                            </div>
                        </div>

                        <div class="result-box" id="result-box-${tabId}">
                            <div class="result-header">
                                <span class="result-icon" id="result-icon-${tabId}"></span>
                                <span class="result-title" id="result-title-${tabId}">Estado</span>
                            </div>
                            <div class="result-code" id="result-code-${tabId}"></div>
                            <div class="result-details" id="result-details-${tabId}"></div>
                        </div>

                        <div class="code2-container" id="code2-container-${tabId}">
                            <label style="font-size: 0.9em; color: var(--error); font-weight: 600; margin-bottom: 8px; display: block;">
                                ‚ö†Ô∏è C√≥digo no encontrado. Ingresa C√≥digo 2 o fuerza el registro:
                            </label>
                            <div class="code2-row">
                                <div class="scan-input-group">
                                    <input type="text" class="scan-input" id="code2-input-${tabId}" placeholder="C√≥digo 2..." autocomplete="off" style="font-size: 1.1em;">
                                </div>
                                <button class="btn-insertado" onclick="TabManager.forceInsert('${tabId}')">
                                    ‚ö° INSERTADO
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="columns-container">
                        <div class="column ok">
                            <div class="column-header">
                                <span class="column-title">‚úÖ OK</span>
                                <span class="column-count" id="ok-count-${tabId}">0</span>
                            </div>
                            <div class="column-pallet-info">
                                <div>Pallet: <span class="column-pallet-code" id="ok-pallet-${tabId}">-</span></div>
                                <input type="text" class="column-location-input" id="location-ok-${tabId}" placeholder="üìç Ubicaci√≥n destino...">
                                <button class="column-send-btn" onclick="TabManager.sendPallet('${tabId}', 'ok')" id="send-ok-btn-${tabId}" disabled>
                                    üì§ Enviar Tarima OK
                                </button>
                            </div>
                            <div class="column-list" id="ok-list-${tabId}">
                                <div class="empty-state">
                                    <div class="empty-icon">üì≠</div>
                                    <div>Sin cajas</div>
                                </div>
                            </div>
                        </div>

                        <div class="column blocked">
                            <div class="column-header">
                                <span class="column-title">‚ö†Ô∏è Bloqueado</span>
                                <span class="column-count" id="blocked-count-${tabId}">0</span>
                            </div>
                            <div class="column-pallet-info">
                                <div>Pallet: <span class="column-pallet-code" id="blocked-pallet-${tabId}">-</span></div>
                                <input type="text" class="column-location-input" id="location-blocked-${tabId}" placeholder="üìç Ubicaci√≥n destino...">
                                <button class="column-send-btn" onclick="TabManager.sendPallet('${tabId}', 'blocked')" id="send-blocked-btn-${tabId}" disabled>
                                    üì§ Enviar Tarima Bloqueado
                                </button>
                            </div>
                            <div class="column-list" id="blocked-list-${tabId}">
                                <div class="empty-state">
                                    <div class="empty-icon">üì≠</div>
                                    <div>Sin cajas</div>
                                </div>
                            </div>
                        </div>

                        <div class="column nowms">
                            <div class="column-header">
                                <span class="column-title">‚ùå No WMS</span>
                                <span class="column-count" id="nowms-count-${tabId}">0</span>
                            </div>
                            <div class="column-pallet-info">
                                <div>Pallet: <span class="column-pallet-code" id="nowms-pallet-${tabId}">-</span></div>
                                <input type="text" class="column-location-input" id="location-nowms-${tabId}" placeholder="üìç Ubicaci√≥n destino...">
                                <button class="column-send-btn" onclick="TabManager.sendPallet('${tabId}', 'nowms')" id="send-nowms-btn-${tabId}" disabled>
                                    üì§ Enviar Tarima No WMS
                                </button>
                            </div>
                            <div class="column-list" id="nowms-list-${tabId}">
                                <div class="empty-state">
                                    <div class="empty-icon">üì≠</div>
                                    <div>Sin cajas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            getQuickCaptureHTML(tabId) { /* AGREGADO (PASO 4.9) */
                return `
                    <div class="header">
                        <h1>‚ö° Captura R√°pida (BD2)</h1>
                    </div>
                    <div class="scan-section">
                        <div class="scan-row">
                            <div class="scan-input-group">
                                <label>Escanear C√≥digo</label>
                                <input type="text" class="scan-input" id="quick-input-${tabId}" placeholder="Escanea c√≥digo..." autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="quick-log-container">
                        <div class="quick-log-header">üìù Log de Escaneos (√öltimos 100)</div>
                        <div class="quick-log-list" id="quick-log-${tabId}">
                            <div class="empty-state">
                                <div class="empty-icon">üìã</div>
                                <div>Sin escaneos</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            setupTabEventListeners(tabId, type) { /* MODIFICADO (PASO 4.11) */
                if (type === 'quick') {
                    const quickInput = document.getElementById(`quick-input-${tabId}`);
                    if (quickInput) {
                        quickInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' && quickInput.value.trim()) {
                                e.preventDefault();
                                this.processQuickScan(tabId, quickInput.value.trim());
                                quickInput.value = '';
                            }
                        });
                        setTimeout(() => quickInput.focus(), 100);
                    }
                    this.updateQuickLog(tabId);
                    return;
                }

                const scanInput = document.getElementById(`scan-input-${tabId}`);
                if (scanInput) {
                    scanInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && scanInput.value.trim()) {
                            e.preventDefault();
                            this.processScan(tabId, scanInput.value.trim());
                            scanInput.value = '';
                        }
                    });
                }

                const code2Input = document.getElementById(`code2-input-${tabId}`);
                if (code2Input) {
                    code2Input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && code2Input.value.trim()) {
                            e.preventDefault();
                            this.processCode2(tabId, code2Input.value.trim());
                            code2Input.value = '';
                        }
                    });
                }
                this.updateTabUI(tabId);
                setTimeout(() => scanInput.focus(), 100);
            },

            getTabPallets(tabId) { /* FUNCI√ìN DE AYUDA FALTANTE */
                // Nota: Asume que, a pesar de las pesta√±as, se utiliza el estado global `STATE.pallets`
                // para la gesti√≥n de tarimas, ya que no se proporcion√≥ una estructura de estado per-tab.
                return STATE.pallets;
            },

            processScan(tabId, rawCode) {
                this.flashInput(tabId, '');
                this.showResultBox(tabId, '', '...');
                document.getElementById(`code2-container-${tabId}`).classList.remove('show');
                STATE.pendingCode1 = { tabId, raw: rawCode, code: normalizeCode(rawCode) };

                const code = STATE.pendingCode1.code;
                const item = STATE.inventory.get(code);
                const resultBox = document.getElementById(`result-box-${tabId}`);

                if (!item) {
                    this.showResultBox(tabId, 'error', code, 'ERROR', 'C√≥digo no encontrado. Ingresa C√≥digo 2 o fuerza el registro:', null);
                    document.getElementById(`code2-container-${tabId}`).classList.add('show');
                    this.flashInput(tabId, 'error');
                    playSound('error');
                    setTimeout(() => document.getElementById(`code2-input-${tabId}`)?.focus(), 100);
                    return;
                }

                document.getElementById(`code2-container-${tabId}`).classList.remove('show');
                STATE.pendingCode1 = null;

                if (item.isBlocked) {
                    addBox('blocked', createBoxData(rawCode, code, '', item));
                    this.showResultBox(tabId, 'blocked', code, 'BLOQUEADO', 'Inventario bloqueado', item);
                    playSound('warning');
                } else if (item.isAvailable) {
                    addBox('ok', createBoxData(rawCode, code, '', item));
                    this.showResultBox(tabId, 'success', code, 'OK', 'Validado correctamente', item);
                    playSound('success');
                } else {
                    addBox('blocked', createBoxData(rawCode, code, '', item));
                    this.showResultBox(tabId, 'blocked', code, 'SIN STOCK', 'Sin stock disponible', item);
                    playSound('warning');
                }
                this.flashInput(tabId, 'success');
                this.updateTabUI(tabId);
            },

            processCode2(tabId, rawCode2) {
                if (!STATE.pendingCode1 || STATE.pendingCode1.tabId !== tabId) return;

                const code2 = normalizeCode(rawCode2);
                const item = STATE.inventory.get(code2);

                document.getElementById(`code2-container-${tabId}`).classList.remove('show');

                if (!item) {
                    this.showResultBox(tabId, 'error', STATE.pendingCode1.code, 'ERROR', 'C√≥digo 2 no encontrado. Usa INSERTADO', null);
                    this.flashInput(tabId, 'error');
                    playSound('error');
                    setTimeout(() => document.getElementById(`code2-input-${tabId}`)?.focus(), 100);
                    return;
                }

                if (item.isBlocked || !item.isAvailable) {
                    addBox('blocked', createBoxData(STATE.pendingCode1.raw, code2, rawCode2, item));
                    this.showResultBox(tabId, 'blocked', code2, 'BLOQUEADO', 'Validado con C√≥digo 2 - Bloqueado', item);
                    playSound('warning');
                } else {
                    addBox('ok', createBoxData(STATE.pendingCode1.raw, code2, rawCode2, item));
                    this.showResultBox(tabId, 'success', code2, 'OK (C√≥digo 2)', 'Validado correctamente con C√≥digo 2', item);
                    playSound('success');
                }

                STATE.pendingCode1 = null;
                this.flashInput(tabId, 'success');
                document.getElementById(`scan-input-${tabId}`)?.focus();
                this.updateTabUI(tabId);
            },

            processQuickScan(tabId, rawCode) { /* AGREGADO (PASO 4.12) */
                const code = normalizeCode(rawCode);
                const now = new Date();
                const dateStr = now.toLocaleDateString();
                const timeStr = now.toLocaleTimeString();

                const item = STATE.inventory.get(code);
                let status = 'NO ENCONTRADO';
                let statusClass = 'error';
                let usedCode2 = false;
                let actualCode = code;

                if (item) {
                    status = item.isAvailable ? 'OK' : 'BLOQUEADO';
                    statusClass = item.isAvailable ? 'success' : 'blocked';
                    playSound(item.isAvailable ? 'success' : 'warning');
                } else {
                    // Buscar C√≥digo 2 autom√°tico
                    for (const [, invItem] of STATE.inventory) {
                        if (normalizeCode(invItem.code2) === code) {
                            actualCode = normalizeCode(invItem.code);
                            status = invItem.isAvailable ? 'OK' : 'BLOQUEADO';
                            statusClass = invItem.isAvailable ? 'success' : 'blocked';
                            usedCode2 = true;
                            playSound(invItem.isAvailable ? 'success' : 'warning');
                            break;
                        }
                    }
                }

                const entry = {
                    date: dateStr,
                    time: timeStr,
                    user: CURRENT_USER || 'Usuario',
                    scan1: rawCode,
                    scan2: usedCode2 ? actualCode : '',
                    location: item?.cellNo || '-',
                    status,
                    note: usedCode2 ? 'C√≥digo alternativo usado autom√°ticamente' : '',
                    pallet: '-',
                    displayTime: now.toLocaleTimeString()
                };

                STATE.quickHistory.unshift(entry);
                STATE.quickHistory = STATE.quickHistory.slice(0, 100);
                PENDING_SYNC_QUICK.push(entry);
                SyncManager.save();
                this.updateQuickLog(tabId);

                if (IS_ONLINE && gapi?.client?.getToken()) {
                    SyncManager.syncQuick(false);
                }
                this.flashInput(tabId, statusClass);
            },

            forceInsert(tabId) {
                if (!STATE.pendingCode1 || STATE.pendingCode1.tabId !== tabId) {
                    showNotification('‚ùå Primero escanea un c√≥digo', 'warning');
                    return;
                }

                const code2Value = document.getElementById(`code2-input-${tabId}`)?.value.trim() || '';
                addBox('nowms', createBoxData(
                    STATE.pendingCode1.raw,
                    STATE.pendingCode1.code,
                    code2Value,
                    null
                ));

                const msg = code2Value ?
                    `Insertado con c√≥digos: ${STATE.pendingCode1.code} y ${code2Value}` :
                    `Insertado con c√≥digo: ${STATE.pendingCode1.code}`;

                this.showResultBox(tabId, 'error', STATE.pendingCode1.code, 'INSERTADO (No WMS)', msg, null);
                document.getElementById(`code2-container-${tabId}`).classList.remove('show');
                const code2Input = document.getElementById(`code2-input-${tabId}`);
                if (code2Input) code2Input.value = '';
                STATE.pendingCode1 = null;
                playSound('warning');
                this.flashInput(tabId, 'warning');
                document.getElementById(`scan-input-${tabId}`)?.focus();
                this.updateTabUI(tabId);
                showNotification('‚ö° Caja forzada a No WMS', 'warning');
            },

            clearPalletData(tabId, category) {
                const pallet = this.getTabPallets(tabId)[category];
                pallet.boxes = [];
                pallet.location = '';
                pallet.id = generatePalletId(category.toUpperCase().substring(0, 3));
                saveToStorage();
                this.updateTabUI(tabId);
                updateUI();
            },

            async sendPallet(tabId, category) {
                const pallet = this.getTabPallets(tabId)[category];
                const locationInput = document.getElementById(`location-${category}-${tabId}`);
                const location = locationInput?.value.trim() || '';

                if (pallet.boxes.length === 0) {
                    showNotification('‚ùå No hay cajas en esta tarima', 'warning');
                    return;
                }

                if (!location && category !== 'nowms') {
                    showNotification('‚ùå Ingresa la ubicaci√≥n destino', 'warning');
                    locationInput?.focus();
                    return;
                }

                if (category !== 'nowms') {
                    const validation = validateLocation(location);
                    if (!validation.valid) {
                        showNotification(validation.message, 'warning');
                        showNotification(validation.details, 'warning');
                        locationInput?.focus();
                        return;
                    }
                }

                const confirmMessage = `¬øConfirmar env√≠o de ${pallet.boxes.length} caja(s) de la categor√≠a ${category.toUpperCase()} al sistema?`;
                if (!confirm(confirmMessage)) return;

                const success = await this.addPalletToSync(tabId, category, location);
                if (success) {
                    showNotification(`‚úÖ Pallet ${pallet.id} agregado a sincronizaci√≥n.`, 'success');
                    this.clearPalletData(tabId, category);
                } else {
                    showNotification(`‚ùå Error al agregar pallet ${pallet.id}.`, 'error');
                }
            },

            async addPalletToSync(tabId, category, location) {
                const pallet = this.getTabPallets(tabId)[category];
                if (pallet.boxes.length === 0) return false;

                const palletData = {
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    user: CURRENT_USER || 'Usuario',
                    palletId: pallet.id,
                    location: location,
                    boxes: pallet.boxes,
                    category: category.toUpperCase()
                };

                // Add to history and pending sync queue
                STATE.history.unshift(palletData);
                STATE.history = STATE.history.slice(0, 10);
                PENDING_SYNC.push(palletData);
                SyncManager.save();

                // Clear boxes in the active pallet
                pallet.boxes = [];
                pallet.id = generatePalletId(category.toUpperCase().substring(0, 3));
                pallet.location = '';

                // Try to sync immediately
                if (IS_ONLINE && gapi?.client?.getToken()) {
                    await SyncManager.sync();
                }

                saveToStorage();
                updateUI();

                return true;
            },

            updateTabUI(tabId) {
                this.updatePalletInfo(tabId, 'ok');
                this.updatePalletInfo(tabId, 'blocked');
                this.updatePalletInfo(tabId, 'nowms');
                this.updateLists(tabId);
                updateSidebar(); // Update global sidebar counts
                updateResumen();
            },

            updatePalletInfo(tabId, category) { /* MODIFICADO (PASO 4.18) */
                const pallet = this.getTabPallets(tabId)[category];
                document.getElementById(`${category}-pallet-${tabId}`).textContent = pallet.id;
                document.getElementById(`${category}-count-${tabId}`).textContent = pallet.boxes.length;
                document.getElementById(`location-${category}-${tabId}`).value = pallet.location;
                // AGREGADO (PASO 4.18)
                document.getElementById(`location-${category}-${tabId}`).disabled = category === 'nowms';
                // FIN AGREGADO
                document.getElementById(`send-${category}-btn-${tabId}`).disabled = pallet.boxes.length === 0 || (!pallet.location && category !== 'nowms');
            },

            updateLists(tabId) {
                this.updateList(tabId, 'ok');
                this.updateList(tabId, 'blocked');
                this.updateList(tabId, 'nowms');
            },

            updateList(tabId, category) {
                const listEl = document.getElementById(`${category}-list-${tabId}`);
                const boxes = this.getTabPallets(tabId)[category].boxes;

                if (boxes.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div>Sin cajas</div>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = boxes.map((box, index) => `
                    <div class="box-item">
                        <div class="box-info">
                            <div class="box-code">${box.code}${box.scan2 ? ` / ${box.scan2}` : ''}</div>
                            <div class="box-meta">${box.location} ‚Ä¢ ${box.timestamp}</div>
                        </div>
                        <button class="box-delete" onclick="TabManager.deleteBox('${tabId}', '${category}', ${index})">‚úï</button>
                    </div>
                `).join('');
            },

            updateQuickLog(tabId) { /* AGREGADO (PASO 4.13) */
                const logEl = document.getElementById(`quick-log-${tabId}`);
                if (!logEl) return;

                if (STATE.quickHistory.length === 0) {
                    logEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <div>Sin escaneos</div>
                        </div>
                    `;
                    return;
                }

                logEl.innerHTML = STATE.quickHistory.map(entry => `
                    <div class="quick-log-item ${entry.status === 'OK' ? 'success' : entry.status === 'BLOQUEADO' || entry.status === 'NO ENCONTRADO' ? 'blocked' : 'error'}">
                        <div class="quick-log-info">
                            <div class="quick-log-code">${entry.scan1} ${entry.scan2 ? `(${entry.scan2})` : ''}</div>
                            <div class="quick-log-status">
                                ${entry.status === 'OK' ? '‚úÖ OK' : entry.status === 'BLOQUEADO' ? '‚ö†Ô∏è BLOQUEADO' : '‚ùå NO ENCONTRADO'}
                                ${entry.note ? ` - ${entry.note}` : ''}
                            </div>
                        </div>
                        <div class="quick-log-time">${entry.displayTime}</div>
                    </div>
                `).join('');
            },

            showResultBox(tabId, type, code, title, message, item) {
                const resultBox = document.getElementById(`result-box-${tabId}`);
                const iconEl = document.getElementById(`result-icon-${tabId}`);
                const titleEl = document.getElementById(`result-title-${tabId}`);
                const codeEl = document.getElementById(`result-code-${tabId}`);
                const detailsEl = document.getElementById(`result-details-${tabId}`);

                resultBox.classList.remove('show', 'success', 'warning', 'blocked', 'error');
                resultBox.classList.add('show', type);

                const icons = { 'success': '‚úÖ', 'warning': '‚ö†Ô∏è', 'blocked': '‚ö†Ô∏è', 'error': '‚ùå' };
                iconEl.textContent = icons[type] || '‚ìò';
                titleEl.textContent = title;
                codeEl.textContent = code;

                if (item) {
                    detailsEl.innerHTML = `
                        <div><span class="result-detail-label">Ubicaci√≥n</span><div class="result-detail-value">${item.cellNo || '-'}</div></div>
                        <div><span class="result-detail-label">SKU</span><div class="result-detail-value">${item.sku || '-'}</div></div>
                        <div><span class="result-detail-label">Producto</span><div class="result-detail-value">${item.productName || '-'}</div></div>
                        <div><span class="result-detail-label">Stock</span><div class="result-detail-value">${item.availableStock || 0}</div></div>
                    `;
                } else {
                    detailsEl.innerHTML = `<div style="grid-column: 1/-1; color: #666;">${message}</div>`;
                }
            },

            flashInput(tabId, type) {
                const input = document.getElementById(`scan-input-${tabId}`);
                if (!input) return;
                input.classList.remove('success', 'error', 'warning');
                input.classList.add(type === 'success' ? 'success' : type === 'error' || type === 'blocked' ? 'error' : type === 'warning' ? 'warning' : '');
                setTimeout(() => input.classList.remove('success', 'error', 'warning'), 500);
            },

            deleteBox(tabId, category, index) {
                if (confirm('¬øEliminar esta caja?')) {
                    this.getTabPallets(tabId)[category].boxes.splice(index, 1);
                    saveToStorage();
                    this.updateTabUI(tabId);
                    updateUI();
                    showNotification('Caja eliminada', 'info');
                }
            },

            closeTab(tabId) {
                const tabIndex = this.tabs.findIndex(t => t.id === tabId);
                if (tabIndex === -1) return;

                const tab = this.tabs[tabIndex];

                if (tab.type === 'scan' && this.hasPalletData(tabId)) {
                    if (!confirm(`‚ö†Ô∏è La pesta√±a "${tab.title}" tiene cajas sin enviar. ¬øDeseas cerrarla de todos modos?`)) {
                        return;
                    }
                    // Clear pallet data if confirmed to close with data
                    this.clearPalletData(tabId, 'ok');
                    this.clearPalletData(tabId, 'blocked');
                    this.clearPalletData(tabId, 'nowms');
                }

                this.tabs.splice(tabIndex, 1);
                document.getElementById(tabId)?.remove();

                if (this.activeTabId === tabId) {
                    let newActiveTab = this.tabs[tabIndex] || this.tabs[tabIndex - 1];
                    this.activeTabId = newActiveTab ? newActiveTab.id : null;
                }

                this.updateUI();
                this.saveState();

                if (this.tabs.length === 0) {
                    this.createTab('scan');
                }
            },

            setActiveTab(tabId) {
                if (this.activeTabId === tabId) return;
                this.activeTabId = tabId;

                document.querySelectorAll('.tab-content').forEach(el => {
                    el.classList.toggle('active', el.id === tabId);
                });
                document.querySelectorAll('.tab-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.tabId === tabId);
                });

                const activeTab = this.tabs.find(t => t.id === tabId);
                if (activeTab && activeTab.type === 'scan') {
                    this.updateTabUI(tabId);
                } else if (activeTab && activeTab.type === 'quick') {
                    this.updateQuickLog(tabId);
                }

                setTimeout(() => {
                    if (activeTab.type === 'scan') {
                        document.getElementById(`scan-input-${tabId}`)?.focus();
                    } else if (activeTab.type === 'quick') {
                        document.getElementById(`quick-input-${tabId}`)?.focus();
                    }
                }, 100);
                this.saveState();
            },

            hasPalletData(tabId) { /* FUNCI√ìN DE AYUDA FALTANTE (PARA PASO 4.6) */
                const pallet = this.getTabPallets(tabId);
                if (!pallet) return false;
                return pallet.ok.boxes.length > 0 || pallet.blocked.boxes.length > 0 || pallet.nowms.boxes.length > 0;
            },

            updateUI() {
                const tabsList = document.getElementById('tabs-list');
                if (!tabsList) return;

                if (this.tabs.length === 0) {
                    tabsList.innerHTML = '';
                    const emptyState = document.getElementById('empty-workspace');
                    if (emptyState) emptyState.style.display = 'flex';
                    return;
                }

                const emptyState = document.getElementById('empty-workspace');
                if (emptyState) emptyState.style.display = 'none';

                tabsList.innerHTML = this.tabs.map(tab => `
                    <div class="tab-item ${tab.id === this.activeTabId ? 'active' : ''}" data-tab-id="${tab.id}" onclick="TabManager.setActiveTab('${tab.id}')">
                        <span>${tab.title}</span>
                        <button class="tab-close" onclick="event.stopPropagation(); TabManager.closeTab('${tab.id}')">√ó</button>
                    </div>
                `).join('');

                // Ensure the active tab content is shown, especially on load
                this.setActiveTab(this.activeTabId);
            },

            saveState() {
                try {
                    const state = { tabs: this.tabs, activeTabId: this.activeTabId, nextId: this.nextId };
                    localStorage.setItem('pd_tabs_state', JSON.stringify(state));
                } catch (e) {
                    console.error('Error saving tab state:', e);
                }
            },

            loadState() {
                try {
                    const saved = localStorage.getItem('pd_tabs_state');
                    if (saved) {
                        const state = JSON.parse(saved);
                        this.tabs = state.tabs || [];
                        this.activeTabId = state.activeTabId;
                        this.nextId = state.nextId || 1;

                        // Recreate tab DOM elements
                        const contentArea = document.getElementById('tab-content-area');
                        if (contentArea) {
                            this.tabs.forEach(tab => this.createTabContent(tab.id, tab.type));
                        }
                    }
                } catch (e) {
                    console.error('Error loading tab state:', e);
                }
            }
        };

        // ==================== SYNC MANAGER ====================
        const SyncManager = {
            inProgress: false,
            retryCount: 0,
            intervalId: null,
            AUTO_SYNC_INTERVAL: 30000,

            init() {
                this.load();
                this.startAutoSync();
                this.setupExitProtection();
                this.updateUI(PENDING_SYNC.length === 0 && PENDING_SYNC_QUICK.length === 0);
            },

            setupExitProtection() {
                window.addEventListener('beforeunload', (e) => {
                    const hasUnsavedData = PENDING_SYNC.length > 0 || PENDING_SYNC_QUICK.length > 0 || TabManager.tabs.some(tab => TabManager.hasPalletData(tab.id));
                    if (hasUnsavedData) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            },

            async save() { /* MODIFICADO (PASO 4.19) */
                try {
                    localStorage.setItem('pd_pending_sync', JSON.stringify(PENDING_SYNC));
                    localStorage.setItem('pd_pending_sync_quick', JSON.stringify(PENDING_SYNC_QUICK));
                } catch (e) {
                    console.error('Error saving pending sync data:', e);
                }
            },

            async load() { /* MODIFICADO (PASO 4.20) */
                try {
                    const saved = localStorage.getItem('pd_pending_sync');
                    if (saved) PENDING_SYNC = JSON.parse(saved);
                    const savedQuick = localStorage.getItem('pd_pending_sync_quick');
                    if (savedQuick) PENDING_SYNC_QUICK = JSON.parse(savedQuick);
                } catch (e) {
                    console.error('Error loading pending sync data:', e);
                }
            },

            updateUI(synced) { /* REEMPLAZADO (PASO 4.15) */
                const el = document.getElementById('sync-status');
                if (!el) return;
                const totalPending = PENDING_SYNC.length + PENDING_SYNC_QUICK.length;
                if (!IS_ONLINE) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `‚ö†Ô∏è Sin conexi√≥n${totalPending > 0 ? ` (${totalPending})` : ''}`;
                } else if (totalPending > 0) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `‚è≥ ${totalPending} pendientes`;
                } else if (synced) {
                    el.className = 'sync-status sync-ok';
                    el.textContent = '‚úÖ Sincronizado';
                } else {
                    el.className = 'sync-status sync-error';
                    el.textContent = '‚ùå Error sync';
                }
            },

            showPanel() {
                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay show';
                overlay.innerHTML = `
                    <div class="popup-content" style="max-width: 450px;">
                        <div class="popup-header">
                            <span>üìä Estado de Sincronizaci√≥n</span>
                            <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                        </div>
                        <p style="font-size: 0.9em; margin-bottom: 15px;">Hay ${PENDING_SYNC.length} tarimas y ${PENDING_SYNC_QUICK.length} registros de Captura R√°pida pendientes por enviar.</p>
                        <button class="btn btn-primary btn-full" onclick="SyncManager.sync(true)"> üîÑ Forzar Sincronizaci√≥n </button>
                        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
                            <h3 style="font-size: 1em; margin-bottom: 5px;">Tarimas Pendientes (BD)</h3>
                            <ul style="max-height: 150px; overflow-y: auto; list-style: none; padding: 0;">
                                ${PENDING_SYNC.map(p => `<li style="font-family: monospace; font-size: 0.8em; margin-bottom: 3px; padding: 3px; background: #f9f9f9; border-radius: 4px;">${p.palletId} (${p.boxes.length} cajas) - ${p.category}</li>`).join('')}
                                ${PENDING_SYNC.length === 0 ? '<li style="color: #999;">Nada pendiente en BD.</li>' : ''}
                            </ul>
                            <h3 style="font-size: 1em; margin-top: 15px; margin-bottom: 5px;">Registros R√°pidos Pendientes (BD2)</h3>
                            <ul style="max-height: 150px; overflow-y: auto; list-style: none; padding: 0;">
                                ${PENDING_SYNC_QUICK.map(q => `<li style="font-family: monospace; font-size: 0.8em; margin-bottom: 3px; padding: 3px; background: #f9f9f9; border-radius: 4px;">${q.scan1} - ${q.status}</li>`).join('')}
                                ${PENDING_SYNC_QUICK.length === 0 ? '<li style="color: #999;">Nada pendiente en BD2.</li>' : ''}
                            </ul>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            },

            startAutoSync() {
                if (this.intervalId) clearInterval(this.intervalId);
                this.intervalId = setInterval(() => { /* MODIFICADO (PASO 4.21) */
                    if (IS_ONLINE && gapi?.client?.getToken()) {
                        if (PENDING_SYNC.length > 0) this.sync();
                        if (PENDING_SYNC_QUICK.length > 0) this.syncQuick();
                    }
                }, this.AUTO_SYNC_INTERVAL);
            },

            async sync(showMessages = true) {
                if (this.inProgress) {
                    if (showMessages) showNotification('üîÑ Sincronizaci√≥n en progreso...', 'info');
                    return { success: false };
                }
                if (!IS_ONLINE || !gapi?.client?.getToken() || PENDING_SYNC.length === 0) return { success: true };

                this.inProgress = true;
                updateConnectionIndicator(true);
                if (showMessages) showNotification(`üîÑ Enviando ${PENDING_SYNC.length} tarima(s)...`, 'info');

                try {
                    await this.sendToWMS();
                    if (PENDING_SYNC_QUICK.length > 0) this.syncQuick(false); /* AGREGADO (PASO 4.17) */

                    if (showMessages) showNotification('‚úÖ Sincronizaci√≥n completa', 'success');
                    this.retryCount = 0;
                    this.updateUI(true);
                    updateResumen();
                    return { success: true };
                } catch (e) {
                    console.error('Sync failed:', e);
                    this.retryCount++;
                    if (showMessages) showNotification(`‚ùå Error de sincronizaci√≥n. Reintentando en ${this.AUTO_SYNC_INTERVAL / 1000}s`, 'error');
                    this.updateUI(false);
                    return { success: false };
                } finally {
                    this.inProgress = false;
                    updateConnectionIndicator(false);
                }
            },

            async syncQuick(showMessages = true) { /* AGREGADO (PASO 4.16) */
                if (this.inProgress) {
                    if (showMessages) showNotification('üîÑ Sincronizaci√≥n en progreso...', 'info');
                    return { success: false };
                }
                if (!IS_ONLINE || !gapi?.client?.getToken() || PENDING_SYNC_QUICK.length === 0) return { success: true };

                this.inProgress = true;
                updateConnectionIndicator(true);
                if (showMessages) showNotification(`üîÑ Enviando ${PENDING_SYNC_QUICK.length} registros BD2...`, 'info');

                try {
                    await this.sendToBD2();

                    if (showMessages) showNotification('‚úÖ Sincronizaci√≥n BD2 completa', 'success');
                    this.updateUI(PENDING_SYNC.length === 0 && PENDING_SYNC_QUICK.length === 0);
                    updateResumen();
                    return { success: true };
                } catch (e) {
                    console.error('Quick Sync failed:', e);
                    if (showMessages) showNotification(`‚ùå Error de sincronizaci√≥n BD2.`, 'error');
                    this.updateUI(false);
                    return { success: false };
                } finally {
                    this.inProgress = false;
                    updateConnectionIndicator(false);
                }
            },

            async sendToWMS() {
                const pendingData = PENDING_SYNC;
                if (pendingData.length === 0) return;

                const values = pendingData.flatMap(pallet =>
                    pallet.boxes.map(box => [
                        pallet.date,
                        pallet.time,
                        pallet.user,
                        box.code,
                        box.scan2 || '',
                        box.rawCode,
                        box.rawCode2 || '',
                        pallet.location,
                        pallet.palletId,
                        box.boxType,
                        pallet.category,
                        box.item?.cellNo || '',
                        box.item?.sku || '',
                        box.item?.productName || ''
                    ])
                );

                const resource = {
                    values: values,
                };

                const response = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                    range: `${CONFIG.SHEET_NAME}!A:N`,
                    valueInputOption: 'USER_ENTERED',
                    insertDataOption: 'INSERT_ROWS',
                    resource: resource,
                });

                if (response.result.updates.updatedRows > 0) {
                    PENDING_SYNC = [];
                    await this.save();
                } else {
                    throw new Error('No rows updated.');
                }
            },

            async sendToBD2() { /* AGREGADO (PASO 4.16) */
                const pendingData = PENDING_SYNC_QUICK;
                if (pendingData.length === 0) return;

                const values = pendingData.map(entry => [
                    entry.date,
                    entry.time,
                    entry.user,
                    entry.scan1,
                    entry.scan2,
                    entry.location,
                    entry.status,
                    entry.note
                ]);

                const resource = {
                    values: values,
                };

                const response = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                    range: 'BD2!A:H', // Asumir hoja BD2
                    valueInputOption: 'USER_ENTERED',
                    insertDataOption: 'INSERT_ROWS',
                    resource: resource,
                });

                if (response.result.updates.updatedRows > 0) {
                    PENDING_SYNC_QUICK = [];
                    await this.save();
                } else {
                    throw new Error('No rows updated in BD2.');
                }
            }
        };

        // ==================== GOOGLE AUTH & INIT ====================

        function initClient() {
            gapi.client.init({
                apiKey: 'YOUR_API_KEY', // Not strictly needed for public sheet CSV, but good practice
                clientId: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
            }).then(() => {
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            gapi.client.setToken(tokenResponse);
                            handleAuthResult(tokenResponse);
                        } else {
                            updateSigninStatus(false);
                        }
                    },
                });
                updateSigninStatus(gapi.client.getToken() !== null);
            });
        }

        function handleLogin() {
            // üîë CORRECCI√ìN CLAVE: Verifica que TOKEN_CLIENT est√© inicializado
            if (!TOKEN_CLIENT) {
                showNotification('‚ùå El sistema de autenticaci√≥n no est√° listo. Intenta recargar la p√°gina o espera un momento.', 'error');
                console.error("Error: TOKEN_CLIENT no ha sido inicializado.");
                return; 
            }
            
            // Si el cliente est√° listo, solicita el token de acceso.
            TOKEN_CLIENT.requestAccessToken();
        }

        async function handleAuthResult(authResult) {
            if (authResult && authResult.access_token) {
                // Fetch user info
                await gapi.client.request({
                    path: 'https://www.googleapis.com/oauth2/v2/userinfo',
                    method: 'GET'
                }).then(response => {
                    const data = response.result;
                    USER_EMAIL = data.email || '';
                    USER_GOOGLE_NAME = data.name || 'Usuario';
                    const savedAlias = localStorage.getItem(`pd_alias_${USER_EMAIL}`);
                    if (savedAlias) {
                        CURRENT_USER = savedAlias;
                        showNotification(`‚úÖ Bienvenido, ${CURRENT_USER}`, 'success');
                        updateUserFooter();
                    } else {
                        showAliasPopup();
                    }
                }).catch(error => {
                    console.error('Error fetching user info:', error);
                    CURRENT_USER = 'Usuario';
                    updateUserFooter();
                });

                updateSigninStatus(true);
                showApp();
                await loadInventory();
            } else {
                updateSigninStatus(false);
            }
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                // If signed in, ensure background sync is running
                SyncManager.init();
            }
            // Logic to show/hide login/app screen is in showApp/handleLogout
        }

        function showAliasPopup() {
            document.getElementById('alias-popup-overlay').classList.add('show');
            document.getElementById('alias-input').value = CURRENT_USER || USER_GOOGLE_NAME.split(' ')[0].toUpperCase();
            document.getElementById('alias-input').focus();
        }

        function saveAlias() {
            const alias = document.getElementById('alias-input').value.trim().toUpperCase();
            if (alias) {
                CURRENT_USER = alias;
                localStorage.setItem(`pd_alias_${USER_EMAIL}`, CURRENT_USER);
                document.getElementById('alias-popup-overlay').classList.remove('show');
                showNotification(`‚úÖ Alias guardado: ${CURRENT_USER}`, 'success');
                updateUserFooter();
            } else {
                showNotification('‚ùå Ingresa un alias v√°lido', 'error');
            }
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateUserFooter();
            updateUI();
        }

        function handleLogout() {
            /* MODIFICADO (PASO 4.6) */
            const hasData = PENDING_SYNC.length > 0 || PENDING_SYNC_QUICK.length > 0 || TabManager.tabs.some(tab => TabManager.hasPalletData(tab.id));
            if (hasData) {
                if (!confirm('‚ö†Ô∏è Tienes datos sin sincronizar. ¬øSeguro que quieres salir?')) {
                    return;
                }
            }
            if (gapi.client.getToken()) {
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                gapi.client.setToken(null);
            }
            CURRENT_USER = '';
            USER_EMAIL = '';
            USER_GOOGLE_NAME = '';
            localStorage.removeItem('pd_tabs_state');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            updateSigninStatus(false);
            SyncManager.intervalId = null; // Stop auto-sync
            location.reload(); // Simplest way to reset state/UI completely
        }

        // ==================== DATA MANAGEMENT ====================

        async function loadInventory(force = false) {
            if (!force && STATE.inventoryLastUpdate && (Date.now() - STATE.inventoryLastUpdate < 3600000)) {
                showNotification(`‚ìò Usando ${STATE.inventory.size} c√≥digos en cach√©. √öltima actualizaci√≥n: ${new Date(STATE.inventoryLastUpdate).toLocaleTimeString()}`, 'info');
                updateBdInfo();
                updateConnectionIndicator();
                return;
            }

            /* MODIFICADO (PASO 1.4) */
            showLoading('üîÑ Cargando Inventario...', 'Descargando base de datos desde Google Sheets');
            updateConnectionIndicator(true);

            try {
                const response = await fetch(CONFIG.INVENTORY_CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csv = await response.text();
                if (!csv || csv.trim().length === 0) throw new Error('CSV vac√≠o');

                parseInventoryCSV(csv);
                STATE.inventoryLastUpdate = Date.now();
                await saveToStorage();

                /* MODIFICADO (PASO 1.4) */
                hideLoading();
                showNotification(`‚úÖ ${STATE.inventory.size} c√≥digos cargados`, 'success');

                updateBdInfo();
            } catch (e) {
                /* AGREGADO (PASO 1.4) */
                hideLoading();
                console.error('Error cargando inventario:', e);
                showNotification(`‚ö†Ô∏è Error al cargar inventario: ${e.message}`, 'warning');
                if (STATE.inventory.size > 0) {
                    showNotification(`Usando ${STATE.inventory.size} c√≥digos en cach√©`, 'info');
                }
            } finally {
                updateConnectionIndicator(false);
            }
        }

        function parseInventoryCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim().length > 0);
            STATE.inventory.clear();

            // Find header to correctly map columns (assuming first row is header)
            const headers = parseCSVLine(lines[0]);
            const columnMap = {
                boxType: headers.findIndex(h => h.includes('TIPO DE CAJA')),
                code: headers.findIndex(h => h.includes('C√ìDIGO PRINCIPAL')),
                code2: headers.findIndex(h => h.includes('C√ìDIGO ALTERNATIVO')),
                cellNo: headers.findIndex(h => h.includes('UBICACI√ìN')),
                sku: headers.findIndex(h => h.includes('SKU')),
                productName: headers.findIndex(h => h.includes('PRODUCTO')),
                availableStock: headers.findIndex(h => h.includes('STOCK DISPONIBLE')),
                lockedInventory: headers.findIndex(h => h.includes('STOCK BLOQUEADO')),
                isAvailable: headers.findIndex(h => h.includes('DISPONIBLE (SI/NO)')),
                isBlocked: headers.findIndex(h => h.includes('BLOQUEADO (SI/NO)')),
            };


            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);

                const codeIndex = columnMap.code;
                const code2Index = columnMap.code2;
                const availableStockIndex = columnMap.availableStock;
                const lockedInventoryIndex = columnMap.lockedInventory;
                const isAvailableIndex = columnMap.isAvailable;
                const isBlockedIndex = columnMap.isBlocked;


                if (cols.length > Math.max(...Object.values(columnMap).filter(v => v !== -1))) {
                    const code = (cols[codeIndex] || '').toString().trim().toUpperCase();
                    if (code && code.length > 0) {
                        const availableStock = parseFloat(cols[availableStockIndex]) || 0;
                        const lockedInventory = parseFloat(cols[lockedInventoryIndex]) || 0;
                        const isAvailable = (cols[isAvailableIndex] || '').toUpperCase() === 'SI' && (availableStock > 0);
                        const isBlocked = (cols[isBlockedIndex] || '').toUpperCase() === 'SI' || (lockedInventory > 0);

                        STATE.inventory.set(code, {
                            code,
                            code2: cols[code2Index] || '',
                            boxType: cols[columnMap.boxType] || '',
                            cellNo: cols[columnMap.cellNo] || '',
                            sku: cols[columnMap.sku] || '',
                            productName: cols[columnMap.productName] || '',
                            availableStock,
                            lockedInventory,
                            isAvailable,
                            isBlocked
                        });
                    }
                }
            }
        }

        // ==================== UTILITIES ====================

        function generatePalletId(prefix) {
            const date = new Date();
            const year = date.getFullYear().toString().substring(2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const time = date.getTime().toString().slice(-4);
            return `${prefix}-${year}${month}${day}-${time}`;
        }

        function createBoxData(rawCode, code, rawCode2, item) {
            const timestamp = new Date().toLocaleTimeString();
            return {
                rawCode,
                code,
                rawCode2,
                scan2: rawCode2 ? normalizeCode(rawCode2) : '',
                boxType: item?.boxType || 'N/A',
                location: item?.cellNo || 'N/A',
                item,
                timestamp
            };
        }

        function parseCSVLine(line) {
            // Simple CSV parser for this case (handles commas outside of quotes)
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function normalizeCode(rawCode) {
            let code = rawCode.trim().toUpperCase();
            // Replace - with / or vice-versa
            if (code.includes('-') && !code.includes('/')) {
                // Heuristic: If it looks like a / code = code.replace(/(\d)-(\d)/g, '$1/$2');
            }
            // Limpiar caracteres especiales excepto guiones, diagonales y letras/n√∫meros
            return code.replace(/[^a-zA-Z0-9\-\/]/g, '');
        }

        // ==================== VALIDADOR DE UBICACIONES ====================
        /**
         * Valida el formato de ubicaci√≥n del almac√©n
         * Formato: [LETRA][N√öMERO]-[N√öMERO]-[N√öMERO]-[N√öMERO]
         * Ejemplo: A21-06-05-01, B27-01-04-01
         */
        function validateLocation(location) {
            const loc = location.trim().toUpperCase();
            // Patr√≥n: LETRA + N√öMEROS + GUION + N√öMEROS + GUION + N√öMEROS + GUION + N√öMEROS
            const pattern = /^([A-Z])(\d{1,3})-(\d{1,2})-(\d{1,2})-(\d{1,2})$/;
            const match = loc.match(pattern);
            if (!match) {
                return { valid: false, message: '‚ùå Formato inv√°lido', details: 'La ubicaci√≥n debe seguir el formato: [LETRA][NUM]-[NUM]-[NUM]-[NUM]' };
            }

            const [_, letter, aisle, bay, level, pos] = match;

            // Simple checks (can be expanded)
            if (parseInt(aisle) < 1 || parseInt(aisle) > 99) {
                return { valid: false, message: '‚ùå Pasillo inv√°lido', details: 'El n√∫mero de pasillo (1-99) es incorrecto.' };
            }

            return { valid: true, message: '‚úÖ Ubicaci√≥n v√°lida', details: loc };
        }

        // ==================== BOX MANAGEMENT ====================

        function addBox(category, boxData) {
            STATE.pallets[category].boxes.push(boxData);
            saveToStorage();
            updateUI();
        }

        // ==================== UI UPDATES ====================

        function updateUI() { /* REEMPLAZADO (PASO 4.3) */
            TabManager.updateUI();
            updateSidebar();
            SyncManager.updateUI(PENDING_SYNC.length === 0 && PENDING_SYNC_QUICK.length === 0);
            updateResumen();
        }

        function updateSidebar() {
            document.getElementById('sidebar-ok-count').textContent = STATE.pallets.ok.boxes.length;
            document.getElementById('sidebar-blocked-count').textContent = STATE.pallets.blocked.boxes.length;
            document.getElementById('sidebar-nowms-count').textContent = STATE.pallets.nowms.boxes.length;

            document.getElementById('sidebar-ok-pallet').textContent = STATE.pallets.ok.id;
            document.getElementById('sidebar-blocked-pallet').textContent = STATE.pallets.blocked.id;
            document.getElementById('sidebar-nowms-pallet').textContent = STATE.pallets.nowms.id;
        }

        function updateResumen() {
            const total = STATE.history.reduce((sum, p) => sum + p.boxes.length, 0);
            const ok = STATE.history.filter(p => p.category === 'OK').reduce((sum, p) => sum + p.boxes.length, 0);
            const blocked = STATE.history.filter(p => p.category === 'BLOCKED').reduce((sum, p) => sum + p.boxes.length, 0);
            const nowms = STATE.history.filter(p => p.category === 'NW').reduce((sum, p) => sum + p.boxes.length, 0);

            document.getElementById('resumen-total').textContent = total;
            document.getElementById('resumen-ok').textContent = ok;
            document.getElementById('resumen-blocked').textContent = blocked;
            document.getElementById('resumen-nowms').textContent = nowms;
            document.getElementById('resumen-quick').textContent = STATE.quickHistory.length;

            /* MODIFICADO (PASO 4.24) */
            document.getElementById('resumen-pending').textContent = PENDING_SYNC.length + PENDING_SYNC_QUICK.length;

            const listEl = document.getElementById('history-list');
            if (STATE.history.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÇ</div>
                        <div>Sin historial</div>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = STATE.history.map(pallet => `
                <div class="history-item">
                    <div class="history-date">${pallet.date} ${pallet.time}</div>
                    <div class="history-pallet">${pallet.palletId} (${pallet.boxes.length} cj.)</div>
                    <div class="history-status ${pallet.category.toLowerCase()}">
                        ${pallet.category === 'OK' ? '‚úÖ OK' : pallet.category === 'BLOCKED' ? '‚ö†Ô∏è BLOQ' : '‚ùå WMS'}
                    </div>
                    <div class="history-user">${pallet.user}</div>
                </div>
            `).join('');
        }

        function updateBdInfo() {
            const codes = STATE.inventory.size;
            const lastUpdate = STATE.inventoryLastUpdate ? new Date(STATE.inventoryLastUpdate).toLocaleTimeString() : 'N/A';
            document.getElementById('bd-info').innerHTML = `BD: ${codes} c√≥digos cargados.<br>Actualizado: ${lastUpdate}`;
        }

        function updateUserFooter() {
            const avatar = document.getElementById('user-avatar');
            const nameEl = document.getElementById('user-name');
            if (avatar) avatar.textContent = (CURRENT_USER || 'U')[0];
            if (nameEl) nameEl.textContent = CURRENT_USER || 'Usuario';
        }

        function showResumen() {
            document.getElementById('tab-content-area').classList.add('hidden');
            document.getElementById('resumen-screen').classList.remove('hidden');
            updateResumen();
        }

        function showApp() {
            document.getElementById('tab-content-area').classList.remove('hidden');
            document.getElementById('resumen-screen').classList.add('hidden');
        }

        function newSession() {
            if (!confirm('‚ö†Ô∏è Esto limpiar√° las cajas en los pallets de TODAS las pesta√±as, pero mantendr√° el inventario y el historial. ¬øContinuar?')) {
                return;
            }

            // Clear global state/pallets
            STATE.pallets.ok = { id: generatePalletId('OK'), boxes: [], location: '' };
            STATE.pallets.blocked = { id: generatePalletId('BLK'), boxes: [], location: '' };
            STATE.pallets.nowms = { id: generatePalletId('NW'), boxes: [], location: '' };
            STATE.pendingCode1 = null;
            saveToStorage();

            TabManager.newSession(); /* AGREGADO (PASO 4.5) */

            updateUI();
            showNotification('‚úÖ Nueva sesi√≥n iniciada', 'success');
        }

        function openQuickCapture() { /* AGREGADO (PASO 4.14) */
            const tab = TabManager.tabs.find(t => t.type === 'quick');
            if (tab) {
                TabManager.setActiveTab(tab.id);
                showNotification('‚ìò Pesta√±a de Captura R√°pida ya est√° abierta', 'info');
            } else {
                const newTabId = TabManager.createTab('quick');
                showNotification('‚ö° Captura R√°pida iniciada', 'success');
            }
        }

        function exportData() {
            const data = JSON.stringify({ state: STATE, pending: PENDING_SYNC, pendingQuick: PENDING_SYNC_QUICK }, (key, value) => {
                // Custom replacer for Map to Array conversion
                if (value instanceof Map) {
                    return Array.from(value.entries());
                }
                return value;
            }, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventario_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('‚úÖ Datos exportados como JSON', 'success');
        }

        async function saveToStorage() { /* REEMPLAZADO (PASO 4.25) */
            try {
                const data = {
                    inventory: Array.from(STATE.inventory.entries()),
                    inventoryLastUpdate: STATE.inventoryLastUpdate,
                    pallets: STATE.pallets,
                    history: STATE.history,
                    quickHistory: STATE.quickHistory,
                };
                localStorage.setItem('pd_system_state', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving to storage:', e);
            }
        }

        async function loadFromStorage() { /* REEMPLAZADO (PASO 4.26) */
            try {
                const saved = localStorage.getItem('pd_system_state');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.inventory) STATE.inventory = new Map(data.inventory);
                    STATE.inventoryLastUpdate = data.inventoryLastUpdate;
                    if (data.pallets) STATE.pallets = data.pallets;
                    STATE.history = data.history || [];
                    STATE.quickHistory = data.quickHistory || [];
                }
                updateBdInfo();
            } catch (e) {
                console.error('Error loading from storage:', e);
            }
        }


        // ==================== CONNECTION / INIT ====================

        function setupConnectionMonitor() {
            window.addEventListener('online', () => {
                IS_ONLINE = true;
                updateConnectionBanner('online');
                setTimeout(() => { /* MODIFICADO (PASO 4.22) */
                    SyncManager.sync();
                    SyncManager.syncQuick();
                }, 1000);
            });

            window.addEventListener('offline', () => {
                IS_ONLINE = false;
                updateConnectionBanner('offline');
            });
        }

        function updateConnectionBanner(status) {
            const banner = document.getElementById('connection-banner');
            banner.className = `connection-banner ${status}`;
            banner.textContent = status === 'online' ? '‚úÖ Conexi√≥n restaurada' : status === 'offline' ? '‚ö†Ô∏è Sin conexi√≥n a internet' : 'üîÑ Sincronizando...';
            if (status === 'online') {
                setTimeout(() => banner.style.display = 'none', 3000);
            }
        }

        function updateConnectionIndicator(syncing = false) {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');
            if (!dot || !text) return;

            if (syncing) {
                dot.className = 'connection-dot syncing';
                text.textContent = 'Sincronizando...';
            } else if (IS_ONLINE) {
                dot.className = 'connection-dot online';
                text.textContent = 'En l√≠nea';
            } else {
                dot.className = 'connection-dot offline';
                text.textContent = 'Sin conexi√≥n';
            }
        }

        function init() {
            gapi.load('client:auth2', initClient);
            loadFromStorage().then(() => {
                TabManager.init(); /* AGREGADO (PASO 4.4) */
                updateUI(); // Initial UI update after loading state
            });
            setupConnectionMonitor();
        }

        // ==================== UTILITY FUNCTIONS ====================

        // ==================== LOADING INDICATOR (PASO 1.3) ====================
        function showLoading(text = 'Cargando Inventario...', subtext = 'Por favor espera') {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.querySelector('.loading-text').textContent = text;
                overlay.querySelector('.loading-subtext').textContent = subtext;
                overlay.classList.add('show');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.remove('show');
        }


        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const icons = { 'success': '‚úÖ', 'error': '‚ùå', 'warning': '‚ö†Ô∏è', 'info': '‚ìò' };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span style="margin-right: 8px;">${icons[type]}</span>${message}`;

            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function playSound(type) {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API not supported", e);
                    return;
                }
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);

                if (type === 'success') {
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.15);
                } else if (type === 'error') {
                    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.35);
                } else if (type === 'warning') {
                    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.1);
                }
            } catch (e) {
                console.error("Error playing sound:", e);
            }
        }

        // Initialize the app on page load
        init();
    </script>
</body>
</html>
