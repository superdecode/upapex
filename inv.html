<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inventario</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --blocked: #f97316;
            --bg: #f7f7f7;
            --text: #333;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* Connection Banner */
        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s;
        }
        .connection-banner.offline {
            background: var(--error);
            color: white;
            display: block;
        }
        .connection-banner.online {
            background: var(--success);
            color: white;
            display: block;
        }
        .connection-banner.syncing {
            background: var(--warning);
            color: white;
            display: block;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        /* MAIN LAYOUT */
        .main-container {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #555;
        }

        .sidebar-header h2 {
            color: var(--primary);
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.8em;
            color: #aaa;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }

        .sidebar-section-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .sidebar-btn:hover {
            transform: translateX(3px);
        }

        .sidebar-btn-primary {
            background: var(--primary);
            color: white;
        }

        .sidebar-btn-secondary {
            background: #555;
            color: white;
        }

        /* Sync Status */
        .sync-status {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            cursor: pointer;
        }
        .sync-ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .sync-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }
        .sync-warning {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* Pallets por estatus */
        .pallet-status-list {
            flex: 1;
            overflow-y: auto;
        }

        .pallet-status-item {
            background: #444;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .pallet-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .pallet-status-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .pallet-status-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .pallet-code {
            font-family: monospace;
            font-size: 0.7em;
            color: #aaa;
            word-break: break-all;
        }

        .pallet-send-btn {
            margin-top: 6px;
            padding: 5px 10px;
            font-size: 0.7em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }

        .pallet-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pallet-send-btn.ok { background: var(--success); color: white; }
        .pallet-send-btn.blocked { background: var(--blocked); color: white; }
        .pallet-send-btn.nowms { background: var(--error); color: white; }

        /* User Footer */
        .user-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            color: white;
            flex-shrink: 0;
            cursor: pointer;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .connection-indicator {
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }
        .connection-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-footer-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .user-footer-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.75em;
        }

        .bd-info {
            font-size: 0.7em;
            color: #aaa;
            text-align: center;
            line-height: 1.4;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.4em;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        /* Scan Section */
        .scan-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scan-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .scan-input-group {
            flex: 1;
        }

        .scan-input-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .scan-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.3em;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
            transition: all 0.2s;
        }

        .scan-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .scan-input.error {
            border-color: var(--error);
            background: #ffebee;
        }

        .scan-input.success {
            border-color: var(--success);
            background: #e8f5e9;
        }

        /* Result Box */
        .result-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-box.show { display: block; }
        .result-box.success { background: #e8f5e9; border: 2px solid var(--success); }
        .result-box.warning { background: #fff3e0; border: 2px solid var(--warning); }
        .result-box.blocked { background: #fff3e0; border: 2px solid var(--blocked); }
        .result-box.error { background: #ffebee; border: 2px solid var(--error); }

        .result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .result-icon { font-size: 1.5rem; }
        .result-title { font-weight: 700; font-size: 1.1em; }
        .result-code { font-family: monospace; font-weight: 600; }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            font-size: 0.85em;
        }

        .result-detail-label { color: #666; font-size: 0.8em; }
        .result-detail-value { font-weight: 600; }

        /* Code2 Input */
        .code2-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px dashed var(--error);
            display: none;
        }

        .code2-container.show { display: block; }

        .code2-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn-insertado {
            padding: 12px 20px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-insertado:hover {
            background: #d32f2f;
        }

        /* Columns Container */
        .columns-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            flex: 1;
            min-height: 0;
        }

        .column {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .column-title {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .column-count {
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
        }

        .column.ok .column-title { color: var(--success); }
        .column.ok .column-count { background: rgba(76, 175, 80, 0.15); color: var(--success); }

        .column.blocked .column-title { color: var(--blocked); }
        .column.blocked .column-count { background: rgba(249, 115, 22, 0.15); color: var(--blocked); }

        .column.nowms .column-title { color: var(--error); }
        .column.nowms .column-count { background: rgba(244, 67, 54, 0.15); color: var(--error); }

        .column-pallet-info {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.8em;
        }

        .column-pallet-code {
            font-family: monospace;
            font-weight: 600;
            color: var(--primary);
        }

        .column-location-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
            margin-top: 6px;
        }

        .column-send-btn {
            margin-top: 8px;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 0.85em;
        }

        .column-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .column.ok .column-send-btn { background: var(--success); color: white; }
        .column.blocked .column-send-btn { background: var(--blocked); color: white; }
        .column.nowms .column-send-btn { background: var(--error); color: white; }

        .column-list {
            flex: 1;
            overflow-y: auto;
            counter-reset: item-counter;
        }

        .box-item {
            padding: 8px 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid;
            counter-increment: item-counter;
        }

        .box-item::before {
            content: counter(item-counter) ".";
            font-weight: 700;
            min-width: 25px;
            margin-right: 8px;
        }

        .column.ok .box-item { border-color: var(--success); }
        .column.ok .box-item::before { color: var(--success); }

        .column.blocked .box-item { border-color: var(--blocked); }
        .column.blocked .box-item::before { color: var(--blocked); }

        .column.nowms .box-item { border-color: var(--error); }
        .column.nowms .box-item::before { color: var(--error); }

        .box-info { flex: 1; }
        .box-code { font-weight: 600; font-family: monospace; font-size: 0.9em; }
        .box-meta { font-size: 0.75em; color: #666; }

        .box-delete {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1.1em;
            padding: 4px;
            opacity: 0.6;
        }

        .box-delete:hover { opacity: 1; }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #999;
        }

        .empty-icon { font-size: 2.5em; margin-bottom: 8px; opacity: 0.5; }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-google { background: #4285F4; color: white; }

        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        .btn-full { width: 100%; }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .notification {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }

        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Popups */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-overlay.show { display: flex; }

        .popup-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .popup-header {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .popup-close:hover { color: #333; }

        .popup-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        /* Resumen Module */
        .resumen-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .resumen-stat {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f5f5f5;
        }

        .resumen-stat-number {
            font-size: 2em;
            font-weight: 700;
        }

        .resumen-stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .resumen-stat.ok { border: 2px solid var(--success); }
        .resumen-stat.ok .resumen-stat-number { color: var(--success); }

        .resumen-stat.blocked { border: 2px solid var(--blocked); }
        .resumen-stat.blocked .resumen-stat-number { color: var(--blocked); }

        .resumen-stat.nowms { border: 2px solid var(--error); }
        .resumen-stat.nowms .resumen-stat-number { color: var(--error); }

        .resumen-stat.pending { border: 2px solid var(--warning); }
        .resumen-stat.pending .resumen-stat-number { color: var(--warning); }

        .resumen-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .resumen-table th, .resumen-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .resumen-table th {
            background: #f5f5f5;
            font-weight: 700;
            position: sticky;
            top: 0;
        }

        .resumen-table-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .resumen-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .hidden { display: none !important; }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            flex-direction: column;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            text-align: center;
            max-width: 300px;
        }

        .loading-subtext {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            margin-top: 8px;
            text-align: center;
        }

        /* Cabecera Principal de Escaneo */
        .scan-header-bar {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
            flex-wrap: wrap;
        }

        .origin-location-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .origin-location-group label {
            color: white;
            font-weight: 600;
            font-size: 0.8em;
            white-space: nowrap;
        }

        .origin-location-input {
            width: 140px;
            padding: 8px 10px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.2s;
        }

        .origin-location-input:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.4);
        }

        .origin-location-input::placeholder {
            color: #a0aec0;
            font-weight: 400;
            font-size: 0.85em;
        }

        /* Contador Global de Cajas */
        .global-counter {
            background: rgba(0, 0, 0, 0.25);
            padding: 6px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .global-counter-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.8em;
            font-weight: 500;
        }

        .global-counter-value {
            background: white;
            color: #f97316;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1em;
            min-width: 32px;
            text-align: center;
        }

        /* Box Item mejorado con acciones hover */
        .box-item {
            padding: 6px 8px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            border-left: 3px solid;
            counter-increment: item-counter;
            position: relative;
            transition: all 0.15s;
        }

        .box-item:hover {
            background: #f0f0f0;
        }

        .box-item::before {
            content: counter(item-counter) ".";
            font-weight: 700;
            min-width: 20px;
            margin-right: 6px;
            font-size: 0.8em;
        }

        .box-info { flex: 1; min-width: 0; }
        .box-code { font-weight: 600; font-family: monospace; font-size: 0.8em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .box-meta { font-size: 0.7em; color: #666; }

        .box-actions {
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .box-item:hover .box-actions {
            opacity: 1;
        }

        .box-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85em;
            padding: 3px 5px;
            border-radius: 4px;
            opacity: 0.6;
            transition: all 0.15s;
        }

        .box-action-btn:hover {
            opacity: 1;
            background: rgba(0,0,0,0.08);
        }

        .box-action-btn.copy { color: var(--primary); border: 1px solid var(--primary); background: rgba(249, 115, 22, 0.08); }
        .box-action-btn.move { color: var(--warning); border: 1px solid var(--warning); background: rgba(255, 193, 7, 0.08); }
        .box-action-btn.check { color: var(--success); border: 1px solid var(--success); background: rgba(76, 175, 80, 0.08); }
        .box-action-btn.delete { color: var(--error); border: 1px solid var(--error); background: rgba(244, 67, 54, 0.08); }
        .box-action-btn:hover { transform: scale(1.1); filter: brightness(1.1); }

        .box-item.verified {
            background: rgba(76, 175, 80, 0.12);
        }

        .box-item.verified .box-check-icon {
            color: var(--success);
        }

        /* Scan Section Compacta */
        .scan-section {
            background: white;
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .scan-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 1.1em;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
            transition: all 0.2s;
        }

        /* Result Box Compacto Horizontal */
        .result-box {
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            display: none;
            animation: fadeIn 0.2s;
        }

        .result-box.show { display: block; }

        .result-compact {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .result-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 0.95em;
        }

        .result-status .icon { font-size: 1.1em; }

        .result-info {
            display: flex;
            gap: 15px;
            flex: 1;
            flex-wrap: wrap;
            font-size: 0.8em;
        }

        .result-info-item {
            display: flex;
            gap: 4px;
        }

        .result-info-label { color: #666; }
        .result-info-value { font-weight: 600; font-family: monospace; }

        /* Modal de Detalle de Pallet */
        .pallet-detail-modal {
            max-width: 1200px;
            width: 95vw;
        }

        .pallet-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .pallet-detail-counters {
            display: flex;
            gap: 10px;
        }

        .counter-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .counter-badge.ok { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        .counter-badge.pending { background: rgba(244, 67, 54, 0.15); color: var(--error); }

        .pallet-detail-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .pallet-detail-filters input,
        .pallet-detail-filters select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .pallet-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .pallet-detail-table th {
            background: #f5f5f5;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
        }

        .pallet-detail-table th:hover {
            background: #eee;
        }

        .pallet-detail-table th .sort-icon {
            margin-left: 4px;
            opacity: 0.5;
        }

        .pallet-detail-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
        }

        .pallet-detail-table tr:hover {
            background: #f9f9f9;
        }

        .pallet-detail-table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Popup Duplicado */
        .duplicate-popup {
            max-width: 420px;
        }

        .duplicate-info {
            background: #fff3e0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid var(--warning);
        }

        .duplicate-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .duplicate-info-label { color: #666; }
        .duplicate-info-value { font-weight: 600; }

        /* Pre-validaci√≥n Env√≠o */
        .send-validation-popup {
            max-width: 380px;
        }

        .validation-input-group {
            margin-bottom: 15px;
        }

        .validation-input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .validation-input-group input {
            width: 100%;
            padding: 12px;
            font-size: 1.5em;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-weight: 700;
        }

        .validation-mismatch {
            background: #ffebee;
            border: 2px solid var(--error);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            color: var(--error);
            font-weight: 600;
            margin-bottom: 15px;
        }

        .validation-match {
            background: #e8f5e9;
            border: 2px solid var(--success);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            color: var(--success);
            font-weight: 600;
            margin-bottom: 15px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 180px; }
            .columns-container { grid-template-columns: 1fr; }
            .resumen-stats { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; max-height: 200px; }
        }
    </style>
</head>
<body>
    <div class="connection-banner" id="connection-banner"></div>
    <div class="notification-container" id="notifications"></div>

    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">üì¶ Cargando Inventario...</div>
        <div class="loading-subtext">Descargando base de datos desde Google Sheets</div>
    </div>

    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">üì¶</div>
            <h1 class="login-title">Sistema Inventario</h1>
            <p class="login-subtitle">Control y gesti√≥n de mercanc√≠a</p>
            <button class="btn btn-google btn-full" onclick="handleLogin()" style="padding: 15px; font-size: 1.1em;">
                üîê Iniciar sesi√≥n con Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <div class="main-container">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>üì¶ Inventario</h2>
                    <p>Sistema de gesti√≥n</p>
                </div>

                <!-- Sync Status -->
                <div id="sync-status" class="sync-status sync-ok" onclick="SyncManager.showPanel()">
                    ‚úÖ Sincronizado
                </div>

                <!-- Menu -->
                <div class="sidebar-section">
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showResumen()">
                        üìä Resumen
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="newSession()">
                        ‚ûï Nueva Sesi√≥n
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="exportData()">
                        üì• Exportar
                    </button>
                </div>

                <!-- Pallets por estatus -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Tarimas Activas</div>
                    <div class="pallet-status-list" id="pallet-status-list">
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--success);">‚úÖ OK</span>
                                <span class="pallet-status-count" id="sidebar-ok-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-ok-pallet">-</div>
                        </div>
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--blocked);">‚ö†Ô∏è Bloqueado</span>
                                <span class="pallet-status-count" id="sidebar-blocked-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-blocked-pallet">-</div>
                        </div>
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--error);">‚ùå No WMS</span>
                                <span class="pallet-status-count" id="sidebar-nowms-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-nowms-pallet">-</div>
                        </div>
                    </div>
                </div>

                <!-- User Footer -->
                <div class="user-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar" onclick="changeUserAlias()">?</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name-display" onclick="changeUserAlias()">No conectado</div>
                            <div class="connection-indicator">
                                <div class="connection-dot" id="connection-dot"></div>
                                <span id="connection-text">Offline</span>
                            </div>
                        </div>
                    </div>
                    <div class="user-footer-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshInventory()">üîÑ BD</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleConnection()" id="sidebar-auth-btn">üîó</button>
                        <button class="btn btn-danger btn-small" onclick="handleLogout()">üö™</button>
                    </div>
                    <div class="bd-info">
                        <div><span id="bd-count">0</span> c√≥digos cargados</div>
                        <div id="bd-update-time">Sin actualizar</div>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- Cabecera Principal con Ubicaci√≥n y Contador -->
                <div class="scan-header-bar">
                    <div class="origin-location-group">
                        <label>üìç Origen:</label>
                        <input type="text" class="origin-location-input" id="origin-location"
                               placeholder="A21-06-05-01" autocomplete="off"
                               title="Ubicaci√≥n f√≠sica de origen">
                    </div>
                    <div class="global-counter">
                        <span class="global-counter-label">Total Cajas:</span>
                        <span class="global-counter-value" id="global-box-count">0</span>
                    </div>
                </div>

                <!-- Scan Section Compacta -->
                <div class="scan-section">
                    <input type="text" class="scan-input" id="scan-input" placeholder="üîç Escanea o ingresa c√≥digo..." autocomplete="off">

                    <!-- Result Box Compacto -->
                    <div class="result-box" id="result-box">
                        <div class="result-compact">
                            <div class="result-status">
                                <span class="icon" id="result-icon">üì¶</span>
                                <span id="result-title">Estado</span>
                            </div>
                            <div class="result-info" id="result-details"></div>
                        </div>
                    </div>

                    <!-- Code2 Container Compacto -->
                    <div class="code2-container" id="code2-container">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="color: var(--error); font-weight: 600; font-size: 0.85em;">‚ö†Ô∏è No encontrado:</span>
                            <input type="text" class="scan-input" id="code2-input" placeholder="C√≥digo 2..." autocomplete="off" style="flex: 1; font-size: 1em; padding: 8px;">
                            <button class="btn-insertado" onclick="forceInsert()" style="padding: 8px 14px; font-size: 0.85em;">
                                ‚ö° INSERTADO
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Columns -->
                <div class="columns-container">
                    <!-- OK Column -->
                    <div class="column ok">
                        <div class="column-header">
                            <span class="column-title">‚úÖ OK</span>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span class="counter-badge ok" id="ok-verified-badge" style="display: none;">‚úì <span id="ok-verified-count">0</span></span>
                                <span class="counter-badge pending" id="ok-pending-badge" style="display: none;">‚óã <span id="ok-pending-count">0</span></span>
                                <span class="column-count" id="ok-count">0</span>
                                <button class="box-action-btn" onclick="showPalletDetailModal('ok')" title="Ver detalle" style="opacity: 0.7;">‚õ∂</button>
                            </div>
                        </div>
                        <div class="column-pallet-info">
                            <div>Pallet: <span class="column-pallet-code" id="ok-pallet">-</span></div>
                            <input type="text" class="column-location-input" id="location-ok" placeholder="üìç Ubicaci√≥n destino...">
                            <button class="column-send-btn" onclick="sendPallet('ok')" id="send-ok-btn" disabled>
                                üì§ Enviar Tarima OK
                            </button>
                        </div>
                        <div class="column-list" id="ok-list">
                            <div class="empty-state">
                                <div class="empty-icon">üì≠</div>
                                <div>Sin cajas</div>
                            </div>
                        </div>
                    </div>

                    <!-- Blocked Column -->
                    <div class="column blocked">
                        <div class="column-header">
                            <span class="column-title">‚ö†Ô∏è Bloqueado</span>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span class="column-count" id="blocked-count">0</span>
                                <button class="box-action-btn" onclick="showPalletDetailModal('blocked')" title="Ver detalle" style="opacity: 0.7;">‚õ∂</button>
                            </div>
                        </div>
                        <div class="column-pallet-info">
                            <div>Pallet: <span class="column-pallet-code" id="blocked-pallet">-</span></div>
                            <input type="text" class="column-location-input" id="location-blocked" placeholder="üìç Ubicaci√≥n destino...">
                            <button class="column-send-btn" onclick="sendPallet('blocked')" id="send-blocked-btn" disabled>
                                üì§ Enviar Tarima Bloqueado
                            </button>
                        </div>
                        <div class="column-list" id="blocked-list">
                            <div class="empty-state">
                                <div class="empty-icon">üì≠</div>
                                <div>Sin cajas</div>
                            </div>
                        </div>
                    </div>

                    <!-- No WMS Column -->
                    <div class="column nowms">
                        <div class="column-header">
                            <span class="column-title">‚ùå No WMS</span>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span class="column-count" id="nowms-count">0</span>
                                <button class="box-action-btn" onclick="showPalletDetailModal('nowms')" title="Ver detalle" style="opacity: 0.7;">‚õ∂</button>
                            </div>
                        </div>
                        <div class="column-pallet-info">
                            <div>Pallet: <span class="column-pallet-code" id="nowms-pallet">-</span></div>
                            <input type="text" class="column-location-input" id="location-nowms" placeholder="üìç Ubicaci√≥n destino...">
                            <button class="column-send-btn" onclick="sendPallet('nowms')" id="send-nowms-btn" disabled>
                                üì§ Enviar Tarima No WMS
                            </button>
                        </div>
                        <div class="column-list" id="nowms-list">
                            <div class="empty-state">
                                <div class="empty-icon">üì≠</div>
                                <div>Sin cajas</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESUMEN POPUP -->
    <div class="popup-overlay" id="resumen-popup">
        <div class="popup-content">
            <div class="popup-header">
                <span>üìä Resumen de Sesi√≥n</span>
                <button class="popup-close" onclick="closeResumen()">√ó</button>
            </div>

            <div class="resumen-stats">
                <div class="resumen-stat ok">
                    <div class="resumen-stat-number" id="resumen-ok">0</div>
                    <div class="resumen-stat-label">OK</div>
                </div>
                <div class="resumen-stat blocked">
                    <div class="resumen-stat-number" id="resumen-blocked">0</div>
                    <div class="resumen-stat-label">Bloqueado</div>
                </div>
                <div class="resumen-stat nowms">
                    <div class="resumen-stat-number" id="resumen-nowms">0</div>
                    <div class="resumen-stat-label">No WMS</div>
                </div>
                <div class="resumen-stat pending">
                    <div class="resumen-stat-number" id="resumen-pending">0</div>
                    <div class="resumen-stat-label">Pendientes Sync</div>
                </div>
            </div>

            <div class="resumen-actions">
                <button class="btn btn-primary btn-small" onclick="refreshInventory(); closeResumen();">üîÑ Recargar BD</button>
                <button class="btn btn-success btn-small" onclick="SyncManager.sync(); updateResumen();">üîÑ Sincronizar</button>
                <button class="btn btn-secondary btn-small" onclick="exportData();">üì• Exportar</button>
            </div>

            <h3 style="margin-bottom: 10px; font-size: 1em;">üìã Historial Reciente</h3>
            <div class="resumen-table-container">
                <table class="resumen-table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>C√≥digo</th>
                            <th>C√≥digo 2</th>
                            <th>Estatus</th>
                            <th>Destino</th>
                            <th>Origen</th>
                            <th>Pallet</th>
                        </tr>
                    </thead>
                    <tbody id="resumen-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            CLIENT_ID: '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile',
            SPREADSHEET_WRITE: '1FBhZloEeT-xTe1yVKzdWxGJa6gKkZQOObmkBMuxqcv8',
            SHEET_NAME: 'BD',  // Nombre de la hoja donde se escriben los datos
            INVENTORY_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-HG8HPf-94Ki5Leo5iEF5pyqsiD9CVk-mcl-F8BAw34kT0s3nzNn532YTYDCtkG76NbauiVx0Ffmd/pub?output=csv'
        };

        // ==================== STATE ====================
        let STATE = {
            inventory: new Map(),
            inventoryLastUpdate: null,
            pallets: {
                ok: { id: generatePalletId('OK'), boxes: [], location: '' },
                blocked: { id: generatePalletId('BLK'), boxes: [], location: '' },
                nowms: { id: generatePalletId('NW'), boxes: [], location: '' }
            },
            pendingCode1: null,
            history: []
        };

        let CURRENT_USER = '';
        let USER_EMAIL = '';
        let USER_GOOGLE_NAME = '';
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];
        let TOKEN_CLIENT = null;
        let audioCtx = null;

        // ==================== SYNC MANAGER ====================
        const SyncManager = {
            inProgress: false,
            retryCount: 0,
            intervalId: null,
            AUTO_SYNC_INTERVAL: 30000,

            init() {
                this.load();
                this.startAutoSync();
                this.setupExitProtection();
                this.updateUI(PENDING_SYNC.length === 0);
            },

            setupExitProtection() {
                window.addEventListener('beforeunload', (e) => {
                    const hasUnsavedData = PENDING_SYNC.length > 0 ||
                        STATE.pallets.ok.boxes.length > 0 ||
                        STATE.pallets.blocked.boxes.length > 0 ||
                        STATE.pallets.nowms.boxes.length > 0;

                    if (hasUnsavedData) {
                        e.preventDefault();
                        e.returnValue = '¬°Tienes datos sin sincronizar! ¬øSeguro que quieres salir?';
                        return e.returnValue;
                    }
                });
            },

            startAutoSync() {
                if (this.intervalId) clearInterval(this.intervalId);
                this.intervalId = setInterval(() => {
                    if (IS_ONLINE && gapi?.client?.getToken() && PENDING_SYNC.length > 0) {
                        this.sync(false);
                    }
                }, this.AUTO_SYNC_INTERVAL);
            },

            async sync(showMessages = true) {
                if (this.inProgress) {
                    if (showMessages) showNotification('‚è≥ Sincronizaci√≥n en progreso...', 'info');
                    return { success: false };
                }

                if (!IS_ONLINE) {
                    if (showMessages) showNotification('‚ö†Ô∏è Sin conexi√≥n a internet', 'warning');
                    return { success: false };
                }

                if (!gapi?.client?.getToken()) {
                    if (showMessages) showNotification('‚ö†Ô∏è No conectado a Google', 'warning');
                    return { success: false };
                }

                if (PENDING_SYNC.length === 0) {
                    this.updateUI(true);
                    if (showMessages) showNotification('‚úÖ Todo sincronizado', 'success');
                    return { success: true, synced: 0 };
                }

                return await this._doSync(showMessages);
            },

            async _doSync(showMessages) {
                this.inProgress = true;
                updateConnectionIndicator(true);

                if (showMessages) showNotification('üîÑ Sincronizando...', 'info');

                try {
                    // Columnas: A-J (incluye Ubicaci√≥n F√≠sica de Origen en columna J)
                    const values = PENDING_SYNC.map(r => [
                        r.date, r.time, r.user, r.scan1, r.scan2,
                        r.location, r.status, r.note, r.pallet, r.originLocation || ''
                    ]);

                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                        range: `${CONFIG.SHEET_NAME}!A:J`,
                        valueInputOption: 'USER_ENTERED',
                        insertDataOption: 'INSERT_ROWS',
                        resource: { values }
                    });

                    const synced = PENDING_SYNC.length;
                    PENDING_SYNC = [];
                    this.save();
                    this.updateUI(true);

                    if (showMessages) showNotification(`‚úÖ ${synced} registros sincronizados`, 'success');
                    return { success: true, synced };
                } catch (e) {
                    console.error('Sync error:', e);
                    this.updateUI(false);
                    if (showMessages) showNotification(`‚ùå Error: ${e.result?.error?.message || e.message || 'Error desconocido'}`, 'error');
                    return { success: false };
                } finally {
                    this.inProgress = false;
                    updateConnectionIndicator();
                }
            },

            async save() {
                try {
                    localStorage.setItem('pd_pending_sync', JSON.stringify(PENDING_SYNC));
                } catch (e) {}
            },

            async load() {
                try {
                    const saved = localStorage.getItem('pd_pending_sync');
                    if (saved) PENDING_SYNC = JSON.parse(saved);
                } catch (e) {}
            },

            updateUI(synced) {
                const el = document.getElementById('sync-status');
                if (!el) return;

                if (!IS_ONLINE) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `‚ö†Ô∏è Sin conexi√≥n${PENDING_SYNC.length > 0 ? ` (${PENDING_SYNC.length})` : ''}`;
                } else if (PENDING_SYNC.length > 0) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `‚è≥ ${PENDING_SYNC.length} pendientes`;
                } else if (synced) {
                    el.className = 'sync-status sync-ok';
                    el.textContent = '‚úÖ Sincronizado';
                } else {
                    el.className = 'sync-status sync-error';
                    el.textContent = '‚ùå Error sync';
                }
            },

            showPanel() {
                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay show';
                overlay.innerHTML = `
                    <div class="popup-content" style="max-width: 450px;">
                        <div class="popup-header">
                            <span>üìä Estado de Sincronizaci√≥n</span>
                            <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px; text-align: center;">
                                <div style="font-size: 0.85em; color: #666;">Pendientes de sincronizar</div>
                                <div style="font-size: 2em; font-weight: 700; color: ${PENDING_SYNC.length > 0 ? 'var(--warning)' : 'var(--success)'};">
                                    ${PENDING_SYNC.length}
                                </div>
                            </div>
                            <div style="font-size: 0.9em; padding: 10px; background: #f9f9f9; border-radius: 6px;">
                                ${IS_ONLINE ? 'üü¢ Conectado a internet' : 'üî¥ Sin conexi√≥n'}<br>
                                ${gapi?.client?.getToken() ? 'üü¢ Google conectado' : 'üî¥ Google desconectado'}<br>
                                üìÑ Hoja destino: <strong>${CONFIG.SHEET_NAME}</strong>
                            </div>
                        </div>
                        <div class="popup-buttons">
                            ${PENDING_SYNC.length > 0 && IS_ONLINE && gapi?.client?.getToken() ? `
                                <button class="btn btn-success btn-full" onclick="this.closest('.popup-overlay').remove(); SyncManager.sync();">
                                    üîÑ Sincronizar Ahora
                                </button>
                            ` : ''}
                            <button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">
                                Cerrar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) overlay.remove();
                });
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            initAudio();
            loadFromStorage();
            setupEventListeners();
            setupConnectionMonitor();
            gapi.load('client', initGAPI);
        });

        function initAudio() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.addEventListener('click', () => {
                    if (audioCtx?.state === 'suspended') audioCtx.resume();
                }, { once: true });
            } catch (e) {}
        }

        async function initGAPI() {
            try {
                await gapi.client.init({
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
                });
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: handleAuthCallback
                });
            } catch (e) {
                showNotification('Error inicializando API', 'error');
            }
        }

        async function handleAuthCallback(response) {
            if (response?.access_token) {
                gapi.client.setToken(response);
                await getUserProfile();
                await loadInventory();
                SyncManager.init();
                if (PENDING_SYNC.length > 0) SyncManager.sync();
                showApp();
            }
        }

        function handleLogin() {
            TOKEN_CLIENT?.requestAccessToken();
        }

        async function getUserProfile() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` }
                });
                const data = await response.json();
                USER_EMAIL = data.email || '';
                USER_GOOGLE_NAME = data.name || 'Usuario';

                const savedAlias = localStorage.getItem(`pd_alias_${USER_EMAIL}`);
                if (savedAlias) {
                    CURRENT_USER = savedAlias;
                    showNotification(`‚úÖ Bienvenido, ${CURRENT_USER}`, 'success');
                    updateUserFooter();
                } else {
                    showAliasPopup();
                }
            } catch (e) {
                CURRENT_USER = 'Usuario';
                updateUserFooter();
            }
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateUserFooter();
            updateUI();
            document.getElementById('scan-input').focus();
        }

        function handleLogout() {
            const hasData = PENDING_SYNC.length > 0 ||
                STATE.pallets.ok.boxes.length > 0 ||
                STATE.pallets.blocked.boxes.length > 0 ||
                STATE.pallets.nowms.boxes.length > 0;

            if (hasData) {
                if (!confirm('‚ö†Ô∏è Tienes datos sin sincronizar. ¬øSeguro que quieres salir?')) {
                    return;
                }
            }

            if (gapi.client.getToken()) {
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                gapi.client.setToken(null);
            }

            CURRENT_USER = '';
            USER_EMAIL = '';
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        // ==================== ALIAS/NICKNAME SYSTEM ====================
        function showAliasPopup() {
            document.querySelectorAll('.alias-popup').forEach(e => e.remove());

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show alias-popup';
            overlay.innerHTML = `
                <div class="popup-content" style="max-width: 400px;">
                    <div class="popup-header">üë§ ¬øC√≥mo te llamamos?</div>
                    <p style="margin-bottom: 15px; color: #666;">
                        Hola <strong>${USER_GOOGLE_NAME}</strong>, elige c√≥mo aparecer√° tu nombre en los registros:
                    </p>
                    <div class="popup-buttons">
                        <button class="btn btn-primary btn-full" onclick="saveUserAlias('${USER_GOOGLE_NAME}', true)">
                            üë§ Usar mi nombre de Google
                        </button>
                        <div style="text-align: center; color: #999; font-size: 0.85em;">o</div>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="alias-input" placeholder="Escribe un alias..."
                                style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em;"
                                maxlength="20">
                            <button class="btn btn-success" onclick="saveUserAlias(document.getElementById('alias-input').value)">
                                üíæ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            const input = overlay.querySelector('#alias-input');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    saveUserAlias(input.value);
                }
            });
            input.focus();
        }

        function saveUserAlias(alias, isGoogleName = false) {
            const finalAlias = alias?.trim() || USER_GOOGLE_NAME;
            if (!finalAlias) {
                showNotification('‚ö†Ô∏è Ingresa un nombre v√°lido', 'warning');
                return;
            }

            CURRENT_USER = finalAlias;
            localStorage.setItem(`pd_alias_${USER_EMAIL}`, finalAlias);

            document.querySelectorAll('.alias-popup').forEach(e => e.remove());
            showNotification(`‚úÖ ${isGoogleName ? 'Nombre' : 'Alias'} guardado: ${finalAlias}`, 'success');
            updateUserFooter();
        }

        function changeUserAlias() {
            showAliasPopup();
        }

        function updateUserFooter() {
            const avatar = document.getElementById('user-avatar');
            const nameDisplay = document.getElementById('user-name-display');

            if (avatar) {
                avatar.textContent = CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : '?';
                avatar.title = USER_EMAIL || 'No conectado';
            }
            if (nameDisplay) {
                nameDisplay.textContent = CURRENT_USER || 'No conectado';
                nameDisplay.title = `Click para cambiar alias\n${USER_EMAIL}`;
            }

            updateConnectionIndicator();
        }

        // ==================== INVENTORY ====================
        function showLoadingOverlay(show = true) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                if (show) {
                    overlay.classList.add('show');
                } else {
                    overlay.classList.remove('show');
                }
            }
        }

        async function loadInventory() {
            try {
                showLoadingOverlay(true);
                updateConnectionIndicator(true);

                const response = await fetch(CONFIG.INVENTORY_CSV_URL, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const csv = await response.text();
                if (!csv || csv.trim().length === 0) throw new Error('CSV vac√≠o');

                parseInventoryCSV(csv);
                await saveToStorage();
                showNotification(`‚úÖ ${STATE.inventory.size} c√≥digos cargados`, 'success');
                updateBdInfo();
            } catch (e) {
                console.error('Error cargando inventario:', e);
                showNotification(`‚ö†Ô∏è ${e.message}`, 'warning');

                if (STATE.inventory.size > 0) {
                    showNotification(`Usando ${STATE.inventory.size} c√≥digos en cach√©`, 'info');
                }
            } finally {
                showLoadingOverlay(false);
                updateConnectionIndicator();
            }
        }

        function parseInventoryCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim().length > 0);
            STATE.inventory.clear();

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);

                if (cols.length >= 11) {
                    const code = (cols[1] || '').toString().trim().toUpperCase();

                    if (code && code.length > 0) {
                        const availableStock = parseFloat(cols[9]) || 0;
                        const lockedInventory = parseFloat(cols[10]) || 0;

                        STATE.inventory.set(code, {
                            code,
                            boxType: cols[0] || '',
                            warehouse: cols[3] || '',
                            cellNo: cols[6] || '',  // Columna G (√≠ndice 6)
                            area: cols[8] || '',
                            availableStock,
                            lockedInventory,
                            sku: cols[12] || '',
                            productName: cols[13] || '',
                            isAvailable: availableStock > 0,
                            isBlocked: lockedInventory > 0
                        });
                    }
                }
            }

            STATE.inventoryLastUpdate = new Date().toLocaleString();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function refreshInventory() {
            loadInventory();
        }

        function updateBdInfo() {
            document.getElementById('bd-count').textContent = STATE.inventory.size.toLocaleString();
            document.getElementById('bd-update-time').textContent = STATE.inventoryLastUpdate || 'Sin actualizar';
        }

        // ==================== SCAN PROCESSING ====================
        function setupEventListeners() {
            const scanInput = document.getElementById('scan-input');
            scanInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && scanInput.value.trim()) {
                    e.preventDefault();
                    processScan(scanInput.value.trim());
                    scanInput.value = '';  // Limpiar autom√°ticamente
                }
            });

            const code2Input = document.getElementById('code2-input');
            code2Input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && code2Input.value.trim()) {
                    e.preventDefault();
                    processCode2(code2Input.value.trim());
                    code2Input.value = '';  // Limpiar autom√°ticamente
                }
            });
        }

        function processScan(rawCode) {
            const code = normalizeCode(rawCode);

            // Check duplicates across all pallets con info detallada
            const duplicateInfo = findDuplicate(code);

            if (duplicateInfo) {
                showDuplicatePopup(code, duplicateInfo, rawCode);
                flashInput('warning');
                playSound('warning');
                return;
            }

            const item = STATE.inventory.get(code);

            if (!item) {
                // Not found - show Code2 input
                STATE.pendingCode1 = { raw: rawCode, code };
                showResultBox('error', code, 'NO ENCONTRADO',
                    'C√≥digo no encontrado en WMS. Ingresa C√≥digo 2 o usa INSERTADO.', null);
                document.getElementById('code2-container').classList.add('show');
                flashInput('error');
                playSound('error');
                setTimeout(() => document.getElementById('code2-input').focus(), 100);
                return;
            }

            // Hide code2 container
            document.getElementById('code2-container').classList.remove('show');
            STATE.pendingCode1 = null;

            // Determine status and add to appropriate pallet
            if (item.isBlocked) {
                addBox('blocked', createBoxData(rawCode, code, '', item));
                showResultBox('blocked', code, 'BLOQUEADO', 'Inventario bloqueado', item);
                playSound('warning');
            } else if (item.isAvailable) {
                addBox('ok', createBoxData(rawCode, code, '', item));
                showResultBox('success', code, 'OK', 'Validado correctamente', item);
                playSound('success');
            } else {
                addBox('blocked', createBoxData(rawCode, code, '', item));
                showResultBox('blocked', code, 'SIN STOCK', 'Sin stock disponible', item);
                playSound('warning');
            }

            flashInput('success');
        }

        // Buscar duplicado con informaci√≥n detallada
        function findDuplicate(code) {
            const categories = ['ok', 'blocked', 'nowms'];
            const categoryNames = { ok: 'OK', blocked: 'Bloqueado', nowms: 'No WMS' };

            for (const cat of categories) {
                const boxes = STATE.pallets[cat].boxes;
                const index = boxes.findIndex(b => b.code === code);
                if (index !== -1) {
                    const box = boxes[index];
                    return {
                        category: cat,
                        categoryName: categoryNames[cat],
                        index,
                        box,
                        timestamp: box.timestamp,
                        user: CURRENT_USER
                    };
                }
            }
            return null;
        }

        // Mostrar popup de duplicado con opci√≥n de ingreso forzado
        function showDuplicatePopup(code, duplicateInfo, rawCode) {
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show';
            overlay.innerHTML = `
                <div class="popup-content duplicate-popup">
                    <div class="popup-header">
                        <span>‚ö†Ô∏è C√≥digo Duplicado</span>
                        <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                    </div>
                    <div class="duplicate-info">
                        <div class="duplicate-info-row">
                            <span class="duplicate-info-label">C√≥digo:</span>
                            <span class="duplicate-info-value"><code>${code}</code></span>
                        </div>
                        <div class="duplicate-info-row">
                            <span class="duplicate-info-label">Ya registrado en:</span>
                            <span class="duplicate-info-value">${duplicateInfo.categoryName}</span>
                        </div>
                        <div class="duplicate-info-row">
                            <span class="duplicate-info-label">Hora de registro:</span>
                            <span class="duplicate-info-value">${duplicateInfo.timestamp}</span>
                        </div>
                        <div class="duplicate-info-row">
                            <span class="duplicate-info-label">Registrado por:</span>
                            <span class="duplicate-info-value">${duplicateInfo.user || 'Usuario'}</span>
                        </div>
                    </div>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                        Este c√≥digo ya fue escaneado anteriormente. ¬øDeseas forzar un nuevo registro?
                    </p>
                    <div class="popup-buttons">
                        <button class="btn btn-warning btn-full" onclick="forceInsertDuplicate('${code}', '${rawCode}'); this.closest('.popup-overlay').remove();">
                            ‚ö° Ingreso Forzado (Duplicado)
                        </button>
                        <button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }

        // Forzar inserci√≥n de duplicado
        function forceInsertDuplicate(code, rawCode) {
            const item = STATE.inventory.get(code);

            if (!item) {
                addBox('nowms', createBoxData(rawCode, code, '', null));
                showNotification('‚ö° Duplicado insertado en No WMS', 'warning');
            } else if (item.isBlocked) {
                addBox('blocked', createBoxData(rawCode, code, '', item));
                showNotification('‚ö° Duplicado insertado en Bloqueado', 'warning');
            } else {
                addBox('ok', createBoxData(rawCode, code, '', item));
                showNotification('‚ö° Duplicado insertado en OK', 'warning');
            }

            playSound('warning');
            document.getElementById('scan-input').focus();
        }

        function processCode2(rawCode2) {
            if (!STATE.pendingCode1) return;

            const code2 = normalizeCode(rawCode2);
            const item = STATE.inventory.get(code2);

            document.getElementById('code2-container').classList.remove('show');

            if (!item) {
                // Both codes failed - add to No WMS with BOTH codes
                addBox('nowms', createBoxData(STATE.pendingCode1.raw, STATE.pendingCode1.code, rawCode2, null));
                showResultBox('error', STATE.pendingCode1.code, 'NO WMS',
                    `Ambos c√≥digos no encontrados. Guardados: ${STATE.pendingCode1.code} y ${code2}`, null);
                playSound('error');
            } else if (item.isBlocked) {
                addBox('blocked', createBoxData(STATE.pendingCode1.raw, code2, rawCode2, item));
                showResultBox('blocked', code2, 'BLOQUEADO (C√≥digo 2)',
                    'Validado con C√≥digo 2 - Bloqueado', item);
                playSound('warning');
            } else {
                addBox('ok', createBoxData(STATE.pendingCode1.raw, code2, rawCode2, item));
                showResultBox('success', code2, 'OK (C√≥digo 2)',
                    'Validado correctamente con C√≥digo 2', item);
                playSound('success');
            }

            STATE.pendingCode1 = null;
            flashInput('success');
            document.getElementById('scan-input').focus();
        }

        function forceInsert() {
            if (!STATE.pendingCode1) {
                showNotification('‚ö†Ô∏è Primero escanea un c√≥digo', 'warning');
                return;
            }

            const code2Value = document.getElementById('code2-input').value.trim();

            // Guardar AMBOS c√≥digos
            addBox('nowms', createBoxData(
                STATE.pendingCode1.raw,
                STATE.pendingCode1.code,
                code2Value,  // Puede estar vac√≠o o tener valor
                null
            ));

            const msg = code2Value
                ? `Insertado con c√≥digos: ${STATE.pendingCode1.code} y ${code2Value}`
                : `Insertado con c√≥digo: ${STATE.pendingCode1.code}`;

            showResultBox('error', STATE.pendingCode1.code, 'INSERTADO (No WMS)', msg, null);

            document.getElementById('code2-container').classList.remove('show');
            document.getElementById('code2-input').value = '';
            STATE.pendingCode1 = null;

            playSound('warning');
            flashInput('warning');
            document.getElementById('scan-input').focus();
            showNotification('‚ö° Registro insertado forzosamente', 'warning');
        }

        function createBoxData(raw, code, scan2, item) {
            const cleanScan2 = scan2 ? normalizeCode(scan2) : '';
            return {
                raw,
                code,
                scan1: raw,
                scan2: cleanScan2,  // C√≥digo limpio del segundo escaneo
                rawScan2: scan2 || '',  // Valor raw para referencia
                location: item?.cellNo || '-',
                sku: item?.sku || '-',
                product: item?.productName || '-',
                timestamp: new Date().toLocaleTimeString()
            };
        }

        function normalizeCode(raw) {
            let code = raw.trim().toUpperCase();

            // Patrones de extracci√≥n especiales (JSON, etc)
            const patterns = [
                /\[id\[.*?\[([^\[]+)\[/i,
                /¬®id¬®.*?¬®([^¬®]+)¬®/i,
                /"id"\s*:\s*"([^"]+)"/i
            ];

            for (const pattern of patterns) {
                const match = code.match(pattern);
                if (match) return match[1];
            }

            // CR√çTICO: Preservar guiones ANTES de convertir - a /
            // Detectar patrones tipo: LETRAS+N√öMEROS+GUION+N√öMEROS (ej: BY9888548520-07)
            const hasValidDash = /^[A-Z]+\d+\-\d+$/i.test(code);

            if (!hasValidDash) {
                // Solo si NO es un patr√≥n v√°lido con guion, entonces convertir - a /
                code = code.replace(/(\d)-(\d)/g, '$1/$2');
            }

            // Limpiar caracteres especiales excepto guiones, diagonales y letras/n√∫meros
            return code.replace(/[^a-zA-Z0-9\-\/]/g, '');
        }

        // ==================== VALIDADOR DE UBICACIONES ====================
        /**
         * Valida el formato de ubicaci√≥n del almac√©n
         * Formato: [LETRA][N√öMERO]-[N√öMERO]-[N√öMERO]-[N√öMERO]
         * Ejemplo: A21-06-05-01, B27-01-04-01
         */
        function validateLocation(location) {
            const loc = location.trim().toUpperCase();

            // Patr√≥n: LETRA + N√öMEROS + GUION + N√öMEROS + GUION + N√öMEROS + GUION + N√öMEROS
            const pattern = /^([A-Z])(\d{1,3})-(\d{1,2})-(\d{1,2})-(\d{1,2})$/;
            const match = loc.match(pattern);

            if (!match) {
                return {
                    valid: false,
                    message: '‚ùå Formato inv√°lido',
                    details: 'La ubicaci√≥n debe seguir el formato: [LETRA][NUM]-[NUM]-[NUM]-[NUM]\nEjemplo: A21-06-05-01',
                    parsed: null
                };
            }

            const [, area, pasillo, rack, nivel, palet] = match;

            return {
                valid: true,
                message: '‚úÖ Ubicaci√≥n v√°lida',
                parsed: {
                    area: area,
                    pasillo: pasillo.padStart(2, '0'),
                    rack: rack.padStart(2, '0'),
                    nivel: nivel.padStart(2, '0'),
                    palet: palet.padStart(2, '0'),
                    formatted: `${area}${pasillo.padStart(2, '0')}-${rack.padStart(2, '0')}-${nivel.padStart(2, '0')}-${palet.padStart(2, '0')}`
                }
            };
        }

        /**
         * Muestra di√°logo de confirmaci√≥n para ubicaci√≥n inv√°lida (doble confirmaci√≥n)
         */
        function confirmInvalidLocation(location) {
            const validation = validateLocation(location);

            if (validation.valid) {
                return { confirmed: true, formatted: validation.parsed.formatted };
            }

            // Primera confirmaci√≥n
            const firstConfirm = confirm(
                `‚ö†Ô∏è UBICACI√ìN CON FORMATO INCORRECTO ‚ö†Ô∏è\n\n` +
                `Ubicaci√≥n ingresada: "${location}"\n\n` +
                `${validation.message}\n` +
                `${validation.details}\n\n` +
                `Formato correcto:\n` +
                `‚Ä¢ √Årea (letra): A, B, C, etc.\n` +
                `‚Ä¢ Pasillo (n√∫meros): 01-99\n` +
                `‚Ä¢ Rack (n√∫meros): 01-99\n` +
                `‚Ä¢ Nivel (n√∫meros): 01-99\n` +
                `‚Ä¢ Palet (n√∫meros): 01-99\n\n` +
                `Ejemplos v√°lidos:\n` +
                `‚Ä¢ A21-06-05-01\n` +
                `‚Ä¢ B27-01-04-01\n` +
                `‚Ä¢ C15-03-02-05\n\n` +
                `¬øEst√°s seguro que deseas usar "${location}"?`
            );

            if (!firstConfirm) {
                return { confirmed: false, formatted: null };
            }

            // Segunda confirmaci√≥n (doble check)
            const secondConfirm = confirm(
                `‚ö†Ô∏è SEGUNDA CONFIRMACI√ìN REQUERIDA ‚ö†Ô∏è\n\n` +
                `Confirma nuevamente que deseas registrar esta ubicaci√≥n:\n\n` +
                `"${location}"\n\n` +
                `Esta ubicaci√≥n NO cumple con el formato est√°ndar del almac√©n.\n\n` +
                `¬øCONFIRMAS el uso de esta ubicaci√≥n?`
            );

            return { confirmed: secondConfirm, formatted: secondConfirm ? location.toUpperCase() : null };
        }

        function showResultBox(type, code, title, message, item) {
            const box = document.getElementById('result-box');
            const icons = { success: '‚úÖ', warning: '‚ö†Ô∏è', blocked: '‚ö†Ô∏è', error: '‚ùå' };

            box.className = `result-box show ${type}`;
            document.getElementById('result-icon').textContent = icons[type] || 'üì¶';
            document.getElementById('result-title').textContent = `${title}: ${code}`;

            const detailsEl = document.getElementById('result-details');
            if (item) {
                detailsEl.innerHTML = `
                    <div class="result-info-item"><span class="result-info-label">Ubic:</span><span class="result-info-value">${item.cellNo || '-'}</span></div>
                    <div class="result-info-item"><span class="result-info-label">SKU:</span><span class="result-info-value">${item.sku || '-'}</span></div>
                    <div class="result-info-item"><span class="result-info-label">Stock:</span><span class="result-info-value">${item.availableStock || 0}</span></div>
                `;
            } else {
                detailsEl.innerHTML = `<div class="result-info-item" style="color: #666;">${message}</div>`;
            }
        }

        function flashInput(type) {
            const input = document.getElementById('scan-input');
            input.classList.remove('success', 'error');
            input.classList.add(type === 'success' ? 'success' : type === 'error' ? 'error' : '');
            setTimeout(() => input.classList.remove('success', 'error'), 500);
        }

        // ==================== BOX MANAGEMENT ====================
        function addBox(category, boxData) {
            STATE.pallets[category].boxes.push(boxData);
            saveToStorage();
            updateUI();
        }

        function deleteBox(category, index) {
            if (confirm('¬øEliminar esta caja?')) {
                STATE.pallets[category].boxes.splice(index, 1);
                saveToStorage();
                updateUI();
                showNotification('Caja eliminada', 'info');
            }
        }

        // ==================== SEND INDIVIDUAL PALLET ====================
        async function sendPallet(category) {
            const pallet = STATE.pallets[category];
            const locationInput = document.getElementById(`location-${category}`);
            const location = locationInput.value.trim();

            if (pallet.boxes.length === 0) {
                showNotification('‚ö†Ô∏è No hay cajas en esta tarima', 'warning');
                return;
            }

            if (!location) {
                showNotification('‚ö†Ô∏è Ingresa la ubicaci√≥n destino', 'warning');
                locationInput.focus();
                return;
            }

            // Pre-validaci√≥n: confirmar cantidad f√≠sica
            showSendValidationPopup(category, location);
        }

        // Popup de pre-validaci√≥n de cantidad f√≠sica
        function showSendValidationPopup(category, location) {
            const pallet = STATE.pallets[category];
            const boxCount = pallet.boxes.length;
            const categoryNames = { ok: 'OK ‚úÖ', blocked: 'Bloqueado ‚ö†Ô∏è', nowms: 'No WMS ‚ùå' };

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show';
            overlay.id = 'send-validation-popup';
            overlay.innerHTML = `
                <div class="popup-content send-validation-popup">
                    <div class="popup-header">
                        <span>üì¶ Validar Env√≠o - ${categoryNames[category]}</span>
                        <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 0.9em;">
                        <strong>Cajas escaneadas:</strong> <span style="font-size: 1.5em; color: var(--primary); font-weight: 700;">${boxCount}</span><br>
                        <strong>Destino:</strong> ${location}
                    </p>
                    <div class="validation-input-group">
                        <label>¬øCu√°ntas cajas f√≠sicas hay en la tarima?</label>
                        <input type="number" id="physical-count-input" min="0" placeholder="" autofocus
                               onkeyup="validateBoxCount(${boxCount})" onchange="validateBoxCount(${boxCount})">
                    </div>
                    <div id="validation-status"></div>
                    <div class="popup-buttons">
                        <button class="btn btn-success btn-full" id="confirm-send-btn" disabled
                                onclick="confirmSendPallet('${category}', '${location}')">
                            üì§ Confirmar Env√≠o
                        </button>
                        <button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            // Enfocar el input
            setTimeout(() => {
                const input = document.getElementById('physical-count-input');
                if (input) input.focus();
            }, 100);

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }

        // Validar cantidad de cajas f√≠sicas vs escaneadas
        function validateBoxCount(expectedCount) {
            const input = document.getElementById('physical-count-input');
            const statusDiv = document.getElementById('validation-status');
            const confirmBtn = document.getElementById('confirm-send-btn');
            const physicalCount = parseInt(input.value) || 0;

            if (physicalCount === expectedCount) {
                statusDiv.innerHTML = `<div class="validation-match">‚úÖ ¬°Correcto! Cantidad coincide (${expectedCount} cajas)</div>`;
                confirmBtn.disabled = false;
            } else if (physicalCount > 0) {
                const diff = physicalCount - expectedCount;
                const diffText = diff > 0 ? `+${diff} de m√°s` : `${Math.abs(diff)} faltan`;
                statusDiv.innerHTML = `<div class="validation-mismatch">‚ùå No coincide: Escaneadas ${expectedCount}, F√≠sicas ${physicalCount} (${diffText})</div>`;
                confirmBtn.disabled = true;
            } else {
                statusDiv.innerHTML = '';
                confirmBtn.disabled = true;
            }
        }

        // Confirmar env√≠o despu√©s de validaci√≥n
        async function confirmSendPallet(category, location) {
            // Cerrar popup de validaci√≥n
            document.getElementById('send-validation-popup')?.remove();

            const pallet = STATE.pallets[category];
            const locationInput = document.getElementById(`location-${category}`);
            const originLocationInput = document.getElementById('origin-location');
            const originLocation = originLocationInput.value.trim().toUpperCase();

            // Validar formato de ubicaci√≥n con doble confirmaci√≥n si es inv√°lida
            const locationCheck = confirmInvalidLocation(location);
            if (!locationCheck.confirmed) {
                showNotification('‚ùå Env√≠o cancelado - Verifica la ubicaci√≥n', 'warning');
                locationInput.focus();
                return;
            }

            // Usar la ubicaci√≥n formateada (normalizada si es v√°lida)
            const finalLocation = locationCheck.formatted;
            locationInput.value = finalLocation;

            const statusMap = { ok: 'OK', blocked: 'BLOQUEADO', nowms: 'NO WMS' };
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            const timeStr = now.toTimeString().slice(0, 8);

            // Incluye columna J: Ubicaci√≥n F√≠sica de Origen
            const records = pallet.boxes.map(box => ({
                date: dateStr,
                time: timeStr,
                user: CURRENT_USER || 'Usuario',
                scan1: box.code,
                scan2: box.scan2 || '',
                location: finalLocation,
                status: statusMap[category],
                note: '',
                pallet: pallet.id,
                originLocation: originLocation
            }));

            // Add to history
            STATE.history = [...records, ...STATE.history].slice(0, 1000);

            // Add to pending sync
            PENDING_SYNC = [...PENDING_SYNC, ...records];
            SyncManager.save();

            showNotification(`üíæ ${records.length} registros agregados`, 'info');

            // Try to sync immediately
            if (IS_ONLINE && gapi?.client?.getToken()) {
                await SyncManager.sync();
            } else {
                SyncManager.updateUI(false);
            }

            // Reset only this pallet
            const prefixes = { ok: 'OK', blocked: 'BLK', nowms: 'NW' };
            STATE.pallets[category] = {
                id: generatePalletId(prefixes[category]),
                boxes: [],
                location: ''
            };
            locationInput.value = '';

            saveToStorage();
            updateUI();
            playSound('success');

            // Mover foco al campo de ubicaci√≥n de origen para actualizar
            originLocationInput.focus();
            originLocationInput.select();
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            updateCounts();
            updateLists();
            updateSidebar();
            updateSendButtons();
            updateGlobalCounter();
            updateVerificationBadges();
        }

        function updateGlobalCounter() {
            const total = STATE.pallets.ok.boxes.length +
                          STATE.pallets.blocked.boxes.length +
                          STATE.pallets.nowms.boxes.length;
            const counterEl = document.getElementById('global-box-count');
            if (counterEl) {
                counterEl.textContent = total;
            }
        }

        function updateCounts() {
            document.getElementById('ok-count').textContent = STATE.pallets.ok.boxes.length;
            document.getElementById('blocked-count').textContent = STATE.pallets.blocked.boxes.length;
            document.getElementById('nowms-count').textContent = STATE.pallets.nowms.boxes.length;

            document.getElementById('ok-pallet').textContent = STATE.pallets.ok.id;
            document.getElementById('blocked-pallet').textContent = STATE.pallets.blocked.id;
            document.getElementById('nowms-pallet').textContent = STATE.pallets.nowms.id;
        }

        function updateLists() {
            updateList('ok');
            updateList('blocked');
            updateList('nowms');
        }

        function updateList(category) {
            const listEl = document.getElementById(`${category}-list`);
            const boxes = STATE.pallets[category].boxes;

            if (boxes.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div>Sin cajas</div>
                    </div>
                `;
                return;
            }

            const originLoc = document.getElementById('origin-location').value.trim().toUpperCase() || '-';

            listEl.innerHTML = boxes.map((box, index) => {
                const isVerified = box.verified || false;
                const verifiedClass = isVerified ? 'verified' : '';

                // Solo mostrar check en columna OK
                const checkBtn = category === 'ok'
                    ? `<button class="box-action-btn check" onclick="toggleBoxVerified('${category}', ${index})" title="Marcar verificado">
                         ${isVerified ? '‚úì' : '‚óã'}
                       </button>`
                    : '';

                return `
                <div class="box-item ${verifiedClass}">
                    <div class="box-info">
                        <div class="box-code">${box.code}${box.scan2 ? ` / ${box.scan2}` : ''}</div>
                        <div class="box-meta">${box.location} ‚Ä¢ ${box.timestamp}</div>
                    </div>
                    <div class="box-actions">
                        <button class="box-action-btn copy" onclick="copyToClipboard('${box.code}')" title="Copiar c√≥digo">‚ßâ</button>
                        <button class="box-action-btn copy" onclick="copyToClipboard('${box.location}')" title="Copiar ubicaci√≥n BD">‚óé</button>
                        ${checkBtn}
                        <button class="box-action-btn move" onclick="showMoveBoxPopup('${category}', ${index})" title="Mover a otro pallet">‚áÑ</button>
                        <button class="box-action-btn delete" onclick="deleteBox('${category}', ${index})" title="Eliminar">‚úï</button>
                    </div>
                </div>
            `}).join('');
        }

        // Toggle verificaci√≥n de caja en OK
        function toggleBoxVerified(category, index) {
            if (category !== 'ok') return;
            STATE.pallets[category].boxes[index].verified = !STATE.pallets[category].boxes[index].verified;
            saveToStorage();
            updateUI();
        }

        // Copiar al portapapeles
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification(`üìã Copiado: ${text}`, 'success');
            }).catch(() => {
                showNotification('‚ùå Error al copiar', 'error');
            });
        }

        // Popup para mover caja entre pallets
        function showMoveBoxPopup(fromCategory, index) {
            const box = STATE.pallets[fromCategory].boxes[index];
            const categories = ['ok', 'blocked', 'nowms'].filter(c => c !== fromCategory);
            const categoryNames = { ok: 'OK ‚úÖ', blocked: 'Bloqueado ‚ö†Ô∏è', nowms: 'No WMS ‚ùå' };

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show';
            overlay.innerHTML = `
                <div class="popup-content" style="max-width: 350px;">
                    <div class="popup-header">
                        <span>‚ÜîÔ∏è Mover Caja</span>
                        <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 0.9em;">
                        <strong>C√≥digo:</strong> <code>${box.code}</code><br>
                        <strong>Desde:</strong> ${categoryNames[fromCategory]}
                    </p>
                    <p style="margin-bottom: 10px; font-weight: 600;">Mover a:</p>
                    <div class="popup-buttons">
                        ${categories.map(cat => `
                            <button class="btn btn-${cat === 'ok' ? 'success' : cat === 'blocked' ? 'warning' : 'danger'} btn-full"
                                    onclick="moveBox('${fromCategory}', ${index}, '${cat}'); this.closest('.popup-overlay').remove();">
                                ${categoryNames[cat]}
                            </button>
                        `).join('')}
                        <button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }

        // Mover caja entre pallets
        function moveBox(fromCategory, index, toCategory) {
            const box = STATE.pallets[fromCategory].boxes.splice(index, 1)[0];
            box.verified = false; // Reset verificaci√≥n al mover
            STATE.pallets[toCategory].boxes.push(box);
            saveToStorage();
            updateUI();
            showNotification(`‚úÖ Caja movida a ${toCategory.toUpperCase()}`, 'success');
        }

        // ==================== MODAL DETALLE DE PALLET ====================
        let detailModalSort = { column: 'index', direction: 'asc' };
        let detailModalFilter = { code: '', location: '' };

        function showPalletDetailModal(category) {
            const pallet = STATE.pallets[category];
            const categoryNames = { ok: 'OK ‚úÖ', blocked: 'Bloqueado ‚ö†Ô∏è', nowms: 'No WMS ‚ùå' };
            const categoryColors = { ok: 'var(--success)', blocked: 'var(--blocked)', nowms: 'var(--error)' };

            if (pallet.boxes.length === 0) {
                showNotification('‚ö†Ô∏è No hay cajas en esta tarima', 'warning');
                return;
            }

            const verifiedCount = category === 'ok' ? pallet.boxes.filter(b => b.verified).length : 0;
            const pendingCount = pallet.boxes.length - verifiedCount;

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show';
            overlay.id = 'pallet-detail-modal';
            overlay.innerHTML = `
                <div class="popup-content pallet-detail-modal">
                    <div class="pallet-detail-header">
                        <div>
                            <span style="font-size: 1.2em; font-weight: 700; color: ${categoryColors[category]};">
                                ${categoryNames[category]} - ${pallet.id}
                            </span>
                            <span style="font-size: 0.9em; color: #666; margin-left: 10px;">${pallet.boxes.length} cajas</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${category === 'ok' ? `
                                <div class="pallet-detail-counters">
                                    <span class="counter-badge ok">‚úì ${verifiedCount}</span>
                                    <span class="counter-badge pending">‚óã ${pendingCount}</span>
                                </div>
                            ` : ''}
                            <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                        </div>
                    </div>
                    <div class="pallet-detail-filters">
                        <input type="text" placeholder="üîç Filtrar c√≥digo..." id="detail-filter-code" onkeyup="filterDetailModal('${category}')">
                        <input type="text" placeholder="üìç Filtrar ubicaci√≥n..." id="detail-filter-location" onkeyup="filterDetailModal('${category}')">
                        <button class="btn btn-small btn-secondary" onclick="clearDetailFilters('${category}')">Limpiar</button>
                    </div>
                    <div class="pallet-detail-table-container">
                        <table class="pallet-detail-table">
                            <thead>
                                <tr>
                                    <th onclick="sortDetailModal('${category}', 'index')"># ‚Üï</th>
                                    <th onclick="sortDetailModal('${category}', 'code')">C√≥digo ‚Üï</th>
                                    <th onclick="sortDetailModal('${category}', 'scan2')">C√≥digo 2 ‚Üï</th>
                                    <th onclick="sortDetailModal('${category}', 'location')">Ubicaci√≥n ‚Üï</th>
                                    <th onclick="sortDetailModal('${category}', 'timestamp')">Hora ‚Üï</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="detail-table-body"></tbody>
                        </table>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            renderDetailTable(category);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        }

        function renderDetailTable(category) {
            const pallet = STATE.pallets[category];
            const tbody = document.getElementById('detail-table-body');
            if (!tbody) return;
            const originLoc = document.getElementById('origin-location').value.trim().toUpperCase() || '-';

            let filtered = pallet.boxes.map((box, index) => ({ ...box, originalIndex: index }));
            if (detailModalFilter.code) {
                const s = detailModalFilter.code.toUpperCase();
                filtered = filtered.filter(b => b.code.toUpperCase().includes(s) || (b.scan2 && b.scan2.toUpperCase().includes(s)));
            }
            if (detailModalFilter.location) {
                const s = detailModalFilter.location.toUpperCase();
                filtered = filtered.filter(b => b.location.toUpperCase().includes(s));
            }

            filtered.sort((a, b) => {
                let valA, valB;
                switch (detailModalSort.column) {
                    case 'code': valA = a.code; valB = b.code; break;
                    case 'scan2': valA = a.scan2 || ''; valB = b.scan2 || ''; break;
                    case 'location': valA = a.location; valB = b.location; break;
                    case 'timestamp': valA = a.timestamp; valB = b.timestamp; break;
                    default: valA = a.originalIndex; valB = b.originalIndex;
                }
                if (typeof valA === 'string') return detailModalSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                return detailModalSort.direction === 'asc' ? valA - valB : valB - valA;
            });

            tbody.innerHTML = filtered.map((box, i) => {
                const verified = box.verified || false;
                const style = verified ? 'background: rgba(76, 175, 80, 0.1);' : '';
                const checkBtn = category === 'ok' ? `<button class="box-action-btn check" onclick="toggleBoxVerifiedModal('${category}', ${box.originalIndex})">${verified ? '‚úì' : '‚óã'}</button>` : '';
                return `<tr style="${style}"><td>${i + 1}</td><td><code>${box.code}</code></td><td><code>${box.scan2 || '-'}</code></td><td>${box.location}</td><td>${box.timestamp}</td><td><button class="box-action-btn copy" onclick="copyToClipboard('${box.code}')">‚ßâ</button><button class="box-action-btn copy" onclick="copyToClipboard('${box.location}')">‚óé</button>${checkBtn}<button class="box-action-btn move" onclick="showMoveBoxPopup('${category}', ${box.originalIndex}); document.getElementById('pallet-detail-modal')?.remove();">‚áÑ</button><button class="box-action-btn delete" onclick="deleteBoxModal('${category}', ${box.originalIndex})">‚úï</button></td></tr>`;
            }).join('');
        }

        function sortDetailModal(category, column) {
            if (detailModalSort.column === column) detailModalSort.direction = detailModalSort.direction === 'asc' ? 'desc' : 'asc';
            else { detailModalSort.column = column; detailModalSort.direction = 'asc'; }
            renderDetailTable(category);
        }

        function filterDetailModal(category) {
            detailModalFilter.code = document.getElementById('detail-filter-code')?.value || '';
            detailModalFilter.location = document.getElementById('detail-filter-location')?.value || '';
            renderDetailTable(category);
        }

        function clearDetailFilters(category) {
            document.getElementById('detail-filter-code').value = '';
            document.getElementById('detail-filter-location').value = '';
            detailModalFilter = { code: '', location: '' };
            renderDetailTable(category);
        }

        function toggleBoxVerifiedModal(category, index) {
            toggleBoxVerified(category, index);
            renderDetailTable(category);
            const pallet = STATE.pallets[category];
            const v = pallet.boxes.filter(b => b.verified).length;
            const p = pallet.boxes.length - v;
            const counters = document.querySelector('.pallet-detail-counters');
            if (counters) counters.innerHTML = `<span class="counter-badge ok">‚úì ${v}</span><span class="counter-badge pending">‚óã ${p}</span>`;
        }

        function deleteBoxModal(category, index) {
            if (confirm('¬øEliminar esta caja?')) {
                STATE.pallets[category].boxes.splice(index, 1);
                saveToStorage();
                updateUI();
                if (STATE.pallets[category].boxes.length === 0) {
                    document.getElementById('pallet-detail-modal')?.remove();
                    showNotification('Tarima vac√≠a', 'info');
                } else {
                    renderDetailTable(category);
                    showNotification('Caja eliminada', 'info');
                }
            }
        }

        function updateVerificationBadges() {
            const pallet = STATE.pallets.ok;
            const v = pallet.boxes.filter(b => b.verified).length;
            const p = pallet.boxes.length - v;
            const vBadge = document.getElementById('ok-verified-badge');
            const pBadge = document.getElementById('ok-pending-badge');
            if (pallet.boxes.length > 0) {
                vBadge.style.display = v > 0 ? 'flex' : 'none';
                document.getElementById('ok-verified-count').textContent = v;
                pBadge.style.display = p > 0 ? 'flex' : 'none';
                document.getElementById('ok-pending-count').textContent = p;
            } else {
                vBadge.style.display = 'none';
                pBadge.style.display = 'none';
            }
        }

        function updateSidebar() {
            document.getElementById('sidebar-ok-count').textContent = STATE.pallets.ok.boxes.length;
            document.getElementById('sidebar-blocked-count').textContent = STATE.pallets.blocked.boxes.length;
            document.getElementById('sidebar-nowms-count').textContent = STATE.pallets.nowms.boxes.length;

            document.getElementById('sidebar-ok-pallet').textContent = STATE.pallets.ok.id;
            document.getElementById('sidebar-blocked-pallet').textContent = STATE.pallets.blocked.id;
            document.getElementById('sidebar-nowms-pallet').textContent = STATE.pallets.nowms.id;
        }

        function updateSendButtons() {
            document.getElementById('send-ok-btn').disabled = STATE.pallets.ok.boxes.length === 0;
            document.getElementById('send-blocked-btn').disabled = STATE.pallets.blocked.boxes.length === 0;
            document.getElementById('send-nowms-btn').disabled = STATE.pallets.nowms.boxes.length === 0;
        }

        // ==================== PALLET MANAGEMENT ====================
        function generatePalletId(prefix = 'PD') {
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}-${timestamp}-${random}`;
        }

        function newSession() {
            const total = STATE.pallets.ok.boxes.length +
                          STATE.pallets.blocked.boxes.length +
                          STATE.pallets.nowms.boxes.length;

            if (total > 0) {
                if (!confirm(`Hay ${total} cajas en las tarimas. ¬øIniciar nueva sesi√≥n sin enviar?`)) {
                    return;
                }
            }

            STATE.pallets = {
                ok: { id: generatePalletId('OK'), boxes: [], location: '' },
                blocked: { id: generatePalletId('BLK'), boxes: [], location: '' },
                nowms: { id: generatePalletId('NW'), boxes: [], location: '' }
            };
            STATE.pendingCode1 = null;

            document.getElementById('result-box').classList.remove('show');
            document.getElementById('code2-container').classList.remove('show');
            document.getElementById('location-ok').value = '';
            document.getElementById('location-blocked').value = '';
            document.getElementById('location-nowms').value = '';
            document.getElementById('origin-location').value = '';

            saveToStorage();
            updateUI();
            showNotification('‚úÖ Nueva sesi√≥n iniciada', 'success');
            document.getElementById('origin-location').focus();
        }

        // ==================== RESUMEN MODULE ====================
        function showResumen() {
            updateResumen();
            document.getElementById('resumen-popup').classList.add('show');
        }

        function closeResumen() {
            document.getElementById('resumen-popup').classList.remove('show');
        }

        function updateResumen() {
            document.getElementById('resumen-ok').textContent = STATE.pallets.ok.boxes.length;
            document.getElementById('resumen-blocked').textContent = STATE.pallets.blocked.boxes.length;
            document.getElementById('resumen-nowms').textContent = STATE.pallets.nowms.boxes.length;
            document.getElementById('resumen-pending').textContent = PENDING_SYNC.length;

            // Update table
            const tbody = document.getElementById('resumen-table-body');
            const recentHistory = STATE.history.slice(0, 50);

            if (recentHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Sin registros recientes</td></tr>';
            } else {
                tbody.innerHTML = recentHistory.map(r => `
                    <tr>
                        <td>${r.time}</td>
                        <td><code>${r.scan1}</code></td>
                        <td><code>${r.scan2 || '-'}</code></td>
                        <td><span style="color: ${r.status === 'OK' ? 'var(--success)' : r.status === 'BLOQUEADO' ? 'var(--blocked)' : 'var(--error)'}">${r.status}</span></td>
                        <td>${r.location}</td>
                        <td>${r.originLocation || '-'}</td>
                        <td style="font-size: 0.8em;">${r.pallet}</td>
                    </tr>
                `).join('');
            }
        }

        // ==================== CONNECTION ====================
        function setupConnectionMonitor() {
            window.addEventListener('online', () => {
                IS_ONLINE = true;
                showConnectionBanner('online');
                updateConnectionIndicator();
                showNotification('‚úÖ Conexi√≥n restaurada', 'success');
                setTimeout(() => SyncManager.sync(), 1000);
            });

            window.addEventListener('offline', () => {
                IS_ONLINE = false;
                showConnectionBanner('offline');
                updateConnectionIndicator();
                showNotification('‚ö†Ô∏è Sin conexi√≥n - Modo offline', 'warning');
            });

            updateConnectionIndicator();
        }

        function showConnectionBanner(status) {
            const banner = document.getElementById('connection-banner');
            banner.className = `connection-banner ${status}`;
            banner.textContent = status === 'online' ? '‚úÖ Conexi√≥n restaurada' :
                                 status === 'offline' ? '‚ö†Ô∏è Sin conexi√≥n a internet' :
                                 'üîÑ Sincronizando...';
            if (status === 'online') {
                setTimeout(() => banner.style.display = 'none', 3000);
            }
        }

        function updateConnectionIndicator(syncing = false) {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');

            if (!dot || !text) return;

            if (syncing) {
                dot.className = 'connection-dot syncing';
                text.textContent = 'Sincronizando...';
            } else if (IS_ONLINE) {
                dot.className = 'connection-dot online';
                text.textContent = 'En l√≠nea';
            } else {
                dot.className = 'connection-dot offline';
                text.textContent = 'Sin conexi√≥n';
            }
        }

        function toggleConnection() {
            if (gapi?.client?.getToken()) {
                if (confirm('¬øDesconectar de Google?')) {
                    google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                    gapi.client.setToken(null);
                    showNotification('Desconectado de Google', 'info');
                    updateConnectionIndicator();
                }
            } else {
                handleLogin();
            }
        }

        // ==================== STORAGE ====================
        async function loadFromStorage() {
            try {
                const saved = localStorage.getItem('pd_system_state');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.inventory) STATE.inventory = new Map(data.inventory);
                    STATE.inventoryLastUpdate = data.inventoryLastUpdate;
                    if (data.pallets) STATE.pallets = data.pallets;
                    STATE.history = data.history || [];
                }
                updateBdInfo();
            } catch (e) {
                console.error('Error loading from storage:', e);
            }
        }

        async function saveToStorage() {
            try {
                const data = {
                    inventory: Array.from(STATE.inventory.entries()),
                    inventoryLastUpdate: STATE.inventoryLastUpdate,
                    pallets: STATE.pallets,
                    history: STATE.history.slice(0, 1000)
                };
                localStorage.setItem('pd_system_state', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving to storage:', e);
            }
        }

        // ==================== EXPORT ====================
        function exportData() {
            if (STATE.history.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }

            const headers = ['FECHA', 'HORA', 'RESPONSABLE', 'SCAN 1', 'SCAN 2', 'UBICACION DESTINO', 'ESTATUS', 'NOTA', 'PALLET', 'UBICACION FISICA ORIGEN'];
            const rows = STATE.history.map(r => [
                r.date, r.time, r.user, r.scan1, r.scan2, r.location, r.status, r.note, r.pallet, r.originLocation || ''
            ]);

            const csv = '\ufeff' + [
                headers.join(','),
                ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `inventario_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();

            showNotification('‚úÖ Datos exportados', 'success');
        }

        // ==================== UTILITIES ====================
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span style="margin-right: 8px;">${icons[type]}</span>${message}`;

            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function playSound(type) {
            if (!audioCtx) return;

            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);

                if (type === 'success') {
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.15);
                } else if (type === 'error') {
                    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.35);
                } else if (type === 'warning') {
                    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.1);
                }
            } catch (e) {}
        }
    </script>
</body>
</html>
