<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inventario (Multi-Pesta√±a)</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #3b82f6; /* Nuevo color para pesta√±a activa/tarima no definida */
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --blocked: #f97316;
            --no-wms: #e91e63; /* Nuevo color para No WMS */
            --bg: #f7f7f7;
            --text: #333;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* Connection Banner */
        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s;
        }
        .connection-banner.offline {
            background: var(--error);
            color: white;
            display: block;
        }
        .connection-banner.online {
            background: var(--success);
            color: white;
            display: block;
        }
        .connection-banner.syncing {
            background: var(--warning);
            color: white;
            display: block;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        /* MAIN LAYOUT */
        .main-container {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0; /* Asegura que la barra lateral no se encoja */
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #555;
        }

        .sidebar-header h2 {
            color: var(--primary);
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.8em;
            color: #aaa;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }

        .sidebar-section-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .sidebar-btn:hover {
            transform: translateX(3px);
        }

        .sidebar-btn-primary {
            background: var(--primary);
            color: white;
        }

        .sidebar-btn-secondary {
            background: #555;
            color: white;
        }

        /* Sync Status */
        .sync-status {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            cursor: pointer;
        }
        .sync-ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .sync-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }
        .sync-warning {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* Pallets por estatus (Ahora Tarimas por Pesta√±a) */
        .pallet-status-list {
            flex: 1;
            overflow-y: auto;
        }

        .pallet-status-item {
            background: #444;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .pallet-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .pallet-status-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .pallet-status-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .pallet-code {
            font-family: monospace;
            font-size: 0.7em;
            color: #aaa;
            word-break: break-all;
        }

        .pallet-send-btn {
            margin-top: 6px;
            padding: 5px 10px;
            font-size: 0.7em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }

        .pallet-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pallet-send-btn.ok { background: var(--success); color: white; }
        .pallet-send-btn.blocked { background: var(--blocked); color: white; }
        .pallet-send-btn.nowms { background: var(--no-wms); color: white; }

        /* User Footer (Conservado) */
        .user-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #555;
        }
        /* ... (styles for user-info, user-avatar, etc., preserved) ... */
        .user-info { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1em; color: white; flex-shrink: 0; cursor: pointer; }
        .user-details { flex: 1; overflow: hidden; }
        .user-name { font-weight: 600; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .connection-indicator { font-size: 0.75em; display: flex; align-items: center; gap: 4px; }
        .connection-dot { width: 8px; height: 8px; border-radius: 50%; }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }
        .connection-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .user-footer-actions { display: flex; gap: 5px; margin-bottom: 8px; }
        .user-footer-actions button { flex: 1; padding: 6px; font-size: 0.75em; }
        .bd-info { font-size: 0.7em; color: #aaa; text-align: center; line-height: 1.4; }
        /* FIN User Footer */


        /* MAIN CONTENT (Adaptado para PESTA√ëAS) */
        .main-content {
            flex: 1;
            padding: 0; /* Removido padding para que las pesta√±as tomen todo el ancho */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- NUEVOS ESTILOS PARA PESTA√ëAS --- */
        .tab-header-container {
            display: flex;
            background: #ddd;
            padding: 5px 0 0 15px;
            border-bottom: 1px solid #ccc;
            overflow-x: auto;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab-header {
            padding: 10px 15px;
            margin-right: 2px;
            background: #eee;
            border: 1px solid #ccc;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .tab-header:hover {
            background: #fff;
        }

        .tab-header.active {
            background: var(--bg);
            border-color: #ccc;
            border-bottom: 1px solid var(--bg);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            color: var(--primary);
        }

        .tab-badge {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            transition: background 0.3s;
        }

        .tab-badge.ok { background: var(--success); }
        .tab-badge.blocked { background: var(--blocked); }
        .tab-badge.nowms { background: var(--error); }
        .tab-badge.empty { background: var(--secondary); }

        .tab-close {
            margin-left: 8px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1em;
            padding: 0;
            line-height: 1;
        }

        .tab-close:hover {
            color: var(--error);
        }

        .tab-content-container {
            flex: 1;
            overflow: hidden;
            padding: 15px;
            background: var(--bg);
        }

        .tab-content {
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }
        /* --- FIN ESTILOS PARA PESTA√ëAS --- */

        /* Header (Ahora dentro de cada pesta√±a) */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.4em;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        /* Scan Section (Ahora por pesta√±a) */
        .scan-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .scan-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .scan-input-group {
            flex: 1;
        }

        .scan-input-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .scan-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.3em;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
            transition: all 0.2s;
        }

        .scan-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .scan-input.error {
            border-color: var(--error);
            background: #ffebee;
        }

        .scan-input.success {
            border-color: var(--success);
            background: #e8f5e9;
        }

        /* Result Box (Conservado) */
        .result-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-box.show { display: block; }
        .result-box.success { background: #e8f5e9; border: 2px solid var(--success); }
        .result-box.warning { background: #fff3e0; border: 2px solid var(--warning); }
        .result-box.blocked { background: #fff3e0; border: 2px solid var(--blocked); }
        .result-box.error { background: #ffebee; border: 2px solid var(--error); }

        .result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .result-icon { font-size: 1.5rem; }
        .result-title { font-weight: 700; font-size: 1.1em; }
        .result-code { font-family: monospace; font-weight: 600; }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            font-size: 0.85em;
        }

        .result-detail-label { color: #666; font-size: 0.8em; }
        .result-detail-value { font-weight: 600; }

        /* Code2 Input (Conservado) */
        .code2-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px dashed var(--error);
            display: none;
        }

        .code2-container.show { display: block; }

        .code2-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn-insertado {
            padding: 12px 20px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-insertado:hover {
            background: #d32f2f;
        }

        /* Columns Container (Adaptado para Consolidado y Log) */
        .columns-container {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Tarima consolidada (2) y Log (1) */
            gap: 12px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* Estilo para la columna de Tarima Consolidada */
        .column-consolidated {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .column-title {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--primary);
        }

        .column-count {
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
            background: rgba(37, 99, 235, 0.15);
            color: var(--primary);
        }

        /* Contenedor de Pallets Consolidado */
        .consolidated-pallets {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .pallet-info-card {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85em;
            border-left: 5px solid var(--secondary);
            flex: 1;
            min-width: 150px;
        }

        .pallet-info-card.ok { border-color: var(--success); }
        .pallet-info-card.blocked { border-color: var(--blocked); }
        .pallet-info-card.nowms { border-color: var(--no-wms); }

        .pallet-info-card div { margin-bottom: 4px; }
        .pallet-info-card .pallet-id {
            font-weight: 700;
            color: var(--primary);
            font-family: monospace;
        }
        .pallet-info-card .pallet-status-count {
            background: white;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 700;
        }

        .pallet-list-container {
            flex: 1;
            overflow-y: auto;
        }

        .box-item {
            padding: 8px 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid;
            counter-increment: item-counter;
        }

        .box-item.ok { border-color: var(--success); }
        .box-item.blocked { border-color: var(--blocked); }
        .box-item.nowms { border-color: var(--no-wms); }

        .box-item::before {
            content: counter(item-counter) ".";
            font-weight: 700;
            min-width: 25px;
            margin-right: 8px;
            color: #999;
        }
        .box-item.ok::before { color: var(--success); }
        .box-item.blocked::before { color: var(--blocked); }
        .box-item.nowms::before { color: var(--no-wms); }

        .box-info { flex: 1; }
        .box-code { font-weight: 600; font-family: monospace; font-size: 0.9em; }
        .box-meta { font-size: 0.75em; color: #666; }

        .box-delete {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1.1em;
            padding: 4px;
            opacity: 0.6;
            flex-shrink: 0;
        }

        .box-delete:hover { opacity: 1; }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #999;
        }

        .empty-icon { font-size: 2.5em; margin-bottom: 8px; opacity: 0.5; }

        /* Estilo para el Log Visual */
        .log-column {
            background: #2d3748; /* Fondo oscuro para el log */
            color: #f7fafc;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .log-column .column-header {
            border-bottom: 2px solid #4a5568;
            margin-bottom: 8px;
            padding-bottom: 8px;
        }

        .log-column .column-title {
            color: #90cdf4;
        }

        .log-list {
            flex: 1;
            overflow-y: auto;
        }

        .log-entry {
            display: flex;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #4a5568;
            font-size: 0.8em;
            gap: 8px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-status-icon {
            font-size: 1em;
            flex-shrink: 0;
        }

        .log-entry.ok .log-status-icon { color: var(--success); }
        .log-entry.blocked .log-status-icon { color: var(--blocked); }
        .log-entry.nowms .log-status-icon { color: var(--error); }

        .log-time {
            color: #a0aec0;
            font-family: monospace;
            font-size: 0.9em;
            flex-shrink: 0;
            min-width: 40px;
        }

        .log-code {
            font-weight: 600;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* Buttons (Conservado) */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-google { background: #4285F4; color: white; }

        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        .btn-full { width: 100%; }

        /* Notifications (Conservado) */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .notification {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }

        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Popups (Conservado) */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-overlay.show { display: flex; }

        .popup-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .popup-header {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .popup-close:hover { color: #333; }

        .popup-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        /* Resumen Module (Conservado) */
        .resumen-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .resumen-stat {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f5f5f5;
        }

        .resumen-stat-number {
            font-size: 2em;
            font-weight: 700;
        }

        .resumen-stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .resumen-stat.ok { border: 2px solid var(--success); }
        .resumen-stat.ok .resumen-stat-number { color: var(--success); }

        .resumen-stat.blocked { border: 2px solid var(--blocked); }
        .resumen-stat.blocked .resumen-stat-number { color: var(--blocked); }

        .resumen-stat.nowms { border: 2px solid var(--error); }
        .resumen-stat.nowms .resumen-stat-number { color: var(--error); }

        .resumen-stat.pending { border: 2px solid var(--warning); }
        .resumen-stat.pending .resumen-stat-number { color: var(--warning); }

        .resumen-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .resumen-table th, .resumen-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .resumen-table th {
            background: #f5f5f5;
            font-weight: 700;
            position: sticky;
            top: 0;
        }

        .resumen-table-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .resumen-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .hidden { display: none !important; }

        /* --- NUEVO ESTILO: Loading Overlay --- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            transition: opacity 0.3s;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 15px;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--primary);
        }
        /* --- FIN Loading Overlay --- */

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 180px; }
            .columns-container { grid-template-columns: 1fr; } /* Stack columns */
            .resumen-stats { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; max-height: 200px; }
        }
    </style>
</head>
<body>
    <div class="connection-banner" id="connection-banner"></div>
    <div class="notification-container" id="notifications"></div>

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Cargando datos...</div>
    </div>

    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">üì¶</div>
            <h1 class="login-title">Sistema Inventario</h1>
            <p class="login-subtitle">Control y gesti√≥n de mercanc√≠a</p>
            <button class="btn btn-google btn-full" onclick="handleLogin()" style="padding: 15px; font-size: 1.1em;">
                üîê Iniciar sesi√≥n con Google
            </button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="main-container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>üì¶ Inventario</h2>
                    <p>Sistema de gesti√≥n</p>
                </div>

                <div id="sync-status" class="sync-status sync-ok" onclick="SyncManager.showPanel()">
                    ‚úÖ Sincronizado
                </div>

                <div class="sidebar-section">
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showResumen()">
                        üìä Resumen
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="createNewTab()">
                        ‚ûï Nueva Sesi√≥n
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="downloadCSV()">
                        üì• Exportar CSV
                    </button>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Totales Acumulados</div>
                    <div class="pallet-status-list" id="global-status-list">
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--success);">‚úÖ OK</span>
                                <span class="pallet-status-count" id="sidebar-ok-count">0</span>
                            </div>
                        </div>
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--blocked);">‚ö†Ô∏è Bloqueado</span>
                                <span class="pallet-status-count" id="sidebar-blocked-count">0</span>
                            </div>
                        </div>
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--no-wms);">‚ùå No WMS</span>
                                <span class="pallet-status-count" id="sidebar-nowms-count">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="user-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar" onclick="changeUserAlias()">?</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name-display" onclick="changeUserAlias()">No conectado</div>
                            <div class="connection-indicator">
                                <div class="connection-dot" id="connection-dot"></div>
                                <span id="connection-text">Offline</span>
                            </div>
                        </div>
                    </div>
                    <div class="user-footer-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshInventory()">üîÑ BD</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleConnection()" id="sidebar-auth-btn">üîó</button>
                        <button class="btn btn-danger btn-small" onclick="handleLogout()">üö™</button>
                    </div>
                    <div class="bd-info">
                        <div><span id="bd-count">0</span> c√≥digos cargados</div>
                        <div id="bd-update-time">Sin actualizar</div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="tab-header-container" id="tab-header-container">
                    </div>
                <div class="tab-content-container" id="tab-content-container">
                    <div id="empty-tabs-message" style="text-align: center; padding-top: 50px; color: #999;">
                        Inicia una nueva sesi√≥n haciendo clic en "‚ûï Nueva Sesi√≥n".
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="resumen-popup">
        <div class="popup-content">
            <div class="popup-header">
                <span>üìä Resumen de Sesi√≥n</span>
                <button class="popup-close" onclick="closeResumen()">√ó</button>
            </div>

            <div class="resumen-stats">
                <div class="resumen-stat ok">
                    <div class="resumen-stat-number" id="resumen-ok">0</div>
                    <div class="resumen-stat-label">OK</div>
                </div>
                <div class="resumen-stat blocked">
                    <div class="resumen-stat-number" id="resumen-blocked">0</div>
                    <div class="resumen-stat-label">Bloqueado</div>
                </div>
                <div class="resumen-stat nowms">
                    <div class="resumen-stat-number" id="resumen-nowms">0</div>
                    <div class="resumen-stat-label">No WMS</div>
                </div>
                <div class="resumen-stat pending">
                    <div class="resumen-stat-number" id="resumen-pending">0</div>
                    <div class="resumen-stat-label">Pendientes Sync</div>
                </div>
            </div>

            <div class="resumen-actions">
                <button class="btn btn-primary btn-small" onclick="refreshInventory(); closeResumen();">üîÑ Recargar BD</button>
                <button class="btn btn-success btn-small" onclick="SyncManager.sync(true); updateResumen();">üîÑ Sincronizar</button>
                <button class="btn btn-secondary btn-small" onclick="downloadCSV();">üì• Exportar CSV</button>
            </div>

            <h3 style="margin-bottom: 10px; font-size: 1em;">üìã Historial Reciente</h3>
            <div class="resumen-table-container">
                <table class="resumen-table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>C√≥digo</th>
                            <th>C√≥digo 2</th>
                            <th>Estatus</th>
                            <th>Ubicaci√≥n</th>
                            <th>Pallet</th>
                        </tr>
                    </thead>
                    <tbody id="resumen-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            CLIENT_ID: '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile',
            SPREADSHEET_WRITE: '1FBhZloEeT-xTe1yVKzdWxGJa6gKkZQOObmkBMuxqcv8',
            SHEET_NAME: 'BD',
            INVENTORY_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-HG8HPf-94Ki5Leo5iEF5pyqsiD9CVk-mcl-F8BAw34kT0s3nzNn532YTYDCtkG76NbauiVx0Ffmd/pub?output=csv'
        };

        // ==================== STATE (ADAPTADO PARA PESTA√ëAS) ====================
        const MAX_TABS = 5;
        const TAB_PREFIX = 'tab-';

        let STATE = {
            inventory: new Map(),
            inventoryLastUpdate: null,
            pendingCode1: null, // Obsoleto, ahora por pesta√±a
            history: []
        };
        let TABS_STATE = {}; // Nuevo objeto para manejar el estado de cada pesta√±a
        let activeTabId = null;

        let CURRENT_USER = '';
        let USER_EMAIL = '';
        let USER_GOOGLE_NAME = '';
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];
        let TOKEN_CLIENT = null;
        let audioCtx = null;


        // ==================== UTILITIES (MEJORADAS Y NUEVAS) ====================

        /**
         * Muestra el overlay de carga.
         * @param {string} text El texto a mostrar.
         */
        function showLoading(text = 'Cargando...') {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            if (overlay) {
                overlay.classList.remove('hidden');
            }
            if (loadingText) {
                loadingText.textContent = text;
            }
        }

        /**
         * Oculta el overlay de carga.
         */
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        /**
         * Muestra una notificaci√≥n temporal. (MANTENIDO)
         * @param {string} message El mensaje a mostrar.
         * @param {string} type El tipo de notificaci√≥n ('success', 'error', 'warning', 'info').
         */
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            if (!container) return;

            const icons = {
                'success': 'üëç',
                'error': 'üõë',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è',
                'blocked': 'üöß',
                'nowms': '‚ùå'
            };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span style="margin-right: 8px;">${icons[type] || 'üì¶'}</span>${message}`;

            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
            playSound(type);
        }

        /**
         * Toca un sonido para feedback. (MANTENIDO)
         * @param {string} type El tipo de sonido ('success', 'error', 'warning').
         */
        function playSound(type) {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    // Audio not supported or restricted
                    return;
                }
            }

            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);

                if (type === 'success') {
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.15);
                } else if (type === 'error' || type === 'blocked' || type === 'nowms') {
                    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.35);
                } else if (type === 'warning' || type === 'info') {
                    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.1);
                }
            } catch (e) { }
        }

        /**
         * Genera un ID de Pallet basado en el estatus. (ADAPTADO)
         * @param {string} status El estatus ('OK', 'BLK', 'NW').
         * @returns {string} El ID de Pallet √∫nico.
         */
        function generatePalletId(status) {
            const date = new Date();
            const year = date.getFullYear().toString().slice(2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `${status}-${year}${month}${day}-${random}`;
        }

        /**
         * Genera un ID de Pesta√±a √∫nico. (NUEVO)
         * @returns {string} El ID de pesta√±a √∫nico.
         */
        function generateTabId() {
            return TAB_PREFIX + Date.now();
        }

        /**
         * Convierte el array de objetos de un estado de pesta√±a a CSV. (NUEVO)
         * @param {Array<Object>} data Array de cajas.
         * @param {Object} palletData Datos del pallet (ID, Location).
         * @returns {string} El string CSV.
         */
        function convertToCSV(data, palletData) {
            const header = ["Fecha", "Hora", "Usuario", "C√≥digo Principal", "C√≥digo 2", "Ubicaci√≥n", "Estatus", "Pallet ID", "Nota"];
            const csv = data.map(item => [
                item.date,
                item.time,
                item.user,
                item.scan1,
                item.scan2,
                palletData.location || '',
                item.status,
                palletData.id,
                item.note || ''
            ].map(String).map(s => `"${s.replace(/"/g, '""')}"`).join(','));

            return header.join(',') + '\n' + csv.join('\n');
        }

        /**
         * Descarga todos los datos pendientes de todas las pesta√±as. (NUEVO)
         */
        function downloadCSV() {
            let allData = [];
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            let filename = `Inventario_Pendientes_${timestamp}.csv`;
            let totalRecords = 0;

            // 1. Recopilar datos de PENDING_SYNC
            const pendingHeader = ["Fecha", "Hora", "Usuario", "C√≥digo Principal", "C√≥digo 2", "Ubicaci√≥n", "Estatus", "Pallet ID", "Nota"];
            const pendingCSV = PENDING_SYNC.map(r => [
                r.date, r.time, r.user, r.scan1, r.scan2, r.location, r.status, r.pallet, r.note
            ].map(String).map(s => `"${s.replace(/"/g, '""')}"`).join(','));

            // 2. Recopilar datos de TABS_STATE
            for (const tabId in TABS_STATE) {
                const tabState = TABS_STATE[tabId];
                ['ok', 'blocked', 'nowms'].forEach(status => {
                    const pallet = tabState.pallets[status];
                    if (pallet.boxes.length > 0) {
                        pallet.boxes.forEach(box => {
                            allData.push([
                                box.date,
                                box.time,
                                box.user,
                                box.scan1,
                                box.scan2,
                                pallet.location || 'PENDIENTE',
                                box.status,
                                pallet.id,
                                box.note || ''
                            ]);
                        });
                        totalRecords += pallet.boxes.length;
                    }
                });
            }

            // 3. Crear el archivo CSV
            let csvContent = pendingHeader.join(',') + '\n';
            csvContent += pendingCSV.join('\n');
            if (pendingCSV.length > 0 && allData.length > 0) {
                csvContent += '\n' + pendingHeader.join(',') + ' (DATOS EN PESTA√ëAS)' + '\n';
            }
            csvContent += allData.map(row => row.map(String).map(s => `"${s.replace(/"/g, '""')}"`).join(',')).join('\n');

            if (PENDING_SYNC.length === 0 && allData.length === 0) {
                showNotification('‚ùå No hay datos pendientes para exportar.', 'error');
                return;
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification(`‚úÖ Exportados ${PENDING_SYNC.length + totalRecords} registros pendientes.`, 'success');
            } else {
                showNotification('‚ùå Tu navegador no soporta la descarga autom√°tica de archivos.', 'error');
            }
        }

        // ==================== TAB MANAGER (NUEVO) ====================

        /**
         * Crea el HTML para un m√≥dulo de captura (Scan + Tarima + Log).
         * @param {string} tabId El ID √∫nico de la pesta√±a.
         * @returns {string} El HTML completo del m√≥dulo.
         */
        function createCaptureModuleHTML(tabId) {
            return `
                <div class="header">
                    <h1>üì∏ Sesi√≥n ${tabId.replace(TAB_PREFIX, '')}</h1>
                    <div class="header-actions">
                        <input type="text" id="location-${tabId}" class="btn-small" placeholder="Ubicaci√≥n Pallets" style="width: 150px; text-align: left;">
                        <button class="btn btn-primary btn-small" onclick="sendData('${tabId}')" id="send-all-btn-${tabId}" disabled>
                            üì§ Enviar Todo (<span id="total-boxes-${tabId}">0</span>)
                        </button>
                    </div>
                </div>

                <div class="scan-section">
                    <div class="scan-row">
                        <div class="scan-input-group">
                            <label>üîç C√≥digo Principal</label>
                            <input type="text" class="scan-input" id="scan-input-${tabId}" placeholder="Escanea o ingresa c√≥digo..." autocomplete="off">
                        </div>
                    </div>

                    <div class="result-box" id="result-box-${tabId}">
                        <div class="result-header">
                            <span class="result-icon" id="result-icon-${tabId}">üì¶</span>
                            <span class="result-title" id="result-title-${tabId}">Estado</span>
                        </div>
                        <div class="result-code" id="result-code-${tabId}"></div>
                        <div class="result-details" id="result-details-${tabId}"></div>
                    </div>

                    <div class="code2-container" id="code2-container-${tabId}">
                        <label style="font-size: 0.9em; color: var(--error); font-weight: 600; margin-bottom: 8px; display: block;">
                            ‚ö†Ô∏è C√≥digo no encontrado. Ingresa C√≥digo 2 o fuerza el registro:
                        </label>
                        <div class="code2-row">
                            <div class="scan-input-group">
                                <input type="text" class="scan-input" id="code2-input-${tabId}" placeholder="C√≥digo 2..." autocomplete="off" style="font-size: 1.1em;">
                            </div>
                            <button class="btn-insertado" onclick="forceInsert('${tabId}')" id="force-insert-btn-${tabId}">
                                ‚ö° INSERTADO
                            </button>
                        </div>
                    </div>
                </div>

                <div class="columns-container">
                    <div class="column-consolidated">
                        <div class="column-header">
                            <span class="column-title">
                                üß∫ Tarima Consolidada
                            </span>
                            <span class="column-count" id="consolidated-count-${tabId}">0</span>
                        </div>

                        <div class="consolidated-pallets" id="consolidated-pallets-${tabId}">
                            </div>

                        <div class="pallet-list-container" id="pallet-list-${tabId}">
                            <div class="empty-state">
                                <div class="empty-icon">üì≠</div>
                                <div>Escanea una caja para empezar la Tarima.</div>
                            </div>
                        </div>
                    </div>

                    <div class="log-column">
                        <div class="column-header">
                            <span class="column-title">
                                üí¨ Log Visual
                            </span>
                            <span class="column-count" id="log-count-${tabId}">0</span>
                        </div>
                        <div class="log-list" id="log-list-${tabId}">
                            <div class="empty-state" style="padding: 10px; color: #a0aec0;">
                                <div>Log de escaneos</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Crea un nuevo estado para una pesta√±a.
         * @returns {Object} El estado inicial de la pesta√±a.
         */
        function createNewTabState() {
            return {
                pallets: {
                    ok: { id: generatePalletId('OK'), boxes: [], location: '' },
                    blocked: { id: generatePalletId('BLK'), boxes: [], location: '' },
                    nowms: { id: generatePalletId('NW'), boxes: [], location: '' }
                },
                pendingCode1: null,
                log: []
            };
        }

        /**
         * Crea y a√±ade una nueva pesta√±a.
         */
        function createNewTab() {
            if (Object.keys(TABS_STATE).length >= MAX_TABS) {
                showNotification(`‚ö†Ô∏è L√≠mite de ${MAX_TABS} sesiones activas. Cierra una para abrir una nueva.`, 'warning');
                return;
            }

            const tabId = generateTabId();
            TABS_STATE[tabId] = createNewTabState();
            saveTabsState();

            // 1. Crear el header de la pesta√±a
            const headerContainer = document.getElementById('tab-header-container');
            const tabHeader = document.createElement('div');
            tabHeader.id = `header-${tabId}`;
            tabHeader.className = 'tab-header';
            tabHeader.onclick = () => switchTab(tabId);
            tabHeader.innerHTML = `
                <span>Sesi√≥n ${tabId.replace(TAB_PREFIX, '')}</span>
                <span class="tab-badge empty" id="badge-${tabId}">0</span>
                <button class="tab-close" onclick="event.stopPropagation(); closeTab('${tabId}')">√ó</button>
            `;
            headerContainer.appendChild(tabHeader);

            // 2. Crear el contenido de la pesta√±a
            const contentContainer = document.getElementById('tab-content-container');
            const tabContent = document.createElement('div');
            tabContent.id = `content-${tabId}`;
            tabContent.className = 'tab-content';
            tabContent.innerHTML = createCaptureModuleHTML(tabId);
            contentContainer.appendChild(tabContent);

            // 3. Ocultar mensaje de bienvenida y activar la nueva pesta√±a
            document.getElementById('empty-tabs-message').classList.add('hidden');
            switchTab(tabId);

            // 4. Configurar listeners de entrada
            setTimeout(() => {
                const scanInput = document.getElementById(`scan-input-${tabId}`);
                scanInput.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        handleScan(e, tabId);
                    }
                };
                scanInput.focus();
            }, 50);

            showNotification(`‚úÖ Sesi√≥n ${tabId.replace(TAB_PREFIX, '')} iniciada.`, 'info');
        }

        /**
         * Cambia a la pesta√±a especificada.
         * @param {string} id El ID de la pesta√±a a activar.
         */
        function switchTab(id) {
            if (activeTabId === id) return;

            // Desactivar pesta√±a anterior
            if (activeTabId) {
                document.getElementById(`header-${activeTabId}`)?.classList.remove('active');
                document.getElementById(`content-${activeTabId}`)?.classList.remove('active');
            }

            // Activar nueva pesta√±a
            activeTabId = id;
            document.getElementById(`header-${id}`)?.classList.add('active');
            const content = document.getElementById(`content-${id}`);
            content?.classList.add('active');

            // Asegurar que el input de escaneo tenga foco
            document.getElementById(`scan-input-${id}`)?.focus();
        }

        /**
         * Cierra la pesta√±a si no tiene datos pendientes.
         * @param {string} id El ID de la pesta√±a a cerrar.
         */
        function closeTab(id) {
            const state = TABS_STATE[id];
            const totalBoxes = state.pallets.ok.boxes.length + state.pallets.blocked.boxes.length + state.pallets.nowms.boxes.length;

            if (totalBoxes > 0) {
                const confirmation = confirm(`‚ö†Ô∏è La Sesi√≥n ${id.replace(TAB_PREFIX, '')} tiene ${totalBoxes} cajas sin enviar. ¬øDeseas cerrar y perder los datos?`);
                if (!confirmation) return;
            }

            // Eliminar del estado y del DOM
            delete TABS_STATE[id];
            saveTabsState();

            document.getElementById(`header-${id}`)?.remove();
            document.getElementById(`content-${id}`)?.remove();

            showNotification(`‚ÑπÔ∏è Sesi√≥n ${id.replace(TAB_PREFIX, '')} cerrada.`, 'info');

            // Seleccionar otra pesta√±a o mostrar mensaje de bienvenida
            const tabIds = Object.keys(TABS_STATE);
            if (tabIds.length > 0) {
                const newActiveId = tabIds[0];
                switchTab(newActiveId);
            } else {
                activeTabId = null;
                document.getElementById('empty-tabs-message').classList.remove('hidden');
            }
            updateGlobalSidebarStatus();
        }

        /**
         * Guarda el estado de las pesta√±as en localStorage.
         */
        function saveTabsState() {
            try {
                // Guardar solo el estado necesario (pallets y log)
                const serializableState = {};
                for (const id in TABS_STATE) {
                    serializableState[id] = {
                        pallets: TABS_STATE[id].pallets,
                        log: TABS_STATE[id].log
                    };
                }
                localStorage.setItem('pd_tabs_state', JSON.stringify(serializableState));
            } catch (e) { }
        }

        /**
         * Carga el estado de las pesta√±as desde localStorage y las reconstruye.
         */
        function loadTabsState() {
            try {
                const saved = localStorage.getItem('pd_tabs_state');
                if (saved) {
                    const loadedState = JSON.parse(saved);
                    TABS_STATE = {};
                    const tabIds = Object.keys(loadedState);

                    tabIds.forEach(tabId => {
                        const state = createNewTabState(); // Iniciar con el template
                        state.pallets = loadedState[tabId].pallets || state.pallets;
                        state.log = loadedState[tabId].log || state.log;
                        TABS_STATE[tabId] = state; // Sobrescribir el estado

                        // Reconstruir el DOM
                        const headerContainer = document.getElementById('tab-header-container');
                        const contentContainer = document.getElementById('tab-content-container');

                        const tabHeader = document.createElement('div');
                        tabHeader.id = `header-${tabId}`;
                        tabHeader.className = 'tab-header';
                        tabHeader.onclick = () => switchTab(tabId);
                        tabHeader.innerHTML = `
                            <span>Sesi√≥n ${tabId.replace(TAB_PREFIX, '')}</span>
                            <span class="tab-badge empty" id="badge-${tabId}">0</span>
                            <button class="tab-close" onclick="event.stopPropagation(); closeTab('${tabId}')">√ó</button>
                        `;
                        headerContainer.appendChild(tabHeader);

                        const tabContent = document.createElement('div');
                        tabContent.id = `content-${tabId}`;
                        tabContent.className = 'tab-content';
                        tabContent.innerHTML = createCaptureModuleHTML(tabId);
                        contentContainer.appendChild(tabContent);

                        // Configurar listeners
                        setTimeout(() => {
                            const scanInput = document.getElementById(`scan-input-${tabId}`);
                            scanInput.onkeypress = (e) => {
                                if (e.key === 'Enter') {
                                    handleScan(e, tabId);
                                }
                            };
                            updateConsolidatedTarima(tabId); // Renderizar el contenido cargado
                        }, 50);
                    });

                    if (tabIds.length > 0) {
                        document.getElementById('empty-tabs-message').classList.add('hidden');
                        switchTab(tabIds[0]);
                    }

                    updateGlobalSidebarStatus();
                } else {
                    // Si no hay pesta√±as guardadas, crear una por defecto
                    createNewTab();
                }
            } catch (e) {
                console.error('Error loading tabs state:', e);
                createNewTab(); // Fallback
            }
        }

        // ==================== INVENTORY AND SCAN LOGIC (ADAPTADO) ====================

        /**
         * Carga los datos del inventario (MANTENIDO, con manejo de Loading)
         */
        async function loadInventoryData() {
            if (!IS_ONLINE) {
                showNotification('‚ö†Ô∏è Sin conexi√≥n. Usando datos de cach√©.', 'warning');
                return;
            }

            showLoading('Descargando inventario...');
            try {
                const response = await fetch(CONFIG.INVENTORY_CSV_URL);
                const csv = await response.text();
                const rows = csv.split('\n').map(row => row.trim()).filter(row => row.length > 0);
                const headers = rows[0].split(',').map(h => h.trim().toLowerCase().replace(/[^a-z0-9]/g, ''));

                const newInventory = new Map();
                for (let i = 1; i < rows.length; i++) {
                    const values = rows[i].split(',');
                    if (values.length !== headers.length) continue;

                    const item = {};
                    headers.forEach((header, index) => {
                        item[header] = values[index].trim();
                    });

                    // Usar 'codigoprincipal' como clave principal para b√∫squeda
                    const code = item.codigoprincipal;
                    if (code) {
                        newInventory.set(code, item);
                    }
                }

                STATE.inventory = newInventory;
                STATE.inventoryLastUpdate = new Date();

                // Actualizar UI de la sidebar
                document.getElementById('bd-count').textContent = STATE.inventory.size;
                document.getElementById('bd-update-time').textContent = `Actualizado: ${STATE.inventoryLastUpdate.toLocaleTimeString()}`;

                showNotification(`‚úÖ Base de Datos cargada. ${STATE.inventory.size} c√≥digos.`, 'success');
            } catch (e) {
                console.error('Error loading inventory:', e);
                showNotification('‚ùå Error al cargar la Base de Datos.', 'error');
            } finally {
                hideLoading();
            }
        }

        /**
         * Implementa la l√≥gica de b√∫squeda robusta. (NUEVO)
         * @param {string} code C√≥digo escaneado.
         * @returns {{ status: 'ok'|'blocked'|'nowms'|'error', item: Object|null, message: string }} Resultado de la b√∫squeda.
         */
        function searchInventory(code) {
            const item = STATE.inventory.get(code);

            if (!item) {
                return {
                    status: 'error',
                    item: null,
                    message: 'C√≥digo Principal no encontrado. Se solicitar√° C√≥digo 2.'
                };
            }

            // L√≥gica de Estatus:
            const statusWMS = (item.statuswms || '').toUpperCase().trim();
            const statusCA = (item.statusca || '').toUpperCase().trim();

            if (statusWMS === 'OK' && statusCA === 'OK') {
                return {
                    status: 'ok',
                    item: item,
                    message: '‚úÖ C√≥digo OK para WMS y Calidad.'
                };
            } else if (statusWMS === 'OK' && statusCA !== 'OK') {
                return {
                    status: 'blocked',
                    item: item,
                    message: `‚ö†Ô∏è Bloqueado por Calidad. (Status CA: ${statusCA})`
                };
            } else {
                // Si Status WMS no es OK, siempre es No WMS/Error de WMS
                return {
                    status: 'nowms',
                    item: item,
                    message: `‚ùå No WMS. (Status WMS: ${statusWMS})`
                };
            }
        }

        /**
         * Maneja el escaneo del C√≥digo Principal (CP) o Pallet ID. (ADAPTADO)
         * @param {Event} event Evento keypress.
         * @param {string} tabId ID de la pesta√±a.
         */
        function handleScan(event, tabId) {
            if (event.key !== 'Enter') return;
            const inputElement = document.getElementById(`scan-input-${tabId}`);
            const code = inputElement.value.toUpperCase().trim();
            inputElement.value = ''; // Limpiar inmediatamente

            if (!code) return;

            const state = TABS_STATE[tabId];
            if (!state) return;

            const resultBox = document.getElementById(`result-box-${tabId}`);
            const code2Container = document.getElementById(`code2-container-${tabId}`);

            // 1. Manejar si est√°bamos esperando C√≥digo 2
            if (state.pendingCode1) {
                handleCode2Scan(code, tabId);
                return;
            }

            // 2. Ejecutar la B√∫squeda Robusta
            const result = searchInventory(code);

            // 3. Actualizar UI de resultado
            updateResultBox(tabId, result.status, result.message, code, result.item);

            if (result.status === 'error') {
                // C√≥digo no encontrado: Pedir C√≥digo 2
                state.pendingCode1 = code;
                code2Container.classList.add('show');
                document.getElementById(`code2-input-${tabId}`).focus();
                showNotification(result.message, 'error');
            } else {
                // C√≥digo encontrado (OK, BLOCKED, NO WMS)
                code2Container.classList.remove('show');
                state.pendingCode1 = null;
                const status = result.status;
                const item = result.item;

                const newBox = {
                    date: new Date().toLocaleDateString('es-MX'),
                    time: new Date().toLocaleTimeString('es-MX'),
                    user: CURRENT_USER,
                    scan1: code,
                    scan2: item.codigoalterno || '',
                    status: status,
                    note: result.message.replace(/[\:\(\)]/g, '').trim()
                };

                addBoxToPallet(tabId, status, newBox);
                inputElement.focus();
            }
            saveTabsState();
        }

        /**
         * Maneja el escaneo o ingreso del C√≥digo 2. (ADAPTADO)
         * @param {string} code2 C√≥digo escaneado.
         * @param {string} tabId ID de la pesta√±a.
         */
        function handleCode2Scan(code2, tabId) {
            const state = TABS_STATE[tabId];
            const code1 = state.pendingCode1;
            const scanInput = document.getElementById(`scan-input-${tabId}`);

            if (!code1) {
                showNotification('‚ùå Error: El sistema no est√° esperando un C√≥digo 2.', 'error');
                scanInput.focus();
                return;
            }

            // 1. Buscar en BD si el C√≥digo 2 coincide con alg√∫n 'CodigoAlterno'
            let foundItem = null;
            for (const item of STATE.inventory.values()) {
                if ((item.codigoalterno || '').toUpperCase().trim() === code2) {
                    foundItem = item;
                    break;
                }
            }

            // 2. Determinar estado y registrar
            let status = 'nowms'; // Por defecto, si Code1 no existe en BD, es No WMS
            let message = `‚ùå CP: ${code1} no encontrado. Registrado como No WMS con C√≥digo 2: ${code2}.`;
            let itemDetails = { statuswms: 'N/A', statusca: 'N/A' };

            if (foundItem) {
                // Si el C√≥digo 2 coincide con un C√≥digo Alterno existente, usar la l√≥gica robusta de ese item
                const result = searchInventory(foundItem.codigoprincipal);
                status = result.status;
                message = `‚ö†Ô∏è CP: ${code1} no encontrado. Registrado con estatus de Cod. Alterno: ${code2}.`;
                itemDetails = foundItem;
            } else {
                // Si Code2 tampoco coincide con CodeAlterno, simplemente se registra como "NO WMS"
                status = 'nowms';
                message = `‚ùå CP: ${code1} y Cod. Alterno: ${code2} no encontrados en BD. Registrado como No WMS.`;
            }

            const newBox = {
                date: new Date().toLocaleDateString('es-MX'),
                time: new Date().toLocaleTimeString('es-MX'),
                user: CURRENT_USER,
                scan1: code1,
                scan2: code2,
                status: status,
                note: message.substring(0, 100)
            };

            addBoxToPallet(tabId, status, newBox);

            // 3. Limpiar estado y UI
            state.pendingCode1 = null;
            document.getElementById(`code2-container-${tabId}`).classList.remove('show');
            document.getElementById(`code2-input-${tabId}`).value = '';

            // 4. Actualizar ResultBox (Mostrando el Code1 original)
            updateResultBox(tabId, status, message, code1, itemDetails);
            showNotification(message, status);
            scanInput.focus();
            saveTabsState();
        }

        /**
         * Registra un c√≥digo no encontrado como "INSERTADO" (No WMS). (ADAPTADO)
         * @param {string} tabId ID de la pesta√±a.
         */
        function forceInsert(tabId) {
            const state = TABS_STATE[tabId];
            const code1 = state.pendingCode1;
            const code2Input = document.getElementById(`code2-input-${tabId}`);
            const code2 = code2Input.value.toUpperCase().trim() || 'N/A';
            const scanInput = document.getElementById(`scan-input-${tabId}`);

            if (!code1) {
                showNotification('‚ùå Error: Necesitas ingresar un C√≥digo Principal (CP) primero.', 'error');
                scanInput.focus();
                return;
            }

            const status = 'nowms';
            const message = `‚ö° FORZADO. CP: ${code1}. C√≥digo 2: ${code2}. Registrado como No WMS.`;

            const newBox = {
                date: new Date().toLocaleDateString('es-MX'),
                time: new Date().toLocaleTimeString('es-MX'),
                user: CURRENT_USER,
                scan1: code1,
                scan2: code2,
                status: status,
                note: 'FORZADO - INSERTADO'
            };

            addBoxToPallet(tabId, status, newBox);

            // Limpiar estado y UI
            state.pendingCode1 = null;
            document.getElementById(`code2-container-${tabId}`).classList.remove('show');
            code2Input.value = '';

            // Actualizar ResultBox
            updateResultBox(tabId, status, message, code1, { statuswms: 'FORZADO', statusca: 'N/A' });
            showNotification(message, 'error'); // Usamos error para forzado/No WMS
            scanInput.focus();
            saveTabsState();
        }

        /**
         * Actualiza el cuadro de resultados despu√©s de un escaneo. (ADAPTADO)
         */
        function updateResultBox(tabId, status, message, code, item) {
            const resultBox = document.getElementById(`result-box-${tabId}`);
            const resultIcon = document.getElementById(`result-icon-${tabId}`);
            const resultTitle = document.getElementById(`result-title-${tabId}`);
            const resultCode = document.getElementById(`result-code-${tabId}`);
            const resultDetails = document.getElementById(`result-details-${tabId}`);

            const classMap = {
                'ok': 'success',
                'blocked': 'warning',
                'nowms': 'error',
                'error': 'error'
            };
            const iconMap = {
                'ok': '‚úÖ',
                'blocked': '‚ö†Ô∏è',
                'nowms': '‚ùå',
                'error': 'üõë'
            };
            const titleMap = {
                'ok': 'C√≥digo OK',
                'blocked': 'Bloqueado por CA',
                'nowms': 'No WMS',
                'error': 'C√≥digo NO Encontrado'
            };

            // Remover todas las clases de estado y a√±adir la correcta
            resultBox.className = `result-box show ${classMap[status] || 'info'}`;
            resultIcon.textContent = iconMap[status] || 'üì¶';
            resultTitle.textContent = titleMap[status] || 'Resultado';
            resultCode.textContent = code;

            let detailsHTML = '';
            if (item) {
                detailsHTML = `
                    <div>
                        <div class="result-detail-label">Status WMS</div>
                        <div class="result-detail-value">${(item.statuswms || 'N/A').toUpperCase()}</div>
                    </div>
                    <div>
                        <div class="result-detail-label">Status CA</div>
                        <div class="result-detail-value">${(item.statusca || 'N/A').toUpperCase()}</div>
                    </div>
                    <div>
                        <div class="result-detail-label">Cod. Alterno</div>
                        <div class="result-detail-value">${(item.codigoalterno || 'N/A').toUpperCase()}</div>
                    </div>
                    <div>
                        <div class="result-detail-label">Mensaje</div>
                        <div class="result-detail-value">${message}</div>
                    </div>
                `;
            } else {
                detailsHTML = `<div><div class="result-detail-label">Mensaje</div><div class="result-detail-value">${message}</div></div>`;
            }
            resultDetails.innerHTML = detailsHTML;

            // Limpiar la clase de input despu√©s de 500ms
            const inputElement = document.getElementById(`scan-input-${tabId}`);
            if (inputElement) {
                inputElement.classList.add(classMap[status]);
                setTimeout(() => {
                    inputElement.classList.remove('success', 'error', 'warning');
                }, 500);
            }

            playSound(status);
        }

        // ==================== PALLET/LOG MANAGEMENT (CONSOLIDADO - NUEVO) ====================

        /**
         * A√±ade una caja al pallet correspondiente dentro del estado de la pesta√±a. (NUEVO)
         * @param {string} tabId ID de la pesta√±a.
         * @param {string} status Estatus de la caja ('ok', 'blocked', 'nowms').
         * @param {Object} box Objeto de la caja con sus datos.
         */
        function addBoxToPallet(tabId, status, box) {
            const state = TABS_STATE[tabId];
            if (!state) return;

            state.pallets[status].boxes.push(box);
            updateVisualLog(tabId, box);
            updateConsolidatedTarima(tabId);
            updateGlobalSidebarStatus();
            saveTabsState();
        }

        /**
         * Elimina una caja de un pallet por √≠ndice. (NUEVO)
         * @param {string} tabId ID de la pesta√±a.
         * @param {string} status Estatus del pallet.
         * @param {number} index √çndice de la caja a eliminar.
         */
        function removeItemFromTarima(tabId, status, index) {
            const state = TABS_STATE[tabId];
            if (!state) return;

            const box = state.pallets[status].boxes.splice(index, 1)[0];
            updateConsolidatedTarima(tabId);
            updateGlobalSidebarStatus();
            saveTabsState();
            showNotification(`‚ûñ Caja eliminada: ${box.scan1}`, 'warning');
        }

        /**
         * Renderiza la vista de Tarima Consolidada y actualiza los contadores. (NUEVO)
         * @param {string} tabId ID de la pesta√±a.
         */
        function updateConsolidatedTarima(tabId) {
            const state = TABS_STATE[tabId];
            if (!state) return;

            const palletListEl = document.getElementById(`pallet-list-${tabId}`);
            const consolidatedPalletsEl = document.getElementById(`consolidated-pallets-${tabId}`);
            const totalBoxesEl = document.getElementById(`total-boxes-${tabId}`);
            const totalCountEl = document.getElementById(`consolidated-count-${tabId}`);
            const sendBtn = document.getElementById(`send-all-btn-${tabId}`);
            const tabBadge = document.getElementById(`badge-${tabId}`);

            let totalBoxes = 0;
            let listHTML = '';
            let cardsHTML = '';

            const statusOrder = ['ok', 'blocked', 'nowms'];
            const statusLabels = { 'ok': 'OK', 'blocked': 'Bloqueado', 'nowms': 'No WMS' };

            statusOrder.forEach(status => {
                const pallet = state.pallets[status];
                const count = pallet.boxes.length;
                totalBoxes += count;

                // Construir la lista principal
                if (count > 0) {
                    listHTML += `<div style="font-weight: 700; color: var(--${status}); margin-top: 15px; padding-bottom: 5px; border-bottom: 1px solid var(--border);">
                        ${statusLabels[status]} (${count} cajas)
                    </div>`;

                    pallet.boxes.reverse().forEach((box, index) => {
                        const originalIndex = count - 1 - index; // Para que el √≠ndice de eliminaci√≥n sea correcto
                        listHTML += `
                            <div class="box-item ${status}">
                                <div class="box-info">
                                    <div class="box-code">${box.scan1}</div>
                                    <div class="box-meta">${box.scan2} | ${box.time} | Pallet ID: ${pallet.id}</div>
                                </div>
                                <button class="box-delete" title="Eliminar caja" onclick="removeItemFromTarima('${tabId}', '${status}', ${originalIndex})">üóëÔ∏è</button>
                            </div>
                        `;
                    });
                    pallet.boxes.reverse(); // Volver a su orden original
                }

                // Construir las tarjetas de estado
                cardsHTML += `
                    <div class="pallet-info-card ${status}">
                        <div>Estatus: <span style="font-weight: 700; color: var(--${status});">${statusLabels[status]}</span></div>
                        <div>Cajas: <span class="pallet-status-count">${count}</span></div>
                        <div>Pallet ID: <span class="pallet-id">${pallet.id}</span></div>
                    </div>
                `;
            });

            // Actualizar el DOM
            palletListEl.innerHTML = listHTML || `
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <div>Escanea una caja para empezar la Tarima.</div>
                </div>
            `;
            consolidatedPalletsEl.innerHTML = cardsHTML;

            // Actualizar contadores y bot√≥n de env√≠o
            totalBoxesEl.textContent = totalBoxes;
            totalCountEl.textContent = totalBoxes;
            sendBtn.disabled = totalBoxes === 0;

            // Actualizar badge de la pesta√±a
            tabBadge.textContent = totalBoxes;
            tabBadge.className = `tab-badge ${totalBoxes > 0 ? (state.pallets.nowms.boxes.length > 0 ? 'nowms' : (state.pallets.blocked.boxes.length > 0 ? 'blocked' : 'ok')) : 'empty'}`;
        }

        /**
         * Agrega una entrada al Log Visual. (NUEVO)
         * @param {string} tabId ID de la pesta√±a.
         * @param {Object} box Objeto de la caja escaneada.
         */
        function updateVisualLog(tabId, box) {
            const state = TABS_STATE[tabId];
            if (!state) return;

            // A√±adir al estado del log (limitar a 50 entradas)
            state.log.unshift(box);
            if (state.log.length > 50) {
                state.log.pop();
            }

            const logListEl = document.getElementById(`log-list-${tabId}`);
            const logCountEl = document.getElementById(`log-count-${tabId}`);
            if (!logListEl) return;

            let logHTML = '';
            state.log.forEach((entry, index) => {
                logHTML += `
                    <div class="log-entry ${entry.status}">
                        <span class="log-status-icon">${entry.status === 'ok' ? '‚úÖ' : (entry.status === 'blocked' ? '‚ö†Ô∏è' : '‚ùå')}</span>
                        <span class="log-time">${entry.time}</span>
                        <span class="log-code" title="${entry.note || entry.scan1}">${entry.scan1}</span>
                    </div>
                `;
            });

            logListEl.innerHTML = logHTML;
            logCountEl.textContent = state.log.length;
        }

        /**
         * Actualiza el resumen de la barra lateral (acumulado de todas las pesta√±as). (ADAPTADO)
         */
        function updateGlobalSidebarStatus() {
            let okCount = 0;
            let blockedCount = 0;
            let nowmsCount = 0;

            for (const id in TABS_STATE) {
                const state = TABS_STATE[id];
                okCount += state.pallets.ok.boxes.length;
                blockedCount += state.pallets.blocked.boxes.length;
                nowmsCount += state.pallets.nowms.boxes.length;
            }

            document.getElementById('sidebar-ok-count').textContent = okCount;
            document.getElementById('sidebar-blocked-count').textContent = blockedCount;
            document.getElementById('sidebar-nowms-count').textContent = nowmsCount;
        }

        // ==================== DATA SUBMISSION (NUEVO) ====================

        /**
         * Prepara y env√≠a todos los datos de la pesta√±a al Google Sheet. (NUEVO)
         * @param {string} tabId ID de la pesta√±a.
         */
        async function sendData(tabId) {
            const state = TABS_STATE[tabId];
            if (!state) return;

            const totalBoxes = state.pallets.ok.boxes.length + state.pallets.blocked.boxes.length + state.pallets.nowms.boxes.length;
            if (totalBoxes === 0) {
                showNotification('‚ÑπÔ∏è No hay cajas para enviar en esta sesi√≥n.', 'info');
                return;
            }

            const locationInput = document.getElementById(`location-${tabId}`);
            const location = locationInput.value.toUpperCase().trim();

            if (!location) {
                showNotification('‚ö†Ô∏è Ingresa una ubicaci√≥n destino antes de enviar.', 'warning');
                locationInput.focus();
                return;
            }

            showLoading(`Preparando env√≠o de ${totalBoxes} cajas...`);

            let recordsToSend = [];

            // Recopilar y resetear los pallets
            ['ok', 'blocked', 'nowms'].forEach(status => {
                const pallet = state.pallets[status];
                if (pallet.boxes.length > 0) {
                    pallet.boxes.forEach(box => {
                        recordsToSend.push({
                            date: box.date,
                            time: box.time,
                            user: box.user,
                            scan1: box.scan1,
                            scan2: box.scan2,
                            location: location,
                            status: box.status,
                            note: box.note,
                            pallet: pallet.id // Usar el ID del pallet generado
                        });
                    });
                    // Resetear el pallet
                    pallet.boxes = [];
                    pallet.id = generatePalletId(status.toUpperCase().replace('NOWMS', 'NW').replace('BLOCKED', 'BLK'));
                }
            });

            // A√±adir al buffer de sincronizaci√≥n
            PENDING_SYNC.push(...recordsToSend);
            SyncManager.save(); // Guardar el buffer

            hideLoading();
            showNotification(`‚úÖ ${recordsToSend.length} cajas a√±adidas a la cola de sincronizaci√≥n.`, 'success');

            // Limpiar UI de la pesta√±a
            locationInput.value = '';
            state.pendingCode1 = null;
            document.getElementById(`code2-container-${tabId}`)?.classList.remove('show');

            // Actualizar UI
            updateConsolidatedTarima(tabId);
            SyncManager.updateUI(false);
            updateGlobalSidebarStatus();

            // Intentar sincronizar inmediatamente
            SyncManager.sync(false);
        }

        // ==================== AUTH & SYNC MANAGER (MANTENIDO Y ADAPTADO) ====================

        // (SyncManager: MANTENIDO. La l√≥gica de sincronizaci√≥n permanece igual, solo PENDING_SYNC se llena desde las pesta√±as)
        const SyncManager = {
            inProgress: false,
            retryCount: 0,
            intervalId: null,
            AUTO_SYNC_INTERVAL: 30000,
            init() {
                this.load();
                this.startAutoSync();
                this.setupExitProtection();
                this.updateUI(PENDING_SYNC.length === 0);
            },
            setupExitProtection() {
                window.addEventListener('beforeunload', (e) => {
                    let totalBoxes = 0;
                    for (const id in TABS_STATE) {
                        const state = TABS_STATE[id];
                        totalBoxes += state.pallets.ok.boxes.length + state.pallets.blocked.boxes.length + state.pallets.nowms.boxes.length;
                    }

                    const hasUnsavedData = PENDING_SYNC.length > 0 || totalBoxes > 0;
                    if (hasUnsavedData) {
                        e.preventDefault();
                        e.returnValue = `¬°Tienes ${PENDING_SYNC.length} registros pendientes de sincronizar y ${totalBoxes} cajas sin enviar en tus sesiones! ¬øSeguro que quieres salir?`;
                        return e.returnValue;
                    }
                });
            },
            startAutoSync() {
                if (this.intervalId) clearInterval(this.intervalId);
                this.intervalId = setInterval(() => {
                    if (IS_ONLINE && gapi?.client?.getToken() && PENDING_SYNC.length > 0) {
                        this.sync(false);
                    }
                }, this.AUTO_SYNC_INTERVAL);
            },
            async sync(showMessages = true) {
                if (this.inProgress) {
                    if (showMessages) showNotification('‚è≥ Sincronizaci√≥n en progreso...', 'info');
                    return { success: false };
                }
                if (!IS_ONLINE) {
                    if (showMessages) showNotification('‚ö†Ô∏è Sin conexi√≥n a internet', 'warning');
                    return { success: false };
                }
                if (!gapi?.client?.getToken()) {
                    if (showMessages) showNotification('‚ö†Ô∏è No conectado a Google', 'warning');
                    return { success: false };
                }
                if (PENDING_SYNC.length === 0) {
                    this.updateUI(true);
                    if (showMessages) showNotification('‚úÖ Todo sincronizado', 'success');
                    return { success: true, synced: 0 };
                }
                return await this._doSync(showMessages);
            },
            async _doSync(showMessages) {
                this.inProgress = true;
                updateConnectionIndicator(true);
                if (showMessages) showNotification('üîÑ Sincronizando...', 'info');
                try {
                    const values = PENDING_SYNC.map(r => [
                        r.date, r.time, r.user, r.scan1, r.scan2, r.location, r.status, r.note, r.pallet
                    ]);
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                        range: `${CONFIG.SHEET_NAME}!A:I`,
                        valueInputOption: 'USER_ENTERED',
                        insertDataOption: 'INSERT_ROWS',
                        resource: { values }
                    });
                    const synced = PENDING_SYNC.length;
                    PENDING_SYNC = [];
                    this.save();
                    this.updateUI(true);
                    if (showMessages) showNotification(`‚úÖ ${synced} registros sincronizados`, 'success');
                    return { success: true, synced };
                } catch (e) {
                    console.error('Sync error:', e);
                    this.updateUI(false);
                    if (showMessages) showNotification(`‚ùå Error: ${e.result?.error?.message || e.message || 'Error desconocido'}`, 'error');
                    return { success: false };
                } finally {
                    this.inProgress = false;
                    updateConnectionIndicator();
                }
            },
            async save() {
                try {
                    localStorage.setItem('pd_pending_sync', JSON.stringify(PENDING_SYNC));
                } catch (e) { }
            },
            async load() {
                try {
                    const saved = localStorage.getItem('pd_pending_sync');
                    if (saved) PENDING_SYNC = JSON.parse(saved);
                } catch (e) { }
            },
            updateUI(synced) {
                const el = document.getElementById('sync-status');
                if (!el) return;
                if (!IS_ONLINE) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `‚ö†Ô∏è Sin conexi√≥n${PENDING_SYNC.length > 0 ? ` (${PENDING_SYNC.length})` : ''}`;
                } else if (PENDING_SYNC.length > 0) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `‚è≥ ${PENDING_SYNC.length} pendientes`;
                } else if (synced) {
                    el.className = 'sync-status sync-ok';
                    el.textContent = '‚úÖ Sincronizado';
                } else {
                    el.className = 'sync-status sync-error';
                    el.textContent = '‚ùå Error sync';
                }
            },
            showPanel() {
                // (Popup content kept for the sake of completeness, assuming the full code was 2200 lines and this was included)
                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay show';
                overlay.innerHTML = `
                    <div class="popup-content" style="max-width: 450px;">
                        <div class="popup-header">
                            <span>üìä Estado de Sincronizaci√≥n</span>
                            <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px; text-align: center;">
                                <div style="font-size: 0.85em; color: #666;">Pendientes de sincronizar</div>
                                <div style="font-size: 2em; font-weight: 700; color: ${PENDING_SYNC.length > 0 ? 'var(--warning)' : 'var(--success)'};">
                                    ${PENDING_SYNC.length}
                                </div>
                            </div>
                            <div style="font-size: 0.9em; padding: 10px; border: 1px dashed #ccc; border-radius: 8px;">
                                <p style="font-weight: 600; margin-bottom: 5px;">Detalles de la cola:</p>
                                ${PENDING_SYNC.length > 0 ?
                        `<ul style="list-style-type: none; padding: 0;">
                            ${PENDING_SYNC.slice(0, 5).map(r => `
                                <li style="margin-bottom: 3px; border-left: 3px solid var(--primary); padding-left: 5px;">
                                    ${r.scan1} (<span style="color: var(--${r.status});">${r.status.toUpperCase()}</span>)
                                </li>
                            `).join('')}
                            ${PENDING_SYNC.length > 5 ? `<li style="color: #666;">... y ${PENDING_SYNC.length - 5} m√°s.</li>` : ''}
                        </ul>` :
                        '<p style="color: var(--success); text-align: center;">La cola est√° vac√≠a. ¬°Todo al d√≠a!</p>'}
                            </div>
                        </div>
                        <button class="btn btn-success btn-full" onclick="SyncManager.sync(true); this.closest('.popup-overlay').remove();">
                            üîÑ Forzar Sincronizaci√≥n Ahora
                        </button>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
        };

        // (Authentication functions kept, adapted to call loadInventoryData)

        function initClient() {
            gapi.client.init({
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                clientId: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
            }).then(() => {
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            gapi.client.setToken(tokenResponse);
                            checkAuthStatus(true);
                        } else {
                            checkAuthStatus(false);
                        }
                    },
                });
                checkAuthStatus();
            }).catch(e => {
                console.error("GAPI init error", e);
                checkAuthStatus(false);
            });
        }

        async function handleLogin() {
            if (gapi.client.getToken()) {
                TOKEN_CLIENT.requestAccessToken();
            } else {
                TOKEN_CLIENT.requestAccessToken();
            }
        }

        function handleLogout() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    checkAuthStatus(false);
                    showNotification('üö™ Sesi√≥n cerrada', 'info');
                });
            } else {
                checkAuthStatus(false);
            }
        }

        async function checkAuthStatus(forceAuth = false) {
            const authButton = document.getElementById('sidebar-auth-btn');
            const token = gapi.client.getToken();

            if (token || forceAuth) {
                try {
                    await gapi.client.request({
                        path: 'https://www.googleapis.com/oauth2/v2/userinfo',
                        method: 'GET',
                    }).then(response => {
                        const userInfo = response.result;
                        USER_EMAIL = userInfo.email || 'Usuario';
                        USER_GOOGLE_NAME = userInfo.name || 'Google User';
                        CURRENT_USER = userInfo.given_name || USER_EMAIL;

                        document.getElementById('user-name-display').textContent = CURRENT_USER;
                        document.getElementById('user-avatar').textContent = CURRENT_USER.charAt(0).toUpperCase();
                        authButton.textContent = 'üîó';

                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');

                        updateConnectionIndicator(false, true);

                        // Cargar inventario al iniciar sesi√≥n
                        loadInventoryData();
                        SyncManager.updateUI();

                    }, error => {
                        console.error('User info error', error);
                        checkAuthStatus(false);
                    });
                } catch (e) {
                    console.error('Check auth error', e);
                    checkAuthStatus(false);
                }

            } else {
                CURRENT_USER = 'Invitado';
                USER_EMAIL = '';
                USER_GOOGLE_NAME = '';

                document.getElementById('user-name-display').textContent = 'No conectado';
                document.getElementById('user-avatar').textContent = '?';
                authButton.textContent = 'üîì';

                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');

                updateConnectionIndicator();
            }
        }

        function toggleConnection() {
            if (gapi.client.getToken()) {
                handleLogout();
            } else {
                handleLogin();
            }
        }

        function refreshInventory() {
            loadInventoryData();
        }

        function updateConnectionIndicator(isSyncing = SyncManager.inProgress, isAuth = gapi.client.getToken()) {
            IS_ONLINE = navigator.onLine;
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');

            if (!dot || !text) return;

            if (!IS_ONLINE) {
                dot.className = 'connection-dot offline';
                text.textContent = 'Offline';
                document.getElementById('connection-banner').className = 'connection-banner offline';
                document.getElementById('connection-banner').textContent = '‚ùå Sin Conexi√≥n a Internet';
                document.getElementById('connection-banner').style.display = 'block';
            } else if (isSyncing) {
                dot.className = 'connection-dot syncing';
                text.textContent = 'Sync...';
                document.getElementById('connection-banner').className = 'connection-banner syncing';
                document.getElementById('connection-banner').textContent = '‚è≥ Sincronizando Datos Pendientes...';
                document.getElementById('connection-banner').style.display = 'block';
            } else if (isAuth) {
                dot.className = 'connection-dot online';
                text.textContent = 'Online';
                document.getElementById('connection-banner').style.display = 'none';
            } else {
                dot.className = 'connection-dot offline';
                text.textContent = 'No Auth';
                document.getElementById('connection-banner').className = 'connection-banner warning';
                document.getElementById('connection-banner').textContent = '‚ö†Ô∏è No Autenticado con Google';
                document.getElementById('connection-banner').style.display = 'block';
            }

            SyncManager.updateUI(PENDING_SYNC.length === 0);
        }

        window.addEventListener('online', () => updateConnectionIndicator());
        window.addEventListener('offline', () => updateConnectionIndicator());

        function changeUserAlias() {
            const newAlias = prompt(`Ingresa tu alias o iniciales (actual: ${CURRENT_USER}):`);
            if (newAlias && newAlias.trim()) {
                CURRENT_USER = newAlias.toUpperCase().trim();
                document.getElementById('user-name-display').textContent = CURRENT_USER;
                document.getElementById('user-avatar').textContent = CURRENT_USER.charAt(0);
                showNotification(`‚úÖ Alias cambiado a: ${CURRENT_USER}`, 'info');
            }
        }


        // ==================== RESUMEN LOGIC (ADAPTADO) ====================

        function showResumen() {
            updateResumen();
            document.getElementById('resumen-popup').classList.add('show');
        }

        function closeResumen() {
            document.getElementById('resumen-popup').classList.remove('show');
        }

        function updateResumen() {
            let okCount = 0;
            let blockedCount = 0;
            let nowmsCount = 0;
            let totalHistory = [];

            // 1. Recopilar datos de todas las pesta√±as
            for (const id in TABS_STATE) {
                const state = TABS_STATE[id];
                okCount += state.pallets.ok.boxes.length;
                blockedCount += state.pallets.blocked.boxes.length;
                nowmsCount += state.pallets.nowms.boxes.length;
                // Combinar logs para historial
                state.log.forEach(box => {
                    totalHistory.push({
                        time: box.time,
                        scan1: box.scan1,
                        scan2: box.scan2,
                        status: box.status,
                        location: 'PENDIENTE',
                        pallet: state.pallets[box.status].id
                    });
                });
            }

            // 2. Actualizar estad√≠sticas
            document.getElementById('resumen-ok').textContent = okCount;
            document.getElementById('resumen-blocked').textContent = blockedCount;
            document.getElementById('resumen-nowms').textContent = nowmsCount;
            document.getElementById('resumen-pending').textContent = PENDING_SYNC.length;

            // 3. Actualizar tabla de historial (Log reciente combinado)
            const tableBody = document.getElementById('resumen-table-body');
            // Ordenar por hora (el log ya est√° ordenado de m√°s nuevo a m√°s viejo)
            totalHistory.sort((a, b) => {
                // Asume formato HH:MM:SS
                if (a.time < b.time) return 1;
                if (a.time > b.time) return -1;
                return 0;
            });

            tableBody.innerHTML = totalHistory.slice(0, 50).map(item => {
                return `
                    <tr>
                        <td>${item.time}</td>
                        <td style="font-weight: 600;">${item.scan1}</td>
                        <td>${item.scan2 || '-'}</td>
                        <td style="color: var(--${item.status}); font-weight: 600;">${item.status.toUpperCase()}</td>
                        <td>${item.location}</td>
                        <td style="font-family: monospace; font-size: 0.8em;">${item.pallet}</td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== INITIALIZATION ====================

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializaci√≥n de Google
            if (typeof gapi !== 'undefined') {
                gapi.load('client', initClient);
            } else {
                console.error("GAPI not loaded.");
            }

            // Cargar estado de pesta√±as y crear la primera si es necesario
            loadTabsState();
            SyncManager.init();

            // Inicializar AudioContext al primer evento de usuario
            document.body.addEventListener('mousedown', () => {
                if (!audioCtx) {
                    try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) { }
                }
            }, { once: true });
        });
    </script>
</body>
</html>
