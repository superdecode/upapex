<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inventario</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --blocked: #f97316;
            --bg: #f7f7f7;
            --text: #333;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 0.9em;
            color: #666;
        }

        /* Connection Banner */
        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s;
        }

        .connection-banner.offline {
            background: var(--error);
            color: white;
            display: block;
        }

        .connection-banner.online {
            background: var(--success);
            color: white;
            display: block;
        }

        .connection-banner.syncing {
            background: var(--warning);
            color: white;
            display: block;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ==================== LOGIN SCREEN ==================== */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        /* ==================== MAIN LAYOUT ==================== */
        .main-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #555;
        }

        .sidebar-header h2 {
            color: var(--primary);
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.8em;
            color: #aaa;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }

        .sidebar-section-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .sidebar-btn:hover {
            transform: translateX(3px);
        }

        .sidebar-btn-primary { background: var(--primary); color: white; }
        .sidebar-btn-secondary { background: #555; color: white; }
        .sidebar-btn-orange { background: var(--blocked); color: white; }

        /* Sync Status */
        .sync-status {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            cursor: pointer;
        }
        .sync-ok { background: rgba(76, 175, 80, 0.2); color: var(--success); border: 1px solid var(--success); }
        .sync-error { background: rgba(244, 67, 54, 0.2); color: var(--error); border: 1px solid var(--error); }
        .sync-warning { background: rgba(255, 152, 0, 0.2); color: var(--warning); border: 1px solid var(--warning); }

        /* Pallets por estatus */
        .pallet-status-list {
            flex: 1;
            overflow-y: auto;
        }

        .pallet-status-item {
            background: #444;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .pallet-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .pallet-status-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .pallet-status-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .pallet-code {
            font-family: monospace;
            font-size: 0.7em;
            color: #aaa;
            word-break: break-all;
        }

        /* User Footer */
        .user-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            color: white;
            flex-shrink: 0;
            cursor: pointer;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .connection-indicator {
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }
        .connection-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-footer-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .user-footer-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.75em;
        }

        .bd-info {
            font-size: 0.7em;
            color: #aaa;
            text-align: center;
            line-height: 1.4;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.4em;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        /* Tabs System */
        .tabs-container {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 5px;
        }

        .tab {
            padding: 8px 15px;
            background: white;
            border: 2px solid #ddd;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #f5f5f5;
        }

        .tab.active {
            background: var(--blocked);
            color: white;
            border-color: var(--blocked);
        }

        .tab-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin-left: 5px;
            opacity: 0.7;
        }

        .tab-close:hover {
            opacity: 1;
        }

        .tab-new {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .tab-new:hover {
            background: #45a049;
        }

        /* Empty State */
        .tabs-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .tabs-empty-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .tabs-empty-text {
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        /* Scan Section */
        .scan-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scan-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .scan-input-group {
            flex: 1;
        }

        .scan-input-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .scan-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.3em;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
            transition: all 0.2s;
        }

        .scan-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .scan-input.error {
            border-color: var(--error);
            background: #ffebee;
        }

        .scan-input.success {
            border-color: var(--success);
            background: #e8f5e9;
        }

        /* Result Box */
        .result-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-box.show { display: block; }
        .result-box.success { background: #e8f5e9; border: 2px solid var(--success); }
        .result-box.warning { background: #fff3e0; border: 2px solid var(--warning); }
        .result-box.blocked { background: #fff3e0; border: 2px solid var(--blocked); }
        .result-box.error { background: #ffebee; border: 2px solid var(--error); }

        .result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .result-icon { font-size: 1.5rem; }
        .result-title { font-weight: 700; font-size: 1.1em; }
        .result-code { font-family: monospace; font-weight: 600; }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            font-size: 0.85em;
        }

        .result-detail-label { color: #666; font-size: 0.8em; }
        .result-detail-value { font-weight: 600; }

        /* Code2 Input */
        .code2-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px dashed var(--error);
            display: none;
        }

        .code2-container.show { display: block; }

        .code2-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn-insertado {
            padding: 12px 20px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-insertado:hover {
            background: #d32f2f;
        }
        
        /* Columns Container */
        .columns-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            flex: 1;
            min-height: 0;
        }

        .column {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .column-title {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .column-count {
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
        }

        .column.ok .column-title { color: var(--success); }
        .column.ok .column-count { background: rgba(76, 175, 80, 0.15); color: var(--success); }

        .column.blocked .column-title { color: var(--blocked); }
        .column.blocked .column-count { background: rgba(249, 115, 22, 0.15); color: var(--blocked); }

        .column.nowms .column-title { color: var(--error); }
        .column.nowms .column-count { background: rgba(244, 67, 54, 0.15); color: var(--error); }

        .column-pallet-info {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.8em;
        }

        .column-pallet-code {
            font-family: monospace;
            font-weight: 600;
            color: var(--primary);
        }

        .column-location-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
            margin-top: 6px;
        }

        .column-send-btn {
            margin-top: 8px;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 0.85em;
        }

        .column-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .column.ok .column-send-btn { background: var(--success); color: white; }
        .column.blocked .column-send-btn { background: var(--blocked); color: white; }
        .column.nowms .column-send-btn { background: var(--error); color: white; }

        .column-list {
            flex: 1;
            overflow-y: auto;
            counter-reset: item-counter;
        }

        .box-item {
            padding: 8px 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid;
            counter-increment: item-counter;
        }

        .box-item::before {
            content: counter(item-counter) ".";
            font-weight: 700;
            min-width: 25px;
            margin-right: 8px;
        }

        .column.ok .box-item { border-color: var(--success); }
        .column.ok .box-item::before { color: var(--success); }

        .column.blocked .box-item { border-color: var(--blocked); }
        .column.blocked .box-item::before { color: var(--blocked); }

        .column.nowms .box-item { border-color: var(--error); }
        .column.nowms .box-item::before { color: var(--error); }

        .box-info { flex: 1; }
        .box-code { font-weight: 600; font-family: monospace; font-size: 0.9em; }
        .box-meta { font-size: 0.75em; color: #666; }

        .box-delete {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1.1em;
            padding: 4px;
            opacity: 0.6;
        }

        .box-delete:hover { opacity: 1; }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #999;
        }

        .empty-icon { font-size: 2.5em; margin-bottom: 8px; opacity: 0.5; }

        /* Captura General Module */
        .general-capture-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 12px;
        }

        .general-pallet-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .general-pallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .general-pallet-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--blocked);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .general-pallet-count {
            background: rgba(249, 115, 22, 0.15);
            color: var(--blocked);
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: 700;
        }

        .general-pallet-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .general-info-item {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .general-info-label {
            color: #666;
            font-size: 0.8em;
            margin-bottom: 3px;
        }

        .general-info-value {
            font-weight: 600;
            font-family: monospace;
            color: var(--primary);
        }

        .general-location-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .general-location-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .general-send-btn {
            padding: 10px 20px;
            background: var(--blocked);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .general-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .general-send-btn:hover:not(:disabled) {
            background: #ea580c;
        }

        .general-boxes-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .general-box-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .general-box-item.ok { border-color: var(--success); background: #e8f5e9; }
        .general-box-item.blocked { border-color: var(--blocked); background: #fff3e0; }
        .general-box-item.nowms { border-color: var(--error); background: #ffebee; }

        .general-box-main {
            flex: 1;
        }

        .general-box-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .general-box-number {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.8em;
        }

        .general-box-status {
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.75em;
        }

        .general-box-status.ok { background: var(--success); color: white; }
        .general-box-status.blocked { background: var(--blocked); color: white; }
        .general-box-status.nowms { background: var(--error); color: white; }

        .general-box-codes {
            font-family: monospace;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 3px;
        }

        .general-box-time {
            font-size: 0.75em;
            color: #666;
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-google { background: #4285F4; color: white; }

        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        .btn-full { width: 100%; }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .notification {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }

        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Popups */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-overlay.show { display: flex; }

        .popup-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .popup-header {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .popup-close:hover { color: #333; }

        .popup-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        /* Resumen Module */
        .resumen-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .resumen-stat {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f5f5f5;
        }

        .resumen-stat-number {
            font-size: 2em;
            font-weight: 700;
        }

        .resumen-stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .resumen-stat.ok { border: 2px solid var(--success); }
        .resumen-stat.ok .resumen-stat-number { color: var(--success); }

        .resumen-stat.blocked { border: 2px solid var(--blocked); }
        .resumen-stat.blocked .resumen-stat-number { color: var(--blocked); }

        .resumen-stat.nowms { border: 2px solid var(--error); }
        .resumen-stat.nowms .resumen-stat-number { color: var(--error); }

        .resumen-stat.pending { border: 2px solid var(--warning); }
        .resumen-stat.pending .resumen-stat-number { color: var(--warning); }

        .resumen-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .resumen-table th, .resumen-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .resumen-table th {
            background: #f5f5f5;
            font-weight: 700;
            position: sticky;
            top: 0;
        }

        .resumen-table-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .resumen-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 180px; }
            .columns-container { grid-template-columns: 1fr; }
            .resumen-stats { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; max-height: 200px; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">üì¶ Cargando Inventario...</div>
            <div class="loading-subtext">Descargando base de datos desde Google Sheets</div>
        </div>
    </div>

    <div class="connection-banner" id="connection-banner"></div>
    <div class="notification-container" id="notifications"></div>

    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">üì¶</div>
            <h1 class="login-title">Sistema Inventario</h1>
            <p class="login-subtitle">Control y gesti√≥n de mercanc√≠a</p>
            <button class="btn btn-google btn-full" onclick="handleLogin()" style="padding: 15px; font-size: 1.1em;">
                üîê Iniciar sesi√≥n con Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <div class="main-container">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>üì¶ Inventario</h2>
                    <p>Sistema de gesti√≥n</p>
                </div>

                <!-- Sync Status -->
                <div id="sync-status" class="sync-status sync-ok" onclick="SyncManager.showPanel()">
                    ‚úÖ Sincronizado
                </div>

                <!-- Menu -->
                <div class="sidebar-section">
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showResumen()">
                        üìä Resumen
                    </button>
                    <button class="sidebar-btn sidebar-btn-orange" onclick="switchToGeneralCapture()">
                        ‚ö° Captura General
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="newSession()">
                        ‚ûï Nueva Sesi√≥n
                    </button>
                </div>

                <!-- Pallets por estatus -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Tarimas Activas</div>
                    <div class="pallet-status-list" id="pallet-status-list">
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--success);">‚úÖ OK</span>
                                <span class="pallet-status-count" id="sidebar-ok-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-ok-pallet">-</div>
                        </div>
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--blocked);">‚ö†Ô∏è Bloqueado</span>
                                <span class="pallet-status-count" id="sidebar-blocked-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-blocked-pallet">-</div>
                        </div>
                        <div class="pallet-status-item">
                            <div class="pallet-status-header">
                                <span class="pallet-status-name" style="color: var(--error);">‚ùå No WMS</span>
                                <span class="pallet-status-count" id="sidebar-nowms-count">0</span>
                            </div>
                            <div class="pallet-code" id="sidebar-nowms-pallet">-</div>
                        </div>
                    </div>
                </div>

                <!-- User Footer -->
                <div class="user-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar" onclick="changeUserAlias()">?</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name-display" onclick="changeUserAlias()">No conectado</div>
                            <div class="connection-indicator">
                                <div class="connection-dot" id="connection-dot"></div>
                                <span id="connection-text">Offline</span>
                            </div>
                        </div>
                    </div>
                    <div class="user-footer-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshInventory()">üîÑ BD</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleConnection()" id="sidebar-auth-btn">üîó</button>
                        <button class="btn btn-danger btn-small" onclick="handleLogout()">üö™</button>
                    </div>
                    <div class="bd-info">
                        <div><span id="bd-count">0</span> c√≥digos cargados</div>
                        <div id="bd-update-time">Sin actualizar</div>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content" id="main-content-area">
                <!-- Content will be loaded here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- RESUMEN POPUP -->
    <div class="popup-overlay" id="resumen-popup">
        <div class="popup-content">
            <div class="popup-header">
                <span>üìä Resumen de Sesi√≥n</span>
                <button class="popup-close" onclick="closeResumen()">√ó</button>
            </div>

            <div class="resumen-stats">
                <div class="resumen-stat ok">
                    <div class="resumen-stat-number" id="resumen-ok">0</div>
                    <div class="resumen-stat-label">OK</div>
                </div>
                <div class="resumen-stat blocked">
                    <div class="resumen-stat-number" id="resumen-blocked">0</div>
                    <div class="resumen-stat-label">Bloqueado</div>
                </div>
                <div class="resumen-stat nowms">
                    <div class="resumen-stat-number" id="resumen-nowms">0</div>
                    <div class="resumen-stat-label">No WMS</div>
                </div>
                <div class="resumen-stat pending">
                    <div class="resumen-stat-number" id="resumen-pending">0</div>
                    <div class="resumen-stat-label">Pendientes Sync</div>
                </div>
            </div>

            <div class="resumen-actions">
                <button class="btn btn-primary btn-small" onclick="refreshInventory(); closeResumen();">üîÑ Recargar BD</button>
                <button class="btn btn-success btn-small" onclick="SyncManager.syncAndExport(); updateResumen();">üîÑ Sincronizar y Exportar</button>
            </div>

            <h3 style="margin-bottom: 10px; font-size: 1em;">üìã Historial Reciente</h3>
            <div class="resumen-table-container">
                <table class="resumen-table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>C√≥digo</th>
                            <th>C√≥digo 2</th>
                            <th>Estatus</th>
                            <th>Ubicaci√≥n</th>
                            <th>Pallet</th>
                        </tr>
                    </thead>
                    <tbody id="resumen-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
// ==================== CONFIGURATION ==================== //
const CONFIG = {
    CLIENT_ID: '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com',
    SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile',
    SPREADSHEET_WRITE: '1FBhZloEeT-xTe1yVKzdWxGJa6gKkZQOObmkBMuxqcv8',
    SHEET_NAME: 'BD',
    INVENTORY_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-HG8HPf-94Ki5Leo5iEF5pyqsiD9CVk-mcl-F8BAw34kT0s3nzNn532YTYDCtkG76NbauiVx0Ffmd/pub?output=csv'
};

// ==================== STATE ==================== //
let STATE = {
    inventory: new Map(),
    inventoryLastUpdate: null,
    pallets: {
        ok: { id: generatePalletId('OK'), boxes: [], location: '' },
        blocked: { id: generatePalletId('BLK'), boxes: [], location: '' },
        nowms: { id: generatePalletId('NW'), boxes: [], location: '' }
    },
    pendingCode1: null,
    history: [],
    currentView: 'standard', // 'standard' or 'general'
    tabs: [],
    activeTabId: null,
    generalCapture: {
        palletId: generatePalletId('GEN'),
        boxes: [],
        location: ''
    }
};

let CURRENT_USER = '';
let USER_EMAIL = '';
let USER_GOOGLE_NAME = '';
let IS_ONLINE = navigator.onLine;
let PENDING_SYNC = [];
let TOKEN_CLIENT = null;
let audioCtx = null;

// ==================== TABS SYSTEM ====================
const TabsManager = {
    maxTabs: 4,

    init() {
        this.loadTabs();
        if (STATE.tabs.length === 0) {
            this.showEmptyState();
        } else {
            this.activateTab(STATE.tabs[0].id);
        }
    },

    loadTabs() {
        try {
            const saved = localStorage.getItem('pd_tabs');
            if (saved) {
                STATE.tabs = JSON.parse(saved);
            }
        } catch (e) {}
    },

    saveTabs() {
        try {
            localStorage.setItem('pd_tabs', JSON.stringify(STATE.tabs));
        } catch (e) {}
    },

    createTab() {
        if (STATE.tabs.length >= this.maxTabs) {
            showNotification(`‚ö†Ô∏è M√°ximo ${this.maxTabs} pesta√±as`, 'warning');
            return;
        }

        const newTab = {
            id: `tab-${Date.now()}`,
            name: `Pesta√±a ${STATE.tabs.length + 1}`,
            pallets: {
                ok: { id: generatePalletId('OK'), boxes: [], location: '' },
                blocked: { id: generatePalletId('BLK'), boxes: [], location: '' },
                nowms: { id: generatePalletId('NW'), boxes: [], location: '' }
            },
            pendingCode1: null
        };

        STATE.tabs.push(newTab);
        this.saveTabs();
        this.activateTab(newTab.id);
        showNotification('‚úÖ Nueva pesta√±a creada', 'success');
    },

    closeTab(tabId) {
        const tab = STATE.tabs.find(t => t.id === tabId);
        if (!tab) return;

        const totalBoxes = tab.pallets.ok.boxes.length +
                          tab.pallets.blocked.boxes.length +
                          tab.pallets.nowms.boxes.length;

        if (totalBoxes > 0) {
            if (!confirm(`Esta pesta√±a tiene ${totalBoxes} cajas sin enviar. ¬øCerrar de todos modos?`)) {
                return;
            }
        }

        STATE.tabs = STATE.tabs.filter(t => t.id !== tabId);
        this.saveTabs();

        if (STATE.activeTabId === tabId) {
            if (STATE.tabs.length > 0) {
                this.activateTab(STATE.tabs[0].id);
            } else {
                STATE.activeTabId = null;
                this.showEmptyState();
            }
        } else {
            this.renderTabs();
        }

        showNotification('Pesta√±a cerrada', 'info');
    },

    activateTab(tabId) {
        STATE.activeTabId = tabId;
        const tab = STATE.tabs.find(t => t.id === tabId);
        if (tab) {
            STATE.pallets = tab.pallets;
            STATE.pendingCode1 = tab.pendingCode1;
        }
        this.renderTabs();
        this.renderStandardView();
    },

    renderTabs() {
        const container = document.getElementById('tabs-container');
        if (!container) return;

        const html = STATE.tabs.map(tab => {
            const active = tab.id === STATE.activeTabId ? 'active' : '';
            const total = tab.pallets.ok.boxes.length +
                         tab.pallets.blocked.boxes.length +
                         tab.pallets.nowms.boxes.length;
            return `
                <div class="tab ${active}" onclick="TabsManager.activateTab('${tab.id}')">
                    ${tab.name} ${total > 0 ? `(${total})` : ''}
                    <button class="tab-close" onclick="event.stopPropagation(); TabsManager.closeTab('${tab.id}')">√ó</button>
                </div>
            `;
        }).join('');

        const newBtn = STATE.tabs.length < this.maxTabs ? `
            <div class="tab tab-new" onclick="TabsManager.createTab()">
                ‚ûï Nuevo
            </div>
        ` : '';

        container.innerHTML = html + newBtn;
    },

    showEmptyState() {
        const content = document.getElementById('main-content-area');
        content.innerHTML = `
            <div class="tabs-empty-state">
                <div class="tabs-empty-icon">üì¶</div>
                <div class="tabs-empty-text">No hay pesta√±as abiertas</div>
                <button class="btn btn-success" onclick="TabsManager.createTab()">
                    ‚ûï Crear Primera Pesta√±a
                </button>
            </div>
        `;
    },

    renderStandardView() {
        const content = document.getElementById('main-content-area');
        content.innerHTML = `
            <div class="header">
                <h1>üì∏ √Årea de Escaneo</h1>
            </div>

            <div id="tabs-container" class="tabs-container"></div>

            <div class="scan-section">
                <div class="scan-row">
                    <div class="scan-input-group">
                        <label>üîç C√≥digo Principal</label>
                        <input type="text" class="scan-input" id="scan-input" placeholder="Escanea o ingresa c√≥digo..." autocomplete="off">
                    </div>
                </div>

                <div class="result-box" id="result-box">
                    <div class="result-header">
                        <span class="result-icon" id="result-icon">üì¶</span>
                        <span class="result-title" id="result-title">Estado</span>
                    </div>
                    <div class="result-code" id="result-code"></div>
                    <div class="result-details" id="result-details"></div>
                </div>

                <div class="code2-container" id="code2-container">
                    <label style="font-size: 0.9em; color: var(--error); font-weight: 600; margin-bottom: 8px; display: block;">
                        ‚ö†Ô∏è C√≥digo no encontrado. Ingresa C√≥digo 2 o fuerza el registro:
                    </label>
                    <div class="code2-row">
                        <div class="scan-input-group">
                            <input type="text" class="scan-input" id="code2-input" placeholder="C√≥digo 2..." autocomplete="off" style="font-size: 1.1em;">
                        </div>
                        <button class="btn-insertado" onclick="forceInsert()">
                            ‚ö° INSERTADO
                        </button>
                    </div>
                </div>
            </div>

            <div class="columns-container">
                <div class="column ok">
                    <div class="column-header">
                        <span class="column-title">‚úÖ OK</span>
                        <span class="column-count" id="ok-count">0</span>
                    </div>
                    <div class="column-pallet-info">
                        <div>Pallet: <span class="column-pallet-code" id="ok-pallet">-</span></div>
                        <input type="text" class="column-location-input" id="location-ok" placeholder="üìç Ubicaci√≥n destino...">
                        <button class="column-send-btn" onclick="sendPallet('ok')" id="send-ok-btn" disabled>
                            üì§ Enviar Tarima OK
                        </button>
                    </div>
                    <div class="column-list" id="ok-list">
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div>Sin cajas</div>
                        </div>
                    </div>
                </div>

                <div class="column blocked">
                    <div class="column-header">
                        <span class="column-title">‚ö†Ô∏è Bloqueado</span>
                        <span class="column-count" id="blocked-count">0</span>
                    </div>
                    <div class="column-pallet-info">
                        <div>Pallet: <span class="column-pallet-code" id="blocked-pallet">-</span></div>
                        <input type="text" class="column-location-input" id="location-blocked" placeholder="üìç Ubicaci√≥n destino...">
                        <button class="column-send-btn" onclick="sendPallet('blocked')" id="send-blocked-btn" disabled>
                            üì§ Enviar Tarima Bloqueado
                        </button>
                    </div>
                    <div class="column-list" id="blocked-list">
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div>Sin cajas</div>
                        </div>
                    </div>
                </div>

                <div class="column nowms">
                    <div class="column-header">
                        <span class="column-title">‚ùå No WMS</span>
                        <span class="column-count" id="nowms-count">0</span>
                    </div>
                    <div class="column-pallet-info">
                        <div>Pallet: <span class="column-pallet-code" id="nowms-pallet">-</span></div>
                        <input type="text" class="column-location-input" id="location-nowms" placeholder="üìç Ubicaci√≥n destino...">
                        <button class="column-send-btn" onclick="sendPallet('nowms')" id="send-nowms-btn" disabled>
                            üì§ Enviar Tarima No WMS
                        </button>
                    </div>
                    <div class="column-list" id="nowms-list">
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div>Sin cajas</div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        this.renderTabs();
        setupEventListeners();
        updateUI();
    }
};

// ==================== SYNC MANAGER ====================
const SyncManager = {
    inProgress: false,
    retryCount: 0,
    intervalId: null,
    AUTO_SYNC_INTERVAL: 30000,

    init() {
        this.load();
        this.startAutoSync();
        this.setupExitProtection();
        this.updateUI(PENDING_SYNC.length === 0);
    },

    setupExitProtection() {
        window.addEventListener('beforeunload', (e) => {
            const hasUnsavedData = PENDING_SYNC.length > 0 ||
                STATE.pallets.ok.boxes.length > 0 ||
                STATE.pallets.blocked.boxes.length > 0 ||
                STATE.pallets.nowms.boxes.length > 0 ||
                STATE.generalCapture.boxes.length > 0;

            if (hasUnsavedData) {
                e.preventDefault();
                e.returnValue = '¬°Tienes datos sin sincronizar! ¬øSeguro que quieres salir?';
                return e.returnValue;
            }
        });
    },

    startAutoSync() {
        if (this.intervalId) clearInterval(this.intervalId);
        this.intervalId = setInterval(() => {
            if (IS_ONLINE && gapi?.client?.getToken() && PENDING_SYNC.length > 0) {
                this.sync(false);
            }
        }, this.AUTO_SYNC_INTERVAL);
    },

    async sync(showMessages = true) {
        if (this.inProgress) {
            if (showMessages) showNotification('‚è≥ Sincronizaci√≥n en progreso...', 'info');
            return { success: false };
        }

        if (!IS_ONLINE) {
            if (showMessages) showNotification('‚ö†Ô∏è Sin conexi√≥n a internet', 'warning');
            return { success: false };
        }

        if (!gapi?.client?.getToken()) {
            if (showMessages) showNotification('‚ö†Ô∏è No conectado a Google', 'warning');
            return { success: false };
        }

        if (PENDING_SYNC.length === 0) {
            this.updateUI(true);
            if (showMessages) showNotification('‚úÖ Todo sincronizado', 'success');
            return { success: true, synced: 0 };
        }

        return await this._doSync(showMessages);
    },

    async _doSync(showMessages) {
        this.inProgress = true;
        updateConnectionIndicator(true);

        if (showMessages) showNotification('üîÑ Sincronizando...', 'info');

        try {
            const values = PENDING_SYNC.map(r => [
                r.date, r.time, r.user, r.scan1, r.scan2,
                r.location, r.status, r.note, r.pallet
            ]);

            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                range: `${CONFIG.SHEET_NAME}!A:I`,
                valueInputOption: 'USER_ENTERED',
                insertDataOption: 'INSERT_ROWS',
                resource: { values }
            });

            const synced = PENDING_SYNC.length;
            PENDING_SYNC = [];
            this.save();
            this.updateUI(true);

            if (showMessages) showNotification(`‚úÖ ${synced} registros sincronizados`, 'success');
            return { success: true, synced };
        } catch (e) {
            console.error('Sync error:', e);
            this.updateUI(false);
            if (showMessages) showNotification(`‚ùå Error: ${e.result?.error?.message || e.message || 'Error desconocido'}`, 'error');
            return { success: false };
        } finally {
            this.inProgress = false;
            updateConnectionIndicator();
        }
    },

    async syncAndExport() {
        const result = await this.sync(true);
        if (result.success) {
            exportData();
        }
    },

    async save() {
        try {
            localStorage.setItem('pd_pending_sync', JSON.stringify(PENDING_SYNC));
        } catch (e) {}
    },

    async load() {
        try {
            const saved = localStorage.getItem('pd_pending_sync');
            if (saved) PENDING_SYNC = JSON.parse(saved);
        } catch (e) {}
    },

    updateUI(synced) {
        const el = document.getElementById('sync-status');
        if (!el) return;

        if (!IS_ONLINE) {
            el.className = 'sync-status sync-warning';
            el.innerHTML = `‚ö†Ô∏è Sin conexi√≥n${PENDING_SYNC.length > 0 ? ` (${PENDING_SYNC.length})` : ''}`;
        } else if (PENDING_SYNC.length > 0) {
            el.className = 'sync-status sync-warning';
            el.innerHTML = `‚è≥ ${PENDING_SYNC.length} pendientes`;
        } else if (synced) {
            el.className = 'sync-status sync-ok';
            el.textContent = '‚úÖ Sincronizado';
        } else {
            el.className = 'sync-status sync-error';
            el.textContent = '‚ùå Error sync';
        }
    },

    showPanel() {
        const overlay = document.createElement('div');
        overlay.className = 'popup-overlay show';
        overlay.innerHTML = `
            <div class="popup-content" style="max-width: 450px;">
                <div class="popup-header">
                    <span>üìä Estado de Sincronizaci√≥n</span>
                    <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">√ó</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px; text-align: center;">
                        <div style="font-size: 0.85em; color: #666;">Pendientes de sincronizar</div>
                        <div style="font-size: 2em; font-weight: 700; color: ${PENDING_SYNC.length > 0 ? 'var(--warning)' : 'var(--success)'};">
                            ${PENDING_SYNC.length}
                        </div>
                    </div>
                    <div style="font-size: 0.9em; padding: 10px; background: #f9f9f9; border-radius: 6px;">
                        ${IS_ONLINE ? 'üü¢ Conectado a internet' : 'üî¥ Sin conexi√≥n'}<br>
                        ${gapi?.client?.getToken() ? 'üü¢ Google conectado' : 'üî¥ Google desconectado'}<br>
                        üìÑ Hoja destino: <strong>${CONFIG.SHEET_NAME}</strong>
                    </div>
                </div>
                <div class="popup-buttons">
                    ${PENDING_SYNC.length > 0 && IS_ONLINE && gapi?.client?.getToken() ? `
                        <button class="btn btn-success btn-full" onclick="this.closest('.popup-overlay').remove(); SyncManager.sync();">
                            üîÑ Sincronizar Ahora
                        </button>
                    ` : ''}
                    <button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">
                        Cerrar
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) overlay.remove();
        });
    }
};


// ==================== GENERAL CAPTURE MODULE ====================
const GeneralCapture = {
    render() {
        const content = document.getElementById('main-content-area');
        content.innerHTML = `
            <div class="header">
                <h1>‚ö° Captura General</h1>
                <button class="btn btn-secondary btn-small" onclick="switchToStandardView()">
                    üì∏ Vista Est√°ndar
                </button>
            </div>

            <div class="scan-section">
                <div class="scan-row">
                    <div class="scan-input-group">
                        <label>üîç C√≥digo Principal</label>
                        <input type="text" class="scan-input" id="general-scan-input" placeholder="Escanea o ingresa c√≥digo..." autocomplete="off">
                    </div>
                </div>

                <div class="result-box" id="general-result-box">
                    <div class="result-header">
                        <span class="result-icon" id="general-result-icon">üì¶</span>
                        <span class="result-title" id="general-result-title">Estado</span>
                    </div>
                    <div class="result-code" id="general-result-code"></div>
                    <div class="result-details" id="general-result-details"></div>
                </div>

                <div class="code2-container" id="general-code2-container">
                    <label style="font-size: 0.9em; color: var(--error); font-weight: 600; margin-bottom: 8px; display: block;">
                        ‚ö†Ô∏è C√≥digo no encontrado. Ingresa C√≥digo 2 o fuerza el registro:
                    </label>
                    <div class="code2-row">
                        <div class="scan-input-group">
                            <input type="text" class="scan-input" id="general-code2-input" placeholder="C√≥digo 2..." autocomplete="off" style="font-size: 1.1em;">
                        </div>
                        <button class="btn-insertado" onclick="GeneralCapture.forceInsert()">
                            ‚ö° INSERTADO
                        </button>
                    </div>
                </div>
            </div>

            <div class="general-capture-container">
                <div class="general-pallet-card">
                    <div class="general-pallet-header">
                        <span class="general-pallet-title">üì¶ Tarima General</span>
                        <span class="general-pallet-count" id="general-pallet-count">0</span>
                    </div>
                    <div class="general-pallet-info">
                        <div class="general-info-item">
                            <div class="general-info-label">ID Pallet</div>
                            <div class="general-info-value" id="general-pallet-id">-</div>
                        </div>
                        <div class="general-info-item">
                            <div class="general-info-label">Total Cajas</div>
                            <div class="general-info-value" id="general-total-boxes">0</div>
                        </div>
                    </div>
                    <div class="general-location-row">
                        <input type="text" class="general-location-input" id="general-location" placeholder="üìç Ubicaci√≥n destino...">
                        <button class="general-send-btn" onclick="GeneralCapture.sendPallet()" id="general-send-btn" disabled>
                            üì§ Enviar Datos
                        </button>
                    </div>
                </div>

                <div class="general-boxes-container" id="general-boxes-list">
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div>Sin cajas escaneadas</div>
                    </div>
                </div>
            </div>
        `;

        this.setupEventListeners();
        this.updateUI();
    },

    setupEventListeners() {
        const scanInput = document.getElementById('general-scan-input');
        scanInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && scanInput.value.trim()) {
                e.preventDefault();
                this.processScan(scanInput.value.trim());
                scanInput.value = '';
            }
        });

        const code2Input = document.getElementById('general-code2-input');
        code2Input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && code2Input.value.trim()) {
                e.preventDefault();
                this.processCode2(code2Input.value.trim());
                code2Input.value = '';
            }
        });
    },

    processScan(rawCode) {
        const code = normalizeCode(rawCode);

        // Check duplicates
        if (STATE.generalCapture.boxes.some(b => b.code === code)) {
            showNotification('‚ö†Ô∏è C√≥digo duplicado', 'warning');
            this.flashInput('warning');
            playSound('warning');
            return;
        }

        const item = STATE.inventory.get(code);

        if (!item) {
            // Try alternative code
            const altItem = this.findByAlternativeCode(code);
            if (altItem) {
                this.addBox(code, '', altItem);
                this.showResult('success', code, 'OK (C√≥digo Alternativo)', 'Encontrado por c√≥digo alternativo', altItem);
                this.flashInput('success');
                playSound('success');
                return;
            }

            // Not found - show Code2 input
            STATE.pendingCode1 = { raw: rawCode, code };
            this.showResult('error', code, 'NO ENCONTRADO', 'C√≥digo no encontrado. Ingresa C√≥digo 2 o usa INSERTADO.', null);
            document.getElementById('general-code2-container').classList.add('show');
            this.flashInput('error');
            playSound('error');
            setTimeout(() => document.getElementById('general-code2-input').focus(), 100);
            return;
        }

        // Hide code2 container
        document.getElementById('general-code2-container').classList.remove('show');
        STATE.pendingCode1 = null;

        // Add box with status
        this.addBox(code, '', item);

        if (item.isBlocked) {
            this.showResult('blocked', code, 'BLOQUEADO', 'Inventario bloqueado', item);
            playSound('warning');
        } else if (item.isAvailable) {
            this.showResult('success', code, 'OK', 'Validado correctamente', item);
            playSound('success');
        } else {
            this.showResult('blocked', code, 'SIN STOCK', 'Sin stock disponible', item);
            playSound('warning');
        }

        this.flashInput('success');
    },

    findByAlternativeCode(code) {
        for (const [key, item] of STATE.inventory) {
            // Buscar en campos adicionales si existen
            if (item.alternativeCode && normalizeCode(item.alternativeCode) === code) {
                return item;
            }
        }
        return null;
    },

    processCode2(rawCode2) {
        if (!STATE.pendingCode1) return;

        const code2 = normalizeCode(rawCode2);
        const item = STATE.inventory.get(code2);

        document.getElementById('general-code2-container').classList.remove('show');

        if (!item) {
            // Both codes failed
            this.addBox(STATE.pendingCode1.code, rawCode2, null);
            this.showResult('error', STATE.pendingCode1.code, 'NO WMS', 
                `Ambos c√≥digos no encontrados. Guardados: ${STATE.pendingCode1.code} y ${code2}`, null);
            playSound('error');
        } else if (item.isBlocked) {
            this.addBox(code2, rawCode2, item);
            this.showResult('blocked', code2, 'BLOQUEADO (C√≥digo 2)', 'Validado con C√≥digo 2 - Bloqueado', item);
            playSound('warning');
        } else {
            this.addBox(code2, rawCode2, item);
            this.showResult('success', code2, 'OK (C√≥digo 2)', 'Validado correctamente con C√≥digo 2', item);
            playSound('success');
        }

        STATE.pendingCode1 = null;
        this.flashInput('success');
        document.getElementById('general-scan-input').focus();
    },

    forceInsert() {
        if (!STATE.pendingCode1) {
            showNotification('‚ö†Ô∏è Primero escanea un c√≥digo', 'warning');
            return;
        }

        const code2Value = document.getElementById('general-code2-input').value.trim();
        this.addBox(STATE.pendingCode1.code, code2Value, null);

        const msg = code2Value
            ? `Insertado con c√≥digos: ${STATE.pendingCode1.code} y ${code2Value}`
            : `Insertado con c√≥digo: ${STATE.pendingCode1.code}`;

        this.showResult('error', STATE.pendingCode1.code, 'INSERTADO (No WMS)', msg, null);

        document.getElementById('general-code2-container').classList.remove('show');
        document.getElementById('general-code2-input').value = '';
        STATE.pendingCode1 = null;

        playSound('warning');
        this.flashInput('warning');
        document.getElementById('general-scan-input').focus();
        showNotification('‚ö° Registro insertado forzosamente', 'warning');
    },

    addBox(code, scan2, item) {
        const status = !item ? 'nowms' : item.isBlocked ? 'blocked' : 'ok';
        
        STATE.generalCapture.boxes.push({
            code,
            scan1: code,
            scan2: scan2 || '',
            location: item?.cellNo || '-',
            sku: item?.sku || '-',
            product: item?.productName || '-',
            timestamp: new Date().toLocaleTimeString(),
            status
        });

        saveToStorage();
        this.updateUI();
    },

    deleteBox(index) {
        if (confirm('¬øEliminar esta caja?')) {
            STATE.generalCapture.boxes.splice(index, 1);
            saveToStorage();
            this.updateUI();
            showNotification('Caja eliminada', 'info');
        }
    },

    async sendPallet() {
        const location = document.getElementById('general-location').value.trim();

        if (STATE.generalCapture.boxes.length === 0) {
            showNotification('‚ö†Ô∏è No hay cajas en esta tarima', 'warning');
            return;
        }

        if (!location) {
            showNotification('‚ö†Ô∏è Ingresa la ubicaci√≥n destino', 'warning');
            document.getElementById('general-location').focus();
            return;
        }

        // Validar ubicaci√≥n
        const locationCheck = confirmInvalidLocation(location);
        if (!locationCheck.confirmed) {
            showNotification('‚ùå Env√≠o cancelado - Verifica la ubicaci√≥n', 'warning');
            document.getElementById('general-location').focus();
            return;
        }

        const finalLocation = locationCheck.formatted;
        document.getElementById('general-location').value = finalLocation;

        const statusMap = { ok: 'OK', blocked: 'BLOQUEADO', nowms: 'NO WMS' };
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);
        const timeStr = now.toTimeString().slice(0, 8);

        const records = STATE.generalCapture.boxes.map(box => ({
            date: dateStr,
            time: timeStr,
            user: CURRENT_USER || 'Usuario',
            scan1: box.scan1 || box.code,
            scan2: box.scan2 || '',
            location: finalLocation,
            status: statusMap[box.status],
            note: '',
            pallet: STATE.generalCapture.palletId
        }));

        STATE.history = [...records, ...STATE.history].slice(0, 1000);
        PENDING_SYNC = [...PENDING_SYNC, ...records];
        SyncManager.save();

        showNotification(`üíæ ${records.length} registros agregados`, 'info');

        if (IS_ONLINE && gapi?.client?.getToken()) {
            await SyncManager.sync();
        } else {
            SyncManager.updateUI(false);
        }

        // Reset
        STATE.generalCapture = {
            palletId: generatePalletId('GEN'),
            boxes: [],
            location: ''
        };
        document.getElementById('general-location').value = '';

        saveToStorage();
        this.updateUI();
        playSound('success');
        document.getElementById('general-scan-input').focus();
    },

    updateUI() {
        const count = STATE.generalCapture.boxes.length;
        document.getElementById('general-pallet-count').textContent = count;
        document.getElementById('general-pallet-id').textContent = STATE.generalCapture.palletId;
        document.getElementById('general-total-boxes').textContent = count;
        document.getElementById('general-send-btn').disabled = count === 0;

        const listEl = document.getElementById('general-boxes-list');
        if (count === 0) {
            listEl.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <div>Sin cajas escaneadas</div>
                </div>
            `;
            return;
        }

        listEl.innerHTML = STATE.generalCapture.boxes.map((box, index) => {
            const statusLabels = { ok: 'OK', blocked: 'BLOQUEADO', nowms: 'NO WMS' };
            return `
                <div class="general-box-item ${box.status}">
                    <div class="general-box-main">
                        <div class="general-box-header">
                            <span class="general-box-number">#${index + 1}</span>
                            <span class="general-box-status ${box.status}">${statusLabels[box.status]}</span>
                        </div>
                        <div class="general-box-codes">${box.code}${box.scan2 ? ` / ${box.scan2}` : ''}</div>
                        <div class="general-box-time">${box.timestamp} ‚Ä¢ ${box.location}</div>
                    </div>
                    <button class="box-delete" onclick="GeneralCapture.deleteBox(${index})">‚úï</button>
                </div>
            `;
        }).join('');
    },

    showResult(type, code, title, message, item) {
        const box = document.getElementById('general-result-box');
        const icons = { success: '‚úÖ', warning: '‚ö†Ô∏è', blocked: '‚ö†Ô∏è', error: '‚ùå' };

        box.className = `result-box show ${type}`;
        document.getElementById('general-result-icon').textContent = icons[type] || 'üì¶';
        document.getElementById('general-result-title').textContent = title;
        document.getElementById('general-result-code').textContent = code;

        const detailsEl = document.getElementById('general-result-details');
        if (item) {
            detailsEl.innerHTML = `
                <div><span class="result-detail-label">Ubicaci√≥n</span><div class="result-detail-value">${item.cellNo || '-'}</div></div>
                <div><span class="result-detail-label">SKU</span><div class="result-detail-value">${item.sku || '-'}</div></div>
                <div><span class="result-detail-label">Producto</span><div class="result-detail-value">${item.productName || '-'}</div></div>
                <div><span class="result-detail-label">Stock</span><div class="result-detail-value">${item.availableStock || 0}</div></div>
            `;
        } else {
            detailsEl.innerHTML = `<div style="grid-column: 1/-1; color: #666;">${message}</div>`;
        }
    },

    flashInput(type) {
        const input = document.getElementById('general-scan-input');
        input.classList.remove('success', 'error');
        input.classList.add(type === 'success' ? 'success' : type === 'error' ? 'error' : '');
        setTimeout(() => input.classList.remove('success', 'error'), 500);
    }
};

// ==================== VIEW SWITCHING ====================
function switchToGeneralCapture() {
    STATE.currentView = 'general';
    GeneralCapture.render();
    showNotification('‚ö° Modo Captura General', 'info');
}

function switchToStandardView() {
    STATE.currentView = 'standard';
    if (STATE.tabs.length === 0) {
        TabsManager.createTab();
    } else {
        TabsManager.renderStandardView();
    }
    showNotification('üì∏ Vista Est√°ndar', 'info');
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
    initAudio();
    loadFromStorage();
    setupConnectionMonitor();
    gapi.load('client', initGAPI);
});

function initAudio() {
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.addEventListener('click', () => {
            if (audioCtx?.state === 'suspended') audioCtx.resume();
        }, { once: true });
    } catch (e) {}
}

// Enhanced Google API initialization with better error handling and state management
let API_RETRY_COUNT = 0;
const MAX_API_RETRIES = 3;
const TOKEN_EXPIRY_BUFFER = 5 * 60 * 1000; // 5 minutes before token expiry

async function initGAPI() {
    try {
        // Initialize the Google API client
        await gapi.client.init({
            discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
            gapi: {
                client: {
                    clientId: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES
                }
            }
        });

        // Set up token client with error handling
        TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
            client_id: CONFIG.CLIENT_ID,
            scope: CONFIG.SCOPES,
            callback: handleAuthCallback,
            error_callback: (error) => {
                console.error('OAuth2 Error:', error);
                showNotification('Error de autenticaci√≥n con Google', 'error');
                showLoadingOverlay(false);
            }
        });

        // Check for existing token
        const token = gapi.client.getToken();
        if (token) {
            // Check if token is expired or about to expire
            const expiryTime = token.expires_at || 0;
            const currentTime = new Date().getTime();
            
            if (expiryTime > currentTime + TOKEN_EXPIRY_BUFFER) {
                // Token is still valid, proceed with app initialization
                await initializeApp(token);
            } else {
                // Token expired or about to expire, request a new one
                TOKEN_CLIENT.requestAccessToken({ prompt: '' });
            }
        }
    } catch (error) {
        console.error('Failed to initialize GAPI:', error);
        showNotification('Error al inicializar la API de Google', 'error');
        showLoadingOverlay(false);
    }
}

async function initializeApp(token) {
    try {
        showLoadingOverlay(true, 'Cargando datos...');
        
        // Set the token and load user data
        gapi.client.setToken(token);
        await Promise.all([
            getUserProfile(),
            loadInventory()
        ]);
        
        // Initialize sync manager and check for pending syncs
        SyncManager.init();
        if (PENDING_SYNC.length > 0) {
            await SyncManager.sync();
        }
        
        // Show the app and update UI
        showApp();
        updateConnectionStatus(IS_ONLINE);
    } catch (error) {
        console.error('App initialization failed:', error);
        showNotification('Error al cargar los datos', 'error');
        
        // If it's an auth error, try to re-authenticate
        if (error.status === 401 || error.status === 403) {
            TOKEN_CLIENT.requestAccessToken({ prompt: 'consent' });
        }
    } finally {
        showLoadingOverlay(false);
    }
}

async function handleAuthCallback(response) {
    if (!response?.access_token) {
        console.error('No access token in response');
        showNotification('Error de autenticaci√≥n: No se recibi√≥ el token', 'error');
        showLoadingOverlay(false);
        return;
    }

    try {
        // Store token with expiry time (default to 1 hour if not provided)
        const expiresIn = response.expires_in || 3600;
        const expiryTime = new Date().getTime() + (expiresIn * 1000);
        response.expires_at = expiryTime;
        
        // Initialize the app with the new token
        await initializeApp(response);
        
    } catch (error) {
        console.error('Auth callback error:', error);
        showNotification('Error al procesar la autenticaci√≥n', 'error');
        showLoadingOverlay(false);
    }
}

// Helper function to check if token is valid
function isTokenValid() {
    const token = gapi.client.getToken();
    if (!token) return false;
    
    const currentTime = new Date().getTime();
    return token.expires_at > currentTime + TOKEN_EXPIRY_BUFFER;
}

// Enhanced error handling for API calls
async function withApiRetry(apiCall, maxRetries = MAX_API_RETRIES) {
    let lastError;
    
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            // Check and refresh token if needed
            if (!isTokenValid()) {
                await refreshToken();
            }
            
            const result = await apiCall();
            API_RETRY_COUNT = 0; // Reset retry count on success
            return result;
            
        } catch (error) {
            lastError = error;
            
            // If it's an auth error, try to refresh the token
            if (error.status === 401 || error.status === 403) {
                try {
                    await refreshToken();
                    continue; // Retry with new token
                } catch (refreshError) {
                    console.error('Token refresh failed:', refreshError);
                    // If refresh fails, we need to re-authenticate
                    TOKEN_CLIENT.requestAccessToken({ prompt: 'consent' });
                    throw new Error('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
                }
            }
            
            // For other errors, apply exponential backoff
            if (attempt < maxRetries) {
                const backoffDelay = Math.min(1000 * Math.pow(2, attempt), 30000); // Max 30 seconds
                console.warn(`API call failed (attempt ${attempt}/${maxRetries}), retrying in ${backoffDelay}ms...`);
                await new Promise(resolve => setTimeout(resolve, backoffDelay));
            }
        }
    }
    
    // If we get here, all retries failed
    throw lastError || new Error('Unknown error occurred');
}

// Function to refresh the access token
async function refreshToken() {
    if (!gapi.client.getToken()) {
        throw new Error('No token available to refresh');
    }
    
    // Use the token client to get a new token
    return new Promise((resolve, reject) => {
        const refreshClient = google.accounts.oauth2.initTokenClient({
            client_id: CONFIG.CLIENT_ID,
            scope: CONFIG.SCOPES,
            callback: (response) => {
                if (response?.access_token) {
                    gapi.client.setToken(response);
                    resolve(response);
                } else {
                    reject(new Error('Failed to refresh token'));
                }
            },
            error_callback: (error) => {
                console.error('Token refresh error:', error);
                reject(error);
            }
        });
        
        // Request a new token with prompt=none to try silent refresh first
        refreshClient.requestAccessToken({ prompt: 'none' });
    });
}

function showLoadingOverlay(show, message = 'Cargando...') {
    const overlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    
    if (loadingText) {
        loadingText.textContent = message;
    }
    
    if (show) {
        overlay.classList.add('show');
    } else {
        overlay.classList.remove('show');
    }
}

function handleLogin() {
    TOKEN_CLIENT?.requestAccessToken();
}

async function getUserProfile() {
    try {
        const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
            headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` }
        });
        const data = await response.json();
        USER_EMAIL = data.email || '';
        USER_GOOGLE_NAME = data.name || 'Usuario';

        const savedAlias = localStorage.getItem(`pd_alias_${USER_EMAIL}`);
        if (savedAlias) {
            CURRENT_USER = savedAlias;
            showNotification(`‚úÖ Bienvenido, ${CURRENT_USER}`, 'success');
            updateUserFooter();
        } else {
            showAliasPopup();
        }
    } catch (e) {
        CURRENT_USER = 'Usuario';
        updateUserFooter();
    }
}

function showApp() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    updateUserFooter();
    
    if (STATE.currentView === 'general') {
        GeneralCapture.render();
    } else {
        TabsManager.init();
    }
    
    updateBdInfo();
}

function handleLogout() {
    const hasData = PENDING_SYNC.length > 0 ||
        STATE.pallets.ok.boxes.length > 0 ||
        STATE.pallets.blocked.boxes.length > 0 ||
        STATE.pallets.nowms.boxes.length > 0 ||
        STATE.generalCapture.boxes.length > 0;

    if (hasData) {
        if (!confirm('‚ö†Ô∏è Tienes datos sin sincronizar. ¬øSeguro que quieres salir?')) {
            return;
        }
    }

    if (gapi.client.getToken()) {
        google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
        gapi.client.setToken(null);
    }

    CURRENT_USER = '';
    USER_EMAIL = '';
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('main-app').classList.add('hidden');
}

// ==================== ALIAS SYSTEM ====================
function showAliasPopup() {
    document.querySelectorAll('.alias-popup').forEach(e => e.remove());

    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay show alias-popup';
    overlay.innerHTML = `
        <div class="popup-content" style="max-width: 400px;">
            <div class="popup-header">üë§ ¬øC√≥mo te llamamos?</div>
            <p style="margin-bottom: 15px; color: #666;">
                Hola <strong>${USER_GOOGLE_NAME}</strong>, elige c√≥mo aparecer√° tu nombre en los registros:
            </p>
            <div class="popup-buttons">
                <button class="btn btn-primary btn-full" onclick="saveUserAlias('${USER_GOOGLE_NAME}', true)">
                    üë§ Usar mi nombre de Google
                </button>
                <div style="text-align: center; color: #999; font-size: 0.85em;">o</div>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="alias-input" placeholder="Escribe un alias..."
                        style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em;"
                        maxlength="20">
                    <button class="btn btn-success" onclick="saveUserAlias(document.getElementById('alias-input').value)">
                        üíæ
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    const input = overlay.querySelector('#alias-input');
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
            saveUserAlias(input.value);
        }
    });
    input.focus();
}

function saveUserAlias(alias, isGoogleName = false) {
    const finalAlias = alias?.trim() || USER_GOOGLE_NAME;
    if (!finalAlias) {
        showNotification('‚ö†Ô∏è Ingresa un nombre v√°lido', 'warning');
        return;
    }

    CURRENT_USER = finalAlias;
    localStorage.setItem(`pd_alias_${USER_EMAIL}`, finalAlias);

    document.querySelectorAll('.alias-popup').forEach(e => e.remove());
    showNotification(`‚úÖ ${isGoogleName ? 'Nombre' : 'Alias'} guardado: ${finalAlias}`, 'success');
    updateUserFooter();
}

function changeUserAlias() {
    showAliasPopup();
}

function updateUserFooter() {
    const avatar = document.getElementById('user-avatar');
    const nameDisplay = document.getElementById('user-name-display');

    if (avatar) {
        avatar.textContent = CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : '?';
        avatar.title = USER_EMAIL || 'No conectado';
    }
    if (nameDisplay) {
        nameDisplay.textContent = CURRENT_USER || 'No conectado';
        nameDisplay.title = `Click para cambiar alias\n${USER_EMAIL}`;
    }

    updateConnectionIndicator();
}

// Contin√∫a con funciones de inventario, escaneo, validaci√≥n de ubicaci√≥n, etc...
// (El resto del c√≥digo es similar al original pero adaptado para los dos m√≥dulos)

function generatePalletId(prefix = 'PD') {
    const timestamp = Date.now().toString(36).toUpperCase();
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `${prefix}-${timestamp}-${random}`;
}

function normalizeCode(raw) {
    let code = raw.trim().toUpperCase();
    const patterns = [
        /\[id\[.*?\[([^\[]+)\[/i,
        /¬®id¬®.*?¬®([^¬®]+)¬®/i,
        /"id"\s*:\s*"([^"]+)"/i
    ];

    for (const pattern of patterns) {
        const match = code.match(pattern);
        if (match) return match[1];
    }

    const hasValidDash = /^[A-Z]+\d+\-\d+$/i.test(code);
    if (!hasValidDash) {
        code = code.replace(/(\d)-(\d)/g, '$1/$2');
    }

    return code.replace(/[^a-zA-Z0-9\-\/]/g, '');
}

function validateLocation(location) {
    const loc = location.trim().toUpperCase();
    const pattern = /^([A-Z])(\d{1,3})-(\d{1,2})-(\d{1,2})-(\d{1,2})$/;
    const match = loc.match(pattern);

    if (!match) {
        return {
            valid: false,
            message: '‚ùå Formato inv√°lido',
            details: 'La ubicaci√≥n debe seguir el formato: [LETRA][NUM]-[NUM]-[NUM]-[NUM]\nEjemplo: A21-06-05-01',
            parsed: null
        };
    }

    const [, area, pasillo, rack, nivel, palet] = match;

    return {
        valid: true,
        message: '‚úÖ Ubicaci√≥n v√°lida',
        parsed: {
            area,
            pasillo: pasillo.padStart(2, '0'),
            rack: rack.padStart(2, '0'),
            nivel: nivel.padStart(2, '0'),
            palet: palet.padStart(2, '0'),
            formatted: `${area}${pasillo.padStart(2, '0')}-${rack.padStart(2, '0')}-${nivel.padStart(2, '0')}-${palet.padStart(2, '0')}`
        }
    };
}

function confirmInvalidLocation(location) {
    const validation = validateLocation(location);
    if (validation.valid) {
        return { confirmed: true, formatted: validation.parsed.formatted };
    }

    const firstConfirm = confirm(
        `‚ö†Ô∏è UBICACI√ìN CON FORMATO INCORRECTO ‚ö†Ô∏è\n\n` +
        `Ubicaci√≥n ingresada: "${location}"\n\n` +
        `${validation.message}\n${validation.details}\n\n` +
        `¬øEst√°s seguro que deseas usar "${location}"?`
    );

    if (!firstConfirm) return { confirmed: false, formatted: null };

    const secondConfirm = confirm(
        `‚ö†Ô∏è SEGUNDA CONFIRMACI√ìN REQUERIDA ‚ö†Ô∏è\n\n` +
        `Confirma nuevamente: "${location}"\n\n` +
        `¬øCONFIRMAS el uso de esta ubicaci√≥n?`
    );

    return { confirmed: secondConfirm, formatted: secondConfirm ? location.toUpperCase() : null };
}

// Funciones auxiliares finales...
function showNotification(message, type = 'info') {
    const container = document.getElementById('notifications');
    const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };

    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `<span style="margin-right: 8px;">${icons[type]}</span>${message}`;

    container.appendChild(notification);
    setTimeout(() => notification.remove(), 4000);
}

function playSound(type) {
    if (!audioCtx) return;
    try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);

        if (type === 'success') {
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.15);
        } else if (type === 'error') {
            osc.frequency.setValueAtTime(300, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.35);
        } else if (type === 'warning') {
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }
    } catch (e) {}
}
    </script>
</body>
</html>
