<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inventario</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --blocked: #f97316;
            --bg: #f7f7f7;
            --text: #333;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* Connection Banner */
        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s;
        }
        .connection-banner.offline {
            background: var(--error);
            color: white;
            display: block;
        }
        .connection-banner.online {
            background: var(--success);
            color: white;
            display: block;
        }
        .connection-banner.syncing {
            background: var(--warning);
            color: white;
            display: block;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        /* MAIN LAYOUT */
        .main-container {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #555;
        }

        .sidebar-header h2 {
            color: var(--primary);
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.8em;
            color: #aaa;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }

        .sidebar-section-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .sidebar-btn:hover {
            transform: translateX(3px);
        }

        .sidebar-btn-primary {
            background: var(--primary);
            color: white;
        }

        .sidebar-btn-secondary {
            background: #555;
            color: white;
        }

        /* Sync Status */
        .sync-status {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            cursor: pointer;
        }
        .sync-ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .sync-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }
        .sync-warning {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* Pallets por estatus */
        .pallet-status-list {
            flex: 1;
            overflow-y: auto;
        }

        .pallet-status-item {
            background: #444;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .pallet-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .pallet-status-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .pallet-status-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .pallet-code {
            font-family: monospace;
            font-size: 0.7em;
            color: #aaa;
            word-break: break-all;
        }

        .pallet-send-btn {
            margin-top: 6px;
            padding: 5px 10px;
            font-size: 0.7em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }

        .pallet-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pallet-send-btn.ok { background: var(--success); color: white; }
        .pallet-send-btn.blocked { background: var(--blocked); color: white; }
        .pallet-send-btn.nowms { background: var(--error); color: white; }

        /* User Footer */
        .user-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            color: white;
            flex-shrink: 0;
            cursor: pointer;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .connection-indicator {
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--error); }
        .connection-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-footer-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .user-footer-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.75em;
        }

        .bd-info {
            font-size: 0.7em;
            color: #aaa;
            text-align: center;
            line-height: 1.4;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.4em;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        /* Scan Section */
        .scan-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scan-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .scan-input-group {
            flex: 1;
        }

        .scan-input-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .scan-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.3em;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
            transition: all 0.2s;
        }

        .scan-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .scan-input.error {
            border-color: var(--error);
            background: #ffebee;
        }

        .scan-input.success {
            border-color: var(--success);
            background: #e8f5e9;
        }

        /* Result Box */
        .result-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-box.show { display: block; }
        .result-box.success { background: #e8f5e9; border: 2px solid var(--success); }
        .result-box.warning { background: #fff3e0; border: 2px solid var(--warning); }
        .result-box.blocked { background: #fff3e0; border: 2px solid var(--blocked); }
        .result-box.error { background: #ffebee; border: 2px solid var(--error); }

        .result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .result-icon { font-size: 1.5rem; }
        .result-title { font-weight: 700; font-size: 1.1em; }
        .result-code { font-family: monospace; font-weight: 600; }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            font-size: 0.85em;
        }

        .result-detail-label { color: #666; font-size: 0.8em; }
        .result-detail-value { font-weight: 600; }

        /* Code2 Input */
        .code2-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px dashed var(--error);
            display: none;
        }

        .code2-container.show { display: block; }

        .code2-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn-insertado {
            padding: 12px 20px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-insertado:hover {
            background: #d32f2f;
        }

        /* Columns Container */
        .columns-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            flex: 1;
            min-height: 0;
        }

        .column {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .column-title {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .column-count {
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
        }

        .column.ok .column-title { color: var(--success); }
        .column.ok .column-count { background: rgba(76, 175, 80, 0.15); color: var(--success); }

        .column.blocked .column-title { color: var(--blocked); }
        .column.blocked .column-count { background: rgba(249, 115, 22, 0.15); color: var(--blocked); }

        .column.nowms .column-title { color: var(--error); }
        .column.nowms .column-count { background: rgba(244, 67, 54, 0.15); color: var(--error); }

        .column-pallet-info {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.8em;
        }

        .column-pallet-code {
            font-family: monospace;
            font-weight: 600;
            color: var(--primary);
        }

        .column-location-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
            margin-top: 6px;
        }

        .column-send-btn {
            margin-top: 8px;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 0.85em;
        }

        .column-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .column.ok .column-send-btn { background: var(--success); color: white; }
        .column.blocked .column-send-btn { background: var(--blocked); color: white; }
        .column.nowms .column-send-btn { background: var(--error); color: white; }

        .column-list {
            flex: 1;
            overflow-y: auto;
            counter-reset: item-counter;
        }

        .box-item {
            padding: 8px 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid;
            counter-increment: item-counter;
        }

        .box-item::before {
            content: counter(item-counter) ".";
            font-weight: 700;
            min-width: 25px;
            margin-right: 8px;
        }

        .column.ok .box-item { border-color: var(--success); }
        .column.ok .box-item::before { color: var(--success); }

        .column.blocked .box-item { border-color: var(--blocked); }
        .column.blocked .box-item::before { color: var(--blocked); }

        .column.nowms .box-item { border-color: var(--error); }
        .column.nowms .box-item::before { color: var(--error); }

        .box-info { flex: 1; }
        .box-code { font-weight: 600; font-family: monospace; font-size: 0.9em; }
        .box-meta { font-size: 0.75em; color: #666; }

        .box-delete {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1.1em;
            padding: 4px;
            opacity: 0.6;
        }

        .box-delete:hover { opacity: 1; }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #999;
        }

        .empty-icon { font-size: 2.5em; margin-bottom: 8px; opacity: 0.5; }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-google { background: #4285F4; color: white; }

        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        .btn-full { width: 100%; }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .notification {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }

        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Popups */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-overlay.show { display: flex; }

        .popup-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .popup-header {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .popup-close:hover { color: #333; }

        .popup-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        /* Resumen Module */
        .resumen-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .resumen-stat {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f5f5f5;
        }

        .resumen-stat-number {
            font-size: 2em;
            font-weight: 700;
        }

        .resumen-stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .resumen-stat.ok { border: 2px solid var(--success); }
        .resumen-stat.ok .resumen-stat-number { color: var(--success); }

        .resumen-stat.blocked { border: 2px solid var(--blocked); }
        .resumen-stat.blocked .resumen-stat-number { color: var(--blocked); }

        .resumen-stat.nowms { border: 2px solid var(--error); }
        .resumen-stat.nowms .resumen-stat-number { color: var(--error); }

        .resumen-stat.pending { border: 2px solid var(--warning); }
        .resumen-stat.pending .resumen-stat-number { color: var(--warning); }

        .resumen-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .resumen-table th, .resumen-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .resumen-table th {
            background: #f5f5f5;
            font-weight: 700;
            position: sticky;
            top: 0;
        }

        .resumen-table-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .resumen-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .hidden { display: none !important; }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            flex-direction: column;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            text-align: center;
            max-width: 300px;
        }

        .loading-subtext {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            margin-top: 8px;
            text-align: center;
        }

        /* Cabecera Principal de Escaneo */
        .scan-header-bar {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
            flex-wrap: wrap;
        }

        .origin-location-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .origin-location-group label {
            color: white;
            font-weight: 600;
            font-size: 0.8em;
            white-space: nowrap;
        }

        .origin-location-input {
            width: 140px;
            padding: 8px 10px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.2s;
        }

        .origin-location-input:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.4);
        }

        .origin-location-input::placeholder {
            color: #a0aec0;
            font-weight: 400;
            font-size: 0.85em;
        }

        /* Contador Global de Cajas */
        .global-counter {
            background: rgba(0, 0, 0, 0.25);
            padding: 6px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .global-counter-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.8em;
            font-weight: 500;
        }

        .global-counter-value {
            background: white;
            color: #f97316;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1em;
            min-width: 32px;
            text-align: center;
        }

        /* Box Item mejorado con acciones hover */
        .box-item {
            padding: 6px 8px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            border-left: 3px solid;
            counter-increment: item-counter;
            position: relative;
            transition: all 0.15s;
        }

        .box-item:hover {
            background: #f0f0f0;
        }

        .box-item::before {
            content: counter(item-counter) ".";
            font-weight: 700;
            min-width: 20px;
            margin-right: 6px;
            font-size: 0.8em;
        }

        .box-info { flex: 1; min-width: 0; }
        .box-code { font-weight: 600; font-family: monospace; font-size: 0.8em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .box-meta { font-size: 0.7em; color: #666; }

        .box-actions {
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .box-item:hover .box-actions {
            opacity: 1;
        }

        .box-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85em;
            padding: 3px 5px;
            border-radius: 4px;
            opacity: 0.6;
            transition: all 0.15s;
        }

        .box-action-btn:hover {
            opacity: 1;
            background: rgba(0,0,0,0.08);
        }

        .box-action-btn.copy { color: var(--primary); border: 1px solid var(--primary); background: rgba(249, 115, 22, 0.08); }
        .box-action-btn.move { color: var(--warning); border: 1px solid var(--warning); background: rgba(255, 193, 7, 0.08); }
        .box-action-btn.check { color: var(--success); border: 1px solid var(--success); background: rgba(76, 175, 80, 0.08); }
        .box-action-btn.delete { color: var(--error); border: 1px solid var(--error); background: rgba(244, 67, 54, 0.08); }
        .box-action-btn:hover { transform: scale(1.1); filter: brightness(1.1); }

        .box-item.verified {
            background: rgba(76, 175, 80, 0.12);
        }

        .box-item.verified .box-check-icon {
            color: var(--success);
        }

        /* Scan Section Compacta */
        .scan-section {
            background: white;
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .scan-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 1.1em;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            background: #fff5ed;
            transition: all 0.2s;
        }

        /* Result Box Compacto Horizontal */
        .result-box {
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            display: none;
            animation: fadeIn 0.2s;
        }

        .result-box.show { display: block; }

        .result-compact {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .result-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 0.95em;
        }

        .result-status .icon { font-size: 1.1em; }

        .result-info {
            display: flex;
            gap: 15px;
            flex: 1;
            flex-wrap: wrap;
            font-size: 0.8em;
        }

        .result-info-item {
            display: flex;
            gap: 4px;
        }

        .result-info-label { color: #666; }
        .result-info-value { font-weight: 600; font-family: monospace; }

        /* Modal de Detalle de Pallet */
        .pallet-detail-modal {
            max-width: 1200px;
            width: 95vw;
        }

        .pallet-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .pallet-detail-counters {
            display: flex;
            gap: 10px;
        }

        .counter-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .counter-badge.ok { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        .counter-badge.pending { background: rgba(244, 67, 54, 0.15); color: var(--error); }

        .pallet-detail-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .pallet-detail-filters input,
        .pallet-detail-filters select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .pallet-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .pallet-detail-table th {
            background: #f5f5f5;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
        }

        .pallet-detail-table th:hover {
            background: #eee;
        }

        .pallet-detail-table th .sort-icon {
            margin-left: 4px;
            opacity: 0.5;
        }

        .pallet-detail-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
        }

        .pallet-detail-table tr:hover {
            background: #f9f9f9;
        }

        .pallet-detail-table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Popup Duplicado */
        .duplicate-popup {
            max-width: 420px;
        }

        .duplicate-info {
            background: #fff3e0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid var(--warning);
        }

        .duplicate-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .duplicate-info-label { color: #666; }
        .duplicate-info-value { font-weight: 600; }

        /* Pre-validaciÃ³n EnvÃ­o */
        .send-validation-popup {
            max-width: 380px;
        }

        .validation-input-group {
            margin-bottom: 15px;
        }

        .validation-input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .validation-input-group input {
            width: 100%;
            padding: 12px;
            font-size: 1.5em;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-weight: 700;
        }

        .validation-mismatch {
            background: #ffebee;
            border: 2px solid var(--error);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            color: var(--error);
            font-weight: 600;
            margin-bottom: 15px;
        }

        .validation-match {
            background: #e8f5e9;
            border: 2px solid var(--success);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            color: var(--success);
            font-weight: 600;
            margin-bottom: 15px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 180px; }
            .columns-container { grid-template-columns: 1fr; }
            .resumen-stats { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; max-height: 200px; }
        }

        /* ==================== UNIFIED CAPTURE MODULE STYLES ==================== */

        /* Tab System */
        .unified-tabs-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f0f0f0;
            border-radius: 10px 10px 0 0;
            overflow-x: auto;
            min-height: 48px;
        }

        .unified-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px 8px 0 0;
            border-bottom: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.2s;
            white-space: nowrap;
            position: relative;
            margin-bottom: -2px;
        }

        .unified-tab:hover {
            background: #f9f9f9;
        }

        .unified-tab.active {
            background: #f97316;
            color: white;
            border-color: #f97316;
        }

        .unified-tab .tab-count {
            background: rgba(0,0,0,0.15);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .unified-tab.active .tab-count {
            background: rgba(255,255,255,0.3);
        }

        .unified-tab .tab-close {
            background: none;
            border: none;
            color: currentColor;
            cursor: pointer;
            font-size: 1.1em;
            padding: 0 2px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .unified-tab .tab-close:hover {
            opacity: 1;
        }

        .unified-tab-new {
            padding: 8px 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .unified-tab-new:hover {
            background: #43a047;
            transform: translateY(-1px);
        }

        .unified-tab-new:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Empty State for Tabs */
        .unified-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            background: white;
            border-radius: 0 0 12px 12px;
            min-height: 400px;
        }

        .unified-empty-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.4;
        }

        .unified-empty-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }

        .unified-empty-btn {
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .unified-empty-btn:hover {
            background: #43a047;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        /* Unified Main Content */
        .unified-content {
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Unified Pallet View */
        .unified-pallet {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .unified-pallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .unified-pallet-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .unified-pallet-id {
            font-family: monospace;
            font-weight: 700;
            font-size: 1.1em;
            color: var(--primary);
        }

        .unified-status-badges {
            display: flex;
            gap: 8px;
        }

        .unified-status-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.85em;
        }

        .unified-status-badge.ok {
            background: rgba(76, 175, 80, 0.15);
            color: var(--success);
        }

        .unified-status-badge.blocked {
            background: rgba(249, 115, 22, 0.15);
            color: var(--blocked);
        }

        .unified-status-badge.nowms {
            background: rgba(244, 67, 54, 0.15);
            color: var(--error);
        }

        .unified-pallet-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .unified-location-input {
            width: 208px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .unified-location-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .unified-send-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4CAF50, #43a047);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.95em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .unified-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .unified-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Cancelados Toggle Switch */
        .cancelados-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 12px;
            background: #f5f5f5;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            user-select: none;
        }

        .cancelados-toggle:hover {
            border-color: #ff5722;
            background: #fff3e0;
        }

        .cancelados-toggle input[type="checkbox"] {
            display: none;
        }

        .cancelados-slider {
            width: 40px;
            height: 22px;
            background: #ccc;
            border-radius: 11px;
            position: relative;
            transition: all 0.3s ease;
        }

        .cancelados-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .cancelados-toggle input:checked + .cancelados-slider {
            background: linear-gradient(135deg, #ff5722, #e64a19);
        }

        .cancelados-toggle input:checked + .cancelados-slider::before {
            left: 20px;
        }

        .cancelados-text {
            font-weight: 600;
            font-size: 0.85em;
            color: #666;
            transition: color 0.3s ease;
        }

        .cancelados-toggle input:checked ~ .cancelados-text {
            color: #ff5722;
        }

        .cancelados-toggle.active {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-color: #ff5722;
        }

        /* Cancelados Mode Indicator Badge */
        .cancelados-mode-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: linear-gradient(135deg, #ff5722, #e64a19);
            color: white;
            font-size: 0.7em;
            font-weight: 700;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: pulse-cancel 2s infinite;
        }

        @keyframes pulse-cancel {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Badge on each box entry when in cancelados mode */
        .unified-log-entry.cancelado-mode {
            border-left: 4px solid #ff5722 !important;
            background: linear-gradient(90deg, rgba(255, 87, 34, 0.08) 0%, transparent 30%);
        }

        .unified-log-entry .cancelado-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            background: linear-gradient(135deg, #ff5722, #e64a19);
            color: white;
            font-size: 0.65em;
            font-weight: 700;
            border-radius: 3px;
            text-transform: uppercase;
            margin-left: 8px;
        }

        /* Header indicator when cancelados mode is active */
        .cancelados-active-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #ff5722, #e64a19);
            color: white;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 700;
            animation: pulse-cancel 2s infinite;
        }

        .cancelados-active-indicator::before {
            content: 'ðŸš«';
        }

        /* Unified List */
        .unified-list-container {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
        }

        .unified-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .unified-box-item {
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            border-left: 4px solid;
            transition: all 0.15s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .unified-box-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .unified-box-item.ok { border-left-color: var(--success); }
        .unified-box-item.blocked { border-left-color: var(--blocked); }
        .unified-box-item.nowms { border-left-color: var(--error); }

        /* Cancelado mode styling for unified box items */
        .unified-box-item.cancelado-mode {
            border-left: 4px solid #ff5722 !important;
            background: linear-gradient(90deg, rgba(255, 87, 34, 0.1) 0%, rgba(255, 87, 34, 0.02) 30%, transparent 50%);
        }

        .unified-box-item .cancelado-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            background: linear-gradient(135deg, #ff5722, #e64a19);
            color: white;
            font-size: 0.7em;
            font-weight: 700;
            border-radius: 4px;
            text-transform: uppercase;
            margin-left: 10px;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 3px rgba(255, 87, 34, 0.3);
        }

        .unified-box-num {
            font-weight: 700;
            min-width: 30px;
            color: inherit;
        }

        .unified-box-item.ok .unified-box-num { color: var(--success); }
        .unified-box-item.blocked .unified-box-num { color: var(--blocked); }
        .unified-box-item.nowms .unified-box-num { color: var(--error); }

        .unified-box-status-icon {
            font-size: 1.1em;
            margin-right: 10px;
        }

        .unified-box-info {
            flex: 1;
            min-width: 0;
        }

        .unified-box-code {
            font-weight: 600;
            font-family: monospace;
            font-size: 0.95em;
        }

        .unified-box-meta {
            font-size: 0.75em;
            color: #666;
        }

        .unified-box-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .unified-box-item:hover .unified-box-actions {
            opacity: 1;
        }

        /* Scan Log */
        .unified-scan-log {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 10px;
            margin-top: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .unified-scan-log-title {
            color: #888;
            font-size: 0.75em;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .unified-log-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-family: monospace;
            margin-bottom: 4px;
            animation: logSlideIn 0.2s ease-out;
        }

        @keyframes logSlideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .unified-log-entry.ok { background: rgba(76, 175, 80, 0.15); color: #a5d6a7; }
        .unified-log-entry.blocked { background: rgba(249, 115, 22, 0.15); color: #ffcc80; }
        .unified-log-entry.nowms { background: rgba(244, 67, 54, 0.15); color: #ef9a9a; }

        .unified-log-time {
            color: #888;
            font-size: 0.9em;
        }

        .unified-log-code {
            flex: 1;
            font-weight: 600;
        }

        .unified-log-status {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .unified-log-entry.ok .unified-log-status { background: var(--success); color: white; }
        .unified-log-entry.blocked .unified-log-status { background: var(--blocked); color: white; }
        .unified-log-entry.nowms .unified-log-status { background: var(--error); color: white; }


        /* Module Visibility Control */
        .module-hidden {
            display: none !important;
        }

        .module-visible {
            display: flex !important;
        }

        /* Unified Module Container */
        .unified-module-container {
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .unified-module-container.module-visible {
            display: flex !important;
        }

        /* Classic Module when visible */
        #classic-module.module-visible {
            display: block !important;
        }

        /* Welcome State - No active sessions */
        .welcome-state {
            flex: 1;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            margin: 10px 0;
        }

        .welcome-state.module-visible {
            display: flex !important;
        }

        .welcome-content {
            text-align: center;
            padding: 40px;
            max-width: 400px;
        }

        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        .welcome-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 16px;
        }

        .welcome-text {
            font-size: 0.95em;
            color: #888;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .welcome-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }

        .welcome-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5);
        }

        /* Work Type Selection Popup - Professional Design */
        .work-type-popup {
            max-width: 420px;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
        }

        .work-type-toggle-container {
            display: flex;
            background: #f1f3f5;
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }

        .work-type-toggle-btn {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .work-type-toggle-btn:hover:not(.active) {
            background: rgba(255, 152, 0, 0.1);
            color: #f57c00;
        }

        .work-type-toggle-btn.active {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
            transform: scale(1.02);
        }

        .work-type-toggle-btn .toggle-icon {
            font-size: 1.2em;
        }

        .work-type-description {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            min-height: 80px;
            transition: all 0.3s ease;
        }

        .work-type-description-title {
            font-weight: 700;
            font-size: 1em;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .work-type-description-text {
            font-size: 0.85em;
            color: #666;
            line-height: 1.5;
        }

        .work-type-locked {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.08) 0%, rgba(255, 152, 0, 0.15) 100%);
            border: 1px solid rgba(255, 152, 0, 0.3);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 0.8em;
            color: #e65100;
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .work-type-confirm-btn {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .work-type-confirm-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        .work-type-confirm-btn:disabled {
            background: #ccc;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* Blind Count - blur counters when validation popup opens */
        .blind-mode .global-counter-value,
        .blind-mode .column-count,
        .blind-mode .unified-status-badge,
        .blind-mode .tab-count,
        .blind-mode #ok-count,
        .blind-mode #blocked-count,
        .blind-mode #nowms-count,
        .blind-mode #unified-global-box-count,
        .blind-mode #unified-ok-count,
        .blind-mode #unified-blocked-count,
        .blind-mode #unified-nowms-count,
        .blind-mode .sidebar-pallet-count,
        .blind-mode #sidebar-ok-count,
        .blind-mode #sidebar-blocked-count,
        .blind-mode #sidebar-nowms-count {
            filter: blur(8px);
            user-select: none;
        }

        /* Global Summary in Sidebar - Vertical Professional Design */
        .global-summary-section {
            background: linear-gradient(180deg, #3a3a3a 0%, #2d2d2d 100%);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .global-summary-title {
            font-size: 0.7em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 12px;
            text-align: center;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .global-summary-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .global-summary-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: linear-gradient(135deg, #444 0%, #3a3a3a 100%);
            border-radius: 8px;
            border-left: 4px solid;
            transition: all 0.2s ease;
        }

        .global-summary-item:hover {
            transform: translateX(3px);
        }

        .global-summary-item.ok { border-left-color: var(--success); }
        .global-summary-item.blocked { border-left-color: var(--blocked); }
        .global-summary-item.nowms { border-left-color: var(--error); }

        .global-summary-label {
            font-size: 0.85em;
            color: #ccc;
            font-weight: 500;
        }

        .global-summary-count {
            font-size: 1.4em;
            font-weight: 700;
            line-height: 1;
            min-width: 40px;
            text-align: right;
        }

        .global-summary-count.ok { color: var(--success); }
        .global-summary-count.blocked { color: var(--blocked); }
        .global-summary-count.nowms { color: var(--error); }

        .global-summary-total {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            padding: 14px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .global-summary-total-label {
            font-size: 0.85em;
            color: rgba(255,255,255,0.9);
            font-weight: 600;
        }

        .global-summary-total-count {
            font-size: 1.6em;
            font-weight: 700;
            color: white;
        }
    </style>
</head>
<body>
    <div class="connection-banner" id="connection-banner"></div>
    <div class="notification-container" id="notifications"></div>

    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ðŸ“¦ Cargando Inventario...</div>
        <div class="loading-subtext">Descargando base de datos desde Google Sheets</div>
    </div>

    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-icon">ðŸ“¦</div>
            <h1 class="login-title">Sistema Inventario</h1>
            <p class="login-subtitle">Control y gestiÃ³n de mercancÃ­a</p>
            <button class="btn btn-google btn-full" onclick="handleLogin()" style="padding: 15px; font-size: 1.1em;">
                ðŸ” Iniciar sesiÃ³n con Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <div class="main-container">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>ðŸ“¦ Inventario</h2>
                    <p>Sistema de gestiÃ³n</p>
                </div>

                <!-- Sync Status -->
                <div id="sync-status" class="sync-status sync-ok" onclick="SyncManager.showPanel()">
                    âœ… Sincronizado
                </div>

                <!-- Menu -->
                <div class="sidebar-section">
                    <button class="sidebar-btn sidebar-btn-primary" onclick="showResumen()">
                        ðŸ“Š Resumen
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="showWorkTypePopup()" id="new-session-btn">
                        âž• Nuevo
                    </button>
                    <button class="sidebar-btn sidebar-btn-secondary" onclick="exportData()">
                        ðŸ“¥ Exportar
                    </button>
                </div>

                <!-- Global Summary by Status -->
                <div class="global-summary-section" id="global-summary-section">
                    <div class="global-summary-title">Resumen Global</div>
                    <div class="global-summary-grid">
                        <div class="global-summary-item ok">
                            <div class="global-summary-label">âœ… OK</div>
                            <div class="global-summary-count ok" id="global-summary-ok">0</div>
                        </div>
                        <div class="global-summary-item blocked">
                            <div class="global-summary-label">âš ï¸ Bloqueado</div>
                            <div class="global-summary-count blocked" id="global-summary-blocked">0</div>
                        </div>
                        <div class="global-summary-item nowms">
                            <div class="global-summary-label">âŒ No WMS</div>
                            <div class="global-summary-count nowms" id="global-summary-nowms">0</div>
                        </div>
                    </div>
                    <div class="global-summary-total">
                        <div class="global-summary-total-label">ðŸ“¦ Total Cajas</div>
                        <div class="global-summary-total-count" id="global-summary-total">0</div>
                    </div>
                </div>

                <!-- User Footer -->
                <div class="user-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar" onclick="changeUserAlias()">?</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name-display" onclick="changeUserAlias()">No conectado</div>
                            <div class="connection-indicator">
                                <div class="connection-dot" id="connection-dot"></div>
                                <span id="connection-text">Offline</span>
                            </div>
                        </div>
                    </div>
                    <div class="user-footer-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshInventory()">ðŸ”„ BD</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleConnection()" id="sidebar-auth-btn">ðŸ”—</button>
                        <button class="btn btn-danger btn-small" onclick="handleLogout()">ðŸšª</button>
                    </div>
                    <div class="bd-info">
                        <div><span id="bd-count">0</span> cÃ³digos cargados</div>
                        <div id="bd-update-time">Sin actualizar</div>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- GLOBAL TABS SYSTEM -->
                <div class="unified-tabs-container" id="global-tabs-container">
                    <button class="unified-tab-new" id="global-new-tab-btn" onclick="showWorkTypePopup()">
                        âž• Nuevo
                    </button>
                </div>

                <!-- WELCOME STATE - No active sessions -->
                <div id="welcome-state" class="welcome-state module-visible">
                    <div class="welcome-content">
                        <div class="welcome-icon">ðŸ“¦</div>
                        <h2 class="welcome-title">Â¡Bienvenido al Sistema de Inventario!</h2>
                        <p class="welcome-subtitle">No tienes sesiones activas</p>
                        <p class="welcome-text">Crea una nueva sesiÃ³n para comenzar a escanear y clasificar tu inventario.</p>
                        <button class="welcome-btn" onclick="showWorkTypePopup()">
                            âž• Crear Nueva SesiÃ³n
                        </button>
                    </div>
                </div>

                <!-- CLASSIC MODULE -->
                <div id="classic-module" class="module-hidden">
                    <!-- Cabecera Principal con UbicaciÃ³n y Contador -->
                    <div class="scan-header-bar">
                    <div class="origin-location-group">
                        <label>ðŸ“ Origen:</label>
                        <input type="text" class="origin-location-input" id="origin-location"
                               placeholder="A21-06-05-01" autocomplete="off"
                               title="UbicaciÃ³n fÃ­sica de origen"
                               onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('scan-input').focus();}">
                    </div>
                    <div class="global-counter">
                        <span class="global-counter-label">Total Cajas:</span>
                        <span class="global-counter-value" id="global-box-count">0</span>
                    </div>
                </div>

                <!-- Scan Section Compacta -->
                <div class="scan-section">
                    <input type="text" class="scan-input" id="scan-input" placeholder="ðŸ” Escanea o ingresa cÃ³digo..." autocomplete="off">

                    <!-- Result Box Compacto -->
                    <div class="result-box" id="result-box">
                        <div class="result-compact">
                            <div class="result-status">
                                <span class="icon" id="result-icon">ðŸ“¦</span>
                                <span id="result-title">Estado</span>
                            </div>
                            <div class="result-info" id="result-details"></div>
                        </div>
                    </div>

                    <!-- Code2 Container Compacto -->
                    <div class="code2-container" id="code2-container">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="color: var(--error); font-weight: 600; font-size: 0.85em;">âš ï¸ No encontrado:</span>
                            <input type="text" class="scan-input" id="code2-input" placeholder="CÃ³digo 2..." autocomplete="off" style="flex: 1; font-size: 1em; padding: 8px;">
                            <button class="btn-insertado" onclick="forceInsert()" style="padding: 8px 14px; font-size: 0.85em;">
                                âš¡ INSERTADO
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Columns -->
                <div class="columns-container">
                    <!-- OK Column -->
                    <div class="column ok">
                        <div class="column-header">
                            <span class="column-title">âœ… OK</span>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span class="counter-badge ok" id="ok-verified-badge" style="display: none;">âœ“ <span id="ok-verified-count">0</span></span>
                                <span class="counter-badge pending" id="ok-pending-badge" style="display: none;">â—‹ <span id="ok-pending-count">0</span></span>
                                <span class="column-count" id="ok-count">0</span>
                                <button class="box-action-btn" onclick="showPalletDetailModal('ok')" title="Ver detalle" style="opacity: 0.7;">â›¶</button>
                            </div>
                        </div>
                        <div class="column-pallet-info">
                            <div>Pallet: <span class="column-pallet-code" id="ok-pallet">-</span></div>
                            <input type="text" class="column-location-input" id="location-ok" placeholder="ðŸ“ UbicaciÃ³n destino...">
                            <button class="column-send-btn" onclick="sendPallet('ok')" id="send-ok-btn" disabled>
                                ðŸ“¤ Enviar Tarima OK
                            </button>
                        </div>
                        <div class="column-list" id="ok-list">
                            <div class="empty-state">
                                <div class="empty-icon">ðŸ“­</div>
                                <div>Sin cajas</div>
                            </div>
                        </div>
                    </div>

                    <!-- Blocked Column -->
                    <div class="column blocked">
                        <div class="column-header">
                            <span class="column-title">âš ï¸ Bloqueado</span>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span class="column-count" id="blocked-count">0</span>
                                <button class="box-action-btn" onclick="showPalletDetailModal('blocked')" title="Ver detalle" style="opacity: 0.7;">â›¶</button>
                            </div>
                        </div>
                        <div class="column-pallet-info">
                            <div>Pallet: <span class="column-pallet-code" id="blocked-pallet">-</span></div>
                            <input type="text" class="column-location-input" id="location-blocked" placeholder="ðŸ“ UbicaciÃ³n destino...">
                            <button class="column-send-btn" onclick="sendPallet('blocked')" id="send-blocked-btn" disabled>
                                ðŸ“¤ Enviar Tarima Bloqueado
                            </button>
                        </div>
                        <div class="column-list" id="blocked-list">
                            <div class="empty-state">
                                <div class="empty-icon">ðŸ“­</div>
                                <div>Sin cajas</div>
                            </div>
                        </div>
                    </div>

                    <!-- No WMS Column -->
                    <div class="column nowms">
                        <div class="column-header">
                            <span class="column-title">âŒ No WMS</span>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span class="column-count" id="nowms-count">0</span>
                                <button class="box-action-btn" onclick="showPalletDetailModal('nowms')" title="Ver detalle" style="opacity: 0.7;">â›¶</button>
                            </div>
                        </div>
                        <div class="column-pallet-info">
                            <div>Pallet: <span class="column-pallet-code" id="nowms-pallet">-</span></div>
                            <input type="text" class="column-location-input" id="location-nowms" placeholder="ðŸ“ UbicaciÃ³n destino...">
                            <button class="column-send-btn" onclick="sendPallet('nowms')" id="send-nowms-btn" disabled>
                                ðŸ“¤ Enviar Tarima No WMS
                            </button>
                        </div>
                        <div class="column-list" id="nowms-list">
                            <div class="empty-state">
                                <div class="empty-icon">ðŸ“­</div>
                                <div>Sin cajas</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div><!-- End Classic Module -->

                <!-- UNIFIED MODULE -->
                <div id="unified-module" class="unified-module-container module-hidden">
                    <!-- Cabecera Principal con UbicaciÃ³n -->
                    <div class="scan-header-bar">
                        <div class="origin-location-group">
                            <label>ðŸ“ Origen:</label>
                            <input type="text" class="origin-location-input" id="unified-origin-location"
                                   placeholder="A21-06-05-01" autocomplete="off"
                                   title="UbicaciÃ³n fÃ­sica de origen"
                                   onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('unified-scan-input').focus();}">
                        </div>
                        <div class="global-counter">
                            <span class="global-counter-label">Total Cajas:</span>
                            <span class="global-counter-value" id="unified-global-box-count">0</span>
                        </div>
                    </div>

                    <!-- Scan Section -->
                    <div class="scan-section">
                        <input type="text" class="scan-input" id="unified-scan-input" placeholder="ðŸ” Escanea o ingresa cÃ³digo..." autocomplete="off">

                        <!-- Result Box -->
                        <div class="result-box" id="unified-result-box">
                            <div class="result-compact">
                                <div class="result-status">
                                    <span class="icon" id="unified-result-icon">ðŸ“¦</span>
                                    <span id="unified-result-title">Estado</span>
                                </div>
                                <div class="result-info" id="unified-result-details"></div>
                            </div>
                        </div>

                        <!-- Code2 Container -->
                        <div class="code2-container" id="unified-code2-container">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="color: var(--error); font-weight: 600; font-size: 0.85em;">âš ï¸ No encontrado:</span>
                                <input type="text" class="scan-input" id="unified-code2-input" placeholder="CÃ³digo 2..." autocomplete="off" style="flex: 1; font-size: 1em; padding: 8px;">
                                <button class="btn-insertado" onclick="unifiedForceInsert()" style="padding: 8px 14px; font-size: 0.85em;">
                                    âš¡ INSERTADO
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Unified Pallet Content -->
                    <div class="unified-content" id="unified-active-content">
                            <div class="unified-pallet">
                                <div class="unified-pallet-header">
                                    <div class="unified-pallet-info">
                                        <span class="unified-pallet-id" id="unified-pallet-id">-</span>
                                        <div class="unified-status-badges">
                                            <span class="unified-status-badge ok">âœ… <span id="unified-ok-count">0</span></span>
                                            <span class="unified-status-badge blocked">âš ï¸ <span id="unified-blocked-count">0</span></span>
                                            <span class="unified-status-badge nowms">âŒ <span id="unified-nowms-count">0</span></span>
                                        </div>
                                    </div>
                                    <div class="unified-pallet-actions">
                                        <input type="text" class="unified-location-input" id="unified-location"
                                               placeholder="ðŸ“ UbicaciÃ³n destino...">
                                        <label class="cancelados-toggle" id="cancelados-toggle-label">
                                            <input type="checkbox" id="unified-cancelados-check" onchange="UnifiedModule.toggleCancelados(this.checked)">
                                            <span class="cancelados-slider"></span>
                                            <span class="cancelados-text">Cancelados</span>
                                        </label>
                                        <button class="unified-send-btn" id="unified-send-btn" onclick="UnifiedModule.sendPallet()" disabled>
                                            ðŸ“¤ Enviar Datos
                                        </button>
                                    </div>
                                </div>

                        <div class="unified-list-container">
                            <div class="unified-list" id="unified-box-list">
                                <div class="empty-state">
                                    <div class="empty-icon">ðŸ“­</div>
                                    <div>Sin cajas escaneadas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div><!-- End Unified Module -->
            </div>
        </div>
    </div>

    <!-- RESUMEN POPUP -->
    <div class="popup-overlay" id="resumen-popup">
        <div class="popup-content">
            <div class="popup-header">
                <span>ðŸ“Š Resumen de SesiÃ³n</span>
                <button class="popup-close" onclick="closeResumen()">Ã—</button>
            </div>

            <div class="resumen-stats">
                <div class="resumen-stat ok">
                    <div class="resumen-stat-number" id="resumen-ok">0</div>
                    <div class="resumen-stat-label">OK</div>
                </div>
                <div class="resumen-stat blocked">
                    <div class="resumen-stat-number" id="resumen-blocked">0</div>
                    <div class="resumen-stat-label">Bloqueado</div>
                </div>
                <div class="resumen-stat nowms">
                    <div class="resumen-stat-number" id="resumen-nowms">0</div>
                    <div class="resumen-stat-label">No WMS</div>
                </div>
                <div class="resumen-stat pending">
                    <div class="resumen-stat-number" id="resumen-pending">0</div>
                    <div class="resumen-stat-label">Pendientes Sync</div>
                </div>
            </div>

            <div class="resumen-actions">
                <button class="btn btn-primary btn-small" onclick="refreshInventory(); closeResumen();">ðŸ”„ Recargar BD</button>
                <button class="btn btn-success btn-small" onclick="SyncManager.sync(); updateResumen();">ðŸ”„ Sincronizar</button>
                <button class="btn btn-secondary btn-small" onclick="exportData();">ðŸ“¥ Exportar</button>
            </div>

            <h3 style="margin-bottom: 10px; font-size: 1em;">ðŸ“‹ Historial Reciente</h3>
            <div class="resumen-table-container">
                <table class="resumen-table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>CÃ³digo</th>
                            <th>CÃ³digo 2</th>
                            <th>Estatus</th>
                            <th>Destino</th>
                            <th>Origen</th>
                            <th>Pallet</th>
                        </tr>
                    </thead>
                    <tbody id="resumen-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            CLIENT_ID: '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile',
            SPREADSHEET_WRITE: '1FBhZloEeT-xTe1yVKzdWxGJa6gKkZQOObmkBMuxqcv8',
            SHEET_NAME: 'BD',  // Nombre de la hoja donde se escriben los datos
            INVENTORY_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-HG8HPf-94Ki5Leo5iEF5pyqsiD9CVk-mcl-F8BAw34kT0s3nzNn532YTYDCtkG76NbauiVx0Ffmd/pub?output=csv'
        };

        // ==================== STATE ====================
        let STATE = {
            inventory: new Map(),
            inventoryLastUpdate: null,
            pallets: {
                ok: { id: generatePalletId('OK'), boxes: [], location: '' },
                blocked: { id: generatePalletId('BLK'), boxes: [], location: '' },
                nowms: { id: generatePalletId('NW'), boxes: [], location: '' }
            },
            pendingCode1: null,
            history: []
        };

        let CURRENT_USER = '';
        let USER_EMAIL = '';
        let USER_GOOGLE_NAME = '';
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];
        let TOKEN_CLIENT = null;
        let audioCtx = null;

        // ==================== SYNC MANAGER ====================
        const SyncManager = {
            inProgress: false,
            retryCount: 0,
            intervalId: null,
            AUTO_SYNC_INTERVAL: 30000,

            init() {
                this.load();
                this.startAutoSync();
                this.setupExitProtection();
                this.updateUI(PENDING_SYNC.length === 0);
            },

            setupExitProtection() {
                window.addEventListener('beforeunload', (e) => {
                    const hasUnsavedData = PENDING_SYNC.length > 0 ||
                        STATE.pallets.ok.boxes.length > 0 ||
                        STATE.pallets.blocked.boxes.length > 0 ||
                        STATE.pallets.nowms.boxes.length > 0;

                    if (hasUnsavedData) {
                        e.preventDefault();
                        e.returnValue = 'Â¡Tienes datos sin sincronizar! Â¿Seguro que quieres salir?';
                        return e.returnValue;
                    }
                });
            },

            startAutoSync() {
                if (this.intervalId) clearInterval(this.intervalId);
                this.intervalId = setInterval(() => {
                    if (IS_ONLINE && gapi?.client?.getToken() && PENDING_SYNC.length > 0) {
                        this.sync(false);
                    }
                }, this.AUTO_SYNC_INTERVAL);
            },

            async sync(showMessages = true) {
                if (this.inProgress) {
                    if (showMessages) showNotification('â³ SincronizaciÃ³n en progreso...', 'info');
                    return { success: false };
                }

                if (!IS_ONLINE) {
                    if (showMessages) showNotification('âš ï¸ Sin conexiÃ³n a internet', 'warning');
                    return { success: false };
                }

                if (!gapi?.client?.getToken()) {
                    if (showMessages) showNotification('âš ï¸ No conectado a Google', 'warning');
                    return { success: false };
                }

                if (PENDING_SYNC.length === 0) {
                    this.updateUI(true);
                    if (showMessages) showNotification('âœ… Todo sincronizado', 'success');
                    return { success: true, synced: 0 };
                }

                return await this._doSync(showMessages);
            },

            async _doSync(showMessages) {
                this.inProgress = true;
                updateConnectionIndicator(true);

                if (showMessages) showNotification('ðŸ”„ Sincronizando...', 'info');

                try {
                    // Columnas: A-J (incluye UbicaciÃ³n FÃ­sica de Origen en columna J)
                    const values = PENDING_SYNC.map(r => [
                        r.date, r.time, r.user, r.scan1, r.scan2,
                        r.location, r.status, r.note, r.pallet, r.originLocation || ''
                    ]);

                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SPREADSHEET_WRITE,
                        range: `${CONFIG.SHEET_NAME}!A:J`,
                        valueInputOption: 'USER_ENTERED',
                        insertDataOption: 'INSERT_ROWS',
                        resource: { values }
                    });

                    const synced = PENDING_SYNC.length;
                    PENDING_SYNC = [];
                    this.save();
                    this.updateUI(true);

                    if (showMessages) showNotification(`âœ… ${synced} registros sincronizados`, 'success');
                    return { success: true, synced };
                } catch (e) {
                    console.error('Sync error:', e);
                    this.updateUI(false);
                    if (showMessages) showNotification(`âŒ Error: ${e.result?.error?.message || e.message || 'Error desconocido'}`, 'error');
                    return { success: false };
                } finally {
                    this.inProgress = false;
                    updateConnectionIndicator();
                }
            },

            async save() {
                try {
                    localStorage.setItem('pd_pending_sync', JSON.stringify(PENDING_SYNC));
                } catch (e) {}
            },

            async load() {
                try {
                    const saved = localStorage.getItem('pd_pending_sync');
                    if (saved) PENDING_SYNC = JSON.parse(saved);
                } catch (e) {}
            },

            updateUI(synced) {
                const el = document.getElementById('sync-status');
                if (!el) return;

                if (!IS_ONLINE) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `âš ï¸ Sin conexiÃ³n${PENDING_SYNC.length > 0 ? ` (${PENDING_SYNC.length})` : ''}`;
                } else if (PENDING_SYNC.length > 0) {
                    el.className = 'sync-status sync-warning';
                    el.innerHTML = `â³ ${PENDING_SYNC.length} pendientes`;
                } else if (synced) {
                    el.className = 'sync-status sync-ok';
                    el.textContent = 'âœ… Sincronizado';
                } else {
                    el.className = 'sync-status sync-error';
                    el.textContent = 'âŒ Error sync';
                }
            },

            showPanel() {
                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay show';
                overlay.innerHTML = `
                    <div class="popup-content" style="max-width: 450px;">
                        <div class="popup-header">
                            <span>ðŸ“Š Estado de SincronizaciÃ³n</span>
                            <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">Ã—</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px; text-align: center;">
                                <div style="font-size: 0.85em; color: #666;">Pendientes de sincronizar</div>
                                <div style="font-size: 2em; font-weight: 700; color: ${PENDING_SYNC.length > 0 ? 'var(--warning)' : 'var(--success)'};">
                                    ${PENDING_SYNC.length}
                                </div>
                            </div>
                            <div style="font-size: 0.9em; padding: 10px; background: #f9f9f9; border-radius: 6px;">
                                ${IS_ONLINE ? 'ðŸŸ¢ Conectado a internet' : 'ðŸ”´ Sin conexiÃ³n'}<br>
                                ${gapi?.client?.getToken() ? 'ðŸŸ¢ Google conectado' : 'ðŸ”´ Google desconectado'}<br>
                                ðŸ“„ Hoja destino: <strong>${CONFIG.SHEET_NAME}</strong>
                            </div>
                        </div>
                        <div class="popup-buttons">
                            ${PENDING_SYNC.length > 0 && IS_ONLINE && gapi?.client?.getToken() ? `
                                <button class="btn btn-success btn-full" onclick="this.closest('.popup-overlay').remove(); SyncManager.sync();">
                                    ðŸ”„ Sincronizar Ahora
                                </button>
                            ` : ''}
                            <button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">
                                Cerrar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) overlay.remove();
                });
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            initAudio();
            loadFromStorage();
            setupEventListeners();
            setupConnectionMonitor();
            gapi.load('client', initGAPI);
        });

        function initAudio() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.addEventListener('click', () => {
                    if (audioCtx?.state === 'suspended') audioCtx.resume();
                }, { once: true });
            } catch (e) {}
        }

        async function initGAPI() {
            try {
                await gapi.client.init({
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
                });
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: handleAuthCallback
                });
            } catch (e) {
                showNotification('Error inicializando API', 'error');
            }
        }

        async function handleAuthCallback(response) {
            if (response?.access_token) {
                gapi.client.setToken(response);
                await getUserProfile();
                await loadInventory();
                SyncManager.init();
                if (PENDING_SYNC.length > 0) SyncManager.sync();
                showApp();
            }
        }

        function handleLogin() {
            TOKEN_CLIENT?.requestAccessToken();
        }

        async function getUserProfile() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` }
                });
                const data = await response.json();
                USER_EMAIL = data.email || '';
                USER_GOOGLE_NAME = data.name || 'Usuario';

                const savedAlias = localStorage.getItem(`pd_alias_${USER_EMAIL}`);
                if (savedAlias) {
                    CURRENT_USER = savedAlias;
                    showNotification(`âœ… Bienvenido, ${CURRENT_USER}`, 'success');
                    updateUserFooter();
                } else {
                    showAliasPopup();
                }
            } catch (e) {
                CURRENT_USER = 'Usuario';
                updateUserFooter();
            }
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateUserFooter();
            GlobalTabs.init();
            // Only update UI and focus if there are active tabs
            if (GlobalTabs.tabs.length > 0) {
                updateUI();
            }
        }

        function handleLogout() {
            const hasData = PENDING_SYNC.length > 0 ||
                STATE.pallets.ok.boxes.length > 0 ||
                STATE.pallets.blocked.boxes.length > 0 ||
                STATE.pallets.nowms.boxes.length > 0;

            if (hasData) {
                if (!confirm('âš ï¸ Tienes datos sin sincronizar. Â¿Seguro que quieres salir?')) {
                    return;
                }
            }

            if (gapi.client.getToken()) {
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                gapi.client.setToken(null);
            }

            CURRENT_USER = '';
            USER_EMAIL = '';
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        // ==================== ALIAS/NICKNAME SYSTEM ====================
        function showAliasPopup() {
            document.querySelectorAll('.alias-popup').forEach(e => e.remove());

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show alias-popup';
            overlay.innerHTML = `
                <div class="popup-content" style="max-width: 400px;">
                    <div class="popup-header">ðŸ‘¤ Â¿CÃ³mo te llamamos?</div>
                    <p style="margin-bottom: 15px; color: #666;">
                        Hola <strong>${USER_GOOGLE_NAME}</strong>, elige cÃ³mo aparecerÃ¡ tu nombre en los registros:
                    </p>
                    <div class="popup-buttons">
                        <button class="btn btn-primary btn-full" onclick="saveUserAlias('${USER_GOOGLE_NAME}', true)">
                            ðŸ‘¤ Usar mi nombre de Google
                        </button>
                        <div style="text-align: center; color: #999; font-size: 0.85em;">o</div>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="alias-input" placeholder="Escribe un alias..."
                                style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em;"
                                maxlength="20">
                            <button class="btn btn-success" onclick="saveUserAlias(document.getElementById('alias-input').value)">
                                ðŸ’¾
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            const input = overlay.querySelector('#alias-input');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    saveUserAlias(input.value);
                }
            });
            input.focus();
        }

        function saveUserAlias(alias, isGoogleName = false) {
            const finalAlias = alias?.trim() || USER_GOOGLE_NAME;
            if (!finalAlias) {
                showNotification('âš ï¸ Ingresa un nombre vÃ¡lido', 'warning');
                return;
            }

            CURRENT_USER = finalAlias;
            localStorage.setItem(`pd_alias_${USER_EMAIL}`, finalAlias);

            document.querySelectorAll('.alias-popup').forEach(e => e.remove());
            showNotification(`âœ… ${isGoogleName ? 'Nombre' : 'Alias'} guardado: ${finalAlias}`, 'success');
            updateUserFooter();
        }

        function changeUserAlias() {
            showAliasPopup();
        }

        function updateUserFooter() {
            const avatar = document.getElementById('user-avatar');
            const nameDisplay = document.getElementById('user-name-display');

            if (avatar) {
                avatar.textContent = CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : '?';
                avatar.title = USER_EMAIL || 'No conectado';
            }
            if (nameDisplay) {
                nameDisplay.textContent = CURRENT_USER || 'No conectado';
                nameDisplay.title = `Click para cambiar alias\n${USER_EMAIL}`;
            }

            updateConnectionIndicator();
        }

        // ==================== INVENTORY ====================
        function showLoadingOverlay(show = true) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                if (show) {
                    overlay.classList.add('show');
                } else {
                    overlay.classList.remove('show');
                }
            }
        }

        async function loadInventory() {
            try {
                showLoadingOverlay(true);
                updateConnectionIndicator(true);

                const response = await fetch(CONFIG.INVENTORY_CSV_URL, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const csv = await response.text();
                if (!csv || csv.trim().length === 0) throw new Error('CSV vacÃ­o');

                parseInventoryCSV(csv);
                await saveToStorage();
                showNotification(`âœ… ${STATE.inventory.size} cÃ³digos cargados`, 'success');
                updateBdInfo();
            } catch (e) {
                console.error('Error cargando inventario:', e);
                showNotification(`âš ï¸ ${e.message}`, 'warning');

                if (STATE.inventory.size > 0) {
                    showNotification(`Usando ${STATE.inventory.size} cÃ³digos en cachÃ©`, 'info');
                }
            } finally {
                showLoadingOverlay(false);
                updateConnectionIndicator();
            }
        }

        function parseInventoryCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim().length > 0);
            STATE.inventory.clear();

            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);

                if (cols.length >= 11) {
                    const code = (cols[1] || '').toString().trim().toUpperCase();

                    if (code && code.length > 0) {
                        const availableStock = parseFloat(cols[9]) || 0;
                        const lockedInventory = parseFloat(cols[10]) || 0;

                        STATE.inventory.set(code, {
                            code,
                            boxType: cols[0] || '',
                            warehouse: cols[3] || '',
                            cellNo: cols[6] || '',  // Columna G (Ã­ndice 6)
                            area: cols[8] || '',
                            availableStock,
                            lockedInventory,
                            sku: cols[12] || '',
                            productName: cols[13] || '',
                            isAvailable: availableStock > 0,
                            isBlocked: lockedInventory > 0
                        });
                    }
                }
            }

            STATE.inventoryLastUpdate = new Date().toLocaleString();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function refreshInventory() {
            loadInventory();
        }

        function updateBdInfo() {
            document.getElementById('bd-count').textContent = STATE.inventory.size.toLocaleString();
            document.getElementById('bd-update-time').textContent = STATE.inventoryLastUpdate || 'Sin actualizar';
        }

        // ==================== SCAN PROCESSING ====================
        function setupEventListeners() {
            const scanInput = document.getElementById('scan-input');
            scanInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && scanInput.value.trim()) {
                    e.preventDefault();
                    processScan(scanInput.value.trim());
                    scanInput.value = '';  // Limpiar automÃ¡ticamente
                }
            });

            const code2Input = document.getElementById('code2-input');
            code2Input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && code2Input.value.trim()) {
                    e.preventDefault();
                    processCode2(code2Input.value.trim());
                    code2Input.value = '';  // Limpiar automÃ¡ticamente
                }
            });
        }

        function processScan(rawCode) {
            const code = normalizeCode(rawCode);

            // Check duplicates across all pallets con info detallada
            const duplicateInfo = findDuplicate(code);

            if (duplicateInfo) {
                showDuplicatePopup(code, duplicateInfo, rawCode);
                flashInput('warning');
                playSound('warning');
                return;
            }

            const item = STATE.inventory.get(code);

            if (!item) {
                // Not found - show Code2 input
                STATE.pendingCode1 = { raw: rawCode, code };
                showResultBox('error', code, 'NO ENCONTRADO',
                    'CÃ³digo no encontrado en WMS. Ingresa CÃ³digo 2 o usa INSERTADO.', null);
                document.getElementById('code2-container').classList.add('show');
                flashInput('error');
                playSound('error');
                setTimeout(() => document.getElementById('code2-input').focus(), 100);
                return;
            }

            // Hide code2 container
            document.getElementById('code2-container').classList.remove('show');
            STATE.pendingCode1 = null;

            // Determine status and add to appropriate pallet
            if (item.isBlocked) {
                addBox('blocked', createBoxData(rawCode, code, '', item));
                showResultBox('blocked', code, 'BLOQUEADO', 'Inventario bloqueado', item);
                playSound('warning');
            } else if (item.isAvailable) {
                addBox('ok', createBoxData(rawCode, code, '', item));
                showResultBox('success', code, 'OK', 'Validado correctamente', item);
                playSound('success');
            } else {
                addBox('blocked', createBoxData(rawCode, code, '', item));
                showResultBox('blocked', code, 'SIN STOCK', 'Sin stock disponible', item);
                playSound('warning');
            }

            flashInput('success');
        }

        // Buscar duplicado con informaciÃ³n detallada
        function findDuplicate(code) {
            const categories = ['ok', 'blocked', 'nowms'];
            const categoryNames = { ok: 'OK', blocked: 'Bloqueado', nowms: 'No WMS' };

            for (const cat of categories) {
                const boxes = STATE.pallets[cat].boxes;
                const index = boxes.findIndex(b => b.code === code);
                if (index !== -1) {
                    const box = boxes[index];
                    return {
                        category: cat,
                        categoryName: categoryNames[cat],
                        index,
                        box,
                        timestamp: box.timestamp,
                        user: CURRENT_USER
                    };
                }
            }
            return null;
        }

        // Mostrar popup de duplicado con opciÃ³n de ingreso forzado
        function showDuplicatePopup(code, duplicateInfo, rawCode) {
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show';
            overlay.innerHTML = `
                <div class="popup-content duplicate-popup">
                    <div class="popup-header">
                        <span>âš ï¸ CÃ³digo Duplicado</span>
                        <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">Ã—</button>
                    </div>
                    <div class="duplicate-info">
                        <div class="duplicate-info-row">
                            <span class="duplicate-info-label">CÃ³digo:</span>
                            <span class="duplicate-info-value"><code>${code}</code></span>
                        </div>
                        <div class="duplicate-info-row">
                            <span class="duplicate-info-label">Ya registrado en:</span>
                            <span class="duplicate-info-value">${duplicateInfo.categoryName}</span>
                        </div>
                        <div class="duplicate-info-row">
                            <span class="duplicate-info-label">Hora de registro:</span>
                            <span class="duplicate-info-value">${duplicateInfo.timestamp}</span>
                        </div>
                        <div class="duplicate-info-row">
                            <span class="duplicate-info-label">Registrado por:</span>
                            <span class="duplicate-info-value">${duplicateInfo.user || 'Usuario'}</span>
                        </div>
                    </div>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                        Este cÃ³digo ya fue escaneado anteriormente. Â¿Deseas forzar un nuevo registro?
                    </p>
                    <div class="popup-buttons">
                        <button class="btn btn-warning btn-full" onclick="forceInsertDuplicate('${code}', '${rawCode}'); this.closest('.popup-overlay').remove();">
                            âš¡ Ingreso Forzado (Duplicado)
                        </button>
                        <button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }

        // Forzar inserciÃ³n de duplicado
        function forceInsertDuplicate(code, rawCode) {
            const item = STATE.inventory.get(code);

            if (!item) {
                addBox('nowms', createBoxData(rawCode, code, '', null));
                showNotification('âš¡ Duplicado insertado en No WMS', 'warning');
            } else if (item.isBlocked) {
                addBox('blocked', createBoxData(rawCode, code, '', item));
                showNotification('âš¡ Duplicado insertado en Bloqueado', 'warning');
            } else {
                addBox('ok', createBoxData(rawCode, code, '', item));
                showNotification('âš¡ Duplicado insertado en OK', 'warning');
            }

            playSound('warning');
            document.getElementById('scan-input').focus();
        }

        function processCode2(rawCode2) {
            if (!STATE.pendingCode1) return;

            const code2 = normalizeCode(rawCode2);
            const item = STATE.inventory.get(code2);

            document.getElementById('code2-container').classList.remove('show');

            if (!item) {
                // Both codes failed - add to No WMS with BOTH codes
                addBox('nowms', createBoxData(STATE.pendingCode1.raw, STATE.pendingCode1.code, rawCode2, null));
                showResultBox('error', STATE.pendingCode1.code, 'NO WMS',
                    `Ambos cÃ³digos no encontrados. Guardados: ${STATE.pendingCode1.code} y ${code2}`, null);
                playSound('error');
            } else if (item.isBlocked) {
                addBox('blocked', createBoxData(STATE.pendingCode1.raw, code2, rawCode2, item));
                showResultBox('blocked', code2, 'BLOQUEADO (CÃ³digo 2)',
                    'Validado con CÃ³digo 2 - Bloqueado', item);
                playSound('warning');
            } else {
                addBox('ok', createBoxData(STATE.pendingCode1.raw, code2, rawCode2, item));
                showResultBox('success', code2, 'OK (CÃ³digo 2)',
                    'Validado correctamente con CÃ³digo 2', item);
                playSound('success');
            }

            STATE.pendingCode1 = null;
            flashInput('success');
            document.getElementById('scan-input').focus();
        }

        function forceInsert() {
            if (!STATE.pendingCode1) {
                showNotification('âš ï¸ Primero escanea un cÃ³digo', 'warning');
                return;
            }

            const code2Value = document.getElementById('code2-input').value.trim();

            // Guardar AMBOS cÃ³digos
            addBox('nowms', createBoxData(
                STATE.pendingCode1.raw,
                STATE.pendingCode1.code,
                code2Value,  // Puede estar vacÃ­o o tener valor
                null
            ));

            const msg = code2Value
                ? `Insertado con cÃ³digos: ${STATE.pendingCode1.code} y ${code2Value}`
                : `Insertado con cÃ³digo: ${STATE.pendingCode1.code}`;

            showResultBox('error', STATE.pendingCode1.code, 'INSERTADO (No WMS)', msg, null);

            document.getElementById('code2-container').classList.remove('show');
            document.getElementById('code2-input').value = '';
            STATE.pendingCode1 = null;

            playSound('warning');
            flashInput('warning');
            document.getElementById('scan-input').focus();
            showNotification('âš¡ Registro insertado forzosamente', 'warning');
        }

        function createBoxData(raw, code, scan2, item) {
            const cleanScan2 = scan2 ? normalizeCode(scan2) : '';
            return {
                raw,
                code,
                scan1: raw,
                scan2: cleanScan2,  // CÃ³digo limpio del segundo escaneo
                rawScan2: scan2 || '',  // Valor raw para referencia
                location: item?.cellNo || '-',
                sku: item?.sku || '-',
                product: item?.productName || '-',
                timestamp: new Date().toLocaleTimeString()
            };
        }

        function normalizeCode(raw) {
            let code = raw.trim().toUpperCase();

            // Patrones de extracciÃ³n especiales (JSON, etc)
            const patterns = [
                /\[id\[.*?\[([^\[]+)\[/i,
                /Â¨idÂ¨.*?Â¨([^Â¨]+)Â¨/i,
                /"id"\s*:\s*"([^"]+)"/i
            ];

            for (const pattern of patterns) {
                const match = code.match(pattern);
                if (match) return match[1];
            }

            // CRÃTICO: Preservar guiones ANTES de convertir - a /
            // Detectar patrones tipo: LETRAS+NÃšMEROS+GUION+NÃšMEROS (ej: BY9888548520-07)
            const hasValidDash = /^[A-Z]+\d+\-\d+$/i.test(code);

            if (!hasValidDash) {
                // Solo si NO es un patrÃ³n vÃ¡lido con guion, entonces convertir - a /
                code = code.replace(/(\d)-(\d)/g, '$1/$2');
            }

            // Limpiar caracteres especiales excepto guiones, diagonales y letras/nÃºmeros
            return code.replace(/[^a-zA-Z0-9\-\/]/g, '');
        }

        // ==================== VALIDADOR DE UBICACIONES ====================
        /**
         * Valida el formato de ubicaciÃ³n del almacÃ©n
         * Formato: [LETRA][NÃšMERO]-[NÃšMERO]-[NÃšMERO]-[NÃšMERO]
         * Ejemplo: A21-06-05-01, B27-01-04-01
         */
        function validateLocation(location) {
            const loc = location.trim().toUpperCase();

            // PatrÃ³n: LETRA + NÃšMEROS + GUION + NÃšMEROS + GUION + NÃšMEROS + GUION + NÃšMEROS
            const pattern = /^([A-Z])(\d{1,3})-(\d{1,2})-(\d{1,2})-(\d{1,2})$/;
            const match = loc.match(pattern);

            if (!match) {
                return {
                    valid: false,
                    message: 'âŒ Formato invÃ¡lido',
                    details: 'La ubicaciÃ³n debe seguir el formato: [LETRA][NUM]-[NUM]-[NUM]-[NUM]\nEjemplo: A21-06-05-01',
                    parsed: null
                };
            }

            const [, area, pasillo, rack, nivel, palet] = match;

            return {
                valid: true,
                message: 'âœ… UbicaciÃ³n vÃ¡lida',
                parsed: {
                    area: area,
                    pasillo: pasillo.padStart(2, '0'),
                    rack: rack.padStart(2, '0'),
                    nivel: nivel.padStart(2, '0'),
                    palet: palet.padStart(2, '0'),
                    formatted: `${area}${pasillo.padStart(2, '0')}-${rack.padStart(2, '0')}-${nivel.padStart(2, '0')}-${palet.padStart(2, '0')}`
                }
            };
        }

        /**
         * Muestra diÃ¡logo de confirmaciÃ³n para ubicaciÃ³n invÃ¡lida (doble confirmaciÃ³n)
         */
        function confirmInvalidLocation(location) {
            const validation = validateLocation(location);

            if (validation.valid) {
                return { confirmed: true, formatted: validation.parsed.formatted };
            }

            // Primera confirmaciÃ³n
            const firstConfirm = confirm(
                `âš ï¸ UBICACIÃ“N CON FORMATO INCORRECTO âš ï¸\n\n` +
                `UbicaciÃ³n ingresada: "${location}"\n\n` +
                `${validation.message}\n` +
                `${validation.details}\n\n` +
                `Formato correcto:\n` +
                `â€¢ Ãrea (letra): A, B, C, etc.\n` +
                `â€¢ Pasillo (nÃºmeros): 01-99\n` +
                `â€¢ Rack (nÃºmeros): 01-99\n` +
                `â€¢ Nivel (nÃºmeros): 01-99\n` +
                `â€¢ Palet (nÃºmeros): 01-99\n\n` +
                `Ejemplos vÃ¡lidos:\n` +
                `â€¢ A21-06-05-01\n` +
                `â€¢ B27-01-04-01\n` +
                `â€¢ C15-03-02-05\n\n` +
                `Â¿EstÃ¡s seguro que deseas usar "${location}"?`
            );

            if (!firstConfirm) {
                return { confirmed: false, formatted: null };
            }

            // Segunda confirmaciÃ³n (doble check)
            const secondConfirm = confirm(
                `âš ï¸ SEGUNDA CONFIRMACIÃ“N REQUERIDA âš ï¸\n\n` +
                `Confirma nuevamente que deseas registrar esta ubicaciÃ³n:\n\n` +
                `"${location}"\n\n` +
                `Esta ubicaciÃ³n NO cumple con el formato estÃ¡ndar del almacÃ©n.\n\n` +
                `Â¿CONFIRMAS el uso de esta ubicaciÃ³n?`
            );

            return { confirmed: secondConfirm, formatted: secondConfirm ? location.toUpperCase() : null };
        }

        function showResultBox(type, code, title, message, item) {
            const box = document.getElementById('result-box');
            const icons = { success: 'âœ…', warning: 'âš ï¸', blocked: 'âš ï¸', error: 'âŒ' };

            box.className = `result-box show ${type}`;
            document.getElementById('result-icon').textContent = icons[type] || 'ðŸ“¦';
            document.getElementById('result-title').textContent = `${title}: ${code}`;

            const detailsEl = document.getElementById('result-details');
            if (item) {
                detailsEl.innerHTML = `
                    <div class="result-info-item"><span class="result-info-label">Ubic:</span><span class="result-info-value">${item.cellNo || '-'}</span></div>
                    <div class="result-info-item"><span class="result-info-label">SKU:</span><span class="result-info-value">${item.sku || '-'}</span></div>
                    <div class="result-info-item"><span class="result-info-label">Stock:</span><span class="result-info-value">${item.availableStock || 0}</span></div>
                `;
            } else {
                detailsEl.innerHTML = `<div class="result-info-item" style="color: #666;">${message}</div>`;
            }
        }

        function flashInput(type) {
            const input = document.getElementById('scan-input');
            input.classList.remove('success', 'error');
            input.classList.add(type === 'success' ? 'success' : type === 'error' ? 'error' : '');
            setTimeout(() => input.classList.remove('success', 'error'), 500);
        }

        // ==================== BOX MANAGEMENT ====================
        function addBox(category, boxData) {
            STATE.pallets[category].boxes.push(boxData);
            saveToStorage();
            updateUI();
        }

        function deleteBox(category, index) {
            if (confirm('Â¿Eliminar esta caja?')) {
                STATE.pallets[category].boxes.splice(index, 1);
                saveToStorage();
                updateUI();
                showNotification('Caja eliminada', 'info');
            }
        }

        // ==================== SEND INDIVIDUAL PALLET ====================
        async function sendPallet(category) {
            const pallet = STATE.pallets[category];
            const locationInput = document.getElementById(`location-${category}`);
            const location = locationInput.value.trim();

            if (pallet.boxes.length === 0) {
                showNotification('âš ï¸ No hay cajas en esta tarima', 'warning');
                return;
            }

            if (!location) {
                showNotification('âš ï¸ Ingresa la ubicaciÃ³n destino', 'warning');
                locationInput.focus();
                return;
            }

            // Pre-validaciÃ³n: confirmar cantidad fÃ­sica
            showSendValidationPopup(category, location);
        }

        // Popup de pre-validaciÃ³n de cantidad fÃ­sica (blind count protocol)
        function showSendValidationPopup(category, location) {
            const pallet = STATE.pallets[category];
            const boxCount = pallet.boxes.length;
            const categoryNames = { ok: 'OK âœ…', blocked: 'Bloqueado âš ï¸', nowms: 'No WMS âŒ' };

            // Enable blind mode - blur all counters
            document.body.classList.add('blind-mode');

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show';
            overlay.id = 'send-validation-popup';
            overlay.innerHTML = `
                <div class="popup-content send-validation-popup">
                    <div class="popup-header">
                        <span>ðŸ“¦ Validar EnvÃ­o - ${categoryNames[category]}</span>
                        <button class="popup-close" onclick="closeBlindValidationPopup()">Ã—</button>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 0.9em;">
                        <strong>Destino:</strong> ${location}<br>
                        <span style="color: #888; font-size: 0.85em;">ðŸ”’ Conteo oculto - Verifica fÃ­sicamente</span>
                    </p>
                    <div class="validation-input-group">
                        <label>Â¿CuÃ¡ntas cajas fÃ­sicas hay en la tarima?</label>
                        <input type="number" id="physical-count-input" min="0" placeholder="" autofocus
                               onkeyup="validateBoxCount(${boxCount})" onchange="validateBoxCount(${boxCount})">
                    </div>
                    <div id="validation-status"></div>
                    <div class="popup-buttons">
                        <button class="btn btn-success btn-full" id="confirm-send-btn" disabled
                                onclick="confirmSendPallet('${category}', '${location}')">
                            ðŸ“¤ Confirmar EnvÃ­o
                        </button>
                        <button class="btn btn-secondary btn-full" onclick="closeBlindValidationPopup()">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            // Enfocar el input
            setTimeout(() => {
                const input = document.getElementById('physical-count-input');
                if (input) input.focus();
            }, 100);

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeBlindValidationPopup();
            });
        }

        // Close validation popup and disable blind mode
        function closeBlindValidationPopup() {
            document.body.classList.remove('blind-mode');
            const popup = document.getElementById('send-validation-popup');
            if (popup) popup.remove();
        }

        // Validar cantidad de cajas fÃ­sicas vs escaneadas
        function validateBoxCount(expectedCount) {
            const input = document.getElementById('physical-count-input');
            const statusDiv = document.getElementById('validation-status');
            const confirmBtn = document.getElementById('confirm-send-btn');
            const physicalCount = parseInt(input?.value) || 0;  // AÃ‘ADE ?. para evitar error

            if (physicalCount === expectedCount) {
                if (statusDiv) statusDiv.innerHTML = `<div class="validation-match">âœ… Â¡Correcto! Cantidad coincide (${expectedCount} cajas)</div>`;
                if (confirmBtn) confirmBtn.disabled = false;  // AÃ‘ADE verificaciÃ³n
            } else if (physicalCount > 0) {
                const diff = physicalCount - expectedCount;
                const diffText = diff > 0 ? `+${diff} de mÃ¡s` : `${Math.abs(diff)} faltan`;
                if (statusDiv) statusDiv.innerHTML = `<div class="validation-mismatch">âŒ No coincide: Escaneadas ${expectedCount}, FÃ­sicas ${physicalCount} (${diffText})</div>`;
                if (confirmBtn) confirmBtn.disabled = true;
            } else {
                if (statusDiv) statusDiv.innerHTML = '';
                if (confirmBtn) confirmBtn.disabled = true;
            }
        }

        // Confirmar envÃ­o despuÃ©s de validaciÃ³n
        async function confirmSendPallet(category, location) {
            // Cerrar popup de validaciÃ³n y disable blind mode
            document.body.classList.remove('blind-mode');
            document.getElementById('send-validation-popup')?.remove();

            const pallet = STATE.pallets[category];
            const locationInput = document.getElementById(`location-${category}`);
            const originLocationInput = document.getElementById('origin-location');
            const originLocation = originLocationInput.value.trim().toUpperCase();

            // Validar formato de ubicaciÃ³n con doble confirmaciÃ³n si es invÃ¡lida
            const locationCheck = confirmInvalidLocation(location);
            if (!locationCheck.confirmed) {
                showNotification('âŒ EnvÃ­o cancelado - Verifica la ubicaciÃ³n', 'warning');
                locationInput.focus();
                return;
            }

            // Usar la ubicaciÃ³n formateada (normalizada si es vÃ¡lida)
            const finalLocation = locationCheck.formatted;
            locationInput.value = finalLocation;

            const statusMap = { ok: 'OK', blocked: 'BLOQUEADO', nowms: 'NO WMS' };
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            const timeStr = now.toTimeString().slice(0, 8);

            // Incluye columna J: UbicaciÃ³n FÃ­sica de Origen
            const records = pallet.boxes.map(box => ({
                date: dateStr,
                time: timeStr,
                user: CURRENT_USER || 'Usuario',
                scan1: box.code,
                scan2: box.scan2 || '',
                location: finalLocation,
                status: statusMap[category],
                note: '',
                pallet: pallet.id,
                originLocation: originLocation
            }));

            // Add to history
            STATE.history = [...records, ...STATE.history].slice(0, 1000);

            // Add to pending sync
            PENDING_SYNC = [...PENDING_SYNC, ...records];
            SyncManager.save();

            showNotification(`ðŸ’¾ ${records.length} registros agregados`, 'info');

            // Try to sync immediately
            if (IS_ONLINE && gapi?.client?.getToken()) {
                await SyncManager.sync();
            } else {
                SyncManager.updateUI(false);
            }

            // Reset only this pallet
            const prefixes = { ok: 'OK', blocked: 'BLK', nowms: 'NW' };
            STATE.pallets[category] = {
                id: generatePalletId(prefixes[category]),
                boxes: [],
                location: ''
            };
            locationInput.value = '';

            saveToStorage();
            updateUI();
            playSound('success');

            // Mover foco al campo de ubicaciÃ³n de origen para actualizar
            originLocationInput.focus();
            originLocationInput.select();
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            updateCounts();
            updateLists();
            updateSidebar();
            updateSendButtons();
            updateGlobalCounter();
        }

        function updateGlobalCounter() {
    const tab = GlobalTabs.getActiveTab();
    if (!tab) {
        const counterEl = document.getElementById('global-box-count');
        if (counterEl) counterEl.textContent = '0';
        return;
    }
    
    // Obtener total de la pestaÃ±a activa segÃºn su tipo
    let total = 0;
    if (tab.workType === 'unified') {
        total = tab.state.unified.boxes.length;
    } else {
        const classicPallets = tab.state.classic.pallets;
        total = classicPallets.ok.boxes.length +
                classicPallets.blocked.boxes.length +
                classicPallets.nowms.boxes.length;
    }
    
    const counterEl = document.getElementById('global-box-count');
    if (counterEl) {
        counterEl.textContent = total;
    }
}

        function updateCounts() {
            const tab = GlobalTabs.getActiveTab();
            if (!tab) {
                // Reset all counts if no active tab
                document.getElementById('ok-count').textContent = '0';
                document.getElementById('blocked-count').textContent = '0';
                document.getElementById('nowms-count').textContent = '0';
                document.getElementById('ok-pallet').textContent = '-';
                document.getElementById('blocked-pallet').textContent = '-';
                document.getElementById('nowms-pallet').textContent = '-';
                return;
            }

            if (tab.workType === 'unified') {
                // Hide classic UI elements for unified view
                document.querySelectorAll('.classic-only').forEach(el => el.style.display = 'none');
                document.querySelector('.unified-module-container').style.display = 'block';
                
                // Update unified counter
                const unifiedCount = tab.state.unified.boxes.length;
                document.getElementById('unified-box-count').textContent = unifiedCount;
            } else {
                // Show classic UI elements
                document.querySelectorAll('.classic-only').forEach(el => el.style.display = '');
                document.querySelector('.unified-module-container').style.display = 'none';
                
                // Update classic counters
                const pallets = tab.state.classic.pallets;
                document.getElementById('ok-count').textContent = pallets.ok.boxes.length;
                document.getElementById('blocked-count').textContent = pallets.blocked.boxes.length;
                document.getElementById('nowms-count').textContent = pallets.nowms.boxes.length;

                document.getElementById('ok-pallet').textContent = pallets.ok.id;
                document.getElementById('blocked-pallet').textContent = pallets.blocked.id;
                document.getElementById('nowms-pallet').textContent = pallets.nowms.id;
            }
        }

        function updateLists() {
            updateList('ok');
            updateList('blocked');
            updateList('nowms');
        }

        function updateList(category) {
            const listEl = document.getElementById(`${category}-list`);
            const boxes = STATE.pallets[category].boxes;

            if (boxes.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“­</div>
                        <div>Sin cajas</div>
                    </div>
                `;
                return;
            }

            const originLoc = document.getElementById('origin-location').value.trim().toUpperCase() || '-';

            listEl.innerHTML = boxes.map((box, index) => {
                const isVerified = box.verified || false;
                const verifiedClass = isVerified ? 'verified' : '';

                // Solo mostrar check en columna OK
                const checkBtn = category === 'ok'
                    ? `<button class="box-action-btn check" onclick="toggleBoxVerified('${category}', ${index})" title="Marcar verificado">
                         ${isVerified ? 'âœ“' : 'â—‹'}
                       </button>`
                    : '';

                return `
                <div class="box-item ${verifiedClass}">
                    <div class="box-info">
                        <div class="box-code">${box.code}${box.scan2 ? ` / ${box.scan2}` : ''}</div>
                        <div class="box-meta">${box.location} â€¢ ${box.timestamp}</div>
                    </div>
                    <div class="box-actions">
                        <button class="box-action-btn copy" onclick="copyToClipboard('${box.code}')" title="Copiar cÃ³digo">â§‰</button>
                        <button class="box-action-btn copy" onclick="copyToClipboard('${box.location}')" title="Copiar ubicaciÃ³n BD">â—Ž</button>
                        ${checkBtn}
                        <button class="box-action-btn move" onclick="showMoveBoxPopup('${category}', ${index})" title="Mover a otro pallet">â‡„</button>
                        <button class="box-action-btn delete" onclick="deleteBox('${category}', ${index})" title="Eliminar">âœ•</button>
                    </div>
                </div>
            `}).join('');
        }

        // Toggle verificaciÃ³n de caja en OK
        function toggleBoxVerified(category, index) {
            if (category !== 'ok') return;
            STATE.pallets[category].boxes[index].verified = !STATE.pallets[category].boxes[index].verified;
            saveToStorage();
            updateUI();
        }

        // Copiar al portapapeles
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification(`ðŸ“‹ Copiado: ${text}`, 'success');
            }).catch(() => {
                showNotification('âŒ Error al copiar', 'error');
            });
        }

        // Popup para mover caja entre pallets
        function showMoveBoxPopup(fromCategory, index) {
            const box = STATE.pallets[fromCategory].boxes[index];
            const categories = ['ok', 'blocked', 'nowms'].filter(c => c !== fromCategory);
            const categoryNames = { ok: 'OK âœ…', blocked: 'Bloqueado âš ï¸', nowms: 'No WMS âŒ' };

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show';
            overlay.innerHTML = `
                <div class="popup-content" style="max-width: 350px;">
                    <div class="popup-header">
                        <span>â†”ï¸ Mover Caja</span>
                        <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">Ã—</button>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 0.9em;">
                        <strong>CÃ³digo:</strong> <code>${box.code}</code><br>
                        <strong>Desde:</strong> ${categoryNames[fromCategory]}
                    </p>
                    <p style="margin-bottom: 10px; font-weight: 600;">Mover a:</p>
                    <div class="popup-buttons">
                        ${categories.map(cat => `
                            <button class="btn btn-${cat === 'ok' ? 'success' : cat === 'blocked' ? 'warning' : 'danger'} btn-full"
                                    onclick="moveBox('${fromCategory}', ${index}, '${cat}'); this.closest('.popup-overlay').remove();">
                                ${categoryNames[cat]}
                            </button>
                        `).join('')}
                        <button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }

        // Mover caja entre pallets
        function moveBox(fromCategory, index, toCategory) {
            const box = STATE.pallets[fromCategory].boxes.splice(index, 1)[0];
            box.verified = false; // Reset verificaciÃ³n al mover
            STATE.pallets[toCategory].boxes.push(box);
            saveToStorage();
            updateUI();
            showNotification(`âœ… Caja movida a ${toCategory.toUpperCase()}`, 'success');
        }

        // ==================== MODAL DETALLE DE PALLET ====================
        let detailModalSort = { column: 'index', direction: 'asc' };
        let detailModalFilter = { code: '', location: '' };

        function showPalletDetailModal(category) {
            const pallet = STATE.pallets[category];
            const categoryNames = { ok: 'OK âœ…', blocked: 'Bloqueado âš ï¸', nowms: 'No WMS âŒ' };
            const categoryColors = { ok: 'var(--success)', blocked: 'var(--blocked)', nowms: 'var(--error)' };

            if (pallet.boxes.length === 0) {
                showNotification('âš ï¸ No hay cajas en esta tarima', 'warning');
                return;
            }

            const verifiedCount = category === 'ok' ? pallet.boxes.filter(b => b.verified).length : 0;
            const pendingCount = pallet.boxes.length - verifiedCount;

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show';
            overlay.id = 'pallet-detail-modal';
            overlay.innerHTML = `
                <div class="popup-content pallet-detail-modal">
                    <div class="pallet-detail-header">
                        <div>
                            <span style="font-size: 1.2em; font-weight: 700; color: ${categoryColors[category]};">
                                ${categoryNames[category]} - ${pallet.id}
                            </span>
                            <span style="font-size: 0.9em; color: #666; margin-left: 10px;">${pallet.boxes.length} cajas</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${category === 'ok' ? `
                                <div class="pallet-detail-counters">
                                    <span class="counter-badge ok">âœ“ ${verifiedCount}</span>
                                    <span class="counter-badge pending">â—‹ ${pendingCount}</span>
                                </div>
                            ` : ''}
                            <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">Ã—</button>
                        </div>
                    </div>
                    <div class="pallet-detail-filters">
                        <input type="text" placeholder="ðŸ” Filtrar cÃ³digo..." id="detail-filter-code" onkeyup="filterDetailModal('${category}')">
                        <input type="text" placeholder="ðŸ“ Filtrar ubicaciÃ³n..." id="detail-filter-location" onkeyup="filterDetailModal('${category}')">
                        <button class="btn btn-small btn-secondary" onclick="clearDetailFilters('${category}')">Limpiar</button>
                    </div>
                    <div class="pallet-detail-table-container">
                        <table class="pallet-detail-table">
                            <thead>
                                <tr>
                                    <th onclick="sortDetailModal('${category}', 'index')"># â†•</th>
                                    <th onclick="sortDetailModal('${category}', 'code')">CÃ³digo â†•</th>
                                    <th onclick="sortDetailModal('${category}', 'scan2')">CÃ³digo 2 â†•</th>
                                    <th onclick="sortDetailModal('${category}', 'location')">UbicaciÃ³n â†•</th>
                                    <th onclick="sortDetailModal('${category}', 'timestamp')">Hora â†•</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="detail-table-body"></tbody>
                        </table>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            renderDetailTable(category);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        }

        function renderDetailTable(category) {
            const pallet = STATE.pallets[category];
            const tbody = document.getElementById('detail-table-body');
            if (!tbody) return;
            const originLoc = document.getElementById('origin-location').value.trim().toUpperCase() || '-';

            let filtered = pallet.boxes.map((box, index) => ({ ...box, originalIndex: index }));
            if (detailModalFilter.code) {
                const s = detailModalFilter.code.toUpperCase();
                filtered = filtered.filter(b => b.code.toUpperCase().includes(s) || (b.scan2 && b.scan2.toUpperCase().includes(s)));
            }
            if (detailModalFilter.location) {
                const s = detailModalFilter.location.toUpperCase();
                filtered = filtered.filter(b => b.location.toUpperCase().includes(s));
            }

            filtered.sort((a, b) => {
                let valA, valB;
                switch (detailModalSort.column) {
                    case 'code': valA = a.code; valB = b.code; break;
                    case 'scan2': valA = a.scan2 || ''; valB = b.scan2 || ''; break;
                    case 'location': valA = a.location; valB = b.location; break;
                    case 'timestamp': valA = a.timestamp; valB = b.timestamp; break;
                    default: valA = a.originalIndex; valB = b.originalIndex;
                }
                if (typeof valA === 'string') return detailModalSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                return detailModalSort.direction === 'asc' ? valA - valB : valB - valA;
            });

            tbody.innerHTML = filtered.map((box, i) => {
                const verified = box.verified || false;
                const style = verified ? 'background: rgba(76, 175, 80, 0.1);' : '';
                const checkBtn = category === 'ok' ? `<button class="box-action-btn check" onclick="toggleBoxVerifiedModal('${category}', ${box.originalIndex})">${verified ? 'âœ“' : 'â—‹'}</button>` : '';
                return `<tr style="${style}"><td>${i + 1}</td><td><code>${box.code}</code></td><td><code>${box.scan2 || '-'}</code></td><td>${box.location}</td><td>${box.timestamp}</td><td><button class="box-action-btn copy" onclick="copyToClipboard('${box.code}')">â§‰</button><button class="box-action-btn copy" onclick="copyToClipboard('${box.location}')">â—Ž</button>${checkBtn}<button class="box-action-btn move" onclick="showMoveBoxPopup('${category}', ${box.originalIndex}); document.getElementById('pallet-detail-modal')?.remove();">â‡„</button><button class="box-action-btn delete" onclick="deleteBoxModal('${category}', ${box.originalIndex})">âœ•</button></td></tr>`;
            }).join('');
        }

        function sortDetailModal(category, column) {
            if (detailModalSort.column === column) detailModalSort.direction = detailModalSort.direction === 'asc' ? 'desc' : 'asc';
            else { detailModalSort.column = column; detailModalSort.direction = 'asc'; }
            renderDetailTable(category);
        }

        function filterDetailModal(category) {
            detailModalFilter.code = document.getElementById('detail-filter-code')?.value || '';
            detailModalFilter.location = document.getElementById('detail-filter-location')?.value || '';
            renderDetailTable(category);
        }

        function clearDetailFilters(category) {
            document.getElementById('detail-filter-code').value = '';
            document.getElementById('detail-filter-location').value = '';
            detailModalFilter = { code: '', location: '' };
            renderDetailTable(category);
        }

        function toggleBoxVerifiedModal(category, index) {
            toggleBoxVerified(category, index);
            renderDetailTable(category);
            const pallet = STATE.pallets[category];
            const v = pallet.boxes.filter(b => b.verified).length;
            const p = pallet.boxes.length - v;
            const counters = document.querySelector('.pallet-detail-counters');
            if (counters) counters.innerHTML = `<span class="counter-badge ok">âœ“ ${v}</span><span class="counter-badge pending">â—‹ ${p}</span>`;
        }

        function deleteBoxModal(category, index) {
            if (confirm('Â¿Eliminar esta caja?')) {
                STATE.pallets[category].boxes.splice(index, 1);
                saveToStorage();
                updateUI();
                if (STATE.pallets[category].boxes.length === 0) {
                    document.getElementById('pallet-detail-modal')?.remove();
                    showNotification('Tarima vacÃ­a', 'info');
                } else {
                    renderDetailTable(category);
                    showNotification('Caja eliminada', 'info');
                }
            }
        }

        function updateVerificationBadges() {
            const pallet = STATE.pallets.ok;
            const v = pallet.boxes.filter(b => b.verified).length;
            const p = pallet.boxes.length - v;
            const vBadge = document.getElementById('ok-verified-badge');
            const pBadge = document.getElementById('ok-pending-badge');
            if (pallet.boxes.length > 0) {
                vBadge.style.display = v > 0 ? 'flex' : 'none';
                document.getElementById('ok-verified-count').textContent = v;
                pBadge.style.display = p > 0 ? 'flex' : 'none';
                document.getElementById('ok-pending-count').textContent = p;
            } else {
                vBadge.style.display = 'none';
                pBadge.style.display = 'none';
            }
        }

        function updateSidebar() {
            document.getElementById('sidebar-ok-count').textContent = STATE.pallets.ok.boxes.length;
            document.getElementById('sidebar-blocked-count').textContent = STATE.pallets.blocked.boxes.length;
            document.getElementById('sidebar-nowms-count').textContent = STATE.pallets.nowms.boxes.length;

            document.getElementById('sidebar-ok-pallet').textContent = STATE.pallets.ok.id;
            document.getElementById('sidebar-blocked-pallet').textContent = STATE.pallets.blocked.id;
            document.getElementById('sidebar-nowms-pallet').textContent = STATE.pallets.nowms.id;
        }

        function updateSendButtons() {
            const tab = GlobalTabs.getActiveTab();
            if (!tab) {
                // Disable all buttons if no active tab
                document.getElementById('send-ok-btn').disabled = true;
                document.getElementById('send-blocked-btn').disabled = true;
                document.getElementById('send-nowms-btn').disabled = true;
                return;
            }

            if (tab.workType === 'unified') {
                // Handle unified tab
                const unifiedBoxes = tab.state.unified.boxes;
                const sendBtn = document.getElementById('unified-send-btn');
                if (sendBtn) {
                    sendBtn.disabled = unifiedBoxes.length === 0;
                }
                
                // Hide classic buttons
                document.querySelectorAll('.send-btn').forEach(btn => {
                    if (!btn.id.includes('unified-')) {
                        btn.style.display = 'none';
                    } else {
                        btn.style.display = '';
                    }
                });
            } else {
                // Handle classic tab
                const pallets = tab.state.classic.pallets;
                document.getElementById('send-ok-btn').disabled = pallets.ok.boxes.length === 0;
                document.getElementById('send-blocked-btn').disabled = pallets.blocked.boxes.length === 0;
                document.getElementById('send-nowms-btn').disabled = pallets.nowms.boxes.length === 0;
                
                // Show classic buttons, hide unified
                document.querySelectorAll('.send-btn').forEach(btn => {
                    if (btn.id.includes('unified-')) {
                        btn.style.display = 'none';
                    } else {
                        btn.style.display = '';
                    }
                });
            }
        }

        // ==================== PALLET MANAGEMENT ====================
        function generatePalletId(prefix = 'PD') {
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}-${timestamp}-${random}`;
        }

        function newSession() {
            const total = STATE.pallets.ok.boxes.length +
                          STATE.pallets.blocked.boxes.length +
                          STATE.pallets.nowms.boxes.length;

            if (total > 0) {
                if (!confirm(`Hay ${total} cajas en las tarimas. Â¿Iniciar nueva sesiÃ³n sin enviar?`)) {
                    return;
                }
            }

            STATE.pallets = {
                ok: { id: generatePalletId('OK'), boxes: [], location: '' },
                blocked: { id: generatePalletId('BLK'), boxes: [], location: '' },
                nowms: { id: generatePalletId('NW'), boxes: [], location: '' }
            };
            STATE.pendingCode1 = null;

            document.getElementById('result-box').classList.remove('show');
            document.getElementById('code2-container').classList.remove('show');
            document.getElementById('location-ok').value = '';
            document.getElementById('location-blocked').value = '';
            document.getElementById('location-nowms').value = '';
            document.getElementById('origin-location').value = '';

            saveToStorage();
            updateUI();
            showNotification('âœ… Nueva sesiÃ³n iniciada', 'success');
            document.getElementById('origin-location').focus();
        }

        // ==================== RESUMEN MODULE ====================
        function showResumen() {
            updateResumen();
            document.getElementById('resumen-popup').classList.add('show');
        }

        function closeResumen() {
            document.getElementById('resumen-popup').classList.remove('show');
        }

        function updateResumen() {
            document.getElementById('resumen-ok').textContent = STATE.pallets.ok.boxes.length;
            document.getElementById('resumen-blocked').textContent = STATE.pallets.blocked.boxes.length;
            document.getElementById('resumen-nowms').textContent = STATE.pallets.nowms.boxes.length;
            document.getElementById('resumen-pending').textContent = PENDING_SYNC.length;

            // Update table
            const tbody = document.getElementById('resumen-table-body');
            const recentHistory = STATE.history.slice(0, 50);

            if (recentHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Sin registros recientes</td></tr>';
            } else {
                tbody.innerHTML = recentHistory.map(r => `
                    <tr>
                        <td>${r.time}</td>
                        <td><code>${r.scan1}</code></td>
                        <td><code>${r.scan2 || '-'}</code></td>
                        <td><span style="color: ${r.status === 'OK' ? 'var(--success)' : r.status === 'BLOQUEADO' ? 'var(--blocked)' : 'var(--error)'}">${r.status}</span></td>
                        <td>${r.location}</td>
                        <td>${r.originLocation || '-'}</td>
                        <td style="font-size: 0.8em;">${r.pallet}</td>
                    </tr>
                `).join('');
            }
        }

        // ==================== CONNECTION ====================
        function setupConnectionMonitor() {
            window.addEventListener('online', () => {
                IS_ONLINE = true;
                showConnectionBanner('online');
                updateConnectionIndicator();
                showNotification('âœ… ConexiÃ³n restaurada', 'success');
                setTimeout(() => SyncManager.sync(), 1000);
            });

            window.addEventListener('offline', () => {
                IS_ONLINE = false;
                showConnectionBanner('offline');
                updateConnectionIndicator();
                showNotification('âš ï¸ Sin conexiÃ³n - Modo offline', 'warning');
            });

            updateConnectionIndicator();
        }

        function showConnectionBanner(status) {
            const banner = document.getElementById('connection-banner');
            banner.className = `connection-banner ${status}`;
            banner.textContent = status === 'online' ? 'âœ… ConexiÃ³n restaurada' :
                                 status === 'offline' ? 'âš ï¸ Sin conexiÃ³n a internet' :
                                 'ðŸ”„ Sincronizando...';
            if (status === 'online') {
                setTimeout(() => banner.style.display = 'none', 3000);
            }
        }

        function updateConnectionIndicator(syncing = false) {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');

            if (!dot || !text) return;

            if (syncing) {
                dot.className = 'connection-dot syncing';
                text.textContent = 'Sincronizando...';
            } else if (IS_ONLINE) {
                dot.className = 'connection-dot online';
                text.textContent = 'En lÃ­nea';
            } else {
                dot.className = 'connection-dot offline';
                text.textContent = 'Sin conexiÃ³n';
            }
        }

        function toggleConnection() {
            if (gapi?.client?.getToken()) {
                if (confirm('Â¿Desconectar de Google?')) {
                    google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                    gapi.client.setToken(null);
                    showNotification('Desconectado de Google', 'info');
                    updateConnectionIndicator();
                }
            } else {
                handleLogin();
            }
        }

        // ==================== STORAGE ====================
        async function loadFromStorage() {
            try {
                const saved = localStorage.getItem('pd_system_state');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.inventory) STATE.inventory = new Map(data.inventory);
                    STATE.inventoryLastUpdate = data.inventoryLastUpdate;
                    if (data.pallets) STATE.pallets = data.pallets;
                    STATE.history = data.history || [];
                }
                updateBdInfo();
            } catch (e) {
                console.error('Error loading from storage:', e);
            }
        }

        async function saveToStorage() {
            try {
                const data = {
                    inventory: Array.from(STATE.inventory.entries()),
                    inventoryLastUpdate: STATE.inventoryLastUpdate,
                    pallets: STATE.pallets,
                    history: STATE.history.slice(0, 1000)
                };
                localStorage.setItem('pd_system_state', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving to storage:', e);
            }
        }

        // ==================== EXPORT ====================
        function exportData() {
            if (STATE.history.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }

            const headers = ['FECHA', 'HORA', 'RESPONSABLE', 'SCAN 1', 'SCAN 2', 'UBICACION DESTINO', 'ESTATUS', 'NOTA', 'PALLET', 'UBICACION FISICA ORIGEN'];
            const rows = STATE.history.map(r => [
                r.date, r.time, r.user, r.scan1, r.scan2, r.location, r.status, r.note, r.pallet, r.originLocation || ''
            ]);

            const csv = '\ufeff' + [
                headers.join(','),
                ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `inventario_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();

            showNotification('âœ… Datos exportados', 'success');
        }

        // ==================== UTILITIES ====================
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span style="margin-right: 8px;">${icons[type]}</span>${message}`;

            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function playSound(type) {
            if (!audioCtx) return;

            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);

                if (type === 'success') {
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.15);
                } else if (type === 'error') {
                    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.35);
                } else if (type === 'warning') {
                    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.1);
                }
            } catch (e) {}
        }

        // ==================== GLOBAL TABS SYSTEM ====================
        const GlobalTabs = {
            MAX_TABS: 4,
            tabs: [],
            activeTabId: null,

            init() {
                // Load and validate tabs from storage
                this.loadFromStorage();

                // Ensure activeTabId is valid
                if (this.activeTabId && !this.tabs.find(t => t.id === this.activeTabId)) {
                    this.activeTabId = this.tabs.length > 0 ? this.tabs[0].id : null;
                }

                // Render tabs UI
                this.renderTabs();
                this.updateGlobalSummary();

                if (this.tabs.length === 0 || !this.activeTabId) {
                    // No tabs or no active tab - show welcome state
                    this.activeTabId = null;
                    this.showWelcomeScreen();
                } else {
                    // Has valid tabs - load active tab state and switch to its module
                    const activeTab = this.getActiveTab();
                    if (activeTab && activeTab.workType) {
                        this.loadTabState();
                        this.showModuleForTab(activeTab);
                    } else {
                        // Active tab is invalid - show welcome screen
                        this.showWelcomeScreen();
                    }
                }
            },

            showWelcomeScreen() {
                const classicModule = document.getElementById('classic-module');
                const unifiedModule = document.getElementById('unified-module');
                const welcomeState = document.getElementById('welcome-state');

                // Hide both modules
                if (classicModule) {
                    classicModule.classList.remove('module-visible');
                    classicModule.classList.add('module-hidden');
                }
                if (unifiedModule) {
                    unifiedModule.classList.remove('module-visible');
                    unifiedModule.classList.add('module-hidden');
                }
                // Show welcome state
                if (welcomeState) {
                    welcomeState.classList.remove('module-hidden');
                    welcomeState.classList.add('module-visible');
                }
            },

            showModuleForTab(tab) {
                // Validate tab and workType
                if (!tab) {
                    console.error('showModuleForTab: No tab provided');
                    this.showWelcomeScreen();
                    return;
                }

                const workType = tab.workType;
                if (workType !== 'unified' && workType !== 'classic') {
                    console.error('showModuleForTab: Invalid workType:', workType);
                    // Default to classic if invalid
                    tab.workType = 'classic';
                }

                const classicModule = document.getElementById('classic-module');
                const unifiedModule = document.getElementById('unified-module');
                const welcomeState = document.getElementById('welcome-state');

                // Always hide welcome state when showing a module
                if (welcomeState) {
                    welcomeState.classList.remove('module-visible');
                    welcomeState.classList.add('module-hidden');
                }

                // Force hide both modules first to ensure clean state
                if (classicModule) {
                    classicModule.classList.remove('module-visible');
                    classicModule.classList.add('module-hidden');
                }
                if (unifiedModule) {
                    unifiedModule.classList.remove('module-visible');
                    unifiedModule.classList.add('module-hidden');
                }

                // Now show the correct module
                if (tab.workType === 'unified') {
                    // Show unified module
                    if (unifiedModule) {
                        unifiedModule.classList.remove('module-hidden');
                        unifiedModule.classList.add('module-visible');
                    }
                    CURRENT_MODULE = 'unified';
                    // Initialize unified module after a small delay to ensure DOM is ready
                    setTimeout(() => {
                        UnifiedModule.init();
                        UnifiedModule.updateUI();
                    }, 10);
                } else {
                    // Show classic module
                    if (classicModule) {
                        classicModule.classList.remove('module-hidden');
                        classicModule.classList.add('module-visible');
                    }
                    CURRENT_MODULE = 'classic';
                    // Update classic UI after a small delay
                    setTimeout(() => {
                        updateUI();
                    }, 10);
                }

                localStorage.setItem('pd_current_module', CURRENT_MODULE);
            },

            generateTabId() {
                return 'TAB-' + Date.now().toString(36).toUpperCase() + '-' + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            },

            generatePalletId(prefix = 'PAL') {
                const timestamp = Date.now().toString(36).toUpperCase();
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `${prefix}-${timestamp}-${random}`;
            },

            createEmptyTabState() {
                return {
                    // Estado para mÃ³dulo Clasificar
                    classic: {
                        pallets: {
                            ok: { id: this.generatePalletId('OK'), boxes: [] },
                            blocked: { id: this.generatePalletId('BLK'), boxes: [] },
                            nowms: { id: this.generatePalletId('NWS'), boxes: [] }
                        },
                        originLocation: ''
                    },
                    // Estado para mÃ³dulo Unificado
                    unified: {
                        palletId: this.generatePalletId('UNI'),
                        boxes: [],
                        location: '',
                        originLocation: '',
                        canceladosMode: false
                    }
                };
            },

            createTab(workType = 'classic') {
                // Save current tab state before creating a new one
                this.saveCurrentTabState();

                // Validate workType
                if (workType !== 'classic' && workType !== 'unified') {
                    console.error('createTab: Invalid workType:', workType, '- defaulting to classic');
                    workType = 'classic';
                }

                if (this.tabs.length >= this.MAX_TABS) {
                    showNotification(`âš ï¸ MÃ¡ximo ${this.MAX_TABS} pestaÃ±as permitidas`, 'warning');
                    return;
                }

                const tabId = this.generateTabId();
                const newTab = {
                    id: tabId,
                    name: `SesiÃ³n ${this.tabs.length + 1}`,
                    workType: workType,
                    state: this.createEmptyTabState(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // Add the new tab
                this.tabs.push(newTab);
                
                // Switch to the new tab
                this.switchTab(tabId);
                
                // Force UI update
                this.renderTabs();
                
                // Update UI elements based on the new tab's workType
                if (workType === 'unified') {
                    // Reset unified module UI
                    const unifiedInput = document.getElementById('unified-scan-input');
                    if (unifiedInput) {
                        unifiedInput.value = '';
                        unifiedInput.focus();
                    }
                    const unifiedCode2Input = document.getElementById('unified-code2-input');
                    if (unifiedCode2Input) unifiedCode2Input.value = '';
                    
                    const unifiedBoxCount = document.getElementById('unified-box-count');
                    if (unifiedBoxCount) unifiedBoxCount.textContent = '0';
                    
                    const unifiedPalletId = document.getElementById('unified-pallet-id');
                    if (unifiedPalletId) unifiedPalletId.textContent = newTab.state.unified.palletId;
                } else {
                    setTimeout(() => document.getElementById('scan-input')?.focus(), 100);
                }

                const workTypeLabel = workType === 'classic' ? 'Clasificar' : 'Unificado';
                showNotification(`âœ… Nueva sesiÃ³n (${workTypeLabel}) creada`, 'success');
                this.updateGlobalSummary();
            },

            switchTab(tabId) {
                if (this.activeTabId === tabId) return;

                // Guardar estado actual antes de cambiar
                this.saveCurrentTabState();

                this.activeTabId = tabId;
                this.saveToStorage();
                this.renderTabs();
                this.loadTabState();

                // Show the correct module for the new active tab
                const tab = this.getActiveTab();
                if (tab) {
                    this.showModuleForTab(tab);
                    // Focus the appropriate input
                    if (tab.workType === 'unified') {
                        setTimeout(() => document.getElementById('unified-scan-input')?.focus(), 100);
                    } else {
                        setTimeout(() => document.getElementById('scan-input')?.focus(), 100);
                    }
                }
            },

            closeTab(tabId, event) {
                if (event) event.stopPropagation();

                const tab = this.tabs.find(t => t.id === tabId);
                if (!tab) return;

                // Verificar si hay cajas sin enviar
                const classicBoxes = Object.values(tab.state.classic.pallets).reduce((sum, p) => sum + p.boxes.length, 0);
                const unifiedBoxes = tab.state.unified.boxes.length;
                const totalBoxes = classicBoxes + unifiedBoxes;

                if (totalBoxes > 0) {
                    if (!confirm(`âš ï¸ Esta sesiÃ³n tiene ${totalBoxes} cajas sin enviar. Â¿Cerrar de todos modos?`)) {
                        return;
                    }
                }

                this.tabs = this.tabs.filter(t => t.id !== tabId);

                if (this.activeTabId === tabId) {
                    this.activeTabId = this.tabs.length > 0 ? this.tabs[0].id : null;
                }

                this.saveToStorage();
                this.renderTabs();
                this.updateGlobalSummary();

                if (this.tabs.length === 0) {
                    // No more tabs - show welcome screen
                    this.showWelcomeScreen();
                } else if (this.activeTabId) {
                    // Switch to remaining tab
                    this.loadTabState();
                    const activeTab = this.getActiveTab();
                    if (activeTab) {
                        this.showModuleForTab(activeTab);
                    }
                }

                showNotification('SesiÃ³n cerrada', 'info');
            },

            getActiveTab() {
                return this.tabs.find(t => t.id === this.activeTabId);
            },

            saveCurrentTabState() {
                const tab = this.getActiveTab();
                if (!tab) return;

                // Guardar estado del mÃ³dulo Clasificar
                tab.state.classic.pallets = JSON.parse(JSON.stringify(STATE.pallets));
                tab.state.classic.originLocation = document.getElementById('origin-location')?.value || '';

                // Guardar estado del mÃ³dulo Unificado
                tab.state.unified.originLocation = document.getElementById('unified-origin-location')?.value || '';
                tab.state.unified.location = document.getElementById('unified-location')?.value || '';
            },

            loadTabState() {
                const tab = this.getActiveTab();
                if (!tab) return;

                // Validate tab has proper state
                if (!tab.state || !tab.state.classic || !tab.state.unified) {
                    console.error('loadTabState: Tab has invalid state structure');
                    return;
                }

                // Cargar estado del mÃ³dulo Clasificar
                STATE.pallets = JSON.parse(JSON.stringify(tab.state.classic.pallets));
                const originInput = document.getElementById('origin-location');
                if (originInput) originInput.value = tab.state.classic.originLocation || '';

                // Cargar estado del mÃ³dulo Unificado
                const unifiedOriginInput = document.getElementById('unified-origin-location');
                if (unifiedOriginInput) unifiedOriginInput.value = tab.state.unified.originLocation || '';
                const unifiedLocationInput = document.getElementById('unified-location');
                if (unifiedLocationInput) unifiedLocationInput.value = tab.state.unified.location || '';

                // Solo actualizar la UI del mÃ³dulo activo para evitar conflictos
                // La UI se actualizarÃ¡ en showModuleForTab
            },

            renderTabs() {
                const container = document.getElementById('global-tabs-container');
                if (!container) return;

                container.innerHTML = '';

                // Renderizar pestaÃ±as existentes
                this.tabs.forEach((tab, index) => {
                    const classicBoxes = Object.values(tab.state.classic.pallets).reduce((sum, p) => sum + p.boxes.length, 0);
                    const unifiedBoxes = tab.state.unified.boxes.length;
                    const totalBoxes = classicBoxes + unifiedBoxes;
                    const workTypeIcon = tab.workType === 'unified' ? 'ðŸ“¦' : 'ðŸ“‹';
                    const workTypeLabel = tab.workType === 'unified' ? 'Uni' : 'Clas';

                    const tabEl = document.createElement('div');
                    tabEl.className = `unified-tab ${tab.id === this.activeTabId ? 'active' : ''}`;
                    tabEl.onclick = () => this.switchTab(tab.id);
                    tabEl.innerHTML = `
                        <span>${workTypeIcon} S${index + 1}</span>
                        <span class="tab-count">${totalBoxes}</span>
                        <button class="tab-close" onclick="GlobalTabs.closeTab('${tab.id}', event)">Ã—</button>
                    `;
                    container.appendChild(tabEl);
                });

                // BotÃ³n nuevo - shows work type popup
                const newBtnEl = document.createElement('button');
                newBtnEl.className = 'unified-tab-new';
                newBtnEl.onclick = () => showWorkTypePopup();
                newBtnEl.disabled = this.tabs.length >= this.MAX_TABS;
                newBtnEl.innerHTML = 'âž• Nuevo';
                container.appendChild(newBtnEl);
            },

            saveToStorage() {
                this.saveCurrentTabState();
                try {
                    localStorage.setItem('pd_global_tabs', JSON.stringify({
                        tabs: this.tabs,
                        activeTabId: this.activeTabId
                    }));
                } catch (e) {
                    console.error('Error saving global tabs:', e);
                }
            },

            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('pd_global_tabs');
                    if (saved) {
                        const data = JSON.parse(saved);
                        const originalCount = (data.tabs || []).length;

                        // Validate tabs - only keep tabs with valid structure
                        this.tabs = (data.tabs || []).filter(tab => {
                            // Basic validation
                            if (!tab || !tab.id || !tab.workType || !tab.state) {
                                console.warn('Tab rejected - missing basic properties:', tab?.id);
                                return false;
                            }

                            // Validate workType
                            if (tab.workType !== 'classic' && tab.workType !== 'unified') {
                                console.warn('Tab rejected - invalid workType:', tab.id, tab.workType);
                                return false;
                            }

                            // Validate state structure
                            if (!tab.state.classic || !tab.state.unified) {
                                console.warn('Tab rejected - invalid state structure:', tab.id);
                                return false;
                            }

                            // Validate classic state
                            if (!tab.state.classic.pallets) {
                                console.warn('Tab rejected - missing classic pallets:', tab.id);
                                return false;
                            }

                            // Validate unified state
                            if (!Array.isArray(tab.state.unified.boxes)) {
                                console.warn('Tab rejected - invalid unified boxes:', tab.id);
                                return false;
                            }

                            return true;
                        });

                        // Set active tab ID
                        this.activeTabId = this.tabs.length > 0 ?
                            (this.tabs.find(t => t.id === data.activeTabId) ? data.activeTabId : this.tabs[0].id) :
                            null;

                        // Save cleaned data back if any tabs were removed
                        if (this.tabs.length !== originalCount) {
                            console.log(`Cleaned ${originalCount - this.tabs.length} invalid tabs`);
                            this.saveToStorage();
                        }
                    }
                } catch (e) {
                    console.error('Error loading global tabs:', e);
                    this.tabs = [];
                    this.activeTabId = null;
                    localStorage.removeItem('pd_global_tabs');
                }
            },

            getTotalBoxCount() {
                const tab = this.getActiveTab();
                if (!tab) return 0;
                const classicBoxes = Object.values(tab.state.classic.pallets).reduce((sum, p) => sum + p.boxes.length, 0);
                const unifiedBoxes = tab.state.unified.boxes.length;
                return classicBoxes + unifiedBoxes;
            },

            // Update global summary across all tabs
            updateGlobalSummary() {
                let totalOk = 0;
                let totalBlocked = 0;
                let totalNowms = 0;

                this.tabs.forEach(tab => {
                    // Count from classic module
                    totalOk += tab.state.classic.pallets.ok.boxes.length;
                    totalBlocked += tab.state.classic.pallets.blocked.boxes.length;
                    totalNowms += tab.state.classic.pallets.nowms.boxes.length;

                    // Count from unified module
                    tab.state.unified.boxes.forEach(box => {
                        if (box.status === 'ok') totalOk++;
                        else if (box.status === 'blocked') totalBlocked++;
                        else if (box.status === 'nowms') totalNowms++;
                    });
                });

                const total = totalOk + totalBlocked + totalNowms;

                // Update sidebar summary
                const okEl = document.getElementById('global-summary-ok');
                const blockedEl = document.getElementById('global-summary-blocked');
                const nowmsEl = document.getElementById('global-summary-nowms');
                const totalEl = document.getElementById('global-summary-total');

                if (okEl) okEl.textContent = totalOk;
                if (blockedEl) blockedEl.textContent = totalBlocked;
                if (nowmsEl) nowmsEl.textContent = totalNowms;
                if (totalEl) totalEl.textContent = total;
            }
        };

        // ==================== WORK TYPE POPUP ====================
        // Global variable to store selected work type (more reliable than DOM property)
        let PENDING_WORK_TYPE = null;

        function showWorkTypePopup() {
            if (GlobalTabs.tabs.length >= GlobalTabs.MAX_TABS) {
                showNotification(`âš ï¸ MÃ¡ximo ${GlobalTabs.MAX_TABS} pestaÃ±as permitidas`, 'warning');
                return;
            }

            // Reset pending work type
            PENDING_WORK_TYPE = null;

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay show';
            overlay.id = 'work-type-popup';
            overlay.innerHTML = `
                <div class="popup-content work-type-popup">
                    <div class="popup-header">
                        <span>ðŸ†• Nueva SesiÃ³n</span>
                        <button class="popup-close" onclick="closeWorkTypePopup()">Ã—</button>
                    </div>

                    <!-- Professional Toggle Button -->
                    <div class="work-type-toggle-container">
                        <button class="work-type-toggle-btn" id="toggle-classic" onclick="selectWorkType('classic')">
                            <span class="toggle-icon">ðŸ“‹</span>
                            Clasificar
                        </button>
                        <button class="work-type-toggle-btn" id="toggle-unified" onclick="selectWorkType('unified')">
                            <span class="toggle-icon">ðŸ“¦</span>
                            Unificado
                        </button>
                    </div>

                    <!-- Dynamic Description -->
                    <div class="work-type-description" id="work-type-description">
                        <div class="work-type-description-title" id="work-type-desc-title">
                            ðŸ‘† Selecciona un modo
                        </div>
                        <div class="work-type-description-text" id="work-type-desc-text">
                            Elige el tipo de trabajo que realizarÃ¡s en esta sesiÃ³n.
                        </div>
                    </div>

                    <div class="work-type-locked">
                        ðŸ”’ El modo se bloquea al crear la sesiÃ³n
                    </div>

                    <button class="work-type-confirm-btn" id="confirm-work-type-btn" disabled onclick="confirmWorkType()">
                        âœ… Crear SesiÃ³n
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);

            // Close on backdrop click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeWorkTypePopup();
            });
        }

        function closeWorkTypePopup() {
            PENDING_WORK_TYPE = null;
            const popup = document.getElementById('work-type-popup');
            if (popup) popup.remove();
        }

        const workTypeDescriptions = {
            classic: {
                title: 'ðŸ“‹ Modo Clasificar',
                text: 'Separa automÃ¡ticamente las cajas en 3 tarimas segÃºn su estado: OK, Bloqueado y No WMS. Ideal para reorganizar inventario por condiciÃ³n.'
            },
            unified: {
                title: 'ðŸ“¦ Modo Unificado',
                text: 'Agrupa todas las cajas en una sola tarima con estados mixtos. Registra el estado pero las mantiene juntas. Ideal para inventarios rÃ¡pidos.'
            }
        };

        function selectWorkType(type) {
            const popup = document.getElementById('work-type-popup');
            if (!popup) return;

            // Validate type
            if (type !== 'classic' && type !== 'unified') {
                console.error('Invalid work type:', type);
                return;
            }

            // Update toggle buttons
            const classicBtn = document.getElementById('toggle-classic');
            const unifiedBtn = document.getElementById('toggle-unified');
            if (classicBtn) classicBtn.classList.toggle('active', type === 'classic');
            if (unifiedBtn) unifiedBtn.classList.toggle('active', type === 'unified');

            // Update description
            const desc = workTypeDescriptions[type];
            const titleEl = document.getElementById('work-type-desc-title');
            const textEl = document.getElementById('work-type-desc-text');
            if (titleEl) titleEl.textContent = desc.title;
            if (textEl) textEl.textContent = desc.text;

            // Store selection in global variable
            PENDING_WORK_TYPE = type;

            // Enable confirm button
            const confirmBtn = document.getElementById('confirm-work-type-btn');
            if (confirmBtn) confirmBtn.disabled = false;
        }

        function confirmWorkType() {
            // Use the global variable
            if (!PENDING_WORK_TYPE) {
                showNotification('Por favor selecciona un modo de trabajo', 'warning');
                return;
            }

            // Validate work type
            if (PENDING_WORK_TYPE !== 'classic' && PENDING_WORK_TYPE !== 'unified') {
                console.error('Invalid pending work type:', PENDING_WORK_TYPE);
                showNotification('Error: tipo de trabajo invÃ¡lido', 'error');
                PENDING_WORK_TYPE = null;
                return;
            }

            const workType = PENDING_WORK_TYPE;

            // Close popup first
            const popup = document.getElementById('work-type-popup');
            if (popup) popup.remove();

            // Reset global variable
            PENDING_WORK_TYPE = null;

            // Create tab with the selected work type
            GlobalTabs.createTab(workType);
        }

        // ==================== MODULE SWITCHING ====================
        let CURRENT_MODULE = 'classic';

        function switchModule(module, fromTabSwitch = false) {
            // Check if the current tab has a locked work type
            const activeTab = GlobalTabs.getActiveTab();
            if (activeTab && activeTab.workType && !fromTabSwitch) {
                // If user tries to switch modules manually but tab is locked
                if (activeTab.workType !== module) {
                    const lockedType = activeTab.workType === 'classic' ? 'Clasificar' : 'Unificado';
                    showNotification(`ðŸ”’ Esta sesiÃ³n estÃ¡ bloqueada como "${lockedType}"`, 'warning');
                    return;
                }
            }

            CURRENT_MODULE = module;

            const classicModule = document.getElementById('classic-module');
            const unifiedModule = document.getElementById('unified-module');
            const welcomeState = document.getElementById('welcome-state');

            // Hide welcome state using CSS classes
            if (welcomeState) {
                welcomeState.classList.remove('module-visible');
                welcomeState.classList.add('module-hidden');
            }

            // Guardar estado de la pestaÃ±a actual antes de cambiar
            GlobalTabs.saveCurrentTabState();

            if (module === 'classic') {
                // Mostrar clÃ¡sico, ocultar unificado
                if (classicModule) {
                    classicModule.classList.remove('module-hidden');
                    classicModule.classList.add('module-visible');
                }
                if (unifiedModule) {
                    unifiedModule.classList.remove('module-visible');
                    unifiedModule.classList.add('module-hidden');
                }
                setTimeout(() => document.getElementById('scan-input')?.focus(), 100);
            } else {
                // Mostrar unificado, ocultar clÃ¡sico
                if (classicModule) {
                    classicModule.classList.remove('module-visible');
                    classicModule.classList.add('module-hidden');
                }
                if (unifiedModule) {
                    unifiedModule.classList.remove('module-hidden');
                    unifiedModule.classList.add('module-visible');
                }
                UnifiedModule.init();
                setTimeout(() => document.getElementById('unified-scan-input')?.focus(), 100);
            }

            localStorage.setItem('pd_current_module', module);
            GlobalTabs.renderTabs();
        }


        // ==================== UNIFIED CAPTURE MODULE ====================
        const UnifiedModule = {
            pendingCode1: null,

            init() {
                this.setupEventListeners();
                this.syncCanceladosUI();
                this.updateUI();
            },

            // Sync checkbox state with tab state
            syncCanceladosUI() {
                const tab = this.getActiveTab();
                const checkbox = document.getElementById('unified-cancelados-check');
                const toggleLabel = document.getElementById('cancelados-toggle-label');

                if (checkbox && tab) {
                    const isCancelados = tab.canceladosMode || false;
                    checkbox.checked = isCancelados;
                    if (toggleLabel) {
                        toggleLabel.classList.toggle('active', isCancelados);
                    }
                }
            },

            // Toggle Cancelados mode
            toggleCancelados(isChecked) {
                const tab = this.getActiveTab();
                if (!tab) return;

                // Save to tab state
                tab.canceladosMode = isChecked;
                GlobalTabs.saveToStorage();

                // Update toggle label style
                const toggleLabel = document.getElementById('cancelados-toggle-label');
                if (toggleLabel) {
                    toggleLabel.classList.toggle('active', isChecked);
                }

                // Update the list to show/hide badges
                this.renderBoxList();

                // Show notification
                if (isChecked) {
                    showNotification('ðŸš« Modo CANCELADOS activado - Los cÃ³digos se registrarÃ¡n como cancelados', 'warning');
                } else {
                    showNotification('âœ… Modo normal activado', 'success');
                }
            },

            // Check if cancelados mode is active
            isCanceladosMode() {
                const tab = this.getActiveTab();
                return tab ? (tab.canceladosMode || false) : false;
            },

            setupEventListeners() {
                const scanInput = document.getElementById('unified-scan-input');
                const code2Input = document.getElementById('unified-code2-input');

                if (!scanInput || !code2Input) return;

                scanInput.onkeydown = (e) => {
                    if (e.key === 'Enter' && scanInput.value.trim()) {
                        e.preventDefault();
                        this.processScan(scanInput.value.trim());
                        scanInput.value = '';
                    }
                };

                code2Input.onkeydown = (e) => {
                    if (e.key === 'Enter' && code2Input.value.trim()) {
                        e.preventDefault();
                        this.processCode2(code2Input.value.trim());
                        code2Input.value = '';
                    }
                };
            },

            generatePalletId() {
                const timestamp = Date.now().toString(36).toUpperCase();
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `UNI-${timestamp}-${random}`;
            },

            getActiveTab() {
                const tab = GlobalTabs.getActiveTab();
                return tab ? tab.state.unified : null;
            },

            processScan(rawCode) {
                const tab = this.getActiveTab();
                if (!tab) {
                    showNotification('âš ï¸ No hay sesiÃ³n activa', 'warning');
                    return;
                }

                const code = normalizeCode(rawCode);

                // Check duplicates
                const duplicateIndex = tab.boxes.findIndex(b => b.code === code);
                if (duplicateIndex !== -1) {
                    this.showDuplicatePopup(code, rawCode, duplicateIndex);
                    this.flashInput('warning');
                    playSound('warning');
                    return;
                }

                const item = STATE.inventory.get(code);

                if (!item) {
                    // Not found - show Code2 input
                    this.pendingCode1 = { raw: rawCode, code };
                    this.showResultBox('error', code, 'NO ENCONTRADO',
                        'CÃ³digo no encontrado en WMS. Ingresa CÃ³digo 2 o usa INSERTADO.', null);
                    document.getElementById('unified-code2-container').classList.add('show');
                    this.flashInput('error');
                    playSound('error');
                    setTimeout(() => document.getElementById('unified-code2-input').focus(), 100);
                    return;
                }

                // Hide code2 container
                document.getElementById('unified-code2-container').classList.remove('show');
                this.pendingCode1 = null;

                // Determine status and add to pallet
                let status;
                if (item.isBlocked) {
                    status = 'blocked';
                    this.showResultBox('blocked', code, 'BLOQUEADO', 'Inventario bloqueado', item);
                    playSound('warning');
                } else if (item.isAvailable) {
                    status = 'ok';
                    this.showResultBox('success', code, 'OK', 'Validado correctamente', item);
                    playSound('success');
                } else {
                    status = 'blocked';
                    this.showResultBox('blocked', code, 'SIN STOCK', 'Sin stock disponible', item);
                    playSound('warning');
                }

                this.addBox(status, this.createBoxData(rawCode, code, '', item));
                this.flashInput('success');
            },

            processCode2(rawCode2) {
                if (!this.pendingCode1) return;

                const code2 = normalizeCode(rawCode2);
                const item = STATE.inventory.get(code2);

                document.getElementById('unified-code2-container').classList.remove('show');

                let status;
                if (!item) {
                    // Both codes failed - add to No WMS
                    status = 'nowms';
                    this.addBox('nowms', this.createBoxData(this.pendingCode1.raw, this.pendingCode1.code, rawCode2, null));
                    this.showResultBox('error', this.pendingCode1.code, 'NO WMS',
                        `Ambos cÃ³digos no encontrados. Guardados: ${this.pendingCode1.code} y ${code2}`, null);
                    playSound('error');
                } else if (item.isBlocked) {
                    status = 'blocked';
                    this.addBox('blocked', this.createBoxData(this.pendingCode1.raw, code2, rawCode2, item));
                    this.showResultBox('blocked', code2, 'BLOQUEADO (CÃ³digo 2)',
                        'Validado con CÃ³digo 2 - Bloqueado', item);
                    playSound('warning');
                } else {
                    status = 'ok';
                    this.addBox('ok', this.createBoxData(this.pendingCode1.raw, code2, rawCode2, item));
                    this.showResultBox('success', code2, 'OK (CÃ³digo 2)',
                        'Validado correctamente con CÃ³digo 2', item);
                    playSound('success');
                }

                this.pendingCode1 = null;
                this.flashInput('success');
                document.getElementById('unified-scan-input').focus();
            },

            createBoxData(raw, code, scan2, item) {
                const cleanScan2 = scan2 ? normalizeCode(scan2) : '';
                return {
                    raw,
                    code,
                    scan1: raw,
                    scan2: cleanScan2,
                    rawScan2: scan2 || '',
                    location: item?.cellNo || '-',
                    sku: item?.sku || '-',
                    product: item?.productName || '-',
                    timestamp: new Date().toLocaleTimeString()
                };
            },

            addBox(status, boxData) {
                const tab = this.getActiveTab();
                if (!tab) return;

                boxData.status = status;
                tab.boxes.push(boxData);

                GlobalTabs.saveToStorage();
                this.updateUI();
            },

            deleteBox(index) {
                const tab = this.getActiveTab();
                if (!tab) return;

                if (confirm('Â¿Eliminar esta caja?')) {
                    tab.boxes.splice(index, 1);
                    GlobalTabs.saveToStorage();
                    this.updateUI();
                    showNotification('Caja eliminada', 'info');
                }
            },

            showDuplicatePopup(code, rawCode, existingIndex) {
                const tab = this.getActiveTab();
                const existingBox = tab.boxes[existingIndex];

                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay show';
                overlay.innerHTML = `
                    <div class="popup-content duplicate-popup">
                        <div class="popup-header">
                            <span>âš ï¸ CÃ³digo Duplicado</span>
                            <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">Ã—</button>
                        </div>
                        <div class="duplicate-info">
                            <div class="duplicate-info-row">
                                <span class="duplicate-info-label">CÃ³digo:</span>
                                <span class="duplicate-info-value"><code>${code}</code></span>
                            </div>
                            <div class="duplicate-info-row">
                                <span class="duplicate-info-label">Estado actual:</span>
                                <span class="duplicate-info-value">${existingBox.status === 'ok' ? 'OK' : existingBox.status === 'blocked' ? 'Bloqueado' : 'No WMS'}</span>
                            </div>
                            <div class="duplicate-info-row">
                                <span class="duplicate-info-label">Hora de registro:</span>
                                <span class="duplicate-info-value">${existingBox.timestamp}</span>
                            </div>
                        </div>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                            Este cÃ³digo ya fue escaneado. Â¿Deseas forzar un nuevo registro?
                        </p>
                        <div class="popup-buttons">
                            <button class="btn btn-warning btn-full" onclick="UnifiedModule.forceInsertDuplicate('${code}', '${rawCode}'); this.closest('.popup-overlay').remove();">
                                âš¡ Ingreso Forzado
                            </button>
                            <button class="btn btn-secondary btn-full" onclick="this.closest('.popup-overlay').remove();">
                                Cancelar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) overlay.remove();
                });
            },

            forceInsertDuplicate(code, rawCode) {
                const item = STATE.inventory.get(code);
                let status;

                if (!item) {
                    status = 'nowms';
                    showNotification('âš¡ Duplicado insertado en No WMS', 'warning');
                } else if (item.isBlocked) {
                    status = 'blocked';
                    showNotification('âš¡ Duplicado insertado en Bloqueado', 'warning');
                } else {
                    status = 'ok';
                    showNotification('âš¡ Duplicado insertado en OK', 'warning');
                }

                this.addBox(status, this.createBoxData(rawCode, code, '', item));
                playSound('warning');
                document.getElementById('unified-scan-input').focus();
            },

            showResultBox(type, code, title, message, item) {
                const box = document.getElementById('unified-result-box');
                const icons = { success: 'âœ…', warning: 'âš ï¸', blocked: 'âš ï¸', error: 'âŒ' };

                box.className = `result-box show ${type}`;
                document.getElementById('unified-result-icon').textContent = icons[type] || 'ðŸ“¦';
                document.getElementById('unified-result-title').textContent = `${title}: ${code}`;

                const detailsEl = document.getElementById('unified-result-details');
                if (item) {
                    detailsEl.innerHTML = `
                        <div class="result-info-item"><span class="result-info-label">Ubic:</span><span class="result-info-value">${item.cellNo || '-'}</span></div>
                        <div class="result-info-item"><span class="result-info-label">SKU:</span><span class="result-info-value">${item.sku || '-'}</span></div>
                        <div class="result-info-item"><span class="result-info-label">Stock:</span><span class="result-info-value">${item.availableStock || 0}</span></div>
                    `;
                } else {
                    detailsEl.innerHTML = `<div class="result-info-item" style="color: #666;">${message}</div>`;
                }
            },

            flashInput(type) {
                const input = document.getElementById('unified-scan-input');
                input.classList.remove('success', 'error');
                input.classList.add(type === 'success' ? 'success' : type === 'error' ? 'error' : '');
                setTimeout(() => input.classList.remove('success', 'error'), 500);
            },

            async sendPallet() {
                const tab = this.getActiveTab();
                if (!tab) return;

                const location = document.getElementById('unified-location').value.trim();
                const originLocation = document.getElementById('unified-origin-location').value.trim().toUpperCase();

                if (tab.boxes.length === 0) {
                    showNotification('âš ï¸ No hay cajas en esta tarima', 'warning');
                    return;
                }

                if (!location) {
                    showNotification('âš ï¸ Ingresa la ubicaciÃ³n destino', 'warning');
                    document.getElementById('unified-location').focus();
                    return;
                }

                // Show validation popup
                this.showSendValidationPopup(tab, location, originLocation);
            },

            showSendValidationPopup(tab, location, originLocation) {
                const boxCount = tab.boxes.length;

                // Enable blind mode - blur all counters
                document.body.classList.add('blind-mode');

                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay show';
                overlay.id = 'unified-send-validation-popup';
                overlay.innerHTML = `
                    <div class="popup-content send-validation-popup">
                        <div class="popup-header">
                            <span>ðŸ“¦ Validar EnvÃ­o Unificado</span>
                            <button class="popup-close" onclick="UnifiedModule.closeBlindValidationPopup()">Ã—</button>
                        </div>
                        <p style="margin-bottom: 15px; font-size: 0.9em;">
                            <strong>Pallet:</strong> ${tab.palletId}<br>
                            <strong>Destino:</strong> ${location}<br>
                            <span style="color: #888; font-size: 0.85em;">ðŸ”’ Conteo oculto - Verifica fÃ­sicamente</span>
                        </p>
                        <div class="validation-input-group">
                            <label>Â¿CuÃ¡ntas cajas fÃ­sicas hay en la tarima?</label>
                            <input type="number" id="unified-physical-count-input" min="0" placeholder="" autofocus
                                   onkeyup="UnifiedModule.validateBoxCount(${boxCount})" onchange="UnifiedModule.validateBoxCount(${boxCount})">
                        </div>
                        <div id="unified-validation-status"></div>
                        <div class="popup-buttons">
                            <button class="btn btn-success btn-full" id="unified-confirm-send-btn" disabled
                                    onclick="UnifiedModule.confirmSendPallet('${location}', '${originLocation}')">
                                ðŸ“¤ Confirmar EnvÃ­o
                            </button>
                            <button class="btn btn-secondary btn-full" onclick="UnifiedModule.closeBlindValidationPopup()">
                                Cancelar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);

                setTimeout(() => {
                    const input = document.getElementById('unified-physical-count-input');
                    if (input) input.focus();
                }, 100);

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) this.closeBlindValidationPopup();
                });
            },

            closeBlindValidationPopup() {
                document.body.classList.remove('blind-mode');
                const popup = document.getElementById('unified-send-validation-popup');
                if (popup) popup.remove();
            },

            validateBoxCount(expectedCount) {
                const input = document.getElementById('unified-physical-count-input');
                const statusDiv = document.getElementById('unified-validation-status');
                const confirmBtn = document.getElementById('unified-confirm-send-btn');
                const physicalCount = parseInt(input.value) || 0;

                if (physicalCount === expectedCount) {
                    statusDiv.innerHTML = `<div class="validation-match">âœ… Â¡Correcto! Cantidad coincide (${expectedCount} cajas)</div>`;
                    confirmBtn.disabled = false;
                } else if (physicalCount > 0) {
                    const diff = physicalCount - expectedCount;
                    const diffText = diff > 0 ? `+${diff} de mÃ¡s` : `${Math.abs(diff)} faltan`;
                    statusDiv.innerHTML = `<div class="validation-mismatch">âŒ No coincide: Escaneadas ${expectedCount}, FÃ­sicas ${physicalCount} (${diffText})</div>`;
                    confirmBtn.disabled = true;
                } else {
                    statusDiv.innerHTML = '';
                    confirmBtn.disabled = true;
                }
            },

            async confirmSendPallet(location, originLocation) {
                // Disable blind mode and close popup
                document.body.classList.remove('blind-mode');
                document.getElementById('unified-send-validation-popup')?.remove();

                const tab = this.getActiveTab();
                if (!tab) return;

                // Validate location format
                const locationCheck = confirmInvalidLocation(location);
                if (!locationCheck.confirmed) {
                    showNotification('âŒ EnvÃ­o cancelado - Verifica la ubicaciÃ³n', 'warning');
                    document.getElementById('unified-location').focus();
                    return;
                }

                const finalLocation = locationCheck.formatted;
                document.getElementById('unified-location').value = finalLocation;

                const statusMap = { ok: 'OK', blocked: 'BLOQUEADO', nowms: 'NO WMS' };
                const statusMapDisplay = { ok: 'OK', blocked: 'Bloqueada', nowms: 'No WMS' };
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10);
                const timeStr = now.toTimeString().slice(0, 8);

                // Check if cancelados mode is active
                const isCancelados = this.isCanceladosMode();

                // Create records for ALL boxes in the unified pallet
                const records = tab.boxes.map(box => {
                    // If cancelados mode, status = CANCELADO and note contains real status
                    const finalStatus = isCancelados ? 'CANCELADO' : statusMap[box.status];
                    const note = isCancelados ? `Estatus: ${statusMapDisplay[box.status]}` : '';

                    return {
                        date: dateStr,
                        time: timeStr,
                        user: CURRENT_USER || 'Usuario',
                        scan1: box.code,
                        scan2: box.scan2 || '',
                        location: finalLocation,
                        status: finalStatus,
                        note: note,
                        pallet: tab.palletId,  // Same pallet ID for all
                        originLocation: originLocation
                    };
                });

                // Add to history
                STATE.history = [...records, ...STATE.history].slice(0, 1000);

                // Add to pending sync
                PENDING_SYNC = [...PENDING_SYNC, ...records];
                SyncManager.save();

                // Show appropriate notification
                const modeText = isCancelados ? ' como CANCELADOS' : '';
                showNotification(`ðŸ’¾ ${records.length} registros agregados${modeText} (1 tarima unificada)`, 'info');

                // Try to sync immediately
                if (IS_ONLINE && gapi?.client?.getToken()) {
                    await SyncManager.sync();
                } else {
                    SyncManager.updateUI(false);
                }

                // Reset tab (but keep canceladosMode as user preference)
                tab.palletId = this.generatePalletId();
                tab.boxes = [];
                tab.location = '';
                document.getElementById('unified-location').value = '';

                GlobalTabs.saveToStorage();
                this.updateUI();
                playSound('success');

                document.getElementById('unified-origin-location').focus();
            },

            updateUI() {
                const tab = this.getActiveTab();

                const palletIdEl = document.getElementById('unified-pallet-id');
                const locationEl = document.getElementById('unified-location');
                const originLocationEl = document.getElementById('unified-origin-location');
                const okCountEl = document.getElementById('unified-ok-count');
                const blockedCountEl = document.getElementById('unified-blocked-count');
                const nowmsCountEl = document.getElementById('unified-nowms-count');
                const globalCountEl = document.getElementById('unified-global-box-count');
                const sendBtn = document.getElementById('unified-send-btn');

                if (!tab) {
                    if (globalCountEl) globalCountEl.textContent = '0';
                    if (okCountEl) okCountEl.textContent = '0';
                    if (blockedCountEl) blockedCountEl.textContent = '0';
                    if (nowmsCountEl) nowmsCountEl.textContent = '0';
                    if (sendBtn) sendBtn.disabled = true;
                    return;
                }

                // Update pallet ID
                if (palletIdEl) palletIdEl.textContent = tab.palletId;

                // Update location inputs
                if (locationEl) locationEl.value = tab.location || '';
                if (originLocationEl) originLocationEl.value = tab.originLocation || '';

                // Update counts
                const okCount = tab.boxes.filter(b => b.status === 'ok').length;
                const blockedCount = tab.boxes.filter(b => b.status === 'blocked').length;
                const nowmsCount = tab.boxes.filter(b => b.status === 'nowms').length;

                if (okCountEl) okCountEl.textContent = okCount;
                if (blockedCountEl) blockedCountEl.textContent = blockedCount;
                if (nowmsCountEl) nowmsCountEl.textContent = nowmsCount;
                if (globalCountEl) globalCountEl.textContent = tab.boxes.length;

                // Update send button
                if (sendBtn) sendBtn.disabled = tab.boxes.length === 0;

                // Update box list
                this.renderBoxList();

                // Update global tabs (for counts)
                GlobalTabs.renderTabs();
                GlobalTabs.updateGlobalSummary();
            },

            renderBoxList() {
                const tab = this.getActiveTab();
                const listEl = document.getElementById('unified-box-list');

                if (!tab || tab.boxes.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ“­</div>
                            <div>Sin cajas escaneadas</div>
                        </div>
                    `;
                    return;
                }

                const statusIcons = { ok: 'âœ…', blocked: 'âš ï¸', nowms: 'âŒ' };
                const statusNames = { ok: 'OK', blocked: 'Bloqueado', nowms: 'No WMS' };
                const isCancelados = this.isCanceladosMode();

                listEl.innerHTML = tab.boxes.map((box, index) => {
                    const canceladoBadge = isCancelados
                        ? `<span class="cancelado-badge">ðŸš« CANCELADO</span>`
                        : '';
                    const canceladoClass = isCancelados ? 'cancelado-mode' : '';

                    return `
                        <div class="unified-box-item ${box.status} ${canceladoClass}">
                            <span class="unified-box-num">${index + 1}.</span>
                            <span class="unified-box-status-icon">${statusIcons[box.status]}</span>
                            <div class="unified-box-info">
                                <div class="unified-box-code">
                                    ${box.code}${box.scan2 ? ` / ${box.scan2}` : ''}
                                    ${canceladoBadge}
                                </div>
                                <div class="unified-box-meta">${box.location} â€¢ ${box.timestamp}</div>
                            </div>
                            <div class="unified-box-actions">
                                <button class="box-action-btn copy" onclick="copyToClipboard('${box.code}')" title="Copiar cÃ³digo">â§‰</button>
                                <button class="box-action-btn copy" onclick="copyToClipboard('${box.location}')" title="Copiar ubicaciÃ³n">â—Ž</button>
                                <button class="box-action-btn delete" onclick="UnifiedModule.deleteBox(${index})" title="Eliminar">âœ•</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        // Force insert for unified module
        function unifiedForceInsert() {
            if (!UnifiedModule.pendingCode1) {
                showNotification('âš ï¸ Primero escanea un cÃ³digo', 'warning');
                return;
            }

            const code2Value = document.getElementById('unified-code2-input').value.trim();

            UnifiedModule.addBox('nowms', UnifiedModule.createBoxData(
                UnifiedModule.pendingCode1.raw,
                UnifiedModule.pendingCode1.code,
                code2Value,
                null
            ));

            const msg = code2Value
                ? `Insertado con cÃ³digos: ${UnifiedModule.pendingCode1.code} y ${code2Value}`
                : `Insertado con cÃ³digo: ${UnifiedModule.pendingCode1.code}`;

            UnifiedModule.showResultBox('error', UnifiedModule.pendingCode1.code, 'INSERTADO (No WMS)', msg, null);

            document.getElementById('unified-code2-container').classList.remove('show');
            document.getElementById('unified-code2-input').value = '';
            UnifiedModule.pendingCode1 = null;

            playSound('warning');
            UnifiedModule.flashInput('warning');
            document.getElementById('unified-scan-input').focus();
            showNotification('âš¡ Registro insertado forzosamente', 'warning');
        }

        // Load saved module preference on startup
        document.addEventListener('DOMContentLoaded', () => {
            const savedModule = localStorage.getItem('pd_current_module');
            if (savedModule === 'unified') {
                // Defer to after app is shown
                setTimeout(() => {
                    if (document.getElementById('main-app') && !document.getElementById('main-app').classList.contains('hidden')) {
                        switchModule('unified');
                    }
                }, 500);
            }
        });
    </script>
</body>
</html>
